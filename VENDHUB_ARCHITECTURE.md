# VendHub - Архитектура системы учета вендинговых автоматов

## Обзор системы

VendHub - это комплексная система учета для управления парком вендинговых автоматов, включающая:
- Учет оборудования (автоматы, бункеры, сиропы, вода, запчасти)
- Управление запасами и партиями товаров
- Финансовый учет доходов и расходов
- Управление рецептами и себестоимостью
- Telegram-интерфейс для операторов
- Поддержку исторических данных

## Основные компоненты системы

### 1. Вендинговые автоматы (Machines)

#### Структура данных:
- **model**: Модель автомата (например, "NECTA KREA TOUCH")
- **serialNumber**: Заводской номер
- **vendhubCode**: Внутренний код (формат: "VM-015-TASH-WEST")
- **status**: Статус (ACTIVE, WAREHOUSE, BROKEN, MAINTENANCE)
- **location**: Адрес и GPS координаты
- **groupName**: Группировка по районам
- **operator**: Закрепленный оператор

#### Возможности:
- Отслеживание истории перемещений
- Привязка к оператору и маршруту
- Учет установленных компонентов (бункеры, сиропы, вода)
- История обслуживания

### 2. Бункеры (Bunkers)

#### Кодификация:
```
SET-005-4SU
│    │   │ └─ Ингредиент (SU = Sugar)
│    │   └─── Позиция в автомате (1-8)
│    └─────── Номер комплекта
└──────────── Префикс комплекта
```

#### Типы ингредиентов:
- COFFEE - Кофе
- CREAM - Сливки
- CHOCOLATE - Шоколад
- SUGAR - Сахар
- MILK - Молоко
- CAPPUCCINO - Капучино
- DECAF - Декаф
- TEA - Чай

#### Учет операций:
- **Заполнение**: фиксация веса до/после, расчет нетто
- **Установка/снятие**: привязка к автомату и позиции
- **Мойка**: учет времени и места
- **Статусы**: WAREHOUSE, IN_MACHINE, IN_TRANSIT, WASHING, DAMAGED

### 3. Сиропы (Syrups)

#### Типы:
- Стандартные: Карамель, Ваниль, Кокос, Лесной орех, Амаретто, Ирландский крем, Шоколад
- Пользовательские: возможность добавления новых типов

#### Учет:
- Объем в литрах
- Привязка к партии и сроку годности
- Статусы: FULL, PARTIAL, EMPTY, EXPIRED
- История установки в автоматы

### 4. Вода (Water)

#### Характеристики:
- Стандартный объем: 18.9 литров
- Учет по бутылкам
- Статусы: NEW, IN_USE, EMPTY, RETURNED
- Автомат может иметь 2-4 бутылки одновременно

### 5. Запасные части (Spare Parts)

#### Кодификация:
```
SP-2024-DC24-5V-001
│   │    │    │  └─ Порядковый номер
│   │    │    └──── Характеристика (5V)
│   │    └───────── Модель (DC24)
│   └────────────── Год
└────────────────── Префикс запчасти
```

#### Учет:
- Типы: помпы, платы, двигатели и т.д.
- Совместимость с моделями автоматов
- История использования в автоматах
- Статусы: NEW, USED, DAMAGED, REPAIRED, WRITTEN_OFF

### 6. Поставщики и контракты

#### Поставщики:
- Основные данные: название, ИНН, контакты
- Валюта расчетов (UZS, USD, EUR, RUB)
- Условия оплаты

#### Контракты:
- Номер и даты действия
- Список товаров и цен (JSON)
- Условия оплаты и доставки
- Привязка к менеджеру

### 7. Партии товаров (Batches)

#### Кодификация:
```
PARTY-2024-CHOC-03
│     │    │    └─ Порядковый номер партии
│     │    └─────── Тип товара (CHOC = Chocolate)
│     └──────────── Год
└────────────────── Префикс партии
```

#### Учет:
- Типы: INGREDIENT, SYRUP, SPARE_PART
- Количество и единицы измерения
- Стоимость за единицу и общая
- Срок годности
- Остатки на складе

### 8. Финансовый учет

#### Доходы:
- Источники: QR, CASH, VIP, RENT
- Привязка к автомату
- Учет платежных шлюзов для QR

#### Расходы:
- Категории: INGREDIENTS, RENT, REPAIR, SALARY, TRANSPORT, UTILITIES, EQUIPMENT, TAXES
- Привязка к поставщику и контракту
- Типы оплаты: CASH, BANK_ACCOUNT, PETTY_CASH, CARD

### 9. Рецепты и себестоимость

#### Структура рецепта:
- Базовый рецепт с названием и категорией
- Версии рецепта с составом:
  - Ингредиенты (граммовка)
  - Сиропы (объем в мл)
  - Вода (объем в мл)
  - Параметры: температура, давление

#### Расчет себестоимости:
- На основе граммовки ингредиентов
- Учет стоимости из партий
- История изменения цен

### 10. Поддержка исторических данных

Каждая операция содержит:
- **performedAt**: фактическое время события
- **enteredAt**: время записи в систему
- **entryMethod**: способ ввода (MANUAL, TELEGRAM, AUTO_IMPORT, API)
- **userId**: кто выполнил операцию
- **comments**: комментарии
- **photoUrls**: фотофиксация

## Telegram-интерфейс

### Роли пользователей:

#### 1. WAREHOUSE (Склад)
- Прием товаров
- Выдача бункеров/сиропов/воды
- Учет остатков на складе
- Инвентаризация

#### 2. OPERATOR (Оператор)
- Обслуживание автоматов
- Замена бункеров
- Взвешивание и фиксация остатков
- Фотофиксация состояния

#### 3. MANAGER (Менеджер)
- Просмотр отчетов
- Анализ доходности
- Контроль операций
- Управление контрактами

#### 4. ADMIN (Администратор)
- Полный доступ
- Управление пользователями
- Настройка системы
- Корректировка данных

### Основные процессы через Telegram:

#### 1. Заполнение бункера:
1. Выбор бункера по коду
2. Взвешивание пустого
3. Заполнение ингредиентом
4. Взвешивание полного
5. Фотофиксация
6. Указание партии

#### 2. Обслуживание автомата:
1. Сканирование QR автомата
2. Выбор типа операции
3. Замена компонентов
4. Фиксация показаний
5. Фотоотчет

#### 3. Финансовые операции:
1. Сбор выручки
2. Фиксация суммы и типа
3. Загрузка чеков/документов
4. Привязка к автомату

## API структура

### Микросервисы:

1. **machines-service**: Управление автоматами
2. **bunkers-service**: Операции с бункерами
3. **inventory-service**: Учет запасов и партий
4. **finance-service**: Финансовые операции
5. **recipes-service**: Управление рецептами
6. **suppliers-service**: Поставщики и контракты
7. **telegram-bot**: Telegram интерфейс
8. **reports-service**: Отчетность и аналитика

### Основные эндпоинты:

#### Machines:
- `GET /machines` - список автоматов
- `GET /machines/:code` - детали автомата
- `POST /machines/:code/service` - запись обслуживания
- `GET /machines/:code/components` - компоненты автомата

#### Bunkers:
- `GET /bunkers` - список бункеров
- `GET /bunkers/:code` - детали бункера
- `POST /bunkers/:code/fill` - заполнение
- `POST /bunkers/:code/install` - установка в автомат

#### Inventory:
- `GET /batches` - партии товаров
- `POST /batches` - новая партия
- `GET /stock/current` - текущие остатки
- `POST /stock/movement` - движение товара

#### Finance:
- `POST /revenue` - запись дохода
- `POST /expense` - запись расхода
- `GET /transactions` - список транзакций
- `GET /reports/pnl` - отчет о прибылях и убытках

## Отчеты и аналитика

### Оперативные отчеты:
1. Состояние автоматов в реальном времени
2. Остатки ингредиентов по автоматам
3. Требуемые пополнения
4. Активные неисправности

### Финансовые отчеты:
1. Доходы по автоматам/периодам
2. Структура расходов
3. Прибыльность по локациям
4. Себестоимость напитков

### Складские отчеты:
1. Остатки на складе
2. Движение товаров
3. Истекающие сроки годности
4. Потребность в закупках

### Аналитика:
1. Популярность напитков
2. Эффективность операторов
3. Частота обслуживания
4. Прогнозирование спроса

## Безопасность и аудит

### Контроль доступа:
- Ролевая модель (RBAC)
- Разграничение по операциям
- Логирование всех действий

### Аудит:
- Фиксация всех изменений
- История состояний объектов
- Возможность отката операций
- Фотофиксация критических операций

### Валидация данных:
- Проверка весов (нетто не может быть больше брутто)
- Контроль остатков (не может быть отрицательным)
- Проверка сроков годности
- Валидация финансовых операций
