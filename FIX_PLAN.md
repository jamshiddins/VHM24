# План исправления проблем проекта VHM24

## Введение

Данный документ содержит пошаговый план исправления проблем, выявленных в ходе аудита проекта VHM24.
Проблемы сгруппированы по типам и приоритетам для обеспечения систематического подхода к их
устранению.

## Группировка проблем по типам

### 1. Безопасность

- Небезопасная обработка ошибок (отправка ошибок клиенту напрямую)
- Отсутствие валидации входных данных
- Отсутствие проверок на существование сущностей
- Отсутствие защиты от атак (XSS, CSRF, SQL Injection)
- Hardcoded credentials

### 2. Зависимости

- Устаревшие пакеты
- Отсутствующие зависимости
- Уязвимости в зависимостях

### 3. Код

- Синтаксические ошибки
- Бесконечная рекурсия в логгерах
- Отсутствие проверок на существование глобальных объектов
- Отсутствие обработки ошибок при вызове API
- Смешивание синхронных и асинхронных операций
- Дублирование кода
- Неконсистентный стиль кода

### 4. Инфраструктура

- Неполная конфигурация Docker
- Отсутствие централизованного логирования
- Отсутствие мониторинга и health check
- Отсутствие кэширования
- Отсутствие документации API

## Порядок исправления

### Фаза 1: Критические исправления (Приоритет: Критический)

#### Шаг 1.1: Исправление синтаксических ошибок

- Исправить `fs.await` на `await` в `packages/shared/storage/s3Storage.js`
- Исправить `fs.await` на `await` в `services/telegram-bot/src/handlers/warehouseHandler.js`

#### Шаг 1.2: Исправление логгеров

- Переписать логгер в `services/tasks/src/scheduledTasks.js`
- Переписать логгер в `services/telegram-bot/src/utils/qrScanner.js`

#### Шаг 1.3: Добавление проверок на существование глобальных объектов

- Добавить проверки перед использованием `global.logger`
- Добавить проверки перед использованием `global.apiClient`
- Добавить проверки перед использованием `global.notificationService`

#### Шаг 1.4: Улучшение обработки ошибок

- Добавить try-catch блоки во все асинхронные функции
- Создать централизованный обработчик ошибок
- Заменить прямую отправку ошибок клиенту на безопасные сообщения

#### Шаг 1.5: Дополнение Docker конфигурации

- Добавить конфигурацию для всех микросервисов в `docker-compose.yml`
- Настроить зависимости между сервисами
- Добавить health checks для всех сервисов

### Фаза 2: Высокоприоритетные улучшения (Приоритет: Высокий)

#### Шаг 2.1: Добавление валидации входных данных

- Создать JSON Schema для каждого API эндпоинта
- Добавить валидацию для всех POST, PUT, PATCH запросов
- Добавить валидацию для query параметров в GET запросах

#### Шаг 2.2: Добавление проверок на существование сущностей

- Добавить проверки перед операциями с пользователями
- Добавить проверки перед операциями с машинами
- Добавить проверки перед операциями с задачами
- Добавить проверки перед операциями с инвентарем

#### Шаг 2.3: Настройка централизованного логирования

- Создать единый логгер для всех сервисов
- Настроить уровни логирования в зависимости от окружения
- Настроить форматирование логов для удобного анализа

#### Шаг 2.4: Добавление мониторинга и health check

- Добавить `/health` эндпоинт во все сервисы
- Настроить проверку соединения с БД и другими зависимостями
- Добавить метрики производительности

#### Шаг 2.5: Устранение hardcoded credentials

- Найти все hardcoded пароли, токены, ключи
- Вынести их в переменные окружения
- Обновить `.env.example` с полным списком переменных
- Добавить проверку обязательных переменных при старте

### Фаза 3: Среднеприоритетные улучшения (Приоритет: Средний)

#### Шаг 3.1: Замена синхронных операций на асинхронные

- Заменить синхронные операции файловой системы на асинхронные
- Оптимизировать блокирующие операции

#### Шаг 3.2: Добавление пагинации

- Добавить пагинацию для всех API эндпоинтов, возвращающих списки
- Добавить параметры `skip`, `take`, `orderBy`, `order` для всех списков

#### Шаг 3.3: Настройка кэширования

- Настроить Redis для кэширования
- Определить данные, которые можно кэшировать
- Добавить TTL для кэшированных данных

#### Шаг 3.4: Добавление документации API

- Настроить Swagger/OpenAPI для всех сервисов
- Документировать все эндпоинты, параметры и ответы
- Добавить примеры запросов и ответов

#### Шаг 3.5: Увеличение покрытия тестами

- Настроить Jest для каждого сервиса
- Добавить unit тесты для критических функций
- Добавить integration тесты для API эндпоинтов
- Настроить CI для запуска тестов

### Фаза 4: Низкоприоритетные улучшения (Приоритет: Низкий)

#### Шаг 4.1: Стандартизация стиля кода

- Настроить ESLint и Prettier
- Создать единые правила для всех сервисов
- Автоматизировать проверку стиля кода

#### Шаг 4.2: Добавление комментариев

- Добавить JSDoc комментарии для всех функций
- Документировать сложные алгоритмы
- Добавить комментарии к конфигурационным файлам

#### Шаг 4.3: Устранение дублирования кода

- Выявить дублирующийся код
- Вынести общие функции в shared пакеты
- Создать переиспользуемые компоненты

#### Шаг 4.4: Оптимизация запросов к БД

- Проанализировать запросы к БД
- Добавить индексы для часто используемых полей
- Оптимизировать сложные запросы
- Устранить N+1 проблему

#### Шаг 4.5: Внедрение версионирования API

- Разработать стратегию версионирования API
- Добавить версионирование для всех эндпоинтов
- Документировать процесс обновления API

## Отслеживание прогресса

Для отслеживания прогресса будет использоваться следующая структура:

```
[x] - Задача выполнена
[ ] - Задача не выполнена
[-] - Задача в процессе выполнения
```

### Пример:

#### Фаза 1: Критические исправления

- [ ] Шаг 1.1: Исправление синтаксических ошибок
  - [ ] Исправить `fs.await` на `await` в `packages/shared/storage/s3Storage.js`
  - [ ] Исправить `fs.await` на `await` в `services/telegram-bot/src/handlers/warehouseHandler.js`
- [ ] Шаг 1.2: Исправление логгеров
  - [ ] Переписать логгер в `services/tasks/src/scheduledTasks.js`
  - [ ] Переписать логгер в `services/telegram-bot/src/utils/qrScanner.js`

## Заключение

Данный план предоставляет систематический подход к исправлению проблем, выявленных в ходе аудита
проекта VHM24. Следуя этому плану, мы сможем привести проект в состояние готовности к production
запуску, обеспечивая его безопасность, стабильность и производительность.
