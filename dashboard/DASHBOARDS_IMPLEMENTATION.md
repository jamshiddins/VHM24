# РЕАЛИЗАЦИЯ ВЕБ-ДАШБОРДОВ VENDHUB

## ОБЩАЯ ИНФОРМАЦИЯ

**Дата:** 16.07.2025
**Проект:** VHM24 (Vending Hub Manager)
**Версия:** 1.0.0
**Статус:** Реализовано

## ОПИСАНИЕ

В рамках проекта VHM24 были реализованы следующие веб-дашборды для отображения ключевых бизнес-метрик, ошибок и аналитики. Каждый дашборд имеет свое назначение, доступные фильтры, поля и графики, связи с базой данных и особенности визуализации.

## РЕАЛИЗОВАННЫЕ ДАШБОРДЫ

### 1. Продажи (сумма, UZS)

**Назначение:**
Анализ общей выручки по всем автоматам, типам оплаты и периодам.

**Источник данных:** `final_sales_report`

**Поля и графики:**
- Общая сумма продаж за выбранный период
- Разбивка по типам оплат: `Cash`, `Card`, `QR (Payme, Click, Uzum)`
- Сравнение по автоматам (топ-10 по выручке)
- Динамика выручки по дням/неделям/месяцам

**Фильтры:**
- Дата/период
- Тип оплаты
- Автомат (по коду или названию)
- Локация

**Особенности:**
- Отображаются также суммы поступлений из банка
- Подсвечиваются автоматы с нулевой выручкой

**Реализация:**
- Файл: `dashboard/sales-amount.html`
- JavaScript: `dashboard/js/sales-amount.js`
- API: `GET /api/sales/amount`
- Компоненты: 
  - SalesAmountChart
  - PaymentTypeDistribution
  - TopMachinesChart
  - SalesDynamicsChart

### 2. Продажи (кол-во позиций)

**Назначение:**
Отслеживание количества продаж по продуктам, автоматам и периодам.

**Источник данных:** `final_sales_report`

**Поля и графики:**
- Количество проданных позиций
- Разбивка по напиткам (`Goods name`)
- По типам оплат и автоматам
- График динамики количества продаж

**Фильтры:**
- Дата/период
- Автомат
- Продукт
- Статус доставки

**Особенности:**
- Считается только при `brew_status == Delivered`

**Реализация:**
- Файл: `dashboard/sales-count.html`
- JavaScript: `dashboard/js/sales-count.js`
- API: `GET /api/sales/count`
- Компоненты: 
  - SalesCountChart
  - ProductDistributionChart
  - MachinesSalesCountChart
  - SalesCountDynamicsChart

### 3. Активные автоматы

**Назначение:**
Контроль работающих автоматов: подключены, продают, передают данные.

**Источник данных:** `final_sales_report`, телеметрия

**Поля и графики:**
- Список активных автоматов с последним временем продажи
- Продажи за последние 24 часа по каждому автомату
- Средняя выручка за день
- Информация о локации

**Фильтры:**
- Тип автомата (кофейный, снеки и т.д.)
- Локация
- Активность за период

**Реализация:**
- Файл: `dashboard/active-machines.html`
- JavaScript: `dashboard/js/active-machines.js`
- API: `GET /api/machines/active`
- Компоненты: 
  - ActiveMachinesList
  - MachinesSalesChart
  - MachinesLocationMap
  - MachinesStatusChart

### 4. Неактивные автоматы

**Назначение:**
Выявление автоматов, которые не работают, не продают или не передают данные.

**Источник данных:** `final_sales_report`

**Поля и графики:**
- Список автоматов без продаж более 24 часов
- Время последней продажи
- Причины (если есть ошибки: `delivery_fail`, `not_paid`)

**Фильтры:**
- Тип автомата
- Время последней активности
- Ошибки

**Особенности:**
- Подсвечиваются автоматы с 0 продаж более 48 часов

**Реализация:**
- Файл: `dashboard/inactive-machines.html`
- JavaScript: `dashboard/js/inactive-machines.js`
- API: `GET /api/machines/inactive`
- Компоненты: 
  - InactiveMachinesList
  - ErrorDistributionChart
  - InactivityDurationChart
  - MachinesLocationMap

### 5. Активные задачи

**Назначение:**
Мониторинг задач по автоматам (замены, пополнения, чистки).

**Источник:** задачи из Telegram-бота и административной панели

**Поля:**
- Название задачи
- Автомат
- Назначенный сотрудник
- Статус: `В процессе`, `Выполнено`, `Просрочено`

**Фильтры:**
- Дата создания / дедлайн
- Тип задачи
- Исполнитель

**Особенности:**
- Подсветка просроченных задач
- Подсчёт критических задач

**Реализация:**
- Файл: `dashboard/active-tasks.html`
- JavaScript: `dashboard/js/active-tasks.js`
- API: `GET /api/tasks/active`
- Компоненты: 
  - ActiveTasksList
  - TasksStatusChart
  - TasksAssigneeChart
  - TasksCalendar

### 6. Остатки по складу

**Назначение:**
Анализ остатков ингредиентов, воды, стаканов, сиропов.

**Источник:** данные из Telegram-бота + складская система

**Поля:**
- Тип ресурса (кофе, вода, молоко и т.д.)
- Кол-во на складе (в кг, л, шт)
- Дата последнего пополнения / расхода
- Прогноз остатка (если настроено потребление)

**Фильтры:**
- Тип ресурса
- Автомат / склад
- Дата пополнения

**Особенности:**
- Поддержка складов и сумок (наборов)
- В перспективе — анализ потребления по рецептам

**Реализация:**
- Файл: `dashboard/inventory.html`
- JavaScript: `dashboard/js/inventory.js`
- API: `GET /api/inventory`
- Компоненты: 
  - InventoryList
  - ResourceTypeDistributionChart
  - InventoryForecastChart
  - InventoryHistoryChart

### 7. Инкассация

**Назначение:**
Отслеживание факта сдачи наличных, расхождения с продажами по `Cash payment`.

**Источник:** `final_sales_report` + Telegram-бот

**Поля:**
- Сумма продаж за наличные
- Сумма сданная в инкассации
- Остаток наличных (по автомату)
- Превышение / недостаток

**Фильтры:**
- Автомат
- Дата сдачи
- Статус (инкассировано / не инкассировано)

**Особенности:**
- Отображаются случаи, когда инкассация не совпадает с продажами

**Реализация:**
- Файл: `dashboard/collections.html`
- JavaScript: `dashboard/js/collections.js`
- API: `GET /api/collections`
- Компоненты: 
  - CollectionsList
  - CollectionDiscrepancyChart
  - CollectionStatusChart
  - CollectionHistoryChart

### 8. Финансовые показатели

**Назначение:**
Сводный дашборд по прибыли, расходам, фискализации, банку.

**Источник:** `final_sales_report` + банковские поступления + ручной ввод

**Показатели:**
- Общая выручка
- Комиссии платёжных систем
- Сумма фискализированных чеков
- Расходы (аренда, зарплата, ингредиенты — при расширении)
- Прибыль = Выручка – Расходы

**Фильтры:**
- Период
- Автомат
- Тип оплаты

**Особенности:**
- Отображаются расхождения между поступлением и продажами
- Есть виджет "ошибок" (кол-во несоответствий по чекам, банку, инкассации)

**Реализация:**
- Файл: `dashboard/financial.html`
- JavaScript: `dashboard/js/financial.js`
- API: `GET /api/financial`
- Компоненты: 
  - FinancialSummaryWidget
  - RevenueExpensesChart
  - PaymentSystemsCommissionsChart
  - DiscrepanciesWidget

## ТЕХНИЧЕСКИЕ ДЕТАЛИ РЕАЛИЗАЦИИ

### Архитектура дашбордов

Все дашборды реализованы с использованием следующего технологического стека:

- **Frontend**: HTML5, CSS3, JavaScript (ES6+)
- **Библиотеки**: Chart.js для графиков, Leaflet для карт, DataTables для таблиц
- **API**: RESTful API на базе Express.js
- **Аутентификация**: JWT-токены
- **Кэширование**: Redis для кэширования данных и улучшения производительности

### Общие компоненты

Для всех дашбордов реализованы следующие общие компоненты:

- **DateRangePicker**: Компонент для выбора диапазона дат
- **FilterPanel**: Панель с фильтрами, специфичными для каждого дашборда
- **ExportButton**: Кнопка для экспорта данных в Excel или PDF
- **RefreshButton**: Кнопка для обновления данных
- **ErrorHandler**: Компонент для обработки и отображения ошибок

### API для дашбордов

Для каждого дашборда реализован соответствующий API-эндпоинт, который возвращает данные в формате JSON. Все эндпоинты поддерживают фильтрацию, сортировку и пагинацию.

Пример API-эндпоинта для дашборда "Продажи (сумма, UZS)":

```javascript
// backend/routes/api/sales.js
router.get('/amount', auth, async (req, res) => {
  try {
    const { startDate, endDate, paymentType, machineCode, location } = req.query;
    
    // Формирование запроса к базе данных с учетом фильтров
    const query = {
      date: {
        $gte: new Date(startDate),
        $lte: new Date(endDate)
      }
    };
    
    if (paymentType) {
      query.payment_type = paymentType;
    }
    
    if (machineCode) {
      query.machine_code = machineCode;
    }
    
    if (location) {
      query.location = { $regex: location, $options: 'i' };
    }
    
    // Получение данных из базы данных
    const salesData = await SalesReport.find(query);
    
    // Обработка данных и формирование ответа
    const result = processSalesData(salesData);
    
    res.json(result);
  } catch (error) {
    logger.error(`Error getting sales amount data: ${error.message}`, { error });
    res.status(500).json({ error: 'Failed to get sales amount data' });
  }
});
```

### Безопасность

Все дашборды защищены системой аутентификации и авторизации. Доступ к дашбордам имеют только пользователи с соответствующими правами.

Реализованы следующие меры безопасности:

- JWT-токены для аутентификации
- Проверка прав доступа для каждого запроса
- Защита от XSS-атак
- Защита от CSRF-атак
- Rate limiting для предотвращения DDoS-атак

### Производительность

Для обеспечения высокой производительности дашбордов реализованы следующие оптимизации:

- Кэширование данных с использованием Redis
- Оптимизация запросов к базе данных
- Минимизация и сжатие JavaScript и CSS файлов
- Ленивая загрузка компонентов
- Пагинация для больших наборов данных

## ЗАКЛЮЧЕНИЕ

Все веб-дашборды VendHub успешно реализованы и готовы к использованию. Они предоставляют полную информацию о продажах, автоматах, задачах, остатках, инкассации и финансовых показателях, что позволяет эффективно управлять сетью вендинговых автоматов.

Дашборды интегрированы с системой мониторинга и логирования, что позволяет оперативно выявлять и устранять проблемы. Также реализована система оповещений, которая уведомляет пользователей о критических событиях.

В будущем планируется расширение функциональности дашбордов, в частности, добавление прогнозирования спроса на основе исторических данных, интеграция с системами учета и ERP, а также разработка мобильной версии дашбордов.
