const TelegramBot = require('node-telegram-bot-api');
const fs = require('fs');
const path = require('path');
const os = require('os');
const s3Storage = require('../utils/s3Storage');

/**
 * Upload Handler - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
 * –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É —Ñ–æ—Ç–æ, –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ –¥—Ä—É–≥–∏—Ö —Ñ–∞–π–ª–æ–≤ –≤ DigitalOcean Spaces
 */

class UploadHandler {
  constructor(bot) {
    this.bot = bot;
    this.tempDir = path.join(os.tmpdir(), 'vhm24-uploads');
    
    // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    if (!fs.existsSync(this.tempDir)) {
      fs.mkdirSync(this.tempDir, { recursive: true });
    }

    this.setupHandlers();
  }

  setupHandlers() {
    // –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
    this.bot.onText(/\/upload_photo/, (msg) => {
      this.handleUploadPhotoCommand(msg);
    });

    // –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞
    this.bot.onText(/\/upload_document/, (msg) => {
      this.handleUploadDocumentCommand(msg);
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ
    this.bot.on('photo', (msg) => {
      this.handlePhoto(msg);
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    this.bot.on('document', (msg) => {
      this.handleDocument(msg);
    });

    // –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    this.bot.onText(/\/my_uploads/, (msg) => {
      this.handleMyUploads(msg);
    });

    // –ö–æ–º–∞–Ω–¥–∞ –ø–æ–º–æ—â–∏ –ø–æ –∑–∞–≥—Ä—É–∑–∫–µ
    this.bot.onText(/\/upload_help/, (msg) => {
      this.handleUploadHelp(msg);
    });
  }

  /**
   * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /upload_photo
   */
  async handleUploadPhotoCommand(msg) {
    const chatId = msg.chat.id;
    
    const helpText = `üì∏ *–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –≤ –æ–±–ª–∞–∫–æ*

–ü—Ä–æ—Å—Ç–æ –ø—Ä–∏—à–ª–∏—Ç–µ –º–Ω–µ —Ñ–æ—Ç–æ, –∏ —è –∑–∞–≥—Ä—É–∂—É –µ–≥–æ –≤ DigitalOcean Spaces!

*–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:*
‚Ä¢ JPG/JPEG
‚Ä¢ PNG
‚Ä¢ GIF
‚Ä¢ WebP

*–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:*
1. –í—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç–µ —Ñ–æ—Ç–æ
2. –Ø –∑–∞–≥—Ä—É–∂–∞—é –µ–≥–æ –≤ –æ–±–ª–∞–∫–æ
3. –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –ø—É–±–ª–∏—á–Ω—É—é —Å—Å—ã–ª–∫—É

–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å - –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ª—é–±–æ–µ —Ñ–æ—Ç–æ! üì∑`;

    await this.bot.sendMessage(chatId, helpText, { parse_mode: 'Markdown' });
  }

  /**
   * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /upload_document
   */
  async handleUploadDocumentCommand(msg) {
    const chatId = msg.chat.id;
    
    const helpText = `üìÑ *–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –æ–±–ª–∞–∫–æ*

–û—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ –¥–æ–∫—É–º–µ–Ω—Ç, –∏ —è –∑–∞–≥—Ä—É–∂—É –µ–≥–æ –≤ DigitalOcean Spaces!

*–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:*
‚Ä¢ PDF
‚Ä¢ DOC/DOCX
‚Ä¢ XLS/XLSX
‚Ä¢ TXT
‚Ä¢ CSV
‚Ä¢ –ò –º–Ω–æ–≥–∏–µ –¥—Ä—É–≥–∏–µ

*–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä:* 20 –ú–ë

–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å - –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ª—é–±–æ–π –¥–æ–∫—É–º–µ–Ω—Ç! üìé`;

    await this.bot.sendMessage(chatId, helpText, { parse_mode: 'Markdown' });
  }

  /**
   * –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ
   */
  async handlePhoto(msg) {
    const chatId = msg.chat.id;
    const messageId = msg.message_id;

    try {
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
      const statusMsg = await this.bot.sendMessage(chatId, 'üì∏ –ó–∞–≥—Ä—É–∂–∞—é —Ñ–æ—Ç–æ –≤ –æ–±–ª–∞–∫–æ...', {
        reply_to_message_id: messageId
      });

      // –ü–æ–ª—É—á–∞–µ–º —Ñ–æ—Ç–æ –Ω–∞–∏–ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞
      const photo = msg.photo[msg.photo.length - 1];
      const fileId = photo.file_id;

      // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
      const file = await this.bot.getFile(fileId);
      const fileName = `photo_${Date.now()}.jpg`;
      const tempFilePath = path.join(this.tempDir, fileName);

      // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
      await this.bot.downloadFile(fileId, tempFilePath);

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ DigitalOcean Spaces
      const uploadedUrl = await s3Storage.uploadPhoto(tempFilePath, fileName);

      // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
      const stats = fs.statSync(tempFilePath);
      const fileSizeKB = Math.round(stats.size / 1024);

      // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
      fs.unlinkSync(tempFilePath);

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
      const successText = `‚úÖ *–§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!*

üìé *–°—Å—ã–ª–∫–∞:* [–û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ç–æ](${uploadedUrl})
üìè *–†–∞–∑–º–µ—Ä:* ${fileSizeKB} –ö–ë
üåê *CDN:* DigitalOcean Spaces
üìÖ *–î–∞—Ç–∞:* ${new Date().toLocaleString('ru-RU')}

_–°—Å—ã–ª–∫–∞ –ø—É–±–ª–∏—á–Ω–∞—è –∏ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ–≥–¥–∞_`;

      await this.bot.editMessageText(successText, {
        chat_id: chatId,
        message_id: statusMsg.message_id,
        parse_mode: 'Markdown',
        disable_web_page_preview: false
      });

      // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É
      console.log(`‚úÖ Photo uploaded by user ${msg.from.id}: ${uploadedUrl}`);

    } catch (error) {
      console.error('‚ùå Error uploading photo:', error);
      
      await this.bot.sendMessage(chatId, `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ: ${error.message}`, {
        reply_to_message_id: messageId
      });
    }
  }

  /**
   * –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
   */
  async handleDocument(msg) {
    const chatId = msg.chat.id;
    const messageId = msg.message_id;

    try {
      const document = msg.document;
      const fileId = document.file_id;
      const fileName = document.file_name || `document_${Date.now()}`;
      const fileSize = document.file_size;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å–∏–º—É–º 20 –ú–ë)
      if (fileSize > 20 * 1024 * 1024) {
        await this.bot.sendMessage(chatId, '‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 20 –ú–ë', {
          reply_to_message_id: messageId
        });
        return;
      }

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
      const statusMsg = await this.bot.sendMessage(chatId, `üìÑ –ó–∞–≥—Ä—É–∂–∞—é –¥–æ–∫—É–º–µ–Ω—Ç "${fileName}" –≤ –æ–±–ª–∞–∫–æ...`, {
        reply_to_message_id: messageId
      });

      // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
      const tempFilePath = path.join(this.tempDir, fileName);
      await this.bot.downloadFile(fileId, tempFilePath);

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ DigitalOcean Spaces
      const uploadedUrl = await s3Storage.uploadDocument(tempFilePath, fileName);

      // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
      const fileSizeKB = Math.round(fileSize / 1024);
      const fileSizeMB = (fileSize / (1024 * 1024)).toFixed(2);

      // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
      fs.unlinkSync(tempFilePath);

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
      const successText = `‚úÖ *–î–æ–∫—É–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!*

üìé *–°—Å—ã–ª–∫–∞:* [${fileName}](${uploadedUrl})
üìè *–†–∞–∑–º–µ—Ä:* ${fileSizeMB} –ú–ë (${fileSizeKB} –ö–ë)
üìÑ *–¢–∏–ø:* ${document.mime_type || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
üåê *CDN:* DigitalOcean Spaces
üìÖ *–î–∞—Ç–∞:* ${new Date().toLocaleString('ru-RU')}

_–°—Å—ã–ª–∫–∞ –ø—É–±–ª–∏—á–Ω–∞—è –∏ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ–≥–¥–∞_`;

      await this.bot.editMessageText(successText, {
        chat_id: chatId,
        message_id: statusMsg.message_id,
        parse_mode: 'Markdown',
        disable_web_page_preview: false
      });

      // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É
      console.log(`‚úÖ Document uploaded by user ${msg.from.id}: ${uploadedUrl}`);

    } catch (error) {
      console.error('‚ùå Error uploading document:', error);
      
      await this.bot.sendMessage(chatId, `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞: ${error.message}`, {
        reply_to_message_id: messageId
      });
    }
  }

  /**
   * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /my_uploads
   */
  async handleMyUploads(msg) {
    const chatId = msg.chat.id;
    
    const infoText = `üìÅ *–ú–æ–∏ –∑–∞–≥—Ä—É–∑–∫–∏*

–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø–æ–∫–∞ –Ω–µ—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤–∞—à–∏—Ö –∑–∞–≥—Ä—É–∑–æ–∫.

*–ß—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:*
‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –≤–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∑–∞–∫–ª–∞–¥–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
‚Ä¢ –°–æ–∑–¥–∞–π—Ç–µ –∑–∞–º–µ—Ç–∫—É —Å —Å—Å—ã–ª–∫–∞–º–∏

*–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å:*
‚Ä¢ –ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∑–æ–∫
‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞–º–∏
‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ –∞–ª—å–±–æ–º–æ–≤
‚Ä¢ –ü–æ–∏—Å–∫ –ø–æ —Ñ–∞–π–ª–∞–º

–ü–æ–∫–∞ —á—Ç–æ –ø—Ä–æ—Å—Ç–æ –∑–∞–≥—Ä—É–∂–∞–π—Ç–µ —Ñ–∞–π–ª—ã - –≤—Å–µ —Å—Å—ã–ª–∫–∏ –ø—É–±–ª–∏—á–Ω—ã–µ –∏ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ! üöÄ`;

    await this.bot.sendMessage(chatId, infoText, { parse_mode: 'Markdown' });
  }

  /**
   * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /upload_help
   */
  async handleUploadHelp(msg) {
    const chatId = msg.chat.id;
    
    const helpText = `üÜò *–ü–æ–º–æ—â—å –ø–æ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤*

*üì∏ –§–æ—Ç–æ:*
‚Ä¢ –ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ
‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: JPG, PNG, GIF, WebP
‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤ –æ–±–ª–∞–∫–æ

*üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã:*
‚Ä¢ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç
‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 20 –ú–ë
‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã

*üåê –û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ:*
‚Ä¢ DigitalOcean Spaces
‚Ä¢ CDN –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
‚Ä¢ –ü—É–±–ª–∏—á–Ω—ã–µ —Å—Å—ã–ª–∫–∏
‚Ä¢ –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ

*üìã –ö–æ–º–∞–Ω–¥—ã:*
/upload_photo - –ø–æ–º–æ—â—å –ø–æ —Ñ–æ—Ç–æ
/upload_document - –ø–æ–º–æ—â—å –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º
/my_uploads - –º–æ–∏ –∑–∞–≥—Ä—É–∑–∫–∏
/upload_help - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞

*üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:*
‚Ä¢ –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ (UUID)
‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ MIME-—Ç–∏–ø–æ–≤
‚Ä¢ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 1 –≥–æ–¥
‚Ä¢ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –∏ –ø–æ–ª—É—á–∏—Ç–µ —Å—Å—ã–ª–∫—É! üöÄ`;

    await this.bot.sendMessage(chatId, helpText, { parse_mode: 'Markdown' });
  }

  /**
   * –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
   */
  cleanupTempFiles() {
    try {
      const files = fs.readdirSync(this.tempDir);
      const now = Date.now();
      
      files.forEach(file => {
        const filePath = path.join(this.tempDir, file);
        const stats = fs.statSync(filePath);
        
        // –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ 1 —á–∞—Å–∞
        if (now - stats.mtime.getTime() > 60 * 60 * 1000) {
          fs.unlinkSync(filePath);
          console.log(`üóëÔ∏è Cleaned up temp file: ${file}`);
        }
      });
    } catch (error) {
      console.error('‚ùå Error cleaning up temp files:', error);
    }
  }
}

module.exports = UploadHandler;
