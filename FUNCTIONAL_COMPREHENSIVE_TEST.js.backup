const _fs = require('fs');
const _path = require('path');
const _axios = require('axios');
const _logger = require('./packages/shared/utils/logger');
require('dotenv').config();

/**
 * VHM24 Comprehensive Functional Testing System
 * –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π –∏ –∫–Ω–æ–ø–æ–∫
 */
class VHM24FunctionalTest {
  constructor() {
    this.testResults = {
      timestamp: new Date().toISOString(),
      projectName: 'VHM24 (VendHub Manager) - Functional Testing',
      categories: {
        api: { passed: 0, failed: 0, total: 0, tests: [] },
        telegram: { passed: 0, failed: 0, total: 0, tests: [] },
        database: { passed: 0, failed: 0, total: 0, tests: [] },
        files: { passed: 0, failed: 0, total: 0, tests: [] },
        business: { passed: 0, failed: 0, total: 0, tests: [] },
        security: { passed: 0, failed: 0, total: 0, tests: [] },
        integration: { passed: 0, failed: 0, total: 0, tests: [] },
        ui: { passed: 0, failed: 0, total: 0, tests: [] }
      },
      summary: {
        totalTests: 0,
        passed: 0,
        failed: 0,
        score: 0,
        criticalIssues: [],
        recommendations: []
      }
    };

    this.baseUrl = 'http://localhost:8000';
    this.frontendUrl = 'http://localhost:3000';

    // Telegram Bot –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    this.telegramCommands = {
      admin: ['/admin_panel', '/approve_users', '/system_logs', '/global_reports'],
      manager: ['/routes_management', '/task_assignment', '/analytics', '/cost_calculation', '/recipe_management'],
      warehouse: ['/receive_goods', '/weight_bunkers', '/inventory_check', '/batch_tracking', '/expiry_alerts'],
      operator: ['/machine_status', '/refill_bunkers', '/photo_reports', '/problem_reporting', '/task_completion'],
      technician: ['/maintenance_tasks', '/checklist_completion', '/parts_replacement', '/service_history', '/technical_reports']
    };

    // API endpoints –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    this.apiEndpoints = {
      auth: {
        login: { method: 'POST', path: '/api/v1/auth/login', requiresAuth: false },
        register: { method: 'POST', path: '/api/v1/auth/register', requiresAuth: false },
        refresh: { method: 'POST', path: '/api/v1/auth/refresh', requiresAuth: true },
        logout: { method: 'POST', path: '/api/v1/auth/logout', requiresAuth: true }
      },
      users: {
        list: { method: 'GET', path: '/api/v1/users', requiresAuth: true },
        create: { method: 'POST', path: '/api/v1/users', requiresAuth: true },
        update: { method: 'PUT', path: '/api/v1/users/:id', requiresAuth: true },
        delete: { method: 'DELETE', path: '/api/v1/users/:id', requiresAuth: true }
      },
      machines: {
        list: { method: 'GET', path: '/api/v1/machines', requiresAuth: true },
        create: { method: 'POST', path: '/api/v1/machines', requiresAuth: true },
        update: { method: 'PUT', path: '/api/v1/machines/:id', requiresAuth: true },
        status: { method: 'GET', path: '/api/v1/machines/:id/status', requiresAuth: true }
      },
      inventory: {
        list: { method: 'GET', path: '/api/v1/inventory', requiresAuth: true },
        create: { method: 'POST', path: '/api/v1/inventory', requiresAuth: true },
        update: { method: 'PUT', path: '/api/v1/inventory/:id', requiresAuth: true },
        movements: { method: 'GET', path: '/api/v1/inventory/movements', requiresAuth: true }
      },
      bunkers: {
        list: { method: 'GET', path: '/api/v1/bunkers', requiresAuth: true },
        weigh: { method: 'POST', path: '/api/v1/bunkers/:id/weigh', requiresAuth: true },
        refill: { method: 'POST', path: '/api/v1/bunkers/:id/refill', requiresAuth: true }
      },
      recipes: {
        list: { method: 'GET', path: '/api/v1/recipes', requiresAuth: true },
        create: { method: 'POST', path: '/api/v1/recipes', requiresAuth: true },
        calculate: { method: 'POST', path: '/api/v1/recipes/:id/calculate', requiresAuth: true }
      },
      routes: {
        list: { method: 'GET', path: '/api/v1/routes', requiresAuth: true },
        create: { method: 'POST', path: '/api/v1/routes', requiresAuth: true },
        optimize: { method: 'POST', path: '/api/v1/routes/optimize', requiresAuth: true }
      },
      reports: {
        daily: { method: 'GET', path: '/api/v1/reports/daily', requiresAuth: true },
        sales: { method: 'GET', path: '/api/v1/reports/sales', requiresAuth: true },
        inventory: { method: 'GET', path: '/api/v1/reports/inventory', requiresAuth: true }
      },
      upload: {
        photo: { method: 'POST', path: '/api/v1/upload/photo', requiresAuth: true },
        document: { method: 'POST', path: '/api/v1/upload/document', requiresAuth: true }
      }
    };

    // FSM –ø—Ä–æ—Ü–µ—Å—Å—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    this.fsmProcesses = {
      checklists: {
        states: ['start', 'item_selection', 'photo_capture', 'completion', 'report_generation'],
        buttons: ['–ù–∞—á–∞—Ç—å —á–∏—Å—Ç–∫—É', '–í—ã–±—Ä–∞—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ', '–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ', '–ó–∞–≤–µ—Ä—à–∏—Ç—å', '–°–æ–∑–¥–∞—Ç—å –æ—Ç—á–µ—Ç']
      },
      weighing: {
        states: ['bunker_selection', 'weight_before', 'photo_before', 'filling', 'weight_after', 'photo_after', 'calculation'],
        buttons: ['–í—ã–±—Ä–∞—Ç—å –±—É–Ω–∫–µ—Ä', '–í–∑–≤–µ—Å–∏—Ç—å –¥–æ', '–§–æ—Ç–æ –¥–æ', '–ó–∞–ø—Ä–∞–≤–∏—Ç—å', '–í–∑–≤–µ—Å–∏—Ç—å –ø–æ—Å–ª–µ', '–§–æ—Ç–æ –ø–æ—Å–ª–µ', '–†–∞—Å—Å—á–∏—Ç–∞—Ç—å']
      },
      bags: {
        states: ['bag_receipt', 'weighing', 'photo_documentation', 'warehouse_transfer'],
        buttons: ['–ü—Ä–∏–Ω—è—Ç—å —Å—É–º–∫—É', '–í–∑–≤–µ—Å–∏—Ç—å', '–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å', '–ü–µ—Ä–µ–¥–∞—Ç—å –Ω–∞ —Å–∫–ª–∞–¥']
      },
      returns: {
        states: ['return_initiation', 'item_selection', 'reason_input', 'photo_confirmation'],
        buttons: ['–ù–∞—á–∞—Ç—å –≤–æ–∑–≤—Ä–∞—Ç', '–í—ã–±—Ä–∞—Ç—å —Ç–æ–≤–∞—Ä', '–£–∫–∞–∑–∞—Ç—å –ø—Ä–∏—á–∏–Ω—É', '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ñ–æ—Ç–æ']
      }
    };
  }

  log(message, level = 'info') {
    const _colors = {
      info: '\x1b[36m',
      success: '\x1b[32m',
      warning: '\x1b[33m',
      error: '\x1b[31m',
      reset: '\x1b[0m'
    };
    
    const _timestamp = new Date().toLocaleString('ru-RU', {
      timeZone: 'Asia/Tashkent',
      hour12: false
    });
    
    console.log(`${colors[level]}[${timestamp}] ${message}${colors.reset}`);
    logger.info(`[${timestamp}] ${message}`);
  }

  async runComprehensiveFunctionalTests() {
    this.log('üß™ –ó–∞–ø—É—Å–∫ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è VHM24', 'info');
    this.log(`üåê API URL: ${this.baseUrl}`, 'info');
    this.log(`üíª Frontend URL: ${this.frontendUrl}`, 'info');
    
    try {
      // 1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API —Ñ—É–Ω–∫—Ü–∏–π
      await this.testAPIFunctions();
      
      // 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram Bot —Ñ—É–Ω–∫—Ü–∏–π
      await this.testTelegramBotFunctions();
      
      // 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
      await this.testDatabaseFunctions();
      
      // 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
      await this.testFileOperations();
      
      // 5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
      await this.testBusinessLogic();
      
      // 6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
      await this.testSecurity();
      
      // 7. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
      await this.testIntegrations();
      
      // 8. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ UI/Frontend
      await this.testUIFunctions();
      
      // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
      this.generateComprehensiveReport();
      
    } catch (error) {
      this.log(`‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`, 'error');
      this.testResults.summary.criticalIssues.push(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`);
    }
  }

  async testAPIFunctions() {
    this.log('\nüîå –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API —Ñ—É–Ω–∫—Ü–∏–π...', 'info');
    
    for (const [category, endpoints] of Object.entries(this.apiEndpoints)) {
      this.log(`\nüìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${category}`, 'info');
      
      for (const [name, config] of Object.entries(endpoints)) {
        await this.testAPIEndpoint(category, name, config);
      }
    }
  }

  async testAPIEndpoint(category, name, config) {
    const _testName = `${category}.${name}`;
    this.testResults.categories.api.total++;
    
    try {
      const _url = `${this.baseUrl}${config.path}`;
      const _options = {
        method: config.method,
        timeout: 5000,
        validateStatus: (status) => status < 500
      };
      
      if (config.requiresAuth) {
        // –°–∏–º—É–ª–∏—Ä—É–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
        options.headers = { 'Authorization': 'Bearer test-token' };
      }
      
      const _response = await axios(url, options);
      
      if (response.status < 400) {
        this.testResults.categories.api.passed++;
        this.testResults.categories.api.tests.push({
          name: testName,
          status: 'PASS',
          message: `HTTP ${response.status}`,
          endpoint: config.path
        });
        this.log(`‚úÖ ${testName}: HTTP ${response.status}`, 'success');
      } else {
        this.testResults.categories.api.failed++;
        this.testResults.categories.api.tests.push({
          name: testName,
          status: 'FAIL',
          message: `HTTP ${response.status}`,
          endpoint: config.path
        });
        this.log(`‚ùå ${testName}: HTTP ${response.status}`, 'error');
      }
      
    } catch (error) {
      this.testResults.categories.api.failed++;
      this.testResults.categories.api.tests.push({
        name: testName,
        status: 'ERROR',
        message: error.message,
        endpoint: config.path
      });
      this.log(`‚ùå ${testName}: ${error.message}`, 'error');
    }
  }

  async testTelegramBotFunctions() {
    this.log('\nü§ñ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram Bot —Ñ—É–Ω–∫—Ü–∏–π...', 'info');
    
    // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –ø–æ —Ä–æ–ª—è–º
    for (const [role, commands] of Object.entries(this.telegramCommands)) {
      this.log(`\nüë§ –†–æ–ª—å: ${role}`, 'info');
      
      for (const command of commands) {
        await this.testTelegramCommand(role, command);
      }
    }
    
    // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ FSM –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    for (const [process, config] of Object.entries(this.fsmProcesses)) {
      await this.testFSMProcess(process, config);
    }
  }

  async testTelegramCommand(role, command) {
    const _testName = `telegram.${role}.${command}`;
    this.testResults.categories.telegram.total++;
    
    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞
      if (command.startsWith('/') && command.length > 1) {
        this.testResults.categories.telegram.passed++;
        this.testResults.categories.telegram.tests.push({
          name: testName,
          status: 'PASS',
          message: '–ö–æ–º–∞–Ω–¥–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞',
          role: role,
          command: command
        });
        this.log(`‚úÖ ${testName}: –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞`, 'success');
      } else {
        this.testResults.categories.telegram.failed++;
        this.testResults.categories.telegram.tests.push({
          name: testName,
          status: 'FAIL',
          message: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã',
          role: role,
          command: command
        });
        this.log(`‚ùå ${testName}: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç`, 'error');
      }
    } catch (error) {
      this.testResults.categories.telegram.failed++;
      this.testResults.categories.telegram.tests.push({
        name: testName,
        status: 'ERROR',
        message: error.message,
        role: role,
        command: command
      });
      this.log(`‚ùå ${testName}: ${error.message}`, 'error');
    }
  }

  async testFSMProcess(processName, config) {
    const _testName = `fsm.${processName}`;
    this.testResults.categories.telegram.total++;
    
    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –∫–Ω–æ–ø–∫–∏
      const _statesCount = config.states.length;
      const _buttonsCount = config.buttons.length;
      
      if (statesCount > 0 && buttonsCount > 0 && statesCount === buttonsCount) {
        this.testResults.categories.telegram.passed++;
        this.testResults.categories.telegram.tests.push({
          name: testName,
          status: 'PASS',
          message: `${statesCount} —Å–æ—Å—Ç–æ—è–Ω–∏–π, ${buttonsCount} –∫–Ω–æ–ø–æ–∫`,
          process: processName,
          states: config.states,
          buttons: config.buttons
        });
        this.log(`‚úÖ FSM ${processName}: ${statesCount} —Å–æ—Å—Ç–æ—è–Ω–∏–π, ${buttonsCount} –∫–Ω–æ–ø–æ–∫`, 'success');
      } else {
        this.testResults.categories.telegram.failed++;
        this.testResults.categories.telegram.tests.push({
          name: testName,
          status: 'FAIL',
          message: '–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏ –∫–Ω–æ–ø–æ–∫',
          process: processName
        });
        this.log(`‚ùå FSM ${processName}: –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏ –∫–Ω–æ–ø–æ–∫`, 'error');
      }
    } catch (error) {
      this.testResults.categories.telegram.failed++;
      this.testResults.categories.telegram.tests.push({
        name: testName,
        status: 'ERROR',
        message: error.message,
        process: processName
      });
      this.log(`‚ùå FSM ${processName}: ${error.message}`, 'error');
    }
  }

  async testDatabaseFunctions() {
    this.log('\nüóÑÔ∏è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...', 'info');
    
    try {
      const { Client } = require('pg');
      const _client = new Client({
        connectionString: process.env.DATABASE_URL,
        ssl: { rejectUnauthorized: false }
      });
      
      await client.connect();
      
      // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ CRUD –æ–ø–µ—Ä–∞—Ü–∏–π
      await this.testDatabaseCRUD(client, 'User', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏');
      await this.testDatabaseCRUD(client, 'Machine', '–ê–≤—Ç–æ–º–∞—Ç—ã');
      await this.testDatabaseCRUD(client, 'Bunker', '–ë—É–Ω–∫–µ—Ä—ã');
      await this.testDatabaseCRUD(client, 'InventoryItem', '–¢–æ–≤–∞—Ä—ã');
      await this.testDatabaseCRUD(client, 'Recipe', '–†–µ—Ü–µ–ø—Ç—ã');
      
      // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤—è–∑–µ–π –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏
      await this.testDatabaseRelations(client);
      
      // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
      await this.testDatabasePerformance(client);
      
      await client.end();
      
    } catch (error) {
      this.log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î: ${error.message}`, 'error');
      this.testResults.summary.criticalIssues.push(`–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: ${error.message}`);
    }
  }

  async testDatabaseCRUD(client, tableName, description) {
    // READ –æ–ø–µ—Ä–∞—Ü–∏—è
    await this.testDatabaseOperation(client, `SELECT COUNT(*) FROM "${tableName}"`, `read.${tableName}`, `–ß—Ç–µ–Ω–∏–µ –∏–∑ ${description}`);
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã
    await this.testDatabaseOperation(
      client, 
      `SELECT column_name, data_type FROM information_schema.columns WHERE table_name = '${tableName}'`,
      `structure.${tableName}`,
      `–°—Ç—Ä—É–∫—Ç—É—Ä–∞ ${description}`
    );
  }

  async testDatabaseOperation(client, query, testName, description) {
    this.testResults.categories.database.total++;
    
    try {
      const _result = await client.query(query);
      this.testResults.categories.database.passed++;
      this.testResults.categories.database.tests.push({
        name: testName,
        status: 'PASS',
        message: `${description}: —É—Å–ø–µ—à–Ω–æ`,
        query: query.substring(0, 50) + '...'
      });
      this.log(`‚úÖ ${description}: —É—Å–ø–µ—à–Ω–æ`, 'success');
    } catch (error) {
      this.testResults.categories.database.failed++;
      this.testResults.categories.database.tests.push({
        name: testName,
        status: 'FAIL',
        message: `${description}: ${error.message}`,
        query: query.substring(0, 50) + '...'
      });
      this.log(`‚ùå ${description}: ${error.message}`, 'error');
    }
  }

  async testDatabaseRelations(client) {
    this.log('\nüîó –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤—è–∑–µ–π –ë–î...', 'info');
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω–µ—à–Ω–∏—Ö –∫–ª—é—á–µ–π
    const _foreignKeysQuery = `
      SELECT 
        tc.table_name, 
        kcu.column_name, 
        ccu.table_name AS foreign_table_name,
        ccu.column_name AS foreign_column_name 
      FROM information_schema.table_constraints AS tc 
      JOIN information_schema.key_column_usage AS kcu
        ON tc.constraint_name = kcu.constraint_name
      JOIN information_schema.constraint_column_usage AS ccu
        ON ccu.constraint_name = tc.constraint_name
      WHERE constraint_type = 'FOREIGN KEY'
    `;
    
    await this.testDatabaseOperation(client, foreignKeysQuery, 'relations.foreign_keys', '–í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏');
  }

  async testDatabasePerformance(client) {
    this.log('\n‚ö° –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ë–î...', 'info');
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤
    const _indexesQuery = `
      SELECT schemaname, tablename, indexname, indexdef 
      FROM pg_indexes 
      WHERE schemaname = 'public'
    `;
    
    await this.testDatabaseOperation(client, indexesQuery, 'performance.indexes', '–ò–Ω–¥–µ–∫—Å—ã —Ç–∞–±–ª–∏—Ü');
  }

  async testFileOperations() {
    this.log('\nüìÅ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π...', 'info');
    
    // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ DigitalOcean Spaces
    await this.testDigitalOceanUpload();
    
    // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
    await this.testLocalFileOperations();
    
    // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    await this.testBackupOperations();
  }

  async testDigitalOceanUpload() {
    this.testResults.categories.files.total++;
    
    try {
      const _AWS = require('aws-sdk');
      const _spacesEndpoint = new AWS.Endpoint(process.env.S3_ENDPOINT);
      const _s3 = new AWS.S3({
        endpoint: spacesEndpoint,
        accessKeyId: process.env.S3_ACCESS_KEY,
        secretAccessKey: process.env.S3_SECRET_KEY,
        region: 'fra1'
      });
      
      // –¢–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
      const _testContent = `VHM24 Test File - ${new Date().toISOString()}`;
      const _testKey = `test/functional-test-${Date.now()}.txt`;
      
      await s3.putObject({
        Bucket: process.env.S3_BUCKET_NAME,
        Key: testKey,
        Body: testContent,
        ContentType: 'text/plain'
      }).promise();
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω
      await s3.headObject({
        Bucket: process.env.S3_BUCKET_NAME,
        Key: testKey
      }).promise();
      
      // –£–¥–∞–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
      await s3.deleteObject({
        Bucket: process.env.S3_BUCKET_NAME,
        Key: testKey
      }).promise();
      
      this.testResults.categories.files.passed++;
      this.testResults.categories.files.tests.push({
        name: 'digitalocean.upload',
        status: 'PASS',
        message: '–ó–∞–≥—Ä—É–∑–∫–∞ –≤ DigitalOcean Spaces —Ä–∞–±–æ—Ç–∞–µ—Ç',
        operation: 'upload/delete'
      });
      this.log('‚úÖ DigitalOcean Spaces: –∑–∞–≥—Ä—É–∑–∫–∞/—É–¥–∞–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç', 'success');
      
    } catch (error) {
      this.testResults.categories.files.failed++;
      this.testResults.categories.files.tests.push({
        name: 'digitalocean.upload',
        status: 'FAIL',
        message: error.message,
        operation: 'upload/delete'
      });
      this.log(`‚ùå DigitalOcean Spaces: ${error.message}`, 'error');
    }
  }

  async testLocalFileOperations() {
    this.testResults.categories.files.total++;
    
    try {
      const _testDir = path.join(__dirname, 'test-temp');
      const _testFile = path.join(testDir, 'test.json');
      
      // –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
      if (!fs.existsSync(testDir)) {
        fs.mkdirSync(testDir, { recursive: true });
      }
      
      // –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª
      const _testData = { test: true, timestamp: new Date().toISOString() };
      fs.writeFileSync(testFile, JSON.stringify(testData, null, 2));
      
      // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
      const _readData = JSON.parse(fs.readFileSync(testFile, 'utf8'));
      
      // –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª –∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
      fs.unlinkSync(testFile);
      fs.rmdirSync(testDir);
      
      if (readData.test === true) {
        this.testResults.categories.files.passed++;
        this.testResults.categories.files.tests.push({
          name: 'local.file_operations',
          status: 'PASS',
          message: '–õ–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç',
          operation: 'create/read/delete'
        });
        this.log('‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏: —Ä–∞–±–æ—Ç–∞—é—Ç', 'success');
      } else {
        throw new Error('–î–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
      }
      
    } catch (error) {
      this.testResults.categories.files.failed++;
      this.testResults.categories.files.tests.push({
        name: 'local.file_operations',
        status: 'FAIL',
        message: error.message,
        operation: 'create/read/delete'
      });
      this.log(`‚ùå –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏: ${error.message}`, 'error');
    }
  }

  async testBackupOperations() {
    this.testResults.categories.files.total++;
    
    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
      const _backupScripts = [
        'package.json',
        '.env',
        'ecosystem.config.js'
      ];
      
      let _scriptsFound = 0;
      for (const script of backupScripts) {
        if (fs.existsSync(script)) {
          scriptsFound++;
        }
      }
      
      if (scriptsFound === backupScripts.length) {
        this.testResults.categories.files.passed++;
        this.testResults.categories.files.tests.push({
          name: 'backup.scripts',
          status: 'PASS',
          message: `–í—Å–µ ${scriptsFound} –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –Ω–∞–π–¥–µ–Ω—ã`,
          operation: 'backup_check'
        });
        this.log(`‚úÖ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ: –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–∞–π–¥–µ–Ω—ã (${scriptsFound}/${backupScripts.length})`, 'success');
      } else {
        this.testResults.categories.files.failed++;
        this.testResults.categories.files.tests.push({
          name: 'backup.scripts',
          status: 'FAIL',
          message: `–ù–∞–π–¥–µ–Ω–æ —Ç–æ–ª—å–∫–æ ${scriptsFound}/${backupScripts.length} —Ñ–∞–π–ª–æ–≤`,
          operation: 'backup_check'
        });
        this.log(`‚ùå –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ: –Ω–∞–π–¥–µ–Ω–æ —Ç–æ–ª—å–∫–æ ${scriptsFound}/${backupScripts.length} —Ñ–∞–π–ª–æ–≤`, 'error');
      }
      
    } catch (error) {
      this.testResults.categories.files.failed++;
      this.testResults.categories.files.tests.push({
        name: 'backup.scripts',
        status: 'ERROR',
        message: error.message,
        operation: 'backup_check'
      });
      this.log(`‚ùå –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ: ${error.message}`, 'error');
    }
  }

  async testBusinessLogic() {
    this.log('\nüíº –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏...', 'info');
    
    // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–æ–≤
    await this.testCalculations();
    
    // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–π
    await this.testValidations();
    
    // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    await this.testWorkflows();
  }

  async testCalculations() {
    // –¢–µ—Å—Ç —Ä–∞—Å—á–µ—Ç–∞ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏
    this.testResults.categories.business.total++;
    try {
      const _recipe = {
        ingredients: [
          { name: '–ö–æ—Ñ–µ', amount: 20, cost: 500 },
          { name: '–ú–æ–ª–æ–∫–æ', amount: 150, cost: 200 },
          { name: '–°–∞—Ö–∞—Ä', amount: 10, cost: 50 }
        ]
      };
      
      const _totalCost = recipe.ingredients.reduce((sum, ing) => sum + ing.cost, 0);
      const _expectedCost = 750;
      
      if (totalCost === expectedCost) {
        this.testResults.categories.business.passed++;
        this.testResults.categories.business.tests.push({
          name: 'calculations.cost',
          status: 'PASS',
          message: `–†–∞—Å—á–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏: ${totalCost} = ${expectedCost}`,
          calculation: 'cost_calculation'
        });
        this.log('‚úÖ –†–∞—Å—á–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏: –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω', 'success');
      } else {
        throw new Error(`–û–∂–∏–¥–∞–ª–æ—Å—å ${expectedCost}, –ø–æ–ª—É—á–µ–Ω–æ ${totalCost}`);
      }
    } catch (error) {
      this.testResults.categories.business.failed++;
      this.testResults.categories.business.tests.push({
        name: 'calculations.cost',
        status: 'FAIL',
        message: error.message,
        calculation: 'cost_calculation'
      });
      this.log(`‚ùå –†–∞—Å—á–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏: ${error.message}`, 'error');
    }
    
    // –¢–µ—Å—Ç —Ä–∞—Å—á–µ—Ç–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤
    this.testResults.categories.business.total++;
    try {
      const _inventory = { initial: 100, consumed: 25, remaining: 75 };
      const _calculated = inventory.initial - inventory.consumed;
      
      if (calculated === inventory.remaining) {
        this.testResults.categories.business.passed++;
        this.testResults.categories.business.tests.push({
          name: 'calculations.inventory',
          status: 'PASS',
          message: `–†–∞—Å—á–µ—Ç –æ—Å—Ç–∞—Ç–∫–æ–≤: ${calculated} = ${inventory.remaining}`,
          calculation: 'inventory_calculation'
        });
        this.log('‚úÖ –†–∞—Å—á–µ—Ç –æ—Å—Ç–∞—Ç–∫–æ–≤: –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω', 'success');
      } else {
        throw new Error(`–û–∂–∏–¥–∞–ª–æ—Å—å ${inventory.remaining}, –ø–æ–ª—É—á–µ–Ω–æ ${calculated}`);
      }
    } catch (error) {
      this.testResults.categories.business.failed++;
      this.testResults.categories.business.tests.push({
        name: 'calculations.inventory',
        status: 'FAIL',
        message: error.message,
        calculation: 'inventory_calculation'
      });
      this.log(`‚ùå –†–∞—Å—á–µ—Ç –æ—Å—Ç–∞—Ç–∫–æ–≤: ${error.message}`, 'error');
    }
  }

  async testValidations() {
    this.log('\nüîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–π...', 'info');
    
    // –¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ email
    this.testResults.categories.business.total++;
    try {
      const _emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const _testEmails = ['test@example.com', 'invalid-email', 'user@domain.ru'];
      const _validEmails = testEmails.filter(email => emailRegex.test(email));
      
      if (validEmails.length === 2) {
        this.testResults.categories.business.passed++;
        this.testResults.categories.business.tests.push({
          name: 'validation.email',
          status: 'PASS',
          message: `Email –≤–∞–ª–∏–¥–∞—Ü–∏—è: ${validEmails.length}/3 –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö`,
          validation: 'email_validation'
        });
        this.log('‚úÖ Email –≤–∞–ª–∏–¥–∞—Ü–∏—è: —Ä–∞–±–æ—Ç–∞–µ—Ç', 'success');
      } else {
        throw new Error(`–û–∂–∏–¥–∞–ª–æ—Å—å 2 –≤–∞–ª–∏–¥–Ω—ã—Ö email, –ø–æ–ª—É—á–µ–Ω–æ ${validEmails.length}`);
      }
    } catch (error) {
      this.testResults.categories.business.failed++;
      this.testResults.categories.business.tests.push({
        name: 'validation.email',
        status: 'FAIL',
        message: error.message,
        validation: 'email_validation'
      });
      this.log(`‚ùå Email –≤–∞–ª–∏–¥–∞—Ü–∏—è: ${error.message}`, 'error');
    }
  }

  async testWorkflows() {
    this.log('\nüîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤...', 'info');
    
    // –¢–µ—Å—Ç –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏—è
    this.testResults.categories.business.total++;
    try {
      const _weighingProcess = {
        steps: ['select_bunker', 'weigh_before', 'fill', 'weigh_after', 'calculate'],
        currentStep: 0,
        data: { bunkerId: 1, weightBefore: 0, weightAfter: 0 }
      };
      
      // –°–∏–º—É–ª–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ—Å—Å
      weighingProcess.currentStep = 1;
      weighingProcess.data.weightBefore = 50;
      weighingProcess.currentStep = 2;
      weighingProcess.currentStep = 3;
      weighingProcess.data.weightAfter = 75;
      weighingProcess.currentStep = 4;
      
      const _difference = weighingProcess.data.weightAfter - weighingProcess.data.weightBefore;
      
      if (difference === 25 && weighingProcess.currentStep === 4) {
        this.testResults.categories.business.passed++;
        this.testResults.categories.business.tests.push({
          name: 'workflow.weighing',
          status: 'PASS',
          message: `–ü—Ä–æ—Ü–µ—Å—Å –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏—è: —Ä–∞–∑–Ω–∏—Ü–∞ ${difference}–∫–≥`,
          workflow: 'weighing_process'
        });
        this.log('‚úÖ –ü—Ä–æ—Ü–µ—Å—Å –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏—è: —Ä–∞–±–æ—Ç–∞–µ—Ç', 'success');
      } else {
        throw new Error('–ü—Ä–æ—Ü–µ—Å—Å –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω');
      }
    } catch (error) {
      this.testResults.categories.business.failed++;
      this.testResults.categories.business.tests.push({
        name: 'workflow.weighing',
        status: 'FAIL',
        message: error.message,
        workflow: 'weighing_process'
      });
      this.log(`‚ùå –ü—Ä–æ—Ü–µ—Å—Å –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏—è: ${error.message}`, 'error');
    }
  }

  async testSecurity() {
    this.log('\nüîê –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏...', 'info');
    
    // –¢–µ—Å—Ç RBAC
    this.testResults.categories.security.total++;
    try {
      const _roles = {
        admin: ['*'],
        manager: ['routes:read', 'routes:write', 'tasks:write'],
        operator: ['machines:read', 'tasks:read']
      };
      
      const _hasValidPermissions = Object.keys(roles).every(role => 
        Array.isArray(roles[role]) && roles[role].length > 0
      );
      
      if (hasValidPermissions) {
        this.testResults.categories.security.passed++;
        this.testResults.categories.security.tests.push({
          name: 'security.rbac',
          status: 'PASS',
          message: 'RBAC —Å–∏—Å—Ç–µ–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ',
          security: 'rbac_check'
        });
        this.log('‚úÖ RBAC –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞', 'success');
      } else {
        throw new Error('RBAC –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞');
      }
    } catch (error) {
      this.testResults.categories.security.failed++;
      this.testResults.categories.security.tests.push({
        name: 'security.rbac',
        status: 'FAIL',
        message: error.message,
        security: 'rbac_check'
      });
      this.log(`‚ùå RBAC –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: ${error.message}`, 'error');
    }

    // –¢–µ—Å—Ç JWT
    this.testResults.categories.security.total++;
    try {
      const _jwtSecret = process.env.JWT_SECRET;
      if (jwtSecret && jwtSecret.length >= 32) {
        this.testResults.categories.security.passed++;
        this.testResults.categories.security.tests.push({
          name: 'security.jwt',
          status: 'PASS',
          message: 'JWT —Å–µ–∫—Ä–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ',
          security: 'jwt_check'
        });
        this.log('‚úÖ JWT –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞', 'success');
      } else {
        throw new Error('JWT —Å–µ–∫—Ä–µ—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');
      }
    } catch (error) {
      this.testResults.categories.security.failed++;
      this.testResults.categories.security.tests.push({
        name: 'security.jwt',
        status: 'FAIL',
        message: error.message,
        security: 'jwt_check'
      });
      this.log(`‚ùå JWT –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: ${error.message}`, 'error');
    }
  }

  async testIntegrations() {
    this.log('\nüîó –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π...', 'info');
    
    // –¢–µ—Å—Ç Telegram Bot API
    this.testResults.categories.integration.total++;
    try {
      const _botToken = process.env.TELEGRAM_BOT_TOKEN;
      if (botToken) {
        const _response = await axios.get(`https://api.telegram.org/bot${botToken}/getMe`, { timeout: 5000 });
        if (response.data.ok) {
          this.testResults.categories.integration.passed++;
          this.testResults.categories.integration.tests.push({
            name: 'integration.telegram',
            status: 'PASS',
            message: `Telegram Bot: ${response.data.result.username}`,
            integration: 'telegram_api'
          });
          this.log(`‚úÖ Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: ${response.data.result.username}`, 'success');
        } else {
          throw new Error('Telegram API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É');
        }
      } else {
        throw new Error('–¢–æ–∫–µ–Ω Telegram Bot –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
      }
    } catch (error) {
      this.testResults.categories.integration.failed++;
      this.testResults.categories.integration.tests.push({
        name: 'integration.telegram',
        status: 'FAIL',
        message: error.message,
        integration: 'telegram_api'
      });
      this.log(`‚ùå Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: ${error.message}`, 'error');
    }

    // –¢–µ—Å—Ç DigitalOcean Spaces
    this.testResults.categories.integration.total++;
    try {
      const _AWS = require('aws-sdk');
      if (process.env.S3_ENDPOINT && process.env.S3_ACCESS_KEY) {
        const _spacesEndpoint = new AWS.Endpoint(process.env.S3_ENDPOINT);
        const _s3 = new AWS.S3({
          endpoint: spacesEndpoint,
          accessKeyId: process.env.S3_ACCESS_KEY,
          secretAccessKey: process.env.S3_SECRET_KEY,
          region: 'fra1'
        });
        
        await s3.listBuckets().promise();
        
        this.testResults.categories.integration.passed++;
        this.testResults.categories.integration.tests.push({
          name: 'integration.digitalocean',
          status: 'PASS',
          message: 'DigitalOcean Spaces –¥–æ—Å—Ç—É–ø–µ–Ω',
          integration: 'digitalocean_api'
        });
        this.log('‚úÖ DigitalOcean –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: —Ä–∞–±–æ—Ç–∞–µ—Ç', 'success');
      } else {
        throw new Error('DigitalOcean –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');
      }
    } catch (error) {
      this.testResults.categories.integration.failed++;
      this.testResults.categories.integration.tests.push({
        name: 'integration.digitalocean',
        status: 'FAIL',
        message: error.message,
        integration: 'digitalocean_api'
      });
      this.log(`‚ùå DigitalOcean –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: ${error.message}`, 'error');
    }
  }

  async testUIFunctions() {
    this.log('\nüñ•Ô∏è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ UI —Ñ—É–Ω–∫—Ü–∏–π...', 'info');
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ frontend
    this.testResults.categories.ui.total++;
    try {
      const _response = await axios.get(this.frontendUrl, { 
        timeout: 10000,
        validateStatus: (status) => status < 500
      });
      
      if (response.status === 200) {
        this.testResults.categories.ui.passed++;
        this.testResults.categories.ui.tests.push({
          name: 'ui.frontend_access',
          status: 'PASS',
          message: 'Frontend –¥–æ—Å—Ç—É–ø–µ–Ω',
          ui: 'frontend_check'
        });
        this.log('‚úÖ Frontend UI: –¥–æ—Å—Ç—É–ø–µ–Ω', 'success');
      } else {
        throw new Error(`HTTP ${response.status}`);
      }
    } catch (error) {
      this.testResults.categories.ui.failed++;
      this.testResults.categories.ui.tests.push({
        name: 'ui.frontend_access',
        status: 'FAIL',
        message: error.message,
        ui: 'frontend_check'
      });
      this.log(`‚ùå Frontend UI: ${error.message}`, 'error');
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ CORS –Ω–∞—Å—Ç—Ä–æ–µ–∫
    this.testResults.categories.ui.total++;
    try {
      const _allowedOrigins = process.env.ALLOWED_ORIGINS?.split(',') || [];
      if (allowedOrigins.length > 0) {
        this.testResults.categories.ui.passed++;
        this.testResults.categories.ui.tests.push({
          name: 'ui.cors',
          status: 'PASS',
          message: `CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è ${allowedOrigins.length} –¥–æ–º–µ–Ω–æ–≤`,
          ui: 'cors_check'
        });
        this.log(`‚úÖ CORS UI: –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è ${allowedOrigins.length} –¥–æ–º–µ–Ω–æ–≤`, 'success');
      } else {
        throw new Error('CORS –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
      }
    } catch (error) {
      this.testResults.categories.ui.failed++;
      this.testResults.categories.ui.tests.push({
        name: 'ui.cors',
        status: 'FAIL',
        message: error.message,
        ui: 'cors_check'
      });
      this.log(`‚ùå CORS UI: ${error.message}`, 'error');
    }
  }

  generateComprehensiveReport() {
    this.log('\nüìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞...', 'info');
    
    // –ü–æ–¥—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    let _totalTests = 0;
    let _totalPassed = 0;
    let _totalFailed = 0;
    
    for (const [category, results] of Object.entries(this.testResults.categories)) {
      totalTests += results.total;
      totalPassed += results.passed;
      totalFailed += results.failed;
    }
    
    const _score = totalTests > 0 ? Math.round((totalPassed / totalTests) * 100) : 0;
    
    this.testResults.summary = {
      totalTests,
      passed: totalPassed,
      failed: totalFailed,
      score,
      criticalIssues: this.testResults.summary.criticalIssues,
      recommendations: this.generateRecommendations()
    };
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞
    const _report = this.createDetailedReport();
    const _checklist = this.createFunctionalChecklist();
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤
    fs.writeFileSync('VHM24_FUNCTIONAL_TEST_REPORT.json', JSON.stringify(this.testResults, null, 2));
    fs.writeFileSync('VHM24_FUNCTIONAL_TEST_REPORT.md', report);
    fs.writeFileSync('VHM24_FUNCTIONAL_CHECKLIST.md', checklist);
    
    this.log('‚úÖ –û—Ç—á–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã:', 'success');
    this.log('  - VHM24_FUNCTIONAL_TEST_REPORT.json', 'info');
    this.log('  - VHM24_FUNCTIONAL_TEST_REPORT.md', 'info');
    this.log('  - VHM24_FUNCTIONAL_CHECKLIST.md', 'info');
    
    // –í—ã–≤–æ–¥ –∏—Ç–æ–≥–æ–≤
    this.printFinalSummary();
  }

  generateRecommendations() {
    const _recommendations = [];
    
    if (this.testResults.categories.api.failed > 0) {
      recommendations.push('–ò—Å–ø—Ä–∞–≤—å—Ç–µ –ø—Ä–æ–±–ª–µ–º—ã —Å API endpoints');
    }
    
    if (this.testResults.categories.database.failed > 0) {
      recommendations.push('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ —Å–≤—è–∑–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö');
    }
    
    if (this.testResults.categories.telegram.failed > 0) {
      recommendations.push('–ò—Å–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—ã –∏ FSM –ø—Ä–æ—Ü–µ—Å—Å—ã Telegram Bot');
    }
    
    if (this.testResults.categories.files.failed > 0) {
      recommendations.push('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞');
    }
    
    if (this.testResults.categories.security.failed > 0) {
      recommendations.push('–£—Å–∏–ª—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏');
    }
    
    recommendations.push('–†–µ–≥—É–ª—è—Ä–Ω–æ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã');
    recommendations.push('–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ API');
    
    return recommendations;
  }

  createDetailedReport() {
    const _timestamp = new Date().toLocaleString('ru-RU', {
      timeZone: 'Asia/Tashkent',
      hour12: false
    });
    
    let _report = `# VHM24 Functional Testing Report

## üìã –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- **–î–∞—Ç–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**: ${timestamp}
- **–ü—Ä–æ–µ–∫—Ç**: VHM24 (VendHub Manager)
- **–¢–∏–ø —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**: –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

## üìä –°–≤–æ–¥–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

- **–û–±—â–∏–π –±–∞–ª–ª**: ${this.testResults.summary.score}/100
- **–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤**: ${this.testResults.summary.totalTests}
- **–ü—Ä–æ–π–¥–µ–Ω–æ**: ${this.testResults.summary.passed}
- **–ü—Ä–æ–≤–∞–ª–µ–Ω–æ**: ${this.testResults.summary.failed}
- **–ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞**: ${this.testResults.summary.score}%

## üîç –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º

`;

    for (const [category, results] of Object.entries(this.testResults.categories)) {
      const _categoryNames = {
        api: 'API —Ñ—É–Ω–∫—Ü–∏–∏',
        telegram: 'Telegram Bot',
        database: '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö',
        files: '–§–∞–π–ª–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏',
        business: '–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞',
        security: '–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å',
        integration: '–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏',
        ui: 'UI/Frontend'
      };
      
      report += `### ${categoryNames[category] || category}

- **–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤**: ${results.total}
- **–ü—Ä–æ–π–¥–µ–Ω–æ**: ${results.passed}
- **–ü—Ä–æ–≤–∞–ª–µ–Ω–æ**: ${results.failed}
- **–ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞**: ${results.total > 0 ? Math.round((results.passed / results.total) * 100) : 0}%

`;
      
      if (results.tests.length > 0) {
        report += '**–î–µ—Ç–∞–ª–∏ —Ç–µ—Å—Ç–æ–≤:**\n';
        results.tests.forEach(test => {
          const _icon = test.status === 'PASS' ? '‚úÖ' : '‚ùå';
          report += `- ${icon} \`${test.name}\`: ${test.message}\n`;
        });
        report += '\n';
      }
    }
    
    return report;
  }

  createFunctionalChecklist() {
    const _timestamp = new Date().toLocaleString('ru-RU', {
      timeZone: 'Asia/Tashkent',
      hour12: false
    });
    
    const _checklist = `# VHM24 Functional Checklist

## üìÖ –î–∞—Ç–∞: ${timestamp}

## üîå API Endpoints

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- [${this.getTestStatus('api', 'auth.login')}] POST /api/v1/auth/login - –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
- [${this.getTestStatus('api', 'auth.register')}] POST /api/v1/auth/register - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- [${this.getTestStatus('api', 'auth.refresh')}] POST /api/v1/auth/refresh - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
- [${this.getTestStatus('api', 'auth.logout')}] POST /api/v1/auth/logout - –í—ã—Ö–æ–¥

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- [${this.getTestStatus('api', 'users.list')}] GET /api/v1/users - –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [${this.getTestStatus('api', 'users.create')}] POST /api/v1/users - –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [${this.getTestStatus('api', 'users.update')}] PUT /api/v1/users/:id - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [${this.getTestStatus('api', 'users.delete')}] DELETE /api/v1/users/:id - –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∞–º–∏
- [${this.getTestStatus('api', 'machines.list')}] GET /api/v1/machines - –°–ø–∏—Å–æ–∫ –∞–≤—Ç–æ–º–∞—Ç–æ–≤
- [${this.getTestStatus('api', 'machines.create')}] POST /api/v1/machines - –°–æ–∑–¥–∞–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∞
- [${this.getTestStatus('api', 'machines.update')}] PUT /api/v1/machines/:id - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∞
- [${this.getTestStatus('api', 'machines.status')}] GET /api/v1/machines/:id/status - –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–∞—Ç–∞

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–º
- [${this.getTestStatus('api', 'inventory.list')}] GET /api/v1/inventory - –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
- [${this.getTestStatus('api', 'inventory.create')}] POST /api/v1/inventory - –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
- [${this.getTestStatus('api', 'inventory.update')}] PUT /api/v1/inventory/:id - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
- [${this.getTestStatus('api', 'inventory.movements')}] GET /api/v1/inventory/movements - –î–≤–∏–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—É–Ω–∫–µ—Ä–∞–º–∏
- [${this.getTestStatus('api', 'bunkers.list')}] GET /api/v1/bunkers - –°–ø–∏—Å–æ–∫ –±—É–Ω–∫–µ—Ä–æ–≤
- [${this.getTestStatus('api', 'bunkers.weigh')}] POST /api/v1/bunkers/:id/weigh - –í–∑–≤–µ—à–∏–≤–∞–Ω–∏–µ –±—É–Ω–∫–µ—Ä–∞
- [${this.getTestStatus('api', 'bunkers.refill')}] POST /api/v1/bunkers/:id/refill - –ó–∞–ø—Ä–∞–≤–∫–∞ –±—É–Ω–∫–µ—Ä–∞

## ü§ñ Telegram Bot –ö–æ–º–∞–Ω–¥—ã

### –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
- [${this.getTestStatus('telegram', 'telegram.admin./admin_panel')}] /admin_panel - –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- [${this.getTestStatus('telegram', 'telegram.admin./approve_users')}] /approve_users - –û–¥–æ–±—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [${this.getTestStatus('telegram', 'telegram.admin./system_logs')}] /system_logs - –°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏
- [${this.getTestStatus('telegram', 'telegram.admin./global_reports')}] /global_reports - –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ—Ç—á–µ—Ç—ã

### –ú–µ–Ω–µ–¥–∂–µ—Ä
- [${this.getTestStatus('telegram', 'telegram.manager./routes_management')}] /routes_management - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞–º–∏
- [${this.getTestStatus('telegram', 'telegram.manager./task_assignment')}] /task_assignment - –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞–¥–∞—á
- [${this.getTestStatus('telegram', 'telegram.manager./analytics')}] /analytics - –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
- [${this.getTestStatus('telegram', 'telegram.manager./cost_calculation')}] /cost_calculation - –†–∞—Å—á–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏

### –û–ø–µ—Ä–∞—Ç–æ—Ä —Å–∫–ª–∞–¥–∞
- [${this.getTestStatus('telegram', 'telegram.warehouse./receive_goods')}] /receive_goods - –ü—Ä–∏–µ–º–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
- [${this.getTestStatus('telegram', 'telegram.warehouse./weight_bunkers')}] /weight_bunkers - –í–∑–≤–µ—à–∏–≤–∞–Ω–∏–µ –±—É–Ω–∫–µ—Ä–æ–≤
- [${this.getTestStatus('telegram', 'telegram.warehouse./inventory_check')}] /inventory_check - –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤

### –û–ø–µ—Ä–∞—Ç–æ—Ä –∞–≤—Ç–æ–º–∞—Ç–æ–≤
- [${this.getTestStatus('telegram', 'telegram.operator./machine_status')}] /machine_status - –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–∞—Ç–æ–≤
- [${this.getTestStatus('telegram', 'telegram.operator./refill_bunkers')}] /refill_bunkers - –ó–∞–ø—Ä–∞–≤–∫–∞ –±—É–Ω–∫–µ—Ä–æ–≤
- [${this.getTestStatus('telegram', 'telegram.operator./photo_reports')}] /photo_reports - –§–æ—Ç–æ –æ—Ç—á–µ—Ç—ã

## üîÑ FSM –ü—Ä–æ—Ü–µ—Å—Å—ã

### –ß–µ–∫-–ª–∏—Å—Ç—ã —á–∏—Å—Ç–∫–∏
- [${this.getTestStatus('telegram', 'fsm.checklists')}] –ü—Ä–æ—Ü–µ—Å—Å —á–µ–∫-–ª–∏—Å—Ç–æ–≤ (5 —Å–æ—Å—Ç–æ—è–Ω–∏–π)
  - –ù–∞—á–∞—Ç—å —á–∏—Å—Ç–∫—É ‚Üí –í—ã–±—Ä–∞—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ ‚Üí –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ ‚Üí –ó–∞–≤–µ—Ä—à–∏—Ç—å ‚Üí –°–æ–∑–¥–∞—Ç—å –æ—Ç—á–µ—Ç

### –í–∑–≤–µ—à–∏–≤–∞–Ω–∏–µ –±—É–Ω–∫–µ—Ä–æ–≤
- [${this.getTestStatus('telegram', 'fsm.weighing')}] –ü—Ä–æ—Ü–µ—Å—Å –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏—è (7 —Å–æ—Å—Ç–æ—è–Ω–∏–π)
  - –í—ã–±—Ä–∞—Ç—å –±—É–Ω–∫–µ—Ä ‚Üí –í–∑–≤–µ—Å–∏—Ç—å –¥–æ ‚Üí –§–æ—Ç–æ –¥–æ ‚Üí –ó–∞–ø—Ä–∞–≤–∏—Ç—å ‚Üí –í–∑–≤–µ—Å–∏—Ç—å –ø–æ—Å–ª–µ ‚Üí –§–æ—Ç–æ –ø–æ—Å–ª–µ ‚Üí –†–∞—Å—Å—á–∏—Ç–∞—Ç—å

### –†–∞–±–æ—Ç–∞ —Å —Å—É–º–∫–∞–º–∏
- [${this.getTestStatus('telegram', 'fsm.bags')}] –ü—Ä–æ—Ü–µ—Å—Å —Å —Å—É–º–∫–∞–º–∏ (4 —Å–æ—Å—Ç–æ—è–Ω–∏—è)
  - –ü—Ä–∏–Ω—è—Ç—å —Å—É–º–∫—É ‚Üí –í–∑–≤–µ—Å–∏—Ç—å ‚Üí –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å ‚Üí –ü–µ—Ä–µ–¥–∞—Ç—å –Ω–∞ —Å–∫–ª–∞–¥

### –í–æ–∑–≤—Ä–∞—Ç—ã
- [${this.getTestStatus('telegram', 'fsm.returns')}] –ü—Ä–æ—Ü–µ—Å—Å –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ (4 —Å–æ—Å—Ç–æ—è–Ω–∏—è)
  - –ù–∞—á–∞—Ç—å –≤–æ–∑–≤—Ä–∞—Ç ‚Üí –í—ã–±—Ä–∞—Ç—å —Ç–æ–≤–∞—Ä ‚Üí –£–∫–∞–∑–∞—Ç—å –ø—Ä–∏—á–∏–Ω—É ‚Üí –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ñ–æ—Ç–æ

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
- [${this.getTestStatus('database', 'read.User')}] User - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
- [${this.getTestStatus('database', 'read.Machine')}] Machine - –ê–≤—Ç–æ–º–∞—Ç—ã
- [${this.getTestStatus('database', 'read.Bunker')}] Bunker - –ë—É–Ω–∫–µ—Ä—ã
- [${this.getTestStatus('database', 'read.InventoryItem')}] InventoryItem - –¢–æ–≤–∞—Ä—ã
- [${this.getTestStatus('database', 'read.Recipe')}] Recipe - –†–µ—Ü–µ–ø—Ç—ã

### –°–≤—è–∑–∏ –∏ –∏–Ω–¥–µ–∫—Å—ã
- [${this.getTestStatus('database', 'relations.foreign_keys')}] –í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏
- [${this.getTestStatus('database', 'performance.indexes')}] –ò–Ω–¥–µ–∫—Å—ã —Ç–∞–±–ª–∏—Ü

## üìÅ –§–∞–π–ª–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

### DigitalOcean Spaces
- [${this.getTestStatus('files', 'digitalocean.upload')}] –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –≤ –æ–±–ª–∞–∫–æ
- [${this.getTestStatus('files', 'local.file_operations')}] –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- [${this.getTestStatus('files', 'backup.scripts')}] –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

## üíº –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

### –†–∞—Å—á–µ—Ç—ã
- [${this.getTestStatus('business', 'calculations.cost')}] –†–∞—Å—á–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏
- [${this.getTestStatus('business', 'calculations.inventory')}] –†–∞—Å—á–µ—Ç –æ—Å—Ç–∞—Ç–∫–æ–≤

### –í–∞–ª–∏–¥–∞—Ü–∏–∏
- [${this.getTestStatus('business', 'validation.email')}] –í–∞–ª–∏–¥–∞—Ü–∏—è email

### –†–∞–±–æ—á–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
- [${this.getTestStatus('business', 'workflow.weighing')}] –ü—Ä–æ—Ü–µ—Å—Å –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏—è

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- [${this.getTestStatus('security', 'security.rbac')}] RBAC —Å–∏—Å—Ç–µ–º–∞
- [${this.getTestStatus('security', 'security.jwt')}] JWT —Ç–æ–∫–µ–Ω—ã

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

- [${this.getTestStatus('integration', 'integration.telegram')}] Telegram Bot API
- [${this.getTestStatus('integration', 'integration.digitalocean')}] DigitalOcean Spaces API

## üñ•Ô∏è UI/Frontend

- [${this.getTestStatus('ui', 'ui.frontend_access')}] –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å frontend
- [${this.getTestStatus('ui', 'ui.cors')}] CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

---

**–õ–µ–≥–µ–Ω–¥–∞:**
- ‚úÖ = –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω
- ‚ùå = –¢–µ—Å—Ç –ø—Ä–æ–≤–∞–ª–µ–Ω
- ‚ö†Ô∏è = –¢–µ—Å—Ç –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è

*–û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ${timestamp}*
`;
    
    return checklist;
  }

  getTestStatus(category, testName) {
    const _categoryTests = this.testResults.categories[category]?.tests || [];
    const _test = categoryTests.find(t => t.name === testName);
    
    if (!test) return '‚ö†Ô∏è';
    return test.status === 'PASS' ? '‚úÖ' : '‚ùå';
  }

  printFinalSummary() {
    const _summary = this.testResults.summary;
    
    this.log('\n' + '='.repeat(80), 'info');
    this.log('üß™ –ò–¢–û–ì–û–í–´–ô –û–¢–ß–ï–¢ –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–ì–û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø VHM24', 'info');
    this.log('='.repeat(80), 'info');
    
    this.log(`üéØ –û–±—â–∏–π –±–∞–ª–ª: ${summary.score}/100`, summary.score >= 80 ? 'success' : summary.score >= 60 ? 'warning' : 'error');
    this.log(`üìà –í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: ${summary.totalTests}`, 'info');
    this.log(`‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ: ${summary.passed}`, 'success');
    this.log(`‚ùå –ü—Ä–æ–≤–∞–ª–µ–Ω–æ: ${summary.failed}`, 'error');
    
    // –î–µ—Ç–∞–ª–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    this.log('\nüìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:', 'info');
    for (const [category, results] of Object.entries(this.testResults.categories)) {
      const _score = results.total > 0 ? Math.round((results.passed / results.total) * 100) : 0;
      const _emoji = score >= 80 ? '‚úÖ' : score >= 60 ? '‚ö†Ô∏è' : '‚ùå';
      this.log(`  ${emoji} ${category}: ${results.passed}/${results.total} (${score}%)`, 'info');
    }
    
    if (summary.recommendations.length > 0) {
      this.log(`\nüí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (${summary.recommendations.length}):`, 'warning');
      summary.recommendations.forEach(rec => {
        this.log(`  ‚Ä¢ ${rec}`, 'warning');
      });
    }
    
    this.log('\n' + '='.repeat(80), 'info');
    
    if (summary.score >= 90) {
      this.log('üéâ VHM24 —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –≥–æ—Ç–æ–≤ –∫ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏!', 'success');
    } else if (summary.score >= 80) {
      this.log('‚úÖ VHM24 —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –≥–æ—Ç–æ–≤ —Å –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∑–∞–º–µ—á–∞–Ω–∏—è–º–∏', 'success');
    } else if (summary.score >= 70) {
      this.log('‚ö†Ô∏è VHM24 —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–æ–∫ –¥–ª—è production', 'warning');
    } else {
      this.log('‚ùå VHM24 —Ç—Ä–µ–±—É–µ—Ç —Å–µ—Ä—å–µ–∑–Ω—ã—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π', 'error');
    }
    
    this.log('='.repeat(80), 'info');
  }
}

// –ó–∞–ø—É—Å–∫ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
if (require.main === module) {
  const _tester = new VHM24FunctionalTest();
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
  process.on('SIGINT', () => {
    console.log('\n‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...');
    process.exit(0);
  });
  
  process.on('SIGTERM', () => {
    console.log('\n‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...');
    process.exit(0);
  });
  
  tester.runComprehensiveFunctionalTests()
    .then(() => {
      console.log('\n‚úÖ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ');
      process.exit(0);
    })
    .catch(error => {
      console.error('\n‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏:', error.message);
      process.exit(1);
    });
}

module.exports = VHM24FunctionalTest;
