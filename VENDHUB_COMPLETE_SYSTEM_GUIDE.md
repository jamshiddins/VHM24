# Руководство по запуску и использованию системы VendHub

## Обзор системы

VendHub - это комплексная система управления вендинговыми автоматами, состоящая из следующих компонентов:

1. **API-сервер** - обрабатывает запросы от веб-интерфейса и Telegram-бота
2. **Telegram-бот** - предоставляет интерфейс для мобильного управления системой
3. **База данных** - хранит информацию о пользователях, автоматах, задачах и т.д.
4. **Веб-интерфейс** - предоставляет графический интерфейс для управления системой

Система использует **конечные автоматы (FSM)** для организации и контроля всех рабочих процессов в Telegram-боте. Вся логика работы бота построена на пошаговых FSM-сценариях, что обеспечивает интуитивно понятное взаимодействие с пользователем через кнопки и минимизирует ошибки.

## Требования

- Node.js 16.x или выше
- npm 7.x или выше
- PostgreSQL 13.x или выше (опционально, можно использовать SQLite)
- Telegram Bot Token (получить у @BotFather)

## Установка

1. Клонировать репозиторий:
   ```bash
   git clone https://github.com/jamshiddins/VHM24.git
   cd VHM24
   ```

2. Установить зависимости:
   ```bash
   npm install
   ```

3. Создать файл `.env` на основе `.env.example`:
   ```bash
   cp .env.example .env
   ```

4. Отредактировать файл `.env` и указать необходимые переменные окружения:
   ```
   # Основные настройки
   NODE_ENV=development
   PORT=3000
   
   # База данных
   DATABASE_URL=file:./dev.db
   SKIP_DATABASE=true
   
   # Telegram Bot
   TELEGRAM_BOT_TOKEN=your_telegram_bot_token
   ADMIN_IDS=123456789,987654321
   
   # API и Webhook
   API_BASE_URL=http://localhost:3000
   WEBHOOK_URL=http://localhost:3000/api/telegram/webhook
   ```

## Запуск системы

### Запуск в режиме разработки

Для запуска только Telegram-бота без подключения к базе данных:
```bash
node start-telegram-bot.js
```

Для запуска полной системы (API-сервер + Telegram-бот) с синхронизацией:
```bash
node start-vendhub-complete.js
```

### Запуск в production режиме

Для запуска в production режиме с настройкой вебхуков:
```bash
NODE_ENV=production node start-vendhub-complete.js
```

## Структура FSM-сценариев

Система VendHubBot использует 17 FSM-сценариев для организации всех рабочих процессов:

1. **main_menu_fsm** - Главное меню с динамической адаптацией под роль пользователя
2. **task_create_fsm** - Создание новых задач для операторов, техников и склада
3. **task_execution_fsm** - Выполнение назначенных задач по чек-листу
4. **checklist_fsm** - Пошаговое прохождение чек-листа в рамках задачи
5. **bag_fsm** - Формирование сумок-комплектов для оператора
6. **warehouse_receive_fsm** - Приём новых ингредиентов и товаров на склад
7. **warehouse_return_fsm** - Приём возвратов от оператора
8. **warehouse_check_inventory_fsm** - Проведение инвентаризации складских запасов
9. **cash_fsm** - Учёт инкассации и сверка наличности
10. **retro_fsm** - Ретроспективный ввод данных о прошлых действиях
11. **error_fsm** - Фиксация ошибок и проблем
12. **import_fsm** - Загрузка отчётов из внешних систем
13. **directory_fsm** - Управление всеми справочниками в системе
14. **user_fsm** - Управление пользователями системы
15. **report_fsm** - Генерация и просмотр отчётов
16. **finance_fsm** - Учёт доходов, расходов и баланса компании
17. **admin_fsm** - Системные настройки и управление

## Команды Telegram-бота

Telegram-бот поддерживает следующие команды:

- `/start` - Запуск бота и переход к главному меню
- `/help` - Получение справки по использованию бота
- `/admin` - Переход к административным функциям
- `/finance` - Переход к финансовым функциям
- `/report` - Переход к отчетам
- `/user` - Переход к управлению пользователями
- `/directory` - Переход к справочникам
- `/import` - Переход к импорту данных
- `/error` - Переход к фиксации ошибок
- `/retro` - Переход к ретроспективному вводу данных
- `/cash` - Переход к учету инкассации
- `/warehouse_inventory` - Переход к инвентаризации склада
- `/warehouse_return` - Переход к приему возвратов
- `/warehouse_receive` - Переход к приему товаров на склад
- `/bag` - Переход к формированию сумок
- `/checklist` - Переход к чек-листам
- `/task_execution` - Переход к выполнению задач
- `/task_create` - Переход к созданию задач
- `/main_menu` - Возврат в главное меню

## API Endpoints

API-сервер предоставляет следующие основные эндпоинты:

- `GET /api/health` - Проверка работоспособности API
- `GET /api/users` - Получение списка пользователей
- `GET /api/machines` - Получение списка автоматов
- `GET /api/tasks` - Получение списка задач
- `POST /api/telegram/webhook` - Вебхук для Telegram-бота
- `POST /api/telegram/setWebhook` - Установка вебхука для Telegram-бота
- `GET /api/telegram/status` - Проверка статуса вебхука

## Синхронизация между ботом и веб-интерфейсом

Система обеспечивает синхронизацию данных между Telegram-ботом и веб-интерфейсом через API-сервер. Все изменения, сделанные через бота, сразу же доступны в веб-интерфейсе и наоборот.

Основные механизмы синхронизации:

1. **Общая база данных** - оба компонента используют одну и ту же базу данных
2. **API-сервер** - все запросы проходят через API-сервер, который обеспечивает единую точку доступа к данным
3. **Вебхуки** - Telegram-бот использует вебхуки для получения обновлений в реальном времени
4. **Мониторинг** - система автоматически проверяет работоспособность компонентов и перезапускает их при необходимости

## Мониторинг и логирование

Система ведет подробные логи работы всех компонентов:

- **API-логи** - логи работы API-сервера
- **Bot-логи** - логи работы Telegram-бота
- **System-логи** - логи работы системы в целом

Логи сохраняются в директории `logs` с временными метками и доступны для анализа.

## Устранение неполадок

### Проблемы с запуском API-сервера

1. Проверьте, что порт 3000 не занят другим приложением
2. Проверьте переменные окружения в файле `.env`
3. Проверьте подключение к базе данных

### Проблемы с Telegram-ботом

1. Проверьте, что токен бота указан правильно в файле `.env`
2. Проверьте, что API-сервер запущен и доступен
3. Проверьте настройки вебхука

### Проблемы с синхронизацией

1. Проверьте, что API-сервер и Telegram-бот запущены
2. Проверьте настройки вебхука
3. Проверьте подключение к базе данных

## Дополнительная информация

Для получения более подробной информации о системе, обратитесь к следующим документам:

- `FSM_DOCUMENTATION.md` - Подробная документация по FSM-сценариям
- `API_DOCUMENTATION.md` - Документация по API
- `DEPLOYMENT_GUIDE.md` - Руководство по развертыванию системы в production

## Контакты

По вопросам поддержки обращайтесь:

- Email: support@vendhub.com
- Telegram: @vendhub_support
