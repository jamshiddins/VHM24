# VendHub - План миграции и дорожная карта

## Обзор проекта

### Текущая ситуация
- Существующая система vhm24-platform с базовым функционалом
- Необходимость в расширенном учете компонентов (бункеры, сиропы, вода)
- Требование детального финансового учета
- Потребность в мобильном интерфейсе для операторов

### Целевая архитектура
- Микросервисная архитектура с API Gateway
- PostgreSQL для основных данных
- Redis для кеширования и сессий
- Telegram Bot с FSM для операторов
- S3-совместимое хранилище для медиа

## Фазы миграции

### Фаза 1: Подготовка инфраструктуры (2 недели)

#### Неделя 1-2:
- [ ] Развертывание PostgreSQL кластера
- [ ] Настройка Redis
- [ ] Развертывание S3 хранилища (MinIO)
- [ ] Настройка мониторинга (Prometheus + Grafana)
- [ ] CI/CD pipeline (GitLab/GitHub Actions)

#### Результаты:
- Готовая инфраструктура для новой системы
- Автоматизированное развертывание
- Система мониторинга

### Фаза 2: Базовые сервисы (3 недели)

#### Неделя 3-4:
- [ ] Auth Service (аутентификация и авторизация)
- [ ] Users Service (управление пользователями)
- [ ] API Gateway настройка
- [ ] Базовая структура микросервисов

#### Неделя 5:
- [ ] Machines Service (управление автоматами)
- [ ] Миграция данных по автоматам
- [ ] Тестирование API

#### Результаты:
- Работающая система аутентификации
- Базовый учет автоматов
- API документация

### Фаза 3: Компоненты и инвентарь (4 недели)

#### Неделя 6-7:
- [ ] Bunkers Service
  - [ ] Модели данных
  - [ ] API endpoints
  - [ ] Бизнес-логика операций
- [ ] Начальная загрузка данных по бункерам

#### Неделя 8:
- [ ] Syrups Service
- [ ] Water Service
- [ ] Spare Parts Service

#### Неделя 9:
- [ ] Inventory Service
  - [ ] Управление партиями
  - [ ] Движение товаров
  - [ ] Остатки на складе
- [ ] Suppliers Service

#### Результаты:
- Полный учет компонентов
- Управление запасами
- История операций

### Фаза 4: Telegram Bot (3 недели)

#### Неделя 10-11:
- [ ] Базовая структура бота
- [ ] FSM implementation
- [ ] Аутентификация через телефон
- [ ] Главное меню по ролям

#### Неделя 12:
- [ ] Операции с бункерами
  - [ ] Заполнение
  - [ ] Установка/снятие
  - [ ] Взвешивание
- [ ] Фотофиксация
- [ ] Интеграция с S3

#### Результаты:
- Рабочий Telegram бот
- Основные операции для операторов
- Фотоотчеты

### Фаза 5: Финансы и рецепты (3 недели)

#### Неделя 13-14:
- [ ] Finance Service
  - [ ] Учет доходов
  - [ ] Учет расходов
  - [ ] Отчетность
- [ ] Интеграция с платежными системами

#### Неделя 15:
- [ ] Recipes Service
  - [ ] Управление рецептами
  - [ ] Версионирование
  - [ ] Расчет себестоимости

#### Результаты:
- Полный финансовый учет
- Управление рецептами
- Автоматический расчет себестоимости

### Фаза 6: Расширенный функционал (3 недели)

#### Неделя 16-17:
- [ ] Reports Service
  - [ ] Оперативные отчеты
  - [ ] Финансовые отчеты
  - [ ] Аналитика
- [ ] Экспорт в PDF/Excel

#### Неделя 18:
- [ ] Уведомления
  - [ ] Push уведомления в Telegram
  - [ ] Email уведомления
  - [ ] Настройка правил
- [ ] Исторический ввод данных

#### Результаты:
- Полная система отчетности
- Автоматические уведомления
- Возможность работы с историческими данными

### Фаза 7: Оптимизация и стабилизация (2 недели)

#### Неделя 19-20:
- [ ] Оптимизация производительности
- [ ] Нагрузочное тестирование
- [ ] Исправление багов
- [ ] Обучение пользователей
- [ ] Документация

## Детальный план миграции данных

### 1. Пользователи
```sql
-- Маппинг ролей
ADMIN -> ADMIN
MANAGER -> MANAGER
WAREHOUSE -> WAREHOUSE
OPERATOR -> OPERATOR
TECHNICIAN -> OPERATOR (с ограничениями)
```

### 2. Автоматы
```javascript
// Скрипт миграции
async function migrateMachines() {
  const oldMachines = await oldDb.machine.findMany();
  
  for (const old of oldMachines) {
    await newDb.machine.create({
      data: {
        model: old.type || 'UNKNOWN',
        serialNumber: old.serialNumber,
        vendhubCode: old.code,
        status: mapStatus(old.status),
        locationAddress: old.location?.address,
        locationLat: old.location?.latitude,
        locationLng: old.location?.longitude,
        operatorId: old.assignedToId,
        metadata: old.metadata
      }
    });
  }
}
```

### 3. Инвентарь
- Создание справочника ингредиентов
- Генерация начальных бункеров
- Импорт текущих остатков

### 4. Исторические данные
- Конвертация транзакций
- Миграция истории обслуживания
- Сохранение аудит логов

## Риски и митигация

### Технические риски

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Потеря данных при миграции | Низкая | Высокое | Резервные копии, поэтапная миграция |
| Недоступность системы | Средняя | Высокое | Параллельная работа старой и новой систем |
| Проблемы интеграции | Средняя | Среднее | Тщательное тестирование API |
| Производительность | Низкая | Среднее | Оптимизация запросов, кеширование |

### Организационные риски

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Сопротивление пользователей | Высокая | Среднее | Обучение, постепенное внедрение |
| Недостаток ресурсов | Средняя | Высокое | Приоритизация функций |
| Изменение требований | Высокая | Среднее | Agile подход, итеративная разработка |

## Команда проекта

### Роли и ответственность

#### Технический лидер
- Архитектура системы
- Code review
- Техническая документация

#### Backend разработчики (2-3)
- Разработка микросервисов
- Интеграция с БД
- API implementation

#### Frontend разработчик
- Admin dashboard (опционально)
- Мониторинг дашборды

#### DevOps инженер
- Инфраструктура
- CI/CD
- Мониторинг

#### QA инженер
- Тестирование API
- E2E тесты
- Нагрузочное тестирование

#### Бизнес-аналитик
- Сбор требований
- Тестирование бизнес-логики
- Обучение пользователей

## Бюджет времени

| Фаза | Длительность | Человеко-недель |
|------|--------------|-----------------|
| Подготовка | 2 недели | 4 |
| Базовые сервисы | 3 недели | 12 |
| Компоненты | 4 недели | 20 |
| Telegram Bot | 3 недели | 12 |
| Финансы | 3 недели | 12 |
| Расширенный функционал | 3 недели | 9 |
| Стабилизация | 2 недели | 8 |
| **ИТОГО** | **20 недель** | **77** |

## Критерии успеха

### Технические метрики
- [ ] Время ответа API < 200ms (p95)
- [ ] Uptime > 99.9%
- [ ] Покрытие тестами > 80%
- [ ] Нулевая потеря данных при миграции

### Бизнес метрики
- [ ] 100% операторов используют Telegram бот
- [ ] Снижение времени на операцию на 50%
- [ ] Точность учета остатков > 99%
- [ ] Автоматизация отчетности на 90%

### Пользовательские метрики
- [ ] NPS > 80
- [ ] Время обучения < 2 часов
- [ ] Количество ошибок операторов < 1%

## Поддержка после запуска

### SLA
- Критические баги: 4 часа
- Важные баги: 24 часа
- Минорные баги: 1 неделя
- Feature requests: по договоренности

### Мониторинг
- Uptime monitoring (UptimeRobot)
- APM (Application Performance Monitoring)
- Error tracking (Sentry)
- Business metrics dashboards

### Обновления
- Security patches: немедленно
- Bug fixes: еженедельно
- Features: ежемесячно
- Major updates: квартально

## Альтернативные сценарии

### План B: Упрощенная миграция
Если полная миграция невозможна:
1. Начать только с Telegram бота
2. Интегрировать с существующей БД
3. Постепенно переносить функционал

### План C: MVP подход
Минимально жизнеспособный продукт:
1. Только учет бункеров
2. Базовый Telegram интерфейс
3. Простая отчетность
4. Расширение по мере необходимости

## Чек-лист готовности к запуску

### За 2 недели до запуска
- [ ] Все критические функции протестированы
- [ ] Данные мигрированы на тестовый сервер
- [ ] Проведено обучение ключевых пользователей
- [ ] Подготовлена документация

### За 1 неделю до запуска
- [ ] Финальное тестирование
- [ ] Резервные копии
- [ ] План отката
- [ ] Коммуникация с пользователями

### День запуска
- [ ] Финальная проверка инфраструктуры
- [ ] Миграция продакшн данных
- [ ] Мониторинг первых операций
- [ ] Горячая линия поддержки

### После запуска (1 неделя)
- [ ] Ежедневные standup по проблемам
- [ ] Сбор обратной связи
- [ ] Быстрые исправления
- [ ] Отчет о запуске
