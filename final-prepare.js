const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

console.log('üöÄ –ó–∞–ø—É—Å–∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ VHM24 –∫ –¥–µ–ø–ª–æ—é\n');

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã –∏ –≤—ã–≤–æ–¥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
function runCommand(command, options = {}) {
  console.log(`–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã: ${command}`);
  try {
    const output = execSync(command, { encoding: 'utf8', ...options });
    console.log(output);
    return output;
  } catch (error) {
    console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã: ${command}`);
    console.error(error.message);
    if (error.stdout) console.log(error.stdout.toString());
    if (error.stderr) console.error(error.stderr.toString());
    return null;
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞
function checkFileExists(filePath) {
  return fs.existsSync(filePath);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
function ensureDirectoryExists(dirPath) {
  if (!fs.existsSync(dirPath)) {
    fs.mkdirSync(dirPath, { recursive: true });
    console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: ${dirPath}`);
    return true;
  }
  return false;
}

// –®–∞–≥ 1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
console.log('\nüìã –®–∞–≥ 1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏');
if (checkFileExists('scripts/secure-credentials.js')) {
  runCommand('node scripts/secure-credentials.js');
} else {
  console.error('‚ùå –§–∞–π–ª scripts/secure-credentials.js –Ω–µ –Ω–∞–π–¥–µ–Ω');
}

// –®–∞–≥ 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –ø—Ä–æ–±–ª–µ–º
console.log('\nüìã –®–∞–≥ 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –ø—Ä–æ–±–ª–µ–º');
if (checkFileExists('scripts/fix-remaining-issues.js')) {
  runCommand('node scripts/fix-remaining-issues.js');
} else {
  console.error('‚ùå –§–∞–π–ª scripts/fix-remaining-issues.js –Ω–µ –Ω–∞–π–¥–µ–Ω');
}

// –®–∞–≥ 3: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
console.log('\nüìã –®–∞–≥ 3: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º');
if (checkFileExists('scripts/emergency-fix.js')) {
  runCommand('node scripts/emergency-fix.js');
} else {
  console.error('‚ùå –§–∞–π–ª scripts/emergency-fix.js –Ω–µ –Ω–∞–π–¥–µ–Ω');
}

// –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ .env.example, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
console.log('\nüìã –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ .env.example');
if (!checkFileExists('.env.example') && checkFileExists('.env')) {
  console.log('–°–æ–∑–¥–∞–Ω–∏–µ .env.example –∏–∑ .env...');
  let envContent = fs.readFileSync('.env', 'utf8');
  
  // –ó–∞–º–µ–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –Ω–∞ –ø—Ä–∏–º–µ—Ä—ã
  envContent = envContent
    .replace(/JWT_SECRET=.+/g, 'JWT_SECRET=your_jwt_secret_here')
    .replace(/DATABASE_URL=.+/g, 'DATABASE_URL=postgresql://user:password@localhost:5432/dbname')
    .replace(/REDIS_URL=.+/g, 'REDIS_URL=redis://localhost:6379')
    .replace(/TELEGRAM_BOT_TOKEN=.+/g, 'TELEGRAM_BOT_TOKEN=your_telegram_bot_token_here')
    .replace(/PASSWORD_\d+=.+/g, 'PASSWORD_XXX=your_password_here')
    .replace(/API_KEY_\d+=.+/g, 'API_KEY_XXX=your_api_key_here')
    .replace(/SECRET_\d+=.+/g, 'SECRET_XXX=your_secret_here');
  
  fs.writeFileSync('.env.example', envContent);
  console.log('‚úÖ –°–æ–∑–¥–∞–Ω .env.example –∏–∑ .env —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º–∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏');
}

// –®–∞–≥ 5: –°–æ–∑–¥–∞–Ω–∏–µ .gitignore, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
console.log('\nüìã –®–∞–≥ 5: –°–æ–∑–¥–∞–Ω–∏–µ .gitignore');
if (!checkFileExists('.gitignore')) {
  console.log('–°–æ–∑–¥–∞–Ω–∏–µ .gitignore...');
  const gitignoreContent = `# Dependency directories
node_modules/
jspm_packages/

# Environment variables
.env
.env.*
!.env.example

# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# Runtime data
pids
*.pid
*.seed
*.pid.lock

# Directory for instrumented libs generated by jscoverage/JSCover
lib-cov

# Coverage directory used by tools like istanbul
coverage

# nyc test coverage
.nyc_output

# Grunt intermediate storage (https://gruntjs.com/creating-plugins#storing-task-files)
.grunt

# Bower dependency directory (https://bower.io/)
bower_components

# node-waf configuration
.lock-wscript

# Compiled binary addons (https://nodejs.org/api/addons.html)
build/Release

# TypeScript v1 declaration files
typings/

# Optional npm cache directory
.npm

# Optional eslint cache
.eslintcache

# Optional REPL history
.node_repl_history

# Output of 'npm pack'
*.tgz

# Yarn Integrity file
.yarn-integrity

# dotenv environment variables file
.env

# parcel-bundler cache (https://parceljs.org/)
.cache

# next.js build output
.next

# nuxt.js build / generate output
.nuxt
dist

# vuepress build output
.vuepress/dist

# Serverless directories
.serverless/

# FuseBox cache
.fusebox/

# DynamoDB Local files
.dynamodb/

# OS specific files
.DS_Store
Thumbs.db

# IDE specific files
.idea/
.vscode/
*.swp
*.swo
`;
  
  fs.writeFileSync('.gitignore', gitignoreContent);
  console.log('‚úÖ –°–æ–∑–¥–∞–Ω .gitignore');
}

// –®–∞–≥ 6: –°–æ–∑–¥–∞–Ω–∏–µ README.md, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
console.log('\nüìã –®–∞–≥ 6: –°–æ–∑–¥–∞–Ω–∏–µ README.md');
if (!checkFileExists('README.md')) {
  console.log('–°–æ–∑–¥–∞–Ω–∏–µ README.md...');
  const readmeContent = `# VHM24 - –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–µ–Ω–¥–∏–Ω–≥–æ–≤—ã–º–∏ –∞–≤—Ç–æ–º–∞—Ç–∞–º–∏

## –û–ø–∏—Å–∞–Ω–∏–µ

VHM24 - —ç—Ç–æ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–µ–Ω–¥–∏–Ω–≥–æ–≤—ã–º–∏ –∞–≤—Ç–æ–º–∞—Ç–∞–º–∏. –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–æ–≤, —É–ø—Ä–∞–≤–ª—è—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–º, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–∞–∫–∞–∑—ã –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ.

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Node.js 18+
- npm 9+
- Docker –∏ Docker Compose (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- PostgreSQL
- Redis

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:
   \`\`\`bash
   git clone https://github.com/jamshiddins/VHM24.git
   cd VHM24
   \`\`\`

2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
   \`\`\`bash
   npm install
   \`\`\`

3. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª .env –∏–∑ .env.example:
   \`\`\`bash
   cp .env.example .env
   \`\`\`

4. –ó–∞–ø–æ–ª–Ω–∏—Ç—å .env —Ñ–∞–π–ª –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏.

## –ó–∞–ø—É—Å–∫

### –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

\`\`\`bash
node start-optimized.js
\`\`\`

### –ó–∞–ø—É—Å–∫ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

\`\`\`bash
cd services/auth
npm start
\`\`\`

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

- \`services/\` - –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã
  - \`auth/\` - –°–µ—Ä–≤–∏—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
  - \`inventory/\` - –°–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–º
  - \`machines/\` - –°–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∞–º–∏
  - \`warehouse/\` - –°–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫–ª–∞–¥–æ–º
  - \`tasks/\` - –°–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞–º–∏
  - \`data-import/\` - –°–µ—Ä–≤–∏—Å –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
  - \`gateway/\` - API Gateway
  - \`telegram-bot/\` - Telegram –±–æ—Ç
- \`packages/\` - –û–±—â–∏–µ –ø–∞–∫–µ—Ç—ã
  - \`database/\` - –î–æ—Å—Ç—É–ø –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
  - \`shared/\` - –û–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã
  - \`shared-types/\` - –û–±—â–∏–µ —Ç–∏–ø—ã
- \`scripts/\` - –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–º
- \`docs/\` - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## –î–µ–ø–ª–æ–π

### –î–µ–ø–ª–æ–π –Ω–∞ Railway

\`\`\`bash
node scripts/deploy-to-railway.js
\`\`\`

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

\`\`\`bash
npm test
\`\`\`

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É \`/docs\` –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤.

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT
`;
  
  fs.writeFileSync('README.md', readmeContent);
  console.log('‚úÖ –°–æ–∑–¥–∞–Ω README.md');
}

// –®–∞–≥ 7: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
console.log('\nüìã –®–∞–≥ 7: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤');
if (checkFileExists('jest.config.js')) {
  runCommand('npm test');
} else {
  console.log('‚ö†Ô∏è –§–∞–π–ª jest.config.js –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤');
}

// –®–∞–≥ 8: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
console.log('\nüìã –®–∞–≥ 8: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π');
runCommand('npm audit fix');

// –®–∞–≥ 9: –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
console.log('\nüìã –®–∞–≥ 9: –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏');
if (checkFileExists('start-optimized.js')) {
  console.log('–î–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:');
  console.log('node start-optimized.js');
} else {
  console.error('‚ùå –§–∞–π–ª start-optimized.js –Ω–µ –Ω–∞–π–¥–µ–Ω');
}

// –®–∞–≥ 10: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –¥–µ–ø–ª–æ—é –Ω–∞ Railway
console.log('\nüìã –®–∞–≥ 10: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –¥–µ–ø–ª–æ—é –Ω–∞ Railway');
if (checkFileExists('scripts/deploy-to-railway.js')) {
  console.log('–î–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ Railway –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:');
  console.log('node scripts/deploy-to-railway.js');
} else {
  console.error('‚ùå –§–∞–π–ª scripts/deploy-to-railway.js –Ω–µ –Ω–∞–π–¥–µ–Ω');
}

console.log('\n‚úÖ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ VHM24 –∫ –¥–µ–ø–ª–æ—é –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
console.log('\nüìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–∞–ª—å–Ω–µ–π—à–µ–º—É —É–ª—É—á—à–µ–Ω–∏—é –ø—Ä–æ–µ–∫—Ç–∞:');
console.log('1. –î–æ–±–∞–≤–∏—Ç—å ESLint –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞');
console.log('2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CI/CD pipeline –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –¥–µ–ø–ª–æ—è');
console.log('3. –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Prometheus –∏ Grafana');
console.log('4. –£–ª—É—á—à–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é API —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º OpenAPI/Swagger');
console.log('5. –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö');
console.log('\n–ü–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ —Ñ–∞–π–ª–µ RECOMMENDATIONS.md');
