# VHM24 VendHub - Полный План Реализации

## Анализ Документации

На основе предоставленной документации VendHub - это комплексная система управления вендинговыми автоматами с следующими ключевыми компонентами:

### 1. РОЛИ И ПРАВА
- **admin**: Полный доступ, управление пользователями, ролями, справочниками, логами
- **manager**: Создание задач, управление справочниками, отчётами, доходами/расходами
- **warehouse**: Приёмка, выдача, заполнение, взвешивание бункеров, расходников, воды
- **operator**: Выполнение задач по замене бункеров, воды, сиропов, фотофиксации
- **technician**: Выполнение задач по ремонту и обслуживанию
- **driver**: Выполнение маршрутов, отчёт по логистике, топливу, пробегу

### 2. ОСНОВНЫЕ СУЩНОСТИ

#### Справочники:
- **Автоматы**: ID, модель, серийный номер, локация, SIM-карта, счётчик
- **Ингредиенты**: название, тип, срок годности, единицы, остаток, цена
- **Бункеры**: ID (SET-XXX-Y), назначение, вес тары, статус, циклы
- **Сумки**: номер, состав (бункеры, сиропы, стаканы), статус
- **Вода**: уникальный номер бутылки, вес, статус, история
- **Сиропы**: название, объём, количество бутылок, статус
- **Расходники**: стаканы, крышки, тряпки, остаток, расход
- **Запчасти**: название, назначение, срок службы, количество
- **Рецепты**: название продукта, ингредиенты в граммах, себестоимость

#### Операционные сущности:
- **Задачи**: FSM-цепочки с чек-листами
- **Маршруты**: последовательность автоматов для операторов
- **Инкассация**: сбор и сверка наличных
- **Отчёты**: продажи, остатки, сверка, финансы

### 3. FSM-СЦЕНАРИИ (Finite State Machine)

#### Замена ингредиентов (Operator):
1. Выбор автомата → Проверка сумки → Снятие старого бункера (с фото) → Установка нового → Взвешивание → Фото после → Завершение

#### Пополнение воды (Operator):
1. Получение бутылок → Установка → Фотофиксация → Возврат старых → Взвешивание → Завершение

#### Приёмка на склад (Warehouse):
1. Отметка поставки → Ввод номера → Количество, вес, срок годности → Привязка к складу

#### Инкассация (Operator → Manager):
1. Указание суммы → Фото купюр → Передача → Сверка → Отчёт

### 4. СИСТЕМА СВЕРКИ

Автоматическая сверка между:
- Логами автоматов
- QR-платежами (Payme, Uzum, Click)
- Отчётами Multikassa
- Фактическими остатками
- Рецептами и нормативным расходом

### 5. ФИНАНСОВЫЙ МОДУЛЬ

- **Доходы**: продажи по всем видам оплат
- **Расходы**: закупки, аренда, ремонт, расходники
- **Инкассация**: наличные с автоматов
- **Сверка**: автоматическое сопоставление всех источников

## ПЛАН РЕАЛИЗАЦИИ

### ФАЗА 1: Базовая инфраструктура
1. ✅ Настройка базы данных (PostgreSQL)
2. ✅ Настройка Redis для FSM
3. ✅ Базовая авторизация и роли
4. 🔄 Создание всех моделей данных

### ФАЗА 2: Справочники и CRUD
1. 🔄 Реализация всех справочников
2. 🔄 Web-интерфейс для управления
3. 🔄 API для всех операций CRUD
4. 🔄 Система прав доступа (RBAC)

### ФАЗА 3: FSM и Telegram-бот
1. 🔄 FSM-машина состояний
2. 🔄 Telegram-интерфейс по ролям
3. 🔄 Чек-листы и задачи
4. 🔄 Фотофиксация и геолокация

### ФАЗА 4: Система сверки и отчёты
1. 🔄 Модуль сверки продаж/платежей
2. 🔄 Финансовые отчёты
3. 🔄 Аналитика и дашборды
4. 🔄 Экспорт в Excel/PDF

### ФАЗА 5: Интеграции
1. 🔄 Интеграция с платёжными системами
2. 🔄 Интеграция с вендинг-системами
3. 🔄 S3 для файлов
4. 🔄 Уведомления и мониторинг

## ТЕКУЩИЙ СТАТУС

### Готово:
- ✅ Railway deployment
- ✅ PostgreSQL база данных
- ✅ Redis для сессий
- ✅ Базовая структура проекта
- ✅ Telegram-бот (базовый)
- ✅ Базовые роуты API

### В работе:
- 🔄 Полная схема базы данных
- 🔄 Все справочники
- 🔄 FSM для Telegram-бота
- 🔄 Web-интерфейс

### Следующие шаги:
1. Создать полную схему базы данных
2. Реализовать все справочники
3. Создать FSM-логику для Telegram
4. Добавить систему задач и чек-листов
5. Реализовать систему сверки

## АРХИТЕКТУРА

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Telegram Bot  │    │   Web Frontend  │    │   Mobile App    │
│   (FSM Logic)   │    │   (Admin Panel) │    │   (Operators)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   Backend API   │
                    │   (FastAPI)     │
                    └─────────────────┘
                                 │
                    ┌─────────────────┐
                    │   PostgreSQL    │
                    │   (Main DB)     │
                    └─────────────────┘
                                 │
                    ┌─────────────────┐
                    │     Redis       │
                    │   (FSM State)   │
                    └─────────────────┘
```

## КЛЮЧЕВЫЕ ОСОБЕННОСТИ

1. **FSM-управление**: Все действия через конечные автоматы состояний
2. **Фотофиксация**: Обязательные фото для всех операций
3. **Геолокация**: Контроль местоположения операторов
4. **Автоматическая сверка**: Сопоставление всех источников данных
5. **Ролевая модель**: Строгое разграничение доступа
6. **Мобильность**: Оптимизация под мобильные устройства
7. **Аудит**: Полное логирование всех действий

Система готова к полной реализации согласно документации.
