# VendHub Этап 5: Telegram FSM-бот - В ПРОЦЕССЕ

## 🎯 Цели этапа

### Создание интеллектуального Telegram бота для управления операциями VendHub:
- ✅ **FSM архитектура** с пошаговыми сценариями
- ✅ **Role-based интерфейсы** для разных типов пользователей
- ✅ **Интеграция с API** системы задач и чек-листов
- ✅ **Обработка мультимедиа** (фото, геолокация, QR коды)
- ✅ **Real-time уведомления** и алерты
- ✅ **Автоматизированные workflow** для повышения эффективности

## 📋 План выполнения

### Фаза 1: Базовая архитектура (1 неделя)
- [🔄] Настройка Node.js бота с telegraf.js
- [🔄] FSM система с состояниями пользователей
- [🔄] Базовая авторизация и роутинг по ролям
- [🔄] Интеграция с backend API

### Фаза 2: Операторские сценарии (1 неделя)
- [ ] Получение и выполнение задач
- [ ] Пошаговые чек-листы с фотофиксацией
- [ ] Возврат сумок и инкассация
- [ ] Отчеты по выполненным задачам

### Фаза 3: Складские сценарии (1 неделя)
- [ ] Создание и сборка сумок
- [ ] Прием возвратов и инвентаризация
- [ ] Управление остатками ингредиентов
- [ ] Мойка и подготовка бункеров

### Фаза 4: Управленческие функции (1 неделя)
- [ ] Создание задач и назначение исполнителей
- [ ] Мониторинг выполнения и контроль качества
- [ ] Аналитические отчеты и дашборды
- [ ] Управление справочниками

## 🤖 Архитектура бота

### FSM состояния
```javascript
const BOT_STATES = {
  // Базовые состояния
  IDLE: 'idle',
  MAIN_MENU: 'main_menu',
  PROFILE: 'profile',
  
  // Операторские состояния
  OPERATOR_TASKS: 'operator_tasks',
  TASK_EXECUTION: 'task_execution',
  CHECKLIST_STEP: 'checklist_step',
  PHOTO_UPLOAD: 'photo_upload',
  WEIGHT_INPUT: 'weight_input',
  GPS_LOCATION: 'gps_location',
  QR_SCAN: 'qr_scan',
  INCASSATION: 'incassation',
  BAG_RETURN: 'bag_return',
  
  // Складские состояния
  WAREHOUSE_MENU: 'warehouse_menu',
  BAG_CREATION: 'bag_creation',
  BUNKER_SELECTION: 'bunker_selection',
  INVENTORY_CHECK: 'inventory_check',
  RECEIVE_RETURN: 'receive_return',
  
  // Управленческие состояния
  MANAGER_MENU: 'manager_menu',
  CREATE_TASK: 'create_task',
  TASK_ASSIGNMENT: 'task_assignment',
  REPORTS_MENU: 'reports_menu',
  DIRECTORIES: 'directories'
};
```

### Role-based меню
```javascript
const ROLE_KEYBOARDS = {
  OPERATOR: [
    [{ text: '📋 Мои задачи', callback_data: 'my_tasks' }],
    [{ text: '🎒 Возврат сумок', callback_data: 'return_bags' }],
    [{ text: '💰 Инкассация', callback_data: 'incassation' }],
    [{ text: '📊 Мой отчет', callback_data: 'my_report' }]
  ],
  WAREHOUSE: [
    [{ text: '📦 Приём/выдача', callback_data: 'receive_issue' }],
    [{ text: '🎒 Сборка сумок', callback_data: 'create_bags' }],
    [{ text: '📋 Остатки', callback_data: 'inventory' }],
    [{ text: '🧹 Мойка бункеров', callback_data: 'wash_bunkers' }]
  ],
  MANAGER: [
    [{ text: '📝 Создать задачу', callback_data: 'create_task' }],
    [{ text: '👥 Управление задачами', callback_data: 'manage_tasks' }],
    [{ text: '📊 Отчёты', callback_data: 'reports' }],
    [{ text: '📚 Справочники', callback_data: 'directories' }]
  ],
  TECHNICIAN: [
    [{ text: '🔧 Технические задачи', callback_data: 'tech_tasks' }],
    [{ text: '⚙️ Диагностика', callback_data: 'diagnostics' }],
    [{ text: '📸 Фото отчеты', callback_data: 'photo_reports' }],
    [{ text: '📋 История ремонтов', callback_data: 'repair_history' }]
  ]
};
```

## 🔧 Технический стек

### Основные технологии
- **Node.js** + **Telegraf.js** - основной фреймворк бота
- **FSM (Finite State Machine)** - управление состояниями диалогов
- **Redis** - хранение сессий и временных данных
- **Prisma ORM** - интеграция с базой данных
- **Axios** - HTTP клиент для API вызовов

### Структура проекта
```
telegram-bot/
├── src/
│   ├── bot.js              # Основной файл бота
│   ├── middleware/         # Middleware функции
│   │   ├── auth.js         # Авторизация пользователей
│   │   ├── session.js      # Управление сессиями
│   │   └── logging.js      # Логирование действий
│   ├── handlers/           # Обработчики команд
│   │   ├── operator/       # Операторские команды
│   │   ├── warehouse/      # Складские команды
│   │   ├── manager/        # Управленческие команды
│   │   └── common/         # Общие команды
│   ├── fsm/               # FSM сценарии
│   │   ├── states.js      # Определение состояний
│   │   ├── transitions.js # Переходы между состояниями
│   │   └── scenarios/     # Конкретные сценарии
│   ├── keyboards/         # Клавиатуры и inline кнопки
│   ├── services/          # API сервисы
│   │   ├── api.js         # HTTP клиент
│   │   ├── tasks.js       # Работа с задачами
│   │   ├── users.js       # Работа с пользователями
│   │   └── media.js       # Обработка медиафайлов
│   ├── utils/             # Утилиты
│   │   ├── formatters.js  # Форматирование сообщений
│   │   ├── validators.js  # Валидация данных
│   │   └── helpers.js     # Вспомогательные функции
│   └── config/
│       ├── bot.js         # Конфигурация бота
│       └── redis.js       # Конфигурация Redis
├── package.json
└── .env
```

## 🎨 Пользовательские интерфейсы

### Операторский интерфейс
```
🤖 VendHub Бот - Добро пожаловать, Анвар!

📋 Ваши задачи на сегодня (3):
├─ 🔧 Техобслуживание - Автомат Ц-1
│  ⏱️ Осталось: 45 мин | 📍 Центр города
├─ 💧 Замена воды - Автомат П-7  
│  ⏱️ Осталось: 20 мин | 📍 Парк им. Навои
└─ 🧹 Уборка - Автомат У-3
   ⏱️ Осталось: 30 мин | 📍 Университет

🎒 Сумка #156 (готова к выдаче)
├─ Бункер: Кофе Espresso (2 кг)
├─ Бункер: Сахар белый (3 кг)  
└─ Сироп: Ваниль x2, Карамель x1

💰 Последняя инкассация: вчера 18:30
Сумма: 2,450,000 сум
```

### Складской интерфейс
```
📦 Склад VendHub - Добро пожаловать, Фарход!

🎒 Активные сумки (12):
├─ #156 - Анвар (готова к выдаче)
├─ #157 - На сборке (60% готовности)
└─ #158 - Возврат от Дилшода

📋 Критические остатки:
├─ ⚠️ Кофе Arabica: 12 кг (мин: 50 кг)
├─ ⚠️ Сахар белый: 8 кг (мин: 30 кг)
└─ ⚠️ Стаканы 180мл: 240 шт (мин: 500 шт)

🧹 Мойка бункеров:
├─ ✅ Очередь: 8 чистых
├─ 🔄 В процессе: 3 моются
└─ ❌ Грязных: 2 ожидают
```

### Управленческий интерфейс
```
👔 VendHub Управление - Добро пожаловать, Руслан!

📊 Сводка за сегодня:
├─ 💰 Выручка: 45,680,000 сум (+12%)
├─ 📋 Задач выполнено: 23/27 (85%)
├─ ⚠️ Инциденты: 2 (низкий уровень)
└─ 👥 Активных операторов: 8/10

🎯 Требуют внимания:
├─ 🚨 Автомат Ц-5: нет связи 2 часа
├─ ⏰ Просрочена задача: ТО Автомата П-12
└─ 📦 Критический остаток: кофе на складе

📈 Тренды:
├─ Продажи ↗️ +15% к прошлой неделе
├─ Время выполнения задач ↘️ -8%
└─ Удовлетворенность клиентов ↗️ 94%
```

## 🔄 FSM Сценарии

### Сценарий выполнения задачи оператором
```
1. [OPERATOR_TASKS] Выбор задачи из списка
   ↓
2. [TASK_EXECUTION] Обзор задачи и начало выполнения
   ↓
3. [CHECKLIST_STEP] Пошаговое выполнение чек-листа
   ↓ (для каждого шага)
4a. [PHOTO_UPLOAD] Загрузка фото (если требуется)
4b. [WEIGHT_INPUT] Ввод веса (если требуется)
4c. [GPS_LOCATION] Геолокация (если требуется)
4d. [QR_SCAN] Сканирование QR (если требуется)
   ↓
5. [TASK_COMPLETION] Завершение задачи и отчет
   ↓
6. [MAIN_MENU] Возврат в главное меню
```

### Сценарий создания сумки на складе
```
1. [WAREHOUSE_MENU] Выбор "Сборка сумок"
   ↓
2. [BAG_CREATION] Выбор задачи для сборки
   ↓
3. [BUNKER_SELECTION] Выбор бункеров из списка
   ↓ (для каждого бункера)
4. [WEIGHT_INPUT] Взвешивание ингредиентов
   ↓
5. [PHOTO_UPLOAD] Фото готовой сумки
   ↓
6. [BAG_COMPLETION] Завершение сборки и маркировка
   ↓
7. [WAREHOUSE_MENU] Возврат в меню склада
```

## 📱 Команды и возможности

### Базовые команды
- `/start` - Запуск бота и авторизация
- `/help` - Справка по командам
- `/profile` - Профиль пользователя
- `/settings` - Настройки уведомлений
- `/status` - Текущий статус и задачи

### Операторские команды  
- `/tasks` - Мои активные задачи
- `/report` - Отчет за смену
- `/return` - Возврат сумок
- `/collect` - Инкассация наличных

### Складские команды
- `/bags` - Управление сумками
- `/inventory` - Проверка остатков
- `/receive` - Прием возвратов
- `/wash` - Мойка бункеров

### Управленческие команды
- `/create` - Создать новую задачу  
- `/assign` - Назначить задачу
- `/analytics` - Аналитические отчеты
- `/alerts` - Настройка уведомлений

## 🔔 Система уведомлений

### Типы уведомлений
```javascript
const NOTIFICATION_TYPES = {
  // Критические уведомления
  MACHINE_OFFLINE: {
    roles: ['MANAGER', 'TECHNICIAN'],
    priority: 'HIGH',
    template: '🚨 Автомат {machineId} не отвечает уже {duration}'
  },
  
  TASK_OVERDUE: {
    roles: ['MANAGER'],
    priority: 'HIGH', 
    template: '⏰ Просрочена задача: {taskTitle} у {operatorName}'
  },
  
  LOW_STOCK: {
    roles: ['WAREHOUSE', 'MANAGER'],
    priority: 'MEDIUM',
    template: '⚠️ Низкий остаток: {itemName} ({quantity} {unit})'
  },
  
  // Информационные уведомления
  TASK_COMPLETED: {
    roles: ['MANAGER'],
    priority: 'LOW',
    template: '✅ Задача завершена: {taskTitle} выполнил {operatorName}'
  },
  
  BAG_READY: {
    roles: ['OPERATOR'],
    priority: 'MEDIUM',
    template: '🎒 Сумка #{bagId} готова к выдаче для автомата {machineId}'
  }
};
```

### Настройки уведомлений
```javascript
const DEFAULT_NOTIFICATION_SETTINGS = {
  OPERATOR: {
    newTasks: true,
    taskReminders: true,
    bagReady: true,
    criticalAlerts: true,
    quietHours: { start: '22:00', end: '07:00' }
  },
  
  WAREHOUSE: {
    lowStock: true,
    newReturns: true,
    bagRequests: true,
    criticalAlerts: true,
    quietHours: { start: '20:00', end: '08:00' }
  },
  
  MANAGER: {
    allTasks: true,
    overdueTasks: true,
    machineAlerts: true,
    dailyReports: true,
    weeklyAnalytics: true,
    quietHours: { start: '23:00', end: '08:00' }
  }
};
```

## 📊 Интеграция с аналитикой

### Метрики бота
- **Активность пользователей** - количество команд в день
- **Время выполнения задач** - среднее время от назначения до завершения
- **Качество выполнения** - процент задач с фотофиксацией
- **Эффективность уведомлений** - процент прочитанных алертов

### Дашборд для менеджеров
```
📊 Аналитика VendHub Bot

👥 Пользователи (за сегодня):
├─ Активных: 23/28 (82%)
├─ Средняя сессия: 12 мин
└─ Команд выполнено: 1,247

⚡ Производительность:
├─ Среднее время задачи: 45 мин (-12%)
├─ Задач с фото: 97% (+3%)
└─ Автоматизация: 78% процессов

🎯 Топ-активности:
├─ 1. Выполнение задач (45%)
├─ 2. Проверка статуса (23%)
├─ 3. Возврат сумок (18%)
└─ 4. Создание задач (14%)
```

## 🚀 Начало работы

### Этап 5.1 - ✅ ЗАВЕРШЕН!

**Базовая архитектура Telegram бота создана:**

#### 🏗️ Структура проекта
- ✅ Настроен Node.js проект с зависимостями (telegraf, redis, axios, winston)
- ✅ Создана модульная архитектура с разделением по ролям
- ✅ Настроена система конфигурации через .env файлы

#### 🤖 FSM архитектура
- ✅ Определены 50+ состояний для всех сценариев использования
- ✅ Созданы правила переходов между состояниями по ролям
- ✅ Реализована система валидации переходов

#### 🎯 Role-based интерфейсы  
- ✅ **Операторы**: полная реализация (задачи, чек-листы, инкассация, возврат сумок)
- ✅ **Склад**: базовая структура (сборка сумок, инвентаризация, мойка бункеров)
- ✅ **Менеджеры**: базовая структура (создание задач, отчеты, управление)
- ✅ **Общие**: авторизация, профиль, настройки, помощь

#### 🔧 Middleware и сервисы
- ✅ Авторизация пользователей через Telegram ID
- ✅ Управление сессиями через Redis
- ✅ Система логирования с Winston
- ✅ API клиент для интеграции с backend
- ✅ Форматирование сообщений и валидация

#### 📱 Пользовательский интерфейс
- ✅ Динамические клавиатуры для разных ролей
- ✅ Контекстные кнопки в зависимости от состояния
- ✅ Поддержка мультимедиа (фото, геолокация, QR коды)
- ✅ Пагинация для больших списков

#### 🔗 Интеграция с API
- ✅ HTTP клиент с перехватчиками и обработкой ошибок
- ✅ Методы для работы с задачами, пользователями, автоматами
- ✅ Загрузка файлов и медиа контента
- ✅ Получение отчетов и статистики

#### 📖 Документация
- ✅ Подробный README с инструкциями по установке и использованию
- ✅ Примеры конфигурации и переменных окружения
- ✅ Описание архитектуры и принципов работы

### Этап 5.2 - В ОЧЕРЕДИ
**Расширенная функциональность (планируется на следующую итерацию):**
- 📋 Полная реализация складских сценариев
- 📊 Детализация управленческих отчетов  
- 🔧 Технические сценарии для техников
- 📸 Продвинутая обработка медиафайлов
- 🔔 Система push-уведомлений
- 📈 Аналитика и метрики использования
