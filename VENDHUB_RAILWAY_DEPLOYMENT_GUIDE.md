# Руководство по развертыванию VendHub в Railway

Это руководство содержит пошаговые инструкции по развертыванию системы VendHub в онлайн-сервисе Railway.

## Содержание

1. [Подготовка](#1-подготовка)
2. [Создание проекта в Railway](#2-создание-проекта-в-railway)
3. [Настройка базы данных PostgreSQL](#3-настройка-базы-данных-postgresql)
4. [Настройка переменных окружения](#4-настройка-переменных-окружения)
5. [Развертывание приложения](#5-развертывание-приложения)
6. [Настройка вебхука Telegram](#6-настройка-вебхука-telegram)
7. [Проверка работоспособности](#7-проверка-работоспособности)
8. [Устранение возможных проблем](#8-устранение-возможных-проблем)

## 1. Подготовка

### Необходимые инструменты

- Аккаунт на [Railway](https://railway.app/)
- Git-репозиторий с проектом VendHub
- Токен бота Telegram (получить у [@BotFather](https://t.me/BotFather))

### Подготовка репозитория

Убедитесь, что ваш репозиторий содержит следующие файлы:

- `railway.toml` - конфигурация для Railway
- `nixpacks.toml` - конфигурация для сборки приложения
- `backend/prisma/schema.prisma` - схема базы данных
- `backend/src/index.js` - основной файл API-сервера
- `apps/telegram-bot/src/index.js` - основной файл Telegram-бота

## 2. Создание проекта в Railway

1. Войдите в свой аккаунт на [Railway](https://railway.app/)
2. Нажмите кнопку "New Project"
3. Выберите "Deploy from GitHub repo"
4. Выберите репозиторий с проектом VendHub
5. Нажмите "Deploy Now"

## 3. Настройка базы данных PostgreSQL

1. В проекте Railway нажмите "New"
2. Выберите "Database" -> "PostgreSQL"
3. Дождитесь создания базы данных
4. После создания базы данных, нажмите на неё в списке сервисов
5. Перейдите на вкладку "Connect" и скопируйте "Prisma Connection URL"

## 4. Настройка переменных окружения

1. В проекте Railway выберите ваш сервис (не базу данных)
2. Перейдите на вкладку "Variables"
3. Добавьте следующие переменные окружения:

```
DATABASE_URL=<URL базы данных PostgreSQL, скопированный на шаге 3.5>
PORT=3000
NODE_ENV=production
TELEGRAM_BOT_TOKEN=<токен вашего Telegram-бота>
API_BASE_URL=<URL вашего API, например https://your-app-name.up.railway.app>
WEBHOOK_URL=<URL вебхука Telegram, например https://your-app-name.up.railway.app/api/telegram/webhook>
```

4. Нажмите "Save Changes"

## 5. Развертывание приложения

1. После настройки переменных окружения Railway автоматически начнет процесс развертывания
2. Дождитесь завершения развертывания (статус "Success")
3. Перейдите на вкладку "Settings" и найдите "Domains"
4. Скопируйте URL вашего приложения (например, https://your-app-name.up.railway.app)

## 6. Настройка вебхука Telegram

1. Откройте браузер и перейдите по следующему URL (замените переменные на свои значения):
```
https://api.telegram.org/bot<TELEGRAM_BOT_TOKEN>/setWebhook?url=<WEBHOOK_URL>
```

2. Вы должны увидеть ответ в формате JSON с полем "ok": true

Пример:
```json
{
  "ok": true,
  "result": true,
  "description": "Webhook was set"
}
```

## 7. Проверка работоспособности

1. Откройте Telegram и найдите своего бота
2. Отправьте боту команду `/start`
3. Бот должен ответить приветственным сообщением и показать главное меню
4. Проверьте работу API, открыв в браузере:
```
https://your-app-name.up.railway.app/api/health
```

5. Вы должны увидеть ответ в формате JSON с информацией о состоянии API

## 8. Устранение возможных проблем

### Проблема: Ошибка при миграции базы данных

**Решение:**
1. Перейдите в Railway
2. Выберите ваш сервис
3. Перейдите на вкладку "Shell"
4. Выполните следующие команды:
```bash
cd backend
npx prisma migrate reset --force
npx prisma migrate deploy
```

### Проблема: Бот не отвечает на сообщения

**Решение:**
1. Проверьте, правильно ли настроен вебхук:
```
https://api.telegram.org/bot<TELEGRAM_BOT_TOKEN>/getWebhookInfo
```

2. Проверьте логи в Railway на наличие ошибок
3. Убедитесь, что переменные окружения настроены правильно

### Проблема: Ошибки в схеме Prisma

**Решение:**
1. Проверьте файл `backend/prisma/schema.prisma` на наличие дублирующихся значений в enum
2. Исправьте ошибки и закоммитьте изменения в репозиторий
3. Railway автоматически обновит приложение

### Проблема: Ошибка "Can't reach database server"

**Решение:**
1. Проверьте, что база данных PostgreSQL создана и работает
2. Проверьте переменную окружения DATABASE_URL
3. Перезапустите сервис в Railway

## Дополнительные ресурсы

- [Документация Railway](https://docs.railway.app/)
- [Документация Prisma](https://www.prisma.io/docs/)
- [Документация Telegram Bot API](https://core.telegram.org/bots/api)

## Контакты для поддержки

При возникновении проблем с развертыванием системы VendHub в Railway, обратитесь к администратору системы или создайте issue в репозитории проекта.
