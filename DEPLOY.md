# Руководство по деплою VHM24

## Структура проекта

Проект VHM24 состоит из трех основных компонентов:

1. **API сервер** - обрабатывает HTTP запросы, взаимодействует с базой данных и предоставляет REST API.
2. **Worker** - обрабатывает фоновые задачи, такие как отправка уведомлений, генерация отчетов и синхронизация данных.
3. **Scheduler** - планирует задачи для выполнения в определенное время.

## Файлы окружения

Для каждого компонента созданы отдельные файлы окружения:

- `.env.api` - переменные окружения для API сервера
- `.env.worker` - переменные окружения для Worker
- `.env.scheduler` - переменные окружения для Scheduler

Для локальной разработки используются файлы:

- `.env.api.local` - локальные переменные окружения для API сервера
- `.env.worker.local` - локальные переменные окружения для Worker
- `.env.scheduler.local` - локальные переменные окружения для Scheduler

## Запуск проекта локально

Для запуска проекта локально используйте следующие команды:

```bash
# Запуск API сервера
npm run start:api:local

# Запуск Worker
npm run start:worker:local

# Запуск Scheduler
npm run start:scheduler:local

# Запуск всех компонентов одновременно
npm run start:all:local
```

Или используйте скрипт `start-all-local.bat` для Windows:

```bash
./start-all-local.bat
```

## Деплой в Railway

Для деплоя проекта в Railway используется файл `railway.json`, который содержит настройки для деплоя.

### Настройка переменных окружения в Railway

1. Создайте новый проект в Railway
2. Добавьте переменные окружения из файлов `.env.api`, `.env.worker` и `.env.scheduler`
3. Убедитесь, что переменные `DATABASE_URL` и `REDIS_URL` указывают на правильные сервисы в Railway

### Деплой проекта

```bash
# Деплой проекта в Railway
npm run deploy:railway

# Деплой с проверкой переменных окружения
npm run deploy:railway:safe
```

## Проверка работоспособности

После деплоя проверьте работоспособность сервисов:

```bash
# Проверка API сервера
curl $RAILWAY_PUBLIC_URL/health

# Проверка Worker и Scheduler
npm run check:worker-scheduler
```

## Устранение неполадок

Если возникают проблемы с деплоем, используйте следующие команды:

```bash
# Проверка переменных окружения
npm run check:env

# Проверка логов Railway
npm run check:railway-logs

# Исправление проблем с Worker и Scheduler
npm run fix:worker-scheduler

# Исправление проблем с переменными окружения
npm run fix:env-variables
```

## Важные замечания

1. Хост `postgres.railway.internal` доступен только внутри инфраструктуры Railway. Для локальной разработки используйте локальную базу данных PostgreSQL.

2. Хост `yamanote.proxy.rlwy.net` для Redis также доступен только внутри инфраструктуры Railway. Для локальной разработки используйте локальный Redis.

3. При деплое в Railway убедитесь, что в файле `railway.json` указана правильная команда запуска: `node api/index.js`.
