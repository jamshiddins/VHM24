{
  "create-telegram-user.js": "#!/usr/bin/env node\r\n\r\nconst { getAuthClient } = require('./packages/database');\r\nconst bcrypt = require('bcrypt');\r\n\r\nasync function createTelegramUser() {\r\n  const prisma = getAuthClient();\r\n  \r\n  try {\r\n    console.log('üîß Creating Telegram user for VHM24 Bot...');\r\n    \r\n    // –í–∞—à Telegram ID –∏–∑ .env\r\n    const telegramId = process.env.ADMIN_IDS || '42283329';\r\n    const email = 'admin@vhm24.ru';\r\n    const name = 'VHM24 Admin';\r\n    const password = 'admin123';\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å\r\n    const existingUser = await prisma.user.findFirst({\r\n      where: {\r\n        OR: [\r\n          { telegramId },\r\n          { email }\r\n        ]\r\n      }\r\n    });\r\n    \r\n    if (existingUser) {\r\n      if (!existingUser.telegramId) {\r\n        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–æ–±–∞–≤–ª—è–µ–º Telegram ID\r\n        await prisma.user.update({\r\n          where: { id: existingUser.id },\r\n          data: { telegramId }\r\n        });\r\n        console.log('‚úÖ Updated existing user with Telegram ID');\r\n      } else {\r\n        console.log('‚úÖ User with Telegram ID already exists');\r\n      }\r\n    } else {\r\n      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n      const passwordHash = await bcrypt.hash(password, 10);\r\n      \r\n      const user = await prisma.user.create({\r\n        data: {\r\n          email,\r\n          name,\r\n          passwordHash,\r\n          telegramId,\r\n          roles: ['ADMIN', 'MANAGER', 'OPERATOR'],\r\n          isActive: true\r\n        }\r\n      });\r\n      \r\n      console.log('‚úÖ Created new user with Telegram ID');\r\n      console.log(`üìß Email: ${email}`);\r\n      console.log(`üîë Password: ${password}`);\r\n      console.log(`üì± Telegram ID: ${telegramId}`);\r\n    }\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç\r\n    const user = await prisma.user.findFirst({\r\n      where: { telegramId },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        name: true,\r\n        telegramId: true,\r\n        roles: true,\r\n        isActive: true\r\n      }\r\n    });\r\n    \r\n    console.log('\\nüìä User details:');\r\n    console.log(JSON.stringify(user, null, 2));\r\n    \r\n    console.log('\\nüéâ Telegram user ready for VHM24 Bot!');\r\n    \r\n  } catch (error) {\r\n    console.error('‚ùå Error creating Telegram user:', error);\r\n  } finally {\r\n    await prisma.$disconnect();\r\n  }\r\n}\r\n\r\ncreateTelegramUser();\r\n",
  "packages/shared/middleware/security.js": "/**\r\n * VHM24 Security Middleware\r\n * –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ middleware –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤\r\n */\r\n\r\nconst { PrismaClient } = require('@prisma/client');\r\nconst rateLimit = require('@fastify/rate-limit');\r\nconst helmet = require('@fastify/helmet');\r\nconst cors = require('@fastify/cors');\r\nconst jwt = require('@fastify/jwt');\r\nconst { \r\n  sanitizeInput, \r\n  isAllowedOrigin, \r\n  getRateLimitKey,\r\n  maskSensitiveData \r\n} = require('../../shared-types/src/security');\r\n\r\nconst prisma = new PrismaClient();\r\n\r\n/**\r\n * –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫\r\n * –ó–∞–º–µ–Ω—è–µ—Ç –≤—Å–µ reply.send(err) –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ responses\r\n */\r\nconst securityErrorHandler = (error, request, reply) => {\r\n  const isDev = process.env.NODE_ENV === 'development';\r\n  \r\n  // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ª–Ω—É—é –æ—à–∏–±–∫—É –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏\r\n  if (isDev) {\r\n    console.error('Security Error:', {\r\n      error: error.message,\r\n      stack: error.stack,\r\n      url: request.url,\r\n      method: request.method,\r\n      headers: request.headers,\r\n      body: request.body\r\n    });\r\n  } else {\r\n    // –í production –ª–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é\r\n    console.error('Security Error:', {\r\n      error: error.name || 'Internal Server Error',\r\n      url: request.url,\r\n      method: request.method,\r\n      statusCode: error.statusCode || 500,\r\n      timestamp: new Date().toISOString()\r\n    });\r\n  }\r\n\r\n  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ—à–∏–±–∫–∏ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π response\r\n  let statusCode = error.statusCode || 500;\r\n  let errorName = error.name || 'Internal Server Error';\r\n  let message = 'An error occurred';\r\n\r\n  // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫\r\n  switch (error.name) {\r\n    case 'ValidationError':\r\n      statusCode = 400;\r\n      message = isDev ? error.message : 'Invalid input data';\r\n      break;\r\n    case 'UnauthorizedError':\r\n    case 'JsonWebTokenError':\r\n    case 'TokenExpiredError':\r\n      statusCode = 401;\r\n      errorName = 'Unauthorized';\r\n      message = 'Authentication required';\r\n      break;\r\n    case 'ForbiddenError':\r\n      statusCode = 403;\r\n      errorName = 'Forbidden';\r\n      message = 'Access denied';\r\n      break;\r\n    case 'NotFoundError':\r\n      statusCode = 404;\r\n      errorName = 'Not Found';\r\n      message = 'Resource not found';\r\n      break;\r\n    case 'ConflictError':\r\n      statusCode = 409;\r\n      errorName = 'Conflict';\r\n      message = 'Resource conflict';\r\n      break;\r\n    case 'TooManyRequestsError':\r\n      statusCode = 429;\r\n      errorName = 'Too Many Requests';\r\n      message = 'Rate limit exceeded';\r\n      break;\r\n    case 'PrismaClientKnownRequestError':\r\n      statusCode = 400;\r\n      errorName = 'Database Error';\r\n      message = isDev ? error.message : 'Database operation failed';\r\n      break;\r\n    default:\r\n      if (isDev) {\r\n        message = error.message;\r\n      }\r\n  }\r\n\r\n  // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π response –±–µ–∑ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏\r\n  reply.code(statusCode).send({\r\n    error: errorName,\r\n    message: message,\r\n    statusCode: statusCode,\r\n    timestamp: new Date().toISOString(),\r\n    path: request.url\r\n  });\r\n};\r\n\r\n/**\r\n * Middleware –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n */\r\nconst authenticate = async (request, reply) => {\r\n  try {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º JWT —Ç–æ–∫–µ–Ω\r\n    await request.jwtVerify();\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n    const user = await prisma.user.findUnique({\r\n      where: { \r\n        id: request.user.id,\r\n        isActive: true \r\n      },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        role: true,\r\n        isActive: true,\r\n        lastLoginAt: true,\r\n        createdAt: true\r\n      }\r\n    });\r\n\r\n    if (!user) {\r\n      throw new Error('User not found or inactive');\r\n    }\r\n\r\n    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏\r\n    await prisma.user.update({\r\n      where: { id: user.id },\r\n      data: { lastLoginAt: new Date() }\r\n    });\r\n\r\n    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ request\r\n    request.user = user;\r\n    \r\n  } catch (err) {\r\n    reply.code(401).send({\r\n      error: 'Unauthorized',\r\n      message: 'Authentication required',\r\n      statusCode: 401,\r\n      timestamp: new Date().toISOString()\r\n    });\r\n  }\r\n};\r\n\r\n/**\r\n * Middleware –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ —Ä–æ–ª—è–º\r\n */\r\nconst authorize = (allowedRoles = []) => {\r\n  return async (request, reply) => {\r\n    if (!request.user) {\r\n      return reply.code(401).send({\r\n        error: 'Unauthorized',\r\n        message: 'Authentication required',\r\n        statusCode: 401\r\n      });\r\n    }\r\n\r\n    if (allowedRoles.length > 0 && !allowedRoles.includes(request.user.role)) {\r\n      return reply.code(403).send({\r\n        error: 'Forbidden',\r\n        message: 'Insufficient permissions',\r\n        statusCode: 403\r\n      });\r\n    }\r\n  };\r\n};\r\n\r\n/**\r\n * Middleware —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö\r\n */\r\nconst sanitizeInputs = async (request, reply) => {\r\n  // –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è query –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤\r\n  if (request.query) {\r\n    for (const [key, value] of Object.entries(request.query)) {\r\n      if (typeof value === 'string') {\r\n        request.query[key] = sanitizeInput(value);\r\n      }\r\n    }\r\n  }\r\n\r\n  // –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è body –¥–∞–Ω–Ω—ã—Ö\r\n  if (request.body && typeof request.body === 'object') {\r\n    const visited = new WeakSet(); // –ó–∞—â–∏—Ç–∞ –æ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫\r\n    \r\n    const sanitizeObject = (obj, depth = 0) => {\r\n      // –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª–∏—à–∫–æ–º –≥–ª—É–±–æ–∫–æ–π –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏\r\n      if (depth > 10) {\r\n        return;\r\n      }\r\n      \r\n      // –ó–∞—â–∏—Ç–∞ –æ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫\r\n      if (visited.has(obj)) {\r\n        return;\r\n      }\r\n      visited.add(obj);\r\n      \r\n      for (const [key, value] of Object.entries(obj)) {\r\n        if (typeof value === 'string') {\r\n          obj[key] = sanitizeInput(value);\r\n        } else if (typeof value === 'object' && value !== null && !Array.isArray(value)) {\r\n          sanitizeObject(value, depth + 1);\r\n        } else if (Array.isArray(value)) {\r\n          // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –º–∞—Å—Å–∏–≤—ã –æ—Ç–¥–µ–ª—å–Ω–æ\r\n          value.forEach((item, index) => {\r\n            if (typeof item === 'string') {\r\n              value[index] = sanitizeInput(item);\r\n            } else if (typeof item === 'object' && item !== null) {\r\n              sanitizeObject(item, depth + 1);\r\n            }\r\n          });\r\n        }\r\n      }\r\n    };\r\n    \r\n    sanitizeObject(request.body);\r\n  }\r\n};\r\n\r\n/**\r\n * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏ origins\r\n */\r\nconst setupCORS = (fastify, options = {}) => {\r\n  const allowedOrigins = process.env.ALLOWED_ORIGINS \r\n    ? process.env.ALLOWED_ORIGINS.split(',')\r\n    : ['http://localhost:3000', 'http://localhost:3001'];\r\n\r\n  return fastify.register(cors, {\r\n    origin: (origin, callback) => {\r\n      // –†–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ origin (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–æ–±–∏–ª—å–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)\r\n      if (!origin) return callback(null, true);\r\n      \r\n      if (isAllowedOrigin(origin, allowedOrigins)) {\r\n        callback(null, true);\r\n      } else {\r\n        callback(new Error('Not allowed by CORS'), false);\r\n      }\r\n    },\r\n    credentials: true,\r\n    methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],\r\n    allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With'],\r\n    ...options\r\n  });\r\n};\r\n\r\n/**\r\n * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Helmet –¥–ª—è –∑–∞—â–∏—Ç—ã –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤\r\n */\r\nconst setupHelmet = (fastify, options = {}) => {\r\n  return fastify.register(helmet, {\r\n    contentSecurityPolicy: {\r\n      directives: {\r\n        defaultSrc: [\"'self'\"],\r\n        styleSrc: [\"'self'\", \"'unsafe-inline'\"],\r\n        scriptSrc: [\"'self'\"],\r\n        imgSrc: [\"'self'\", \"data:\", \"https:\"],\r\n        connectSrc: [\"'self'\"],\r\n        fontSrc: [\"'self'\"],\r\n        objectSrc: [\"'none'\"],\r\n        mediaSrc: [\"'self'\"],\r\n        frameSrc: [\"'none'\"],\r\n      },\r\n    },\r\n    crossOriginEmbedderPolicy: false,\r\n    ...options\r\n  });\r\n};\r\n\r\n/**\r\n * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Rate Limiting\r\n */\r\nconst setupRateLimit = (fastify, options = {}) => {\r\n  return fastify.register(rateLimit, {\r\n    max: options.max || 100, // –º–∞–∫—Å–∏–º—É–º –∑–∞–ø—Ä–æ—Å–æ–≤\r\n    timeWindow: options.timeWindow || '1 minute', // –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ\r\n    skipOnError: true, // –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö Redis\r\n    keyGenerator: (request) => {\r\n      // –ò—Å–ø–æ–ª—å–∑—É–µ–º IP + User ID –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\r\n      const ip = request.ip;\r\n      const userId = request.user?.id;\r\n      return userId ? `${ip}:${userId}` : ip;\r\n    },\r\n    errorResponseBuilder: (request, context) => {\r\n      return {\r\n        error: 'Too Many Requests',\r\n        message: `Rate limit exceeded. Try again in ${Math.round(context.ttl / 1000)} seconds.`,\r\n        statusCode: 429,\r\n        retryAfter: Math.round(context.ttl / 1000)\r\n      };\r\n    },\r\n    ...options\r\n  });\r\n};\r\n\r\n/**\r\n * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ JWT\r\n */\r\nconst setupJWT = (fastify, options = {}) => {\r\n  const jwtSecret = process.env.JWT_SECRET;\r\n  \r\n  if (!jwtSecret || jwtSecret.length < 32) {\r\n    throw new Error('JWT_SECRET must be at least 32 characters long');\r\n  }\r\n\r\n  return fastify.register(jwt, {\r\n    secret: jwtSecret,\r\n    sign: {\r\n      expiresIn: process.env.JWT_EXPIRES_IN || '7d'\r\n    },\r\n    verify: {\r\n      maxAge: process.env.JWT_EXPIRES_IN || '7d'\r\n    },\r\n    ...options\r\n  });\r\n};\r\n\r\n/**\r\n * Middleware –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π\r\n */\r\nconst securityLogger = async (request, reply) => {\r\n  const startTime = Date.now();\r\n  \r\n  // –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å (–±–µ–∑ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)\r\n  const logData = {\r\n    method: request.method,\r\n    url: request.url,\r\n    ip: request.ip,\r\n    userAgent: request.headers['user-agent'],\r\n    userId: request.user?.id,\r\n    timestamp: new Date().toISOString()\r\n  };\r\n\r\n  // –ú–∞—Å–∫–∏—Ä—É–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ query –∏ body\r\n  if (request.query) {\r\n    logData.query = { ...request.query };\r\n    if (logData.query.password) logData.query.password = '***';\r\n    if (logData.query.token) logData.query.token = '***';\r\n  }\r\n\r\n  console.log('Security Request:', logData);\r\n\r\n  // –í Fastify 5.x –∏—Å–ø–æ–ª—å–∑—É–µ–º reply.hijack() –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è response\r\n  const originalSend = reply.send;\r\n  reply.send = function(payload) {\r\n    const duration = Date.now() - startTime;\r\n    console.log('Security Response:', {\r\n      method: request.method,\r\n      url: request.url,\r\n      statusCode: reply.statusCode,\r\n      duration: `${duration}ms`,\r\n      userId: request.user?.id,\r\n      timestamp: new Date().toISOString()\r\n    });\r\n    return originalSend.call(this, payload);\r\n  };\r\n};\r\n\r\n/**\r\n * –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞\r\n */\r\nconst healthCheck = async (request, reply) => {\r\n  try {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö\r\n    await prisma.$queryRaw`SELECT 1`;\r\n    \r\n    reply.send({\r\n      status: 'healthy',\r\n      timestamp: new Date().toISOString(),\r\n      service: process.env.SERVICE_NAME || 'unknown',\r\n      version: process.env.SERVICE_VERSION || '1.0.0',\r\n      uptime: process.uptime()\r\n    });\r\n  } catch (error) {\r\n    reply.code(503).send({\r\n      status: 'unhealthy',\r\n      error: 'Database connection failed',\r\n      timestamp: new Date().toISOString()\r\n    });\r\n  }\r\n};\r\n\r\nmodule.exports = {\r\n  securityErrorHandler,\r\n  authenticate,\r\n  authorize,\r\n  sanitizeInputs,\r\n  setupCORS,\r\n  setupHelmet,\r\n  setupRateLimit,\r\n  setupJWT,\r\n  securityLogger,\r\n  healthCheck\r\n};\r\n",
  "scripts/auto-fixer.js": "const fs = require('fs');\r\nconst path = require('path');\r\nconst { execSync } = require('child_process');\r\n\r\nclass AutoFixer {\r\n  constructor(analysisReport) {\r\n    this.report = analysisReport;\r\n    this.fixed = [];\r\n    this.failed = [];\r\n    this.backups = new Map();\r\n  }\r\n\r\n  async fixAllIssues() {\r\n    console.log('üîß Starting Auto-Fix Process...\\n');\r\n    \r\n    // –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏\r\n    await this.createBackups();\r\n    \r\n    try {\r\n      // 1. –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\r\n      await this.fixSecurityIssues();\r\n      \r\n      // 2. –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏\r\n      await this.fixDependencyIssues();\r\n      \r\n      // 3. –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º—ã –∫–æ–¥–∞\r\n      await this.fixCodeIssues();\r\n      \r\n      // 4. –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã\r\n      await this.addMissingComponents();\r\n      \r\n      // 5. –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å\r\n      await this.fixPerformanceIssues();\r\n      \r\n      // 6. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç\r\n      this.generateFixReport();\r\n      \r\n    } catch (error) {\r\n      console.error('‚ùå Error during fix process:', error);\r\n      await this.rollbackAll();\r\n    }\r\n  }\r\n\r\n  async createBackups() {\r\n    console.log('üì¶ Creating backups...');\r\n    \r\n    const filesToBackup = new Set();\r\n    \r\n    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –∏–∑ –æ—Ç—á–µ—Ç–∞\r\n    Object.values(this.report.issues).flat().forEach(issue => {\r\n      if (issue.file) filesToBackup.add(issue.file);\r\n    });\r\n    \r\n    filesToBackup.forEach(file => {\r\n      const content = fs.readFileSync(file, 'utf8');\r\n      this.backups.set(file, content);\r\n    });\r\n    \r\n    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–µ–∫–∞–ø –Ω–∞ –¥–∏—Å–∫\r\n    fs.writeFileSync('backup.json', JSON.stringify(Object.fromEntries(this.backups), null, 2));\r\n    console.log(`‚úÖ Created backups for ${this.backups.size} files`);\r\n  }\r\n\r\n  async fixSecurityIssues() {\r\n    console.log('\\nüîí Fixing security issues...');\r\n    \r\n    const securityFixes = {\r\n      // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Ç–µ—á–∫–∏ –æ—à–∏–±–æ–∫\r\n      'reply.send(err)': {\r\n        pattern: /reply\\.(send|code\\(\\d+\\)\\.send)\\s*\\(\\s*err\\s*\\)/g,\r\n        replacement: `reply.code(err.statusCode || 500).send({\r\n          error: err.name || 'Internal Server Error',\r\n          message: process.env.NODE_ENV === 'development' ? err.message : 'An error occurred'\r\n        })`\r\n      },\r\n      \r\n      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏\r\n      'missing-validation': {\r\n        detect: (content) => content.includes('async (request, reply)') && \r\n                             content.includes('request.body') && \r\n                             !content.includes('schema:'),\r\n        fix: (content, filePath) => {\r\n          // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ routes –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ö–µ–º—ã\r\n          return this.addValidationSchemas(content, filePath);\r\n        }\r\n      },\r\n      \r\n      // –ó–∞–º–µ–Ω–∞ hardcoded credentials\r\n      'hardcoded-secrets': {\r\n        patterns: [\r\n          { match: /JWT_SECRET\\s*=\\s*[\"'][^\"']+[\"']/g, replace: 'JWT_SECRET = process.env.JWT_SECRET' },\r\n          { match: /password:\\s*[\"'][^\"']+[\"']/g, replace: 'password: process.env.DB_PASSWORD' }\r\n        ]\r\n      }\r\n    };\r\n    \r\n    this.report.issues.critical.forEach(issue => {\r\n      if (issue.file && issue.issue.includes('–£—Ç–µ—á–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏')) {\r\n        this.fixInFile(issue.file, securityFixes['reply.send(err)']);\r\n      }\r\n    });\r\n  }\r\n\r\n  async fixDependencyIssues() {\r\n    console.log('\\nüì¶ Fixing dependency issues...');\r\n    \r\n    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π\r\n    try {\r\n      console.log('Running npm audit fix...');\r\n      execSync('npm audit fix', { stdio: 'inherit' });\r\n      this.fixed.push('Fixed npm vulnerabilities');\r\n    } catch (e) {\r\n      this.failed.push('npm audit fix failed');\r\n    }\r\n    \r\n    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π\r\n    const missingDeps = new Map();\r\n    \r\n    this.report.issues.high.forEach(issue => {\r\n      if (issue.issue.includes('–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å')) {\r\n        const match = issue.issue.match(/–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å: (.+)/);\r\n        if (match) {\r\n          const dep = match[1];\r\n          const service = issue.file.split('/')[1];\r\n          \r\n          if (!missingDeps.has(service)) {\r\n            missingDeps.set(service, []);\r\n          }\r\n          missingDeps.get(service).push(dep);\r\n        }\r\n      }\r\n    });\r\n    \r\n    missingDeps.forEach((deps, service) => {\r\n      const servicePath = path.join('services', service);\r\n      console.log(`Installing dependencies for ${service}: ${deps.join(', ')}`);\r\n      \r\n      try {\r\n        execSync(`cd ${servicePath} && npm install ${deps.join(' ')}`, { stdio: 'inherit' });\r\n        this.fixed.push(`Installed dependencies for ${service}`);\r\n      } catch (e) {\r\n        this.failed.push(`Failed to install dependencies for ${service}`);\r\n      }\r\n    });\r\n  }\r\n\r\n  async fixCodeIssues() {\r\n    console.log('\\nüìù Fixing code issues...');\r\n    \r\n    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è ES6 –≤ CommonJS\r\n    this.report.issues.high.forEach(issue => {\r\n      if (issue.issue.includes('–°–º–µ—à–∏–≤–∞–Ω–∏–µ ES6 –∏ CommonJS')) {\r\n        this.convertToCommonJS(issue.file);\r\n      }\r\n    });\r\n    \r\n    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ try-catch\r\n    this.report.issues.medium.forEach(issue => {\r\n      if (issue.issue.includes('Async —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫')) {\r\n        this.addTryCatch(issue.file);\r\n      }\r\n    });\r\n    \r\n    // –ó–∞–º–µ–Ω–∞ console.log –Ω–∞ logger\r\n    this.report.issues.low.forEach(issue => {\r\n      if (issue.issue.includes('console.log')) {\r\n        this.replaceConsoleLog(issue.file);\r\n      }\r\n    });\r\n  }\r\n\r\n  async addMissingComponents() {\r\n    console.log('\\n‚ûï Adding missing components...');\r\n    \r\n    // –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö Dockerfile\r\n    const services = fs.readdirSync('services');\r\n    services.forEach(service => {\r\n      const dockerfilePath = path.join('services', service, 'Dockerfile');\r\n      if (!fs.existsSync(dockerfilePath)) {\r\n        this.createDockerfile(service, dockerfilePath);\r\n      }\r\n    });\r\n    \r\n    // –°–æ–∑–¥–∞–Ω–∏–µ CI/CD pipeline\r\n    if (!fs.existsSync('.github/workflows')) {\r\n      this.createGitHubActions();\r\n    }\r\n    \r\n    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ health checks\r\n    services.forEach(service => {\r\n      const indexPath = path.join('services', service, 'src', 'index.js');\r\n      if (fs.existsSync(indexPath)) {\r\n        this.addHealthCheck(indexPath);\r\n      }\r\n    });\r\n    \r\n    // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤\r\n    services.forEach(service => {\r\n      this.createTestsForService(service);\r\n    });\r\n  }\r\n\r\n  async fixPerformanceIssues() {\r\n    console.log('\\n‚ö° Fixing performance issues...');\r\n    \r\n    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏\r\n    this.report.issues.high.forEach(issue => {\r\n      if (issue.issue.includes('findMany –±–µ–∑ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏')) {\r\n        this.addPagination(issue.file);\r\n      }\r\n    });\r\n    \r\n    // –ó–∞–º–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π\r\n    this.report.issues.medium.forEach(issue => {\r\n      if (issue.issue.includes('–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏')) {\r\n        this.makeAsync(issue.file);\r\n      }\r\n    });\r\n  }\r\n\r\n  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π\r\n  fixInFile(filePath, fix) {\r\n    try {\r\n      let content = fs.readFileSync(filePath, 'utf8');\r\n      const originalContent = content;\r\n      \r\n      if (fix.pattern && fix.replacement) {\r\n        content = content.replace(fix.pattern, fix.replacement);\r\n      } else if (fix.fix) {\r\n        content = fix.fix(content, filePath);\r\n      }\r\n      \r\n      if (content !== originalContent) {\r\n        fs.writeFileSync(filePath, content);\r\n        this.fixed.push(`Fixed: ${filePath} - ${fix.pattern || 'custom fix'}`);\r\n      }\r\n    } catch (error) {\r\n      this.failed.push(`Failed to fix ${filePath}: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  convertToCommonJS(filePath) {\r\n    try {\r\n      let content = fs.readFileSync(filePath, 'utf8');\r\n      \r\n      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º import –≤ require\r\n      content = content.replace(/import\\s+(\\w+)\\s+from\\s+['\"]([^'\"]+)['\"]/g, \r\n        \"const $1 = require('$2')\");\r\n      \r\n      content = content.replace(/import\\s+\\*\\s+as\\s+(\\w+)\\s+from\\s+['\"]([^'\"]+)['\"]/g,\r\n        \"const $1 = require('$2')\");\r\n      \r\n      content = content.replace(/import\\s+\\{([^}]+)\\}\\s+from\\s+['\"]([^'\"]+)['\"]/g,\r\n        \"const {$1} = require('$2')\");\r\n      \r\n      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º export –≤ module.exports\r\n      content = content.replace(/export\\s+default\\s+/g, 'module.exports = ');\r\n      content = content.replace(/export\\s+\\{([^}]+)\\}/g, 'module.exports = {$1}');\r\n      content = content.replace(/export\\s+(const|let|var)\\s+/g, '$1 ');\r\n      \r\n      // –î–æ–±–∞–≤–ª—è–µ–º exports –≤ –∫–æ–Ω–µ—Ü –µ—Å–ª–∏ –Ω—É–∂–Ω–æ\r\n      if (!content.includes('module.exports')) {\r\n        const exports = content.match(/(?:const|let|var)\\s+(\\w+)\\s*=/g) || [];\r\n        if (exports.length > 0) {\r\n          const exportNames = exports.map(e => e.match(/(\\w+)\\s*=/)[1]);\r\n          content += `\\n\\nmodule.exports = { ${exportNames.join(', ')} };`;\r\n        }\r\n      }\r\n      \r\n      fs.writeFileSync(filePath, content);\r\n      this.fixed.push(`Converted to CommonJS: ${filePath}`);\r\n    } catch (error) {\r\n      this.failed.push(`Failed to convert ${filePath}: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  addValidationSchemas(content, filePath) {\r\n    // –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–µ —Å—Ö–µ–º—ã –¥–ª—è common endpoints\r\n    const schemas = `\r\nconst schemas = {\r\n  createSchema: {\r\n    body: {\r\n      type: 'object',\r\n      required: ['name'],\r\n      properties: {\r\n        name: { type: 'string', minLength: 1, maxLength: 255 },\r\n        description: { type: 'string', maxLength: 1000 }\r\n      }\r\n    }\r\n  },\r\n  updateSchema: {\r\n    body: {\r\n      type: 'object',\r\n      properties: {\r\n        name: { type: 'string', minLength: 1, maxLength: 255 },\r\n        description: { type: 'string', maxLength: 1000 }\r\n      }\r\n    }\r\n  },\r\n  querySchema: {\r\n    query: {\r\n      type: 'object',\r\n      properties: {\r\n        page: { type: 'integer', minimum: 1, default: 1 },\r\n        limit: { type: 'integer', minimum: 1, maximum: 100, default: 20 },\r\n        search: { type: 'string', maxLength: 100 }\r\n      }\r\n    }\r\n  }\r\n};\r\n`;\r\n    \r\n    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ö–µ–º—ã –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞\r\n    if (!content.includes('schemas')) {\r\n      content = schemas + '\\n' + content;\r\n    }\r\n    \r\n    // –î–æ–±–∞–≤–ª—è–µ–º schema –∫ routes\r\n    content = content.replace(\r\n      /fastify\\.(get|post|put|patch|delete)\\s*\\(\\s*['\"][^'\"]+['\"]\\s*,\\s*async/g,\r\n      (match) => {\r\n        if (match.includes('post') || match.includes('put') || match.includes('patch')) {\r\n          return match.replace('async', '{ schema: schemas.createSchema }, async');\r\n        } else if (match.includes('get') && !match.includes('/health')) {\r\n          return match.replace('async', '{ schema: schemas.querySchema }, async');\r\n        }\r\n        return match;\r\n      }\r\n    );\r\n    \r\n    return content;\r\n  }\r\n\r\n  addTryCatch(filePath) {\r\n    try {\r\n      let content = fs.readFileSync(filePath, 'utf8');\r\n      \r\n      // –ù–∞—Ö–æ–¥–∏–º async —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ try-catch\r\n      const asyncFunctionRegex = /(async\\s+(?:function\\s+)?\\w*\\s*\\([^)]*\\)\\s*(?:=>)?\\s*\\{)([^}]+)(\\})/g;\r\n      \r\n      content = content.replace(asyncFunctionRegex, (match, start, body, end) => {\r\n        if (!body.includes('try')) {\r\n          return `${start}\r\n  try {${body}  } catch (error) {\r\n    console.error('Error:', error);\r\n    throw error;\r\n  }\r\n${end}`;\r\n        }\r\n        return match;\r\n      });\r\n      \r\n      fs.writeFileSync(filePath, content);\r\n      this.fixed.push(`Added try-catch blocks: ${filePath}`);\r\n    } catch (error) {\r\n      this.failed.push(`Failed to add try-catch: ${filePath}`);\r\n    }\r\n  }\r\n\r\n  replaceConsoleLog(filePath) {\r\n    try {\r\n      let content = fs.readFileSync(filePath, 'utf8');\r\n      \r\n      // –î–æ–±–∞–≤–ª—è–µ–º logger –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç\r\n      if (!content.includes('logger')) {\r\n        content = `const logger = require('@vhm24/shared/logger');\\n\\n` + content;\r\n      }\r\n      \r\n      // –ó–∞–º–µ–Ω—è–µ–º console.log\r\n      content = content.replace(/console\\.log\\(/g, 'logger.info(');\r\n      content = content.replace(/console\\.error\\(/g, 'logger.error(');\r\n      content = content.replace(/console\\.warn\\(/g, 'logger.warn(');\r\n      \r\n      fs.writeFileSync(filePath, content);\r\n      this.fixed.push(`Replaced console.log with logger: ${filePath}`);\r\n    } catch (error) {\r\n      this.failed.push(`Failed to replace console.log: ${filePath}`);\r\n    }\r\n  }\r\n\r\n  createDockerfile(service, dockerfilePath) {\r\n    const dockerfile = `# Build stage\r\nFROM node:18-alpine AS builder\r\n\r\nWORKDIR /app\r\n\r\n# Copy package files\r\nCOPY package*.json ./\r\nCOPY services/${service}/package*.json ./services/${service}/\r\n\r\n# Install dependencies\r\nRUN npm ci --only=production\r\n\r\n# Copy source code\r\nCOPY services/${service} ./services/${service}\r\nCOPY packages ./packages\r\n\r\n# Production stage\r\nFROM node:18-alpine\r\n\r\nWORKDIR /app\r\n\r\n# Copy from builder\r\nCOPY --from=builder /app/node_modules ./node_modules\r\nCOPY --from=builder /app/services/${service} ./services/${service}\r\nCOPY --from=builder /app/packages ./packages\r\n\r\n# Add non-root user\r\nRUN addgroup -g 1001 -S nodejs\r\nRUN adduser -S nodejs -u 1001\r\nUSER nodejs\r\n\r\n# Expose port\r\nEXPOSE \\${PORT:-3000}\r\n\r\n# Health check\r\nHEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \\\\\r\n  CMD node -e \"require('http').get('http://localhost:' + (process.env.PORT || 3000) + '/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))\"\r\n\r\n# Start service\r\nCMD [\"node\", \"services/${service}/src/index.js\"]\r\n`;\r\n    \r\n    fs.writeFileSync(dockerfilePath, dockerfile);\r\n    this.fixed.push(`Created Dockerfile for ${service}`);\r\n  }\r\n\r\n  createGitHubActions() {\r\n    const workflowDir = '.github/workflows';\r\n    fs.mkdirSync(workflowDir, { recursive: true });\r\n    \r\n    const ciWorkflow = `name: CI/CD Pipeline\r\n\r\non:\r\n  push:\r\n    branches: [main, develop]\r\n  pull_request:\r\n    branches: [main]\r\n\r\njobs:\r\n  test:\r\n    runs-on: ubuntu-latest\r\n    \r\n    services:\r\n      postgres:\r\n        image: postgres:15\r\n        env:\r\n          POSTGRES_PASSWORD: postgres\r\n        options: >-\r\n          --health-cmd pg_isready\r\n          --health-interval 10s\r\n          --health-timeout 5s\r\n          --health-retries 5\r\n        ports:\r\n          - 5432:5432\r\n          \r\n      redis:\r\n        image: redis:7\r\n        options: >-\r\n          --health-cmd \"redis-cli ping\"\r\n          --health-interval 10s\r\n          --health-timeout 5s\r\n          --health-retries 5\r\n        ports:\r\n          - 6379:6379\r\n    \r\n    steps:\r\n      - uses: actions/checkout@v3\r\n      \r\n      - name: Setup Node.js\r\n        uses: actions/setup-node@v3\r\n        with:\r\n          node-version: 18\r\n          cache: 'npm'\r\n      \r\n      - name: Install dependencies\r\n        run: |\r\n          npm ci\r\n          npm ci --workspaces\r\n      \r\n      - name: Run linter\r\n        run: npm run lint --if-present\r\n      \r\n      - name: Run tests\r\n        run: npm test\r\n        env:\r\n          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test\r\n          REDIS_URL: redis://localhost:6379\r\n          JWT_SECRET: test-secret-key-for-testing-only\r\n      \r\n      - name: Build\r\n        run: npm run build --if-present\r\n      \r\n      - name: Upload coverage\r\n        uses: codecov/codecov-action@v3\r\n        if: always()\r\n\r\n  security:\r\n    runs-on: ubuntu-latest\r\n    steps:\r\n      - uses: actions/checkout@v3\r\n      \r\n      - name: Run security audit\r\n        run: npm audit --audit-level=high\r\n      \r\n      - name: Run Snyk\r\n        uses: snyk/actions/node@master\r\n        env:\r\n          SNYK_TOKEN: \\${{ secrets.SNYK_TOKEN }}\r\n        continue-on-error: true\r\n\r\n  docker:\r\n    needs: [test, security]\r\n    runs-on: ubuntu-latest\r\n    if: github.ref == 'refs/heads/main'\r\n    \r\n    steps:\r\n      - uses: actions/checkout@v3\r\n      \r\n      - name: Set up Docker Buildx\r\n        uses: docker/setup-buildx-action@v2\r\n      \r\n      - name: Login to Docker Hub\r\n        uses: docker/login-action@v2\r\n        with:\r\n          username: \\${{ secrets.DOCKER_USERNAME }}\r\n          password: \\${{ secrets.DOCKER_PASSWORD }}\r\n      \r\n      - name: Build and push\r\n        uses: docker/build-push-action@v4\r\n        with:\r\n          context: .\r\n          push: true\r\n          tags: |\r\n            vhm24/platform:latest\r\n            vhm24/platform:\\${{ github.sha }}\r\n          cache-from: type=registry,ref=vhm24/platform:buildcache\r\n          cache-to: type=registry,ref=vhm24/platform:buildcache,mode=max\r\n`;\r\n    \r\n    fs.writeFileSync(path.join(workflowDir, 'ci.yml'), ciWorkflow);\r\n    this.fixed.push('Created GitHub Actions CI/CD pipeline');\r\n  }\r\n\r\n  addHealthCheck(filePath) {\r\n    try {\r\n      let content = fs.readFileSync(filePath, 'utf8');\r\n      \r\n      if (!content.includes('/health')) {\r\n        const healthEndpoint = `\r\n// Health check endpoint\r\nfastify.get('/health', async (request, reply) => {\r\n  const health = {\r\n    status: 'ok',\r\n    timestamp: new Date().toISOString(),\r\n    service: '${path.basename(path.dirname(path.dirname(filePath)))}',\r\n    uptime: process.uptime(),\r\n    memory: process.memoryUsage(),\r\n    checks: {}\r\n  };\r\n  \r\n  // Database check\r\n  try {\r\n    await prisma.$queryRaw\\`SELECT 1\\`;\r\n    health.checks.database = 'ok';\r\n  } catch (error) {\r\n    health.checks.database = 'error';\r\n    health.status = 'degraded';\r\n  }\r\n  \r\n  // Redis check (if applicable)\r\n  if (typeof redis !== 'undefined') {\r\n    try {\r\n      await redis.ping();\r\n      health.checks.redis = 'ok';\r\n    } catch (error) {\r\n      health.checks.redis = 'error';\r\n      health.status = 'degraded';\r\n    }\r\n  }\r\n  \r\n  reply.code(health.status === 'ok' ? 200 : 503).send(health);\r\n});\r\n`;\r\n        \r\n        // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ fastify.listen\r\n        content = content.replace(/(fastify\\.listen)/g, healthEndpoint + '\\n$1');\r\n        \r\n        fs.writeFileSync(filePath, content);\r\n        this.fixed.push(`Added health check: ${filePath}`);\r\n      }\r\n    } catch (error) {\r\n      this.failed.push(`Failed to add health check: ${filePath}`);\r\n    }\r\n  }\r\n\r\n  createTestsForService(service) {\r\n    const testDir = path.join('services', service, 'tests');\r\n    fs.mkdirSync(testDir, { recursive: true });\r\n    \r\n    // –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π —Ç–µ—Å—Ç\r\n    const testFile = `const { test } = require('tap');\r\nconst build = require('../src/app');\r\n\r\ntest('health check', async (t) => {\r\n  const app = build({ logger: false });\r\n  \r\n  const response = await app.inject({\r\n    method: 'GET',\r\n    url: '/health'\r\n  });\r\n  \r\n  t.equal(response.statusCode, 200);\r\n  t.match(JSON.parse(response.payload), {\r\n    status: 'ok',\r\n    service: '${service}'\r\n  });\r\n});\r\n\r\ntest('requires authentication', async (t) => {\r\n  const app = build({ logger: false });\r\n  \r\n  const response = await app.inject({\r\n    method: 'GET',\r\n    url: '/api/v1/${service}'\r\n  });\r\n  \r\n  t.equal(response.statusCode, 401);\r\n});\r\n`;\r\n    \r\n    const testPath = path.join(testDir, `${service}.test.js`);\r\n    if (!fs.existsSync(testPath)) {\r\n      fs.writeFileSync(testPath, testFile);\r\n      this.fixed.push(`Created tests for ${service}`);\r\n    }\r\n  }\r\n\r\n  addPagination(filePath) {\r\n    try {\r\n      let content = fs.readFileSync(filePath, 'utf8');\r\n      \r\n      // –ó–∞–º–µ–Ω—è–µ–º findMany() –Ω–∞ findMany —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π\r\n      content = content.replace(\r\n        /\\.findMany\\(\\s*\\)/g,\r\n        `.findMany({\r\n      skip: (request.query.page - 1) * request.query.limit,\r\n      take: request.query.limit,\r\n      orderBy: { createdAt: 'desc' }\r\n    })`\r\n      );\r\n      \r\n      // –¢–∞–∫–∂–µ –¥–ª—è findMany({})\r\n      content = content.replace(\r\n        /\\.findMany\\(\\s*\\{\\s*\\}\\s*\\)/g,\r\n        `.findMany({\r\n      skip: (request.query.page - 1) * request.query.limit,\r\n      take: request.query.limit,\r\n      orderBy: { createdAt: 'desc' }\r\n    })`\r\n      );\r\n      \r\n      fs.writeFileSync(filePath, content);\r\n      this.fixed.push(`Added pagination: ${filePath}`);\r\n    } catch (error) {\r\n      this.failed.push(`Failed to add pagination: ${filePath}`);\r\n    }\r\n  }\r\n\r\n  makeAsync(filePath) {\r\n    try {\r\n      let content = fs.readFileSync(filePath, 'utf8');\r\n      \r\n      // –ó–∞–º–µ–Ω—è–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ\r\n      content = content.replace(/readFileSync\\(/g, 'await fs.promises.readFile(');\r\n      content = content.replace(/writeFileSync\\(/g, 'await fs.promises.writeFile(');\r\n      \r\n      // –î–æ–±–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ\r\n      if (content.includes('fs.promises') && !content.includes(\"require('fs').promises\")) {\r\n        content = content.replace(\r\n          /const fs = require\\(['\"]fs['\"]\\)/,\r\n          \"const fs = require('fs')\\nconst { promises: fsPromises } = fs\"\r\n        );\r\n        content = content.replace(/fs\\.promises/g, 'fsPromises');\r\n      }\r\n      \r\n      fs.writeFileSync(filePath, content);\r\n      this.fixed.push(`Made operations async: ${filePath}`);\r\n    } catch (error) {\r\n      this.failed.push(`Failed to make async: ${filePath}`);\r\n    }\r\n  }\r\n\r\n  async rollbackAll() {\r\n    console.log('\\nüîÑ Rolling back all changes...');\r\n    \r\n    this.backups.forEach((content, filePath) => {\r\n      fs.writeFileSync(filePath, content);\r\n      console.log(`Restored: ${filePath}`);\r\n    });\r\n  }\r\n\r\n  generateFixReport() {\r\n    const report = {\r\n      timestamp: new Date().toISOString(),\r\n      fixed: this.fixed,\r\n      failed: this.failed,\r\n      summary: {\r\n        totalFixed: this.fixed.length,\r\n        totalFailed: this.failed.length,\r\n        successRate: Math.round((this.fixed.length / (this.fixed.length + this.failed.length)) * 100)\r\n      }\r\n    };\r\n    \r\n    fs.writeFileSync('fix-report.json', JSON.stringify(report, null, 2));\r\n    \r\n    console.log('\\nüìä Fix Report:');\r\n    console.log(`‚úÖ Fixed: ${this.fixed.length} issues`);\r\n    console.log(`‚ùå Failed: ${this.failed.length} issues`);\r\n    console.log(`üìà Success rate: ${report.summary.successRate}%`);\r\n    \r\n    if (this.failed.length > 0) {\r\n      console.log('\\n‚ùå Failed fixes:');\r\n      this.failed.forEach(fail => console.log(`  - ${fail}`));\r\n    }\r\n  }\r\n}\r\n\r\n// –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è\r\nasync function runAutoFix() {\r\n  // –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑\r\n  const analysisReport = JSON.parse(fs.readFileSync('analysis-report.json', 'utf8'));\r\n  \r\n  // –ó–∞—Ç–µ–º –∏—Å–ø—Ä–∞–≤–ª—è–µ–º\r\n  const fixer = new AutoFixer(analysisReport);\r\n  await fixer.fixAllIssues();\r\n}\r\n\r\nrunAutoFix().catch(console.error);\r\n",
  "scripts/deploy-to-railway.js": "const { execSync } = require('child_process');\r\nconst fs = require('fs');\r\n\r\nconsole.log('üöÇ VHM24 Railway Deployment Script\\n');\r\n\r\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Railway CLI\r\nfunction checkRailwayCLI() {\r\n  try {\r\n    execSync('railway --version', { stdio: 'pipe' });\r\n    console.log('‚úÖ Railway CLI –Ω–∞–π–¥–µ–Ω');\r\n    return true;\r\n  } catch (error) {\r\n    console.error('‚ùå Railway CLI –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: npm install -g @railway/cli');\r\n    return false;\r\n  }\r\n}\r\n\r\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –≤ Railway\r\nfunction checkRailwayAuth() {\r\n  try {\r\n    execSync('railway whoami', { stdio: 'pipe' });\r\n    console.log('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Railway –∞–∫—Ç–∏–≤–Ω–∞');\r\n    return true;\r\n  } catch (error) {\r\n    console.error('‚ùå –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã –≤ Railway. –í—ã–ø–æ–ª–Ω–∏—Ç–µ: railway login');\r\n    return false;\r\n  }\r\n}\r\n\r\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ–∞–π–ª–æ–≤\r\nfunction checkRequiredFiles() {\r\n  const requiredFiles = [\r\n    'package.json',\r\n    'nixpacks.toml',\r\n    'railway.toml',\r\n    'scripts/start-production.js',\r\n    'scripts/check-env.js',\r\n    'packages/shared/storage/s3.js'\r\n  ];\r\n\r\n  let allFilesExist = true;\r\n  \r\n  requiredFiles.forEach(file => {\r\n    if (fs.existsSync(file)) {\r\n      console.log(`‚úÖ ${file}`);\r\n    } else {\r\n      console.error(`‚ùå ${file} –Ω–µ –Ω–∞–π–¥–µ–Ω`);\r\n      allFilesExist = false;\r\n    }\r\n  });\r\n\r\n  return allFilesExist;\r\n}\r\n\r\n// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–µ–ø–ª–æ—è\r\nasync function deployToRailway() {\r\n  console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –¥–µ–ø–ª–æ—é...\\n');\r\n\r\n  // –ü—Ä–æ–≤–µ—Ä–∫–∏\r\n  if (!checkRailwayCLI()) return;\r\n  if (!checkRailwayAuth()) return;\r\n  if (!checkRequiredFiles()) return;\r\n\r\n  console.log('\\nüöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π...\\n');\r\n\r\n  try {\r\n    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–µ–∫—Ç\r\n    console.log('1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ Railway –ø—Ä–æ–µ–∫—Ç–∞...');\r\n    try {\r\n      const projectInfo = execSync('railway status', { stdio: 'pipe' }).toString();\r\n      console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ Railway –ø—Ä–æ–µ–∫—Ç—É');\r\n    } catch (error) {\r\n      console.log('‚ö†Ô∏è –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ –ø—Ä–æ–µ–∫—Ç—É. –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π...');\r\n      execSync('railway new vhm24-production', { stdio: 'inherit' });\r\n    }\r\n\r\n    // 2. –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç\r\n    console.log('\\n2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö...');\r\n    try {\r\n      const services = execSync('railway services', { stdio: 'pipe' }).toString();\r\n      \r\n      if (!services.includes('postgresql')) {\r\n        console.log('üì¶ –î–æ–±–∞–≤–ª—è–µ–º PostgreSQL...');\r\n        execSync('railway add postgresql', { stdio: 'inherit' });\r\n      } else {\r\n        console.log('‚úÖ PostgreSQL —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω');\r\n      }\r\n      \r\n      if (!services.includes('redis')) {\r\n        console.log('üì¶ –î–æ–±–∞–≤–ª—è–µ–º Redis...');\r\n        execSync('railway add redis', { stdio: 'inherit' });\r\n      } else {\r\n        console.log('‚úÖ Redis —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω');\r\n      }\r\n    } catch (error) {\r\n      console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º...');\r\n    }\r\n\r\n    // 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\n    console.log('\\n3Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è...');\r\n    \r\n    const envVars = {\r\n      NODE_ENV: 'production',\r\n      RAILWAY_SERVICE_NAME: 'gateway',\r\n      JWT_SECRET: 'your-super-secret-jwt-key-change-this-in-production-12345678',\r\n      TELEGRAM_BOT_TOKEN: '8015112367:AAHi25gHhI3p1X1uyuCAt8vUnlMZRrcoKEQ',\r\n      ADMIN_IDS: '42283329',\r\n      ALLOWED_ORIGINS: 'https://your-app.railway.app',\r\n      MAX_FILE_SIZE: '10485760',\r\n      RATE_LIMIT_MAX: '100',\r\n      RATE_LIMIT_WINDOW: '60000',\r\n      SESSION_EXPIRY: '86400000',\r\n      EMAIL_FROM: 'noreply@vhm24.ru'\r\n    };\r\n\r\n    Object.entries(envVars).forEach(([key, value]) => {\r\n      try {\r\n        execSync(`railway variables set ${key}=\"${value}\"`, { stdio: 'pipe' });\r\n        console.log(`‚úÖ ${key} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω`);\r\n      } catch (error) {\r\n        console.log(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ${key}`);\r\n      }\r\n    });\r\n\r\n    // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\n    console.log('\\n4Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è...');\r\n    try {\r\n      execSync('node scripts/check-env.js', { stdio: 'inherit' });\r\n    } catch (error) {\r\n      console.log('‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–µ–ø–ª–æ–π...');\r\n    }\r\n\r\n    // 5. –ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ–ø–ª–æ–π\r\n    console.log('\\n5Ô∏è‚É£ –ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—è...');\r\n    execSync('railway up', { stdio: 'inherit' });\r\n\r\n    // 6. –ü–æ–ª—É—á–∞–µ–º URL –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è\r\n    console.log('\\n6Ô∏è‚É£ –ü–æ–ª—É—á–µ–Ω–∏–µ URL –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');\r\n    try {\r\n      const domain = execSync('railway domain', { stdio: 'pipe' }).toString().trim();\r\n      console.log(`üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: ${domain}`);\r\n      \r\n      // –¢–µ—Å—Ç–∏—Ä—É–µ–º health endpoint\r\n      console.log('\\n7Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');\r\n      setTimeout(() => {\r\n        try {\r\n          const { execSync } = require('child_process');\r\n          execSync(`curl -f ${domain}/health`, { stdio: 'pipe' });\r\n          console.log('‚úÖ Health check –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ');\r\n        } catch (error) {\r\n          console.log('‚ö†Ô∏è Health check –Ω–µ –ø—Ä–æ—à–µ–ª, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏');\r\n        }\r\n      }, 30000); // –ñ–¥–µ–º 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∑–∞–ø—É—Å–∫–∞\r\n\r\n    } catch (error) {\r\n      console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ–º–µ–Ω, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ Railway dashboard');\r\n    }\r\n\r\n    console.log('\\nüéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!');\r\n    console.log('\\nüìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:');\r\n    console.log('1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ DigitalOcean Spaces (—Å–º. DIGITALOCEAN_SPACES_SETUP.md)');\r\n    console.log('2. –û–±–Ω–æ–≤–∏—Ç–µ ALLOWED_ORIGINS —Å —Ä–µ–∞–ª—å–Ω—ã–º URL');\r\n    console.log('3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: railway logs');\r\n    console.log('4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –¥–æ–º–µ–Ω: railway domain add your-domain.com');\r\n\r\n  } catch (error) {\r\n    console.error('\\n‚ùå –û—à–∏–±–∫–∞ –¥–µ–ø–ª–æ—è:', error.message);\r\n    console.log('\\nüîß Troubleshooting:');\r\n    console.log('1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: railway logs');\r\n    console.log('2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: railway variables');\r\n    console.log('3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: railway status');\r\n  }\r\n}\r\n\r\n// –ó–∞–ø—É—Å–∫\r\ndeployToRailway();\r\n",
  "scripts/project-analyzer.js": "const fs = require('fs');\r\nconst path = require('path');\r\nconst { execSync } = require('child_process');\r\n\r\nclass ProjectAnalyzer {\r\n  constructor() {\r\n    this.issues = {\r\n      critical: [],\r\n      high: [],\r\n      medium: [],\r\n      low: [],\r\n      info: []\r\n    };\r\n    this.stats = {\r\n      filesAnalyzed: 0,\r\n      totalIssues: 0,\r\n      fixedIssues: 0\r\n    };\r\n  }\r\n\r\n  async runFullAnalysis() {\r\n    console.log('üîç VHM24 Project Deep Analysis\\n');\r\n    \r\n    // 1. –ê–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\r\n    await this.securityAnalysis();\r\n    \r\n    // 2. –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞\r\n    await this.codeQualityAnalysis();\r\n    \r\n    // 3. –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π\r\n    await this.dependencyAnalysis();\r\n    \r\n    // 4. –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏\r\n    await this.performanceAnalysis();\r\n    \r\n    // 5. –ê–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã\r\n    await this.architectureAnalysis();\r\n    \r\n    // 6. –ê–Ω–∞–ª–∏–∑ DevOps\r\n    await this.devopsAnalysis();\r\n    \r\n    // 7. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞\r\n    this.generateReport();\r\n  }\r\n\r\n  async securityAnalysis() {\r\n    console.log('üîí –ê–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏...\\n');\r\n    \r\n    // –ü–æ–∏—Å–∫ —É—Ç–µ—á–µ–∫ –¥–∞–Ω–Ω—ã—Ö\r\n    this.scanFiles('**/*.js', (filePath, content) => {\r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ reply.send(err)\r\n      if (content.match(/reply\\.(send|code\\(\\d+\\)\\.send)\\s*\\(\\s*err\\s*\\)/)) {\r\n        this.addIssue('critical', {\r\n          file: filePath,\r\n          line: this.getLineNumber(content, /reply\\.send\\s*\\(\\s*err\\s*\\)/),\r\n          issue: '–£—Ç–µ—á–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—à–∏–±–∫–∞—Ö',\r\n          fix: 'reply.code(500).send({ error: \"Internal Server Error\" })'\r\n        });\r\n      }\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏\r\n      if (content.includes('request.body') && !content.includes('schema:')) {\r\n        this.addIssue('high', {\r\n          file: filePath,\r\n          issue: '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö',\r\n          fix: '–î–æ–±–∞–≤–∏—Ç—å JSON Schema –≤–∞–ª–∏–¥–∞—Ü–∏—é'\r\n        });\r\n      }\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ hardcoded credentials\r\n      const secretPatterns = [\r\n        /password\\s*[:=]\\s*[\"'][\\w\\d]{4,}/i,\r\n        /secret\\s*[:=]\\s*[\"'][\\w\\d]{4,}/i,\r\n        /api[_-]?key\\s*[:=]\\s*[\"'][\\w\\d]{4,}/i\r\n      ];\r\n      \r\n      secretPatterns.forEach(pattern => {\r\n        if (pattern.test(content)) {\r\n          this.addIssue('critical', {\r\n            file: filePath,\r\n            issue: 'Hardcoded credentials',\r\n            fix: '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è'\r\n          });\r\n        }\r\n      });\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT\r\n      if (content.includes('jwt') && !content.includes('expiresIn')) {\r\n        this.addIssue('medium', {\r\n          file: filePath,\r\n          issue: 'JWT —Ç–æ–∫–µ–Ω—ã –±–µ–∑ —Å—Ä–æ–∫–∞ –∂–∏–∑–Ω–∏',\r\n          fix: '–î–æ–±–∞–≤–∏—Ç—å expiresIn –≤ JWT –æ–ø—Ü–∏–∏'\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  async codeQualityAnalysis() {\r\n    console.log('üìù –ê–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞...\\n');\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–º–µ—à–∏–≤–∞–Ω–∏–µ –º–æ–¥—É–ª–µ–π\r\n    this.scanFiles('**/*.js', (filePath, content) => {\r\n      const hasImport = content.includes('import ');\r\n      const hasRequire = content.includes('require(');\r\n      \r\n      if (hasImport && hasRequire) {\r\n        this.addIssue('high', {\r\n          file: filePath,\r\n          issue: '–°–º–µ—à–∏–≤–∞–Ω–∏–µ ES6 –∏ CommonJS –º–æ–¥—É–ª–µ–π',\r\n          fix: '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ CommonJS (require/module.exports)'\r\n        });\r\n      }\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ try-catch\r\n      if (content.includes('async') && !content.includes('try')) {\r\n        this.addIssue('medium', {\r\n          file: filePath,\r\n          issue: 'Async —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫',\r\n          fix: '–î–æ–±–∞–≤–∏—Ç—å try-catch –±–ª–æ–∫–∏'\r\n        });\r\n      }\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ console.log\r\n      if (content.includes('console.log')) {\r\n        this.addIssue('low', {\r\n          file: filePath,\r\n          issue: '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ console.log –≤–º–µ—Å—Ç–æ logger',\r\n          fix: '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (pino/winston)'\r\n        });\r\n      }\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–∞–≥–∏—á–µ—Å–∫–∏–µ —á–∏—Å–ª–∞\r\n      const magicNumbers = content.match(/\\b\\d{4,}\\b/g);\r\n      if (magicNumbers && magicNumbers.length > 2) {\r\n        this.addIssue('low', {\r\n          file: filePath,\r\n          issue: '–ú–∞–≥–∏—á–µ—Å–∫–∏–µ —á–∏—Å–ª–∞ –≤ –∫–æ–¥–µ',\r\n          fix: '–í—ã–Ω–µ—Å—Ç–∏ –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã'\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  async dependencyAnalysis() {\r\n    console.log('üì¶ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...\\n');\r\n    \r\n    try {\r\n      // npm audit\r\n      const auditResult = execSync('npm audit --json', { stdio: 'pipe' }).toString();\r\n      const audit = JSON.parse(auditResult);\r\n      \r\n      if (audit.metadata.vulnerabilities.total > 0) {\r\n        this.addIssue('critical', {\r\n          issue: `–ù–∞–π–¥–µ–Ω–æ ${audit.metadata.vulnerabilities.total} —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π`,\r\n          critical: audit.metadata.vulnerabilities.critical,\r\n          high: audit.metadata.vulnerabilities.high,\r\n          fix: 'npm audit fix --force'\r\n        });\r\n      }\r\n    } catch (e) {\r\n      // npm audit –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç non-zero –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π\r\n    }\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π\r\n    this.scanFiles('services/*/src/**/*.js', (filePath, content) => {\r\n      const requires = content.match(/require\\(['\"]([^'\"]+)['\"]\\)/g) || [];\r\n      requires.forEach(req => {\r\n        const module = req.match(/require\\(['\"]([^'\"]+)['\"]\\)/)[1];\r\n        if (!module.startsWith('.') && !module.startsWith('@vhm24')) {\r\n          const servicePath = filePath.split('/').slice(0, 2).join('/');\r\n          const packageJsonPath = path.join(servicePath, 'package.json');\r\n          \r\n          if (fs.existsSync(packageJsonPath)) {\r\n            const pkg = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'));\r\n            const deps = Object.keys(pkg.dependencies || {});\r\n            \r\n            if (!deps.includes(module) && !this.isBuiltinModule(module)) {\r\n              this.addIssue('high', {\r\n                file: filePath,\r\n                issue: `–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å: ${module}`,\r\n                fix: `cd ${servicePath} && npm install ${module}`\r\n              });\r\n            }\r\n          }\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  async performanceAnalysis() {\r\n    console.log('‚ö° –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏...\\n');\r\n    \r\n    this.scanFiles('**/*.js', (filePath, content) => {\r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏\r\n      if (content.includes('findMany()') || content.includes('findMany({})')) {\r\n        this.addIssue('high', {\r\n          file: filePath,\r\n          issue: 'findMany –±–µ–∑ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏',\r\n          fix: '–î–æ–±–∞–≤–∏—Ç—å skip/take –ø–∞—Ä–∞–º–µ—Ç—Ä—ã'\r\n        });\r\n      }\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏\r\n      if (content.includes('readFileSync') || content.includes('writeFileSync')) {\r\n        this.addIssue('medium', {\r\n          file: filePath,\r\n          issue: '–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã',\r\n          fix: '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏'\r\n        });\r\n      }\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤\r\n      if (content.includes('where:') && content.includes('createdAt')) {\r\n        this.addIssue('medium', {\r\n          file: filePath,\r\n          issue: '–ó–∞–ø—Ä–æ—Å—ã –ø–æ –Ω–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—è–º',\r\n          fix: '–î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –≤ schema.prisma'\r\n        });\r\n      }\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ N+1 –ø—Ä–æ–±–ª–µ–º—ã\r\n      if (content.includes('.map') && content.includes('await') && content.includes('prisma')) {\r\n        this.addIssue('high', {\r\n          file: filePath,\r\n          issue: '–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è N+1 –ø—Ä–æ–±–ª–µ–º–∞',\r\n          fix: '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å include –∏–ª–∏ Promise.all'\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  async architectureAnalysis() {\r\n    console.log('üèóÔ∏è –ê–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã...\\n');\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–µ—Ä–≤–∏—Å–æ–≤\r\n    const services = fs.readdirSync('services');\r\n    services.forEach(service => {\r\n      const requiredDirs = ['src', 'tests', 'docs'];\r\n      const servicePath = path.join('services', service);\r\n      \r\n      requiredDirs.forEach(dir => {\r\n        if (!fs.existsSync(path.join(servicePath, dir))) {\r\n          this.addIssue('medium', {\r\n            service,\r\n            issue: `–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è ${dir}`,\r\n            fix: `mkdir -p ${servicePath}/${dir}`\r\n          });\r\n        }\r\n      });\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ç–µ—Å—Ç–æ–≤\r\n      const testDir = path.join(servicePath, 'tests');\r\n      if (!fs.existsSync(testDir) || fs.readdirSync(testDir).length === 0) {\r\n        this.addIssue('high', {\r\n          service,\r\n          issue: '–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ç–µ—Å—Ç—ã',\r\n          fix: '–°–æ–∑–¥–∞—Ç—å –º–æ–¥—É–ª—å–Ω—ã–µ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã'\r\n        });\r\n      }\r\n    });\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞\r\n    const codePatterns = new Map();\r\n    this.scanFiles('**/*.js', (filePath, content) => {\r\n      // –ò—â–µ–º –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω—ã\r\n      const functions = content.match(/function\\s+\\w+|const\\s+\\w+\\s*=\\s*(?:async\\s*)?\\(/g) || [];\r\n      functions.forEach(func => {\r\n        if (codePatterns.has(func)) {\r\n          codePatterns.get(func).push(filePath);\r\n        } else {\r\n          codePatterns.set(func, [filePath]);\r\n        }\r\n      });\r\n    });\r\n    \r\n    codePatterns.forEach((files, pattern) => {\r\n      if (files.length > 2) {\r\n        this.addIssue('medium', {\r\n          issue: `–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞: ${pattern}`,\r\n          files: files,\r\n          fix: '–í—ã–Ω–µ—Å—Ç–∏ –≤ shared –ø–∞–∫–µ—Ç'\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  async devopsAnalysis() {\r\n    console.log('üöÄ –ê–Ω–∞–ª–∏–∑ DevOps...\\n');\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ Dockerfile\r\n    const services = fs.readdirSync('services');\r\n    services.forEach(service => {\r\n      if (!fs.existsSync(path.join('services', service, 'Dockerfile'))) {\r\n        this.addIssue('high', {\r\n          service,\r\n          issue: '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç Dockerfile',\r\n          fix: '–°–æ–∑–¥–∞—Ç—å multi-stage Dockerfile'\r\n        });\r\n      }\r\n    });\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ CI/CD\r\n    if (!fs.existsSync('.github/workflows')) {\r\n      this.addIssue('high', {\r\n        issue: '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç CI/CD pipeline',\r\n        fix: '–°–æ–∑–¥–∞—Ç—å GitHub Actions workflow'\r\n      });\r\n    }\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ .dockerignore\r\n    if (!fs.existsSync('.dockerignore')) {\r\n      this.addIssue('medium', {\r\n        issue: '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç .dockerignore',\r\n        fix: '–°–æ–∑–¥–∞—Ç—å .dockerignore —Ñ–∞–π–ª'\r\n      });\r\n    }\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ health checks\r\n    this.scanFiles('services/*/src/index.js', (filePath, content) => {\r\n      if (!content.includes('/health')) {\r\n        this.addIssue('high', {\r\n          file: filePath,\r\n          issue: '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç health check endpoint',\r\n          fix: '–î–æ–±–∞–≤–∏—Ç—å GET /health endpoint'\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã\r\n  scanFiles(pattern, callback) {\r\n    const glob = require('glob');\r\n    const files = glob.sync(pattern, { \r\n      ignore: ['**/node_modules/**', '**/dist/**', '**/coverage/**'] \r\n    });\r\n    \r\n    files.forEach(file => {\r\n      const content = fs.readFileSync(file, 'utf8');\r\n      callback(file, content);\r\n      this.stats.filesAnalyzed++;\r\n    });\r\n  }\r\n\r\n  addIssue(severity, issue) {\r\n    this.issues[severity].push(issue);\r\n    this.stats.totalIssues++;\r\n  }\r\n\r\n  getLineNumber(content, pattern) {\r\n    const lines = content.split('\\n');\r\n    for (let i = 0; i < lines.length; i++) {\r\n      if (pattern.test(lines[i])) {\r\n        return i + 1;\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  isBuiltinModule(module) {\r\n    const builtins = ['fs', 'path', 'http', 'https', 'crypto', 'os', 'util', 'stream', 'events'];\r\n    return builtins.includes(module);\r\n  }\r\n\r\n  generateReport() {\r\n    const report = {\r\n      timestamp: new Date().toISOString(),\r\n      stats: this.stats,\r\n      issues: this.issues,\r\n      summary: {\r\n        critical: this.issues.critical.length,\r\n        high: this.issues.high.length,\r\n        medium: this.issues.medium.length,\r\n        low: this.issues.low.length,\r\n        total: this.stats.totalIssues\r\n      }\r\n    };\r\n    \r\n    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π JSON –æ—Ç—á–µ—Ç\r\n    fs.writeFileSync('analysis-report.json', JSON.stringify(report, null, 2));\r\n    \r\n    // –°–æ–∑–¥–∞–µ–º Markdown –æ—Ç—á–µ—Ç\r\n    let markdown = `# VHM24 Project Analysis Report\r\n\r\nGenerated: ${new Date().toLocaleString()}\r\n\r\n## üìä Summary\r\n\r\n- **Files Analyzed**: ${this.stats.filesAnalyzed}\r\n- **Total Issues**: ${this.stats.totalIssues}\r\n- **Critical**: ${this.issues.critical.length}\r\n- **High**: ${this.issues.high.length}\r\n- **Medium**: ${this.issues.medium.length}\r\n- **Low**: ${this.issues.low.length}\r\n\r\n## üö® Critical Issues\\n\\n`;\r\n\r\n    ['critical', 'high', 'medium', 'low'].forEach(severity => {\r\n      if (this.issues[severity].length > 0) {\r\n        markdown += `### ${severity.toUpperCase()} Priority\\n\\n`;\r\n        this.issues[severity].forEach((issue, index) => {\r\n          markdown += `${index + 1}. **${issue.issue}**\\n`;\r\n          if (issue.file) markdown += `   - File: \\`${issue.file}\\`\\n`;\r\n          if (issue.line) markdown += `   - Line: ${issue.line}\\n`;\r\n          if (issue.fix) markdown += `   - Fix: \\`${issue.fix}\\`\\n`;\r\n          markdown += '\\n';\r\n        });\r\n      }\r\n    });\r\n    \r\n    fs.writeFileSync('ANALYSIS_REPORT.md', markdown);\r\n    \r\n    console.log('\\n‚úÖ Analysis complete!');\r\n    console.log(`üìÑ Reports saved: analysis-report.json, ANALYSIS_REPORT.md`);\r\n  }\r\n}\r\n\r\n// –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞\r\nconst analyzer = new ProjectAnalyzer();\r\nanalyzer.runFullAnalysis().catch(console.error);\r\n",
  "scripts/setup-railway-env.js": "const { execSync } = require('child_process');\r\n\r\nconsole.log('üöÇ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è Railway...\\n');\r\n\r\n// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ –≤–∞—à–µ–≥–æ .env —Ñ–∞–π–ª–∞\r\nconst envVars = {\r\n  // –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å\r\n  JWT_SECRET: 'your-super-secret-jwt-key-change-this-in-production-12345678',\r\n  ALLOWED_ORIGINS: 'https://your-app.railway.app,https://your-dashboard.railway.app',\r\n  \r\n  // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (—É–∂–µ –µ—Å—Ç—å –≤ Railway)\r\n  DATABASE_URL: 'postgresql://postgres:tcaqejEXLSdaUdMQXFqEDGBQvavWVbGy@metro.proxy.rlwy.net:36258/railway',\r\n  AUTH_DATABASE_URL: 'postgresql://postgres:tcaqejEXLSdaUdMQXFqEDGBQvavWVbGy@metro.proxy.rlwy.net:36258/railway',\r\n  \r\n  // Redis (—É–∂–µ –µ—Å—Ç—å –≤ Railway)\r\n  REDIS_URL: 'redis://default:RgADgivPNrtbjDUQYGWfzkJnmwCEnPil@maglev.proxy.rlwy.net:56313',\r\n  REDIS_TTL: '3600',\r\n  \r\n  // Telegram Bot\r\n  TELEGRAM_BOT_TOKEN: '8015112367:AAHi25gHhI3p1X1uyuCAt8vUnlMZRrcoKEQ',\r\n  ADMIN_IDS: '42283329',\r\n  \r\n  // –ü–æ—Ä—Ç—ã (Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–∞–µ—Ç PORT)\r\n  GATEWAY_PORT: '8000',\r\n  AUTH_PORT: '3001',\r\n  MACHINES_PORT: '3002',\r\n  INVENTORY_PORT: '3003',\r\n  TASKS_PORT: '3004',\r\n  BUNKERS_PORT: '3005',\r\n  \r\n  // API Configuration\r\n  API_URL: 'https://your-app.railway.app/api/v1',\r\n  \r\n  // File Storage - –ù–£–ñ–ù–û –ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê DIGITALOCEAN SPACES\r\n  MAX_FILE_SIZE: '10485760',\r\n  \r\n  // Rate Limiting\r\n  RATE_LIMIT_MAX: '100',\r\n  RATE_LIMIT_WINDOW: '60000',\r\n  \r\n  // Session\r\n  SESSION_EXPIRY: '86400000',\r\n  \r\n  // Environment\r\n  NODE_ENV: 'production',\r\n  \r\n  // Monitoring\r\n  PROMETHEUS_PORT: '9090',\r\n  \r\n  // Email\r\n  SMTP_HOST: 'smtp.gmail.com',\r\n  SMTP_PORT: '587',\r\n  EMAIL_FROM: 'noreply@vhm24.ru',\r\n  \r\n  // Backup\r\n  BACKUP_ENABLED: 'true',\r\n  BACKUP_SCHEDULE: '0 2 * * *',\r\n  BACKUP_RETENTION_DAYS: '30'\r\n};\r\n\r\n// DigitalOcean Spaces –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è)\r\nconst digitalOceanVars = {\r\n  // DigitalOcean Spaces –¥–ª—è —Ñ–∞–π–ª–æ–≤\r\n  S3_ENDPOINT: 'https://fra1.digitaloceanspaces.com', // –∏–ª–∏ –¥—Ä—É–≥–æ–π —Ä–µ–≥–∏–æ–Ω\r\n  S3_BUCKET: 'vhm24-uploads',\r\n  S3_ACCESS_KEY: 'YOUR_DO_SPACES_ACCESS_KEY',\r\n  S3_SECRET_KEY: 'YOUR_DO_SPACES_SECRET_KEY',\r\n  S3_REGION: 'fra1', // –∏–ª–∏ –¥—Ä—É–≥–æ–π —Ä–µ–≥–∏–æ–Ω\r\n  \r\n  // –î–ª—è –±—ç–∫–∞–ø–æ–≤\r\n  BACKUP_S3_BUCKET: 'vhm24-backups',\r\n  BACKUP_S3_ACCESS_KEY: 'YOUR_DO_SPACES_ACCESS_KEY',\r\n  BACKUP_S3_SECRET_KEY: 'YOUR_DO_SPACES_SECRET_KEY',\r\n  BACKUP_S3_ENDPOINT: 'https://fra1.digitaloceanspaces.com'\r\n};\r\n\r\nfunction setRailwayVariable(key, value) {\r\n  try {\r\n    console.log(`Setting ${key}...`);\r\n    execSync(`railway variables set ${key}=\"${value}\"`, { stdio: 'pipe' });\r\n    console.log(`‚úÖ ${key} set successfully`);\r\n  } catch (error) {\r\n    console.error(`‚ùå Failed to set ${key}: ${error.message}`);\r\n  }\r\n}\r\n\r\nconsole.log('üîß –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ...\\n');\r\n\r\n// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ\r\nObject.entries(envVars).forEach(([key, value]) => {\r\n  setRailwayVariable(key, value);\r\n});\r\n\r\nconsole.log('\\n‚ö†Ô∏è –í–ê–ñ–ù–û: –ù—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å DigitalOcean Spaces –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:');\r\nconsole.log('–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è DigitalOcean Spaces –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:');\r\nconsole.log('');\r\n\r\nObject.entries(digitalOceanVars).forEach(([key, value]) => {\r\n  console.log(`railway variables set ${key}=\"${value}\"`);\r\n});\r\n\r\nconsole.log('\\n‚úÖ –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!');\r\nconsole.log('\\nüìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:');\r\nconsole.log('1. –°–æ–∑–¥–∞–π—Ç–µ DigitalOcean Spaces (–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–∏–∂–µ)');\r\nconsole.log('2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ DigitalOcean –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ');\r\nconsole.log('3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –¥–µ–ø–ª–æ–π: railway up');\r\n",
  "services/audit/src/index.js": "const fastify = require('fastify')({ logger: true });\r\nconst { PrismaClient } = require('@prisma/client');\r\nconst cron = require('node-cron');\r\n\r\nconst prisma = new PrismaClient();\r\n\r\n// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–ª–∞–≥–∏–Ω–æ–≤\r\nfastify.register(require('@fastify/cors'), {\r\n  origin: true,\r\n  credentials: true\r\n});\r\n\r\nfastify.register(require('@fastify/helmet'));\r\nfastify.register(require('@fastify/rate-limit'), {\r\n  max: 100,\r\n  timeWindow: '1 minute'\r\n});\r\n\r\nfastify.register(require('@fastify/jwt'), {\r\n  secret: process.env.JWT_SECRET || 'your-secret-key'\r\n});\r\n\r\n// –ò–º–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç–æ–≤\r\nfastify.register(require('./routes/audit'), { prefix: '/api/audit' });\r\nfastify.register(require('./routes/reports'), { prefix: '/api/reports' });\r\nfastify.register(require('./routes/incomplete-data'), { prefix: '/api/incomplete-data' });\r\n\r\n// Middleware –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏\r\nfastify.decorate('authenticate', async function(request, reply) {\r\n  try {\r\n    await request.jwtVerify();\r\n  } catch (err) {\r\n    reply.send(err);\r\n  }\r\n});\r\n\r\n// Middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤\r\nfastify.addHook('preHandler', async (request, reply) => {\r\n  const auditService = require('./services/auditService');\r\n  \r\n  // –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –≤—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã\r\n  await auditService.logSystemAction({\r\n    userId: request.user?.id || null,\r\n    sessionId: request.headers['x-session-id'] || null,\r\n    action: 'READ',\r\n    entity: 'API_REQUEST',\r\n    description: `${request.method} ${request.url}`,\r\n    inputData: {\r\n      method: request.method,\r\n      url: request.url,\r\n      params: request.params,\r\n      query: request.query,\r\n      body: request.method !== 'GET' ? request.body : undefined\r\n    },\r\n    ipAddress: request.ip,\r\n    userAgent: request.headers['user-agent'],\r\n    endpoint: request.url,\r\n    method: request.method\r\n  });\r\n});\r\n\r\n// Hook –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤\r\nfastify.addHook('onSend', async (request, reply, payload) => {\r\n  const auditService = require('./services/auditService');\r\n  \r\n  await auditService.logSystemAction({\r\n    userId: request.user?.id || null,\r\n    sessionId: request.headers['x-session-id'] || null,\r\n    action: 'INFO',\r\n    entity: 'API_RESPONSE',\r\n    description: `Response for ${request.method} ${request.url}`,\r\n    metadata: {\r\n      statusCode: reply.statusCode,\r\n      responseTime: reply.getResponseTime()\r\n    },\r\n    ipAddress: request.ip,\r\n    userAgent: request.headers['user-agent'],\r\n    endpoint: request.url,\r\n    method: request.method,\r\n    statusCode: reply.statusCode,\r\n    responseTime: reply.getResponseTime()\r\n  });\r\n});\r\n\r\n// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞\r\nfastify.get('/health', async (request, reply) => {\r\n  try {\r\n    await prisma.$queryRaw`SELECT 1`;\r\n    return { status: 'ok', service: 'audit', timestamp: new Date().toISOString() };\r\n  } catch (error) {\r\n    reply.code(500);\r\n    return { status: 'error', service: 'audit', error: error.message };\r\n  }\r\n});\r\n\r\n// –ó–∞–ø—É—Å–∫ cron –∑–∞–¥–∞—á –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö\r\ncron.schedule('0 */6 * * *', async () => {\r\n  const incompleteDataService = require('./services/incompleteDataService');\r\n  await incompleteDataService.processIncompleteData();\r\n});\r\n\r\n// –ó–∞–ø—É—Å–∫ cron –∑–∞–¥–∞—á –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤\r\ncron.schedule('0 2 * * 0', async () => {\r\n  const auditService = require('./services/auditService');\r\n  await auditService.cleanupOldLogs();\r\n});\r\n\r\n// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞\r\nconst start = async () => {\r\n  try {\r\n    const port = process.env.AUDIT_SERVICE_PORT || 3009;\r\n    await fastify.listen({ port, host: '0.0.0.0' });\r\n    console.log(`üîç Audit service –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${port}`);\r\n  } catch (err) {\r\n    fastify.log.error(err);\r\n    process.exit(1);\r\n  }\r\n};\r\n\r\n// Graceful shutdown\r\nprocess.on('SIGTERM', async () => {\r\n  await prisma.$disconnect();\r\n  await fastify.close();\r\n});\r\n\r\nprocess.on('SIGINT', async () => {\r\n  await prisma.$disconnect();\r\n  await fastify.close();\r\n});\r\n\r\nstart();\r\n",
  "services/auth/src/__tests__/auth.test.js": "/**\r\n * VHM24 Auth Service Tests\r\n * Production-ready —Ç–µ—Å—Ç—ã –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏\r\n */\r\n\r\nconst { test, beforeAll, afterAll, describe } = require('@jest/globals');\r\nconst Fastify = require('fastify');\r\nconst { getAuthClient } = require('@vhm24/database');\r\n\r\n// –ú–æ–∫–∞–µ–º shared –ø–∞–∫–µ—Ç –¥–ª—è —Ç–µ—Å—Ç–æ–≤\r\njest.mock('@vhm24/shared', () => ({\r\n  setupCORS: jest.fn(),\r\n  setupHelmet: jest.fn(),\r\n  setupRateLimit: jest.fn(),\r\n  setupJWT: jest.fn(),\r\n  authenticate: jest.fn(),\r\n  authorize: jest.fn(),\r\n  sanitizeInputs: jest.fn(),\r\n  securityLogger: jest.fn(),\r\n  healthCheck: jest.fn(),\r\n  validateBody: jest.fn(),\r\n  validateQuery: jest.fn(),\r\n  validateId: jest.fn(),\r\n  registerErrorHandlers: jest.fn(),\r\n  setupGlobalErrorHandlers: jest.fn(),\r\n  createError: {\r\n    authentication: jest.fn((msg) => new Error(msg)),\r\n    database: jest.fn((msg) => new Error(msg)),\r\n    validation: jest.fn((msg) => new Error(msg))\r\n  },\r\n  asyncHandler: jest.fn((fn) => fn),\r\n  logger: {\r\n    info: jest.fn(),\r\n    error: jest.fn(),\r\n    warn: jest.fn(),\r\n    debug: jest.fn()\r\n  },\r\n  config: {},\r\n  createFastifyConfig: jest.fn(() => ({ logger: false }))\r\n}));\r\n\r\n// –ú–æ–∫–∞–µ–º Prisma –∫–ª–∏–µ–Ω—Ç\r\nconst mockPrisma = {\r\n  user: {\r\n    findFirst: jest.fn(),\r\n    findUnique: jest.fn(),\r\n    create: jest.fn(),\r\n    update: jest.fn(),\r\n    count: jest.fn()\r\n  },\r\n  auditLog: {\r\n    create: jest.fn()\r\n  },\r\n  $transaction: jest.fn(),\r\n  $disconnect: jest.fn()\r\n};\r\n\r\njest.mock('@vhm24/database', () => ({\r\n  getAuthClient: jest.fn(() => mockPrisma)\r\n}));\r\n\r\n// –ú–æ–∫–∞–µ–º bcrypt\r\njest.mock('bcrypt', () => ({\r\n  hash: jest.fn(() => Promise.resolve('hashedPassword')),\r\n  compare: jest.fn(() => Promise.resolve(true))\r\n}));\r\n\r\ndescribe('Auth Service', () => {\r\n  let app;\r\n  \r\n  beforeAll(async () => {\r\n    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\n    process.env.NODE_ENV = 'test';\r\n    process.env.JWT_SECRET = 'test-secret-key-for-testing-purposes-only';\r\n    process.env.SERVICE_NAME = 'auth';\r\n    \r\n    // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\r\n    app = Fastify({ logger: false });\r\n    \r\n    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º JWT –¥–ª—è —Ç–µ—Å—Ç–æ–≤\r\n    await app.register(require('@fastify/jwt'), {\r\n      secret: process.env.JWT_SECRET\r\n    });\r\n    \r\n    // –ü—Ä–æ—Å—Ç—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —Ä–æ—É—Ç—ã\r\n    app.get('/health', async () => ({ status: 'ok', service: 'auth' }));\r\n    \r\n    app.post('/api/v1/auth/login', async (request, reply) => {\r\n      const { email, password } = request.body;\r\n      \r\n      if (!email || !password) {\r\n        return reply.code(400).send({ error: 'Email and password required' });\r\n      }\r\n      \r\n      // –ú–æ–∫–∞–µ–º –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n      const user = await mockPrisma.user.findFirst({\r\n        where: { email: email.toLowerCase() }\r\n      });\r\n      \r\n      if (!user) {\r\n        return reply.code(401).send({ error: 'Invalid credentials' });\r\n      }\r\n      \r\n      const token = app.jwt.sign({\r\n        id: user.id,\r\n        email: user.email,\r\n        roles: user.roles\r\n      });\r\n      \r\n      return {\r\n        success: true,\r\n        token,\r\n        user: {\r\n          id: user.id,\r\n          email: user.email,\r\n          name: user.name,\r\n          roles: user.roles\r\n        }\r\n      };\r\n    });\r\n    \r\n    app.post('/api/v1/auth/register', async (request, reply) => {\r\n      const { email, password, name } = request.body;\r\n      \r\n      if (!email || !password || !name) {\r\n        return reply.code(400).send({ \r\n          error: 'Email, password and name are required' \r\n        });\r\n      }\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n      const existingUser = await mockPrisma.user.findFirst({\r\n        where: { email: email.toLowerCase() }\r\n      });\r\n      \r\n      if (existingUser) {\r\n        return reply.code(400).send({ \r\n          error: 'User already exists' \r\n        });\r\n      }\r\n      \r\n      // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n      const user = await mockPrisma.user.create({\r\n        data: {\r\n          email: email.toLowerCase(),\r\n          passwordHash: 'hashedPassword',\r\n          name,\r\n          roles: ['OPERATOR']\r\n        }\r\n      });\r\n      \r\n      const token = app.jwt.sign({\r\n        id: user.id,\r\n        email: user.email,\r\n        roles: user.roles\r\n      });\r\n      \r\n      return {\r\n        success: true,\r\n        data: {\r\n          user,\r\n          token\r\n        }\r\n      };\r\n    });\r\n    \r\n    await app.ready();\r\n  });\r\n  \r\n  afterAll(async () => {\r\n    await app.close();\r\n    await mockPrisma.$disconnect();\r\n  });\r\n  \r\n  describe('Health Check', () => {\r\n    test('should return health status', async () => {\r\n      const response = await app.inject({\r\n        method: 'GET',\r\n        url: '/health'\r\n      });\r\n      \r\n      expect(response.statusCode).toBe(200);\r\n      const payload = JSON.parse(response.payload);\r\n      expect(payload.status).toBe('ok');\r\n      expect(payload.service).toBe('auth');\r\n    });\r\n  });\r\n  \r\n  describe('Authentication', () => {\r\n    beforeEach(() => {\r\n      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –º–æ–∫–∏ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º\r\n      jest.clearAllMocks();\r\n    });\r\n    \r\n    test('should login with valid credentials', async () => {\r\n      // –ú–æ–∫–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n      mockPrisma.user.findFirst.mockResolvedValue({\r\n        id: '1',\r\n        email: 'test@example.com',\r\n        name: 'Test User',\r\n        roles: ['OPERATOR'],\r\n        isActive: true,\r\n        passwordHash: 'hashedPassword'\r\n      });\r\n      \r\n      const response = await app.inject({\r\n        method: 'POST',\r\n        url: '/api/v1/auth/login',\r\n        payload: {\r\n          email: 'test@example.com',\r\n          password: 'password123'\r\n        }\r\n      });\r\n      \r\n      expect(response.statusCode).toBe(200);\r\n      const payload = JSON.parse(response.payload);\r\n      expect(payload.success).toBe(true);\r\n      expect(payload.token).toBeDefined();\r\n      expect(payload.user.email).toBe('test@example.com');\r\n      expect(mockPrisma.user.findFirst).toHaveBeenCalledWith({\r\n        where: { email: 'test@example.com' }\r\n      });\r\n    });\r\n    \r\n    test('should reject login with invalid credentials', async () => {\r\n      // –ú–æ–∫–∞–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n      mockPrisma.user.findFirst.mockResolvedValue(null);\r\n      \r\n      const response = await app.inject({\r\n        method: 'POST',\r\n        url: '/api/v1/auth/login',\r\n        payload: {\r\n          email: 'nonexistent@example.com',\r\n          password: 'wrongpassword'\r\n        }\r\n      });\r\n      \r\n      expect(response.statusCode).toBe(401);\r\n      const payload = JSON.parse(response.payload);\r\n      expect(payload.error).toBe('Invalid credentials');\r\n    });\r\n    \r\n    test('should reject login without email or password', async () => {\r\n      const response = await app.inject({\r\n        method: 'POST',\r\n        url: '/api/v1/auth/login',\r\n        payload: {\r\n          email: 'test@example.com'\r\n          // password –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç\r\n        }\r\n      });\r\n      \r\n      expect(response.statusCode).toBe(400);\r\n      const payload = JSON.parse(response.payload);\r\n      expect(payload.error).toBe('Email and password required');\r\n    });\r\n  });\r\n  \r\n  describe('Registration', () => {\r\n    beforeEach(() => {\r\n      jest.clearAllMocks();\r\n    });\r\n    \r\n    test('should register new user successfully', async () => {\r\n      // –ú–æ–∫–∞–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n      mockPrisma.user.findFirst.mockResolvedValue(null);\r\n      \r\n      // –ú–æ–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n      mockPrisma.user.create.mockResolvedValue({\r\n        id: '2',\r\n        email: 'newuser@example.com',\r\n        name: 'New User',\r\n        roles: ['OPERATOR'],\r\n        createdAt: new Date()\r\n      });\r\n      \r\n      const response = await app.inject({\r\n        method: 'POST',\r\n        url: '/api/v1/auth/register',\r\n        payload: {\r\n          email: 'newuser@example.com',\r\n          password: 'password123',\r\n          name: 'New User'\r\n        }\r\n      });\r\n      \r\n      expect(response.statusCode).toBe(200);\r\n      const payload = JSON.parse(response.payload);\r\n      expect(payload.success).toBe(true);\r\n      expect(payload.data.token).toBeDefined();\r\n      expect(payload.data.user.email).toBe('newuser@example.com');\r\n      expect(mockPrisma.user.create).toHaveBeenCalled();\r\n    });\r\n    \r\n    test('should reject registration for existing user', async () => {\r\n      // –ú–æ–∫–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n      mockPrisma.user.findFirst.mockResolvedValue({\r\n        id: '1',\r\n        email: 'existing@example.com',\r\n        name: 'Existing User'\r\n      });\r\n      \r\n      const response = await app.inject({\r\n        method: 'POST',\r\n        url: '/api/v1/auth/register',\r\n        payload: {\r\n          email: 'existing@example.com',\r\n          password: 'password123',\r\n          name: 'New User'\r\n        }\r\n      });\r\n      \r\n      expect(response.statusCode).toBe(400);\r\n      const payload = JSON.parse(response.payload);\r\n      expect(payload.error).toBe('User already exists');\r\n      expect(mockPrisma.user.create).not.toHaveBeenCalled();\r\n    });\r\n    \r\n    test('should reject registration without required fields', async () => {\r\n      const response = await app.inject({\r\n        method: 'POST',\r\n        url: '/api/v1/auth/register',\r\n        payload: {\r\n          email: 'test@example.com'\r\n          // password –∏ name –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç\r\n        }\r\n      });\r\n      \r\n      expect(response.statusCode).toBe(400);\r\n      const payload = JSON.parse(response.payload);\r\n      expect(payload.error).toBe('Email, password and name are required');\r\n    });\r\n  });\r\n  \r\n  describe('Security', () => {\r\n    test('should normalize email to lowercase', async () => {\r\n      mockPrisma.user.findFirst.mockResolvedValue({\r\n        id: '1',\r\n        email: 'test@example.com',\r\n        name: 'Test User',\r\n        roles: ['OPERATOR'],\r\n        isActive: true\r\n      });\r\n      \r\n      await app.inject({\r\n        method: 'POST',\r\n        url: '/api/v1/auth/login',\r\n        payload: {\r\n          email: 'TEST@EXAMPLE.COM',\r\n          password: 'password123'\r\n        }\r\n      });\r\n      \r\n      expect(mockPrisma.user.findFirst).toHaveBeenCalledWith({\r\n        where: { email: 'test@example.com' }\r\n      });\r\n    });\r\n    \r\n    test('should generate valid JWT token', async () => {\r\n      mockPrisma.user.findFirst.mockResolvedValue({\r\n        id: '1',\r\n        email: 'test@example.com',\r\n        name: 'Test User',\r\n        roles: ['OPERATOR'],\r\n        isActive: true\r\n      });\r\n      \r\n      const response = await app.inject({\r\n        method: 'POST',\r\n        url: '/api/v1/auth/login',\r\n        payload: {\r\n          email: 'test@example.com',\r\n          password: 'password123'\r\n        }\r\n      });\r\n      \r\n      const payload = JSON.parse(response.payload);\r\n      const token = payload.token;\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ–∫–µ–Ω –º–æ–∂–Ω–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å\r\n      const decoded = app.jwt.verify(token);\r\n      expect(decoded.id).toBe('1');\r\n      expect(decoded.email).toBe('test@example.com');\r\n      expect(decoded.roles).toEqual(['OPERATOR']);\r\n    });\r\n  });\r\n  \r\n  describe('Error Handling', () => {\r\n    test('should handle database errors gracefully', async () => {\r\n      // –ú–æ–∫–∞–µ–º –æ—à–∏–±–∫—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\r\n      mockPrisma.user.findFirst.mockRejectedValue(new Error('Database connection failed'));\r\n      \r\n      const response = await app.inject({\r\n        method: 'POST',\r\n        url: '/api/v1/auth/login',\r\n        payload: {\r\n          email: 'test@example.com',\r\n          password: 'password123'\r\n        }\r\n      });\r\n      \r\n      // –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å 500 –æ—à–∏–±–∫—É, –Ω–æ –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å –¥–µ—Ç–∞–ª–∏\r\n      expect(response.statusCode).toBe(500);\r\n    });\r\n  });\r\n});\r\n",
  "services/routes/src/index.js": "/**\r\n * VHM24 Routes Service\r\n * –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞–º–∏ –≤–æ–¥–∏—Ç–µ–ª–µ–π\r\n */\r\n\r\nconst fastify = require('fastify')({ logger: true });\r\nconst { PrismaClient } = require('@prisma/client');\r\n\r\nconst prisma = new PrismaClient();\r\n\r\n// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–ª–∞–≥–∏–Ω—ã\r\nfastify.register(require('@fastify/cors'), {\r\n  origin: true\r\n});\r\n\r\nfastify.register(require('@fastify/jwt'), {\r\n  secret: process.env.JWT_SECRET || 'your-secret-key'\r\n});\r\n\r\n// Middleware –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏\r\nfastify.decorate('authenticate', async function (request, reply) {\r\n  try {\r\n    await request.jwtVerify();\r\n  } catch (err) {\r\n    reply.send(err);\r\n  }\r\n});\r\n\r\n// –ü–æ–ª—É—á–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã\r\nfastify.get('/routes', {\r\n  preHandler: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    const { driverId, status, limit = 10, offset = 0 } = request.query;\r\n    \r\n    const where = {};\r\n    if (driverId) where.driverId = driverId;\r\n    if (status) {\r\n      if (status.includes(',')) {\r\n        where.status = { in: status.split(',') };\r\n      } else {\r\n        where.status = status;\r\n      }\r\n    }\r\n\r\n    const routes = await prisma.route.findMany({\r\n      where,\r\n      include: {\r\n        driver: {\r\n          select: { id: true, name: true, email: true }\r\n        },\r\n        stops: {\r\n          include: {\r\n            machine: {\r\n              select: { id: true, name: true, location: true }\r\n            }\r\n          },\r\n          orderBy: { order: 'asc' }\r\n        }\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n      take: parseInt(limit),\r\n      skip: parseInt(offset)\r\n    });\r\n\r\n    // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ –ø–æ–ª—è\r\n    const routesWithStats = routes.map(route => ({\r\n      ...route,\r\n      totalStops: route.stops.length,\r\n      completedStops: route.stops.filter(stop => stop.status === 'COMPLETED').length,\r\n      currentStop: route.stops.find(stop => stop.status === 'ARRIVED') || \r\n                   route.stops.find(stop => stop.status === 'PENDING')\r\n    }));\r\n\r\n    reply.send({\r\n      success: true,\r\n      data: routesWithStats,\r\n      pagination: {\r\n        limit: parseInt(limit),\r\n        offset: parseInt(offset),\r\n        total: await prisma.route.count({ where })\r\n      }\r\n    });\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.status(500).send({\r\n      success: false,\r\n      error: 'Failed to fetch routes'\r\n    });\r\n  }\r\n});\r\n\r\n// –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç\r\nfastify.get('/routes/:id', {\r\n  preHandler: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    const { id } = request.params;\r\n\r\n    const route = await prisma.route.findUnique({\r\n      where: { id },\r\n      include: {\r\n        driver: {\r\n          select: { id: true, name: true, email: true }\r\n        },\r\n        stops: {\r\n          include: {\r\n            machine: {\r\n              select: { id: true, name: true, location: true }\r\n            }\r\n          },\r\n          orderBy: { order: 'asc' }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!route) {\r\n      return reply.status(404).send({\r\n        success: false,\r\n        error: 'Route not found'\r\n      });\r\n    }\r\n\r\n    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É\r\n    const routeWithStats = {\r\n      ...route,\r\n      totalStops: route.stops.length,\r\n      completedStops: route.stops.filter(stop => stop.status === 'COMPLETED').length,\r\n      currentStop: route.stops.find(stop => stop.status === 'ARRIVED') || \r\n                   route.stops.find(stop => stop.status === 'PENDING')\r\n    };\r\n\r\n    reply.send({\r\n      success: true,\r\n      data: routeWithStats\r\n    });\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.status(500).send({\r\n      success: false,\r\n      error: 'Failed to fetch route'\r\n    });\r\n  }\r\n});\r\n\r\n// –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç\r\nfastify.post('/routes', {\r\n  preHandler: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    const { name, description, driverId, plannedDate, stops } = request.body;\r\n\r\n    // –í–∞–ª–∏–¥–∞—Ü–∏—è\r\n    if (!name || !driverId || !stops || stops.length === 0) {\r\n      return reply.status(400).send({\r\n        success: false,\r\n        error: 'Name, driverId and stops are required'\r\n      });\r\n    }\r\n\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –≤–æ–¥–∏—Ç–µ–ª—è\r\n    const driver = await prisma.user.findUnique({\r\n      where: { id: driverId }\r\n    });\r\n\r\n    if (!driver || !driver.isDriver) {\r\n      return reply.status(400).send({\r\n        success: false,\r\n        error: 'Invalid driver'\r\n      });\r\n    }\r\n\r\n    // –°–æ–∑–¥–∞–µ–º –º–∞—Ä—à—Ä—É—Ç —Å –æ—Å—Ç–∞–Ω–æ–≤–∫–∞–º–∏\r\n    const route = await prisma.route.create({\r\n      data: {\r\n        name,\r\n        description,\r\n        driverId,\r\n        plannedDate: plannedDate ? new Date(plannedDate) : null,\r\n        status: 'PLANNED',\r\n        stops: {\r\n          create: stops.map((stop, index) => ({\r\n            machineId: stop.machineId,\r\n            order: index + 1,\r\n            status: 'PENDING',\r\n            plannedTime: stop.plannedTime ? new Date(stop.plannedTime) : null,\r\n            description: stop.description\r\n          }))\r\n        }\r\n      },\r\n      include: {\r\n        driver: {\r\n          select: { id: true, name: true, email: true }\r\n        },\r\n        stops: {\r\n          include: {\r\n            machine: {\r\n              select: { id: true, name: true, location: true }\r\n            }\r\n          },\r\n          orderBy: { order: 'asc' }\r\n        }\r\n      }\r\n    });\r\n\r\n    reply.status(201).send({\r\n      success: true,\r\n      data: route\r\n    });\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.status(500).send({\r\n      success: false,\r\n      error: 'Failed to create route'\r\n    });\r\n  }\r\n});\r\n\r\n// –û–±–Ω–æ–≤–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç\r\nfastify.patch('/routes/:id', {\r\n  preHandler: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    const { id } = request.params;\r\n    const updateData = request.body;\r\n\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞\r\n    const existingRoute = await prisma.route.findUnique({\r\n      where: { id }\r\n    });\r\n\r\n    if (!existingRoute) {\r\n      return reply.status(404).send({\r\n        success: false,\r\n        error: 'Route not found'\r\n      });\r\n    }\r\n\r\n    // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç\r\n    const route = await prisma.route.update({\r\n      where: { id },\r\n      data: {\r\n        ...updateData,\r\n        updatedAt: new Date()\r\n      },\r\n      include: {\r\n        driver: {\r\n          select: { id: true, name: true, email: true }\r\n        },\r\n        stops: {\r\n          include: {\r\n            machine: {\r\n              select: { id: true, name: true, location: true }\r\n            }\r\n          },\r\n          orderBy: { order: 'asc' }\r\n        }\r\n      }\r\n    });\r\n\r\n    reply.send({\r\n      success: true,\r\n      data: route\r\n    });\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.status(500).send({\r\n      success: false,\r\n      error: 'Failed to update route'\r\n    });\r\n  }\r\n});\r\n\r\n// –ü–æ–ª—É—á–∏—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞\r\nfastify.get('/route-stops', {\r\n  preHandler: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    const { routeId, status, limit = 10, offset = 0 } = request.query;\r\n    \r\n    const where = {};\r\n    if (routeId) where.routeId = routeId;\r\n    if (status) {\r\n      if (status.includes(',')) {\r\n        where.status = { in: status.split(',') };\r\n      } else {\r\n        where.status = status;\r\n      }\r\n    }\r\n\r\n    const stops = await prisma.routeStop.findMany({\r\n      where,\r\n      include: {\r\n        route: {\r\n          select: { id: true, name: true, status: true }\r\n        },\r\n        machine: {\r\n          select: { id: true, name: true, location: true }\r\n        }\r\n      },\r\n      orderBy: [\r\n        { routeId: 'asc' },\r\n        { order: 'asc' }\r\n      ],\r\n      take: parseInt(limit),\r\n      skip: parseInt(offset)\r\n    });\r\n\r\n    reply.send({\r\n      success: true,\r\n      data: stops,\r\n      pagination: {\r\n        limit: parseInt(limit),\r\n        offset: parseInt(offset),\r\n        total: await prisma.routeStop.count({ where })\r\n      }\r\n    });\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.status(500).send({\r\n      success: false,\r\n      error: 'Failed to fetch route stops'\r\n    });\r\n  }\r\n});\r\n\r\n// –û–±–Ω–æ–≤–∏—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫—É\r\nfastify.patch('/route-stops/:id', {\r\n  preHandler: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    const { id } = request.params;\r\n    const updateData = request.body;\r\n\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏\r\n    const existingStop = await prisma.routeStop.findUnique({\r\n      where: { id }\r\n    });\r\n\r\n    if (!existingStop) {\r\n      return reply.status(404).send({\r\n        success: false,\r\n        error: 'Route stop not found'\r\n      });\r\n    }\r\n\r\n    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫—É\r\n    const stop = await prisma.routeStop.update({\r\n      where: { id },\r\n      data: {\r\n        ...updateData,\r\n        updatedAt: new Date()\r\n      },\r\n      include: {\r\n        route: {\r\n          select: { id: true, name: true, status: true }\r\n        },\r\n        machine: {\r\n          select: { id: true, name: true, location: true }\r\n        }\r\n      }\r\n    });\r\n\r\n    reply.send({\r\n      success: true,\r\n      data: stop\r\n    });\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.status(500).send({\r\n      success: false,\r\n      error: 'Failed to update route stop'\r\n    });\r\n  }\r\n});\r\n\r\n// –ü–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏ –≤–æ–¥–∏—Ç–µ–ª—è\r\nfastify.get('/driver-logs', {\r\n  preHandler: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    const { driverId, type, routeId, limit = 50, offset = 0 } = request.query;\r\n    \r\n    const where = {};\r\n    if (driverId) where.driverId = driverId;\r\n    if (type) where.type = type;\r\n    if (routeId) where.routeId = routeId;\r\n\r\n    const logs = await prisma.driverLog.findMany({\r\n      where,\r\n      include: {\r\n        driver: {\r\n          select: { id: true, name: true, email: true }\r\n        },\r\n        route: {\r\n          select: { id: true, name: true }\r\n        }\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n      take: parseInt(limit),\r\n      skip: parseInt(offset)\r\n    });\r\n\r\n    reply.send({\r\n      success: true,\r\n      data: logs,\r\n      pagination: {\r\n        limit: parseInt(limit),\r\n        offset: parseInt(offset),\r\n        total: await prisma.driverLog.count({ where })\r\n      }\r\n    });\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.status(500).send({\r\n      success: false,\r\n      error: 'Failed to fetch driver logs'\r\n    });\r\n  }\r\n});\r\n\r\n// –°–æ–∑–¥–∞—Ç—å –ª–æ–≥ –≤–æ–¥–∏—Ç–µ–ª—è\r\nfastify.post('/driver-logs', {\r\n  preHandler: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    const { type, description, driverId, routeId, mileage, latitude, longitude, photos, metadata } = request.body;\r\n\r\n    // –í–∞–ª–∏–¥–∞—Ü–∏—è\r\n    if (!type || !description) {\r\n      return reply.status(400).send({\r\n        success: false,\r\n        error: 'Type and description are required'\r\n      });\r\n    }\r\n\r\n    // –ï—Å–ª–∏ driverId –Ω–µ —É–∫–∞–∑–∞–Ω, –±–µ—Ä–µ–º –∏–∑ —Ç–æ–∫–µ–Ω–∞\r\n    const finalDriverId = driverId || request.user.id;\r\n\r\n    const log = await prisma.driverLog.create({\r\n      data: {\r\n        type,\r\n        description,\r\n        driverId: finalDriverId,\r\n        routeId,\r\n        mileage: mileage ? parseFloat(mileage) : null,\r\n        latitude: latitude ? parseFloat(latitude) : null,\r\n        longitude: longitude ? parseFloat(longitude) : null,\r\n        photos: photos || [],\r\n        metadata: metadata || {}\r\n      },\r\n      include: {\r\n        driver: {\r\n          select: { id: true, name: true, email: true }\r\n        },\r\n        route: {\r\n          select: { id: true, name: true }\r\n        }\r\n      }\r\n    });\r\n\r\n    reply.status(201).send({\r\n      success: true,\r\n      data: log\r\n    });\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.status(500).send({\r\n      success: false,\r\n      error: 'Failed to create driver log'\r\n    });\r\n  }\r\n});\r\n\r\n// Health check\r\nfastify.get('/health', async (request, reply) => {\r\n  reply.send({ status: 'ok', service: 'routes', timestamp: new Date().toISOString() });\r\n});\r\n\r\n// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞\r\nconst start = async () => {\r\n  try {\r\n    const port = process.env.PORT || 3005;\r\n    await fastify.listen({ port, host: '0.0.0.0' });\r\n    fastify.log.info(`Routes service listening on port ${port}`);\r\n  } catch (err) {\r\n    fastify.log.error(err);\r\n    process.exit(1);\r\n  }\r\n};\r\n\r\nstart();\r\n",
  "services/telegram-bot/src/fsm/states.js": "/**\r\n * VHM24 Telegram Bot FSM States\r\n * –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ —Ä–∞–±–æ—Ç—ã\r\n */\r\n\r\n// –°–æ—Å—Ç–æ—è–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏\r\nconst REGISTRATION_STATES = {\r\n  WAITING_PHONE: 'registration:waiting_phone',\r\n  WAITING_PASSWORD: 'registration:waiting_password',\r\n  WAITING_ADMIN_APPROVAL: 'registration:waiting_admin_approval',\r\n  COMPLETED: 'registration:completed'\r\n};\r\n\r\n// –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π\r\nconst DRIVER_STATES = {\r\n  WAITING_ROUTE_START: 'driver:waiting_route_start',\r\n  WAITING_MILEAGE: 'driver:waiting_mileage',\r\n  WAITING_FUEL_PHOTO: 'driver:waiting_fuel_photo',\r\n  WAITING_ARRIVAL_CONFIRMATION: 'driver:waiting_arrival_confirmation',\r\n  WAITING_GPS_LOCATION: 'driver:waiting_gps_location'\r\n};\r\n\r\n// –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∑–∞–¥–∞—á\r\nconst TASK_STATES = {\r\n  WAITING_TASK_PHOTO_BEFORE: 'task:waiting_photo_before',\r\n  WAITING_TASK_PHOTO_AFTER: 'task:waiting_photo_after',\r\n  WAITING_TASK_COMMENT: 'task:waiting_comment',\r\n  WAITING_TASK_COMPLETION: 'task:waiting_completion'\r\n};\r\n\r\n// –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Å–∫–ª–∞–¥–∞\r\nconst WAREHOUSE_STATES = {\r\n  WAITING_ITEM_SCAN: 'warehouse:waiting_item_scan',\r\n  WAITING_QUANTITY_INPUT: 'warehouse:waiting_quantity_input',\r\n  WAITING_BUNKER_PHOTO: 'warehouse:waiting_bunker_photo',\r\n  WAITING_WEIGHT_INPUT: 'warehouse:waiting_weight_input'\r\n};\r\n\r\n// –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤\r\nconst OPERATOR_STATES = {\r\n  WAITING_MACHINE_SELECTION: 'operator:waiting_machine_selection',\r\n  WAITING_BUNKER_INSTALLATION: 'operator:waiting_bunker_installation',\r\n  WAITING_REMAINS_INPUT: 'operator:waiting_remains_input',\r\n  WAITING_PROBLEM_DESCRIPTION: 'operator:waiting_problem_description'\r\n};\r\n\r\n// –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ç–µ—Ö–Ω–∏–∫–æ–≤\r\nconst TECHNICIAN_STATES = {\r\n  TECHNICIAN_MENU: 'technician:menu',\r\n  TECHNICIAN_SELECT_MACHINE: 'technician:select_machine',\r\n  TECHNICIAN_MAINTENANCE: 'technician:maintenance',\r\n  TECHNICIAN_CHECKLIST: 'technician:checklist',\r\n  TECHNICIAN_PART_REPLACEMENT: 'technician:part_replacement',\r\n  TECHNICIAN_REPORT_PROBLEM: 'technician:report_problem',\r\n  WAITING_CHECKLIST_ITEM: 'technician:waiting_checklist_item',\r\n  WAITING_PART_REPLACEMENT: 'technician:waiting_part_replacement',\r\n  WAITING_SERVICE_PHOTO: 'technician:waiting_service_photo',\r\n  WAITING_SERVICE_REPORT: 'technician:waiting_service_report'\r\n};\r\n\r\n// –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤\r\nconst REPORT_STATES = {\r\n  WAITING_REPORT_TYPE: 'report:waiting_type',\r\n  WAITING_DATE_RANGE: 'report:waiting_date_range',\r\n  WAITING_MACHINE_FILTER: 'report:waiting_machine_filter'\r\n};\r\n\r\n// –û–±—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è\r\nconst COMMON_STATES = {\r\n  IDLE: 'common:idle',\r\n  WAITING_CONFIRMATION: 'common:waiting_confirmation',\r\n  WAITING_ADMIN_ACTION: 'common:waiting_admin_action'\r\n};\r\n\r\n// –í—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è\r\nconst ALL_STATES = {\r\n  ...REGISTRATION_STATES,\r\n  ...DRIVER_STATES,\r\n  ...TASK_STATES,\r\n  ...WAREHOUSE_STATES,\r\n  ...OPERATOR_STATES,\r\n  ...TECHNICIAN_STATES,\r\n  ...REPORT_STATES,\r\n  ...COMMON_STATES\r\n};\r\n\r\n// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π\r\nconst isRegistrationState = (state) => {\r\n  return Object.values(REGISTRATION_STATES).includes(state);\r\n};\r\n\r\nconst isDriverState = (state) => {\r\n  return Object.values(DRIVER_STATES).includes(state);\r\n};\r\n\r\nconst isTaskState = (state) => {\r\n  return Object.values(TASK_STATES).includes(state);\r\n};\r\n\r\nconst isWarehouseState = (state) => {\r\n  return Object.values(WAREHOUSE_STATES).includes(state);\r\n};\r\n\r\nconst isOperatorState = (state) => {\r\n  return Object.values(OPERATOR_STATES).includes(state);\r\n};\r\n\r\nconst isTechnicianState = (state) => {\r\n  return Object.values(TECHNICIAN_STATES).includes(state);\r\n};\r\n\r\nconst isReportState = (state) => {\r\n  return Object.values(REPORT_STATES).includes(state);\r\n};\r\n\r\nmodule.exports = {\r\n  REGISTRATION_STATES,\r\n  DRIVER_STATES,\r\n  TASK_STATES,\r\n  WAREHOUSE_STATES,\r\n  OPERATOR_STATES,\r\n  TECHNICIAN_STATES,\r\n  REPORT_STATES,\r\n  COMMON_STATES,\r\n  ALL_STATES,\r\n  isRegistrationState,\r\n  isDriverState,\r\n  isTaskState,\r\n  isWarehouseState,\r\n  isOperatorState,\r\n  isTechnicianState,\r\n  isReportState\r\n};\r\n",
  "services/warehouse/src/index.js": "/**\r\n * VHM24 Warehouse Service\r\n * –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫–ª–∞–¥—Å–∫–∏–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏\r\n */\r\n\r\nconst fastify = require('fastify')({ logger: true });\r\nconst { PrismaClient } = require('@prisma/client');\r\n\r\nconst prisma = new PrismaClient();\r\n\r\n// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–ª–∞–≥–∏–Ω—ã\r\nfastify.register(require('@fastify/cors'), {\r\n  origin: true\r\n});\r\n\r\nfastify.register(require('@fastify/jwt'), {\r\n  secret: process.env.JWT_SECRET || 'your-secret-key'\r\n});\r\n\r\n// Middleware –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏\r\nfastify.decorate('authenticate', async function (request, reply) {\r\n  try {\r\n    await request.jwtVerify();\r\n  } catch (err) {\r\n    reply.send(err);\r\n  }\r\n});\r\n\r\n// –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∫–ª–∞–¥–∞\r\nfastify.get('/warehouse/stats', {\r\n  preHandler: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    const today = new Date();\r\n    today.setHours(0, 0, 0, 0);\r\n    const tomorrow = new Date(today);\r\n    tomorrow.setDate(tomorrow.getDate() + 1);\r\n\r\n    // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤\r\n    const totalItems = await prisma.inventoryItem.count();\r\n\r\n    // –¢–æ–≤–∞—Ä—ã —Å –Ω–∏–∑–∫–∏–º–∏ –æ—Å—Ç–∞—Ç–∫–∞–º–∏\r\n    const lowStock = await prisma.inventoryItem.count({\r\n      where: {\r\n        quantity: {\r\n          lte: prisma.inventoryItem.fields.minQuantity\r\n        }\r\n      }\r\n    });\r\n\r\n    // –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è\r\n    const todayReceived = await prisma.stockMovement.count({\r\n      where: {\r\n        type: 'IN',\r\n        createdAt: {\r\n          gte: today,\r\n          lt: tomorrow\r\n        }\r\n      }\r\n    });\r\n\r\n    // –û—Ç–≥—Ä—É–∂–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è\r\n    const todayShipped = await prisma.stockMovement.count({\r\n      where: {\r\n        type: 'OUT',\r\n        createdAt: {\r\n          gte: today,\r\n          lt: tomorrow\r\n        }\r\n      }\r\n    });\r\n\r\n    reply.send({\r\n      success: true,\r\n      data: {\r\n        totalItems,\r\n        lowStock,\r\n        todayReceived,\r\n        todayShipped\r\n      }\r\n    });\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.status(500).send({\r\n      success: false,\r\n      error: 'Failed to fetch warehouse stats'\r\n    });\r\n  }\r\n});\r\n\r\n// –ü–æ–ª—É—á–∏—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤\r\nfastify.get('/stock-movements', {\r\n  preHandler: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    const { type, itemId, userId, limit = 50, offset = 0 } = request.query;\r\n    \r\n    const where = {};\r\n    if (type) where.type = type;\r\n    if (itemId) where.itemId = itemId;\r\n    if (userId) where.userId = userId;\r\n\r\n    const movements = await prisma.stockMovement.findMany({\r\n      where,\r\n      include: {\r\n        item: {\r\n          select: { id: true, name: true, sku: true, unit: true }\r\n        },\r\n        user: {\r\n          select: { id: true, name: true, email: true }\r\n        }\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n      take: parseInt(limit),\r\n      skip: parseInt(offset)\r\n    });\r\n\r\n    reply.send({\r\n      success: true,\r\n      data: movements,\r\n      pagination: {\r\n        limit: parseInt(limit),\r\n        offset: parseInt(offset),\r\n        total: await prisma.stockMovement.count({ where })\r\n      }\r\n    });\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.status(500).send({\r\n      success: false,\r\n      error: 'Failed to fetch stock movements'\r\n    });\r\n  }\r\n});\r\n\r\n// –°–æ–∑–¥–∞—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞\r\nfastify.post('/stock-movements', {\r\n  preHandler: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    const { \r\n      itemId, \r\n      type, \r\n      quantity, \r\n      quantityBefore,\r\n      quantityAfter,\r\n      reason, \r\n      reference, \r\n      machineId,\r\n      metadata \r\n    } = request.body;\r\n\r\n    // –í–∞–ª–∏–¥–∞—Ü–∏—è\r\n    if (!itemId || !type || !quantity || !reason) {\r\n      return reply.status(400).send({\r\n        success: false,\r\n        error: 'ItemId, type, quantity and reason are required'\r\n      });\r\n    }\r\n\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞\r\n    const item = await prisma.inventoryItem.findUnique({\r\n      where: { id: itemId }\r\n    });\r\n\r\n    if (!item) {\r\n      return reply.status(404).send({\r\n        success: false,\r\n        error: 'Item not found'\r\n      });\r\n    }\r\n\r\n    // –°–æ–∑–¥–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏\r\n    const result = await prisma.$transaction(async (tx) => {\r\n      // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ –¥–≤–∏–∂–µ–Ω–∏–∏\r\n      const movement = await tx.stockMovement.create({\r\n        data: {\r\n          itemId,\r\n          type,\r\n          quantity: parseFloat(quantity),\r\n          quantityBefore: quantityBefore ? parseFloat(quantityBefore) : item.quantity,\r\n          quantityAfter: quantityAfter ? parseFloat(quantityAfter) : null,\r\n          reason,\r\n          reference,\r\n          userId: request.user.id,\r\n          machineId,\r\n          metadata: metadata || {}\r\n        },\r\n        include: {\r\n          item: {\r\n            select: { id: true, name: true, sku: true, unit: true }\r\n          },\r\n          user: {\r\n            select: { id: true, name: true, email: true }\r\n          }\r\n        }\r\n      });\r\n\r\n      // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–æ–∫ —Ç–æ–≤–∞—Ä–∞\r\n      let newQuantity;\r\n      if (quantityAfter !== undefined) {\r\n        newQuantity = parseFloat(quantityAfter);\r\n      } else {\r\n        newQuantity = type === 'IN' \r\n          ? item.quantity + parseFloat(quantity)\r\n          : item.quantity - parseFloat(quantity);\r\n      }\r\n\r\n      await tx.inventoryItem.update({\r\n        where: { id: itemId },\r\n        data: { \r\n          quantity: newQuantity,\r\n          updatedAt: new Date()\r\n        }\r\n      });\r\n\r\n      return { ...movement, newQuantity };\r\n    });\r\n\r\n    reply.status(201).send({\r\n      success: true,\r\n      data: result\r\n    });\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.status(500).send({\r\n      success: false,\r\n      error: 'Failed to create stock movement'\r\n    });\r\n  }\r\n});\r\n\r\n// –ü–æ–ª—É—á–∏—Ç—å —Å–∫–ª–∞–¥—Å–∫–∏–µ –ª–æ–≥–∏\r\nfastify.get('/warehouse-logs', {\r\n  preHandler: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    const { type, userId, limit = 50, offset = 0 } = request.query;\r\n    \r\n    const where = {};\r\n    if (type) where.type = type;\r\n    if (userId) where.userId = userId;\r\n\r\n    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â—É—é —Ç–∞–±–ª–∏—Ü—É –ª–æ–≥–æ–≤ –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é –¥–ª—è —Å–∫–ª–∞–¥–∞\r\n    const logs = await prisma.activityLog.findMany({\r\n      where: {\r\n        ...where,\r\n        category: 'WAREHOUSE'\r\n      },\r\n      include: {\r\n        user: {\r\n          select: { id: true, name: true, email: true }\r\n        }\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n      take: parseInt(limit),\r\n      skip: parseInt(offset)\r\n    });\r\n\r\n    reply.send({\r\n      success: true,\r\n      data: logs,\r\n      pagination: {\r\n        limit: parseInt(limit),\r\n        offset: parseInt(offset),\r\n        total: await prisma.activityLog.count({ \r\n          where: { ...where, category: 'WAREHOUSE' } \r\n        })\r\n      }\r\n    });\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.status(500).send({\r\n      success: false,\r\n      error: 'Failed to fetch warehouse logs'\r\n    });\r\n  }\r\n});\r\n\r\n// –°–æ–∑–¥–∞—Ç—å —Å–∫–ª–∞–¥—Å–∫–æ–π –ª–æ–≥\r\nfastify.post('/warehouse-logs', {\r\n  preHandler: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    const { type, description, weight, photos, metadata } = request.body;\r\n\r\n    // –í–∞–ª–∏–¥–∞—Ü–∏—è\r\n    if (!type || !description) {\r\n      return reply.status(400).send({\r\n        success: false,\r\n        error: 'Type and description are required'\r\n      });\r\n    }\r\n\r\n    const log = await prisma.activityLog.create({\r\n      data: {\r\n        category: 'WAREHOUSE',\r\n        type,\r\n        description,\r\n        userId: request.user.id,\r\n        metadata: {\r\n          ...metadata,\r\n          weight: weight ? parseFloat(weight) : null,\r\n          photos: photos || []\r\n        }\r\n      },\r\n      include: {\r\n        user: {\r\n          select: { id: true, name: true, email: true }\r\n        }\r\n      }\r\n    });\r\n\r\n    reply.status(201).send({\r\n      success: true,\r\n      data: log\r\n    });\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.status(500).send({\r\n      success: false,\r\n      error: 'Failed to create warehouse log'\r\n    });\r\n  }\r\n});\r\n\r\n// –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–≤–∞—Ä—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –±—É–Ω–∫–µ—Ä–æ–≤\r\nfastify.get('/machine-inventory', {\r\n  preHandler: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    const { machineId, needsRefill, limit = 20, offset = 0 } = request.query;\r\n    \r\n    const where = {};\r\n    if (machineId) where.machineId = machineId;\r\n    if (needsRefill === 'true') {\r\n      where.quantity = {\r\n        lte: 10 // –°—á–∏—Ç–∞–µ–º —á—Ç–æ –Ω—É–∂–Ω–∞ –¥–æ–∑–∞–ø—Ä–∞–≤–∫–∞ –µ—Å–ª–∏ –º–µ–Ω—å—à–µ 10 –µ–¥–∏–Ω–∏—Ü\r\n      };\r\n    }\r\n\r\n    const inventory = await prisma.machineInventory.findMany({\r\n      where,\r\n      include: {\r\n        machine: {\r\n          select: { id: true, name: true, location: true }\r\n        },\r\n        item: {\r\n          select: { id: true, name: true, sku: true, unit: true }\r\n        }\r\n      },\r\n      orderBy: { updatedAt: 'desc' },\r\n      take: parseInt(limit),\r\n      skip: parseInt(offset)\r\n    });\r\n\r\n    reply.send({\r\n      success: true,\r\n      data: inventory,\r\n      pagination: {\r\n        limit: parseInt(limit),\r\n        offset: parseInt(offset),\r\n        total: await prisma.machineInventory.count({ where })\r\n      }\r\n    });\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.status(500).send({\r\n      success: false,\r\n      error: 'Failed to fetch machine inventory'\r\n    });\r\n  }\r\n});\r\n\r\n// –û–±–Ω–æ–≤–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏ –≤ –±—É–Ω–∫–µ—Ä–µ\r\nfastify.patch('/machine-inventory/:id', {\r\n  preHandler: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    const { id } = request.params;\r\n    const { quantity } = request.body;\r\n\r\n    if (quantity === undefined || quantity < 0) {\r\n      return reply.status(400).send({\r\n        success: false,\r\n        error: 'Valid quantity is required'\r\n      });\r\n    }\r\n\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏\r\n    const existing = await prisma.machineInventory.findUnique({\r\n      where: { id },\r\n      include: {\r\n        machine: { select: { id: true, name: true } },\r\n        item: { select: { id: true, name: true, sku: true } }\r\n      }\r\n    });\r\n\r\n    if (!existing) {\r\n      return reply.status(404).send({\r\n        success: false,\r\n        error: 'Machine inventory record not found'\r\n      });\r\n    }\r\n\r\n    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ\r\n    const updated = await prisma.machineInventory.update({\r\n      where: { id },\r\n      data: {\r\n        quantity: parseFloat(quantity),\r\n        updatedAt: new Date()\r\n      },\r\n      include: {\r\n        machine: {\r\n          select: { id: true, name: true, location: true }\r\n        },\r\n        item: {\r\n          select: { id: true, name: true, sku: true, unit: true }\r\n        }\r\n      }\r\n    });\r\n\r\n    // –°–æ–∑–¥–∞–µ–º –ª–æ–≥ –∏–∑–º–µ–Ω–µ–Ω–∏—è\r\n    await prisma.activityLog.create({\r\n      data: {\r\n        category: 'WAREHOUSE',\r\n        type: 'INVENTORY_UPDATE',\r\n        description: `–û–±–Ω–æ–≤–ª–µ–Ω—ã –æ—Å—Ç–∞—Ç–∫–∏ ${existing.item.name} –≤ ${existing.machine.name}: ${existing.quantity} ‚Üí ${quantity}`,\r\n        userId: request.user.id,\r\n        metadata: {\r\n          machineId: existing.machineId,\r\n          itemId: existing.itemId,\r\n          oldQuantity: existing.quantity,\r\n          newQuantity: parseFloat(quantity)\r\n        }\r\n      }\r\n    });\r\n\r\n    reply.send({\r\n      success: true,\r\n      data: updated\r\n    });\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.status(500).send({\r\n      success: false,\r\n      error: 'Failed to update machine inventory'\r\n    });\r\n  }\r\n});\r\n\r\n// –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É/–Ω–∞–∑–≤–∞–Ω–∏—é\r\nfastify.get('/inventory/items', {\r\n  preHandler: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    const { sku, name, limit = 20, offset = 0 } = request.query;\r\n    \r\n    const where = {};\r\n    if (sku) {\r\n      where.sku = {\r\n        contains: sku,\r\n        mode: 'insensitive'\r\n      };\r\n    }\r\n    if (name) {\r\n      where.name = {\r\n        contains: name,\r\n        mode: 'insensitive'\r\n      };\r\n    }\r\n\r\n    const items = await prisma.inventoryItem.findMany({\r\n      where,\r\n      orderBy: { name: 'asc' },\r\n      take: parseInt(limit),\r\n      skip: parseInt(offset)\r\n    });\r\n\r\n    reply.send({\r\n      success: true,\r\n      data: items,\r\n      pagination: {\r\n        limit: parseInt(limit),\r\n        offset: parseInt(offset),\r\n        total: await prisma.inventoryItem.count({ where })\r\n      }\r\n    });\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.status(500).send({\r\n      success: false,\r\n      error: 'Failed to search items'\r\n    });\r\n  }\r\n});\r\n\r\n// Health check\r\nfastify.get('/health', async (request, reply) => {\r\n  reply.send({ status: 'ok', service: 'warehouse', timestamp: new Date().toISOString() });\r\n});\r\n\r\n// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞\r\nconst start = async () => {\r\n  try {\r\n    const port = process.env.PORT || 3006;\r\n    await fastify.listen({ port, host: '0.0.0.0' });\r\n    fastify.log.info(`Warehouse service listening on port ${port}`);\r\n  } catch (err) {\r\n    fastify.log.error(err);\r\n    process.exit(1);\r\n  }\r\n};\r\n\r\nstart();\r\n",
  "test-all-services.js": "/**\r\n * VHM24 - Test All Services\r\n * Comprehensive test script for all microservices\r\n */\r\n\r\nconst axios = require('axios');\r\nconst colors = require('colors/safe');\r\n\r\n// Configuration\r\nconst GATEWAY_URL = 'http://localhost:8000';\r\nconst AUTH_URL = 'http://localhost:3001';\r\nconst SERVICES = {\r\n  gateway: { url: GATEWAY_URL, port: 8000 },\r\n  auth: { url: AUTH_URL, port: 3001 },\r\n  machines: { url: 'http://localhost:3002', port: 3002 },\r\n  inventory: { url: 'http://localhost:3003', port: 3003 },\r\n  tasks: { url: 'http://localhost:3004', port: 3004 },\r\n  bunkers: { url: 'http://localhost:3005', port: 3005 }\r\n};\r\n\r\n// Test credentials\r\nconst TEST_USER = {\r\n  email: 'admin@vhm24.ru',\r\n  password: 'admin123'\r\n};\r\n\r\nlet authToken = null;\r\n\r\n// Helper functions\r\nfunction logSuccess(message) {\r\n  console.log(colors.green('‚úì ' + message));\r\n}\r\n\r\nfunction logError(message) {\r\n  console.log(colors.red('‚úó ' + message));\r\n}\r\n\r\nfunction logInfo(message) {\r\n  console.log(colors.blue('‚Ñπ ' + message));\r\n}\r\n\r\nfunction logSection(title) {\r\n  console.log('\\n' + colors.yellow('‚ïê'.repeat(50)));\r\n  console.log(colors.yellow(title));\r\n  console.log(colors.yellow('‚ïê'.repeat(50)));\r\n}\r\n\r\n// Test functions\r\nasync function testServiceHealth(name, service) {\r\n  try {\r\n    const response = await axios.get(`${service.url}/health`, { timeout: 5000 });\r\n    if (response.data.status === 'ok') {\r\n      logSuccess(`${name} service is healthy on port ${service.port}`);\r\n      return true;\r\n    } else {\r\n      logError(`${name} service returned unexpected status: ${response.data.status}`);\r\n      return false;\r\n    }\r\n  } catch (error) {\r\n    logError(`${name} service is not responding on port ${service.port}: ${error.message}`);\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function testGatewayHealth() {\r\n  try {\r\n    const response = await axios.get(`${GATEWAY_URL}/health`);\r\n    logSuccess('Gateway is healthy');\r\n    \r\n    // Check individual services through gateway\r\n    if (response.data.services) {\r\n      console.log('\\nService Status through Gateway:');\r\n      Object.entries(response.data.services).forEach(([service, status]) => {\r\n        if (status === 'ok') {\r\n          logSuccess(`  ${service}: ${status}`);\r\n        } else {\r\n          logError(`  ${service}: ${status}`);\r\n        }\r\n      });\r\n    }\r\n    \r\n    // Check database status\r\n    if (response.data.dbStatus) {\r\n      if (response.data.dbStatus === 'connected') {\r\n        logSuccess(`Database: ${response.data.dbStatus}`);\r\n      } else {\r\n        logError(`Database: ${response.data.dbStatus}`);\r\n      }\r\n    }\r\n    \r\n    return true;\r\n  } catch (error) {\r\n    logError(`Gateway health check failed: ${error.message}`);\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function testAuthentication() {\r\n  try {\r\n    // Test login\r\n    const loginResponse = await axios.post(`${GATEWAY_URL}/api/v1/auth/login`, TEST_USER);\r\n    \r\n    if (loginResponse.data.success && loginResponse.data.token) {\r\n      authToken = loginResponse.data.token;\r\n      logSuccess(`Authentication successful for ${TEST_USER.email}`);\r\n      logInfo(`Token received: ${authToken.substring(0, 20)}...`);\r\n      \r\n      // Test /me endpoint\r\n      const meResponse = await axios.get(`${GATEWAY_URL}/api/v1/auth/me`, {\r\n        headers: { Authorization: `Bearer ${authToken}` }\r\n      });\r\n      \r\n      if (meResponse.data.success) {\r\n        logSuccess('Auth /me endpoint working');\r\n        logInfo(`User: ${meResponse.data.data.name} (${meResponse.data.data.email})`);\r\n        logInfo(`Roles: ${meResponse.data.data.roles.join(', ')}`);\r\n      }\r\n      \r\n      return true;\r\n    } else {\r\n      logError('Authentication failed - no token received');\r\n      return false;\r\n    }\r\n  } catch (error) {\r\n    logError(`Authentication test failed: ${error.response?.data?.error || error.message}`);\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function testMachinesAPI() {\r\n  if (!authToken) {\r\n    logError('No auth token - skipping machines API test');\r\n    return false;\r\n  }\r\n  \r\n  try {\r\n    const response = await axios.get(`${GATEWAY_URL}/api/v1/machines`, {\r\n      headers: { Authorization: `Bearer ${authToken}` }\r\n    });\r\n    \r\n    if (response.data.success !== undefined) {\r\n      logSuccess('Machines API is accessible');\r\n      logInfo(`Total machines: ${response.data.data?.total || 0}`);\r\n      return true;\r\n    }\r\n  } catch (error) {\r\n    logError(`Machines API test failed: ${error.response?.data?.error || error.message}`);\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function testInventoryAPI() {\r\n  if (!authToken) {\r\n    logError('No auth token - skipping inventory API test');\r\n    return false;\r\n  }\r\n  \r\n  try {\r\n    const response = await axios.get(`${GATEWAY_URL}/api/v1/inventory/items`, {\r\n      headers: { Authorization: `Bearer ${authToken}` }\r\n    });\r\n    \r\n    if (response.data.success !== undefined) {\r\n      logSuccess('Inventory API is accessible');\r\n      logInfo(`Total items: ${response.data.data?.total || 0}`);\r\n      return true;\r\n    }\r\n  } catch (error) {\r\n    logError(`Inventory API test failed: ${error.response?.data?.error || error.message}`);\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function testTasksAPI() {\r\n  if (!authToken) {\r\n    logError('No auth token - skipping tasks API test');\r\n    return false;\r\n  }\r\n  \r\n  try {\r\n    const response = await axios.get(`${GATEWAY_URL}/api/v1/tasks`, {\r\n      headers: { Authorization: `Bearer ${authToken}` }\r\n    });\r\n    \r\n    if (response.data.success !== undefined) {\r\n      logSuccess('Tasks API is accessible');\r\n      logInfo(`Total tasks: ${response.data.data?.total || 0}`);\r\n      return true;\r\n    }\r\n  } catch (error) {\r\n    logError(`Tasks API test failed: ${error.response?.data?.error || error.message}`);\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function testBunkersAPI() {\r\n  if (!authToken) {\r\n    logError('No auth token - skipping bunkers API test');\r\n    return false;\r\n  }\r\n  \r\n  try {\r\n    const response = await axios.get(`${GATEWAY_URL}/api/v1/bunkers`, {\r\n      headers: { Authorization: `Bearer ${authToken}` }\r\n    });\r\n    \r\n    if (response.data.success !== undefined) {\r\n      logSuccess('Bunkers API is accessible');\r\n      logInfo(`Total bunkers: ${response.data.data?.total || 0}`);\r\n      \r\n      // Test critical bunkers endpoint\r\n      const criticalResponse = await axios.get(`${GATEWAY_URL}/api/v1/bunkers/critical`, {\r\n        headers: { Authorization: `Bearer ${authToken}` }\r\n      });\r\n      \r\n      if (criticalResponse.data.success) {\r\n        logSuccess('Critical bunkers endpoint working');\r\n        logInfo(`Critical bunkers: ${criticalResponse.data.data?.totalCritical || 0}`);\r\n      }\r\n      \r\n      return true;\r\n    }\r\n  } catch (error) {\r\n    logError(`Bunkers API test failed: ${error.response?.data?.error || error.message}`);\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function testDashboardStats() {\r\n  if (!authToken) {\r\n    logError('No auth token - skipping dashboard stats test');\r\n    return false;\r\n  }\r\n  \r\n  try {\r\n    const response = await axios.get(`${GATEWAY_URL}/api/v1/dashboard/stats`, {\r\n      headers: { Authorization: `Bearer ${authToken}` }\r\n    });\r\n    \r\n    if (response.data.success) {\r\n      logSuccess('Dashboard stats endpoint working');\r\n      const stats = response.data.data;\r\n      console.log('\\nDashboard Statistics:');\r\n      logInfo(`  Total Machines: ${stats.totalMachines}`);\r\n      logInfo(`  Online Machines: ${stats.onlineMachines}`);\r\n      logInfo(`  Total Tasks: ${stats.totalTasks}`);\r\n      logInfo(`  Pending Tasks: ${stats.pendingTasks}`);\r\n      logInfo(`  Total Users: ${stats.totalUsers}`);\r\n      logInfo(`  Active Users: ${stats.activeUsers}`);\r\n      logInfo(`  Inventory Items: ${stats.inventoryItems}`);\r\n      logInfo(`  Low Stock Items: ${stats.lowStockItems}`);\r\n      logInfo(`  Today's Revenue: ${stats.todayRevenue}`);\r\n      return true;\r\n    }\r\n  } catch (error) {\r\n    logError(`Dashboard stats test failed: ${error.response?.data?.error || error.message}`);\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function testWebSocket() {\r\n  // Note: This is a basic test. For full WebSocket testing, consider using a WebSocket client library\r\n  logInfo('WebSocket endpoint available at: ws://localhost:8000/ws');\r\n  logInfo('(WebSocket testing requires a WebSocket client)');\r\n  return true;\r\n}\r\n\r\n// Main test runner\r\nasync function runAllTests() {\r\n  console.log(colors.cyan('\\nüöÄ VHM24 Platform - Service Test Suite\\n'));\r\n  \r\n  let totalTests = 0;\r\n  let passedTests = 0;\r\n  \r\n  // Test individual service health\r\n  logSection('Testing Individual Services');\r\n  for (const [name, service] of Object.entries(SERVICES)) {\r\n    totalTests++;\r\n    if (await testServiceHealth(name, service)) {\r\n      passedTests++;\r\n    }\r\n  }\r\n  \r\n  // Test Gateway comprehensive health\r\n  logSection('Testing Gateway Health Check');\r\n  totalTests++;\r\n  if (await testGatewayHealth()) {\r\n    passedTests++;\r\n  }\r\n  \r\n  // Test Authentication\r\n  logSection('Testing Authentication');\r\n  totalTests++;\r\n  if (await testAuthentication()) {\r\n    passedTests++;\r\n  }\r\n  \r\n  // Test API Endpoints\r\n  logSection('Testing API Endpoints');\r\n  \r\n  totalTests++;\r\n  if (await testMachinesAPI()) {\r\n    passedTests++;\r\n  }\r\n  \r\n  totalTests++;\r\n  if (await testInventoryAPI()) {\r\n    passedTests++;\r\n  }\r\n  \r\n  totalTests++;\r\n  if (await testTasksAPI()) {\r\n    passedTests++;\r\n  }\r\n  \r\n  totalTests++;\r\n  if (await testBunkersAPI()) {\r\n    passedTests++;\r\n  }\r\n  \r\n  totalTests++;\r\n  if (await testDashboardStats()) {\r\n    passedTests++;\r\n  }\r\n  \r\n  // Test WebSocket\r\n  logSection('Testing WebSocket');\r\n  totalTests++;\r\n  if (await testWebSocket()) {\r\n    passedTests++;\r\n  }\r\n  \r\n  // Summary\r\n  logSection('Test Summary');\r\n  console.log(`\\nTotal Tests: ${totalTests}`);\r\n  console.log(colors.green(`Passed: ${passedTests}`));\r\n  console.log(colors.red(`Failed: ${totalTests - passedTests}`));\r\n  \r\n  const successRate = (passedTests / totalTests * 100).toFixed(1);\r\n  if (passedTests === totalTests) {\r\n    console.log(colors.green(`\\n‚úÖ All tests passed! (${successRate}%)`));\r\n  } else {\r\n    console.log(colors.yellow(`\\n‚ö†Ô∏è  ${successRate}% tests passed`));\r\n  }\r\n  \r\n  // Additional information\r\n  console.log('\\n' + colors.cyan('Additional Information:'));\r\n  logInfo('Default credentials: admin@vhm24.ru / admin123');\r\n  logInfo('API Documentation: http://localhost:8000/docs (if enabled)');\r\n  logInfo('MinIO Console: http://localhost:9001 (minioadmin/minioadmin)');\r\n  logInfo('Database: PostgreSQL on localhost:5432');\r\n  logInfo('Cache: Redis on localhost:6379');\r\n}\r\n\r\n// Run tests\r\nrunAllTests().catch(error => {\r\n  console.error(colors.red('\\n‚ùå Test suite failed with error:'), error);\r\n  process.exit(1);\r\n});\r\n",
  "test-audit-system.js": "#!/usr/bin/env node\r\n\r\nconst axios = require('axios');\r\nconst { PrismaClient } = require('@prisma/client');\r\n\r\nconst prisma = new PrismaClient();\r\n\r\nconsole.log('üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∞—É–¥–∏—Ç–∞ VHM24...\\n');\r\n\r\nconst AUDIT_SERVICE_URL = process.env.AUDIT_SERVICE_URL || 'http://localhost:3009';\r\nconst TEST_USER_ID = 'test-user-123';\r\nconst TEST_SESSION_ID = 'test-session-456';\r\n\r\nasync function testAuditService() {\r\n  try {\r\n    console.log('üì° –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞ –∞—É–¥–∏—Ç–∞...');\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ health endpoint\r\n    const healthResponse = await axios.get(`${AUDIT_SERVICE_URL}/health`);\r\n    console.log('‚úÖ –°–µ—Ä–≤–∏—Å –∞—É–¥–∏—Ç–∞ –¥–æ—Å—Ç—É–ø–µ–Ω:', healthResponse.data);\r\n\r\n    // –¢–µ—Å—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è\r\n    console.log('\\nüìù –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è...');\r\n    const logResponse = await axios.post(`${AUDIT_SERVICE_URL}/api/audit/log`, {\r\n      userId: TEST_USER_ID,\r\n      sessionId: TEST_SESSION_ID,\r\n      action: 'CREATE',\r\n      entity: 'TEST_ENTITY',\r\n      entityId: 'test-entity-789',\r\n      description: '–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–∏',\r\n      inputData: { name: 'Test Entity', value: 123 },\r\n      ipAddress: '127.0.0.1',\r\n      userAgent: 'Test Agent'\r\n    });\r\n    console.log('‚úÖ –î–µ–π—Å—Ç–≤–∏–µ –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–æ:', logResponse.data);\r\n\r\n    // –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–≥–æ–≤\r\n    console.log('\\nüìä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–≥–æ–≤...');\r\n    const logsResponse = await axios.get(`${AUDIT_SERVICE_URL}/api/audit/logs?limit=5`);\r\n    console.log('‚úÖ –õ–æ–≥–∏ –ø–æ–ª—É—á–µ–Ω—ã:', logsResponse.data.logs.length, '–∑–∞–ø–∏—Å–µ–π');\r\n\r\n    // –¢–µ—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏\r\n    console.log('\\nüìà –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏...');\r\n    const statsResponse = await axios.get(`${AUDIT_SERVICE_URL}/api/audit/stats/activity`);\r\n    console.log('‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞:', statsResponse.data);\r\n\r\n    // –¢–µ—Å—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö\r\n    console.log('\\nüîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö...');\r\n    const dataChangeResponse = await axios.post(`${AUDIT_SERVICE_URL}/api/audit/log-data-change`, {\r\n      entity: 'TEST_ENTITY',\r\n      entityId: 'test-entity-789',\r\n      oldData: { name: 'Old Name', value: 100 },\r\n      newData: { name: 'New Name', value: 200 },\r\n      action: 'UPDATE'\r\n    }, {\r\n      headers: {\r\n        'x-user-id': TEST_USER_ID\r\n      }\r\n    });\r\n    console.log('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω—ã:', dataChangeResponse.data);\r\n\r\n    // –¢–µ—Å—Ç –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö\r\n    console.log('\\nüìã –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...');\r\n    const incompleteDataResponse = await axios.get(`${AUDIT_SERVICE_URL}/api/incomplete-data/`);\r\n    console.log('‚úÖ –ù–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:', incompleteDataResponse.data.data.length, '–∑–∞–ø–∏—Å–µ–π');\r\n\r\n    // –¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏\r\n    console.log('\\n‚úîÔ∏è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏...');\r\n    const validationResponse = await axios.post(`${AUDIT_SERVICE_URL}/api/audit/validate`, {\r\n      entity: 'TEST_ENTITY',\r\n      entityId: 'test-entity-789',\r\n      fieldName: 'email',\r\n      fieldValue: 'test@example.com',\r\n      validationType: 'EMAIL'\r\n    }, {\r\n      headers: {\r\n        'x-user-id': TEST_USER_ID\r\n      }\r\n    });\r\n    console.log('‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞:', validationResponse.data);\r\n\r\n    // –¢–µ—Å—Ç –æ—Ç—á–µ—Ç–æ–≤\r\n    console.log('\\nüìä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤...');\r\n    const reportResponse = await axios.get(`${AUDIT_SERVICE_URL}/api/reports/system-activity`);\r\n    console.log('‚úÖ –û—Ç—á–µ—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—É—á–µ–Ω:', reportResponse.data);\r\n\r\n    console.log('\\nüéâ –í—Å–µ —Ç–µ—Å—Ç—ã —Å–∏—Å—Ç–µ–º—ã –∞—É–¥–∏—Ç–∞ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!');\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã –∞—É–¥–∏—Ç–∞:', error.message);\r\n    if (error.response) {\r\n      console.error('–°—Ç–∞—Ç—É—Å:', error.response.status);\r\n      console.error('–î–∞–Ω–Ω—ã–µ:', error.response.data);\r\n    }\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\nasync function testDatabase() {\r\n  try {\r\n    console.log('\\nüóÑÔ∏è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...');\r\n\r\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö\r\n    await prisma.$connect();\r\n    console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');\r\n\r\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü –∞—É–¥–∏—Ç–∞\r\n    const auditLogs = await prisma.systemAuditLog.findMany({\r\n      take: 1\r\n    });\r\n    console.log('‚úÖ –¢–∞–±–ª–∏—Ü–∞ SystemAuditLog –¥–æ—Å—Ç—É–ø–Ω–∞');\r\n\r\n    const incompleteLogs = await prisma.incompleteDataLog.findMany({\r\n      take: 1\r\n    });\r\n    console.log('‚úÖ –¢–∞–±–ª–∏—Ü–∞ IncompleteDataLog –¥–æ—Å—Ç—É–ø–Ω–∞');\r\n\r\n    const userSessions = await prisma.userSession.findMany({\r\n      take: 1\r\n    });\r\n    console.log('‚úÖ –¢–∞–±–ª–∏—Ü–∞ UserSession –¥–æ—Å—Ç—É–ø–Ω–∞');\r\n\r\n    const validationLogs = await prisma.dataValidationLog.findMany({\r\n      take: 1\r\n    });\r\n    console.log('‚úÖ –¢–∞–±–ª–∏—Ü–∞ DataValidationLog –¥–æ—Å—Ç—É–ø–Ω–∞');\r\n\r\n    console.log('‚úÖ –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∞—É–¥–∏—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω—ã');\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:', error.message);\r\n    process.exit(1);\r\n  } finally {\r\n    await prisma.$disconnect();\r\n  }\r\n}\r\n\r\nasync function testMiddleware() {\r\n  try {\r\n    console.log('\\nüîß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ middleware...');\r\n\r\n    const AuditMiddleware = require('./packages/shared/middleware/auditMiddleware');\r\n    const auditMiddleware = new AuditMiddleware();\r\n\r\n    // –¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ID —Å–µ—Å—Å–∏–∏\r\n    const sessionId = auditMiddleware.generateSessionId();\r\n    console.log('‚úÖ ID —Å–µ—Å—Å–∏–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω:', sessionId);\r\n\r\n    // –¢–µ—Å—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è –∏–∑ HTTP –º–µ—Ç–æ–¥–∞\r\n    const action = auditMiddleware.getActionFromMethod('POST');\r\n    console.log('‚úÖ –î–µ–π—Å—Ç–≤–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ:', action);\r\n\r\n    // –¢–µ—Å—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—É—â–Ω–æ—Å—Ç–∏ –∏–∑ URL\r\n    const entity = auditMiddleware.getEntityFromUrl('/api/users/123');\r\n    console.log('‚úÖ –°—É—â–Ω–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞:', entity);\r\n\r\n    // –¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ ID\r\n    const isValidId = auditMiddleware.isValidId('123');\r\n    console.log('‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è ID:', isValidId);\r\n\r\n    // –¢–µ—Å—Ç –æ—á–∏—Å—Ç–∫–∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö\r\n    const testData = {\r\n      name: 'Test User',\r\n      password: 'secret123',\r\n      email: 'test@example.com'\r\n    };\r\n    const sanitized = auditMiddleware.removeSensitiveFields(testData, ['password']);\r\n    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã:', sanitized);\r\n\r\n    console.log('‚úÖ Middleware —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ middleware:', error.message);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\nasync function runAllTests() {\r\n  console.log('üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –∞—É–¥–∏—Ç–∞ VHM24\\n');\r\n  \r\n  await testDatabase();\r\n  await testMiddleware();\r\n  await testAuditService();\r\n  \r\n  console.log('\\nüéä –í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!');\r\n  console.log('üìã –°–∏—Å—Ç–µ–º–∞ –∞—É–¥–∏—Ç–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é');\r\n  \r\n  process.exit(0);\r\n}\r\n\r\n// –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤\r\nrunAllTests().catch((error) => {\r\n  console.error('üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏:', error);\r\n  process.exit(1);\r\n});\r\n",
  "test-complete-system-with-notifications.js": "#!/usr/bin/env node\r\n\r\n/**\r\n * VHM24 Complete System Test with Notifications & Audit\r\n * –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã –≤–∫–ª—é—á–∞—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –∞—É–¥–∏—Ç\r\n */\r\n\r\nconst axios = require('axios');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\n// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\r\nconst config = {\r\n  baseURL: 'http://localhost:8000/api/v1',\r\n  timeout: 10000,\r\n  testUser: {\r\n    email: 'test@vhm24.com',\r\n    password: 'Test123!',\r\n    name: 'Test User',\r\n    role: 'ADMIN'\r\n  }\r\n};\r\n\r\n// –°–æ–∑–¥–∞–µ–º HTTP –∫–ª–∏–µ–Ω—Ç\r\nconst api = axios.create({\r\n  baseURL: config.baseURL,\r\n  timeout: config.timeout,\r\n  headers: {\r\n    'Content-Type': 'application/json'\r\n  }\r\n});\r\n\r\nlet authToken = null;\r\n\r\n// –¶–≤–µ—Ç–∞ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏\r\nconst colors = {\r\n  reset: '\\x1b[0m',\r\n  bright: '\\x1b[1m',\r\n  red: '\\x1b[31m',\r\n  green: '\\x1b[32m',\r\n  yellow: '\\x1b[33m',\r\n  blue: '\\x1b[34m',\r\n  magenta: '\\x1b[35m',\r\n  cyan: '\\x1b[36m'\r\n};\r\n\r\nfunction log(message, color = 'reset') {\r\n  console.log(`${colors[color]}${message}${colors.reset}`);\r\n}\r\n\r\nfunction logSuccess(message) {\r\n  log(`‚úÖ ${message}`, 'green');\r\n}\r\n\r\nfunction logError(message) {\r\n  log(`‚ùå ${message}`, 'red');\r\n}\r\n\r\nfunction logInfo(message) {\r\n  log(`‚ÑπÔ∏è  ${message}`, 'blue');\r\n}\r\n\r\nfunction logWarning(message) {\r\n  log(`‚ö†Ô∏è  ${message}`, 'yellow');\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫\r\nasync function makeRequest(method, url, data = null, headers = {}) {\r\n  try {\r\n    const requestConfig = {\r\n      method,\r\n      url,\r\n      headers: {\r\n        ...headers,\r\n        ...(authToken && { Authorization: `Bearer ${authToken}` })\r\n      }\r\n    };\r\n\r\n    if (data) {\r\n      requestConfig.data = data;\r\n    }\r\n\r\n    const response = await api(requestConfig);\r\n    return { success: true, data: response.data, status: response.status };\r\n  } catch (error) {\r\n    return {\r\n      success: false,\r\n      error: error.response?.data || error.message,\r\n      status: error.response?.status || 500\r\n    };\r\n  }\r\n}\r\n\r\n// –¢–µ—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏\r\nasync function testAuthentication() {\r\n  log('\\nüîê –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏...', 'cyan');\r\n\r\n  // –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞\r\n  const loginResult = await makeRequest('POST', '/auth/login', {\r\n    email: config.testUser.email,\r\n    password: config.testUser.password\r\n  });\r\n\r\n  if (loginResult.success && loginResult.data.data?.token) {\r\n    authToken = loginResult.data.data.token;\r\n    logSuccess('–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');\r\n    return true;\r\n  } else {\r\n    logWarning('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–ø—ã—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏...');\r\n    \r\n    // –ü–æ–ø—ã—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏\r\n    const registerResult = await makeRequest('POST', '/auth/register', config.testUser);\r\n    \r\n    if (registerResult.success) {\r\n      logSuccess('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');\r\n      \r\n      // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞\r\n      const secondLoginResult = await makeRequest('POST', '/auth/login', {\r\n        email: config.testUser.email,\r\n        password: config.testUser.password\r\n      });\r\n      \r\n      if (secondLoginResult.success && secondLoginResult.data.data?.token) {\r\n        authToken = secondLoginResult.data.data.token;\r\n        logSuccess('–í—Ö–æ–¥ –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —É—Å–ø–µ—à–µ–Ω');\r\n        return true;\r\n      }\r\n    }\r\n    \r\n    logError('–ù–µ —É–¥–∞–ª–æ—Å—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å—Å—è');\r\n    return false;\r\n  }\r\n}\r\n\r\n// –¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã –∞—É–¥–∏—Ç–∞\r\nasync function testAuditSystem() {\r\n  log('\\nüîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∞—É–¥–∏—Ç–∞...', 'cyan');\r\n\r\n  try {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–∞ –∞—É–¥–∏—Ç–∞\r\n    const healthResult = await makeRequest('GET', '/audit/health');\r\n    if (!healthResult.success) {\r\n      logWarning('–°–µ—Ä–≤–∏—Å –∞—É–¥–∏—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');\r\n      return false;\r\n    }\r\n    logSuccess('–°–µ—Ä–≤–∏—Å –∞—É–¥–∏—Ç–∞ –¥–æ—Å—Ç—É–ø–µ–Ω');\r\n\r\n    // –ü–æ–ª—É—á–∞–µ–º –ª–æ–≥–∏ –∞—É–¥–∏—Ç–∞\r\n    const logsResult = await makeRequest('GET', '/audit/logs?limit=10');\r\n    if (logsResult.success) {\r\n      logSuccess(`–ü–æ–ª—É—á–µ–Ω–æ ${logsResult.data.data?.items?.length || 0} –∑–∞–ø–∏—Å–µ–π –∞—É–¥–∏—Ç–∞`);\r\n    }\r\n\r\n    // –ü–æ–ª—É—á–∞–µ–º –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\r\n    const incompleteResult = await makeRequest('GET', '/audit/incomplete-data?limit=5');\r\n    if (incompleteResult.success) {\r\n      logSuccess(`–ù–∞–π–¥–µ–Ω–æ ${incompleteResult.data.data?.items?.length || 0} –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π`);\r\n    }\r\n\r\n    // –ü–æ–ª—É—á–∞–µ–º –æ—Ç—á–µ—Ç—ã\r\n    const reportsResult = await makeRequest('GET', '/audit/reports/summary');\r\n    if (reportsResult.success) {\r\n      logSuccess('–û—Ç—á–µ—Ç—ã –∞—É–¥–∏—Ç–∞ –ø–æ–ª—É—á–µ–Ω—ã');\r\n    }\r\n\r\n    return true;\r\n  } catch (error) {\r\n    logError(`–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞—É–¥–∏—Ç–∞: ${error.message}`);\r\n    return false;\r\n  }\r\n}\r\n\r\n// –¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\r\nasync function testNotificationSystem() {\r\n  log('\\nüîî –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π...', 'cyan');\r\n\r\n  try {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\r\n    const healthResult = await makeRequest('GET', '/notifications/health');\r\n    if (!healthResult.success) {\r\n      logWarning('–°–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');\r\n      return false;\r\n    }\r\n    logSuccess('–°–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–æ—Å—Ç—É–ø–µ–Ω');\r\n\r\n    // –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\r\n    const notificationResult = await makeRequest('POST', '/notifications/send', {\r\n      type: 'SYSTEM_ALERT',\r\n      recipients: [config.testUser.email],\r\n      data: {\r\n        alertType: 'TEST_ALERT',\r\n        message: '–¢–µ—Å—Ç–æ–≤–æ–µ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ',\r\n        timestamp: new Date().toISOString()\r\n      }\r\n    });\r\n\r\n    if (notificationResult.success) {\r\n      logSuccess('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ');\r\n    } else {\r\n      logWarning('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ');\r\n    }\r\n\r\n    // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\r\n    const statsResult = await makeRequest('GET', '/notifications/stats?period=7d');\r\n    if (statsResult.success) {\r\n      logSuccess('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—É—á–µ–Ω–∞');\r\n    }\r\n\r\n    // –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\r\n    const historyResult = await makeRequest('GET', '/notifications/history?take=5');\r\n    if (historyResult.success) {\r\n      logSuccess(`–ò—Å—Ç–æ—Ä–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: ${historyResult.data.data?.items?.length || 0} –∑–∞–ø–∏—Å–µ–π`);\r\n    }\r\n\r\n    return true;\r\n  } catch (error) {\r\n    logError(`–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: ${error.message}`);\r\n    return false;\r\n  }\r\n}\r\n\r\n// –¢–µ—Å—Ç –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤\r\nasync function testCoreServices() {\r\n  log('\\nüèóÔ∏è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤...', 'cyan');\r\n\r\n  const services = [\r\n    { name: 'Machines', endpoint: '/machines' },\r\n    { name: 'Inventory', endpoint: '/inventory' },\r\n    { name: 'Tasks', endpoint: '/tasks' },\r\n    { name: 'Routes', endpoint: '/routes' },\r\n    { name: 'Warehouse', endpoint: '/warehouse' },\r\n    { name: 'Recipes', endpoint: '/recipes' }\r\n  ];\r\n\r\n  let successCount = 0;\r\n\r\n  for (const service of services) {\r\n    const result = await makeRequest('GET', service.endpoint);\r\n    if (result.success) {\r\n      logSuccess(`${service.name} —Å–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç`);\r\n      successCount++;\r\n    } else {\r\n      logError(`${service.name} —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (${result.status})`);\r\n    }\r\n  }\r\n\r\n  logInfo(`–†–∞–±–æ—Ç–∞—é—â–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤: ${successCount}/${services.length}`);\r\n  return successCount === services.length;\r\n}\r\n\r\n// –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã–º–∏\r\nasync function testDataOperations() {\r\n  log('\\nüìä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π —Å –¥–∞–Ω–Ω—ã–º–∏...', 'cyan');\r\n\r\n  try {\r\n    // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –º–∞—à–∏–Ω—É\r\n    const machineResult = await makeRequest('POST', '/machines', {\r\n      name: 'Test Machine',\r\n      location: {\r\n        address: 'Test Address',\r\n        latitude: 41.2995,\r\n        longitude: 69.2401\r\n      },\r\n      status: 'ONLINE'\r\n    });\r\n\r\n    let machineId = null;\r\n    if (machineResult.success) {\r\n      machineId = machineResult.data.data?.id;\r\n      logSuccess('–¢–µ—Å—Ç–æ–≤–∞—è –º–∞—à–∏–Ω–∞ —Å–æ–∑–¥–∞–Ω–∞');\r\n    }\r\n\r\n    // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–¥–∞—á—É\r\n    const taskResult = await makeRequest('POST', '/tasks', {\r\n      title: 'Test Task',\r\n      description: '–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏—Å—Ç–µ–º—ã',\r\n      priority: 'MEDIUM',\r\n      dueDate: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),\r\n      machineId: machineId\r\n    });\r\n\r\n    let taskId = null;\r\n    if (taskResult.success) {\r\n      taskId = taskResult.data.data?.id;\r\n      logSuccess('–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞');\r\n    }\r\n\r\n    // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–æ–≤–∞—Ä\r\n    const inventoryResult = await makeRequest('POST', '/inventory', {\r\n      name: 'Test Item',\r\n      sku: 'TEST-001',\r\n      quantity: 100,\r\n      unit: '—à—Ç',\r\n      minQuantity: 10,\r\n      price: 1000\r\n    });\r\n\r\n    if (inventoryResult.success) {\r\n      logSuccess('–¢–µ—Å—Ç–æ–≤—ã–π —Ç–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω');\r\n    }\r\n\r\n    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–¥–∞—á—É\r\n    if (taskId) {\r\n      const updateResult = await makeRequest('PATCH', `/tasks/${taskId}`, {\r\n        status: 'IN_PROGRESS'\r\n      });\r\n      \r\n      if (updateResult.success) {\r\n        logSuccess('–ó–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');\r\n      }\r\n    }\r\n\r\n    return true;\r\n  } catch (error) {\r\n    logError(`–û—à–∏–±–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π —Å –¥–∞–Ω–Ω—ã–º–∏: ${error.message}`);\r\n    return false;\r\n  }\r\n}\r\n\r\n// –¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏\r\nasync function testServiceIntegration() {\r\n  log('\\nüîó –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤...', 'cyan');\r\n\r\n  try {\r\n    // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ —Å –æ—Å—Ç–∞–Ω–æ–≤–∫–∞–º–∏\r\n    const routeResult = await makeRequest('POST', '/routes', {\r\n      name: 'Test Route',\r\n      description: '–¢–µ—Å—Ç–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç',\r\n      status: 'PLANNED'\r\n    });\r\n\r\n    if (routeResult.success) {\r\n      logSuccess('–ú–∞—Ä—à—Ä—É—Ç —Å–æ–∑–¥–∞–Ω');\r\n      \r\n      // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –º–∞—à–∏–Ω –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞\r\n      const machinesResult = await makeRequest('GET', '/machines?limit=3');\r\n      if (machinesResult.success && machinesResult.data.data?.length > 0) {\r\n        logSuccess('–ú–∞—à–∏–Ω—ã –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞ –ø–æ–ª—É—á–µ–Ω—ã');\r\n      }\r\n    }\r\n\r\n    // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞\r\n    const recipeResult = await makeRequest('POST', '/recipes', {\r\n      name: 'Test Recipe',\r\n      description: '–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç',\r\n      ingredients: [\r\n        { name: 'Ingredient 1', quantity: 100, unit: '–≥' },\r\n        { name: 'Ingredient 2', quantity: 50, unit: '–º–ª' }\r\n      ],\r\n      instructions: '–¢–µ—Å—Ç–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏'\r\n    });\r\n\r\n    if (recipeResult.success) {\r\n      logSuccess('–†–µ—Ü–µ–ø—Ç —Å–æ–∑–¥–∞–Ω');\r\n    }\r\n\r\n    return true;\r\n  } catch (error) {\r\n    logError(`–û—à–∏–±–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤: ${error.message}`);\r\n    return false;\r\n  }\r\n}\r\n\r\n// –¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏\r\nasync function testPerformance() {\r\n  log('\\n‚ö° –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏...', 'cyan');\r\n\r\n  const tests = [\r\n    { name: 'Health Check', endpoint: '/health' },\r\n    { name: 'Machines List', endpoint: '/machines?limit=10' },\r\n    { name: 'Tasks List', endpoint: '/tasks?limit=10' },\r\n    { name: 'Audit Logs', endpoint: '/audit/logs?limit=10' }\r\n  ];\r\n\r\n  for (const test of tests) {\r\n    const startTime = Date.now();\r\n    const result = await makeRequest('GET', test.endpoint);\r\n    const endTime = Date.now();\r\n    const duration = endTime - startTime;\r\n\r\n    if (result.success) {\r\n      if (duration < 1000) {\r\n        logSuccess(`${test.name}: ${duration}ms ‚ú®`);\r\n      } else if (duration < 3000) {\r\n        logWarning(`${test.name}: ${duration}ms ‚ö†Ô∏è`);\r\n      } else {\r\n        logError(`${test.name}: ${duration}ms üêå`);\r\n      }\r\n    } else {\r\n      logError(`${test.name}: FAILED`);\r\n    }\r\n  }\r\n\r\n  return true;\r\n}\r\n\r\n// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞\r\nasync function generateReport(results) {\r\n  log('\\nüìã –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞...', 'cyan');\r\n\r\n  const report = {\r\n    timestamp: new Date().toISOString(),\r\n    summary: {\r\n      total: Object.keys(results).length,\r\n      passed: Object.values(results).filter(r => r).length,\r\n      failed: Object.values(results).filter(r => !r).length\r\n    },\r\n    details: results,\r\n    recommendations: []\r\n  };\r\n\r\n  // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\r\n  if (!results.authentication) {\r\n    report.recommendations.push('–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ —Å–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');\r\n  }\r\n  if (!results.auditSystem) {\r\n    report.recommendations.push('–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å –∞—É–¥–∏—Ç–∞ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞');\r\n  }\r\n  if (!results.notificationSystem) {\r\n    report.recommendations.push('–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤');\r\n  }\r\n  if (!results.coreServices) {\r\n    report.recommendations.push('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤');\r\n  }\r\n\r\n  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á–µ—Ç\r\n  const reportPath = path.join(__dirname, 'test-report.json');\r\n  fs.writeFileSync(reportPath, JSON.stringify(report, null, 2));\r\n\r\n  log('\\nüìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø:', 'bright');\r\n  log(`‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ: ${report.summary.passed}`, 'green');\r\n  log(`‚ùå –ü—Ä–æ–≤–∞–ª–µ–Ω–æ: ${report.summary.failed}`, 'red');\r\n  log(`üìà –£—Å–ø–µ—à–Ω–æ—Å—Ç—å: ${Math.round((report.summary.passed / report.summary.total) * 100)}%`, 'blue');\r\n  \r\n  if (report.recommendations.length > 0) {\r\n    log('\\nüí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:', 'yellow');\r\n    report.recommendations.forEach(rec => log(`   ‚Ä¢ ${rec}`, 'yellow'));\r\n  }\r\n\r\n  log(`\\nüìÑ –ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: ${reportPath}`, 'cyan');\r\n\r\n  return report;\r\n}\r\n\r\n// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\r\nasync function runTests() {\r\n  log('üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è VHM24...', 'bright');\r\n  log(`üåê –ë–∞–∑–æ–≤—ã–π URL: ${config.baseURL}`, 'blue');\r\n\r\n  const results = {};\r\n\r\n  try {\r\n    // –í—ã–ø–æ–ª–Ω—è–µ–º —Ç–µ—Å—Ç—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ\r\n    results.authentication = await testAuthentication();\r\n    results.auditSystem = await testAuditSystem();\r\n    results.notificationSystem = await testNotificationSystem();\r\n    results.coreServices = await testCoreServices();\r\n    results.dataOperations = await testDataOperations();\r\n    results.serviceIntegration = await testServiceIntegration();\r\n    results.performance = await testPerformance();\r\n\r\n    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç\r\n    const report = await generateReport(results);\r\n\r\n    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç\r\n    const overallSuccess = Object.values(results).every(result => result === true);\r\n    \r\n    if (overallSuccess) {\r\n      log('\\nüéâ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´ –£–°–ü–ï–®–ù–û!', 'green');\r\n      process.exit(0);\r\n    } else {\r\n      log('\\n‚ö†Ô∏è  –ù–ï–ö–û–¢–û–†–´–ï –¢–ï–°–¢–´ –ù–ï –ü–†–û–ô–î–ï–ù–´', 'yellow');\r\n      process.exit(1);\r\n    }\r\n\r\n  } catch (error) {\r\n    logError(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ${error.message}`);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è\r\nprocess.on('SIGINT', () => {\r\n  log('\\nüëã –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º', 'yellow');\r\n  process.exit(1);\r\n});\r\n\r\nprocess.on('unhandledRejection', (reason, promise) => {\r\n  logError(`–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: ${reason}`);\r\n  process.exit(1);\r\n});\r\n\r\n// –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤\r\nif (require.main === module) {\r\n  runTests();\r\n}\r\n\r\nmodule.exports = {\r\n  runTests,\r\n  testAuthentication,\r\n  testAuditSystem,\r\n  testNotificationSystem,\r\n  testCoreServices,\r\n  testDataOperations,\r\n  testServiceIntegration,\r\n  testPerformance\r\n};\r\n",
  "test-complete-system-with-recipes.js": "#!/usr/bin/env node\r\n\r\n/**\r\n * VHM24 Complete System Test with Recipes API\r\n * –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –≤–∫–ª—é—á–∞—è –Ω–æ–≤—ã–π Recipes API\r\n */\r\n\r\nconst axios = require('axios');\r\nconst fs = require('fs');\r\n\r\n// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è\r\nconst config = {\r\n  gateway: 'http://localhost:3000',\r\n  services: {\r\n    auth: 'http://localhost:3001',\r\n    machines: 'http://localhost:3002',\r\n    inventory: 'http://localhost:3003',\r\n    tasks: 'http://localhost:3004',\r\n    routes: 'http://localhost:3005',\r\n    warehouse: 'http://localhost:3006',\r\n    recipes: 'http://localhost:3007',\r\n    notifications: 'http://localhost:3008',\r\n    monitoring: 'http://localhost:3009',\r\n    backup: 'http://localhost:3010'\r\n  },\r\n  dashboard: 'http://localhost:3001'\r\n};\r\n\r\n// –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ\r\nconst testData = {\r\n  user: {\r\n    telegramId: '123456789',\r\n    username: 'test_user',\r\n    firstName: 'Test',\r\n    lastName: 'User',\r\n    email: 'test@vhm24.uz',\r\n    password: 'test123456',\r\n    roles: ['MANAGER']\r\n  },\r\n  recipe: {\r\n    name: '–¢–µ—Å—Ç–æ–≤—ã–π –∫–æ—Ñ–µ',\r\n    description: '–ü—Ä–æ—Å—Ç–æ–π —Ä–µ—Ü–µ–ø—Ç –∫–æ—Ñ–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∞',\r\n    category: '–ù–∞–ø–∏—Ç–∫–∏',\r\n    preparationTime: 2,\r\n    servings: 1,\r\n    instructions: '–°–º–µ—à–∞—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –∏ –ø–æ–¥–∞—Ç—å –≥–æ—Ä—è—á–∏–º',\r\n    ingredients: [\r\n      { ingredientId: 1, quantity: 15, unit: '–≥' },\r\n      { ingredientId: 2, quantity: 200, unit: '–º–ª' }\r\n    ]\r\n  },\r\n  ingredient: {\r\n    name: '–ö–æ—Ñ–µ –º–æ–ª–æ—Ç—ã–π',\r\n    category: '–ù–∞–ø–∏—Ç–∫–∏',\r\n    unit: '–≥',\r\n    costPerUnit: 2.5,\r\n    supplier: 'Coffee Supply Co',\r\n    description: '–í—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –º–æ–ª–æ—Ç—ã–π –∫–æ—Ñ–µ'\r\n  }\r\n};\r\n\r\nlet authToken = null;\r\nlet testResults = {\r\n  passed: 0,\r\n  failed: 0,\r\n  tests: []\r\n};\r\n\r\n// –£—Ç–∏–ª–∏—Ç—ã\r\nfunction log(message, type = 'info') {\r\n  const timestamp = new Date().toISOString();\r\n  const colors = {\r\n    info: '\\x1b[36m',\r\n    success: '\\x1b[32m',\r\n    error: '\\x1b[31m',\r\n    warning: '\\x1b[33m',\r\n    reset: '\\x1b[0m'\r\n  };\r\n  \r\n  console.log(`${colors[type]}[${timestamp}] ${message}${colors.reset}`);\r\n}\r\n\r\nfunction addTestResult(name, passed, message = '') {\r\n  testResults.tests.push({ name, passed, message });\r\n  if (passed) {\r\n    testResults.passed++;\r\n    log(`‚úÖ ${name}`, 'success');\r\n  } else {\r\n    testResults.failed++;\r\n    log(`‚ùå ${name}: ${message}`, 'error');\r\n  }\r\n}\r\n\r\nasync function makeRequest(url, options = {}) {\r\n  try {\r\n    const response = await axios({\r\n      url,\r\n      timeout: 10000,\r\n      ...options,\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        ...(authToken && { 'Authorization': `Bearer ${authToken}` }),\r\n        ...options.headers\r\n      }\r\n    });\r\n    return { success: true, data: response.data, status: response.status };\r\n  } catch (error) {\r\n    return {\r\n      success: false,\r\n      error: error.message,\r\n      status: error.response?.status,\r\n      data: error.response?.data\r\n    };\r\n  }\r\n}\r\n\r\n// –¢–µ—Å—Ç—ã —Å–µ—Ä–≤–∏—Å–æ–≤\r\nasync function testServiceHealth(serviceName, url) {\r\n  log(`–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞: ${serviceName}`);\r\n  \r\n  const result = await makeRequest(`${url}/health`);\r\n  \r\n  if (result.success && result.status === 200) {\r\n    addTestResult(`${serviceName} Health Check`, true);\r\n    return true;\r\n  } else {\r\n    addTestResult(`${serviceName} Health Check`, false, result.error || 'Service unavailable');\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function testAuthService() {\r\n  log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Auth Service...');\r\n  \r\n  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n  const registerResult = await makeRequest(`${config.services.auth}/api/v1/auth/register`, {\r\n    method: 'POST',\r\n    data: testData.user\r\n  });\r\n  \r\n  if (registerResult.success) {\r\n    addTestResult('User Registration', true);\r\n  } else {\r\n    addTestResult('User Registration', false, registerResult.error);\r\n  }\r\n  \r\n  // –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É\r\n  const loginResult = await makeRequest(`${config.services.auth}/api/v1/auth/login`, {\r\n    method: 'POST',\r\n    data: {\r\n      telegramId: testData.user.telegramId,\r\n      password: testData.user.password\r\n    }\r\n  });\r\n  \r\n  if (loginResult.success && loginResult.data.token) {\r\n    authToken = loginResult.data.token;\r\n    addTestResult('User Login', true);\r\n    return true;\r\n  } else {\r\n    addTestResult('User Login', false, loginResult.error);\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function testRecipesService() {\r\n  log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Recipes Service...');\r\n  \r\n  // –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞\r\n  const ingredientResult = await makeRequest(`${config.services.recipes}/api/v1/ingredients`, {\r\n    method: 'POST',\r\n    data: testData.ingredient\r\n  });\r\n  \r\n  if (ingredientResult.success) {\r\n    addTestResult('Create Ingredient', true);\r\n    \r\n    // –û–±–Ω–æ–≤–ª—è–µ–º ID –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ –≤ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö\r\n    testData.recipe.ingredients[0].ingredientId = ingredientResult.data.data.id;\r\n  } else {\r\n    addTestResult('Create Ingredient', false, ingredientResult.error);\r\n  }\r\n  \r\n  // –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ (–≤–æ–¥–∞)\r\n  const waterIngredient = {\r\n    name: '–í–æ–¥–∞',\r\n    category: '–ù–∞–ø–∏—Ç–∫–∏',\r\n    unit: '–º–ª',\r\n    costPerUnit: 0.01,\r\n    supplier: 'Water Supply',\r\n    description: '–û—á–∏—â–µ–Ω–Ω–∞—è –≤–æ–¥–∞'\r\n  };\r\n  \r\n  const waterResult = await makeRequest(`${config.services.recipes}/api/v1/ingredients`, {\r\n    method: 'POST',\r\n    data: waterIngredient\r\n  });\r\n  \r\n  if (waterResult.success) {\r\n    testData.recipe.ingredients[1].ingredientId = waterResult.data.data.id;\r\n  }\r\n  \r\n  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤\r\n  const ingredientsListResult = await makeRequest(`${config.services.recipes}/api/v1/ingredients`);\r\n  \r\n  if (ingredientsListResult.success && Array.isArray(ingredientsListResult.data.data)) {\r\n    addTestResult('Get Ingredients List', true);\r\n  } else {\r\n    addTestResult('Get Ingredients List', false, ingredientsListResult.error);\r\n  }\r\n  \r\n  // –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞\r\n  const recipeResult = await makeRequest(`${config.services.recipes}/api/v1/recipes`, {\r\n    method: 'POST',\r\n    data: testData.recipe\r\n  });\r\n  \r\n  if (recipeResult.success) {\r\n    addTestResult('Create Recipe', true);\r\n    \r\n    const recipeId = recipeResult.data.data.id;\r\n    \r\n    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞ –ø–æ ID\r\n    const getRecipeResult = await makeRequest(`${config.services.recipes}/api/v1/recipes/${recipeId}`);\r\n    \r\n    if (getRecipeResult.success) {\r\n      addTestResult('Get Recipe by ID', true);\r\n    } else {\r\n      addTestResult('Get Recipe by ID', false, getRecipeResult.error);\r\n    }\r\n    \r\n    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞\r\n    const updateData = {\r\n      name: '–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ—Ñ–µ',\r\n      description: '–û–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞'\r\n    };\r\n    \r\n    const updateResult = await makeRequest(`${config.services.recipes}/api/v1/recipes/${recipeId}`, {\r\n      method: 'PUT',\r\n      data: updateData\r\n    });\r\n    \r\n    if (updateResult.success) {\r\n      addTestResult('Update Recipe', true);\r\n    } else {\r\n      addTestResult('Update Recipe', false, updateResult.error);\r\n    }\r\n    \r\n  } else {\r\n    addTestResult('Create Recipe', false, recipeResult.error);\r\n  }\r\n  \r\n  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤\r\n  const recipesListResult = await makeRequest(`${config.services.recipes}/api/v1/recipes`);\r\n  \r\n  if (recipesListResult.success && Array.isArray(recipesListResult.data.data)) {\r\n    addTestResult('Get Recipes List', true);\r\n  } else {\r\n    addTestResult('Get Recipes List', false, recipesListResult.error);\r\n  }\r\n  \r\n  // –ü–æ–∏—Å–∫ —Ä–µ—Ü–µ–ø—Ç–æ–≤\r\n  const searchResult = await makeRequest(`${config.services.recipes}/api/v1/recipes?search=–∫–æ—Ñ–µ`);\r\n  \r\n  if (searchResult.success) {\r\n    addTestResult('Search Recipes', true);\r\n  } else {\r\n    addTestResult('Search Recipes', false, searchResult.error);\r\n  }\r\n  \r\n  // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏\r\n  const filterResult = await makeRequest(`${config.services.recipes}/api/v1/recipes?category=–ù–∞–ø–∏—Ç–∫–∏`);\r\n  \r\n  if (filterResult.success) {\r\n    addTestResult('Filter Recipes by Category', true);\r\n  } else {\r\n    addTestResult('Filter Recipes by Category', false, filterResult.error);\r\n  }\r\n  \r\n  // –†–∞—Å—á—ë—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏\r\n  const costCalculationData = {\r\n    ingredients: testData.recipe.ingredients,\r\n    servings: 1,\r\n    markup: 20\r\n  };\r\n  \r\n  const costResult = await makeRequest(`${config.services.recipes}/api/v1/cost-calculation`, {\r\n    method: 'POST',\r\n    data: costCalculationData\r\n  });\r\n  \r\n  if (costResult.success && costResult.data.data.totalCost !== undefined) {\r\n    addTestResult('Cost Calculation', true);\r\n  } else {\r\n    addTestResult('Cost Calculation', false, costResult.error);\r\n  }\r\n  \r\n  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–µ—Ü–µ–ø—Ç–æ–≤\r\n  const categoriesResult = await makeRequest(`${config.services.recipes}/api/v1/recipe-categories`);\r\n  \r\n  if (categoriesResult.success && Array.isArray(categoriesResult.data.data)) {\r\n    addTestResult('Get Recipe Categories', true);\r\n  } else {\r\n    addTestResult('Get Recipe Categories', false, categoriesResult.error);\r\n  }\r\n}\r\n\r\nasync function testMachinesService() {\r\n  log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Machines Service...');\r\n  \r\n  const result = await makeRequest(`${config.services.machines}/api/v1/machines`);\r\n  \r\n  if (result.success) {\r\n    addTestResult('Get Machines List', true);\r\n  } else {\r\n    addTestResult('Get Machines List', false, result.error);\r\n  }\r\n}\r\n\r\nasync function testInventoryService() {\r\n  log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Inventory Service...');\r\n  \r\n  const result = await makeRequest(`${config.services.inventory}/api/v1/inventory`);\r\n  \r\n  if (result.success) {\r\n    addTestResult('Get Inventory List', true);\r\n  } else {\r\n    addTestResult('Get Inventory List', false, result.error);\r\n  }\r\n}\r\n\r\nasync function testTasksService() {\r\n  log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Tasks Service...');\r\n  \r\n  const result = await makeRequest(`${config.services.tasks}/api/v1/tasks`);\r\n  \r\n  if (result.success) {\r\n    addTestResult('Get Tasks List', true);\r\n  } else {\r\n    addTestResult('Get Tasks List', false, result.error);\r\n  }\r\n}\r\n\r\nasync function testRoutesService() {\r\n  log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Routes Service...');\r\n  \r\n  const result = await makeRequest(`${config.services.routes}/api/v1/routes`);\r\n  \r\n  if (result.success) {\r\n    addTestResult('Get Routes List', true);\r\n  } else {\r\n    addTestResult('Get Routes List', false, result.error);\r\n  }\r\n}\r\n\r\nasync function testWarehouseService() {\r\n  log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Warehouse Service...');\r\n  \r\n  const result = await makeRequest(`${config.services.warehouse}/api/v1/warehouse`);\r\n  \r\n  if (result.success) {\r\n    addTestResult('Get Warehouse Data', true);\r\n  } else {\r\n    addTestResult('Get Warehouse Data', false, result.error);\r\n  }\r\n}\r\n\r\nasync function testNotificationsService() {\r\n  log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Notifications Service...');\r\n  \r\n  const result = await makeRequest(`${config.services.notifications}/api/v1/notifications`);\r\n  \r\n  if (result.success) {\r\n    addTestResult('Get Notifications', true);\r\n  } else {\r\n    addTestResult('Get Notifications', false, result.error);\r\n  }\r\n}\r\n\r\nasync function testMonitoringService() {\r\n  log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Monitoring Service...');\r\n  \r\n  const result = await makeRequest(`${config.services.monitoring}/api/v1/monitoring/status`);\r\n  \r\n  if (result.success) {\r\n    addTestResult('Get Monitoring Status', true);\r\n  } else {\r\n    addTestResult('Get Monitoring Status', false, result.error);\r\n  }\r\n}\r\n\r\nasync function testBackupService() {\r\n  log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Backup Service...');\r\n  \r\n  const result = await makeRequest(`${config.services.backup}/api/v1/backup/status`);\r\n  \r\n  if (result.success) {\r\n    addTestResult('Get Backup Status', true);\r\n  } else {\r\n    addTestResult('Get Backup Status', false, result.error);\r\n  }\r\n}\r\n\r\nasync function testGatewayIntegration() {\r\n  log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Gateway Integration...');\r\n  \r\n  // –¢–µ—Å—Ç —Ä–æ—É—Ç–∏–Ω–≥–∞ —á–µ—Ä–µ–∑ gateway\r\n  const services = ['auth', 'machines', 'recipes', 'inventory', 'tasks'];\r\n  \r\n  for (const service of services) {\r\n    const result = await makeRequest(`${config.gateway}/api/v1/${service}/health`);\r\n    \r\n    if (result.success) {\r\n      addTestResult(`Gateway ${service} routing`, true);\r\n    } else {\r\n      addTestResult(`Gateway ${service} routing`, false, result.error);\r\n    }\r\n  }\r\n}\r\n\r\nasync function testWebDashboard() {\r\n  log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Web Dashboard...');\r\n  \r\n  // –¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ dashboard\r\n  const result = await makeRequest(config.dashboard);\r\n  \r\n  if (result.success) {\r\n    addTestResult('Web Dashboard Accessibility', true);\r\n  } else {\r\n    addTestResult('Web Dashboard Accessibility', false, result.error);\r\n  }\r\n}\r\n\r\n// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\r\nasync function runCompleteSystemTest() {\r\n  log('üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã VHM24 —Å Recipes API', 'info');\r\n  log('=' * 80, 'info');\r\n  \r\n  try {\r\n    // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤\r\n    log('\\nüìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–æ–≤...', 'info');\r\n    for (const [name, url] of Object.entries(config.services)) {\r\n      await testServiceHealth(name, url);\r\n    }\r\n    \r\n    // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏\r\n    log('\\nüîê –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏...', 'info');\r\n    const authSuccess = await testAuthService();\r\n    \r\n    if (authSuccess) {\r\n      // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤\r\n      log('\\nüîß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤...', 'info');\r\n      await testMachinesService();\r\n      await testInventoryService();\r\n      await testTasksService();\r\n      await testRoutesService();\r\n      await testWarehouseService();\r\n      \r\n      // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ Recipes API\r\n      log('\\nüç≥ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Recipes API...', 'info');\r\n      await testRecipesService();\r\n      \r\n      // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤\r\n      log('\\nüì° –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤...', 'info');\r\n      await testNotificationsService();\r\n      await testMonitoringService();\r\n      await testBackupService();\r\n      \r\n      // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏\r\n      log('\\nüåê –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏...', 'info');\r\n      await testGatewayIntegration();\r\n      await testWebDashboard();\r\n    } else {\r\n      log('‚ùå –ü—Ä–æ–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏', 'error');\r\n    }\r\n    \r\n  } catch (error) {\r\n    log(`‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ${error.message}`, 'error');\r\n  }\r\n  \r\n  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞\r\n  generateTestReport();\r\n}\r\n\r\nfunction generateTestReport() {\r\n  log('\\nüìã –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...', 'info');\r\n  \r\n  const report = {\r\n    timestamp: new Date().toISOString(),\r\n    summary: {\r\n      total: testResults.passed + testResults.failed,\r\n      passed: testResults.passed,\r\n      failed: testResults.failed,\r\n      successRate: Math.round((testResults.passed / (testResults.passed + testResults.failed)) * 100)\r\n    },\r\n    tests: testResults.tests,\r\n    config: config\r\n  };\r\n  \r\n  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á—ë—Ç–∞\r\n  const reportFile = `test-report-complete-${Date.now()}.json`;\r\n  fs.writeFileSync(reportFile, JSON.stringify(report, null, 2));\r\n  \r\n  // –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤\r\n  log('\\n' + '=' * 80, 'info');\r\n  log('üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ö–û–ú–ü–õ–ï–ö–°–ù–û–ì–û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø', 'info');\r\n  log('=' * 80, 'info');\r\n  log(`‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤: ${testResults.passed}`, 'success');\r\n  log(`‚ùå –ü—Ä–æ–≤–∞–ª–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤: ${testResults.failed}`, 'error');\r\n  log(`üìà –ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞: ${report.summary.successRate}%`, 'info');\r\n  log(`üìÑ –û—Ç—á—ë—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω: ${reportFile}`, 'info');\r\n  \r\n  if (testResults.failed > 0) {\r\n    log('\\n‚ùå –ü—Ä–æ–≤–∞–ª–∏–≤—à–∏–µ—Å—è —Ç–µ—Å—Ç—ã:', 'error');\r\n    testResults.tests\r\n      .filter(test => !test.passed)\r\n      .forEach(test => log(`  ‚Ä¢ ${test.name}: ${test.message}`, 'error'));\r\n  }\r\n  \r\n  log('\\nüéâ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!', 'success');\r\n  \r\n  // –í–æ–∑–≤—Ä–∞—Ç –∫–æ–¥–∞ –≤—ã—Ö–æ–¥–∞\r\n  process.exit(testResults.failed > 0 ? 1 : 0);\r\n}\r\n\r\n// –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\r\nif (require.main === module) {\r\n  runCompleteSystemTest().catch(error => {\r\n    log(`üí• –§–∞—Ç–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞: ${error.message}`, 'error');\r\n    process.exit(1);\r\n  });\r\n}\r\n\r\nmodule.exports = {\r\n  runCompleteSystemTest,\r\n  testResults,\r\n  config\r\n};\r\n",
  "test-system-comprehensive.js": "/**\r\n * VHM24 - Comprehensive System Testing\r\n * –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã\r\n */\r\n\r\nconst axios = require('axios');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\n// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\r\nconst config = {\r\n  baseUrl: process.env.API_URL || 'http://localhost:8000',\r\n  services: {\r\n    gateway: { port: 8000, path: '/health' },\r\n    auth: { port: 3001, path: '/health' },\r\n    machines: { port: 3002, path: '/health' },\r\n    inventory: { port: 3003, path: '/health' },\r\n    tasks: { port: 3004, path: '/health' },\r\n    bunkers: { port: 3005, path: '/health' },\r\n    notifications: { port: 3006, path: '/health' },\r\n    backup: { port: 3007, path: '/health' },\r\n    monitoring: { port: 3008, path: '/health' }\r\n  },\r\n  timeout: 10000,\r\n  retries: 3\r\n};\r\n\r\n// –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\r\nconst results = {\r\n  services: {},\r\n  api: {},\r\n  database: {},\r\n  security: {},\r\n  performance: {},\r\n  integration: {},\r\n  summary: {\r\n    total: 0,\r\n    passed: 0,\r\n    failed: 0,\r\n    warnings: 0\r\n  }\r\n};\r\n\r\n// –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\r\nclass TestRunner {\r\n  constructor() {\r\n    this.startTime = Date.now();\r\n  }\r\n\r\n  log(message, type = 'info') {\r\n    const timestamp = new Date().toISOString();\r\n    const colors = {\r\n      info: '\\x1b[36m',\r\n      success: '\\x1b[32m',\r\n      warning: '\\x1b[33m',\r\n      error: '\\x1b[31m',\r\n      reset: '\\x1b[0m'\r\n    };\r\n    \r\n    console.log(`${colors[type]}[${timestamp}] ${message}${colors.reset}`);\r\n  }\r\n\r\n  async sleep(ms) {\r\n    return new Promise(resolve => setTimeout(resolve, ms));\r\n  }\r\n\r\n  async retry(fn, retries = config.retries) {\r\n    for (let i = 0; i < retries; i++) {\r\n      try {\r\n        return await fn();\r\n      } catch (error) {\r\n        if (i === retries - 1) throw error;\r\n        await this.sleep(1000 * (i + 1));\r\n      }\r\n    }\r\n  }\r\n\r\n  recordResult(category, test, status, message, data = null) {\r\n    if (!results[category]) results[category] = {};\r\n    \r\n    results[category][test] = {\r\n      status,\r\n      message,\r\n      data,\r\n      timestamp: new Date().toISOString()\r\n    };\r\n\r\n    results.summary.total++;\r\n    if (status === 'passed') results.summary.passed++;\r\n    else if (status === 'failed') results.summary.failed++;\r\n    else if (status === 'warning') results.summary.warnings++;\r\n\r\n    const statusIcon = {\r\n      passed: '‚úÖ',\r\n      failed: '‚ùå',\r\n      warning: '‚ö†Ô∏è'\r\n    };\r\n\r\n    this.log(`${statusIcon[status]} ${category}/${test}: ${message}`, \r\n             status === 'passed' ? 'success' : status === 'failed' ? 'error' : 'warning');\r\n  }\r\n}\r\n\r\n// –¢–µ—Å—Ç—ã —Å–µ—Ä–≤–∏—Å–æ–≤\r\nclass ServiceTests {\r\n  constructor(runner) {\r\n    this.runner = runner;\r\n  }\r\n\r\n  async testServiceHealth(serviceName, serviceConfig) {\r\n    try {\r\n      const url = `http://localhost:${serviceConfig.port}${serviceConfig.path}`;\r\n      const response = await this.runner.retry(async () => {\r\n        return await axios.get(url, { timeout: config.timeout });\r\n      });\r\n\r\n      if (response.status === 200) {\r\n        this.runner.recordResult('services', serviceName, 'passed', \r\n          `Service is healthy (${response.status})`, response.data);\r\n        return true;\r\n      } else {\r\n        this.runner.recordResult('services', serviceName, 'warning', \r\n          `Service responded with status ${response.status}`, response.data);\r\n        return false;\r\n      }\r\n    } catch (error) {\r\n      this.runner.recordResult('services', serviceName, 'failed', \r\n        `Service is not responding: ${error.message}`);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async testAllServices() {\r\n    this.runner.log('üîç Testing all services health...', 'info');\r\n    \r\n    const servicePromises = Object.entries(config.services).map(\r\n      ([name, config]) => this.testServiceHealth(name, config)\r\n    );\r\n\r\n    const results = await Promise.all(servicePromises);\r\n    const healthyServices = results.filter(Boolean).length;\r\n    const totalServices = Object.keys(config.services).length;\r\n\r\n    this.runner.log(`Services health: ${healthyServices}/${totalServices} healthy`, \r\n                   healthyServices === totalServices ? 'success' : 'warning');\r\n\r\n    return { healthy: healthyServices, total: totalServices };\r\n  }\r\n}\r\n\r\n// –¢–µ—Å—Ç—ã API\r\nclass ApiTests {\r\n  constructor(runner) {\r\n    this.runner = runner;\r\n    this.authToken = null;\r\n  }\r\n\r\n  async testGatewayEndpoints() {\r\n    const endpoints = [\r\n      { path: '/health', method: 'GET', auth: false },\r\n      { path: '/api/v1/test-db', method: 'GET', auth: false },\r\n      { path: '/api/v1/dashboard/stats', method: 'GET', auth: true },\r\n      { path: '/api/v1/machines', method: 'GET', auth: true },\r\n      { path: '/api/v1/machines/stats', method: 'GET', auth: true }\r\n    ];\r\n\r\n    for (const endpoint of endpoints) {\r\n      await this.testEndpoint(endpoint);\r\n    }\r\n  }\r\n\r\n  async testEndpoint({ path, method, auth }) {\r\n    try {\r\n      const url = `${config.baseUrl}${path}`;\r\n      const headers = {};\r\n      \r\n      if (auth && this.authToken) {\r\n        headers.Authorization = `Bearer ${this.authToken}`;\r\n      }\r\n\r\n      const response = await axios({\r\n        method,\r\n        url,\r\n        headers,\r\n        timeout: config.timeout,\r\n        validateStatus: () => true // –ù–µ –±—Ä–æ—Å–∞—Ç—å –æ—à–∏–±–∫—É –Ω–∞ –ª—é–±–æ–π —Å—Ç–∞—Ç—É—Å\r\n      });\r\n\r\n      if (response.status >= 200 && response.status < 300) {\r\n        this.runner.recordResult('api', `${method} ${path}`, 'passed', \r\n          `Endpoint responded successfully (${response.status})`);\r\n      } else if (response.status === 401 && auth) {\r\n        this.runner.recordResult('api', `${method} ${path}`, 'warning', \r\n          `Authentication required (${response.status})`);\r\n      } else {\r\n        this.runner.recordResult('api', `${method} ${path}`, 'failed', \r\n          `Endpoint failed (${response.status}): ${response.data?.error || 'Unknown error'}`);\r\n      }\r\n    } catch (error) {\r\n      this.runner.recordResult('api', `${method} ${path}`, 'failed', \r\n        `Request failed: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  async testAuthentication() {\r\n    try {\r\n      // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n      const testUser = {\r\n        email: `test-${Date.now()}@vhm24.test`,\r\n        password: 'TestPassword123!',\r\n        name: 'Test User',\r\n        role: 'OPERATOR'\r\n      };\r\n\r\n      const registerResponse = await axios.post(`${config.baseUrl}/api/v1/auth/register`, testUser, {\r\n        timeout: config.timeout,\r\n        validateStatus: () => true\r\n      });\r\n\r\n      if (registerResponse.status === 201 || registerResponse.status === 409) {\r\n        // 409 –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤\r\n        this.runner.recordResult('api', 'auth_register', 'passed', \r\n          `Registration test completed (${registerResponse.status})`);\r\n\r\n        // –¢–µ—Å—Ç–∏—Ä—É–µ–º –≤—Ö–æ–¥\r\n        const loginResponse = await axios.post(`${config.baseUrl}/api/v1/auth/login`, {\r\n          email: testUser.email,\r\n          password: testUser.password\r\n        }, {\r\n          timeout: config.timeout,\r\n          validateStatus: () => true\r\n        });\r\n\r\n        if (loginResponse.status === 200 && loginResponse.data.data?.token) {\r\n          this.authToken = loginResponse.data.data.token;\r\n          this.runner.recordResult('api', 'auth_login', 'passed', \r\n            'Login successful, token received');\r\n        } else {\r\n          this.runner.recordResult('api', 'auth_login', 'failed', \r\n            `Login failed (${loginResponse.status})`);\r\n        }\r\n      } else {\r\n        this.runner.recordResult('api', 'auth_register', 'failed', \r\n          `Registration failed (${registerResponse.status})`);\r\n      }\r\n    } catch (error) {\r\n      this.runner.recordResult('api', 'auth_test', 'failed', \r\n        `Authentication test failed: ${error.message}`);\r\n    }\r\n  }\r\n}\r\n\r\n// –¢–µ—Å—Ç—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\r\nclass DatabaseTests {\r\n  constructor(runner) {\r\n    this.runner = runner;\r\n  }\r\n\r\n  async testDatabaseConnection() {\r\n    try {\r\n      const response = await axios.get(`${config.baseUrl}/api/v1/test-db`, {\r\n        timeout: config.timeout\r\n      });\r\n\r\n      if (response.status === 200 && response.data.success) {\r\n        this.runner.recordResult('database', 'connection', 'passed', \r\n          'Database connection successful', response.data.data);\r\n      } else {\r\n        this.runner.recordResult('database', 'connection', 'failed', \r\n          'Database connection failed', response.data);\r\n      }\r\n    } catch (error) {\r\n      this.runner.recordResult('database', 'connection', 'failed', \r\n        `Database test failed: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  async testDatabasePerformance() {\r\n    try {\r\n      const startTime = Date.now();\r\n      \r\n      const response = await axios.get(`${config.baseUrl}/api/v1/machines/stats`, {\r\n        timeout: config.timeout\r\n      });\r\n\r\n      const responseTime = Date.now() - startTime;\r\n\r\n      if (response.status === 200) {\r\n        if (responseTime < 1000) {\r\n          this.runner.recordResult('database', 'performance', 'passed', \r\n            `Query performance good (${responseTime}ms)`);\r\n        } else if (responseTime < 3000) {\r\n          this.runner.recordResult('database', 'performance', 'warning', \r\n            `Query performance acceptable (${responseTime}ms)`);\r\n        } else {\r\n          this.runner.recordResult('database', 'performance', 'failed', \r\n            `Query performance poor (${responseTime}ms)`);\r\n        }\r\n      }\r\n    } catch (error) {\r\n      this.runner.recordResult('database', 'performance', 'failed', \r\n        `Performance test failed: ${error.message}`);\r\n    }\r\n  }\r\n}\r\n\r\n// –¢–µ—Å—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\r\nclass SecurityTests {\r\n  constructor(runner) {\r\n    this.runner = runner;\r\n  }\r\n\r\n  async testSecurityHeaders() {\r\n    try {\r\n      const response = await axios.get(`${config.baseUrl}/health`, {\r\n        timeout: config.timeout\r\n      });\r\n\r\n      const securityHeaders = [\r\n        'x-content-type-options',\r\n        'x-frame-options',\r\n        'x-xss-protection'\r\n      ];\r\n\r\n      let secureHeaders = 0;\r\n      securityHeaders.forEach(header => {\r\n        if (response.headers[header]) {\r\n          secureHeaders++;\r\n        }\r\n      });\r\n\r\n      if (secureHeaders === securityHeaders.length) {\r\n        this.runner.recordResult('security', 'headers', 'passed', \r\n          'All security headers present');\r\n      } else {\r\n        this.runner.recordResult('security', 'headers', 'warning', \r\n          `${secureHeaders}/${securityHeaders.length} security headers present`);\r\n      }\r\n    } catch (error) {\r\n      this.runner.recordResult('security', 'headers', 'failed', \r\n        `Security headers test failed: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  async testRateLimiting() {\r\n    try {\r\n      const requests = [];\r\n      const endpoint = `${config.baseUrl}/health`;\r\n\r\n      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –±—ã—Å—Ç—Ä–æ\r\n      for (let i = 0; i < 20; i++) {\r\n        requests.push(axios.get(endpoint, { \r\n          timeout: config.timeout,\r\n          validateStatus: () => true \r\n        }));\r\n      }\r\n\r\n      const responses = await Promise.all(requests);\r\n      const rateLimited = responses.some(r => r.status === 429);\r\n\r\n      if (rateLimited) {\r\n        this.runner.recordResult('security', 'rate_limiting', 'passed', \r\n          'Rate limiting is working');\r\n      } else {\r\n        this.runner.recordResult('security', 'rate_limiting', 'warning', \r\n          'Rate limiting not detected (may be configured with high limits)');\r\n      }\r\n    } catch (error) {\r\n      this.runner.recordResult('security', 'rate_limiting', 'failed', \r\n        `Rate limiting test failed: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  async testUnauthorizedAccess() {\r\n    try {\r\n      const protectedEndpoints = [\r\n        '/api/v1/dashboard/stats',\r\n        '/api/v1/machines',\r\n        '/api/v1/audit-log'\r\n      ];\r\n\r\n      let protectedCount = 0;\r\n      \r\n      for (const endpoint of protectedEndpoints) {\r\n        const response = await axios.get(`${config.baseUrl}${endpoint}`, {\r\n          timeout: config.timeout,\r\n          validateStatus: () => true\r\n        });\r\n\r\n        if (response.status === 401 || response.status === 403) {\r\n          protectedCount++;\r\n        }\r\n      }\r\n\r\n      if (protectedCount === protectedEndpoints.length) {\r\n        this.runner.recordResult('security', 'authorization', 'passed', \r\n          'All protected endpoints require authentication');\r\n      } else {\r\n        this.runner.recordResult('security', 'authorization', 'failed', \r\n          `${protectedCount}/${protectedEndpoints.length} endpoints properly protected`);\r\n      }\r\n    } catch (error) {\r\n      this.runner.recordResult('security', 'authorization', 'failed', \r\n        `Authorization test failed: ${error.message}`);\r\n    }\r\n  }\r\n}\r\n\r\n// –¢–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏\r\nclass PerformanceTests {\r\n  constructor(runner) {\r\n    this.runner = runner;\r\n  }\r\n\r\n  async testResponseTimes() {\r\n    const endpoints = [\r\n      { path: '/health', name: 'health_check' },\r\n      { path: '/api/v1/test-db', name: 'database_test' }\r\n    ];\r\n\r\n    for (const endpoint of endpoints) {\r\n      await this.testEndpointPerformance(endpoint);\r\n    }\r\n  }\r\n\r\n  async testEndpointPerformance({ path, name }) {\r\n    try {\r\n      const measurements = [];\r\n      const iterations = 5;\r\n\r\n      for (let i = 0; i < iterations; i++) {\r\n        const startTime = Date.now();\r\n        \r\n        const response = await axios.get(`${config.baseUrl}${path}`, {\r\n          timeout: config.timeout\r\n        });\r\n\r\n        const responseTime = Date.now() - startTime;\r\n        \r\n        if (response.status === 200) {\r\n          measurements.push(responseTime);\r\n        }\r\n\r\n        await this.runner.sleep(100); // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏\r\n      }\r\n\r\n      if (measurements.length > 0) {\r\n        const avgTime = measurements.reduce((a, b) => a + b, 0) / measurements.length;\r\n        const maxTime = Math.max(...measurements);\r\n\r\n        if (avgTime < 500) {\r\n          this.runner.recordResult('performance', name, 'passed', \r\n            `Good performance: avg ${avgTime.toFixed(0)}ms, max ${maxTime}ms`);\r\n        } else if (avgTime < 1000) {\r\n          this.runner.recordResult('performance', name, 'warning', \r\n            `Acceptable performance: avg ${avgTime.toFixed(0)}ms, max ${maxTime}ms`);\r\n        } else {\r\n          this.runner.recordResult('performance', name, 'failed', \r\n            `Poor performance: avg ${avgTime.toFixed(0)}ms, max ${maxTime}ms`);\r\n        }\r\n      }\r\n    } catch (error) {\r\n      this.runner.recordResult('performance', name, 'failed', \r\n        `Performance test failed: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  async testConcurrentRequests() {\r\n    try {\r\n      const concurrentRequests = 10;\r\n      const endpoint = `${config.baseUrl}/health`;\r\n      \r\n      const startTime = Date.now();\r\n      \r\n      const requests = Array(concurrentRequests).fill().map(() => \r\n        axios.get(endpoint, { timeout: config.timeout })\r\n      );\r\n\r\n      const responses = await Promise.all(requests);\r\n      const totalTime = Date.now() - startTime;\r\n      \r\n      const successfulRequests = responses.filter(r => r.status === 200).length;\r\n\r\n      if (successfulRequests === concurrentRequests && totalTime < 2000) {\r\n        this.runner.recordResult('performance', 'concurrent_requests', 'passed', \r\n          `Handled ${concurrentRequests} concurrent requests in ${totalTime}ms`);\r\n      } else if (successfulRequests === concurrentRequests) {\r\n        this.runner.recordResult('performance', 'concurrent_requests', 'warning', \r\n          `Handled ${concurrentRequests} concurrent requests in ${totalTime}ms (slow)`);\r\n      } else {\r\n        this.runner.recordResult('performance', 'concurrent_requests', 'failed', \r\n          `Only ${successfulRequests}/${concurrentRequests} requests succeeded`);\r\n      }\r\n    } catch (error) {\r\n      this.runner.recordResult('performance', 'concurrent_requests', 'failed', \r\n        `Concurrent requests test failed: ${error.message}`);\r\n    }\r\n  }\r\n}\r\n\r\n// –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã\r\nclass IntegrationTests {\r\n  constructor(runner) {\r\n    this.runner = runner;\r\n  }\r\n\r\n  async testServiceCommunication() {\r\n    try {\r\n      // –¢–µ—Å—Ç–∏—Ä—É–µ–º, —á—Ç–æ gateway –º–æ–∂–µ—Ç –æ–±—â–∞—Ç—å—Å—è —Å –¥—Ä—É–≥–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏\r\n      const response = await axios.get(`${config.baseUrl}/api/v1/dashboard/stats`, {\r\n        timeout: config.timeout,\r\n        validateStatus: () => true\r\n      });\r\n\r\n      // –î–∞–∂–µ –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, —Å–µ—Ä–≤–∏—Å—ã –¥–æ–ª–∂–Ω—ã –æ—Ç–≤–µ—á–∞—Ç—å\r\n      if (response.status === 401 || response.status === 200) {\r\n        this.runner.recordResult('integration', 'service_communication', 'passed', \r\n          'Gateway can communicate with backend services');\r\n      } else {\r\n        this.runner.recordResult('integration', 'service_communication', 'failed', \r\n          `Service communication failed (${response.status})`);\r\n      }\r\n    } catch (error) {\r\n      this.runner.recordResult('integration', 'service_communication', 'failed', \r\n        `Service communication test failed: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  async testWebSocketConnection() {\r\n    // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ WebSocket endpoint\r\n    try {\r\n      const response = await axios.get(`${config.baseUrl}/health`, {\r\n        timeout: config.timeout\r\n      });\r\n\r\n      if (response.status === 200) {\r\n        this.runner.recordResult('integration', 'websocket_availability', 'passed', \r\n          'WebSocket endpoint should be available (gateway is running)');\r\n      }\r\n    } catch (error) {\r\n      this.runner.recordResult('integration', 'websocket_availability', 'failed', \r\n        'WebSocket endpoint not available');\r\n    }\r\n  }\r\n}\r\n\r\n// –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\r\nasync function runComprehensiveTests() {\r\n  const runner = new TestRunner();\r\n  \r\n  runner.log('üöÄ Starting VHM24 Comprehensive System Tests', 'info');\r\n  runner.log('=' .repeat(60), 'info');\r\n\r\n  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã\r\n  const serviceTests = new ServiceTests(runner);\r\n  const apiTests = new ApiTests(runner);\r\n  const databaseTests = new DatabaseTests(runner);\r\n  const securityTests = new SecurityTests(runner);\r\n  const performanceTests = new PerformanceTests(runner);\r\n  const integrationTests = new IntegrationTests(runner);\r\n\r\n  try {\r\n    // 1. –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å—ã\r\n    runner.log('\\nüìã Phase 1: Service Health Tests', 'info');\r\n    await serviceTests.testAllServices();\r\n\r\n    // 2. –¢–µ—Å—Ç–∏—Ä—É–µ–º API\r\n    runner.log('\\nüîå Phase 2: API Tests', 'info');\r\n    await apiTests.testAuthentication();\r\n    await apiTests.testGatewayEndpoints();\r\n\r\n    // 3. –¢–µ—Å—Ç–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\r\n    runner.log('\\nüóÑÔ∏è  Phase 3: Database Tests', 'info');\r\n    await databaseTests.testDatabaseConnection();\r\n    await databaseTests.testDatabasePerformance();\r\n\r\n    // 4. –¢–µ—Å—Ç–∏—Ä—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å\r\n    runner.log('\\nüõ°Ô∏è  Phase 4: Security Tests', 'info');\r\n    await securityTests.testSecurityHeaders();\r\n    await securityTests.testRateLimiting();\r\n    await securityTests.testUnauthorizedAccess();\r\n\r\n    // 5. –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å\r\n    runner.log('\\n‚ö° Phase 5: Performance Tests', 'info');\r\n    await performanceTests.testResponseTimes();\r\n    await performanceTests.testConcurrentRequests();\r\n\r\n    // 6. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã\r\n    runner.log('\\nüîó Phase 6: Integration Tests', 'info');\r\n    await integrationTests.testServiceCommunication();\r\n    await integrationTests.testWebSocketConnection();\r\n\r\n  } catch (error) {\r\n    runner.log(`‚ùå Critical error during testing: ${error.message}`, 'error');\r\n  }\r\n\r\n  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç\r\n  await generateTestReport(runner);\r\n}\r\n\r\nasync function generateTestReport(runner) {\r\n  const totalTime = Date.now() - runner.startTime;\r\n  \r\n  runner.log('\\nüìä Test Results Summary', 'info');\r\n  runner.log('=' .repeat(60), 'info');\r\n  \r\n  const { total, passed, failed, warnings } = results.summary;\r\n  const successRate = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;\r\n  \r\n  runner.log(`Total Tests: ${total}`, 'info');\r\n  runner.log(`‚úÖ Passed: ${passed}`, 'success');\r\n  runner.log(`‚ùå Failed: ${failed}`, failed > 0 ? 'error' : 'info');\r\n  runner.log(`‚ö†Ô∏è  Warnings: ${warnings}`, warnings > 0 ? 'warning' : 'info');\r\n  runner.log(`üìà Success Rate: ${successRate}%`, successRate >= 80 ? 'success' : 'warning');\r\n  runner.log(`‚è±Ô∏è  Total Time: ${(totalTime / 1000).toFixed(1)}s`, 'info');\r\n\r\n  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç\r\n  const reportData = {\r\n    summary: {\r\n      ...results.summary,\r\n      successRate: parseFloat(successRate),\r\n      totalTime: totalTime,\r\n      timestamp: new Date().toISOString()\r\n    },\r\n    results: results,\r\n    environment: {\r\n      nodeVersion: process.version,\r\n      platform: process.platform,\r\n      baseUrl: config.baseUrl\r\n    }\r\n  };\r\n\r\n  const reportPath = path.join(__dirname, `test-report-${Date.now()}.json`);\r\n  fs.writeFileSync(reportPath, JSON.stringify(reportData, null, 2));\r\n  \r\n  runner.log(`\\nüìÑ Detailed report saved to: ${reportPath}`, 'info');\r\n\r\n  // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\r\n  runner.log('\\nüí° Recommendations:', 'info');\r\n  \r\n  if (failed > 0) {\r\n    runner.log('‚Ä¢ Fix failed tests before deployment', 'warning');\r\n  }\r\n  \r\n  if (warnings > 0) {\r\n    runner.log('‚Ä¢ Review warnings for potential improvements', 'warning');\r\n  }\r\n  \r\n  if (successRate >= 95) {\r\n    runner.log('‚Ä¢ System is ready for production! üéâ', 'success');\r\n  } else if (successRate >= 80) {\r\n    runner.log('‚Ä¢ System is mostly stable, address remaining issues', 'warning');\r\n  } else {\r\n    runner.log('‚Ä¢ System needs significant improvements before production', 'error');\r\n  }\r\n\r\n  runner.log('\\nüèÅ Testing completed!', 'info');\r\n  \r\n  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–¥ –≤—ã—Ö–æ–¥–∞ –¥–ª—è CI/CD\r\n  process.exit(failed > 0 ? 1 : 0);\r\n}\r\n\r\n// –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã\r\nif (require.main === module) {\r\n  runComprehensiveTests().catch(error => {\r\n    console.error('‚ùå Test runner failed:', error);\r\n    process.exit(1);\r\n  });\r\n}\r\n\r\nmodule.exports = {\r\n  runComprehensiveTests,\r\n  TestRunner,\r\n  ServiceTests,\r\n  ApiTests,\r\n  DatabaseTests,\r\n  SecurityTests,\r\n  PerformanceTests,\r\n  IntegrationTests\r\n};\r\n",
  "packages/shared/middleware/auditMiddleware.js": "const axios = require('axios');\r\n\r\n/**\r\n * Middleware –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\r\n */\r\nclass AuditMiddleware {\r\n  constructor(auditServiceUrl = process.env.AUDIT_SERVICE_URL || 'http://localhost:3009') {\r\n    this.auditServiceUrl = auditServiceUrl;\r\n  }\r\n\r\n  /**\r\n   * Middleware –¥–ª—è Fastify\r\n   */\r\n  fastifyMiddleware() {\r\n    return async (request, reply) => {\r\n      const startTime = Date.now();\r\n      \r\n      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–µ—Å—Å–∏–∏ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç\r\n      if (!request.headers['x-session-id']) {\r\n        request.headers['x-session-id'] = this.generateSessionId();\r\n      }\r\n\r\n      // –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å\r\n      await this.logRequest(request);\r\n\r\n      // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç\r\n      reply.addHook('onSend', async (request, reply, payload) => {\r\n        const responseTime = Date.now() - startTime;\r\n        await this.logResponse(request, reply, responseTime);\r\n        return payload;\r\n      });\r\n    };\r\n  }\r\n\r\n  /**\r\n   * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞\r\n   */\r\n  async logRequest(request) {\r\n    try {\r\n      const logData = {\r\n        userId: request.user?.id || null,\r\n        sessionId: request.headers['x-session-id'],\r\n        action: this.getActionFromMethod(request.method),\r\n        entity: this.getEntityFromUrl(request.url),\r\n        entityId: this.getEntityIdFromUrl(request.url),\r\n        description: `${request.method} ${request.url}`,\r\n        inputData: this.sanitizeInputData(request),\r\n        ipAddress: request.ip,\r\n        userAgent: request.headers['user-agent'],\r\n        endpoint: request.url,\r\n        method: request.method\r\n      };\r\n\r\n      await this.sendToAuditService('/api/audit/log', logData);\r\n    } catch (error) {\r\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞\r\n   */\r\n  async logResponse(request, reply, responseTime) {\r\n    try {\r\n      const logData = {\r\n        userId: request.user?.id || null,\r\n        sessionId: request.headers['x-session-id'],\r\n        action: 'INFO',\r\n        entity: 'API_RESPONSE',\r\n        description: `Response for ${request.method} ${request.url}`,\r\n        metadata: {\r\n          statusCode: reply.statusCode,\r\n          responseTime\r\n        },\r\n        ipAddress: request.ip,\r\n        userAgent: request.headers['user-agent'],\r\n        endpoint: request.url,\r\n        method: request.method,\r\n        statusCode: reply.statusCode,\r\n        responseTime\r\n      };\r\n\r\n      await this.sendToAuditService('/api/audit/log', logData);\r\n    } catch (error) {\r\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö\r\n   */\r\n  async logDataChange(userId, entity, entityId, oldData, newData, action = 'UPDATE') {\r\n    try {\r\n      const logData = {\r\n        entity,\r\n        entityId,\r\n        oldData,\r\n        newData,\r\n        action\r\n      };\r\n\r\n      await this.sendToAuditService('/api/audit/log-data-change', logData, {\r\n        'Authorization': `Bearer ${this.getUserToken(userId)}`,\r\n        'x-user-id': userId\r\n      });\r\n    } catch (error) {\r\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n   */\r\n  async logUserLogin(userId, sessionId, ipAddress, userAgent) {\r\n    try {\r\n      const logData = {\r\n        sessionId\r\n      };\r\n\r\n      await this.sendToAuditService('/api/audit/log-login', logData, {\r\n        'Authorization': `Bearer ${this.getUserToken(userId)}`,\r\n        'x-user-id': userId,\r\n        'x-forwarded-for': ipAddress,\r\n        'user-agent': userAgent\r\n      });\r\n    } catch (error) {\r\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ –≤—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n   */\r\n  async logUserLogout(userId, sessionId) {\r\n    try {\r\n      const logData = {\r\n        sessionId\r\n      };\r\n\r\n      await this.sendToAuditService('/api/audit/log-logout', logData, {\r\n        'Authorization': `Bearer ${this.getUserToken(userId)}`,\r\n        'x-user-id': userId\r\n      });\r\n    } catch (error) {\r\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ –≤—ã—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö\r\n   */\r\n  async validateField(userId, entity, entityId, fieldName, fieldValue, validationType) {\r\n    try {\r\n      const validationData = {\r\n        entity,\r\n        entityId,\r\n        fieldName,\r\n        fieldValue,\r\n        validationType\r\n      };\r\n\r\n      const response = await this.sendToAuditService('/api/audit/validate', validationData, {\r\n        'Authorization': `Bearer ${this.getUserToken(userId)}`,\r\n        'x-user-id': userId\r\n      });\r\n\r\n      return response.data;\r\n    } catch (error) {\r\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö:', error);\r\n      return { isValid: false, errorMessage: '–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏' };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –∏–∑ HTTP –º–µ—Ç–æ–¥–∞\r\n   */\r\n  getActionFromMethod(method) {\r\n    const methodMap = {\r\n      'GET': 'READ',\r\n      'POST': 'CREATE',\r\n      'PUT': 'UPDATE',\r\n      'PATCH': 'UPDATE',\r\n      'DELETE': 'DELETE'\r\n    };\r\n    return methodMap[method] || 'READ';\r\n  }\r\n\r\n  /**\r\n   * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–∏ –∏–∑ URL\r\n   */\r\n  getEntityFromUrl(url) {\r\n    const pathParts = url.split('/').filter(part => part && !part.includes('?'));\r\n    \r\n    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º /api –∏ –±–µ—Ä–µ–º —Å–ª–µ–¥—É—é—â—É—é —á–∞—Å—Ç—å –∫–∞–∫ —Å—É—â–Ω–æ—Å—Ç—å\r\n    const apiIndex = pathParts.indexOf('api');\r\n    if (apiIndex !== -1 && pathParts.length > apiIndex + 1) {\r\n      return pathParts[apiIndex + 1].toUpperCase();\r\n    }\r\n    \r\n    // –ï—Å–ª–∏ –Ω–µ—Ç /api, –±–µ—Ä–µ–º –ø–µ—Ä–≤—É—é —á–∞—Å—Ç—å\r\n    return pathParts[0] ? pathParts[0].toUpperCase() : 'UNKNOWN';\r\n  }\r\n\r\n  /**\r\n   * –ü–æ–ª—É—á–µ–Ω–∏–µ ID —Å—É—â–Ω–æ—Å—Ç–∏ –∏–∑ URL\r\n   */\r\n  getEntityIdFromUrl(url) {\r\n    const pathParts = url.split('/').filter(part => part && !part.includes('?'));\r\n    \r\n    // –ò—â–µ–º UUID –∏–ª–∏ —á–∏—Å–ª–æ–≤–æ–π ID –≤ URL\r\n    for (const part of pathParts) {\r\n      if (this.isValidId(part)) {\r\n        return part;\r\n      }\r\n    }\r\n    \r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ ID\r\n   */\r\n  isValidId(str) {\r\n    // UUID pattern\r\n    const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;\r\n    // –ß–∏—Å–ª–æ–≤–æ–π ID\r\n    const numericPattern = /^\\d+$/;\r\n    // CUID pattern\r\n    const cuidPattern = /^c[a-z0-9]{24}$/i;\r\n    \r\n    return uuidPattern.test(str) || numericPattern.test(str) || cuidPattern.test(str);\r\n  }\r\n\r\n  /**\r\n   * –û—á–∏—Å—Ç–∫–∞ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏\r\n   */\r\n  sanitizeInputData(request) {\r\n    const sensitiveFields = ['password', 'passwordHash', 'token', 'secret', 'key'];\r\n    const data = {\r\n      params: request.params,\r\n      query: request.query,\r\n      body: request.method !== 'GET' ? request.body : undefined\r\n    };\r\n\r\n    return this.removeSensitiveFields(data, sensitiveFields);\r\n  }\r\n\r\n  /**\r\n   * –£–¥–∞–ª–µ–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –∏–∑ –æ–±—ä–µ–∫—Ç–∞\r\n   */\r\n  removeSensitiveFields(obj, sensitiveFields) {\r\n    if (!obj || typeof obj !== 'object') {\r\n      return obj;\r\n    }\r\n\r\n    const cleaned = Array.isArray(obj) ? [] : {};\r\n\r\n    for (const [key, value] of Object.entries(obj)) {\r\n      if (sensitiveFields.some(field => key.toLowerCase().includes(field.toLowerCase()))) {\r\n        cleaned[key] = '[REDACTED]';\r\n      } else if (typeof value === 'object' && value !== null) {\r\n        cleaned[key] = this.removeSensitiveFields(value, sensitiveFields);\r\n      } else {\r\n        cleaned[key] = value;\r\n      }\r\n    }\r\n\r\n    return cleaned;\r\n  }\r\n\r\n  /**\r\n   * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID —Å–µ—Å—Å–∏–∏\r\n   */\r\n  generateSessionId() {\r\n    return 'sess_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();\r\n  }\r\n\r\n  /**\r\n   * –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∑–∞–≥–ª—É—à–∫–∞)\r\n   */\r\n  getUserToken(userId) {\r\n    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞\r\n    return process.env.AUDIT_SERVICE_TOKEN || 'audit-service-token';\r\n  }\r\n\r\n  /**\r\n   * –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Å–µ—Ä–≤–∏—Å –∞—É–¥–∏—Ç–∞\r\n   */\r\n  async sendToAuditService(endpoint, data, headers = {}) {\r\n    try {\r\n      const response = await axios.post(`${this.auditServiceUrl}${endpoint}`, data, {\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          ...headers\r\n        },\r\n        timeout: 5000 // 5 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç\r\n      });\r\n      \r\n      return response;\r\n    } catch (error) {\r\n      // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –ª–æ–≥–∏–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∞—É–¥–∏—Ç–∞\r\n      console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —Å–µ—Ä–≤–∏—Å –∞—É–¥–∏—Ç–∞ (${endpoint}):`, error.message);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –°–æ–∑–¥–∞–Ω–∏–µ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è CRUD –æ–ø–µ—Ä–∞—Ü–∏–π\r\n   */\r\n  createCrudLogger(entity) {\r\n    return {\r\n      /**\r\n       * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è\r\n       */\r\n      logCreate: async (userId, entityId, data) => {\r\n        await this.logDataChange(userId, entity, entityId, null, data, 'CREATE');\r\n      },\r\n\r\n      /**\r\n       * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\r\n       */\r\n      logUpdate: async (userId, entityId, oldData, newData) => {\r\n        await this.logDataChange(userId, entity, entityId, oldData, newData, 'UPDATE');\r\n      },\r\n\r\n      /**\r\n       * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è\r\n       */\r\n      logDelete: async (userId, entityId, data) => {\r\n        await this.logDataChange(userId, entity, entityId, data, null, 'DELETE');\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Middleware –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π\r\n   */\r\n  createValidationMiddleware(entity, requiredFields) {\r\n    return async (request, reply) => {\r\n      if (!request.user?.id) {\r\n        return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–ª—è –Ω–µ–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\r\n      }\r\n\r\n      const data = request.body;\r\n      const entityId = request.params?.id || 'new';\r\n\r\n      for (const field of requiredFields) {\r\n        const value = data?.[field];\r\n        const validation = await this.validateField(\r\n          request.user.id,\r\n          entity,\r\n          entityId,\r\n          field,\r\n          value,\r\n          'REQUIRED'\r\n        );\r\n\r\n        if (!validation.isValid) {\r\n          reply.code(400).send({\r\n            error: 'Validation failed',\r\n            field,\r\n            message: validation.errorMessage\r\n          });\r\n          return;\r\n        }\r\n      }\r\n    };\r\n  }\r\n}\r\n\r\nmodule.exports = AuditMiddleware;\r\n",
  "packages/shared/middleware/validation.js": "/**\r\n * VHM24 Validation Middleware\r\n * JSON Schema –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è –≤—Å–µ—Ö endpoints\r\n */\r\n\r\nconst Ajv = require('ajv');\r\nconst addFormats = require('ajv-formats');\r\nconst { sanitizeInput } = require('../../shared-types/src/security');\r\n\r\n// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä AJV —Å —Ñ–æ—Ä–º–∞—Ç–∞–º–∏\r\nconst ajv = new Ajv({ \r\n  allErrors: true,\r\n  removeAdditional: true, // –£–¥–∞–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è\r\n  useDefaults: true, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\r\n  coerceTypes: true // –ü—Ä–∏–≤–æ–¥–∏–º —Ç–∏–ø—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏\r\n});\r\naddFormats(ajv);\r\n\r\n/**\r\n * –ë–∞–∑–æ–≤—ã–µ —Å—Ö–µ–º—ã –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è\r\n */\r\nconst baseSchemas = {\r\n  // ID —Å—Ö–µ–º—ã\r\n  id: {\r\n    type: 'string',\r\n    pattern: '^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$'\r\n  },\r\n  \r\n  // Email —Å—Ö–µ–º–∞\r\n  email: {\r\n    type: 'string',\r\n    format: 'email',\r\n    maxLength: 255\r\n  },\r\n  \r\n  // –¢–µ–ª–µ—Ñ–æ–Ω —Å—Ö–µ–º–∞ (–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω)\r\n  phone: {\r\n    type: 'string',\r\n    pattern: '^\\\\+998\\\\d{9}$'\r\n  },\r\n  \r\n  // Telegram ID —Å—Ö–µ–º–∞\r\n  telegramId: {\r\n    type: 'string',\r\n    pattern: '^\\\\d+$',\r\n    minLength: 1,\r\n    maxLength: 20\r\n  },\r\n  \r\n  // –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Å—Ö–µ–º—ã\r\n  pagination: {\r\n    type: 'object',\r\n    properties: {\r\n      page: {\r\n        type: 'integer',\r\n        minimum: 1,\r\n        default: 1\r\n      },\r\n      limit: {\r\n        type: 'integer',\r\n        minimum: 1,\r\n        maximum: 100,\r\n        default: 20\r\n      },\r\n      sortBy: {\r\n        type: 'string',\r\n        maxLength: 50\r\n      },\r\n      sortOrder: {\r\n        type: 'string',\r\n        enum: ['asc', 'desc'],\r\n        default: 'desc'\r\n      }\r\n    },\r\n    additionalProperties: false\r\n  },\r\n  \r\n  // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã\r\n  coordinates: {\r\n    type: 'object',\r\n    properties: {\r\n      latitude: {\r\n        type: 'number',\r\n        minimum: -90,\r\n        maximum: 90\r\n      },\r\n      longitude: {\r\n        type: 'number',\r\n        minimum: -180,\r\n        maximum: 180\r\n      }\r\n    },\r\n    required: ['latitude', 'longitude'],\r\n    additionalProperties: false\r\n  }\r\n};\r\n\r\n/**\r\n * –°—Ö–µ–º—ã –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏\r\n */\r\nconst authSchemas = {\r\n  login: {\r\n    type: 'object',\r\n    properties: {\r\n      email: baseSchemas.email,\r\n      password: {\r\n        type: 'string',\r\n        minLength: 8,\r\n        maxLength: 128\r\n      }\r\n    },\r\n    required: ['email', 'password'],\r\n    additionalProperties: false\r\n  },\r\n  \r\n  register: {\r\n    type: 'object',\r\n    properties: {\r\n      email: baseSchemas.email,\r\n      password: {\r\n        type: 'string',\r\n        minLength: 8,\r\n        maxLength: 128\r\n      },\r\n      firstName: {\r\n        type: 'string',\r\n        minLength: 2,\r\n        maxLength: 50\r\n      },\r\n      lastName: {\r\n        type: 'string',\r\n        minLength: 2,\r\n        maxLength: 50\r\n      },\r\n      phone: baseSchemas.phone,\r\n      telegramId: baseSchemas.telegramId\r\n    },\r\n    required: ['email', 'password', 'firstName', 'lastName'],\r\n    additionalProperties: false\r\n  },\r\n  \r\n  refreshToken: {\r\n    type: 'object',\r\n    properties: {\r\n      refreshToken: {\r\n        type: 'string',\r\n        minLength: 10\r\n      }\r\n    },\r\n    required: ['refreshToken'],\r\n    additionalProperties: false\r\n  }\r\n};\r\n\r\n/**\r\n * –°—Ö–µ–º—ã –¥–ª—è –º–∞—à–∏–Ω\r\n */\r\nconst machineSchemas = {\r\n  create: {\r\n    type: 'object',\r\n    properties: {\r\n      name: {\r\n        type: 'string',\r\n        minLength: 2,\r\n        maxLength: 100\r\n      },\r\n      location: {\r\n        type: 'string',\r\n        minLength: 5,\r\n        maxLength: 255\r\n      },\r\n      coordinates: baseSchemas.coordinates,\r\n      type: {\r\n        type: 'string',\r\n        enum: ['SNACK', 'DRINK', 'COMBO', 'COFFEE']\r\n      },\r\n      capacity: {\r\n        type: 'integer',\r\n        minimum: 1,\r\n        maximum: 1000\r\n      },\r\n      isActive: {\r\n        type: 'boolean',\r\n        default: true\r\n      }\r\n    },\r\n    required: ['name', 'location', 'coordinates', 'type', 'capacity'],\r\n    additionalProperties: false\r\n  },\r\n  \r\n  update: {\r\n    type: 'object',\r\n    properties: {\r\n      name: {\r\n        type: 'string',\r\n        minLength: 2,\r\n        maxLength: 100\r\n      },\r\n      location: {\r\n        type: 'string',\r\n        minLength: 5,\r\n        maxLength: 255\r\n      },\r\n      coordinates: baseSchemas.coordinates,\r\n      type: {\r\n        type: 'string',\r\n        enum: ['SNACK', 'DRINK', 'COMBO', 'COFFEE']\r\n      },\r\n      capacity: {\r\n        type: 'integer',\r\n        minimum: 1,\r\n        maximum: 1000\r\n      },\r\n      isActive: {\r\n        type: 'boolean'\r\n      }\r\n    },\r\n    additionalProperties: false\r\n  },\r\n  \r\n  list: {\r\n    type: 'object',\r\n    properties: {\r\n      ...baseSchemas.pagination.properties,\r\n      type: {\r\n        type: 'string',\r\n        enum: ['SNACK', 'DRINK', 'COMBO', 'COFFEE']\r\n      },\r\n      isActive: {\r\n        type: 'boolean'\r\n      },\r\n      location: {\r\n        type: 'string',\r\n        maxLength: 255\r\n      }\r\n    },\r\n    additionalProperties: false\r\n  }\r\n};\r\n\r\n/**\r\n * –°—Ö–µ–º—ã –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è\r\n */\r\nconst inventorySchemas = {\r\n  create: {\r\n    type: 'object',\r\n    properties: {\r\n      machineId: baseSchemas.id,\r\n      productName: {\r\n        type: 'string',\r\n        minLength: 2,\r\n        maxLength: 100\r\n      },\r\n      quantity: {\r\n        type: 'integer',\r\n        minimum: 0,\r\n        maximum: 1000\r\n      },\r\n      price: {\r\n        type: 'number',\r\n        minimum: 0,\r\n        maximum: 1000000\r\n      },\r\n      expiryDate: {\r\n        type: 'string',\r\n        format: 'date'\r\n      }\r\n    },\r\n    required: ['machineId', 'productName', 'quantity', 'price'],\r\n    additionalProperties: false\r\n  },\r\n  \r\n  update: {\r\n    type: 'object',\r\n    properties: {\r\n      productName: {\r\n        type: 'string',\r\n        minLength: 2,\r\n        maxLength: 100\r\n      },\r\n      quantity: {\r\n        type: 'integer',\r\n        minimum: 0,\r\n        maximum: 1000\r\n      },\r\n      price: {\r\n        type: 'number',\r\n        minimum: 0,\r\n        maximum: 1000000\r\n      },\r\n      expiryDate: {\r\n        type: 'string',\r\n        format: 'date'\r\n      }\r\n    },\r\n    additionalProperties: false\r\n  },\r\n  \r\n  list: {\r\n    type: 'object',\r\n    properties: {\r\n      ...baseSchemas.pagination.properties,\r\n      machineId: baseSchemas.id,\r\n      productName: {\r\n        type: 'string',\r\n        maxLength: 100\r\n      },\r\n      lowStock: {\r\n        type: 'boolean'\r\n      }\r\n    },\r\n    additionalProperties: false\r\n  }\r\n};\r\n\r\n/**\r\n * –°—Ö–µ–º—ã –¥–ª—è –∑–∞–¥–∞—á\r\n */\r\nconst taskSchemas = {\r\n  create: {\r\n    type: 'object',\r\n    properties: {\r\n      machineId: baseSchemas.id,\r\n      type: {\r\n        type: 'string',\r\n        enum: ['MAINTENANCE', 'REFILL', 'REPAIR', 'INSPECTION', 'CLEANING']\r\n      },\r\n      priority: {\r\n        type: 'string',\r\n        enum: ['LOW', 'MEDIUM', 'HIGH', 'URGENT'],\r\n        default: 'MEDIUM'\r\n      },\r\n      description: {\r\n        type: 'string',\r\n        minLength: 10,\r\n        maxLength: 1000\r\n      },\r\n      scheduledFor: {\r\n        type: 'string',\r\n        format: 'date-time'\r\n      },\r\n      assignedTo: baseSchemas.id\r\n    },\r\n    required: ['machineId', 'type', 'description'],\r\n    additionalProperties: false\r\n  },\r\n  \r\n  update: {\r\n    type: 'object',\r\n    properties: {\r\n      type: {\r\n        type: 'string',\r\n        enum: ['MAINTENANCE', 'REFILL', 'REPAIR', 'INSPECTION', 'CLEANING']\r\n      },\r\n      priority: {\r\n        type: 'string',\r\n        enum: ['LOW', 'MEDIUM', 'HIGH', 'URGENT']\r\n      },\r\n      status: {\r\n        type: 'string',\r\n        enum: ['PENDING', 'IN_PROGRESS', 'COMPLETED', 'CANCELLED']\r\n      },\r\n      description: {\r\n        type: 'string',\r\n        minLength: 10,\r\n        maxLength: 1000\r\n      },\r\n      scheduledFor: {\r\n        type: 'string',\r\n        format: 'date-time'\r\n      },\r\n      assignedTo: baseSchemas.id,\r\n      completedAt: {\r\n        type: 'string',\r\n        format: 'date-time'\r\n      },\r\n      notes: {\r\n        type: 'string',\r\n        maxLength: 2000\r\n      }\r\n    },\r\n    additionalProperties: false\r\n  },\r\n  \r\n  list: {\r\n    type: 'object',\r\n    properties: {\r\n      ...baseSchemas.pagination.properties,\r\n      machineId: baseSchemas.id,\r\n      type: {\r\n        type: 'string',\r\n        enum: ['MAINTENANCE', 'REFILL', 'REPAIR', 'INSPECTION', 'CLEANING']\r\n      },\r\n      status: {\r\n        type: 'string',\r\n        enum: ['PENDING', 'IN_PROGRESS', 'COMPLETED', 'CANCELLED']\r\n      },\r\n      priority: {\r\n        type: 'string',\r\n        enum: ['LOW', 'MEDIUM', 'HIGH', 'URGENT']\r\n      },\r\n      assignedTo: baseSchemas.id\r\n    },\r\n    additionalProperties: false\r\n  }\r\n};\r\n\r\n/**\r\n * –í—Å–µ —Å—Ö–µ–º—ã –≤ –æ–¥–Ω–æ–º –æ–±—ä–µ–∫—Ç–µ\r\n */\r\nconst schemas = {\r\n  auth: authSchemas,\r\n  machine: machineSchemas,\r\n  inventory: inventorySchemas,\r\n  task: taskSchemas,\r\n  base: baseSchemas\r\n};\r\n\r\n/**\r\n * –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –≤—Å–µ —Å—Ö–µ–º—ã\r\n */\r\nconst compiledSchemas = {};\r\nObject.keys(schemas).forEach(category => {\r\n  compiledSchemas[category] = {};\r\n  Object.keys(schemas[category]).forEach(schemaName => {\r\n    const schemaKey = `${category}.${schemaName}`;\r\n    compiledSchemas[category][schemaName] = ajv.compile(schemas[category][schemaName]);\r\n  });\r\n});\r\n\r\n/**\r\n * Middleware –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ body\r\n */\r\nconst validateBody = (category, schemaName) => {\r\n  return async (request, reply) => {\r\n    const validator = compiledSchemas[category]?.[schemaName];\r\n    \r\n    if (!validator) {\r\n      return reply.code(500).send({\r\n        error: 'Internal Server Error',\r\n        message: 'Validation schema not found',\r\n        statusCode: 500\r\n      });\r\n    }\r\n\r\n    // –°–∞–Ω–∏—Ç–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π\r\n    if (request.body && typeof request.body === 'object') {\r\n      sanitizeRequestData(request.body);\r\n    }\r\n\r\n    const valid = validator(request.body);\r\n    \r\n    if (!valid) {\r\n      const errors = validator.errors.map(err => ({\r\n        field: err.instancePath.replace('/', '') || err.params?.missingProperty || 'root',\r\n        message: err.message,\r\n        value: err.data\r\n      }));\r\n\r\n      return reply.code(400).send({\r\n        error: 'Validation Error',\r\n        message: 'Invalid request data',\r\n        statusCode: 400,\r\n        details: errors\r\n      });\r\n    }\r\n  };\r\n};\r\n\r\n/**\r\n * Middleware –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ query –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤\r\n */\r\nconst validateQuery = (category, schemaName) => {\r\n  return async (request, reply) => {\r\n    const validator = compiledSchemas[category]?.[schemaName];\r\n    \r\n    if (!validator) {\r\n      return reply.code(500).send({\r\n        error: 'Internal Server Error',\r\n        message: 'Validation schema not found',\r\n        statusCode: 500\r\n      });\r\n    }\r\n\r\n    // –°–∞–Ω–∏—Ç–∏–∑–∏—Ä—É–µ–º query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã\r\n    if (request.query) {\r\n      sanitizeRequestData(request.query);\r\n    }\r\n\r\n    const valid = validator(request.query);\r\n    \r\n    if (!valid) {\r\n      const errors = validator.errors.map(err => ({\r\n        field: err.instancePath.replace('/', '') || err.params?.missingProperty || 'root',\r\n        message: err.message,\r\n        value: err.data\r\n      }));\r\n\r\n      return reply.code(400).send({\r\n        error: 'Validation Error',\r\n        message: 'Invalid query parameters',\r\n        statusCode: 400,\r\n        details: errors\r\n      });\r\n    }\r\n  };\r\n};\r\n\r\n/**\r\n * Middleware –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ params (URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤)\r\n */\r\nconst validateParams = (paramsSchema) => {\r\n  const validator = ajv.compile(paramsSchema);\r\n  \r\n  return async (request, reply) => {\r\n    const valid = validator(request.params);\r\n    \r\n    if (!valid) {\r\n      const errors = validator.errors.map(err => ({\r\n        field: err.instancePath.replace('/', '') || err.params?.missingProperty || 'root',\r\n        message: err.message,\r\n        value: err.data\r\n      }));\r\n\r\n      return reply.code(400).send({\r\n        error: 'Validation Error',\r\n        message: 'Invalid URL parameters',\r\n        statusCode: 400,\r\n        details: errors\r\n      });\r\n    }\r\n  };\r\n};\r\n\r\n/**\r\n * –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –≤–∞–ª–∏–¥–∞—Ç–æ—Ä ID –ø–∞—Ä–∞–º–µ—Ç—Ä–∞\r\n */\r\nconst validateId = validateParams({\r\n  type: 'object',\r\n  properties: {\r\n    id: baseSchemas.id\r\n  },\r\n  required: ['id'],\r\n  additionalProperties: false\r\n});\r\n\r\n/**\r\n * –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞\r\n */\r\nfunction sanitizeRequestData(data) {\r\n  if (typeof data !== 'object' || data === null) return;\r\n  \r\n  for (const [key, value] of Object.entries(data)) {\r\n    if (typeof value === 'string') {\r\n      data[key] = sanitizeInput(value);\r\n    } else if (typeof value === 'object' && value !== null) {\r\n      sanitizeRequestData(value);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞\r\n */\r\nconst createValidator = (schema) => {\r\n  const validator = ajv.compile(schema);\r\n  \r\n  return async (request, reply) => {\r\n    const dataToValidate = {\r\n      ...request.body,\r\n      ...request.query,\r\n      ...request.params\r\n    };\r\n\r\n    // –°–∞–Ω–∏—Ç–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ\r\n    sanitizeRequestData(dataToValidate);\r\n\r\n    const valid = validator(dataToValidate);\r\n    \r\n    if (!valid) {\r\n      const errors = validator.errors.map(err => ({\r\n        field: err.instancePath.replace('/', '') || err.params?.missingProperty || 'root',\r\n        message: err.message,\r\n        value: err.data\r\n      }));\r\n\r\n      return reply.code(400).send({\r\n        error: 'Validation Error',\r\n        message: 'Invalid request data',\r\n        statusCode: 400,\r\n        details: errors\r\n      });\r\n    }\r\n  };\r\n};\r\n\r\n/**\r\n * –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤\r\n */\r\nconst validateFile = (options = {}) => {\r\n  const {\r\n    required = false,\r\n    maxSize = 5 * 1024 * 1024, // 5MB –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\r\n    allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf']\r\n  } = options;\r\n\r\n  return async (request, reply) => {\r\n    const file = request.file;\r\n\r\n    if (required && !file) {\r\n      return reply.code(400).send({\r\n        error: 'Validation Error',\r\n        message: 'File is required',\r\n        statusCode: 400\r\n      });\r\n    }\r\n\r\n    if (file) {\r\n      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞\r\n      if (file.size > maxSize) {\r\n        return reply.code(400).send({\r\n          error: 'Validation Error',\r\n          message: `File size exceeds limit of ${Math.round(maxSize / 1024 / 1024)}MB`,\r\n          statusCode: 400\r\n        });\r\n      }\r\n\r\n      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞\r\n      if (!allowedTypes.includes(file.mimetype)) {\r\n        return reply.code(400).send({\r\n          error: 'Validation Error',\r\n          message: `File type ${file.mimetype} is not allowed`,\r\n          statusCode: 400,\r\n          allowedTypes\r\n        });\r\n      }\r\n    }\r\n  };\r\n};\r\n\r\nmodule.exports = {\r\n  schemas,\r\n  validateBody,\r\n  validateQuery,\r\n  validateParams,\r\n  validateId,\r\n  validateFile,\r\n  createValidator,\r\n  compiledSchemas\r\n};\r\n",
  "railway-start-monolith.js": "#!/usr/bin/env node\r\n\r\n/**\r\n * VHM24 Railway Monolith Start Script\r\n * –ó–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –≤ –æ–¥–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ –¥–ª—è Railway\r\n */\r\n\r\nconst { spawn } = require('child_process');\r\nconst path = require('path');\r\nconst fs = require('fs');\r\nconst Fastify = require('fastify');\r\n\r\n// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\ntry {\r\n  require('dotenv').config();\r\n} catch (error) {\r\n  console.log('‚ö†Ô∏è dotenv not available, using environment variables');\r\n}\r\n\r\nconsole.log('üöÇ VHM24 Railway Monolith Start...');\r\nconsole.log(`üìç Environment: ${process.env.NODE_ENV || 'production'}`);\r\nconsole.log(`üîå Port: ${process.env.PORT || 8000}`);\r\n\r\n// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\nprocess.env.NODE_ENV = process.env.NODE_ENV || 'production';\r\nprocess.env.PORT = process.env.PORT || '8000';\r\n\r\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ\r\nif (!process.env.DATABASE_URL) {\r\n  console.error('‚ùå DATABASE_URL is required for Railway deployment');\r\n  process.exit(1);\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–æ–º–∞–Ω–¥—ã\r\nfunction runCommand(command, args = [], options = {}) {\r\n  return new Promise((resolve, reject) => {\r\n    console.log(`üîß Running: ${command} ${args.join(' ')}`);\r\n    \r\n    const child = spawn(command, args, {\r\n      stdio: 'inherit',\r\n      shell: true,\r\n      ...options\r\n    });\r\n\r\n    child.on('close', (code) => {\r\n      if (code === 0) {\r\n        resolve();\r\n      } else {\r\n        reject(new Error(`Command failed with code ${code}`));\r\n      }\r\n    });\r\n\r\n    child.on('error', reject);\r\n  });\r\n}\r\n\r\n// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è\r\nasync function startRailwayApp() {\r\n  try {\r\n    console.log('üóÑÔ∏è === DATABASE MIGRATION PHASE ===');\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ schema.prisma\r\n    const schemaPath = path.join(__dirname, 'packages/database/prisma/schema.prisma');\r\n    if (!fs.existsSync(schemaPath)) {\r\n      throw new Error('Prisma schema not found at packages/database/prisma/schema.prisma');\r\n    }\r\n    \r\n    console.log('‚úÖ Prisma schema found');\r\n    \r\n    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma –∫–ª–∏–µ–Ω—Ç\r\n    console.log('üîß Generating Prisma client...');\r\n    await runCommand('npx', ['prisma', 'generate'], {\r\n      cwd: path.join(__dirname, 'packages/database')\r\n    });\r\n    console.log('‚úÖ Prisma client generated');\r\n    \r\n    // –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏\r\n    console.log('üîß Running database migrations...');\r\n    await runCommand('npx', ['prisma', 'migrate', 'deploy'], {\r\n      cwd: path.join(__dirname, 'packages/database')\r\n    });\r\n    console.log('‚úÖ Database migrations completed');\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö\r\n    console.log('üîß Testing database connection...');\r\n    const { getPrismaClient } = require('./packages/database');\r\n    let prisma;\r\n    \r\n    try {\r\n      prisma = getPrismaClient();\r\n      await prisma.$connect();\r\n      console.log('‚úÖ Database connection successful');\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\r\n      const userCount = await prisma.user.count();\r\n      console.log(`üìä Users in database: ${userCount}`);\r\n      \r\n      // –°–æ–∑–¥–∞–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\r\n      if (userCount === 0) {\r\n        console.log('üîß Creating default admin user...');\r\n        const bcrypt = require('bcrypt');\r\n        \r\n        const adminUser = await prisma.user.create({\r\n          data: {\r\n            email: 'admin@vhm24.ru',\r\n            name: 'System Administrator',\r\n            passwordHash: await bcrypt.hash('admin123', 10),\r\n            telegramId: process.env.ADMIN_IDS || '42283329',\r\n            roles: ['ADMIN'],\r\n            isActive: true\r\n          }\r\n        });\r\n        \r\n        console.log('‚úÖ Default admin user created');\r\n        console.log(`üìß Email: admin@vhm24.ru`);\r\n        console.log(`üîë Password: admin123`);\r\n        console.log(`üì± Telegram ID: ${adminUser.telegramId}`);\r\n      }\r\n      \r\n      await prisma.$disconnect();\r\n      console.log('üéâ Database migration completed successfully!');\r\n    } catch (error) {\r\n      console.error('‚ùå Database connection failed:', error.message);\r\n      console.log('‚ö†Ô∏è Continuing without database setup...');\r\n    }\r\n    \r\n    console.log('\\nüöÇ === MONOLITH APPLICATION START ===');\r\n    \r\n    // –°–æ–∑–¥–∞–µ–º –µ–¥–∏–Ω—ã–π Fastify —Å–µ—Ä–≤–µ—Ä\r\n    const fastify = Fastify({\r\n      logger: true,\r\n      bodyLimit: 10485760 // 10MB\r\n    });\r\n\r\n    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º CORS\r\n    await fastify.register(require('@fastify/cors'), {\r\n      origin: true,\r\n      credentials: true\r\n    });\r\n\r\n    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º multipart –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤\r\n    await fastify.register(require('@fastify/multipart'), {\r\n      limits: {\r\n        fileSize: 10 * 1024 * 1024 // 10MB\r\n      }\r\n    });\r\n\r\n    // Health check endpoint\r\n    fastify.get('/health', async (request, reply) => {\r\n      return { \r\n        status: 'ok', \r\n        service: 'vhm24-monolith',\r\n        timestamp: new Date().toISOString(),\r\n        database: 'connected'\r\n      };\r\n    });\r\n\r\n    // API Documentation\r\n    fastify.get('/docs', async (request, reply) => {\r\n      reply.type('text/html');\r\n      return `\r\n        <!DOCTYPE html>\r\n        <html>\r\n        <head>\r\n          <title>VHM24 API Documentation</title>\r\n          <style>\r\n            body { font-family: Arial, sans-serif; margin: 40px; }\r\n            .endpoint { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }\r\n            .method { font-weight: bold; color: #007bff; }\r\n          </style>\r\n        </head>\r\n        <body>\r\n          <h1>ü§ñ VHM24 API Documentation</h1>\r\n          <p>VendHub Manager 24/7 - Production API</p>\r\n          \r\n          <div class=\"endpoint\">\r\n            <div class=\"method\">GET /health</div>\r\n            <p>Health check endpoint</p>\r\n          </div>\r\n          \r\n          <div class=\"endpoint\">\r\n            <div class=\"method\">GET /docs</div>\r\n            <p>This documentation page</p>\r\n          </div>\r\n          \r\n          <div class=\"endpoint\">\r\n            <div class=\"method\">POST /api/v1/auth/login</div>\r\n            <p>User authentication</p>\r\n          </div>\r\n          \r\n          <div class=\"endpoint\">\r\n            <div class=\"method\">GET /api/v1/dashboard/stats</div>\r\n            <p>Dashboard statistics</p>\r\n          </div>\r\n          \r\n          <div class=\"endpoint\">\r\n            <div class=\"method\">GET /api/v1/machines</div>\r\n            <p>List all machines</p>\r\n          </div>\r\n          \r\n          <div class=\"endpoint\">\r\n            <div class=\"method\">GET /api/v1/inventory</div>\r\n            <p>Inventory management</p>\r\n          </div>\r\n          \r\n          <div class=\"endpoint\">\r\n            <div class=\"method\">GET /api/v1/tasks</div>\r\n            <p>Task management</p>\r\n          </div>\r\n          \r\n          <p><strong>Environment:</strong> ${process.env.NODE_ENV}</p>\r\n          <p><strong>Version:</strong> 1.0.0</p>\r\n        </body>\r\n        </html>\r\n      `;\r\n    });\r\n\r\n    // –ü–æ–ª—É—á–∞–µ–º prisma –∫–ª–∏–µ–Ω—Ç –¥–ª—è API endpoints\r\n    let apiPrisma;\r\n    try {\r\n      apiPrisma = getPrismaClient();\r\n    } catch (error) {\r\n      console.error('‚ùå Failed to initialize Prisma client for API:', error.message);\r\n      apiPrisma = null;\r\n    }\r\n\r\n    // –í—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ API endpoints –ø—Ä—è–º–æ –≤ –º–æ–Ω–æ–ª–∏—Ç\r\n    \r\n    // Auth endpoints\r\n    fastify.post('/api/v1/auth/login', async (request, reply) => {\r\n      try {\r\n        if (!apiPrisma) {\r\n          return reply.code(503).send({\r\n            success: false,\r\n            error: 'Database not available'\r\n          });\r\n        }\r\n\r\n        const { email, password } = request.body;\r\n        \r\n        if (!email || !password) {\r\n          return reply.code(400).send({\r\n            success: false,\r\n            error: 'Email and password are required'\r\n          });\r\n        }\r\n\r\n        const bcrypt = require('bcrypt');\r\n        const jwt = require('jsonwebtoken');\r\n        \r\n        const user = await apiPrisma.user.findUnique({\r\n          where: { email }\r\n        });\r\n\r\n        if (!user || !await bcrypt.compare(password, user.passwordHash)) {\r\n          return reply.code(401).send({\r\n            success: false,\r\n            error: 'Invalid credentials'\r\n          });\r\n        }\r\n\r\n        const token = jwt.sign(\r\n          { \r\n            id: user.id, \r\n            email: user.email, \r\n            roles: user.roles \r\n          },\r\n          process.env.JWT_SECRET || 'vhm24-secret-key',\r\n          { expiresIn: '24h' }\r\n        );\r\n\r\n        return {\r\n          success: true,\r\n          data: {\r\n            token,\r\n            user: {\r\n              id: user.id,\r\n              email: user.email,\r\n              name: user.name,\r\n              roles: user.roles\r\n            }\r\n          }\r\n        };\r\n      } catch (error) {\r\n        console.error('Login error:', error);\r\n        return reply.code(500).send({\r\n          success: false,\r\n          error: 'Internal server error'\r\n        });\r\n      }\r\n    });\r\n\r\n    // Dashboard stats\r\n    fastify.get('/api/v1/dashboard/stats', async (request, reply) => {\r\n      try {\r\n        if (!apiPrisma) {\r\n          return reply.code(503).send({\r\n            success: false,\r\n            error: 'Database not available'\r\n          });\r\n        }\r\n\r\n        const [\r\n          totalMachines,\r\n          onlineMachines,\r\n          totalTasks,\r\n          pendingTasks,\r\n          totalUsers,\r\n          activeUsers\r\n        ] = await Promise.all([\r\n          apiPrisma.machine.count(),\r\n          apiPrisma.machine.count({ where: { status: 'ONLINE' } }),\r\n          apiPrisma.task.count(),\r\n          apiPrisma.task.count({ where: { status: { in: ['CREATED', 'ASSIGNED'] } } }),\r\n          apiPrisma.user.count(),\r\n          apiPrisma.user.count({ where: { isActive: true } })\r\n        ]);\r\n\r\n        return {\r\n          success: true,\r\n          data: {\r\n            totalMachines,\r\n            onlineMachines,\r\n            totalTasks,\r\n            pendingTasks,\r\n            totalUsers,\r\n            activeUsers,\r\n            todayRevenue: 0,\r\n            totalRevenue: 0\r\n          }\r\n        };\r\n      } catch (error) {\r\n        console.error('Dashboard stats error:', error);\r\n        return reply.code(500).send({\r\n          success: false,\r\n          error: 'Failed to fetch dashboard stats'\r\n        });\r\n      }\r\n    });\r\n\r\n    // Machines endpoints\r\n    fastify.get('/api/v1/machines', async (request, reply) => {\r\n      try {\r\n        if (!apiPrisma) {\r\n          return reply.code(503).send({\r\n            success: false,\r\n            error: 'Database not available'\r\n          });\r\n        }\r\n\r\n        const machines = await apiPrisma.machine.findMany({\r\n          include: {\r\n            location: true\r\n          }\r\n        });\r\n\r\n        return {\r\n          success: true,\r\n          data: machines\r\n        };\r\n      } catch (error) {\r\n        console.error('Machines error:', error);\r\n        return reply.code(500).send({\r\n          success: false,\r\n          error: 'Failed to fetch machines'\r\n        });\r\n      }\r\n    });\r\n\r\n    // Inventory endpoints\r\n    fastify.get('/api/v1/inventory', async (request, reply) => {\r\n      try {\r\n        if (!apiPrisma) {\r\n          return reply.code(503).send({\r\n            success: false,\r\n            error: 'Database not available'\r\n          });\r\n        }\r\n\r\n        const inventory = await apiPrisma.inventoryItem.findMany();\r\n\r\n        return {\r\n          success: true,\r\n          data: inventory\r\n        };\r\n      } catch (error) {\r\n        console.error('Inventory error:', error);\r\n        return reply.code(500).send({\r\n          success: false,\r\n          error: 'Failed to fetch inventory'\r\n        });\r\n      }\r\n    });\r\n\r\n    // Tasks endpoints\r\n    fastify.get('/api/v1/tasks', async (request, reply) => {\r\n      try {\r\n        if (!apiPrisma) {\r\n          return reply.code(503).send({\r\n            success: false,\r\n            error: 'Database not available'\r\n          });\r\n        }\r\n\r\n        const tasks = await apiPrisma.task.findMany({\r\n          include: {\r\n            assignedTo: {\r\n              select: {\r\n                id: true,\r\n                name: true,\r\n                email: true\r\n              }\r\n            },\r\n            machine: {\r\n              select: {\r\n                id: true,\r\n                name: true,\r\n                code: true\r\n              }\r\n            }\r\n          }\r\n        });\r\n\r\n        return {\r\n          success: true,\r\n          data: tasks\r\n        };\r\n      } catch (error) {\r\n        console.error('Tasks error:', error);\r\n        return reply.code(500).send({\r\n          success: false,\r\n          error: 'Failed to fetch tasks'\r\n        });\r\n      }\r\n    });\r\n\r\n    // –ó–∞–ø—É—Å–∫–∞–µ–º Telegram Bot –≤ —Ñ–æ–Ω–µ (–µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –µ—Å—Ç—å)\r\n    if (process.env.TELEGRAM_BOT_TOKEN) {\r\n      setTimeout(() => {\r\n        console.log('ü§ñ Starting Telegram Bot...');\r\n        try {\r\n          require('./services/telegram-bot/src/index.js');\r\n          console.log('‚úÖ Telegram Bot started successfully');\r\n        } catch (error) {\r\n          console.error('‚ùå Telegram Bot failed to start:', error.message);\r\n        }\r\n      }, 3000);\r\n    }\r\n\r\n    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä\r\n    const port = process.env.PORT || 8000;\r\n    await fastify.listen({ \r\n      port: port,\r\n      host: '0.0.0.0'\r\n    });\r\n    \r\n    console.log(`üéâ VHM24 Monolith is running on port ${port}`);\r\n    console.log(`üåê Health check: http://localhost:${port}/health`);\r\n    console.log(`üìö Documentation: http://localhost:${port}/docs`);\r\n    \r\n    // Railway specific logging\r\n    if (process.env.RAILWAY_ENVIRONMENT) {\r\n      console.log('üöÇ Running on Railway:', process.env.RAILWAY_STATIC_URL);\r\n      console.log('üîó Public URL:', `https://${process.env.RAILWAY_STATIC_URL}`);\r\n    }\r\n    \r\n  } catch (error) {\r\n    console.error('‚ùå Railway deployment failed:', error.message);\r\n    console.error('Stack trace:', error.stack);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤\r\nprocess.on('SIGTERM', () => {\r\n  console.log('üõë Received SIGTERM, shutting down...');\r\n  process.exit(0);\r\n});\r\n\r\nprocess.on('SIGINT', () => {\r\n  console.log('üõë Received SIGINT, shutting down...');\r\n  process.exit(0);\r\n});\r\n\r\nprocess.on('uncaughtException', (error) => {\r\n  console.error('‚ùå Uncaught Exception:', error);\r\n  process.exit(1);\r\n});\r\n\r\nprocess.on('unhandledRejection', (reason, promise) => {\r\n  console.error('‚ùå Unhandled Rejection:', reason);\r\n  process.exit(1);\r\n});\r\n\r\n// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\r\nstartRailwayApp();\r\n",
  "railway-start-unified.js": "#!/usr/bin/env node\r\n\r\n/**\r\n * VHM24 Railway Unified Start Script\r\n * –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ –æ–¥–Ω–æ–º —Å–∫—Ä–∏–ø—Ç–µ\r\n * –†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–µ–ø–ª–æ–µ–º –Ω–∞ Railway\r\n */\r\n\r\nconst { spawn } = require('child_process');\r\nconst path = require('path');\r\nconst fs = require('fs');\r\nconst Fastify = require('fastify');\r\n\r\n// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\ntry {\r\n  require('dotenv').config();\r\n} catch (error) {\r\n  console.log('‚ö†Ô∏è dotenv not available, using environment variables');\r\n}\r\n\r\nconsole.log('üöÇ VHM24 Railway Unified Start...');\r\nconsole.log(`üìç Environment: ${process.env.NODE_ENV || 'production'}`);\r\nconsole.log(`üîå Port: ${process.env.PORT || 8000}`);\r\n\r\n// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\nprocess.env.NODE_ENV = process.env.NODE_ENV || 'production';\r\nprocess.env.PORT = process.env.PORT || '8000';\r\n\r\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ\r\nif (!process.env.DATABASE_URL) {\r\n  console.error('‚ùå DATABASE_URL is required for Railway deployment');\r\n  process.exit(1);\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–æ–º–∞–Ω–¥—ã\r\nfunction runCommand(command, args = [], options = {}) {\r\n  return new Promise((resolve, reject) => {\r\n    console.log(`üîß Running: ${command} ${args.join(' ')}`);\r\n    \r\n    const child = spawn(command, args, {\r\n      stdio: 'inherit',\r\n      shell: true,\r\n      ...options\r\n    });\r\n\r\n    child.on('close', (code) => {\r\n      if (code === 0) {\r\n        resolve();\r\n      } else {\r\n        reject(new Error(`Command failed with code ${code}`));\r\n      }\r\n    });\r\n\r\n    child.on('error', reject);\r\n  });\r\n}\r\n\r\n// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è\r\nasync function startRailwayApp() {\r\n  try {\r\n    console.log('üóÑÔ∏è === DATABASE MIGRATION PHASE ===');\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ schema.prisma\r\n    const schemaPath = path.join(__dirname, 'packages/database/prisma/schema.prisma');\r\n    if (!fs.existsSync(schemaPath)) {\r\n      console.warn('‚ö†Ô∏è Prisma schema not found at packages/database/prisma/schema.prisma');\r\n      console.warn('‚ö†Ô∏è Skipping database migration phase');\r\n    } else {\r\n      console.log('‚úÖ Prisma schema found');\r\n      \r\n      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma –∫–ª–∏–µ–Ω—Ç\r\n      console.log('üîß Generating Prisma client...');\r\n      try {\r\n        await runCommand('npx', ['prisma', 'generate'], {\r\n          cwd: path.join(__dirname, 'packages/database')\r\n        });\r\n        console.log('‚úÖ Prisma client generated');\r\n      } catch (error) {\r\n        console.error('‚ö†Ô∏è Failed to generate Prisma client:', error.message);\r\n        console.log('‚ö†Ô∏è Continuing without Prisma client generation');\r\n      }\r\n      \r\n      // –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏\r\n      console.log('üîß Running database migrations...');\r\n      try {\r\n        await runCommand('npx', ['prisma', 'migrate', 'deploy'], {\r\n          cwd: path.join(__dirname, 'packages/database')\r\n        });\r\n        console.log('‚úÖ Database migrations completed');\r\n      } catch (error) {\r\n        console.error('‚ö†Ô∏è Failed to run database migrations:', error.message);\r\n        console.log('‚ö†Ô∏è Continuing without database migrations');\r\n      }\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö\r\n      console.log('üîß Testing database connection...');\r\n      let prisma;\r\n      \r\n      try {\r\n        const { getPrismaClient } = require('./packages/database');\r\n        prisma = getPrismaClient();\r\n        await prisma.$connect();\r\n        console.log('‚úÖ Database connection successful');\r\n        \r\n        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\r\n        const userCount = await prisma.user.count();\r\n        console.log(`üìä Users in database: ${userCount}`);\r\n        \r\n        // –°–æ–∑–¥–∞–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\r\n        if (userCount === 0) {\r\n          console.log('üîß Creating default admin user...');\r\n          try {\r\n            const bcrypt = require('bcrypt');\r\n            \r\n            const adminUser = await prisma.user.create({\r\n              data: {\r\n                email: 'admin@vhm24.ru',\r\n                name: 'System Administrator',\r\n                passwordHash: await bcrypt.hash('admin123', 10),\r\n                telegramId: process.env.ADMIN_IDS || '42283329',\r\n                roles: ['ADMIN'],\r\n                isActive: true\r\n              }\r\n            });\r\n            \r\n            console.log('‚úÖ Default admin user created');\r\n            console.log(`üìß Email: admin@vhm24.ru`);\r\n            console.log(`üîë Password: admin123`);\r\n            console.log(`üì± Telegram ID: ${adminUser.telegramId}`);\r\n          } catch (error) {\r\n            console.error('‚ö†Ô∏è Failed to create admin user:', error.message);\r\n            console.log('‚ö†Ô∏è Continuing without admin user creation');\r\n          }\r\n        }\r\n        \r\n        await prisma.$disconnect();\r\n        console.log('üéâ Database migration completed successfully!');\r\n      } catch (error) {\r\n        console.error('‚ö†Ô∏è Database connection failed:', error.message);\r\n        console.log('‚ö†Ô∏è Continuing without database setup...');\r\n      }\r\n    }\r\n    \r\n    console.log('\\nüöÇ === MONOLITH APPLICATION START ===');\r\n    \r\n    // –°–æ–∑–¥–∞–µ–º –µ–¥–∏–Ω—ã–π Fastify —Å–µ—Ä–≤–µ—Ä\r\n    const fastify = Fastify({\r\n      logger: true,\r\n      bodyLimit: 10485760 // 10MB\r\n    });\r\n\r\n    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º CORS\r\n    try {\r\n      await fastify.register(require('@fastify/cors'), {\r\n        origin: true,\r\n        credentials: true\r\n      });\r\n    } catch (error) {\r\n      console.error('‚ö†Ô∏è Failed to register CORS:', error.message);\r\n    }\r\n\r\n    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º multipart –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤\r\n    try {\r\n      await fastify.register(require('@fastify/multipart'), {\r\n        limits: {\r\n          fileSize: 10 * 1024 * 1024 // 10MB\r\n        }\r\n      });\r\n    } catch (error) {\r\n      console.error('‚ö†Ô∏è Failed to register multipart:', error.message);\r\n    }\r\n\r\n    // Health check endpoint\r\n    fastify.get('/health', async (request, reply) => {\r\n      const healthData = {\r\n        status: 'ok',\r\n        service: 'vhm24-unified',\r\n        timestamp: new Date().toISOString(),\r\n        environment: process.env.NODE_ENV || 'production',\r\n        port: process.env.PORT || 8000,\r\n        uptime: process.uptime(),\r\n        memory: process.memoryUsage(),\r\n        version: '1.0.0'\r\n      };\r\n\r\n      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ\r\n      if (process.env.DATABASE_URL) {\r\n        try {\r\n          const { PrismaClient } = require('@prisma/client');\r\n          const prisma = new PrismaClient();\r\n          await prisma.$queryRaw`SELECT 1`;\r\n          await prisma.$disconnect();\r\n          healthData.database = 'connected';\r\n        } catch (error) {\r\n          healthData.database = 'disconnected';\r\n          healthData.database_error = error.message;\r\n        }\r\n      }\r\n\r\n      return healthData;\r\n    });\r\n\r\n    // Root endpoint\r\n    fastify.get('/', async (request, reply) => {\r\n      reply.type('text/html');\r\n      return `\r\n        <!DOCTYPE html>\r\n        <html lang=\"ru\">\r\n        <head>\r\n          <meta charset=\"UTF-8\">\r\n          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n          <title>VHM24 - Railway Deployment</title>\r\n          <style>\r\n            * { margin: 0; padding: 0; box-sizing: border-box; }\r\n            body { \r\n              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\r\n              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n              color: white;\r\n              min-height: 100vh;\r\n              display: flex;\r\n              align-items: center;\r\n              justify-content: center;\r\n            }\r\n            .container { \r\n              max-width: 900px; \r\n              margin: 0 auto; \r\n              padding: 40px;\r\n              background: rgba(255,255,255,0.1);\r\n              border-radius: 20px;\r\n              backdrop-filter: blur(10px);\r\n              box-shadow: 0 8px 32px rgba(0,0,0,0.1);\r\n              text-align: center;\r\n            }\r\n            .success { \r\n              color: #4CAF50; \r\n              font-size: 2.5em; \r\n              margin: 20px 0;\r\n              text-shadow: 2px 2px 4px rgba(0,0,0,0.3);\r\n            }\r\n            .info-grid {\r\n              display: grid;\r\n              grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\r\n              gap: 15px;\r\n              margin: 30px 0;\r\n            }\r\n            .info-card { \r\n              padding: 15px; \r\n              background: rgba(255,255,255,0.2); \r\n              border-radius: 10px;\r\n              border: 1px solid rgba(255,255,255,0.3);\r\n            }\r\n            .endpoint-list {\r\n              display: grid;\r\n              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\r\n              gap: 10px;\r\n              margin: 20px 0;\r\n            }\r\n            .endpoint { \r\n              padding: 12px; \r\n              background: rgba(255,255,255,0.15); \r\n              border-radius: 8px;\r\n              font-family: 'Courier New', monospace;\r\n              font-size: 0.9em;\r\n            }\r\n            .status-indicator {\r\n              display: inline-block;\r\n              width: 12px;\r\n              height: 12px;\r\n              border-radius: 50%;\r\n              background: #4CAF50;\r\n              margin-right: 8px;\r\n              animation: pulse 2s infinite;\r\n            }\r\n            @keyframes pulse {\r\n              0% { opacity: 1; }\r\n              50% { opacity: 0.5; }\r\n              100% { opacity: 1; }\r\n            }\r\n            .footer {\r\n              margin-top: 40px;\r\n              font-size: 0.9em;\r\n              opacity: 0.8;\r\n              border-top: 1px solid rgba(255,255,255,0.2);\r\n              padding-top: 20px;\r\n            }\r\n            .btn {\r\n              display: inline-block;\r\n              padding: 12px 24px;\r\n              margin: 10px;\r\n              background: rgba(255,255,255,0.2);\r\n              border: 1px solid rgba(255,255,255,0.3);\r\n              border-radius: 8px;\r\n              color: white;\r\n              text-decoration: none;\r\n              transition: all 0.3s ease;\r\n            }\r\n            .btn:hover {\r\n              background: rgba(255,255,255,0.3);\r\n              transform: translateY(-2px);\r\n            }\r\n          </style>\r\n        </head>\r\n        <body>\r\n          <div class=\"container\">\r\n            <h1>üéâ VHM24 Railway Deployment</h1>\r\n            <div class=\"success\">\r\n              <span class=\"status-indicator\"></span>\r\n              –£–°–ü–ï–®–ù–û –†–ê–ó–í–ï–†–ù–£–¢–û!\r\n            </div>\r\n            \r\n            <div class=\"info-grid\">\r\n              <div class=\"info-card\">\r\n                <strong>üåç Environment</strong><br>\r\n                ${process.env.NODE_ENV || 'production'}\r\n              </div>\r\n              <div class=\"info-card\">\r\n                <strong>üîå Port</strong><br>\r\n                ${process.env.PORT || 8000}\r\n              </div>\r\n              <div class=\"info-card\">\r\n                <strong>üöÇ Railway URL</strong><br>\r\n                ${process.env.RAILWAY_STATIC_URL || 'N/A'}\r\n              </div>\r\n              <div class=\"info-card\">\r\n                <strong>‚è∞ Deployed</strong><br>\r\n                ${new Date().toLocaleString('ru-RU')}\r\n              </div>\r\n            </div>\r\n            \r\n            <h2>üîó –î–æ—Å—Ç—É–ø–Ω—ã–µ API endpoints:</h2>\r\n            <div class=\"endpoint-list\">\r\n              <div class=\"endpoint\">GET /health</div>\r\n              <div class=\"endpoint\">GET /</div>\r\n              <div class=\"endpoint\">GET /docs</div>\r\n              <div class=\"endpoint\">GET /api/status</div>\r\n            </div>\r\n            \r\n            <div style=\"margin: 30px 0;\">\r\n              <a href=\"/health\" class=\"btn\">üè• Health Check</a>\r\n              <a href=\"/docs\" class=\"btn\">üìö Documentation</a>\r\n              <a href=\"/api/status\" class=\"btn\">üìä System Status</a>\r\n            </div>\r\n            \r\n            <h2>üéØ –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã:</h2>\r\n            <div class=\"info-grid\">\r\n              <div class=\"info-card\">\r\n                <strong>‚úÖ –°–µ—Ä–≤–µ—Ä</strong><br>\r\n                –ó–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç\r\n              </div>\r\n              <div class=\"info-card\">\r\n                <strong>üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</strong><br>\r\n                ${process.env.DATABASE_URL ? '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∞' : '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞'}\r\n              </div>\r\n              <div class=\"info-card\">\r\n                <strong>üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</strong><br>\r\n                ${process.env.JWT_SECRET ? '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∞' : '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞'}\r\n              </div>\r\n              <div class=\"info-card\">\r\n                <strong>ü§ñ Telegram Bot</strong><br>\r\n                ${process.env.TELEGRAM_BOT_TOKEN ? '–ù–∞—Å—Ç—Ä–æ–µ–Ω' : '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}\r\n              </div>\r\n            </div>\r\n            \r\n            <div class=\"footer\">\r\n              <strong>VHM24 - VendHub Manager 24/7</strong><br>\r\n              Railway Deployment - Version 1.0.0<br>\r\n              Uptime: ${Math.floor(process.uptime())} seconds\r\n            </div>\r\n          </div>\r\n        </body>\r\n        </html>\r\n      `;\r\n    });\r\n\r\n    // API Documentation endpoint\r\n    fastify.get('/docs', async (request, reply) => {\r\n      reply.type('text/html');\r\n      return `\r\n        <!DOCTYPE html>\r\n        <html lang=\"ru\">\r\n        <head>\r\n          <meta charset=\"UTF-8\">\r\n          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n          <title>VHM24 API Documentation</title>\r\n          <style>\r\n            body { \r\n              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\r\n              margin: 40px; \r\n              background: #f5f5f5;\r\n              color: #333;\r\n            }\r\n            .container { max-width: 1000px; margin: 0 auto; background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }\r\n            .endpoint { \r\n              margin: 20px 0; \r\n              padding: 20px; \r\n              border: 1px solid #ddd; \r\n              border-radius: 8px;\r\n              background: #fafafa;\r\n            }\r\n            .method { \r\n              font-weight: bold; \r\n              color: #007bff; \r\n              font-family: 'Courier New', monospace;\r\n              background: #e3f2fd;\r\n              padding: 4px 8px;\r\n              border-radius: 4px;\r\n              display: inline-block;\r\n              margin-bottom: 10px;\r\n            }\r\n            .description { margin: 10px 0; }\r\n            .response { \r\n              background: #f8f9fa; \r\n              padding: 15px; \r\n              border-radius: 5px; \r\n              font-family: 'Courier New', monospace;\r\n              font-size: 0.9em;\r\n              margin-top: 10px;\r\n            }\r\n            h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }\r\n            h2 { color: #34495e; margin-top: 30px; }\r\n            .status { color: #27ae60; font-weight: bold; }\r\n          </style>\r\n        </head>\r\n        <body>\r\n          <div class=\"container\">\r\n            <h1>ü§ñ VHM24 API Documentation</h1>\r\n            <p><strong>VendHub Manager 24/7 - Railway API</strong></p>\r\n            \r\n            <h2>üìã –û—Å–Ω–æ–≤–Ω—ã–µ endpoints</h2>\r\n            \r\n            <div class=\"endpoint\">\r\n              <div class=\"method\">GET /</div>\r\n              <div class=\"description\">–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏</div>\r\n              <div class=\"response\">–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: HTML —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π</div>\r\n            </div>\r\n            \r\n            <div class=\"endpoint\">\r\n              <div class=\"method\">GET /health</div>\r\n              <div class=\"description\">Health check endpoint –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞</div>\r\n              <div class=\"response\">\r\n    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: JSON –æ–±—ä–µ–∫—Ç<br>\r\n    {<br>\r\n    &nbsp;&nbsp;\"status\": \"ok\",<br>\r\n    &nbsp;&nbsp;\"service\": \"vhm24-unified\",<br>\r\n    &nbsp;&nbsp;\"timestamp\": \"2025-07-10T02:10:00.000Z\",<br>\r\n    &nbsp;&nbsp;\"environment\": \"production\",<br>\r\n    &nbsp;&nbsp;\"port\": 8000,<br>\r\n    &nbsp;&nbsp;\"uptime\": 123.45,<br>\r\n    &nbsp;&nbsp;\"memory\": {...},<br>\r\n    &nbsp;&nbsp;\"database\": \"connected\"<br>\r\n    }\r\n              </div>\r\n            </div>\r\n            \r\n            <div class=\"endpoint\">\r\n              <div class=\"method\">GET /docs</div>\r\n              <div class=\"description\">–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ API</div>\r\n              <div class=\"response\">–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: HTML —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π</div>\r\n            </div>\r\n            \r\n            <div class=\"endpoint\">\r\n              <div class=\"method\">GET /api/status</div>\r\n              <div class=\"description\">–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ —Å–∏—Å—Ç–µ–º—ã</div>\r\n              <div class=\"response\">–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: JSON —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–∏—Å—Ç–µ–º–µ</div>\r\n            </div>\r\n            \r\n            <h2>üìä –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>\r\n            <div class=\"endpoint\">\r\n              <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span class=\"status\">Railway deployment —É—Å–ø–µ—à–µ–Ω</span></p>\r\n              <p><strong>Environment:</strong> ${process.env.NODE_ENV || 'production'}</p>\r\n              <p><strong>Version:</strong> 1.0.0</p>\r\n              <p><strong>Port:</strong> ${process.env.PORT || 8000}</p>\r\n              <p><strong>Uptime:</strong> ${Math.floor(process.uptime())} —Å–µ–∫—É–Ω–¥</p>\r\n            </div>\r\n            \r\n            <h2>üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</h2>\r\n            <div class=\"endpoint\">\r\n              <p><strong>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:</strong> ${process.env.DATABASE_URL ? '‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞' : '‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞'}</p>\r\n              <p><strong>JWT Secret:</strong> ${process.env.JWT_SECRET ? '‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω' : '‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}</p>\r\n              <p><strong>Telegram Bot:</strong> ${process.env.TELEGRAM_BOT_TOKEN ? '‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω' : '‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}</p>\r\n              <p><strong>Redis:</strong> ${process.env.REDIS_URL ? '‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω' : '‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}</p>\r\n            </div>\r\n            \r\n            <div style=\"margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666;\">\r\n              <p>VHM24 - VendHub Manager 24/7 | Railway API</p>\r\n            </div>\r\n          </div>\r\n        </body>\r\n        </html>\r\n      `;\r\n    });\r\n\r\n    // System status API endpoint\r\n    fastify.get('/api/status', async (request, reply) => {\r\n      const status = {\r\n        service: 'vhm24-unified',\r\n        status: 'running',\r\n        timestamp: new Date().toISOString(),\r\n        environment: process.env.NODE_ENV || 'production',\r\n        port: process.env.PORT || 8000,\r\n        uptime: process.uptime(),\r\n        memory: process.memoryUsage(),\r\n        version: '1.0.0',\r\n        railway: {\r\n          environment: process.env.RAILWAY_ENVIRONMENT || null,\r\n          static_url: process.env.RAILWAY_STATIC_URL || null,\r\n          deployment_id: process.env.RAILWAY_DEPLOYMENT_ID || null\r\n        },\r\n        configuration: {\r\n          database: !!process.env.DATABASE_URL,\r\n          jwt_secret: !!process.env.JWT_SECRET,\r\n          telegram_bot: !!process.env.TELEGRAM_BOT_TOKEN,\r\n          redis: !!process.env.REDIS_URL,\r\n          admin_ids: !!process.env.ADMIN_IDS\r\n        }\r\n      };\r\n\r\n      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö\r\n      if (process.env.DATABASE_URL) {\r\n        try {\r\n          const { PrismaClient } = require('@prisma/client');\r\n          const prisma = new PrismaClient();\r\n          await prisma.$queryRaw`SELECT 1`;\r\n          await prisma.$disconnect();\r\n          status.database = { status: 'connected', error: null };\r\n        } catch (error) {\r\n          status.database = { status: 'error', error: error.message };\r\n        }\r\n      } else {\r\n        status.database = { status: 'not_configured', error: null };\r\n      }\r\n\r\n      return status;\r\n    });\r\n\r\n    // –ü–æ–ª—É—á–∞–µ–º prisma –∫–ª–∏–µ–Ω—Ç –¥–ª—è API endpoints\r\n    let apiPrisma;\r\n    try {\r\n      const { getPrismaClient } = require('./packages/database');\r\n      apiPrisma = getPrismaClient();\r\n    } catch (error) {\r\n      console.error('‚ö†Ô∏è Failed to initialize Prisma client for API:', error.message);\r\n      apiPrisma = null;\r\n    }\r\n\r\n    // –í—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ API endpoints –ø—Ä—è–º–æ –≤ –º–æ–Ω–æ–ª–∏—Ç\r\n    \r\n    // Auth endpoints\r\n    fastify.post('/api/v1/auth/login', async (request, reply) => {\r\n      try {\r\n        if (!apiPrisma) {\r\n          return reply.code(503).send({\r\n            success: false,\r\n            error: 'Database not available'\r\n          });\r\n        }\r\n\r\n        const { email, password } = request.body;\r\n        \r\n        if (!email || !password) {\r\n          return reply.code(400).send({\r\n            success: false,\r\n            error: 'Email and password are required'\r\n          });\r\n        }\r\n\r\n        const bcrypt = require('bcrypt');\r\n        const jwt = require('jsonwebtoken');\r\n        \r\n        const user = await apiPrisma.user.findUnique({\r\n          where: { email }\r\n        });\r\n\r\n        if (!user || !await bcrypt.compare(password, user.passwordHash)) {\r\n          return reply.code(401).send({\r\n            success: false,\r\n            error: 'Invalid credentials'\r\n          });\r\n        }\r\n\r\n        const token = jwt.sign(\r\n          { \r\n            id: user.id, \r\n            email: user.email, \r\n            roles: user.roles \r\n          },\r\n          process.env.JWT_SECRET || 'vhm24-secret-key',\r\n          { expiresIn: '24h' }\r\n        );\r\n\r\n        return {\r\n          success: true,\r\n          data: {\r\n            token,\r\n            user: {\r\n              id: user.id,\r\n              email: user.email,\r\n              name: user.name,\r\n              roles: user.roles\r\n            }\r\n          }\r\n        };\r\n      } catch (error) {\r\n        console.error('Login error:', error);\r\n        return reply.code(500).send({\r\n          success: false,\r\n          error: 'Internal server error'\r\n        });\r\n      }\r\n    });\r\n\r\n    // Dashboard stats\r\n    fastify.get('/api/v1/dashboard/stats', async (request, reply) => {\r\n      try {\r\n        if (!apiPrisma) {\r\n          return reply.code(503).send({\r\n            success: false,\r\n            error: 'Database not available'\r\n          });\r\n        }\r\n\r\n        const [\r\n          totalMachines,\r\n          onlineMachines,\r\n          totalTasks,\r\n          pendingTasks,\r\n          totalUsers,\r\n          activeUsers\r\n        ] = await Promise.all([\r\n          apiPrisma.machine.count(),\r\n          apiPrisma.machine.count({ where: { status: 'ONLINE' } }),\r\n          apiPrisma.task.count(),\r\n          apiPrisma.task.count({ where: { status: { in: ['CREATED', 'ASSIGNED'] } } }),\r\n          apiPrisma.user.count(),\r\n          apiPrisma.user.count({ where: { isActive: true } })\r\n        ]);\r\n\r\n        return {\r\n          success: true,\r\n          data: {\r\n            totalMachines,\r\n            onlineMachines,\r\n            totalTasks,\r\n            pendingTasks,\r\n            totalUsers,\r\n            activeUsers,\r\n            todayRevenue: 0,\r\n            totalRevenue: 0\r\n          }\r\n        };\r\n      } catch (error) {\r\n        console.error('Dashboard stats error:', error);\r\n        return reply.code(500).send({\r\n          success: false,\r\n          error: 'Failed to fetch dashboard stats'\r\n        });\r\n      }\r\n    });\r\n\r\n    // Machines endpoints\r\n    fastify.get('/api/v1/machines', async (request, reply) => {\r\n      try {\r\n        if (!apiPrisma) {\r\n          return reply.code(503).send({\r\n            success: false,\r\n            error: 'Database not available'\r\n          });\r\n        }\r\n\r\n        const machines = await apiPrisma.machine.findMany({\r\n          include: {\r\n            location: true\r\n          }\r\n        });\r\n\r\n        return {\r\n          success: true,\r\n          data: machines\r\n        };\r\n      } catch (error) {\r\n        console.error('Machines error:', error);\r\n        return reply.code(500).send({\r\n          success: false,\r\n          error: 'Failed to fetch machines'\r\n        });\r\n      }\r\n    });\r\n\r\n    // Inventory endpoints\r\n    fastify.get('/api/v1/inventory', async (request, reply) => {\r\n      try {\r\n        if (!apiPrisma) {\r\n          return reply.code(503).send({\r\n            success: false,\r\n            error: 'Database not available'\r\n          });\r\n        }\r\n\r\n        const inventory = await apiPrisma.inventoryItem.findMany();\r\n\r\n        return {\r\n          success: true,\r\n          data: inventory\r\n        };\r\n      } catch (error) {\r\n        console.error('Inventory error:', error);\r\n        return reply.code(500).send({\r\n          success: false,\r\n          error: 'Failed to fetch inventory'\r\n        });\r\n      }\r\n    });\r\n\r\n    // Tasks endpoints\r\n    fastify.get('/api/v1/tasks', async (request, reply) => {\r\n      try {\r\n        if (!apiPrisma) {\r\n          return reply.code(503).send({\r\n            success: false,\r\n            error: 'Database not available'\r\n          });\r\n        }\r\n\r\n        const tasks = await apiPrisma.task.findMany({\r\n          include: {\r\n            assignedTo: {\r\n              select: {\r\n                id: true,\r\n                name: true,\r\n                email: true\r\n              }\r\n            },\r\n            machine: {\r\n              select: {\r\n                id: true,\r\n                name: true,\r\n                code: true\r\n              }\r\n            }\r\n          }\r\n        });\r\n\r\n        return {\r\n          success: true,\r\n          data: tasks\r\n        };\r\n      } catch (error) {\r\n        console.error('Tasks error:', error);\r\n        return reply.code(500).send({\r\n          success: false,\r\n          error: 'Failed to fetch tasks'\r\n        });\r\n      }\r\n    });\r\n\r\n    // 404 handler\r\n    fastify.setNotFoundHandler(async (request, reply) => {\r\n      reply.code(404).type('application/json');\r\n      return {\r\n        error: 'Not Found',\r\n        message: `Route ${request.method}:${request.url} not found`,\r\n        statusCode: 404,\r\n        timestamp: new Date().toISOString()\r\n      };\r\n    });\r\n\r\n    // Error handler\r\n    fastify.setErrorHandler(async (error, request, reply) => {\r\n      fastify.log.error(error);\r\n      reply.code(500).type('application/json');\r\n      return {\r\n        error: 'Internal Server Error',\r\n        message: error.message,\r\n        statusCode: 500,\r\n        timestamp: new Date().toISOString()\r\n      };\r\n    });\r\n\r\n    // –ó–∞–ø—É—Å–∫–∞–µ–º Telegram Bot –≤ —Ñ–æ–Ω–µ (–µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –µ—Å—Ç—å)\r\n    if (process.env.TELEGRAM_BOT_TOKEN && fs.existsSync('./services/telegram-bot/src/index.js')) {\r\n      setTimeout(() => {\r\n        console.log('ü§ñ Starting Telegram Bot...');\r\n        try {\r\n          require('./services/telegram-bot/src/index.js');\r\n          console.log('‚úÖ Telegram Bot started successfully');\r\n        } catch (error) {\r\n          console.error('‚ö†Ô∏è Telegram Bot failed to start:', error.message);\r\n          console.log('‚ö†Ô∏è Continuing without Telegram Bot');\r\n        }\r\n      }, 3000);\r\n    }\r\n\r\n    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä\r\n    const port = process.env.PORT || 8000;\r\n    await fastify.listen({ \r\n      port: port,\r\n      host: '0.0.0.0'\r\n    });\r\n    \r\n    console.log(`üéâ VHM24 Unified is running on port ${port}`);\r\n    console.log(`üåê Health check: http://localhost:${port}/health`);\r\n    console.log(`üìö Documentation: http://localhost:${port}/docs`);\r\n    console.log(`üìä System status: http://localhost:${port}/api/status`);\r\n    \r\n    // Railway specific logging\r\n    if (process.env.RAILWAY_ENVIRONMENT) {\r\n      console.log('üöÇ Running on Railway:', process.env.RAILWAY_STATIC_URL);\r\n      console.log('üîó Public URL:', `https://${process.env.RAILWAY_STATIC_URL}`);\r\n    }\r\n    \r\n  } catch (error) {\r\n    console.error('‚ùå Railway deployment failed:', error.message);\r\n    console.error('Stack trace:', error.stack);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤\r\nprocess.on('SIGTERM', async () => {\r\n  console.log('üõë Received SIGTERM, shutting down gracefully...');\r\n  process.exit(0);\r\n});\r\n\r\nprocess.on('SIGINT', async () => {\r\n  console.log('üõë Received SIGINT, shutting down gracefully...');\r\n  process.exit(0);\r\n});\r\n\r\nprocess.on('uncaughtException', (error) => {\r\n  console.error('‚ùå Uncaught Exception:', error);\r\n  process.exit(1);\r\n});\r\n\r\nprocess.on('unhandledRejection', (reason, promise) => {\r\n  console.error('‚ùå Unhandled Rejection at:', promise, 'reason:', reason);\r\n  process.exit(1);\r\n});\r\n\r\n// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\r\nstartRailwayApp();\r\n",
  "services/bunkers/src/index.js": "/**\r\n * VHM24 - VendHub Manager 24/7\r\n * Bunkers Service\r\n * Manages coffee bunkers (machine inventory) for 24/7 vending operations\r\n */\r\n\r\nrequire('dotenv').config({ path: require('path').join(__dirname, '../../../.env') });\r\nconst Fastify = require('fastify');\r\nconst cors = require('@fastify/cors');\r\nconst { getSharedClient } = require('@vhm24/database');\r\n\r\nconst fastify = Fastify({ logger: true });\r\nconst prisma = getSharedClient();\r\n\r\n// Register plugins\r\nfastify.register(cors, { origin: true });\r\n\r\n// Health check\r\nfastify.get('/health', async () => {\r\n  return { \r\n    status: 'ok', \r\n    service: 'bunkers',\r\n    description: 'VHM24 Bunkers Service - 24/7 Operation',\r\n    uptime: process.uptime()\r\n  };\r\n});\r\n\r\n// Get all machine inventory (bunkers) with filters\r\nfastify.get('/api/v1/bunkers', async (request, reply) => {\r\n  try {\r\n    const { machineId, itemId, needsRefill, page = 1, limit = 10 } = request.query;\r\n    \r\n    const where = {};\r\n    if (machineId) where.machineId = machineId;\r\n    if (itemId) where.itemId = itemId;\r\n    \r\n    // Get total count\r\n    const total = await prisma.machineInventory.count({ where });\r\n    \r\n    // Get paginated data\r\n    let bunkers = await prisma.machineInventory.findMany({\r\n      where,\r\n      include: {\r\n        machine: {\r\n          include: {\r\n            location: true\r\n          }\r\n        },\r\n        item: true\r\n      },\r\n      skip: (page - 1) * limit,\r\n      take: parseInt(limit),\r\n      orderBy: [\r\n        { machine: { code: 'asc' } },\r\n        { item: { name: 'asc' } }\r\n      ]\r\n    });\r\n\r\n    // Calculate fill percentage and filter if needed\r\n    bunkers = bunkers.map(bunker => {\r\n      const fillPercentage = bunker.maxQuantity > 0 \r\n        ? (bunker.quantity / bunker.maxQuantity) * 100 \r\n        : 0;\r\n      \r\n      return {\r\n        ...bunker,\r\n        fillPercentage,\r\n        needsRefill: fillPercentage < 20,\r\n        critical: fillPercentage < 10\r\n      };\r\n    });\r\n\r\n    // Filter for bunkers needing refill (–¥–ª—è 24/7 –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞)\r\n    if (needsRefill === 'true') {\r\n      bunkers = bunkers.filter(bunker => bunker.needsRefill);\r\n    }\r\n\r\n    const criticalCount = bunkers.filter(b => b.critical).length;\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        items: bunkers,\r\n        total,\r\n        page: parseInt(page),\r\n        limit: parseInt(limit),\r\n        totalPages: Math.ceil(total / limit),\r\n        criticalCount,\r\n        message: criticalCount > 0 \r\n          ? `‚ö†Ô∏è ${criticalCount} bunkers critically low - 24/7 monitoring active!`\r\n          : '‚úÖ All bunkers operational for 24/7 service'\r\n      }\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    return reply.code(500).send({ error: 'Failed to fetch bunkers' });\r\n  }\r\n});\r\n\r\n// Get bunker details\r\nfastify.get('/api/v1/bunkers/:machineId/:itemId', async (request, reply) => {\r\n  try {\r\n    const { machineId, itemId } = request.params;\r\n    \r\n    const bunker = await prisma.machineInventory.findUnique({\r\n      where: {\r\n        machineId_itemId: {\r\n          machineId,\r\n          itemId\r\n        }\r\n      },\r\n      include: {\r\n        machine: {\r\n          include: {\r\n            location: true\r\n          }\r\n        },\r\n        item: true\r\n      }\r\n    });\r\n\r\n    if (!bunker) {\r\n      return reply.code(404).send({ error: 'Bunker not found' });\r\n    }\r\n\r\n    // Get recent movements\r\n    const recentMovements = await prisma.stockMovement.findMany({\r\n      where: {\r\n        machineId,\r\n        itemId\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n      take: 10,\r\n      include: {\r\n        user: {\r\n          select: {\r\n            name: true,\r\n            email: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    const fillPercentage = bunker.maxQuantity > 0 \r\n      ? (bunker.quantity / bunker.maxQuantity) * 100 \r\n      : 0;\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        ...bunker,\r\n        fillPercentage,\r\n        needsRefill: fillPercentage < 20,\r\n        critical: fillPercentage < 10,\r\n        recentMovements,\r\n        status: fillPercentage < 10 ? 'CRITICAL' : \r\n                fillPercentage < 20 ? 'LOW' : \r\n                fillPercentage < 50 ? 'MEDIUM' : 'GOOD'\r\n      }\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    return reply.code(500).send({ error: 'Failed to fetch bunker details' });\r\n  }\r\n});\r\n\r\n// Refill bunker\r\nfastify.post('/api/v1/bunkers/:machineId/:itemId/refill', async (request, reply) => {\r\n  try {\r\n    const { machineId, itemId } = request.params;\r\n    const { quantity, userId, notes } = request.body;\r\n    \r\n    // Get current bunker state\r\n    const bunker = await prisma.machineInventory.findUnique({\r\n      where: {\r\n        machineId_itemId: {\r\n          machineId,\r\n          itemId\r\n        }\r\n      },\r\n      include: {\r\n        item: true\r\n      }\r\n    });\r\n\r\n    if (!bunker) {\r\n      return reply.code(404).send({ error: 'Bunker not found' });\r\n    }\r\n\r\n    const quantityBefore = bunker.quantity;\r\n    const quantityAfter = Math.min(bunker.quantity + quantity, bunker.maxQuantity || quantity);\r\n    const actualQuantity = quantityAfter - quantityBefore;\r\n\r\n    // Update bunker\r\n    const updatedBunker = await prisma.machineInventory.update({\r\n      where: {\r\n        machineId_itemId: {\r\n          machineId,\r\n          itemId\r\n        }\r\n      },\r\n      data: {\r\n        quantity: quantityAfter,\r\n        lastRefill: new Date()\r\n      }\r\n    });\r\n\r\n    // Record stock movement\r\n    await prisma.stockMovement.create({\r\n      data: {\r\n        itemId,\r\n        userId,\r\n        type: 'IN',\r\n        quantity: actualQuantity,\r\n        quantityBefore,\r\n        quantityAfter,\r\n        reason: `Bunker refill - ${notes || 'Regular 24/7 maintenance'}`,\r\n        machineId\r\n      }\r\n    });\r\n\r\n    // Create service history\r\n    await prisma.serviceHistory.create({\r\n      data: {\r\n        machineId,\r\n        serviceType: 'REFILL',\r\n        description: `Refilled ${bunker.item?.name || 'Item'} - Added ${actualQuantity} ${bunker.item?.unit || 'units'}`,\r\n        performedById: userId,\r\n        performedAt: new Date(),\r\n        metadata: {\r\n          itemId,\r\n          quantityAdded: actualQuantity,\r\n          notes\r\n        }\r\n      }\r\n    });\r\n\r\n    fastify.log.info(`Bunker refilled - Machine: ${machineId}, Item: ${itemId}, Quantity: ${actualQuantity}`);\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        bunker: updatedBunker,\r\n        refillAmount: actualQuantity,\r\n        message: `‚úÖ Bunker refilled successfully - Ready for 24/7 operation`\r\n      }\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    return reply.code(500).send({ error: 'Failed to refill bunker' });\r\n  }\r\n});\r\n\r\n// Get critical bunkers (low level)\r\nfastify.get('/api/v1/bunkers/critical', async (request, reply) => {\r\n  try {\r\n    const bunkers = await prisma.machineInventory.findMany({\r\n      include: {\r\n        machine: {\r\n          include: {\r\n            location: true\r\n          }\r\n        },\r\n        item: true\r\n      }\r\n    });\r\n\r\n    // Filter critical bunkers\r\n    const criticalBunkers = bunkers\r\n      .map(bunker => {\r\n        const fillPercentage = bunker.maxQuantity > 0 \r\n          ? (bunker.quantity / bunker.maxQuantity) * 100 \r\n          : 0;\r\n        \r\n        return {\r\n          ...bunker,\r\n          fillPercentage,\r\n          hoursRemaining: fillPercentage < 20 \r\n            ? Math.round((bunker.quantity / 10) * 24) // Estimate based on average consumption\r\n            : null\r\n        };\r\n      })\r\n      .filter(bunker => bunker.fillPercentage < 20)\r\n      .sort((a, b) => a.fillPercentage - b.fillPercentage);\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        critical: criticalBunkers.filter(b => b.fillPercentage < 10),\r\n        low: criticalBunkers.filter(b => b.fillPercentage >= 10 && b.fillPercentage < 20),\r\n        totalCritical: criticalBunkers.length,\r\n        message: criticalBunkers.length > 0 \r\n          ? `‚ö†Ô∏è ${criticalBunkers.length} bunkers need urgent attention for 24/7 operation!`\r\n          : '‚úÖ All bunkers have sufficient levels for 24/7 operation'\r\n      }\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    return reply.code(500).send({ error: 'Failed to fetch critical bunkers' });\r\n  }\r\n});\r\n\r\n// Bunker consumption report\r\nfastify.get('/api/v1/bunkers/consumption-report', async (request, reply) => {\r\n  try {\r\n    const { machineId, itemId, days = 7 } = request.query;\r\n    \r\n    const startDate = new Date();\r\n    startDate.setDate(startDate.getDate() - days);\r\n    \r\n    const where = {\r\n      type: 'OUT',\r\n      createdAt: { gte: startDate }\r\n    };\r\n    \r\n    if (machineId) where.machineId = machineId;\r\n    if (itemId) where.itemId = itemId;\r\n    \r\n    const movements = await prisma.stockMovement.findMany({\r\n      where,\r\n      include: {\r\n        machine: true,\r\n        item: true\r\n      },\r\n      orderBy: { createdAt: 'desc' }\r\n    });\r\n    \r\n    // Group by machine and item\r\n    const consumption = {};\r\n    movements.forEach(movement => {\r\n      const key = `${movement.machineId}-${movement.itemId}`;\r\n      if (!consumption[key]) {\r\n        consumption[key] = {\r\n          machine: movement.machine,\r\n          item: movement.item,\r\n          totalConsumed: 0,\r\n          movements: []\r\n        };\r\n      }\r\n      consumption[key].totalConsumed += movement.quantity;\r\n      consumption[key].movements.push(movement);\r\n    });\r\n    \r\n    return {\r\n      success: true,\r\n      data: {\r\n        period: `Last ${days} days`,\r\n        startDate,\r\n        endDate: new Date(),\r\n        consumption: Object.values(consumption),\r\n        totalMovements: movements.length\r\n      }\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    return reply.code(500).send({ error: 'Failed to generate consumption report' });\r\n  }\r\n});\r\n\r\n// Start server\r\nconst start = async () => {\r\n  try {\r\n    await fastify.listen({ \r\n      port: process.env.BUNKERS_PORT || 3005,\r\n      host: '0.0.0.0'\r\n    });\r\n    console.log('VHM24 Bunkers Service running 24/7 on port', process.env.BUNKERS_PORT || 3005);\r\n  } catch (err) {\r\n    fastify.log.error(err);\r\n    process.exit(1);\r\n  }\r\n};\r\n\r\nstart();\r\n\r\n// Graceful shutdown\r\nprocess.on('SIGTERM', async () => {\r\n  await fastify.close();\r\n  await prisma.$disconnect();\r\n  process.exit(0);\r\n});\r\n",
  "services/data-import/src/index.js": "const fastify = require('fastify')({ logger: true });\r\nconst path = require('path');\r\nconst fs = require('fs');\r\nconst csv = require('csv-parser');\r\nconst XLSX = require('xlsx');\r\nconst moment = require('moment');\r\n\r\n// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–ª–∞–≥–∏–Ω–æ–≤\r\nfastify.register(require('@fastify/cors'), {\r\n  origin: true,\r\n  credentials: true\r\n});\r\n\r\nfastify.register(require('@fastify/multipart'), {\r\n  limits: {\r\n    fileSize: 100 * 1024 * 1024, // 100MB\r\n  }\r\n});\r\n\r\nfastify.register(require('@fastify/static'), {\r\n  root: path.join(__dirname, '../templates'),\r\n  prefix: '/templates/',\r\n});\r\n\r\n// –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –∑–∞–¥–∞—á –∏–º–ø–æ—Ä—Ç–∞ (–≤ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis/Database)\r\nconst importJobs = new Map();\r\nlet jobIdCounter = 1;\r\n\r\n// –°—Ö–µ–º—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏\r\nconst dataSchemas = {\r\n  SALES: {\r\n    required: ['date', 'time', 'machine_id', 'product_id', 'quantity', 'amount'],\r\n    optional: ['customer_id', 'payment_method', 'discount']\r\n  },\r\n  INVENTORY: {\r\n    required: ['date', 'time', 'item_id', 'quantity', 'location'],\r\n    optional: ['batch_number', 'expiry_date', 'supplier_id']\r\n  },\r\n  MAINTENANCE: {\r\n    required: ['date', 'time', 'machine_id', 'type', 'description', 'technician_id'],\r\n    optional: ['parts_used', 'cost', 'duration', 'next_maintenance']\r\n  },\r\n  ROUTES: {\r\n    required: ['date', 'time', 'driver_id', 'route_name', 'start_location', 'end_location'],\r\n    optional: ['distance', 'duration', 'fuel_consumption', 'stops']\r\n  },\r\n  USERS: {\r\n    required: ['username', 'first_name', 'last_name', 'role', 'created_date'],\r\n    optional: ['email', 'phone', 'telegram_username', 'status']\r\n  },\r\n  TASKS: {\r\n    required: ['date', 'time', 'title', 'type', 'assigned_to', 'status', 'description'],\r\n    optional: ['priority', 'machine_id', 'estimated_duration', 'actual_duration']\r\n  }\r\n};\r\n\r\n// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —à–∞–±–ª–æ–Ω–æ–≤ CSV\r\nconst generateTemplate = (dataType) => {\r\n  const schema = dataSchemas[dataType];\r\n  if (!schema) {\r\n    throw new Error(`Unknown data type: ${dataType}`);\r\n  }\r\n\r\n  const headers = [...schema.required, ...schema.optional];\r\n  const sampleData = generateSampleData(dataType);\r\n  \r\n  let csv = headers.join(',') + '\\n';\r\n  csv += sampleData.map(row => headers.map(header => row[header] || '').join(',')).join('\\n');\r\n  \r\n  return csv;\r\n};\r\n\r\n// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ—Ä–æ–≤ –¥–∞–Ω–Ω—ã—Ö\r\nconst generateSampleData = (dataType) => {\r\n  const baseDate = moment().subtract(30, 'days');\r\n  \r\n  switch (dataType) {\r\n    case 'SALES':\r\n      return [\r\n        {\r\n          date: baseDate.format('YYYY-MM-DD'),\r\n          time: '10:30:00',\r\n          machine_id: 'VM001',\r\n          product_id: 'PROD001',\r\n          quantity: '2',\r\n          amount: '150.00',\r\n          customer_id: 'CUST001',\r\n          payment_method: 'CARD'\r\n        },\r\n        {\r\n          date: baseDate.add(1, 'day').format('YYYY-MM-DD'),\r\n          time: '14:15:00',\r\n          machine_id: 'VM002',\r\n          product_id: 'PROD002',\r\n          quantity: '1',\r\n          amount: '85.00',\r\n          payment_method: 'CASH'\r\n        }\r\n      ];\r\n    \r\n    case 'INVENTORY':\r\n      return [\r\n        {\r\n          date: baseDate.format('YYYY-MM-DD'),\r\n          time: '09:00:00',\r\n          item_id: 'ITEM001',\r\n          quantity: '50',\r\n          location: 'WAREHOUSE_A',\r\n          batch_number: 'BATCH001',\r\n          supplier_id: 'SUP001'\r\n        },\r\n        {\r\n          date: baseDate.add(1, 'day').format('YYYY-MM-DD'),\r\n          time: '16:30:00',\r\n          item_id: 'ITEM002',\r\n          quantity: '25',\r\n          location: 'WAREHOUSE_B',\r\n          batch_number: 'BATCH002'\r\n        }\r\n      ];\r\n    \r\n    case 'MAINTENANCE':\r\n      return [\r\n        {\r\n          date: baseDate.format('YYYY-MM-DD'),\r\n          time: '08:00:00',\r\n          machine_id: 'VM001',\r\n          type: 'PREVENTIVE',\r\n          description: 'Routine maintenance check',\r\n          technician_id: 'TECH001',\r\n          duration: '120',\r\n          cost: '500.00'\r\n        }\r\n      ];\r\n    \r\n    case 'ROUTES':\r\n      return [\r\n        {\r\n          date: baseDate.format('YYYY-MM-DD'),\r\n          time: '07:00:00',\r\n          driver_id: 'DRV001',\r\n          route_name: 'Route A',\r\n          start_location: 'Warehouse',\r\n          end_location: 'Mall District',\r\n          distance: '25.5',\r\n          duration: '180'\r\n        }\r\n      ];\r\n    \r\n    case 'USERS':\r\n      return [\r\n        {\r\n          username: 'john.doe',\r\n          first_name: 'John',\r\n          last_name: 'Doe',\r\n          role: 'OPERATOR',\r\n          created_date: baseDate.format('YYYY-MM-DD'),\r\n          email: 'john.doe@example.com',\r\n          status: 'ACTIVE'\r\n        }\r\n      ];\r\n    \r\n    case 'TASKS':\r\n      return [\r\n        {\r\n          date: baseDate.format('YYYY-MM-DD'),\r\n          time: '09:00:00',\r\n          title: 'Refill Machine VM001',\r\n          type: 'REFILL',\r\n          assigned_to: 'TECH001',\r\n          status: 'COMPLETED',\r\n          description: 'Refill products in machine VM001',\r\n          priority: 'HIGH',\r\n          estimated_duration: '60'\r\n        }\r\n      ];\r\n    \r\n    default:\r\n      return [];\r\n  }\r\n};\r\n\r\n// –ü–∞—Ä—Å–∏–Ω–≥ —Ñ–∞–π–ª–æ–≤\r\nconst parseFile = async (filePath, dataType) => {\r\n  const ext = path.extname(filePath).toLowerCase();\r\n  let data = [];\r\n\r\n  try {\r\n    if (ext === '.csv') {\r\n      data = await parseCSV(filePath);\r\n    } else if (ext === '.xlsx' || ext === '.xls') {\r\n      data = await parseExcel(filePath);\r\n    } else if (ext === '.json') {\r\n      data = await parseJSON(filePath);\r\n    } else {\r\n      throw new Error(`Unsupported file format: ${ext}`);\r\n    }\r\n\r\n    // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö\r\n    const validationResult = validateData(data, dataType);\r\n    return validationResult;\r\n  } catch (error) {\r\n    throw new Error(`Error parsing file: ${error.message}`);\r\n  }\r\n};\r\n\r\nconst parseCSV = (filePath) => {\r\n  return new Promise((resolve, reject) => {\r\n    const results = [];\r\n    fs.createReadStream(filePath)\r\n      .pipe(csv())\r\n      .on('data', (data) => results.push(data))\r\n      .on('end', () => resolve(results))\r\n      .on('error', reject);\r\n  });\r\n};\r\n\r\nconst parseExcel = (filePath) => {\r\n  const workbook = XLSX.readFile(filePath);\r\n  const sheetName = workbook.SheetNames[0];\r\n  const worksheet = workbook.Sheets[sheetName];\r\n  return XLSX.utils.sheet_to_json(worksheet);\r\n};\r\n\r\nconst parseJSON = (filePath) => {\r\n  const content = fs.readFileSync(filePath, 'utf8');\r\n  return JSON.parse(content);\r\n};\r\n\r\n// –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö\r\nconst validateData = (data, dataType) => {\r\n  const schema = dataSchemas[dataType];\r\n  const errors = [];\r\n  const validRecords = [];\r\n\r\n  data.forEach((record, index) => {\r\n    const recordErrors = [];\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π\r\n    schema.required.forEach(field => {\r\n      if (!record[field] || record[field].toString().trim() === '') {\r\n        recordErrors.push(`Missing required field: ${field}`);\r\n      }\r\n    });\r\n\r\n    // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏\r\n    if (record.date && !moment(record.date, 'YYYY-MM-DD', true).isValid()) {\r\n      recordErrors.push(`Invalid date format: ${record.date}. Expected: YYYY-MM-DD`);\r\n    }\r\n    \r\n    if (record.time && !moment(record.time, 'HH:mm:ss', true).isValid()) {\r\n      recordErrors.push(`Invalid time format: ${record.time}. Expected: HH:mm:ss`);\r\n    }\r\n\r\n    // –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ —Ç–∏–ø—É –¥–∞–Ω–Ω—ã—Ö\r\n    if (dataType === 'SALES') {\r\n      if (record.amount && isNaN(parseFloat(record.amount))) {\r\n        recordErrors.push(`Invalid amount: ${record.amount}`);\r\n      }\r\n      if (record.quantity && isNaN(parseInt(record.quantity))) {\r\n        recordErrors.push(`Invalid quantity: ${record.quantity}`);\r\n      }\r\n    }\r\n\r\n    if (recordErrors.length > 0) {\r\n      errors.push(`Row ${index + 1}: ${recordErrors.join(', ')}`);\r\n    } else {\r\n      validRecords.push({\r\n        ...record,\r\n        originalIndex: index + 1,\r\n        importedAt: new Date().toISOString()\r\n      });\r\n    }\r\n  });\r\n\r\n  return {\r\n    totalRecords: data.length,\r\n    validRecords,\r\n    errorRecords: errors.length,\r\n    errors\r\n  };\r\n};\r\n\r\n// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–º–ø–æ—Ä—Ç–∞\r\nconst processImport = async (jobId) => {\r\n  const job = importJobs.get(jobId);\r\n  if (!job) return;\r\n\r\n  try {\r\n    job.status = 'PROCESSING';\r\n    job.startedAt = new Date().toISOString();\r\n\r\n    const result = await parseFile(job.filePath, job.dataType);\r\n    \r\n    // –°–∏–º—É–ª—è—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø–∏—Å–µ–π\r\n    for (let i = 0; i < result.validRecords.length; i++) {\r\n      // –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\r\n      await new Promise(resolve => setTimeout(resolve, 100)); // –°–∏–º—É–ª—è—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏\r\n      job.processedRecords = i + 1;\r\n    }\r\n\r\n    job.status = 'COMPLETED';\r\n    job.completedAt = new Date().toISOString();\r\n    job.totalRecords = result.totalRecords;\r\n    job.errorRecords = result.errorRecords;\r\n    job.errors = result.errors;\r\n\r\n    // –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞\r\n    fs.unlinkSync(job.filePath);\r\n    \r\n  } catch (error) {\r\n    job.status = 'FAILED';\r\n    job.errors = [error.message];\r\n    job.completedAt = new Date().toISOString();\r\n  }\r\n};\r\n\r\n// API Routes\r\n\r\n// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á –∏–º–ø–æ—Ä—Ç–∞\r\nfastify.get('/api/v1/data-import/jobs', async (request, reply) => {\r\n  const jobs = Array.from(importJobs.values()).sort((a, b) => \r\n    new Date(b.createdAt) - new Date(a.createdAt)\r\n  );\r\n  \r\n  return {\r\n    success: true,\r\n    data: jobs\r\n  };\r\n});\r\n\r\n// –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö\r\nfastify.get('/api/v1/data-import/historical', async (request, reply) => {\r\n  // –í production –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö\r\n  return {\r\n    success: true,\r\n    data: []\r\n  };\r\n});\r\n\r\n// –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–∞\r\nfastify.post('/api/v1/data-import/preview', async (request, reply) => {\r\n  try {\r\n    const data = await request.file();\r\n    const dataType = request.body?.dataType || 'SALES';\r\n    \r\n    if (!data) {\r\n      return reply.code(400).send({\r\n        success: false,\r\n        error: 'No file uploaded'\r\n      });\r\n    }\r\n\r\n    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞\r\n    const tempPath = path.join(__dirname, '../temp', `preview_${Date.now()}_${data.filename}`);\r\n    await data.file.pipe(fs.createWriteStream(tempPath));\r\n\r\n    // –ü–∞—Ä—Å–∏–Ω–≥ –ø–µ—Ä–≤—ã—Ö 10 –∑–∞–ø–∏—Å–µ–π –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞\r\n    const result = await parseFile(tempPath, dataType);\r\n    const preview = result.validRecords.slice(0, 10);\r\n\r\n    // –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞\r\n    fs.unlinkSync(tempPath);\r\n\r\n    return {\r\n      success: true,\r\n      preview,\r\n      totalRecords: result.totalRecords,\r\n      errors: result.errors.slice(0, 5) // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 5 –æ—à–∏–±–æ–∫\r\n    };\r\n  } catch (error) {\r\n    return reply.code(500).send({\r\n      success: false,\r\n      error: error.message\r\n    });\r\n  }\r\n});\r\n\r\n// –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞\r\nfastify.post('/api/v1/data-import/upload', async (request, reply) => {\r\n  try {\r\n    const data = await request.file();\r\n    const { dataType, startDate, endDate } = request.body;\r\n    \r\n    if (!data) {\r\n      return reply.code(400).send({\r\n        success: false,\r\n        error: 'No file uploaded'\r\n      });\r\n    }\r\n\r\n    // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –∏–º–ø–æ—Ä—Ç–∞\r\n    const jobId = jobIdCounter++;\r\n    const tempPath = path.join(__dirname, '../temp', `import_${jobId}_${data.filename}`);\r\n    \r\n    // –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ temp –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç\r\n    const tempDir = path.dirname(tempPath);\r\n    if (!fs.existsSync(tempDir)) {\r\n      fs.mkdirSync(tempDir, { recursive: true });\r\n    }\r\n\r\n    await data.file.pipe(fs.createWriteStream(tempPath));\r\n\r\n    const job = {\r\n      id: jobId,\r\n      fileName: data.filename,\r\n      fileSize: fs.statSync(tempPath).size,\r\n      dataType,\r\n      status: 'PENDING',\r\n      totalRecords: 0,\r\n      processedRecords: 0,\r\n      errorRecords: 0,\r\n      startDate,\r\n      endDate,\r\n      createdAt: new Date().toISOString(),\r\n      filePath: tempPath,\r\n      errors: []\r\n    };\r\n\r\n    importJobs.set(jobId, job);\r\n\r\n    // –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ —Ñ–æ–Ω–µ\r\n    setImmediate(() => processImport(jobId));\r\n\r\n    return {\r\n      success: true,\r\n      job: {\r\n        id: job.id,\r\n        fileName: job.fileName,\r\n        fileSize: job.fileSize,\r\n        dataType: job.dataType,\r\n        status: job.status,\r\n        createdAt: job.createdAt\r\n      }\r\n    };\r\n  } catch (error) {\r\n    return reply.code(500).send({\r\n      success: false,\r\n      error: error.message\r\n    });\r\n  }\r\n});\r\n\r\n// –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞\r\nfastify.get('/api/v1/data-import/template/:dataType', async (request, reply) => {\r\n  try {\r\n    const { dataType } = request.params;\r\n    \r\n    if (!dataSchemas[dataType]) {\r\n      return reply.code(400).send({\r\n        success: false,\r\n        error: `Unknown data type: ${dataType}`\r\n      });\r\n    }\r\n\r\n    const template = generateTemplate(dataType);\r\n    \r\n    reply\r\n      .header('Content-Type', 'text/csv')\r\n      .header('Content-Disposition', `attachment; filename=\"${dataType.toLowerCase()}_template.csv\"`)\r\n      .send(template);\r\n  } catch (error) {\r\n    return reply.code(500).send({\r\n      success: false,\r\n      error: error.message\r\n    });\r\n  }\r\n});\r\n\r\n// –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –∑–∞–¥–∞—á–∏\r\nfastify.get('/api/v1/data-import/jobs/:jobId', async (request, reply) => {\r\n  const { jobId } = request.params;\r\n  const job = importJobs.get(parseInt(jobId));\r\n  \r\n  if (!job) {\r\n    return reply.code(404).send({\r\n      success: false,\r\n      error: 'Job not found'\r\n    });\r\n  }\r\n\r\n  return {\r\n    success: true,\r\n    data: job\r\n  };\r\n});\r\n\r\n// Health check\r\nfastify.get('/health', async (request, reply) => {\r\n  return { status: 'ok', service: 'data-import', timestamp: new Date().toISOString() };\r\n});\r\n\r\n// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞\r\nconst start = async () => {\r\n  try {\r\n    const port = process.env.PORT || 3009;\r\n    const host = process.env.HOST || '0.0.0.0';\r\n    \r\n    await fastify.listen({ port, host });\r\n    console.log(`üöÄ Data Import Service running on http://${host}:${port}`);\r\n  } catch (err) {\r\n    fastify.log.error(err);\r\n    process.exit(1);\r\n  }\r\n};\r\n\r\nstart();\r\n",
  "fix-prisma-imports.js": "/**\r\n * VHM24 - Fix Prisma Imports Script\r\n * Replaces direct @prisma/client imports with centralized database clients\r\n */\r\n\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\n// Service to client mapping\r\nconst serviceClientMap = {\r\n  'auth': 'getAuthClient',\r\n  'machines': 'getMachinesClient',\r\n  'inventory': 'getInventoryClient',\r\n  'tasks': 'getTasksClient',\r\n  'bunkers': 'getSharedClient', // Bunkers uses shared client\r\n  'gateway': 'getPrismaClient', // Gateway uses main client\r\n  'telegram-bot': 'getPrismaClient' // Bot uses main client\r\n};\r\n\r\n// Files to check and fix\r\nconst servicePaths = [\r\n  'services/machines/src/index.js',\r\n  'services/inventory/src/index.js',\r\n  'services/tasks/src/index.js',\r\n  'services/bunkers/src/index.js',\r\n  'services/telegram-bot/src/index.js',\r\n  'services/telegram-bot/src/handlers/inventoryHandler.js',\r\n  'services/telegram-bot/src/handlers/machinesHandler.js',\r\n  'services/telegram-bot/src/handlers/tasksHandler.js',\r\n  'services/telegram-bot/src/handlers/reportsHandler.js',\r\n  'services/telegram-bot/src/utils/auth.js'\r\n];\r\n\r\nconsole.log('üîß Fixing Prisma imports in VHM24 services...\\n');\r\n\r\nlet fixedCount = 0;\r\nlet errorCount = 0;\r\n\r\nservicePaths.forEach(filePath => {\r\n  if (!fs.existsSync(filePath)) {\r\n    console.log(`‚è≠Ô∏è  Skipped (not found): ${filePath}`);\r\n    return;\r\n  }\r\n  \r\n  try {\r\n    let content = fs.readFileSync(filePath, 'utf8');\r\n    const originalContent = content;\r\n    \r\n    // Determine which client to use based on service\r\n    const serviceName = filePath.split('/')[1];\r\n    const clientFunction = serviceClientMap[serviceName] || 'getPrismaClient';\r\n    \r\n    // Pattern to match Prisma imports\r\n    const prismaImportPattern = /const\\s*{\\s*PrismaClient\\s*}\\s*=\\s*require\\s*\\(\\s*['\"]@prisma\\/client['\"]\\s*\\)\\s*;?\\s*\\n\\s*const\\s+(\\w+)\\s*=\\s*new\\s+PrismaClient\\s*\\(\\s*\\)\\s*;?/g;\r\n    const simplePrismaPattern = /const\\s+(\\w+)\\s*=\\s*new\\s+PrismaClient\\s*\\(\\s*\\)\\s*;?/g;\r\n    \r\n    // Check if file has direct Prisma import\r\n    if (content.includes('@prisma/client') || content.includes('new PrismaClient')) {\r\n      // Replace the import and instantiation\r\n      content = content.replace(prismaImportPattern, (match, varName) => {\r\n        return `const { ${clientFunction} } = require('@vhm24/database');\\nconst ${varName} = ${clientFunction}();`;\r\n      });\r\n      \r\n      // Also handle cases where PrismaClient might be imported elsewhere\r\n      if (content.includes(\"require('@prisma/client')\")) {\r\n        content = content.replace(\r\n          /const\\s*{\\s*PrismaClient\\s*}\\s*=\\s*require\\s*\\(\\s*['\"]@prisma\\/client['\"]\\s*\\)\\s*;?/g,\r\n          `const { ${clientFunction} } = require('@vhm24/database');`\r\n        );\r\n        \r\n        content = content.replace(simplePrismaPattern, (match, varName) => {\r\n          return `const ${varName} = ${clientFunction}();`;\r\n        });\r\n      }\r\n      \r\n      // If content changed, write it back\r\n      if (content !== originalContent) {\r\n        fs.writeFileSync(filePath, content, 'utf8');\r\n        console.log(`‚úÖ Fixed: ${filePath} (using ${clientFunction})`);\r\n        fixedCount++;\r\n      } else {\r\n        console.log(`‚ÑπÔ∏è  Already fixed or no changes needed: ${filePath}`);\r\n      }\r\n    } else {\r\n      console.log(`‚úì No Prisma imports found: ${filePath}`);\r\n    }\r\n  } catch (error) {\r\n    console.error(`‚ùå Error processing ${filePath}: ${error.message}`);\r\n    errorCount++;\r\n  }\r\n});\r\n\r\nconsole.log('\\nüìä Summary:');\r\nconsole.log(`- Files fixed: ${fixedCount}`);\r\nconsole.log(`- Errors: ${errorCount}`);\r\nconsole.log(`- Total files checked: ${servicePaths.length}`);\r\n\r\nif (fixedCount > 0) {\r\n  console.log('\\n‚ö†Ô∏è  Important: Make sure to run \"npm install\" in the root directory to ensure all dependencies are installed.');\r\n}\r\n\r\nconsole.log('\\n‚ú® Prisma import fix complete!');\r\n",
  "services/inventory/src/index.js": "require('dotenv').config({ path: require('path').join(__dirname, '../../../.env') });\r\nconst Fastify = require('fastify');\r\nconst cors = require('@fastify/cors');\r\nconst jwt = require('@fastify/jwt');\r\nconst { getInventoryClient } = require('@vhm24/database');\nconst prisma = getInventoryClient();\r\nconst fastify = Fastify({ logger: true });\r\n\r\n// Plugins\r\nfastify.register(cors, {\r\n  origin: true,\r\n  credentials: true\r\n});\r\n\r\nfastify.register(jwt, {\r\n  secret: process.env.JWT_SECRET || 'your-secret-key'\r\n});\r\n\r\n// –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏\r\nfastify.decorate('authenticate', async function(request, reply) {\r\n  try {\r\n    await request.jwtVerify();\r\n    const user = await prisma.user.findUnique({\r\n      where: { id: request.user.id },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        name: true,\r\n        roles: true,\r\n        isActive: true\r\n      }\r\n    });\r\n    \r\n    if (!user || !user.isActive) {\r\n      throw new Error('User not found or inactive');\r\n    }\r\n    \r\n    request.user = user;\r\n  } catch (err) {\r\n    reply.code(401).send({ \r\n      success: false,\r\n      error: 'Unauthorized',\r\n      message: err.message || 'Invalid or expired token'\r\n    });\r\n  }\r\n});\r\n\r\n// Health check\r\nfastify.get('/health', async (request, reply) => {\r\n  return { status: 'ok', service: 'inventory' };\r\n});\r\n\r\n// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã/–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã\r\nfastify.get('/api/v1/inventory/items', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    querystring: {\r\n      type: 'object',\r\n      properties: {\r\n        category: { type: 'string' },\r\n        search: { type: 'string' },\r\n        inStock: { type: 'boolean' },\r\n        skip: { type: 'integer', minimum: 0, default: 0 },\r\n        take: { type: 'integer', minimum: 1, maximum: 100, default: 20 }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { category, search, inStock, skip, take } = request.query;\r\n  \r\n  try {\r\n    const where = {};\r\n    \r\n    if (category) where.category = category;\r\n    if (search) {\r\n      where.OR = [\r\n        { name: { contains: search, mode: 'insensitive' } },\r\n        { sku: { contains: search, mode: 'insensitive' } }\r\n      ];\r\n    }\r\n    if (inStock !== undefined) {\r\n      where.quantity = inStock ? { gt: 0 } : { lte: 0 };\r\n    }\r\n\r\n    const [items, total] = await Promise.all([\r\n      prisma.inventoryItem.findMany({\r\n        where,\r\n        skip,\r\n        take,\r\n        orderBy: { name: 'asc' },\r\n        include: {\r\n          stockMovements: {\r\n            take: 5,\r\n            orderBy: { createdAt: 'desc' }\r\n          }\r\n        }\r\n      }),\r\n      prisma.inventoryItem.count({ where })\r\n    ]);\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        items,\r\n        total,\r\n        skip,\r\n        take\r\n      }\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to fetch inventory items'\r\n    });\r\n  }\r\n});\r\n\r\n// –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–≤–∞—Ä –ø–æ ID\r\nfastify.get('/api/v1/inventory/items/:id', {\r\n  preValidation: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  const { id } = request.params;\r\n  \r\n  try {\r\n    const item = await prisma.inventoryItem.findUnique({\r\n      where: { id },\r\n      include: {\r\n        stockMovements: {\r\n          orderBy: { createdAt: 'desc' },\r\n          include: {\r\n            user: {\r\n              select: {\r\n                id: true,\r\n                name: true,\r\n                email: true\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!item) {\r\n      return reply.code(404).send({\r\n        success: false,\r\n        error: 'Item not found'\r\n      });\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      data: item\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to fetch item'\r\n    });\r\n  }\r\n});\r\n\r\n// –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä\r\nfastify.post('/api/v1/inventory/items', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    body: {\r\n      type: 'object',\r\n      required: ['name', 'sku', 'unit', 'category'],\r\n      properties: {\r\n        name: { type: 'string', minLength: 1 },\r\n        sku: { type: 'string', minLength: 1 },\r\n        unit: { type: 'string', enum: ['KG', 'L', 'PCS', 'PACK'] },\r\n        category: { type: 'string' },\r\n        description: { type: 'string' },\r\n        minQuantity: { type: 'number', minimum: 0 },\r\n        maxQuantity: { type: 'number', minimum: 0 },\r\n        price: { type: 'number', minimum: 0 }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const data = request.body;\r\n  \r\n  try {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å SKU\r\n    const existing = await prisma.inventoryItem.findUnique({\r\n      where: { sku: data.sku }\r\n    });\r\n\r\n    if (existing) {\r\n      return reply.code(400).send({\r\n        success: false,\r\n        error: 'SKU already exists'\r\n      });\r\n    }\r\n\r\n    const item = await prisma.inventoryItem.create({\r\n      data: {\r\n        ...data,\r\n        quantity: 0, // –ù–∞—á–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Å–µ–≥–¥–∞ 0\r\n        lastUpdated: new Date()\r\n      }\r\n    });\r\n\r\n    return {\r\n      success: true,\r\n      data: item\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to create item'\r\n    });\r\n  }\r\n});\r\n\r\n// –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä\r\nfastify.patch('/api/v1/inventory/items/:id', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    params: {\r\n      type: 'object',\r\n      properties: {\r\n        id: { type: 'string' }\r\n      }\r\n    },\r\n    body: {\r\n      type: 'object',\r\n      properties: {\r\n        name: { type: 'string', minLength: 1 },\r\n        description: { type: 'string' },\r\n        minQuantity: { type: 'number', minimum: 0 },\r\n        maxQuantity: { type: 'number', minimum: 0 },\r\n        price: { type: 'number', minimum: 0 }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { id } = request.params;\r\n  const updates = request.body;\r\n  \r\n  try {\r\n    const item = await prisma.inventoryItem.update({\r\n      where: { id },\r\n      data: {\r\n        ...updates,\r\n        lastUpdated: new Date()\r\n      }\r\n    });\r\n\r\n    return {\r\n      success: true,\r\n      data: item\r\n    };\r\n  } catch (error) {\r\n    if (error.code === 'P2025') {\r\n      return reply.code(404).send({\r\n        success: false,\r\n        error: 'Item not found'\r\n      });\r\n    }\r\n    \r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to update item'\r\n    });\r\n  }\r\n});\r\n\r\n// –î–≤–∏–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (–ø—Ä–∏—Ö–æ–¥/—Ä–∞—Å—Ö–æ–¥)\r\nfastify.post('/api/v1/inventory/stock-movement', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    body: {\r\n      type: 'object',\r\n      required: ['itemId', 'type', 'quantity', 'reason'],\r\n      properties: {\r\n        itemId: { type: 'string' },\r\n        type: { type: 'string', enum: ['IN', 'OUT', 'ADJUSTMENT', 'TRANSFER'] },\r\n        quantity: { type: 'number', minimum: 0.01 },\r\n        reason: { type: 'string', minLength: 1 },\r\n        reference: { type: 'string' },\r\n        fromLocation: { type: 'string' },\r\n        toLocation: { type: 'string' },\r\n        machineId: { type: 'string' }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { itemId, type, quantity, reason, reference, fromLocation, toLocation, machineId } = request.body;\r\n  const userId = request.user.id;\r\n  \r\n  try {\r\n    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ç–æ–≤–∞—Ä\r\n    const item = await prisma.inventoryItem.findUnique({\r\n      where: { id: itemId }\r\n    });\r\n\r\n    if (!item) {\r\n      return reply.code(404).send({\r\n        success: false,\r\n        error: 'Item not found'\r\n      });\r\n    }\r\n\r\n    // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ\r\n    let newQuantity = item.quantity;\r\n    if (type === 'IN') {\r\n      newQuantity += quantity;\r\n    } else if (type === 'OUT') {\r\n      newQuantity -= quantity;\r\n      if (newQuantity < 0) {\r\n        return reply.code(400).send({\r\n          success: false,\r\n          error: 'Insufficient stock'\r\n        });\r\n      }\r\n    }\r\n\r\n    // –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é\r\n    const [movement, updatedItem] = await prisma.$transaction([\r\n      prisma.stockMovement.create({\r\n        data: {\r\n          itemId,\r\n          userId,\r\n          type,\r\n          quantity,\r\n          quantityBefore: item.quantity,\r\n          quantityAfter: newQuantity,\r\n          reason,\r\n          reference,\r\n          fromLocation,\r\n          toLocation,\r\n          machineId\r\n        }\r\n      }),\r\n      prisma.inventoryItem.update({\r\n        where: { id: itemId },\r\n        data: {\r\n          quantity: newQuantity,\r\n          lastUpdated: new Date()\r\n        }\r\n      })\r\n    ]);\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        movement,\r\n        item: updatedItem\r\n      }\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to process stock movement'\r\n    });\r\n  }\r\n});\r\n\r\n// –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–≤–∏–∂–µ–Ω–∏–π\r\nfastify.get('/api/v1/inventory/movements', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    querystring: {\r\n      type: 'object',\r\n      properties: {\r\n        itemId: { type: 'string' },\r\n        type: { type: 'string', enum: ['IN', 'OUT', 'ADJUSTMENT', 'TRANSFER'] },\r\n        machineId: { type: 'string' },\r\n        dateFrom: { type: 'string', format: 'date' },\r\n        dateTo: { type: 'string', format: 'date' },\r\n        skip: { type: 'integer', minimum: 0, default: 0 },\r\n        take: { type: 'integer', minimum: 1, maximum: 100, default: 20 }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { itemId, type, machineId, dateFrom, dateTo, skip, take } = request.query;\r\n  \r\n  try {\r\n    const where = {};\r\n    \r\n    if (itemId) where.itemId = itemId;\r\n    if (type) where.type = type;\r\n    if (machineId) where.machineId = machineId;\r\n    \r\n    if (dateFrom || dateTo) {\r\n      where.createdAt = {};\r\n      if (dateFrom) where.createdAt.gte = new Date(dateFrom);\r\n      if (dateTo) where.createdAt.lte = new Date(dateTo);\r\n    }\r\n\r\n    const [movements, total] = await Promise.all([\r\n      prisma.stockMovement.findMany({\r\n        where,\r\n        skip,\r\n        take,\r\n        orderBy: { createdAt: 'desc' },\r\n        include: {\r\n          item: true,\r\n          user: {\r\n            select: {\r\n              id: true,\r\n              name: true,\r\n              email: true\r\n            }\r\n          },\r\n          machine: {\r\n            select: {\r\n              id: true,\r\n              code: true,\r\n              name: true\r\n            }\r\n          }\r\n        }\r\n      }),\r\n      prisma.stockMovement.count({ where })\r\n    ]);\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        movements,\r\n        total,\r\n        skip,\r\n        take\r\n      }\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to fetch movements'\r\n    });\r\n  }\r\n});\r\n\r\n// –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–≤–∞—Ä—ã —Å –Ω–∏–∑–∫–∏–º –æ—Å—Ç–∞—Ç–∫–æ–º\r\nfastify.get('/api/v1/inventory/low-stock', {\r\n  preValidation: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    const items = await prisma.inventoryItem.findMany({\r\n      where: {\r\n        OR: [\r\n          {\r\n            AND: [\r\n              { minQuantity: { not: null } },\r\n              { quantity: { lte: prisma.inventoryItem.fields.minQuantity } }\r\n            ]\r\n          }\r\n        ]\r\n      },\r\n      orderBy: { quantity: 'asc' }\r\n    });\r\n\r\n    return {\r\n      success: true,\r\n      data: items\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to fetch low stock items'\r\n    });\r\n  }\r\n});\r\n\r\n// –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è\r\nfastify.get('/api/v1/inventory/stats', {\r\n  preValidation: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    const [\r\n      totalItems,\r\n      totalValue,\r\n      lowStockCount,\r\n      outOfStockCount,\r\n      categories\r\n    ] = await Promise.all([\r\n      prisma.inventoryItem.count(),\r\n      prisma.inventoryItem.aggregate({\r\n        _sum: {\r\n          quantity: true,\r\n          price: true\r\n        }\r\n      }),\r\n      prisma.inventoryItem.count({\r\n        where: {\r\n          AND: [\r\n            { minQuantity: { not: null } },\r\n            { quantity: { lte: prisma.inventoryItem.fields.minQuantity } }\r\n          ]\r\n        }\r\n      }),\r\n      prisma.inventoryItem.count({\r\n        where: { quantity: 0 }\r\n      }),\r\n      prisma.inventoryItem.groupBy({\r\n        by: ['category'],\r\n        _count: true\r\n      })\r\n    ]);\r\n\r\n    // –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å\r\n    const totalValueAmount = totalValue._sum.quantity * (totalValue._sum.price || 0);\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        totalItems,\r\n        totalValue: totalValueAmount,\r\n        lowStockCount,\r\n        outOfStockCount,\r\n        categoriesCount: categories.length,\r\n        categories: categories.map(c => ({\r\n          name: c.category,\r\n          count: c._count\r\n        }))\r\n      }\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to fetch statistics'\r\n    });\r\n  }\r\n});\r\n\r\n// –ú–∞—Å—Å–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ (–¥–ª—è –∏–º–ø–æ—Ä—Ç–∞)\r\nfastify.post('/api/v1/inventory/bulk-import', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    body: {\r\n      type: 'object',\r\n      required: ['items'],\r\n      properties: {\r\n        items: {\r\n          type: 'array',\r\n          items: {\r\n            type: 'object',\r\n            required: ['name', 'sku', 'unit', 'category'],\r\n            properties: {\r\n              name: { type: 'string' },\r\n              sku: { type: 'string' },\r\n              unit: { type: 'string', enum: ['KG', 'L', 'PCS', 'PACK'] },\r\n              category: { type: 'string' },\r\n              quantity: { type: 'number', minimum: 0 },\r\n              price: { type: 'number', minimum: 0 }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { items } = request.body;\r\n  \r\n  try {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã SKU\r\n    const skus = items.map(item => item.sku);\r\n    const existingItems = await prisma.inventoryItem.findMany({\r\n      where: { sku: { in: skus } },\r\n      select: { sku: true }\r\n    });\r\n\r\n    if (existingItems.length > 0) {\r\n      return reply.code(400).send({\r\n        success: false,\r\n        error: 'Duplicate SKUs found',\r\n        duplicates: existingItems.map(i => i.sku)\r\n      });\r\n    }\r\n\r\n    // –°–æ–∑–¥–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã\r\n    const createdItems = await prisma.inventoryItem.createMany({\r\n      data: items.map(item => ({\r\n        ...item,\r\n        quantity: item.quantity || 0,\r\n        lastUpdated: new Date()\r\n      }))\r\n    });\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        created: createdItems.count\r\n      }\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to import items'\r\n    });\r\n  }\r\n});\r\n\r\n// Start server\r\nconst start = async () => {\r\n  try {\r\n    await fastify.listen({ \r\n      port: process.env.PORT || 3003,\r\n      host: '0.0.0.0'\r\n    });\r\n    console.log('Inventory service is running on port', process.env.PORT || 3003);\r\n  } catch (err) {\r\n    fastify.log.error(err);\r\n    process.exit(1);\r\n  }\r\n};\r\n\r\nstart();\r\n\r\n// Graceful shutdown\r\nprocess.on('SIGTERM', async () => {\r\n  await fastify.close();\r\n  await prisma.$disconnect();\r\n  process.exit(0);\r\n});\r\n",
  "services/backup/src/index.js": "/**\r\n * VHM24 - VendHub Manager 24/7\r\n * Backup Service\r\n * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö\r\n */\r\n\r\nrequire('dotenv').config({ path: require('path').join(__dirname, '../../../.env') });\r\nconst Fastify = require('fastify');\r\nconst cors = require('@fastify/cors');\r\nconst jwt = require('@fastify/jwt');\r\nconst cron = require('node-cron');\r\nconst { exec } = require('child_process');\r\nconst { promisify } = require('util');\r\nconst fs = require('fs').promises;\r\nconst path = require('path');\r\nconst archiver = require('archiver');\r\nconst AWS = require('aws-sdk');\r\n\r\nconst execAsync = promisify(exec);\r\nconst fastify = Fastify({ \r\n  logger: true,\r\n  trustProxy: true\r\n});\r\n\r\n// –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\nif (!process.env.JWT_SECRET) {\r\n  throw new Error('JWT_SECRET must be set in environment variables');\r\n}\r\n\r\n// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ S3 –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –±—ç–∫–∞–ø–æ–≤\r\nlet s3 = null;\r\nif (process.env.AWS_ACCESS_KEY_ID && process.env.AWS_SECRET_ACCESS_KEY) {\r\n  s3 = new AWS.S3({\r\n    accessKeyId: process.env.AWS_ACCESS_KEY_ID,\r\n    secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY,\r\n    region: process.env.AWS_REGION || 'us-east-1'\r\n  });\r\n}\r\n\r\n// CORS\r\nfastify.register(cors, {\r\n  origin: (origin, cb) => {\r\n    const allowedOrigins = process.env.ALLOWED_ORIGINS?.split(',') || ['http://localhost:3000'];\r\n    if (!origin || allowedOrigins.includes(origin)) {\r\n      cb(null, true);\r\n    } else {\r\n      cb(new Error('Not allowed by CORS'));\r\n    }\r\n  },\r\n  credentials: true\r\n});\r\n\r\n// JWT\r\nfastify.register(jwt, {\r\n  secret: process.env.JWT_SECRET,\r\n  verify: {\r\n    issuer: ['vhm24-gateway', 'vhm24-auth']\r\n  }\r\n});\r\n\r\n// –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏\r\nfastify.decorate('authenticate', async function(request, reply) {\r\n  try {\r\n    await request.jwtVerify();\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä\r\n    if (!request.user.roles || !request.user.roles.includes('ADMIN')) {\r\n      throw new Error('Admin access required');\r\n    }\r\n  } catch (err) {\r\n    reply.code(401).send({ \r\n      success: false,\r\n      error: 'Unauthorized',\r\n      message: err.message || 'Invalid or expired token'\r\n    });\r\n  }\r\n});\r\n\r\n// Health check\r\nfastify.get('/health', async (request, reply) => {\r\n  return { \r\n    status: 'ok', \r\n    service: 'backup',\r\n    storage: {\r\n      s3: s3 ? 'configured' : 'not configured',\r\n      local: 'available'\r\n    },\r\n    schedule: process.env.BACKUP_SCHEDULE || '0 2 * * *'\r\n  };\r\n});\r\n\r\n// –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\r\nasync function createDatabaseBackup() {\r\n  const timestamp = new Date().toISOString().replace(/[:.]/g, '-');\r\n  const backupDir = path.join(process.cwd(), 'backups');\r\n  const backupFile = `vhm24-db-backup-${timestamp}.sql`;\r\n  const backupPath = path.join(backupDir, backupFile);\r\n  \r\n  try {\r\n    // –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±—ç–∫–∞–ø–æ–≤\r\n    await fs.mkdir(backupDir, { recursive: true });\r\n    \r\n    // –ü–∞—Ä—Å–∏–º DATABASE_URL\r\n    const dbUrl = new URL(process.env.DATABASE_URL);\r\n    const [username, password] = dbUrl.username ? [dbUrl.username, dbUrl.password] : ['', ''];\r\n    const hostname = dbUrl.hostname;\r\n    const port = dbUrl.port || 5432;\r\n    const database = dbUrl.pathname.slice(1);\r\n    \r\n    // –°–æ–∑–¥–∞–µ–º –¥–∞–º–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\r\n    const pgDumpCommand = `PGPASSWORD=\"${password}\" pg_dump -h ${hostname} -p ${port} -U ${username} -d ${database} -f ${backupPath}`;\r\n    \r\n    await execAsync(pgDumpCommand);\r\n    \r\n    // –°–∂–∏–º–∞–µ–º –±—ç–∫–∞–ø\r\n    const zipPath = `${backupPath}.zip`;\r\n    const output = await fs.open(zipPath, 'w');\r\n    const archive = archiver('zip', { zlib: { level: 9 } });\r\n    \r\n    archive.pipe(output);\r\n    archive.file(backupPath, { name: backupFile });\r\n    await archive.finalize();\r\n    \r\n    // –£–¥–∞–ª—è–µ–º –Ω–µ—Å–∂–∞—Ç—ã–π —Ñ–∞–π–ª\r\n    await fs.unlink(backupPath);\r\n    \r\n    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ S3 –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ\r\n    if (s3 && process.env.BACKUP_S3_BUCKET) {\r\n      const fileContent = await fs.readFile(zipPath);\r\n      \r\n      await s3.putObject({\r\n        Bucket: process.env.BACKUP_S3_BUCKET,\r\n        Key: `database/${backupFile}.zip`,\r\n        Body: fileContent,\r\n        ContentType: 'application/zip'\r\n      }).promise();\r\n      \r\n      fastify.log.info(`Database backup uploaded to S3: ${backupFile}.zip`);\r\n    }\r\n    \r\n    // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–∫–∞–ª—å–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤\r\n    await cleanupOldBackups(backupDir);\r\n    \r\n    return {\r\n      success: true,\r\n      filename: `${backupFile}.zip`,\r\n      size: (await fs.stat(zipPath)).size,\r\n      path: zipPath,\r\n      s3: s3 && process.env.BACKUP_S3_BUCKET ? true : false\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error('Database backup failed:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞ —Ñ–∞–π–ª–æ–≤\r\nasync function createFilesBackup() {\r\n  const timestamp = new Date().toISOString().replace(/[:.]/g, '-');\r\n  const backupDir = path.join(process.cwd(), 'backups');\r\n  const backupFile = `vhm24-files-backup-${timestamp}.zip`;\r\n  const backupPath = path.join(backupDir, backupFile);\r\n  \r\n  try {\r\n    // –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±—ç–∫–∞–ø–æ–≤\r\n    await fs.mkdir(backupDir, { recursive: true });\r\n    \r\n    // –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤\r\n    const output = await fs.open(backupPath, 'w');\r\n    const archive = archiver('zip', { zlib: { level: 9 } });\r\n    \r\n    archive.pipe(output);\r\n    \r\n    // –î–æ–±–∞–≤–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –±—ç–∫–∞–ø–∞\r\n    const dirsToBackup = ['uploads', 'logs'];\r\n    \r\n    for (const dir of dirsToBackup) {\r\n      const dirPath = path.join(process.cwd(), dir);\r\n      try {\r\n        await fs.access(dirPath);\r\n        archive.directory(dirPath, dir);\r\n      } catch (error) {\r\n        fastify.log.warn(`Directory ${dir} not found, skipping`);\r\n      }\r\n    }\r\n    \r\n    await archive.finalize();\r\n    \r\n    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ S3 –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ\r\n    if (s3 && process.env.BACKUP_S3_BUCKET) {\r\n      const fileContent = await fs.readFile(backupPath);\r\n      \r\n      await s3.putObject({\r\n        Bucket: process.env.BACKUP_S3_BUCKET,\r\n        Key: `files/${backupFile}`,\r\n        Body: fileContent,\r\n        ContentType: 'application/zip'\r\n      }).promise();\r\n      \r\n      fastify.log.info(`Files backup uploaded to S3: ${backupFile}`);\r\n    }\r\n    \r\n    return {\r\n      success: true,\r\n      filename: backupFile,\r\n      size: (await fs.stat(backupPath)).size,\r\n      path: backupPath,\r\n      s3: s3 && process.env.BACKUP_S3_BUCKET ? true : false\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error('Files backup failed:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n// –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤\r\nasync function cleanupOldBackups(backupDir) {\r\n  const retentionDays = parseInt(process.env.BACKUP_RETENTION_DAYS) || 30;\r\n  const cutoffDate = new Date();\r\n  cutoffDate.setDate(cutoffDate.getDate() - retentionDays);\r\n  \r\n  try {\r\n    const files = await fs.readdir(backupDir);\r\n    \r\n    for (const file of files) {\r\n      const filePath = path.join(backupDir, file);\r\n      const stats = await fs.stat(filePath);\r\n      \r\n      if (stats.mtime < cutoffDate) {\r\n        await fs.unlink(filePath);\r\n        fastify.log.info(`Deleted old backup: ${file}`);\r\n      }\r\n    }\r\n  } catch (error) {\r\n    fastify.log.error('Cleanup failed:', error);\r\n  }\r\n}\r\n\r\n// –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø –≤—Ä—É—á–Ω—É—é\r\nfastify.post('/api/v1/backup/create', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    body: {\r\n      type: 'object',\r\n      properties: {\r\n        type: { \r\n          type: 'string', \r\n          enum: ['database', 'files', 'full'],\r\n          default: 'full'\r\n        }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { type } = request.body;\r\n  \r\n  try {\r\n    const results = {};\r\n    \r\n    if (type === 'database' || type === 'full') {\r\n      results.database = await createDatabaseBackup();\r\n    }\r\n    \r\n    if (type === 'files' || type === 'full') {\r\n      results.files = await createFilesBackup();\r\n    }\r\n    \r\n    return {\r\n      success: true,\r\n      data: results,\r\n      message: 'Backup created successfully'\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Backup failed',\r\n      message: error.message\r\n    });\r\n  }\r\n});\r\n\r\n// –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –±—ç–∫–∞–ø–æ–≤\r\nfastify.get('/api/v1/backup/list', {\r\n  preValidation: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    const backupDir = path.join(process.cwd(), 'backups');\r\n    const backups = [];\r\n    \r\n    try {\r\n      const files = await fs.readdir(backupDir);\r\n      \r\n      for (const file of files) {\r\n        const filePath = path.join(backupDir, file);\r\n        const stats = await fs.stat(filePath);\r\n        \r\n        backups.push({\r\n          filename: file,\r\n          size: stats.size,\r\n          created: stats.mtime,\r\n          type: file.includes('db-backup') ? 'database' : 'files'\r\n        });\r\n      }\r\n    } catch (error) {\r\n      // –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç\r\n    }\r\n    \r\n    // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑ S3\r\n    let s3Backups = [];\r\n    if (s3 && process.env.BACKUP_S3_BUCKET) {\r\n      try {\r\n        const s3Data = await s3.listObjectsV2({\r\n          Bucket: process.env.BACKUP_S3_BUCKET,\r\n          MaxKeys: 100\r\n        }).promise();\r\n        \r\n        s3Backups = s3Data.Contents.map(item => ({\r\n          filename: item.Key.split('/').pop(),\r\n          size: item.Size,\r\n          created: item.LastModified,\r\n          type: item.Key.startsWith('database/') ? 'database' : 'files',\r\n          s3: true,\r\n          key: item.Key\r\n        }));\r\n      } catch (error) {\r\n        fastify.log.error('Failed to list S3 backups:', error);\r\n      }\r\n    }\r\n    \r\n    return {\r\n      success: true,\r\n      data: {\r\n        local: backups.sort((a, b) => b.created - a.created),\r\n        s3: s3Backups.sort((a, b) => b.created - a.created)\r\n      }\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to list backups'\r\n    });\r\n  }\r\n});\r\n\r\n// –°–∫–∞—á–∞—Ç—å –±—ç–∫–∞–ø\r\nfastify.get('/api/v1/backup/download/:filename', {\r\n  preValidation: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  const { filename } = request.params;\r\n  \r\n  try {\r\n    const backupDir = path.join(process.cwd(), 'backups');\r\n    const filePath = path.join(backupDir, filename);\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—É—Ç–∏\r\n    if (!filePath.startsWith(backupDir)) {\r\n      return reply.code(400).send({\r\n        success: false,\r\n        error: 'Invalid filename'\r\n      });\r\n    }\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞\r\n    await fs.access(filePath);\r\n    \r\n    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª\r\n    return reply.sendFile(filename, backupDir);\r\n  } catch (error) {\r\n    reply.code(404).send({\r\n      success: false,\r\n      error: 'Backup not found'\r\n    });\r\n  }\r\n});\r\n\r\n// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞\r\nfastify.post('/api/v1/backup/restore', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    body: {\r\n      type: 'object',\r\n      required: ['filename'],\r\n      properties: {\r\n        filename: { type: 'string' },\r\n        source: { type: 'string', enum: ['local', 's3'], default: 'local' }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { filename, source } = request.body;\r\n  \r\n  try {\r\n    // –¢–æ–ª—å–∫–æ –¥–ª—è database –±—ç–∫–∞–ø–æ–≤\r\n    if (!filename.includes('db-backup')) {\r\n      return reply.code(400).send({\r\n        success: false,\r\n        error: 'Only database backups can be restored'\r\n      });\r\n    }\r\n    \r\n    let backupPath;\r\n    \r\n    if (source === 's3' && s3 && process.env.BACKUP_S3_BUCKET) {\r\n      // –°–∫–∞—á–∏–≤–∞–µ–º –∏–∑ S3\r\n      const tempPath = path.join(process.cwd(), 'temp', filename);\r\n      await fs.mkdir(path.dirname(tempPath), { recursive: true });\r\n      \r\n      const s3Object = await s3.getObject({\r\n        Bucket: process.env.BACKUP_S3_BUCKET,\r\n        Key: `database/${filename}`\r\n      }).promise();\r\n      \r\n      await fs.writeFile(tempPath, s3Object.Body);\r\n      backupPath = tempPath;\r\n    } else {\r\n      backupPath = path.join(process.cwd(), 'backups', filename);\r\n    }\r\n    \r\n    // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\r\n    // –≠—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è pg_restore\r\n    \r\n    return {\r\n      success: false,\r\n      error: 'Restore functionality not implemented yet',\r\n      message: 'Please restore manually using pg_restore'\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Restore failed',\r\n      message: error.message\r\n    });\r\n  }\r\n});\r\n\r\n// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –±—ç–∫–∞–ø–æ–≤\r\nif (process.env.BACKUP_ENABLED === 'true') {\r\n  const schedule = process.env.BACKUP_SCHEDULE || '0 2 * * *'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ 2 –Ω–æ—á–∏\r\n  \r\n  cron.schedule(schedule, async () => {\r\n    fastify.log.info('Starting scheduled backup...');\r\n    \r\n    try {\r\n      const dbBackup = await createDatabaseBackup();\r\n      const filesBackup = await createFilesBackup();\r\n      \r\n      fastify.log.info('Scheduled backup completed successfully', {\r\n        database: dbBackup,\r\n        files: filesBackup\r\n      });\r\n    } catch (error) {\r\n      fastify.log.error('Scheduled backup failed:', error);\r\n    }\r\n  });\r\n  \r\n  fastify.log.info(`Backup schedule configured: ${schedule}`);\r\n}\r\n\r\n// Start server\r\nconst start = async () => {\r\n  try {\r\n    await fastify.listen({ \r\n      port: process.env.BACKUP_PORT || 3007,\r\n      host: '0.0.0.0'\r\n    });\r\n    console.log('VHM24 Backup Service running 24/7 on port', process.env.BACKUP_PORT || 3007);\r\n  } catch (err) {\r\n    fastify.log.error(err);\r\n    process.exit(1);\r\n  }\r\n};\r\n\r\nstart();\r\n\r\n// Graceful shutdown\r\nprocess.on('SIGTERM', async () => {\r\n  await fastify.close();\r\n  process.exit(0);\r\n});\r\n",
  "migrate-from-supabase.js": "#!/usr/bin/env node\r\n\r\n/**\r\n * Migration script from Supabase to new database architecture\r\n * This script will:\r\n * 1. Export data from Supabase\r\n * 2. Transform data for new schema structure\r\n * 3. Import data into new databases\r\n */\r\n\r\nconst { PrismaClient } = require('@prisma/client');\r\nconst fs = require('fs').promises;\r\nconst path = require('path');\r\n\r\n// Old Supabase client\r\nconst supabaseClient = new PrismaClient({\r\n  datasources: {\r\n    db: {\r\n      url: process.env.SUPABASE_DATABASE_URL || process.env.DATABASE_URL\r\n    }\r\n  }\r\n});\r\n\r\n// New database clients (will be imported after generation)\r\nlet authClient, machinesClient, inventoryClient, tasksClient, sharedClient;\r\n\r\nasync function loadNewClients() {\r\n  try {\r\n    const { getAuthClient } = require('./packages/database/dist/clients/auth.client');\r\n    const { getMachinesClient } = require('./packages/database/dist/clients/machines.client');\r\n    const { getInventoryClient } = require('./packages/database/dist/clients/inventory.client');\r\n    const { getTasksClient } = require('./packages/database/dist/clients/tasks.client');\r\n    const { getSharedClient } = require('./packages/database/dist/clients/shared.client');\r\n\r\n    authClient = getAuthClient();\r\n    machinesClient = getMachinesClient();\r\n    inventoryClient = getInventoryClient();\r\n    tasksClient = getTasksClient();\r\n    sharedClient = getSharedClient();\r\n  } catch (error) {\r\n    console.error('Error loading new clients. Make sure to run \"npm run generate\" first.');\r\n    throw error;\r\n  }\r\n}\r\n\r\nasync function exportData() {\r\n  console.log('üì§ Exporting data from Supabase...');\r\n  \r\n  const data = {\r\n    users: await supabaseClient.user.findMany(),\r\n    locations: await supabaseClient.location.findMany(),\r\n    machines: await supabaseClient.machine.findMany(),\r\n    tasks: await supabaseClient.task.findMany(),\r\n    taskActions: await supabaseClient.taskAction.findMany(),\r\n    inventoryItems: await supabaseClient.inventoryItem.findMany(),\r\n    stockMovements: await supabaseClient.stockMovement.findMany(),\r\n    machineTelemetry: await supabaseClient.machineTelemetry.findMany(),\r\n    auditLogs: await supabaseClient.auditLog.findMany(),\r\n    transactions: await supabaseClient.transaction.findMany(),\r\n    machineInventory: await supabaseClient.machineInventory.findMany(),\r\n    serviceHistory: await supabaseClient.serviceHistory.findMany(),\r\n  };\r\n\r\n  // Save backup\r\n  const backupPath = path.join(__dirname, 'supabase-backup.json');\r\n  await fs.writeFile(backupPath, JSON.stringify(data, null, 2));\r\n  console.log(`‚úÖ Data exported to ${backupPath}`);\r\n\r\n  return data;\r\n}\r\n\r\nasync function migrateAuthData(data) {\r\n  console.log('üîê Migrating auth data...');\r\n  \r\n  // Migrate users\r\n  for (const user of data.users) {\r\n    await authClient.user.create({\r\n      data: {\r\n        id: user.id,\r\n        email: user.email,\r\n        name: user.name,\r\n        passwordHash: user.passwordHash,\r\n        roles: user.roles,\r\n        phoneNumber: user.phoneNumber,\r\n        telegramId: user.telegramId,\r\n        isActive: user.isActive,\r\n        lastLogin: user.lastLogin,\r\n        createdAt: user.createdAt,\r\n        updatedAt: user.updatedAt,\r\n      }\r\n    });\r\n  }\r\n\r\n  // Migrate audit logs (only auth-related)\r\n  const authAuditLogs = data.auditLogs.filter(log => \r\n    log.entity === 'User' || log.action.includes('auth') || log.action.includes('login')\r\n  );\r\n  \r\n  for (const log of authAuditLogs) {\r\n    await authClient.auditLog.create({\r\n      data: {\r\n        id: log.id,\r\n        userId: log.userId,\r\n        action: log.action,\r\n        entity: log.entity,\r\n        entityId: log.entityId,\r\n        changes: log.changes,\r\n        ipAddress: log.ipAddress,\r\n        userAgent: log.userAgent,\r\n        createdAt: log.createdAt,\r\n      }\r\n    });\r\n  }\r\n\r\n  console.log(`‚úÖ Migrated ${data.users.length} users and ${authAuditLogs.length} audit logs`);\r\n}\r\n\r\nasync function migrateMachinesData(data) {\r\n  console.log('ü§ñ Migrating machines data...');\r\n  \r\n  // Migrate locations\r\n  for (const location of data.locations) {\r\n    await machinesClient.location.create({\r\n      data: {\r\n        id: location.id,\r\n        name: location.name,\r\n        address: location.address,\r\n        latitude: location.latitude,\r\n        longitude: location.longitude,\r\n        isActive: location.isActive,\r\n        createdAt: location.createdAt,\r\n        updatedAt: location.updatedAt,\r\n      }\r\n    });\r\n  }\r\n\r\n  // Migrate machines\r\n  for (const machine of data.machines) {\r\n    await machinesClient.machine.create({\r\n      data: {\r\n        id: machine.id,\r\n        code: machine.code,\r\n        serialNumber: machine.serialNumber,\r\n        type: machine.type,\r\n        name: machine.name,\r\n        status: machine.status,\r\n        locationId: machine.locationId,\r\n        lastPing: machine.lastPing,\r\n        metadata: machine.metadata,\r\n        createdAt: machine.createdAt,\r\n        updatedAt: machine.updatedAt,\r\n      }\r\n    });\r\n  }\r\n\r\n  // Migrate telemetry\r\n  for (const telemetry of data.machineTelemetry) {\r\n    await machinesClient.machineTelemetry.create({\r\n      data: {\r\n        id: telemetry.id,\r\n        machineId: telemetry.machineId,\r\n        temperature: telemetry.temperature,\r\n        humidity: telemetry.humidity,\r\n        sales: telemetry.sales,\r\n        errors: telemetry.errors,\r\n        rawData: telemetry.rawData,\r\n        createdAt: telemetry.createdAt,\r\n      }\r\n    });\r\n  }\r\n\r\n  // Migrate service history\r\n  for (const service of data.serviceHistory) {\r\n    await machinesClient.serviceHistory.create({\r\n      data: {\r\n        id: service.id,\r\n        machineId: service.machineId,\r\n        serviceType: service.serviceType,\r\n        description: service.description,\r\n        performedById: service.performedById,\r\n        performedAt: service.performedAt,\r\n        nextServiceDate: service.nextServiceDate,\r\n        photos: service.photos,\r\n        location: service.location,\r\n        metadata: service.metadata,\r\n      }\r\n    });\r\n  }\r\n\r\n  console.log(`‚úÖ Migrated ${data.locations.length} locations, ${data.machines.length} machines`);\r\n}\r\n\r\nasync function migrateInventoryData(data) {\r\n  console.log('üì¶ Migrating inventory data...');\r\n  \r\n  // Migrate inventory items\r\n  for (const item of data.inventoryItems) {\r\n    await inventoryClient.inventoryItem.create({\r\n      data: {\r\n        id: item.id,\r\n        name: item.name,\r\n        sku: item.sku,\r\n        unit: item.unit,\r\n        category: item.category,\r\n        description: item.description,\r\n        quantity: item.quantity,\r\n        minQuantity: item.minQuantity,\r\n        maxQuantity: item.maxQuantity,\r\n        price: item.price,\r\n        isActive: item.isActive,\r\n        lastUpdated: item.lastUpdated,\r\n        createdAt: item.createdAt,\r\n        updatedAt: item.updatedAt,\r\n      }\r\n    });\r\n  }\r\n\r\n  // Migrate stock movements\r\n  for (const movement of data.stockMovements) {\r\n    await inventoryClient.stockMovement.create({\r\n      data: {\r\n        id: movement.id,\r\n        itemId: movement.itemId,\r\n        userId: movement.userId,\r\n        type: movement.type,\r\n        quantity: movement.quantity,\r\n        quantityBefore: movement.quantityBefore,\r\n        quantityAfter: movement.quantityAfter,\r\n        reason: movement.reason,\r\n        reference: movement.reference,\r\n        fromLocation: movement.fromLocation,\r\n        toLocation: movement.toLocation,\r\n        machineId: movement.machineId,\r\n        metadata: movement.metadata,\r\n        createdAt: movement.createdAt,\r\n      }\r\n    });\r\n  }\r\n\r\n  // Migrate machine inventory\r\n  for (const inv of data.machineInventory) {\r\n    await inventoryClient.machineInventory.create({\r\n      data: {\r\n        id: inv.id,\r\n        machineId: inv.machineId,\r\n        itemId: inv.itemId,\r\n        quantity: inv.quantity,\r\n        minQuantity: inv.minQuantity,\r\n        maxQuantity: inv.maxQuantity,\r\n        lastRefill: inv.lastRefill,\r\n        createdAt: inv.createdAt,\r\n        updatedAt: inv.updatedAt,\r\n      }\r\n    });\r\n  }\r\n\r\n  console.log(`‚úÖ Migrated ${data.inventoryItems.length} items, ${data.stockMovements.length} movements`);\r\n}\r\n\r\nasync function migrateTasksData(data) {\r\n  console.log('üìã Migrating tasks data...');\r\n  \r\n  // Migrate tasks\r\n  for (const task of data.tasks) {\r\n    await tasksClient.task.create({\r\n      data: {\r\n        id: task.id,\r\n        title: task.title,\r\n        description: task.description,\r\n        status: task.status,\r\n        priority: task.priority,\r\n        dueDate: task.dueDate,\r\n        completedAt: task.completedAt,\r\n        machineId: task.machineId,\r\n        assignedToId: task.assignedToId,\r\n        createdById: task.createdById,\r\n        createdAt: task.createdAt,\r\n        updatedAt: task.updatedAt,\r\n      }\r\n    });\r\n  }\r\n\r\n  // Migrate task actions\r\n  for (const action of data.taskActions) {\r\n    await tasksClient.taskAction.create({\r\n      data: {\r\n        id: action.id,\r\n        taskId: action.taskId,\r\n        userId: action.userId,\r\n        action: action.action,\r\n        comment: action.comment,\r\n        location: action.location,\r\n        photoUrls: action.photoUrls,\r\n        metadata: action.metadata,\r\n        createdAt: action.createdAt,\r\n      }\r\n    });\r\n  }\r\n\r\n  console.log(`‚úÖ Migrated ${data.tasks.length} tasks and ${data.taskActions.length} actions`);\r\n}\r\n\r\nasync function migrateSharedData(data) {\r\n  console.log('üåê Migrating shared data...');\r\n  \r\n  // Migrate transactions\r\n  for (const transaction of data.transactions) {\r\n    await sharedClient.transaction.create({\r\n      data: {\r\n        id: transaction.id,\r\n        machineId: transaction.machineId,\r\n        amount: transaction.amount,\r\n        currency: transaction.currency,\r\n        paymentType: transaction.paymentType,\r\n        status: transaction.status,\r\n        reference: transaction.reference,\r\n        metadata: transaction.metadata,\r\n        createdAt: transaction.createdAt,\r\n      }\r\n    });\r\n  }\r\n\r\n  console.log(`‚úÖ Migrated ${data.transactions.length} transactions`);\r\n}\r\n\r\nasync function main() {\r\n  try {\r\n    console.log('üöÄ Starting migration from Supabase...\\n');\r\n\r\n    // Check environment\r\n    if (!process.env.DATABASE_URL && !process.env.SUPABASE_DATABASE_URL) {\r\n      throw new Error('Please set SUPABASE_DATABASE_URL or DATABASE_URL for the source database');\r\n    }\r\n\r\n    // Load new clients\r\n    await loadNewClients();\r\n\r\n    // Export data from Supabase\r\n    const data = await exportData();\r\n\r\n    // Migrate data to new databases\r\n    await migrateAuthData(data);\r\n    await migrateMachinesData(data);\r\n    await migrateInventoryData(data);\r\n    await migrateTasksData(data);\r\n    await migrateSharedData(data);\r\n\r\n    console.log('\\n‚úÖ Migration completed successfully!');\r\n    console.log('üìù Next steps:');\r\n    console.log('1. Update your services to use the new database clients');\r\n    console.log('2. Test all functionality');\r\n    console.log('3. Remove Supabase dependencies');\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Migration failed:', error);\r\n    process.exit(1);\r\n  } finally {\r\n    await supabaseClient.$disconnect();\r\n    if (authClient) await authClient.$disconnect();\r\n    if (machinesClient) await machinesClient.$disconnect();\r\n    if (inventoryClient) await inventoryClient.$disconnect();\r\n    if (tasksClient) await tasksClient.$disconnect();\r\n    if (sharedClient) await sharedClient.$disconnect();\r\n  }\r\n}\r\n\r\n// Run migration\r\nmain();\r\n",
  "packages/database/src/clients/index.js": "// Simplified database clients for JavaScript usage\r\nconst { PrismaClient } = require('@prisma/client');\r\n\r\n// Single database mode (default)\r\nlet prismaClient = null;\r\n\r\nfunction getPrismaClient() {\r\n  if (!prismaClient) {\r\n    prismaClient = new PrismaClient({\r\n      datasources: {\r\n        db: {\r\n          url: process.env.DATABASE_URL,\r\n        },\r\n      },\r\n      log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],\r\n    });\r\n  }\r\n  return prismaClient;\r\n}\r\n\r\n// Multi-database mode clients\r\nlet authClient = null;\r\nlet machinesClient = null;\r\nlet inventoryClient = null;\r\nlet tasksClient = null;\r\nlet sharedClient = null;\r\n\r\nfunction getAuthClient() {\r\n  if (process.env.USE_MULTIPLE_DATABASES !== 'true') {\r\n    return getPrismaClient();\r\n  }\r\n  \r\n  if (!authClient) {\r\n    authClient = new PrismaClient({\r\n      datasources: {\r\n        db: {\r\n          url: process.env.AUTH_DATABASE_URL || process.env.DATABASE_URL,\r\n        },\r\n      },\r\n      log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],\r\n    });\r\n  }\r\n  return authClient;\r\n}\r\n\r\nfunction getMachinesClient() {\r\n  if (process.env.USE_MULTIPLE_DATABASES !== 'true') {\r\n    return getPrismaClient();\r\n  }\r\n  \r\n  if (!machinesClient) {\r\n    machinesClient = new PrismaClient({\r\n      datasources: {\r\n        db: {\r\n          url: process.env.MACHINES_DATABASE_URL || process.env.DATABASE_URL,\r\n        },\r\n      },\r\n      log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],\r\n    });\r\n  }\r\n  return machinesClient;\r\n}\r\n\r\nfunction getInventoryClient() {\r\n  if (process.env.USE_MULTIPLE_DATABASES !== 'true') {\r\n    return getPrismaClient();\r\n  }\r\n  \r\n  if (!inventoryClient) {\r\n    inventoryClient = new PrismaClient({\r\n      datasources: {\r\n        db: {\r\n          url: process.env.INVENTORY_DATABASE_URL || process.env.DATABASE_URL,\r\n        },\r\n      },\r\n      log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],\r\n    });\r\n  }\r\n  return inventoryClient;\r\n}\r\n\r\nfunction getTasksClient() {\r\n  if (process.env.USE_MULTIPLE_DATABASES !== 'true') {\r\n    return getPrismaClient();\r\n  }\r\n  \r\n  if (!tasksClient) {\r\n    tasksClient = new PrismaClient({\r\n      datasources: {\r\n        db: {\r\n          url: process.env.TASKS_DATABASE_URL || process.env.DATABASE_URL,\r\n        },\r\n      },\r\n      log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],\r\n    });\r\n  }\r\n  return tasksClient;\r\n}\r\n\r\nfunction getSharedClient() {\r\n  if (process.env.USE_MULTIPLE_DATABASES !== 'true') {\r\n    return getPrismaClient();\r\n  }\r\n  \r\n  if (!sharedClient) {\r\n    sharedClient = new PrismaClient({\r\n      datasources: {\r\n        db: {\r\n          url: process.env.SHARED_DATABASE_URL || process.env.DATABASE_URL,\r\n        },\r\n      },\r\n      log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],\r\n    });\r\n  }\r\n  return sharedClient;\r\n}\r\n\r\n// Disconnect functions\r\nasync function disconnectAllClients() {\r\n  const clients = [\r\n    prismaClient,\r\n    authClient,\r\n    machinesClient,\r\n    inventoryClient,\r\n    tasksClient,\r\n    sharedClient\r\n  ].filter(Boolean);\r\n\r\n  await Promise.all(clients.map(client => client.$disconnect()));\r\n  \r\n  // Reset all clients\r\n  prismaClient = null;\r\n  authClient = null;\r\n  machinesClient = null;\r\n  inventoryClient = null;\r\n  tasksClient = null;\r\n  sharedClient = null;\r\n}\r\n\r\nmodule.exports = {\r\n  getPrismaClient,\r\n  getAuthClient,\r\n  getMachinesClient,\r\n  getInventoryClient,\r\n  getTasksClient,\r\n  getSharedClient,\r\n  disconnectAllClients,\r\n  // For backward compatibility\r\n  PrismaClient\r\n};\r\n",
  "scripts/comprehensive-test.js": "const { execSync } = require('child_process');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\nclass ProjectTester {\r\n  constructor() {\r\n    this.results = {\r\n      timestamp: new Date().toISOString(),\r\n      environment: process.env.NODE_ENV || 'development',\r\n      tests: {\r\n        dependencies: {},\r\n        services: {},\r\n        api: {},\r\n        database: {},\r\n        infrastructure: {},\r\n        security: {}\r\n      }\r\n    };\r\n  }\r\n\r\n  async runAllTests() {\r\n    console.log('üß™ –ó–∞–ø—É—Å–∫ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è VHM24...\\n');\r\n    \r\n    try {\r\n      // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π\r\n      await this.testDependencies();\r\n      \r\n      // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã\r\n      await this.testInfrastructure();\r\n      \r\n      // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\r\n      await this.testDatabase();\r\n      \r\n      // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤\r\n      await this.testServices();\r\n      \r\n      // 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\r\n      await this.testSecurity();\r\n      \r\n      // 6. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤\r\n      this.saveResults();\r\n      \r\n    } catch (error) {\r\n      console.error('‚ùå Error during testing:', error.message);\r\n      this.results.error = error.message;\r\n      this.saveResults();\r\n    }\r\n  }\r\n\r\n  async testDependencies() {\r\n    console.log('üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...');\r\n    \r\n    try {\r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ npm\r\n      const npmVersion = execSync('npm --version', { stdio: 'pipe' }).toString().trim();\r\n      this.results.tests.dependencies.npm = { version: npmVersion, status: 'OK' };\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ Node.js\r\n      const nodeVersion = execSync('node --version', { stdio: 'pipe' }).toString().trim();\r\n      this.results.tests.dependencies.node = { version: nodeVersion, status: 'OK' };\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π\r\n      try {\r\n        const audit = execSync('npm audit --json', { stdio: 'pipe' });\r\n        const auditData = JSON.parse(audit.toString());\r\n        this.results.tests.dependencies.vulnerabilities = {\r\n          total: auditData.metadata?.vulnerabilities?.total || 0,\r\n          high: auditData.metadata?.vulnerabilities?.high || 0,\r\n          critical: auditData.metadata?.vulnerabilities?.critical || 0\r\n        };\r\n      } catch (e) {\r\n        this.results.tests.dependencies.vulnerabilities = 'Audit check failed';\r\n      }\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ outdated –ø–∞–∫–µ—Ç–æ–≤\r\n      try {\r\n        const outdated = execSync('npm outdated --json', { stdio: 'pipe' });\r\n        this.results.tests.dependencies.outdated = JSON.parse(outdated.toString());\r\n      } catch (e) {\r\n        this.results.tests.dependencies.outdated = {};\r\n      }\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ package.json –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö\r\n      const services = fs.readdirSync('services');\r\n      this.results.tests.dependencies.services = {};\r\n      \r\n      services.forEach(service => {\r\n        const pkgPath = path.join('services', service, 'package.json');\r\n        if (fs.existsSync(pkgPath)) {\r\n          const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));\r\n          this.results.tests.dependencies.services[service] = {\r\n            hasPackageJson: true,\r\n            hasStartScript: !!(pkg.scripts && (pkg.scripts.start || pkg.scripts.dev)),\r\n            dependencies: Object.keys(pkg.dependencies || {}),\r\n            devDependencies: Object.keys(pkg.devDependencies || {})\r\n          };\r\n        } else {\r\n          this.results.tests.dependencies.services[service] = {\r\n            hasPackageJson: false\r\n          };\r\n        }\r\n      });\r\n      \r\n    } catch (error) {\r\n      this.results.tests.dependencies.error = error.message;\r\n    }\r\n  }\r\n\r\n  async testInfrastructure() {\r\n    console.log('üèóÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã...');\r\n    \r\n    // Docker\r\n    try {\r\n      const dockerVersion = execSync('docker --version', { stdio: 'pipe' }).toString().trim();\r\n      this.results.tests.infrastructure.docker = { \r\n        version: dockerVersion, \r\n        status: 'Installed' \r\n      };\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤\r\n      try {\r\n        const containers = execSync('docker ps --format \"{{.Names}}\"', { stdio: 'pipe' })\r\n          .toString().split('\\n').filter(Boolean);\r\n        this.results.tests.infrastructure.containers = containers;\r\n      } catch (e) {\r\n        this.results.tests.infrastructure.containers = [];\r\n      }\r\n    } catch (e) {\r\n      this.results.tests.infrastructure.docker = { status: 'Not installed' };\r\n    }\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã\r\n    const requiredDirs = ['services', 'packages', 'apps'];\r\n    this.results.tests.infrastructure.directories = {};\r\n    \r\n    requiredDirs.forEach(dir => {\r\n      this.results.tests.infrastructure.directories[dir] = fs.existsSync(dir);\r\n    });\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤\r\n    const configFiles = [\r\n      'package.json',\r\n      'docker-compose.yml',\r\n      '.env',\r\n      'nixpacks.toml',\r\n      'railway.json'\r\n    ];\r\n    \r\n    this.results.tests.infrastructure.configFiles = {};\r\n    configFiles.forEach(file => {\r\n      this.results.tests.infrastructure.configFiles[file] = fs.existsSync(file);\r\n    });\r\n  }\r\n\r\n  async testDatabase() {\r\n    console.log('üóÑÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...');\r\n    \r\n    try {\r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ Prisma\r\n      const prismaSchemaPath = 'packages/database/prisma/schema.prisma';\r\n      this.results.tests.database.prismaSchema = fs.existsSync(prismaSchemaPath);\r\n      \r\n      if (this.results.tests.database.prismaSchema) {\r\n        const schema = fs.readFileSync(prismaSchemaPath, 'utf8');\r\n        const models = schema.match(/model\\s+(\\w+)/g) || [];\r\n        this.results.tests.database.models = models.map(m => m.replace('model ', ''));\r\n      }\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –ë–î\r\n      if (fs.existsSync('.env')) {\r\n        const env = fs.readFileSync('.env', 'utf8');\r\n        this.results.tests.database.hasConnectionString = env.includes('DATABASE_URL');\r\n        this.results.tests.database.hasRedisUrl = env.includes('REDIS_URL');\r\n      }\r\n      \r\n      // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)\r\n      try {\r\n        const { PrismaClient } = require('@prisma/client');\r\n        const prisma = new PrismaClient();\r\n        \r\n        await prisma.$connect();\r\n        this.results.tests.database.connection = 'OK';\r\n        \r\n        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü\r\n        const tables = await prisma.$queryRaw`\r\n          SELECT table_name \r\n          FROM information_schema.tables \r\n          WHERE table_schema = 'public'\r\n        `;\r\n        this.results.tests.database.tables = tables.map(t => t.table_name);\r\n        \r\n        await prisma.$disconnect();\r\n      } catch (error) {\r\n        this.results.tests.database.connection = `Failed: ${error.message}`;\r\n      }\r\n      \r\n    } catch (error) {\r\n      this.results.tests.database.error = error.message;\r\n    }\r\n  }\r\n\r\n  async testServices() {\r\n    console.log('üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤...');\r\n    \r\n    const services = [\r\n      { name: 'Gateway', port: 8000, path: 'services/gateway' },\r\n      { name: 'Auth', port: 3001, path: 'services/auth' },\r\n      { name: 'Machines', port: 3002, path: 'services/machines' },\r\n      { name: 'Inventory', port: 3003, path: 'services/inventory' },\r\n      { name: 'Tasks', port: 3004, path: 'services/tasks' },\r\n      { name: 'Telegram Bot', port: 3005, path: 'services/telegram-bot' },\r\n      { name: 'Notifications', port: 3006, path: 'services/notifications' }\r\n    ];\r\n    \r\n    this.results.tests.services = {};\r\n    \r\n    for (const service of services) {\r\n      const serviceResult = {\r\n        exists: fs.existsSync(service.path),\r\n        hasPackageJson: fs.existsSync(path.join(service.path, 'package.json')),\r\n        hasIndex: fs.existsSync(path.join(service.path, 'src', 'index.js')),\r\n        port: service.port,\r\n        status: 'Unknown'\r\n      };\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ index.js\r\n      const indexPath = path.join(service.path, 'src', 'index.js');\r\n      if (fs.existsSync(indexPath)) {\r\n        const content = fs.readFileSync(indexPath, 'utf8');\r\n        serviceResult.hasHealthCheck = content.includes('/health');\r\n        serviceResult.hasPortConfig = content.includes('process.env.PORT');\r\n        serviceResult.usesFastify = content.includes('fastify');\r\n        serviceResult.usesPrisma = content.includes('prisma');\r\n      }\r\n      \r\n      // –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ (–±–µ–∑ –∑–∞–ø—É—Å–∫–∞)\r\n      try {\r\n        const response = await this.checkPort(service.port);\r\n        serviceResult.status = response ? 'Running' : 'Down';\r\n      } catch (error) {\r\n        serviceResult.status = 'Down';\r\n      }\r\n      \r\n      this.results.tests.services[service.name] = serviceResult;\r\n    }\r\n  }\r\n\r\n  async checkPort(port) {\r\n    return new Promise((resolve) => {\r\n      const net = require('net');\r\n      const socket = new net.Socket();\r\n      \r\n      socket.setTimeout(1000);\r\n      socket.on('connect', () => {\r\n        socket.destroy();\r\n        resolve(true);\r\n      });\r\n      \r\n      socket.on('timeout', () => {\r\n        socket.destroy();\r\n        resolve(false);\r\n      });\r\n      \r\n      socket.on('error', () => {\r\n        resolve(false);\r\n      });\r\n      \r\n      socket.connect(port, 'localhost');\r\n    });\r\n  }\r\n\r\n  async testSecurity() {\r\n    console.log('üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏...');\r\n    \r\n    try {\r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ .env —Ñ–∞–π–ª–∞\r\n      if (fs.existsSync('.env')) {\r\n        const env = fs.readFileSync('.env', 'utf8');\r\n        this.results.tests.security.hasJwtSecret = env.includes('JWT_SECRET');\r\n        this.results.tests.security.hasStrongJwtSecret = env.includes('JWT_SECRET') && \r\n          env.match(/JWT_SECRET=.{32,}/);\r\n      }\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ hardcoded —Å–µ–∫—Ä–µ—Ç—ã –≤ –∫–æ–¥–µ\r\n      const securityIssues = [];\r\n      const services = fs.readdirSync('services');\r\n      \r\n      services.forEach(service => {\r\n        const servicePath = path.join('services', service, 'src');\r\n        if (fs.existsSync(servicePath)) {\r\n          const files = this.getAllJsFiles(servicePath);\r\n          files.forEach(file => {\r\n            const content = fs.readFileSync(file, 'utf8');\r\n            \r\n            // –ü–æ–∏—Å–∫ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\r\n            if (content.includes('password') && content.includes('=') && content.includes('\"')) {\r\n              securityIssues.push(`${file}: Potential hardcoded password`);\r\n            }\r\n            \r\n            if (content.includes('secret') && content.includes('=') && content.includes('\"')) {\r\n              securityIssues.push(`${file}: Potential hardcoded secret`);\r\n            }\r\n            \r\n            if (content.includes('api_key') && content.includes('=') && content.includes('\"')) {\r\n              securityIssues.push(`${file}: Potential hardcoded API key`);\r\n            }\r\n          });\r\n        }\r\n      });\r\n      \r\n      this.results.tests.security.issues = securityIssues;\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ CORS –Ω–∞—Å—Ç—Ä–æ–µ–∫\r\n      const gatewayPath = 'services/gateway/src/index.js';\r\n      if (fs.existsSync(gatewayPath)) {\r\n        const content = fs.readFileSync(gatewayPath, 'utf8');\r\n        this.results.tests.security.hasCors = content.includes('cors');\r\n        this.results.tests.security.corsWildcard = content.includes('origin: \"*\"');\r\n      }\r\n      \r\n    } catch (error) {\r\n      this.results.tests.security.error = error.message;\r\n    }\r\n  }\r\n\r\n  getAllJsFiles(dir) {\r\n    const files = [];\r\n    \r\n    function traverse(currentDir) {\r\n      const items = fs.readdirSync(currentDir);\r\n      items.forEach(item => {\r\n        const fullPath = path.join(currentDir, item);\r\n        const stat = fs.statSync(fullPath);\r\n        \r\n        if (stat.isDirectory()) {\r\n          traverse(fullPath);\r\n        } else if (item.endsWith('.js')) {\r\n          files.push(fullPath);\r\n        }\r\n      });\r\n    }\r\n    \r\n    traverse(dir);\r\n    return files;\r\n  }\r\n\r\n  saveResults() {\r\n    const filename = `test-results-${Date.now()}.json`;\r\n    fs.writeFileSync(filename, JSON.stringify(this.results, null, 2));\r\n    \r\n    console.log('\\nüìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:');\r\n    console.log(`‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤: ${filename}`);\r\n    \r\n    // –í—ã–≤–æ–¥ summary\r\n    console.log('\\nüìà Summary:');\r\n    \r\n    // –°–µ—Ä–≤–∏—Å—ã\r\n    const servicesTotal = Object.keys(this.results.tests.services).length;\r\n    const servicesExist = Object.values(this.results.tests.services)\r\n      .filter(s => s.exists).length;\r\n    console.log(`- –°–µ—Ä–≤–∏—Å—ã: ${servicesExist}/${servicesTotal} —Å—É—â–µ—Å—Ç–≤—É—é—Ç`);\r\n    \r\n    // –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏\r\n    if (this.results.tests.dependencies.vulnerabilities) {\r\n      const vuln = this.results.tests.dependencies.vulnerabilities;\r\n      if (typeof vuln === 'object') {\r\n        console.log(`- –£—è–∑–≤–∏–º–æ—Å—Ç–∏: ${vuln.total} (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö: ${vuln.critical})`);\r\n      }\r\n    }\r\n    \r\n    // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö\r\n    if (this.results.tests.database.connection) {\r\n      console.log(`- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: ${this.results.tests.database.connection}`);\r\n    }\r\n    \r\n    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å\r\n    if (this.results.tests.security.issues) {\r\n      console.log(`- –ü—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: ${this.results.tests.security.issues.length}`);\r\n    }\r\n    \r\n    // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\r\n    console.log('\\nüí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:');\r\n    this.generateRecommendations();\r\n  }\r\n\r\n  generateRecommendations() {\r\n    const recommendations = [];\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤\r\n    Object.entries(this.results.tests.services).forEach(([name, service]) => {\r\n      if (!service.exists) {\r\n        recommendations.push(`–°–µ—Ä–≤–∏—Å ${name} –Ω–µ –Ω–∞–π–¥–µ–Ω`);\r\n      } else if (!service.hasPackageJson) {\r\n        recommendations.push(`–î–æ–±–∞–≤–∏—Ç—å package.json –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ ${name}`);\r\n      } else if (!service.hasHealthCheck) {\r\n        recommendations.push(`–î–æ–±–∞–≤–∏—Ç—å health check –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ ${name}`);\r\n      } else if (!service.hasPortConfig) {\r\n        recommendations.push(`–ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–æ—Ä—Ç–æ–≤ –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ ${name}`);\r\n      }\r\n    });\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\r\n    if (this.results.tests.security.issues && this.results.tests.security.issues.length > 0) {\r\n      recommendations.push('–ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ –∫–æ–¥–µ');\r\n    }\r\n    \r\n    if (!this.results.tests.security.hasJwtSecret) {\r\n      recommendations.push('–î–æ–±–∞–≤–∏—Ç—å JWT_SECRET –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è');\r\n    }\r\n    \r\n    if (!this.results.tests.security.hasStrongJwtSecret) {\r\n      recommendations.push('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ —Å–∏–ª—å–Ω—ã–π JWT_SECRET (–º–∏–Ω–∏–º—É–º 32 —Å–∏–º–≤–æ–ª–∞)');\r\n    }\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\r\n    if (this.results.tests.database.connection && \r\n        this.results.tests.database.connection.includes('Failed')) {\r\n      recommendations.push('–ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');\r\n    }\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π\r\n    if (this.results.tests.dependencies.vulnerabilities && \r\n        typeof this.results.tests.dependencies.vulnerabilities === 'object' &&\r\n        this.results.tests.dependencies.vulnerabilities.critical > 0) {\r\n      recommendations.push('–ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö');\r\n    }\r\n    \r\n    recommendations.forEach((rec, index) => {\r\n      console.log(`  ${index + 1}. ${rec}`);\r\n    });\r\n    \r\n    if (recommendations.length === 0) {\r\n      console.log('  ‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ');\r\n    }\r\n  }\r\n}\r\n\r\n// –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤\r\nconst tester = new ProjectTester();\r\ntester.runAllTests().catch(console.error);\r\n",
  "services/audit/src/routes/reports.js": "const auditService = require('../services/auditService');\r\nconst incompleteDataService = require('../services/incompleteDataService');\r\n\r\nasync function reportsRoutes(fastify, options) {\r\n  // –û–±—â–∏–π –æ—Ç—á–µ—Ç –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã\r\n  fastify.get('/system-activity', {\r\n    preHandler: [fastify.authenticate],\r\n    schema: {\r\n      querystring: {\r\n        type: 'object',\r\n        properties: {\r\n          dateFrom: { type: 'string', format: 'date-time' },\r\n          dateTo: { type: 'string', format: 'date-time' },\r\n          groupBy: { type: 'string', enum: ['hour', 'day', 'week', 'month'], default: 'day' }\r\n        },\r\n        required: ['dateFrom', 'dateTo']\r\n      }\r\n    }\r\n  }, async (request, reply) => {\r\n    try {\r\n      const { dateFrom, dateTo, groupBy } = request.query;\r\n      \r\n      // –ü–æ–ª—É—á–∞–µ–º –±–∞–∑–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É\r\n      const stats = await auditService.getUserActivityStats(dateFrom, dateTo);\r\n      \r\n      // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º\r\n      const incompleteStats = await incompleteDataService.getIncompleteDataStats();\r\n      \r\n      return {\r\n        period: { dateFrom, dateTo, groupBy },\r\n        activity: stats,\r\n        incompleteData: incompleteStats,\r\n        generatedAt: new Date().toISOString()\r\n      };\r\n    } catch (error) {\r\n      reply.code(500).send({ error: error.message });\r\n    }\r\n  });\r\n\r\n  // –û—Ç—á–µ—Ç –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º\r\n  fastify.get('/users', {\r\n    preHandler: [fastify.authenticate],\r\n    schema: {\r\n      querystring: {\r\n        type: 'object',\r\n        properties: {\r\n          dateFrom: { type: 'string', format: 'date-time' },\r\n          dateTo: { type: 'string', format: 'date-time' },\r\n          userId: { type: 'string' },\r\n          includeInactive: { type: 'boolean', default: false }\r\n        }\r\n      }\r\n    }\r\n  }, async (request, reply) => {\r\n    try {\r\n      const { dateFrom, dateTo, userId, includeInactive } = request.query;\r\n      \r\n      const filters = {};\r\n      if (dateFrom) filters.dateFrom = dateFrom;\r\n      if (dateTo) filters.dateTo = dateTo;\r\n      if (userId) filters.userId = userId;\r\n\r\n      // –ü–æ–ª—É—á–∞–µ–º –ª–æ–≥–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏\r\n      const activityLogs = await auditService.getAuditLogs(filters, { page: 1, limit: 1000 });\r\n      \r\n      // –ü–æ–ª—É—á–∞–µ–º –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º\r\n      const incompleteData = await incompleteDataService.getIncompleteDataReport(\r\n        { userId, status: 'PENDING' },\r\n        { page: 1, limit: 100 }\r\n      );\r\n\r\n      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º\r\n      const userReport = {};\r\n      \r\n      for (const log of activityLogs.logs) {\r\n        if (!log.userId) continue;\r\n        \r\n        if (!userReport[log.userId]) {\r\n          userReport[log.userId] = {\r\n            user: log.user,\r\n            totalActions: 0,\r\n            actionsByType: {},\r\n            lastActivity: null,\r\n            incompleteDataCount: 0\r\n          };\r\n        }\r\n        \r\n        userReport[log.userId].totalActions++;\r\n        userReport[log.userId].actionsByType[log.action] = \r\n          (userReport[log.userId].actionsByType[log.action] || 0) + 1;\r\n        \r\n        if (!userReport[log.userId].lastActivity || \r\n            new Date(log.createdAt) > new Date(userReport[log.userId].lastActivity)) {\r\n          userReport[log.userId].lastActivity = log.createdAt;\r\n        }\r\n      }\r\n\r\n      // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö\r\n      for (const incomplete of incompleteData.incompleteData) {\r\n        if (incomplete.userId && userReport[incomplete.userId]) {\r\n          userReport[incomplete.userId].incompleteDataCount++;\r\n        }\r\n      }\r\n\r\n      return {\r\n        period: { dateFrom, dateTo },\r\n        users: Object.values(userReport),\r\n        summary: {\r\n          totalUsers: Object.keys(userReport).length,\r\n          totalActions: activityLogs.pagination.total,\r\n          totalIncompleteData: incompleteData.pagination.total\r\n        },\r\n        generatedAt: new Date().toISOString()\r\n      };\r\n    } catch (error) {\r\n      reply.code(500).send({ error: error.message });\r\n    }\r\n  });\r\n\r\n  // –û—Ç—á–µ—Ç –ø–æ —Å—É—â–Ω–æ—Å—Ç—è–º\r\n  fastify.get('/entities', {\r\n    preHandler: [fastify.authenticate],\r\n    schema: {\r\n      querystring: {\r\n        type: 'object',\r\n        properties: {\r\n          dateFrom: { type: 'string', format: 'date-time' },\r\n          dateTo: { type: 'string', format: 'date-time' },\r\n          entity: { type: 'string' }\r\n        }\r\n      }\r\n    }\r\n  }, async (request, reply) => {\r\n    try {\r\n      const { dateFrom, dateTo, entity } = request.query;\r\n      \r\n      const filters = {};\r\n      if (dateFrom) filters.dateFrom = dateFrom;\r\n      if (dateTo) filters.dateTo = dateTo;\r\n      if (entity) filters.entity = entity;\r\n\r\n      // –ü–æ–ª—É—á–∞–µ–º –ª–æ–≥–∏ –ø–æ —Å—É—â–Ω–æ—Å—Ç—è–º\r\n      const entityLogs = await auditService.getAuditLogs(filters, { page: 1, limit: 1000 });\r\n      \r\n      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Å—É—â–Ω–æ—Å—Ç—è–º\r\n      const entityReport = {};\r\n      \r\n      for (const log of entityLogs.logs) {\r\n        if (!entityReport[log.entity]) {\r\n          entityReport[log.entity] = {\r\n            entity: log.entity,\r\n            totalActions: 0,\r\n            actionsByType: {},\r\n            uniqueEntities: new Set(),\r\n            lastActivity: null\r\n          };\r\n        }\r\n        \r\n        entityReport[log.entity].totalActions++;\r\n        entityReport[log.entity].actionsByType[log.action] = \r\n          (entityReport[log.entity].actionsByType[log.action] || 0) + 1;\r\n        \r\n        if (log.entityId) {\r\n          entityReport[log.entity].uniqueEntities.add(log.entityId);\r\n        }\r\n        \r\n        if (!entityReport[log.entity].lastActivity || \r\n            new Date(log.createdAt) > new Date(entityReport[log.entity].lastActivity)) {\r\n          entityReport[log.entity].lastActivity = log.createdAt;\r\n        }\r\n      }\r\n\r\n      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Set –≤ —á–∏—Å–ª–æ\r\n      Object.values(entityReport).forEach(report => {\r\n        report.uniqueEntitiesCount = report.uniqueEntities.size;\r\n        delete report.uniqueEntities;\r\n      });\r\n\r\n      return {\r\n        period: { dateFrom, dateTo },\r\n        entities: Object.values(entityReport),\r\n        summary: {\r\n          totalEntities: Object.keys(entityReport).length,\r\n          totalActions: entityLogs.pagination.total\r\n        },\r\n        generatedAt: new Date().toISOString()\r\n      };\r\n    } catch (error) {\r\n      reply.code(500).send({ error: error.message });\r\n    }\r\n  });\r\n\r\n  // –û—Ç—á–µ—Ç –ø–æ –æ—à–∏–±–∫–∞–º –∏ –ø—Ä–æ–±–ª–µ–º–∞–º\r\n  fastify.get('/errors', {\r\n    preHandler: [fastify.authenticate],\r\n    schema: {\r\n      querystring: {\r\n        type: 'object',\r\n        properties: {\r\n          dateFrom: { type: 'string', format: 'date-time' },\r\n          dateTo: { type: 'string', format: 'date-time' },\r\n          severity: { type: 'string', enum: ['INFO', 'WARNING', 'ERROR', 'CRITICAL'] }\r\n        }\r\n      }\r\n    }\r\n  }, async (request, reply) => {\r\n    try {\r\n      const { dateFrom, dateTo, severity } = request.query;\r\n      \r\n      const filters = {\r\n        action: 'ERROR'\r\n      };\r\n      if (dateFrom) filters.dateFrom = dateFrom;\r\n      if (dateTo) filters.dateTo = dateTo;\r\n\r\n      // –ü–æ–ª—É—á–∞–µ–º –ª–æ–≥–∏ –æ—à–∏–±–æ–∫\r\n      const errorLogs = await auditService.getAuditLogs(filters, { page: 1, limit: 500 });\r\n      \r\n      // –ü–æ–ª—É—á–∞–µ–º –ª–æ–≥–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å –æ—à–∏–±–∫–∞–º–∏\r\n      const { PrismaClient } = require('@prisma/client');\r\n      const prisma = new PrismaClient();\r\n      \r\n      const validationWhere = {\r\n        isValid: false\r\n      };\r\n      if (severity) validationWhere.severity = severity;\r\n      if (dateFrom) validationWhere.createdAt = { gte: new Date(dateFrom) };\r\n      if (dateTo) {\r\n        if (validationWhere.createdAt) {\r\n          validationWhere.createdAt.lte = new Date(dateTo);\r\n        } else {\r\n          validationWhere.createdAt = { lte: new Date(dateTo) };\r\n        }\r\n      }\r\n\r\n      const validationErrors = await prisma.dataValidationLog.findMany({\r\n        where: validationWhere,\r\n        include: {\r\n          user: {\r\n            select: { id: true, name: true, email: true }\r\n          }\r\n        },\r\n        orderBy: { createdAt: 'desc' },\r\n        take: 200\r\n      });\r\n\r\n      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏\r\n      const errorsByType = {};\r\n      const errorsByEntity = {};\r\n      \r\n      for (const error of errorLogs.logs) {\r\n        const errorType = error.metadata?.errorType || 'SYSTEM_ERROR';\r\n        errorsByType[errorType] = (errorsByType[errorType] || 0) + 1;\r\n        errorsByEntity[error.entity] = (errorsByEntity[error.entity] || 0) + 1;\r\n      }\r\n\r\n      const validationErrorsByField = {};\r\n      const validationErrorsBySeverity = {};\r\n      \r\n      for (const error of validationErrors) {\r\n        const key = `${error.entity}.${error.fieldName}`;\r\n        validationErrorsByField[key] = (validationErrorsByField[key] || 0) + 1;\r\n        validationErrorsBySeverity[error.severity] = (validationErrorsBySeverity[error.severity] || 0) + 1;\r\n      }\r\n\r\n      return {\r\n        period: { dateFrom, dateTo },\r\n        systemErrors: {\r\n          total: errorLogs.pagination.total,\r\n          byType: errorsByType,\r\n          byEntity: errorsByEntity,\r\n          recent: errorLogs.logs.slice(0, 10)\r\n        },\r\n        validationErrors: {\r\n          total: validationErrors.length,\r\n          byField: validationErrorsByField,\r\n          bySeverity: validationErrorsBySeverity,\r\n          recent: validationErrors.slice(0, 10)\r\n        },\r\n        generatedAt: new Date().toISOString()\r\n      };\r\n    } catch (error) {\r\n      reply.code(500).send({ error: error.message });\r\n    }\r\n  });\r\n\r\n  // –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–∞ –≤ CSV\r\n  fastify.get('/export/:reportType', {\r\n    preHandler: [fastify.authenticate],\r\n    schema: {\r\n      params: {\r\n        type: 'object',\r\n        properties: {\r\n          reportType: { type: 'string', enum: ['audit-logs', 'incomplete-data', 'user-activity'] }\r\n        },\r\n        required: ['reportType']\r\n      },\r\n      querystring: {\r\n        type: 'object',\r\n        properties: {\r\n          dateFrom: { type: 'string', format: 'date-time' },\r\n          dateTo: { type: 'string', format: 'date-time' },\r\n          format: { type: 'string', enum: ['csv', 'json'], default: 'csv' }\r\n        }\r\n      }\r\n    }\r\n  }, async (request, reply) => {\r\n    try {\r\n      const { reportType } = request.params;\r\n      const { dateFrom, dateTo, format } = request.query;\r\n      \r\n      let data;\r\n      let filename;\r\n      \r\n      switch (reportType) {\r\n        case 'audit-logs':\r\n          const auditData = await auditService.getAuditLogs(\r\n            { dateFrom, dateTo },\r\n            { page: 1, limit: 10000 }\r\n          );\r\n          data = auditData.logs;\r\n          filename = `audit-logs-${new Date().toISOString().split('T')[0]}`;\r\n          break;\r\n          \r\n        case 'incomplete-data':\r\n          const incompleteData = await incompleteDataService.getIncompleteDataReport(\r\n            { dateFrom, dateTo },\r\n            { page: 1, limit: 10000 }\r\n          );\r\n          data = incompleteData.incompleteData;\r\n          filename = `incomplete-data-${new Date().toISOString().split('T')[0]}`;\r\n          break;\r\n          \r\n        case 'user-activity':\r\n          const activityStats = await auditService.getUserActivityStats(\r\n            dateFrom || new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(),\r\n            dateTo || new Date().toISOString()\r\n          );\r\n          data = activityStats.userActions;\r\n          filename = `user-activity-${new Date().toISOString().split('T')[0]}`;\r\n          break;\r\n          \r\n        default:\r\n          return reply.code(400).send({ error: '–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø –æ—Ç—á–µ—Ç–∞' });\r\n      }\r\n\r\n      if (format === 'json') {\r\n        reply.header('Content-Type', 'application/json');\r\n        reply.header('Content-Disposition', `attachment; filename=\"${filename}.json\"`);\r\n        return data;\r\n      } else {\r\n        // –ü—Ä–æ—Å—Ç–∞—è CSV –≥–µ–Ω–µ—Ä–∞—Ü–∏—è\r\n        const csvData = convertToCSV(data);\r\n        reply.header('Content-Type', 'text/csv');\r\n        reply.header('Content-Disposition', `attachment; filename=\"${filename}.csv\"`);\r\n        return csvData;\r\n      }\r\n    } catch (error) {\r\n      reply.code(500).send({ error: error.message });\r\n    }\r\n  });\r\n}\r\n\r\n// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ CSV\r\nfunction convertToCSV(data) {\r\n  if (!data || data.length === 0) {\r\n    return '';\r\n  }\r\n  \r\n  const headers = Object.keys(data[0]);\r\n  const csvRows = [];\r\n  \r\n  // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏\r\n  csvRows.push(headers.join(','));\r\n  \r\n  // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ\r\n  for (const row of data) {\r\n    const values = headers.map(header => {\r\n      const value = row[header];\r\n      if (value === null || value === undefined) {\r\n        return '';\r\n      }\r\n      if (typeof value === 'object') {\r\n        return `\"${JSON.stringify(value).replace(/\"/g, '\"\"')}\"`;\r\n      }\r\n      return `\"${String(value).replace(/\"/g, '\"\"')}\"`;\r\n    });\r\n    csvRows.push(values.join(','));\r\n  }\r\n  \r\n  return csvRows.join('\\n');\r\n}\r\n\r\nmodule.exports = reportsRoutes;\r\n",
  "services/audit/src/services/auditService.js": "const { PrismaClient } = require('@prisma/client');\r\nconst moment = require('moment');\r\nconst _ = require('lodash');\r\n\r\nconst prisma = new PrismaClient();\r\n\r\nclass AuditService {\r\n  /**\r\n   * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è\r\n   */\r\n  async logSystemAction(data) {\r\n    try {\r\n      const auditLog = await prisma.systemAuditLog.create({\r\n        data: {\r\n          userId: data.userId,\r\n          sessionId: data.sessionId,\r\n          action: data.action,\r\n          entity: data.entity,\r\n          entityId: data.entityId,\r\n          description: data.description,\r\n          oldValues: data.oldValues,\r\n          newValues: data.newValues,\r\n          inputData: data.inputData,\r\n          ipAddress: data.ipAddress,\r\n          userAgent: data.userAgent,\r\n          endpoint: data.endpoint,\r\n          method: data.method,\r\n          statusCode: data.statusCode,\r\n          responseTime: data.responseTime,\r\n          errorMessage: data.errorMessage,\r\n          metadata: data.metadata\r\n        }\r\n      });\r\n\r\n      return auditLog;\r\n    } catch (error) {\r\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è:', error);\r\n      // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö\r\n   */\r\n  async logDataChange(userId, entity, entityId, oldData, newData, action = 'UPDATE') {\r\n    try {\r\n      const changes = this.calculateChanges(oldData, newData);\r\n      \r\n      await this.logSystemAction({\r\n        userId,\r\n        action,\r\n        entity,\r\n        entityId,\r\n        description: `${action} ${entity} ${entityId}`,\r\n        oldValues: oldData,\r\n        newValues: newData,\r\n        metadata: { changes }\r\n      });\r\n\r\n      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø–æ–ª—è\r\n      await this.checkIncompleteData(userId, entity, entityId, newData);\r\n\r\n    } catch (error) {\r\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –º–µ–∂–¥—É —Å—Ç–∞—Ä—ã–º–∏ –∏ –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏\r\n   */\r\n  calculateChanges(oldData, newData) {\r\n    const changes = {};\r\n    \r\n    if (!oldData && newData) {\r\n      return { type: 'CREATE', data: newData };\r\n    }\r\n    \r\n    if (oldData && !newData) {\r\n      return { type: 'DELETE', data: oldData };\r\n    }\r\n\r\n    const allKeys = new Set([...Object.keys(oldData || {}), ...Object.keys(newData || {})]);\r\n    \r\n    for (const key of allKeys) {\r\n      const oldValue = oldData?.[key];\r\n      const newValue = newData?.[key];\r\n      \r\n      if (!_.isEqual(oldValue, newValue)) {\r\n        changes[key] = {\r\n          from: oldValue,\r\n          to: newValue\r\n        };\r\n      }\r\n    }\r\n\r\n    return changes;\r\n  }\r\n\r\n  /**\r\n   * –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\r\n   */\r\n  async checkIncompleteData(userId, entity, entityId, data) {\r\n    try {\r\n      const requiredFields = this.getRequiredFields(entity);\r\n      const missingFields = [];\r\n      const partialData = {};\r\n\r\n      for (const field of requiredFields) {\r\n        const value = data?.[field];\r\n        if (!value || (typeof value === 'string' && value.trim() === '')) {\r\n          missingFields.push(field);\r\n        } else {\r\n          partialData[field] = value;\r\n        }\r\n      }\r\n\r\n      if (missingFields.length > 0) {\r\n        const completionRate = ((requiredFields.length - missingFields.length) / requiredFields.length) * 100;\r\n\r\n        await prisma.incompleteDataLog.upsert({\r\n          where: {\r\n            entity_entityId: {\r\n              entity,\r\n              entityId\r\n            }\r\n          },\r\n          update: {\r\n            userId,\r\n            requiredFields,\r\n            missingFields,\r\n            partialData,\r\n            completionRate,\r\n            status: completionRate === 100 ? 'COMPLETED' : 'PENDING',\r\n            completedAt: completionRate === 100 ? new Date() : null,\r\n            updatedAt: new Date()\r\n          },\r\n          create: {\r\n            userId,\r\n            entity,\r\n            entityId,\r\n            requiredFields,\r\n            missingFields,\r\n            partialData,\r\n            completionRate,\r\n            status: completionRate === 100 ? 'COMPLETED' : 'PENDING',\r\n            completedAt: completionRate === 100 ? new Date() : null\r\n          }\r\n        });\r\n      }\r\n    } catch (error) {\r\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –¥–ª—è —Å—É—â–Ω–æ—Å—Ç–∏\r\n   */\r\n  getRequiredFields(entity) {\r\n    const requiredFieldsMap = {\r\n      'User': ['name', 'email', 'phoneNumber'],\r\n      'Machine': ['code', 'serialNumber', 'type', 'name', 'locationId'],\r\n      'Task': ['title', 'description', 'assignedToId', 'dueDate'],\r\n      'InventoryItem': ['name', 'sku', 'unit', 'category', 'minQuantity'],\r\n      'Location': ['name', 'address'],\r\n      'Route': ['name', 'driverId', 'startTime'],\r\n      'ServiceHistory': ['machineId', 'serviceType', 'description', 'performedById'],\r\n      'StockMovement': ['itemId', 'userId', 'type', 'quantity', 'reason'],\r\n      'Recipe': ['name', 'description'],\r\n      'DriverLog': ['driverId', 'type', 'description']\r\n    };\r\n\r\n    return requiredFieldsMap[entity] || [];\r\n  }\r\n\r\n  /**\r\n   * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n   */\r\n  async logUserLogin(userId, sessionId, ipAddress, userAgent) {\r\n    try {\r\n      // –°–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n      await prisma.userSession.create({\r\n        data: {\r\n          userId,\r\n          sessionId,\r\n          ipAddress,\r\n          userAgent,\r\n          loginAt: new Date(),\r\n          lastActivity: new Date(),\r\n          isActive: true\r\n        }\r\n      });\r\n\r\n      // –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ\r\n      await this.logSystemAction({\r\n        userId,\r\n        sessionId,\r\n        action: 'LOGIN',\r\n        entity: 'USER_SESSION',\r\n        entityId: userId,\r\n        description: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É',\r\n        ipAddress,\r\n        userAgent\r\n      });\r\n\r\n      // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ö–æ–¥–∞\r\n      await prisma.user.update({\r\n        where: { id: userId },\r\n        data: { lastLogin: new Date() }\r\n      });\r\n\r\n    } catch (error) {\r\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ –≤—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n   */\r\n  async logUserLogout(userId, sessionId) {\r\n    try {\r\n      // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–µ—Å—Å–∏—é\r\n      await prisma.userSession.updateMany({\r\n        where: {\r\n          userId,\r\n          sessionId,\r\n          isActive: true\r\n        },\r\n        data: {\r\n          logoutAt: new Date(),\r\n          isActive: false\r\n        }\r\n      });\r\n\r\n      // –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ\r\n      await this.logSystemAction({\r\n        userId,\r\n        sessionId,\r\n        action: 'LOGOUT',\r\n        entity: 'USER_SESSION',\r\n        entityId: userId,\r\n        description: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª –∏–∑ —Å–∏—Å—Ç–µ–º—ã'\r\n      });\r\n\r\n    } catch (error) {\r\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ –≤—ã—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n   */\r\n  async updateUserActivity(userId, sessionId) {\r\n    try {\r\n      await prisma.userSession.updateMany({\r\n        where: {\r\n          userId,\r\n          sessionId,\r\n          isActive: true\r\n        },\r\n        data: {\r\n          lastActivity: new Date()\r\n        }\r\n      });\r\n    } catch (error) {\r\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –ü–æ–ª—É—á–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –∞—É–¥–∏—Ç–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π\r\n   */\r\n  async getAuditLogs(filters = {}, pagination = {}) {\r\n    try {\r\n      const {\r\n        userId,\r\n        action,\r\n        entity,\r\n        dateFrom,\r\n        dateTo,\r\n        sessionId\r\n      } = filters;\r\n\r\n      const {\r\n        page = 1,\r\n        limit = 50\r\n      } = pagination;\r\n\r\n      const where = {};\r\n\r\n      if (userId) where.userId = userId;\r\n      if (action) where.action = action;\r\n      if (entity) where.entity = entity;\r\n      if (sessionId) where.sessionId = sessionId;\r\n      \r\n      if (dateFrom || dateTo) {\r\n        where.createdAt = {};\r\n        if (dateFrom) where.createdAt.gte = new Date(dateFrom);\r\n        if (dateTo) where.createdAt.lte = new Date(dateTo);\r\n      }\r\n\r\n      const [logs, total] = await Promise.all([\r\n        prisma.systemAuditLog.findMany({\r\n          where,\r\n          include: {\r\n            user: {\r\n              select: {\r\n                id: true,\r\n                name: true,\r\n                email: true\r\n              }\r\n            }\r\n          },\r\n          orderBy: {\r\n            createdAt: 'desc'\r\n          },\r\n          skip: (page - 1) * limit,\r\n          take: limit\r\n        }),\r\n        prisma.systemAuditLog.count({ where })\r\n      ]);\r\n\r\n      return {\r\n        logs,\r\n        pagination: {\r\n          page,\r\n          limit,\r\n          total,\r\n          pages: Math.ceil(total / limit)\r\n        }\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ª–æ–≥–æ–≤ –∞—É–¥–∏—Ç–∞:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\r\n   */\r\n  async getUserActivityStats(dateFrom, dateTo) {\r\n    try {\r\n      const where = {\r\n        createdAt: {\r\n          gte: new Date(dateFrom),\r\n          lte: new Date(dateTo)\r\n        }\r\n      };\r\n\r\n      const [totalActions, userActions, topActions, topEntities] = await Promise.all([\r\n        // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ–π—Å—Ç–≤–∏–π\r\n        prisma.systemAuditLog.count({ where }),\r\n        \r\n        // –î–µ–π—Å—Ç–≤–∏—è –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º\r\n        prisma.systemAuditLog.groupBy({\r\n          by: ['userId'],\r\n          where,\r\n          _count: {\r\n            id: true\r\n          },\r\n          orderBy: {\r\n            _count: {\r\n              id: 'desc'\r\n            }\r\n          },\r\n          take: 10\r\n        }),\r\n        \r\n        // –¢–æ–ø –¥–µ–π—Å—Ç–≤–∏–π\r\n        prisma.systemAuditLog.groupBy({\r\n          by: ['action'],\r\n          where,\r\n          _count: {\r\n            id: true\r\n          },\r\n          orderBy: {\r\n            _count: {\r\n              id: 'desc'\r\n            }\r\n          },\r\n          take: 10\r\n        }),\r\n        \r\n        // –¢–æ–ø —Å—É—â–Ω–æ—Å—Ç–µ–π\r\n        prisma.systemAuditLog.groupBy({\r\n          by: ['entity'],\r\n          where,\r\n          _count: {\r\n            id: true\r\n          },\r\n          orderBy: {\r\n            _count: {\r\n              id: 'desc'\r\n            }\r\n          },\r\n          take: 10\r\n        })\r\n      ]);\r\n\r\n      // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö\r\n      const userIds = userActions.map(ua => ua.userId).filter(Boolean);\r\n      const users = await prisma.user.findMany({\r\n        where: { id: { in: userIds } },\r\n        select: { id: true, name: true, email: true }\r\n      });\r\n\r\n      const userMap = users.reduce((acc, user) => {\r\n        acc[user.id] = user;\r\n        return acc;\r\n      }, {});\r\n\r\n      const userActionsWithNames = userActions.map(ua => ({\r\n        ...ua,\r\n        user: ua.userId ? userMap[ua.userId] : null\r\n      }));\r\n\r\n      return {\r\n        totalActions,\r\n        userActions: userActionsWithNames,\r\n        topActions,\r\n        topEntities\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤\r\n   */\r\n  async cleanupOldLogs() {\r\n    try {\r\n      const retentionDays = parseInt(process.env.AUDIT_RETENTION_DAYS) || 90;\r\n      const cutoffDate = moment().subtract(retentionDays, 'days').toDate();\r\n\r\n      const [deletedAuditLogs, deletedSystemLogs] = await Promise.all([\r\n        prisma.auditLog.deleteMany({\r\n          where: {\r\n            createdAt: {\r\n              lt: cutoffDate\r\n            }\r\n          }\r\n        }),\r\n        prisma.systemAuditLog.deleteMany({\r\n          where: {\r\n            createdAt: {\r\n              lt: cutoffDate\r\n            }\r\n          }\r\n        })\r\n      ]);\r\n\r\n      console.log(`–û—á–∏—â–µ–Ω–æ ${deletedAuditLogs.count} —Å—Ç–∞—Ä—ã—Ö audit –ª–æ–≥–æ–≤ –∏ ${deletedSystemLogs.count} —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ª–æ–≥–æ–≤`);\r\n\r\n      return {\r\n        deletedAuditLogs: deletedAuditLogs.count,\r\n        deletedSystemLogs: deletedSystemLogs.count\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö\r\n   */\r\n  async validateData(userId, entity, entityId, fieldName, fieldValue, validationType) {\r\n    try {\r\n      let isValid = true;\r\n      let errorMessage = null;\r\n\r\n      switch (validationType) {\r\n        case 'REQUIRED':\r\n          isValid = fieldValue !== null && fieldValue !== undefined && fieldValue !== '';\r\n          if (!isValid) errorMessage = '–ü–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è';\r\n          break;\r\n          \r\n        case 'FORMAT':\r\n          // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ email\r\n          if (fieldName === 'email') {\r\n            const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n            isValid = emailRegex.test(fieldValue);\r\n            if (!isValid) errorMessage = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email';\r\n          }\r\n          break;\r\n          \r\n        case 'LENGTH':\r\n          if (typeof fieldValue === 'string') {\r\n            isValid = fieldValue.length >= 3 && fieldValue.length <= 255;\r\n            if (!isValid) errorMessage = '–î–ª–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 3 –¥–æ 255 —Å–∏–º–≤–æ–ª–æ–≤';\r\n          }\r\n          break;\r\n          \r\n        case 'UNIQUE':\r\n          // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è)\r\n          if (entity === 'User' && fieldName === 'email') {\r\n            const existingUser = await prisma.user.findFirst({\r\n              where: {\r\n                email: fieldValue,\r\n                id: { not: entityId }\r\n              }\r\n            });\r\n            isValid = !existingUser;\r\n            if (!isValid) errorMessage = 'Email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è';\r\n          }\r\n          break;\r\n      }\r\n\r\n      // –õ–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏\r\n      await prisma.dataValidationLog.create({\r\n        data: {\r\n          userId,\r\n          entity,\r\n          entityId,\r\n          fieldName,\r\n          fieldValue: String(fieldValue),\r\n          validationType,\r\n          isValid,\r\n          errorMessage,\r\n          severity: isValid ? 'INFO' : 'ERROR'\r\n        }\r\n      });\r\n\r\n      return { isValid, errorMessage };\r\n\r\n    } catch (error) {\r\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö:', error);\r\n      return { isValid: false, errorMessage: '–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏' };\r\n    }\r\n  }\r\n}\r\n\r\nmodule.exports = new AuditService();\r\n",
  "services/audit/src/services/incompleteDataService.js": "const { PrismaClient } = require('@prisma/client');\r\nconst moment = require('moment');\r\n\r\nconst prisma = new PrismaClient();\r\n\r\nclass IncompleteDataService {\r\n  /**\r\n   * –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –ø–æ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º\r\n   */\r\n  async getIncompleteDataReport(filters = {}, pagination = {}) {\r\n    try {\r\n      const {\r\n        userId,\r\n        entity,\r\n        status,\r\n        completionRateMin,\r\n        completionRateMax,\r\n        dateFrom,\r\n        dateTo\r\n      } = filters;\r\n\r\n      const {\r\n        page = 1,\r\n        limit = 50\r\n      } = pagination;\r\n\r\n      const where = {};\r\n\r\n      if (userId) where.userId = userId;\r\n      if (entity) where.entity = entity;\r\n      if (status) where.status = status;\r\n      \r\n      if (completionRateMin !== undefined || completionRateMax !== undefined) {\r\n        where.completionRate = {};\r\n        if (completionRateMin !== undefined) where.completionRate.gte = completionRateMin;\r\n        if (completionRateMax !== undefined) where.completionRate.lte = completionRateMax;\r\n      }\r\n      \r\n      if (dateFrom || dateTo) {\r\n        where.createdAt = {};\r\n        if (dateFrom) where.createdAt.gte = new Date(dateFrom);\r\n        if (dateTo) where.createdAt.lte = new Date(dateTo);\r\n      }\r\n\r\n      const [incompleteData, total] = await Promise.all([\r\n        prisma.incompleteDataLog.findMany({\r\n          where,\r\n          include: {\r\n            user: {\r\n              select: {\r\n                id: true,\r\n                name: true,\r\n                email: true\r\n              }\r\n            }\r\n          },\r\n          orderBy: [\r\n            { completionRate: 'asc' },\r\n            { createdAt: 'desc' }\r\n          ],\r\n          skip: (page - 1) * limit,\r\n          take: limit\r\n        }),\r\n        prisma.incompleteDataLog.count({ where })\r\n      ]);\r\n\r\n      return {\r\n        incompleteData,\r\n        pagination: {\r\n          page,\r\n          limit,\r\n          total,\r\n          pages: Math.ceil(total / limit)\r\n        }\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞ –ø–æ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º\r\n   */\r\n  async getIncompleteDataStats() {\r\n    try {\r\n      const [\r\n        totalIncomplete,\r\n        byEntity,\r\n        byUser,\r\n        byStatus,\r\n        avgCompletionRate,\r\n        oldestIncomplete\r\n      ] = await Promise.all([\r\n        // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π\r\n        prisma.incompleteDataLog.count({\r\n          where: { status: { not: 'COMPLETED' } }\r\n        }),\r\n        \r\n        // –ü–æ —Å—É—â–Ω–æ—Å—Ç—è–º\r\n        prisma.incompleteDataLog.groupBy({\r\n          by: ['entity'],\r\n          where: { status: { not: 'COMPLETED' } },\r\n          _count: { id: true },\r\n          _avg: { completionRate: true },\r\n          orderBy: { _count: { id: 'desc' } }\r\n        }),\r\n        \r\n        // –ü–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º\r\n        prisma.incompleteDataLog.groupBy({\r\n          by: ['userId'],\r\n          where: { \r\n            status: { not: 'COMPLETED' },\r\n            userId: { not: null }\r\n          },\r\n          _count: { id: true },\r\n          _avg: { completionRate: true },\r\n          orderBy: { _count: { id: 'desc' } },\r\n          take: 10\r\n        }),\r\n        \r\n        // –ü–æ —Å—Ç–∞—Ç—É—Å–∞–º\r\n        prisma.incompleteDataLog.groupBy({\r\n          by: ['status'],\r\n          _count: { id: true },\r\n          orderBy: { _count: { id: 'desc' } }\r\n        }),\r\n        \r\n        // –°—Ä–µ–¥–Ω–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è\r\n        prisma.incompleteDataLog.aggregate({\r\n          where: { status: { not: 'COMPLETED' } },\r\n          _avg: { completionRate: true }\r\n        }),\r\n        \r\n        // –°–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏\r\n        prisma.incompleteDataLog.findMany({\r\n          where: { status: { not: 'COMPLETED' } },\r\n          include: {\r\n            user: {\r\n              select: { id: true, name: true, email: true }\r\n            }\r\n          },\r\n          orderBy: { createdAt: 'asc' },\r\n          take: 5\r\n        })\r\n      ]);\r\n\r\n      // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö\r\n      const userIds = byUser.map(u => u.userId).filter(Boolean);\r\n      const users = await prisma.user.findMany({\r\n        where: { id: { in: userIds } },\r\n        select: { id: true, name: true, email: true }\r\n      });\r\n\r\n      const userMap = users.reduce((acc, user) => {\r\n        acc[user.id] = user;\r\n        return acc;\r\n      }, {});\r\n\r\n      const byUserWithNames = byUser.map(u => ({\r\n        ...u,\r\n        user: u.userId ? userMap[u.userId] : null\r\n      }));\r\n\r\n      return {\r\n        totalIncomplete,\r\n        byEntity,\r\n        byUser: byUserWithNames,\r\n        byStatus,\r\n        avgCompletionRate: avgCompletionRate._avg.completionRate || 0,\r\n        oldestIncomplete\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö\r\n   */\r\n  async sendReminders() {\r\n    try {\r\n      const pendingData = await prisma.incompleteDataLog.findMany({\r\n        where: {\r\n          status: 'PENDING',\r\n          userId: { not: null },\r\n          OR: [\r\n            { lastReminderAt: null },\r\n            { \r\n              lastReminderAt: {\r\n                lt: moment().subtract(24, 'hours').toDate()\r\n              }\r\n            }\r\n          ]\r\n        },\r\n        include: {\r\n          user: {\r\n            select: { id: true, name: true, email: true, telegramId: true }\r\n          }\r\n        },\r\n        take: 100 // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∑–∞ —Ä–∞–∑\r\n      });\r\n\r\n      const reminders = [];\r\n\r\n      for (const item of pendingData) {\r\n        try {\r\n          // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ\r\n          const notification = await prisma.notification.create({\r\n            data: {\r\n              userId: item.userId,\r\n              type: 'SYSTEM_ALERT',\r\n              title: '–ù–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ',\r\n              message: `–£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø–æ–ª—è –≤ ${item.entity}. –ü—Ä–æ—Ü–µ–Ω—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è: ${item.completionRate.toFixed(1)}%`,\r\n              data: {\r\n                entity: item.entity,\r\n                entityId: item.entityId,\r\n                missingFields: item.missingFields,\r\n                completionRate: item.completionRate\r\n              }\r\n            }\r\n          });\r\n\r\n          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π\r\n          await prisma.incompleteDataLog.update({\r\n            where: { id: item.id },\r\n            data: {\r\n              remindersSent: item.remindersSent + 1,\r\n              lastReminderAt: new Date()\r\n            }\r\n          });\r\n\r\n          reminders.push({\r\n            userId: item.userId,\r\n            entity: item.entity,\r\n            entityId: item.entityId,\r\n            notificationId: notification.id\r\n          });\r\n\r\n        } catch (error) {\r\n          console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è ${item.id}:`, error);\r\n        }\r\n      }\r\n\r\n      console.log(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${reminders.length} –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö`);\r\n      return reminders;\r\n\r\n    } catch (error) {\r\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (cron –∑–∞–¥–∞—á–∞)\r\n   */\r\n  async processIncompleteData() {\r\n    try {\r\n      console.log('–ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...');\r\n\r\n      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è\r\n      const reminders = await this.sendReminders();\r\n\r\n      // –ü–æ–º–µ—á–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –∫–∞–∫ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ\r\n      const expiredThreshold = moment().subtract(30, 'days').toDate();\r\n      const expiredResult = await prisma.incompleteDataLog.updateMany({\r\n        where: {\r\n          status: 'PENDING',\r\n          createdAt: { lt: expiredThreshold }\r\n        },\r\n        data: {\r\n          status: 'EXPIRED'\r\n        }\r\n      });\r\n\r\n      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏\r\n      const completedResult = await prisma.incompleteDataLog.updateMany({\r\n        where: {\r\n          status: { in: ['PENDING', 'IN_PROGRESS'] },\r\n          completionRate: 100\r\n        },\r\n        data: {\r\n          status: 'COMPLETED',\r\n          completedAt: new Date()\r\n        }\r\n      });\r\n\r\n      console.log(`–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞:\r\n        - –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π: ${reminders.length}\r\n        - –ü–æ–º–µ—á–µ–Ω–æ –∫–∞–∫ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ: ${expiredResult.count}\r\n        - –ü–æ–º–µ—á–µ–Ω–æ –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ: ${completedResult.count}`);\r\n\r\n      return {\r\n        remindersSent: reminders.length,\r\n        expired: expiredResult.count,\r\n        completed: completedResult.count\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏\r\n   */\r\n  async getIncompleteDataDetails(id) {\r\n    try {\r\n      const incompleteData = await prisma.incompleteDataLog.findUnique({\r\n        where: { id },\r\n        include: {\r\n          user: {\r\n            select: {\r\n              id: true,\r\n              name: true,\r\n              email: true,\r\n              phoneNumber: true\r\n            }\r\n          }\r\n        }\r\n      });\r\n\r\n      if (!incompleteData) {\r\n        throw new Error('–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');\r\n      }\r\n\r\n      // –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —ç—Ç–æ–π —Å—É—â–Ω–æ—Å—Ç–∏\r\n      const auditHistory = await prisma.systemAuditLog.findMany({\r\n        where: {\r\n          entity: incompleteData.entity,\r\n          entityId: incompleteData.entityId\r\n        },\r\n        include: {\r\n          user: {\r\n            select: { id: true, name: true, email: true }\r\n          }\r\n        },\r\n        orderBy: { createdAt: 'desc' },\r\n        take: 10\r\n      });\r\n\r\n      return {\r\n        ...incompleteData,\r\n        auditHistory\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–µ—Ç–∞–ª–µ–π –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏\r\n   */\r\n  async updateIncompleteDataStatus(id, status, userId) {\r\n    try {\r\n      const updatedRecord = await prisma.incompleteDataLog.update({\r\n        where: { id },\r\n        data: {\r\n          status,\r\n          completedAt: status === 'COMPLETED' ? new Date() : null,\r\n          updatedAt: new Date()\r\n        }\r\n      });\r\n\r\n      // –õ–æ–≥–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞\r\n      const auditService = require('./auditService');\r\n      await auditService.logSystemAction({\r\n        userId,\r\n        action: 'UPDATE',\r\n        entity: 'INCOMPLETE_DATA_LOG',\r\n        entityId: id,\r\n        description: `–ò–∑–º–µ–Ω–µ–Ω —Å—Ç–∞—Ç—É—Å –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ ${status}`,\r\n        newValues: { status }\r\n      });\r\n\r\n      return updatedRecord;\r\n\r\n    } catch (error) {\r\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—é –¥–∞–Ω–Ω—ã—Ö\r\n   */\r\n  async getCompletionRecommendations(entity, entityId) {\r\n    try {\r\n      const incompleteData = await prisma.incompleteDataLog.findUnique({\r\n        where: {\r\n          entity_entityId: {\r\n            entity,\r\n            entityId\r\n          }\r\n        }\r\n      });\r\n\r\n      if (!incompleteData) {\r\n        return { recommendations: [] };\r\n      }\r\n\r\n      const recommendations = [];\r\n\r\n      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –ø–æ–ª–µ–π\r\n      for (const field of incompleteData.missingFields) {\r\n        const recommendation = this.getFieldRecommendation(entity, field);\r\n        if (recommendation) {\r\n          recommendations.push(recommendation);\r\n        }\r\n      }\r\n\r\n      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É\r\n      recommendations.sort((a, b) => b.priority - a.priority);\r\n\r\n      return {\r\n        entity,\r\n        entityId,\r\n        completionRate: incompleteData.completionRate,\r\n        missingFields: incompleteData.missingFields,\r\n        recommendations\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—è\r\n   */\r\n  getFieldRecommendation(entity, field) {\r\n    const recommendations = {\r\n      'User': {\r\n        'phoneNumber': {\r\n          title: '–î–æ–±–∞–≤—å—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞',\r\n          description: '–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è —Å–≤—è–∑–∏ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π',\r\n          priority: 8,\r\n          example: '+998901234567'\r\n        },\r\n        'email': {\r\n          title: '–£–∫–∞–∂–∏—Ç–µ email –∞–¥—Ä–µ—Å',\r\n          description: 'Email –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π',\r\n          priority: 10,\r\n          example: 'user@example.com'\r\n        }\r\n      },\r\n      'Machine': {\r\n        'locationId': {\r\n          title: '–£–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∞',\r\n          description: '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤',\r\n          priority: 9,\r\n          example: '–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ª–æ–∫–∞—Ü–∏–π'\r\n        },\r\n        'serialNumber': {\r\n          title: '–î–æ–±–∞–≤—å—Ç–µ —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä',\r\n          description: '–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –Ω—É–∂–µ–Ω –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è',\r\n          priority: 8,\r\n          example: 'SN123456789'\r\n        }\r\n      },\r\n      'Task': {\r\n        'dueDate': {\r\n          title: '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è',\r\n          description: '–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–º–æ–≥–∞–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É',\r\n          priority: 7,\r\n          example: '–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è'\r\n        },\r\n        'assignedToId': {\r\n          title: '–ù–∞–∑–Ω–∞—á—å—Ç–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è',\r\n          description: '–ó–∞–¥–∞—á–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É',\r\n          priority: 9,\r\n          example: '–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤'\r\n        }\r\n      }\r\n    };\r\n\r\n    return recommendations[entity]?.[field] || {\r\n      title: `–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ ${field}`,\r\n      description: '–≠—Ç–æ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è',\r\n      priority: 5,\r\n      example: '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ'\r\n    };\r\n  }\r\n}\r\n\r\nmodule.exports = new IncompleteDataService();\r\n",
  "services/machines/src/index.js": "/**\r\n * VHM24 - VendHub Manager 24/7\r\n * Machines Service - PRODUCTION READY\r\n * Secure machine management with telemetry\r\n */\r\n\r\nrequire('dotenv').config({ path: require('path').join(__dirname, '../../../.env') });\r\n\r\n// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º SERVICE_NAME –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏\r\nprocess.env.SERVICE_NAME = 'machines';\r\n\r\nconst Fastify = require('fastify');\r\nconst { getMachinesClient } = require('@vhm24/database');\r\nconst { sanitizeInput } = require('@vhm24/shared-types/src/security');\r\nconst { cacheManagers, cacheMiddleware } = require('@vhm24/shared-types/src/redis');\r\n\r\n// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à –Ω–æ–≤—ã–π shared –ø–∞–∫–µ—Ç\r\nconst {\r\n  // Middleware\r\n  setupCORS,\r\n  setupHelmet,\r\n  setupRateLimit,\r\n  setupJWT,\r\n  authenticate,\r\n  authorize,\r\n  sanitizeInputs,\r\n  securityLogger,\r\n  healthCheck,\r\n  \r\n  // Validation\r\n  validateBody,\r\n  validateQuery,\r\n  validateId,\r\n  \r\n  // Error handling\r\n  registerErrorHandlers,\r\n  setupGlobalErrorHandlers,\r\n  createError,\r\n  asyncHandler,\r\n  \r\n  // Utils\r\n  logger,\r\n  config: sharedConfig,\r\n  createFastifyConfig,\r\n  paginate\r\n} = require('@vhm24/shared');\r\n\r\n// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ—à–∏–±–æ–∫\r\nsetupGlobalErrorHandlers();\r\n\r\n// –°–æ–∑–¥–∞–µ–º Fastify —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π\r\nconst fastify = Fastify(createFastifyConfig());\r\n\r\nconst prisma = getMachinesClient();\r\nconst cache = cacheManagers.machines;\r\n\r\n// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫\r\nregisterErrorHandlers(fastify);\r\n\r\n// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\r\nsetupHelmet(fastify);\r\nsetupCORS(fastify);\r\nsetupRateLimit(fastify, {\r\n  max: 150, // –°—Ä–µ–¥–Ω–∏–π –ª–∏–º–∏—Ç –¥–ª—è machines —Å–µ—Ä–≤–∏—Å–∞\r\n  timeWindow: '1 minute'\r\n});\r\nsetupJWT(fastify, {\r\n  verify: {\r\n    issuer: ['vhm24-gateway', 'vhm24-auth']\r\n  }\r\n});\r\n\r\n// Middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏\r\nfastify.addHook('preHandler', securityLogger);\r\nfastify.addHook('preHandler', sanitizeInputs);\r\n\r\n// –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)\r\nfastify.decorate('authenticate', authenticate);\r\n\r\n// –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π (–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)\r\nfastify.decorate('requireRole', (roles) => {\r\n  return authorize(roles);\r\n});\r\n\r\n// Health check\r\nfastify.get('/health', async (request, reply) => {\r\n  return { status: 'ok', service: 'machines' };\r\n});\r\n\r\n// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –º–∞—à–∏–Ω—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏\r\nfastify.get('/api/v1/machines', {\r\n  preValidation: [fastify.authenticate],\r\n  preHandler: cacheMiddleware({\r\n    keyGenerator: (req) => `machines:list:${JSON.stringify(req.query)}`,\r\n    ttl: 300, // 5 –º–∏–Ω—É—Ç\r\n    serviceName: 'machines',\r\n    condition: (req) => !req.query.search // –ö–µ—à–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ–∏—Å–∫–∞\r\n  }),\r\n  schema: {\r\n    querystring: {\r\n      type: 'object',\r\n      properties: {\r\n        status: { type: 'string', enum: ['ONLINE', 'OFFLINE', 'MAINTENANCE', 'ERROR'] },\r\n        type: { type: 'string' },\r\n        locationId: { type: 'string' },\r\n        search: { type: 'string' },\r\n        skip: { type: 'integer', minimum: 0, default: 0 },\r\n        take: { type: 'integer', minimum: 1, maximum: 100, default: 20 },\r\n        orderBy: { type: 'string', enum: ['code', 'name', 'status', 'updatedAt'], default: 'code' }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { status, type, locationId, search, skip, take, orderBy } = request.query;\r\n  \r\n  try {\r\n    const where = {};\r\n    \r\n    if (status) where.status = status;\r\n    if (type) where.type = type;\r\n    if (locationId) where.locationId = locationId;\r\n    if (search) {\r\n      where.OR = [\r\n        { code: { contains: search, mode: 'insensitive' } },\r\n        { name: { contains: search, mode: 'insensitive' } },\r\n        { serialNumber: { contains: search, mode: 'insensitive' } }\r\n      ];\r\n    }\r\n\r\n    const [machines, total] = await Promise.all([\r\n      prisma.machine.findMany({\r\n        where,\r\n        skip,\r\n        take,\r\n        orderBy: { [orderBy]: 'asc' },\r\n        include: {\r\n          location: true,\r\n          _count: {\r\n            select: {\r\n              tasks: true,\r\n              telemetry: true\r\n            }\r\n          }\r\n        }\r\n      }),\r\n      prisma.machine.count({ where })\r\n    ]);\r\n\r\n    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—é\r\n    const machinesWithTelemetry = await Promise.all(\r\n      machines.map(async (machine) => {\r\n        const lastTelemetry = await prisma.machineTelemetry.findFirst({\r\n          where: { machineId: machine.id },\r\n          orderBy: { createdAt: 'desc' }\r\n        });\r\n        return {\r\n          ...machine,\r\n          lastTelemetry\r\n        };\r\n      })\r\n    );\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        items: machinesWithTelemetry,\r\n        total,\r\n        skip,\r\n        take\r\n      }\r\n    };\r\n  } catch (error) {\r\n    throw createError.database('Failed to fetch machines');\r\n  }\r\n});\r\n\r\n// –ü–æ–ª—É—á–∏—Ç—å –º–∞—à–∏–Ω—É –ø–æ ID\r\nfastify.get('/api/v1/machines/:id', {\r\n  preValidation: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  const { id } = request.params;\r\n  \r\n  try {\r\n    // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –∫–µ—à–∞\r\n    const cacheKey = `machine:${id}`;\r\n    const cached = await cache.get(cacheKey);\r\n    if (cached) {\r\n      reply.header('X-Cache', 'HIT');\r\n      return {\r\n        success: true,\r\n        data: cached\r\n      };\r\n    }\r\n    \r\n    const machine = await prisma.machine.findUnique({\r\n      where: { id },\r\n      include: {\r\n        location: true,\r\n        tasks: {\r\n          take: 10,\r\n          orderBy: { createdAt: 'desc' },\r\n          include: {\r\n            assignedTo: {\r\n              select: {\r\n                id: true,\r\n                name: true,\r\n                email: true\r\n              }\r\n            }\r\n          }\r\n        },\r\n        telemetry: {\r\n          take: 50,\r\n          orderBy: { createdAt: 'desc' }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!machine) {\r\n      return reply.code(404).send({\r\n        success: false,\r\n        error: 'Machine not found'\r\n      });\r\n    }\r\n\r\n    // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É\r\n    const stats = {\r\n      totalTasks: await prisma.task.count({ where: { machineId: id } }),\r\n      activeTasks: await prisma.task.count({ \r\n        where: { \r\n          machineId: id,\r\n          status: { in: ['CREATED', 'ASSIGNED', 'IN_PROGRESS'] }\r\n        }\r\n      }),\r\n      completedToday: await prisma.task.count({\r\n        where: {\r\n          machineId: id,\r\n          status: 'COMPLETED',\r\n          completedAt: {\r\n            gte: new Date(new Date().setHours(0, 0, 0, 0))\r\n          }\r\n        }\r\n      })\r\n    };\r\n\r\n    const result = {\r\n      ...machine,\r\n      stats\r\n    };\r\n    \r\n    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à\r\n    await cache.set(cacheKey, result, 600); // 10 –º–∏–Ω—É—Ç\r\n    \r\n    return {\r\n      success: true,\r\n      data: result\r\n    };\r\n  } catch (error) {\r\n    throw createError.database('Failed to fetch machine');\r\n  }\r\n});\r\n\r\n// –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–∞—à–∏–Ω—É (—Ç–æ–ª—å–∫–æ –¥–ª—è ADMIN –∏ MANAGER)\r\nfastify.post('/api/v1/machines', {\r\n  preValidation: [fastify.authenticate, fastify.requireRole(['ADMIN', 'MANAGER'])],\r\n  schema: {\r\n    body: {\r\n      type: 'object',\r\n      required: ['code', 'serialNumber', 'type', 'name'],\r\n      properties: {\r\n        code: { type: 'string', pattern: '^CVM-\\\\d{5}$' },\r\n        serialNumber: { type: 'string', minLength: 5 },\r\n        type: { type: 'string', enum: ['COFFEE', 'SNACK', 'COMBO', 'OTHER'] },\r\n        name: { type: 'string', minLength: 3 },\r\n        locationId: { type: 'string' },\r\n        metadata: { type: 'object' }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const data = request.body;\r\n  \r\n  try {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∫–æ–¥–∞ –∏ —Å–µ—Ä–∏–π–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞\r\n    const existing = await prisma.machine.findFirst({\r\n      where: {\r\n        OR: [\r\n          { code: data.code },\r\n          { serialNumber: data.serialNumber }\r\n        ]\r\n      }\r\n    });\r\n\r\n    if (existing) {\r\n      return reply.code(400).send({\r\n        success: false,\r\n        error: 'Machine with this code or serial number already exists'\r\n      });\r\n    }\r\n\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞—Ü–∏—é, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞\r\n    if (data.locationId) {\r\n      const location = await prisma.location.findUnique({\r\n        where: { id: data.locationId }\r\n      });\r\n      \r\n      if (!location) {\r\n        return reply.code(400).send({\r\n          success: false,\r\n          error: 'Location not found'\r\n        });\r\n      }\r\n    }\r\n\r\n    // –°–æ–∑–¥–∞–µ–º –º–∞—à–∏–Ω—É\r\n    const machine = await prisma.machine.create({\r\n      data: {\r\n        ...data,\r\n        status: 'OFFLINE'\r\n      },\r\n      include: {\r\n        location: true\r\n      }\r\n    });\r\n\r\n    // –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ\r\n    await prisma.auditLog.create({\r\n      data: {\r\n        userId: request.user.id,\r\n        action: 'MACHINE_CREATED',\r\n        entity: 'Machine',\r\n        entityId: machine.id,\r\n        changes: data\r\n      }\r\n    });\r\n\r\n    // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à —Å–ø–∏—Å–∫–∞ –º–∞—à–∏–Ω\r\n    await cache.deletePattern('machines:list:*');\r\n    await cache.deletePattern('machines:stats');\r\n\r\n    return {\r\n      success: true,\r\n      data: machine\r\n    };\r\n  } catch (error) {\r\n    throw createError.database('Failed to create machine');\r\n  }\r\n});\r\n\r\n// –û–±–Ω–æ–≤–∏—Ç—å –º–∞—à–∏–Ω—É\r\nfastify.patch('/api/v1/machines/:id', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    params: {\r\n      type: 'object',\r\n      properties: {\r\n        id: { type: 'string' }\r\n      }\r\n    },\r\n    body: {\r\n      type: 'object',\r\n      properties: {\r\n        name: { type: 'string', minLength: 3 },\r\n        status: { type: 'string', enum: ['ONLINE', 'OFFLINE', 'MAINTENANCE', 'ERROR'] },\r\n        locationId: { type: 'string' },\r\n        metadata: { type: 'object' }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { id } = request.params;\r\n  const updates = request.body;\r\n  \r\n  try {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –º–∞—à–∏–Ω—ã\r\n    const existingMachine = await prisma.machine.findUnique({\r\n      where: { id }\r\n    });\r\n\r\n    if (!existingMachine) {\r\n      return reply.code(404).send({\r\n        success: false,\r\n        error: 'Machine not found'\r\n      });\r\n    }\r\n\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞—Ü–∏—é, –µ—Å–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è\r\n    if (updates.locationId) {\r\n      const location = await prisma.location.findUnique({\r\n        where: { id: updates.locationId }\r\n      });\r\n      \r\n      if (!location) {\r\n        return reply.code(400).send({\r\n          success: false,\r\n          error: 'Location not found'\r\n        });\r\n      }\r\n    }\r\n\r\n    // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—à–∏–Ω—É\r\n    const machine = await prisma.machine.update({\r\n      where: { id },\r\n      data: {\r\n        ...updates,\r\n        updatedAt: new Date()\r\n      },\r\n      include: {\r\n        location: true\r\n      }\r\n    });\r\n\r\n    // –õ–æ–≥–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è\r\n    const changes = {};\r\n    for (const [key, value] of Object.entries(updates)) {\r\n      if (existingMachine[key] !== value) {\r\n        changes[key] = {\r\n          from: existingMachine[key],\r\n          to: value\r\n        };\r\n      }\r\n    }\r\n\r\n    if (Object.keys(changes).length > 0) {\r\n      await prisma.auditLog.create({\r\n        data: {\r\n          userId: request.user.id,\r\n          action: 'MACHINE_UPDATED',\r\n          entity: 'Machine',\r\n          entityId: machine.id,\r\n          changes\r\n        }\r\n      });\r\n    }\r\n\r\n    // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à\r\n    await cache.delete(`machine:${id}`);\r\n    await cache.deletePattern('machines:list:*');\r\n    await cache.deletePattern('machines:stats');\r\n\r\n    return {\r\n      success: true,\r\n      data: machine\r\n    };\r\n  } catch (error) {\r\n    throw createError.database('Failed to update machine');\r\n  }\r\n});\r\n\r\n// –£–¥–∞–ª–∏—Ç—å –º–∞—à–∏–Ω—É (soft delete) - —Ç–æ–ª—å–∫–æ –¥–ª—è ADMIN\r\nfastify.delete('/api/v1/machines/:id', {\r\n  preValidation: [fastify.authenticate, fastify.requireRole(['ADMIN'])]\r\n}, async (request, reply) => {\r\n  const { id } = request.params;\r\n  \r\n  try {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏\r\n    const activeTasks = await prisma.task.count({\r\n      where: {\r\n        machineId: id,\r\n        status: { in: ['CREATED', 'ASSIGNED', 'IN_PROGRESS'] }\r\n      }\r\n    });\r\n\r\n    if (activeTasks > 0) {\r\n      return reply.code(400).send({\r\n        success: false,\r\n        error: `Cannot delete machine with ${activeTasks} active tasks`\r\n      });\r\n    }\r\n\r\n    // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω—É—é (soft delete)\r\n    const machine = await prisma.machine.update({\r\n      where: { id },\r\n      data: {\r\n        status: 'OFFLINE',\r\n        metadata: {\r\n          ...(await prisma.machine.findUnique({ where: { id } })).metadata,\r\n          deletedAt: new Date().toISOString(),\r\n          deletedBy: request.user.id\r\n        }\r\n      }\r\n    });\r\n\r\n    // –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ\r\n    await prisma.auditLog.create({\r\n      data: {\r\n        userId: request.user.id,\r\n        action: 'MACHINE_DELETED',\r\n        entity: 'Machine',\r\n        entityId: id\r\n      }\r\n    });\r\n\r\n    // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à\r\n    await cache.delete(`machine:${id}`);\r\n    await cache.deletePattern('machines:list:*');\r\n    await cache.deletePattern('machines:stats');\r\n\r\n    return {\r\n      success: true,\r\n      message: 'Machine deleted successfully'\r\n    };\r\n  } catch (error) {\r\n    if (error.code === 'P2025') {\r\n      return reply.code(404).send({\r\n        success: false,\r\n        error: 'Machine not found'\r\n      });\r\n    }\r\n    \r\n    throw createError.database('Failed to delete machine');\r\n  }\r\n});\r\n\r\n// –ó–∞–ø–∏—Å–∞—Ç—å —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—é\r\nfastify.post('/api/v1/machines/:id/telemetry', {\r\n  schema: {\r\n    params: {\r\n      type: 'object',\r\n      properties: {\r\n        id: { type: 'string' }\r\n      }\r\n    },\r\n    body: {\r\n      type: 'object',\r\n      required: ['rawData'],\r\n      properties: {\r\n        temperature: { type: 'number' },\r\n        humidity: { type: 'number' },\r\n        sales: { type: 'integer' },\r\n        errors: { type: 'array', items: { type: 'string' } },\r\n        rawData: { type: 'object' }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { id } = request.params;\r\n  const telemetryData = request.body;\r\n  \r\n  try {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –º–∞—à–∏–Ω—ã\r\n    const machine = await prisma.machine.findUnique({\r\n      where: { id }\r\n    });\r\n\r\n    if (!machine) {\r\n      return reply.code(404).send({\r\n        success: false,\r\n        error: 'Machine not found'\r\n      });\r\n    }\r\n\r\n    // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏\r\n    const telemetry = await prisma.machineTelemetry.create({\r\n      data: {\r\n        machineId: id,\r\n        ...telemetryData\r\n      }\r\n    });\r\n\r\n    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –º–∞—à–∏–Ω—ã –∏ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–∏–Ω–≥–∞\r\n    const newStatus = telemetryData.errors && telemetryData.errors.length > 0 \r\n      ? 'ERROR' \r\n      : 'ONLINE';\r\n\r\n    await prisma.machine.update({\r\n      where: { id },\r\n      data: {\r\n        status: newStatus,\r\n        lastPing: new Date()\r\n      }\r\n    });\r\n\r\n    // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à –º–∞—à–∏–Ω—ã\r\n    await cache.delete(`machine:${id}`);\r\n    await cache.deletePattern('machines:stats');\r\n\r\n    return {\r\n      success: true,\r\n      data: telemetry\r\n    };\r\n  } catch (error) {\r\n    throw createError.database('Failed to save telemetry');\r\n  }\r\n});\r\n\r\n// –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—é –º–∞—à–∏–Ω—ã\r\nfastify.get('/api/v1/machines/:id/telemetry', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    params: {\r\n      type: 'object',\r\n      properties: {\r\n        id: { type: 'string' }\r\n      }\r\n    },\r\n    querystring: {\r\n      type: 'object',\r\n      properties: {\r\n        from: { type: 'string', format: 'date-time' },\r\n        to: { type: 'string', format: 'date-time' },\r\n        limit: { type: 'integer', minimum: 1, maximum: 1000, default: 100 }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { id } = request.params;\r\n  const { from, to, limit } = request.query;\r\n  \r\n  try {\r\n    const where = { machineId: id };\r\n    \r\n    if (from || to) {\r\n      where.createdAt = {};\r\n      if (from) where.createdAt.gte = new Date(from);\r\n      if (to) where.createdAt.lte = new Date(to);\r\n    }\r\n\r\n    const telemetry = await prisma.machineTelemetry.findMany({\r\n      where,\r\n      orderBy: { createdAt: 'desc' },\r\n      take: limit\r\n    });\r\n\r\n    return {\r\n      success: true,\r\n      data: telemetry\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to fetch telemetry'\r\n    });\r\n  }\r\n});\r\n\r\n// –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –º–∞—à–∏–Ω\r\nfastify.get('/api/v1/machines/stats', {\r\n  preValidation: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –∫–µ—à–∞\r\n    const cacheKey = 'machines:stats';\r\n    const cached = await cache.get(cacheKey);\r\n    if (cached) {\r\n      reply.header('X-Cache', 'HIT');\r\n      return {\r\n        success: true,\r\n        data: cached\r\n      };\r\n    }\r\n    \r\n    const [\r\n      totalMachines,\r\n      machinesByStatus,\r\n      machinesByType,\r\n      machinesWithErrors,\r\n      recentTelemetry\r\n    ] = await Promise.all([\r\n      prisma.machine.count(),\r\n      prisma.machine.groupBy({\r\n        by: ['status'],\r\n        _count: true\r\n      }),\r\n      prisma.machine.groupBy({\r\n        by: ['type'],\r\n        _count: true\r\n      }),\r\n      prisma.machine.count({\r\n        where: { status: 'ERROR' }\r\n      }),\r\n      prisma.machineTelemetry.count({\r\n        where: {\r\n          createdAt: {\r\n            gte: new Date(Date.now() - 24 * 60 * 60 * 1000) // –ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞\r\n          }\r\n        }\r\n      })\r\n    ]);\r\n\r\n    const stats = {\r\n      total: totalMachines,\r\n      byStatus: machinesByStatus.reduce((acc, item) => {\r\n        acc[item.status] = item._count;\r\n        return acc;\r\n      }, {}),\r\n      byType: machinesByType.reduce((acc, item) => {\r\n        acc[item.type] = item._count;\r\n        return acc;\r\n      }, {}),\r\n      withErrors: machinesWithErrors,\r\n      telemetryLast24h: recentTelemetry\r\n    };\r\n    \r\n    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à –Ω–∞ 5 –º–∏–Ω—É—Ç\r\n    await cache.set(cacheKey, stats, 300);\r\n    \r\n    return {\r\n      success: true,\r\n      data: stats\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to fetch statistics'\r\n    });\r\n  }\r\n});\r\n\r\n// Start server\r\nconst start = async () => {\r\n  try {\r\n    const port = process.env.MACHINES_PORT || process.env.PORT || 3002;\r\n    await fastify.listen({ \r\n      port: port,\r\n      host: '0.0.0.0'\r\n    });\r\n    console.log('Machines service is running on port', port);\r\n  } catch (err) {\r\n    fastify.log.error(err);\r\n    process.exit(1);\r\n  }\r\n};\r\n\r\nstart();\r\n\r\n// Graceful shutdown\r\nprocess.on('SIGTERM', async () => {\r\n  await fastify.close();\r\n  await prisma.$disconnect();\r\n  process.exit(0);\r\n});\r\n",
  "services/recipes/src/index.js": "const fastify = require('fastify')({ logger: true });\r\nconst path = require('path');\r\n\r\n// Load environment variables\r\nrequire('dotenv').config({ path: path.join(__dirname, '../../../.env') });\r\n\r\n// Import shared middleware and utilities\r\nconst { errorHandler } = require('@vhm24/shared/middleware/errorHandler');\r\nconst { authMiddleware } = require('@vhm24/shared/middleware/security');\r\nconst logger = require('@vhm24/shared/utils/logger');\r\nconst { PrismaClient } = require('@prisma/client');\r\n\r\n// Initialize Prisma\r\nconst prisma = new PrismaClient();\r\n\r\n// Configuration\r\nconst config = {\r\n  port: process.env.RECIPES_SERVICE_PORT || 3007,\r\n  host: process.env.HOST || '0.0.0.0',\r\n  jwtSecret: process.env.JWT_SECRET || 'your-secret-key'\r\n};\r\n\r\n// Register plugins\r\nasync function registerPlugins() {\r\n  // CORS\r\n  await fastify.register(require('@fastify/cors'), {\r\n    origin: true,\r\n    credentials: true\r\n  });\r\n\r\n  // Security headers\r\n  await fastify.register(require('@fastify/helmet'));\r\n\r\n  // Rate limiting\r\n  await fastify.register(require('@fastify/rate-limit'), {\r\n    max: 100,\r\n    timeWindow: '1 minute'\r\n  });\r\n\r\n  // Swagger documentation\r\n  await fastify.register(require('@fastify/swagger'), {\r\n    swagger: {\r\n      info: {\r\n        title: 'VHM24 Recipes API',\r\n        description: 'API for managing recipes, ingredients and cost calculations',\r\n        version: '1.0.0'\r\n      },\r\n      host: 'localhost:3007',\r\n      schemes: ['http', 'https'],\r\n      consumes: ['application/json'],\r\n      produces: ['application/json'],\r\n      securityDefinitions: {\r\n        Bearer: {\r\n          type: 'apiKey',\r\n          name: 'Authorization',\r\n          in: 'header'\r\n        }\r\n      }\r\n    }\r\n  });\r\n\r\n  await fastify.register(require('@fastify/swagger-ui'), {\r\n    routePrefix: '/docs',\r\n    uiConfig: {\r\n      docExpansion: 'full',\r\n      deepLinking: false\r\n    }\r\n  });\r\n}\r\n\r\n// Authentication hook\r\nfastify.addHook('preHandler', async (request, reply) => {\r\n  // Skip auth for health check and docs\r\n  if (request.url === '/health' || request.url.startsWith('/docs')) {\r\n    return;\r\n  }\r\n\r\n  try {\r\n    await authMiddleware(request, reply, config.jwtSecret);\r\n  } catch (error) {\r\n    reply.code(401).send({ success: false, message: 'Unauthorized' });\r\n  }\r\n});\r\n\r\n// Health check\r\nfastify.get('/health', async (request, reply) => {\r\n  return { status: 'ok', service: 'recipes', timestamp: new Date().toISOString() };\r\n});\r\n\r\n// Recipes endpoints\r\nfastify.get('/api/v1/recipes', {\r\n  schema: {\r\n    description: 'Get all recipes',\r\n    tags: ['Recipes'],\r\n    security: [{ Bearer: [] }],\r\n    querystring: {\r\n      type: 'object',\r\n      properties: {\r\n        page: { type: 'integer', minimum: 1, default: 1 },\r\n        limit: { type: 'integer', minimum: 1, maximum: 100, default: 20 },\r\n        search: { type: 'string' },\r\n        category: { type: 'string' }\r\n      }\r\n    },\r\n    response: {\r\n      200: {\r\n        type: 'object',\r\n        properties: {\r\n          success: { type: 'boolean' },\r\n          data: {\r\n            type: 'array',\r\n            items: {\r\n              type: 'object',\r\n              properties: {\r\n                id: { type: 'integer' },\r\n                name: { type: 'string' },\r\n                description: { type: 'string' },\r\n                category: { type: 'string' },\r\n                preparationTime: { type: 'integer' },\r\n                servings: { type: 'integer' },\r\n                cost: { type: 'number' },\r\n                createdAt: { type: 'string' },\r\n                updatedAt: { type: 'string' }\r\n              }\r\n            }\r\n          },\r\n          pagination: {\r\n            type: 'object',\r\n            properties: {\r\n              page: { type: 'integer' },\r\n              limit: { type: 'integer' },\r\n              total: { type: 'integer' },\r\n              pages: { type: 'integer' }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  try {\r\n    const { page = 1, limit = 20, search, category } = request.query;\r\n    const skip = (page - 1) * limit;\r\n\r\n    const where = {};\r\n    if (search) {\r\n      where.OR = [\r\n        { name: { contains: search, mode: 'insensitive' } },\r\n        { description: { contains: search, mode: 'insensitive' } }\r\n      ];\r\n    }\r\n    if (category) {\r\n      where.category = category;\r\n    }\r\n\r\n    const [recipes, total] = await Promise.all([\r\n      prisma.recipe.findMany({\r\n        where,\r\n        skip,\r\n        take: limit,\r\n        include: {\r\n          ingredients: {\r\n            include: {\r\n              ingredient: true\r\n            }\r\n          }\r\n        },\r\n        orderBy: { createdAt: 'desc' }\r\n      }),\r\n      prisma.recipe.count({ where })\r\n    ]);\r\n\r\n    return {\r\n      success: true,\r\n      data: recipes,\r\n      pagination: {\r\n        page,\r\n        limit,\r\n        total,\r\n        pages: Math.ceil(total / limit)\r\n      }\r\n    };\r\n  } catch (error) {\r\n    logger.error('Get recipes error:', error);\r\n    reply.code(500).send({ success: false, message: 'Internal server error' });\r\n  }\r\n});\r\n\r\nfastify.get('/api/v1/recipes/:id', {\r\n  schema: {\r\n    description: 'Get recipe by ID',\r\n    tags: ['Recipes'],\r\n    security: [{ Bearer: [] }],\r\n    params: {\r\n      type: 'object',\r\n      properties: {\r\n        id: { type: 'integer' }\r\n      },\r\n      required: ['id']\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  try {\r\n    const { id } = request.params;\r\n\r\n    const recipe = await prisma.recipe.findUnique({\r\n      where: { id: parseInt(id) },\r\n      include: {\r\n        ingredients: {\r\n          include: {\r\n            ingredient: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!recipe) {\r\n      return reply.code(404).send({ success: false, message: 'Recipe not found' });\r\n    }\r\n\r\n    return { success: true, data: recipe };\r\n  } catch (error) {\r\n    logger.error('Get recipe error:', error);\r\n    reply.code(500).send({ success: false, message: 'Internal server error' });\r\n  }\r\n});\r\n\r\nfastify.post('/api/v1/recipes', {\r\n  schema: {\r\n    description: 'Create new recipe',\r\n    tags: ['Recipes'],\r\n    security: [{ Bearer: [] }],\r\n    body: {\r\n      type: 'object',\r\n      properties: {\r\n        name: { type: 'string', minLength: 1, maxLength: 255 },\r\n        description: { type: 'string' },\r\n        category: { type: 'string' },\r\n        preparationTime: { type: 'integer', minimum: 1 },\r\n        servings: { type: 'integer', minimum: 1 },\r\n        instructions: { type: 'string' },\r\n        ingredients: {\r\n          type: 'array',\r\n          items: {\r\n            type: 'object',\r\n            properties: {\r\n              ingredientId: { type: 'integer' },\r\n              quantity: { type: 'number', minimum: 0 },\r\n              unit: { type: 'string' }\r\n            },\r\n            required: ['ingredientId', 'quantity', 'unit']\r\n          }\r\n        }\r\n      },\r\n      required: ['name', 'category', 'preparationTime', 'servings', 'ingredients']\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  try {\r\n    const { name, description, category, preparationTime, servings, instructions, ingredients } = request.body;\r\n\r\n    // Calculate total cost\r\n    let totalCost = 0;\r\n    for (const ing of ingredients) {\r\n      const ingredient = await prisma.ingredient.findUnique({\r\n        where: { id: ing.ingredientId }\r\n      });\r\n      if (ingredient) {\r\n        totalCost += (ingredient.costPerUnit * ing.quantity);\r\n      }\r\n    }\r\n\r\n    const recipe = await prisma.recipe.create({\r\n      data: {\r\n        name,\r\n        description,\r\n        category,\r\n        preparationTime,\r\n        servings,\r\n        instructions,\r\n        cost: totalCost,\r\n        ingredients: {\r\n          create: ingredients.map(ing => ({\r\n            ingredientId: ing.ingredientId,\r\n            quantity: ing.quantity,\r\n            unit: ing.unit\r\n          }))\r\n        }\r\n      },\r\n      include: {\r\n        ingredients: {\r\n          include: {\r\n            ingredient: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    return { success: true, data: recipe };\r\n  } catch (error) {\r\n    logger.error('Create recipe error:', error);\r\n    reply.code(500).send({ success: false, message: 'Internal server error' });\r\n  }\r\n});\r\n\r\nfastify.put('/api/v1/recipes/:id', {\r\n  schema: {\r\n    description: 'Update recipe',\r\n    tags: ['Recipes'],\r\n    security: [{ Bearer: [] }],\r\n    params: {\r\n      type: 'object',\r\n      properties: {\r\n        id: { type: 'integer' }\r\n      },\r\n      required: ['id']\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  try {\r\n    const { id } = request.params;\r\n    const { name, description, category, preparationTime, servings, instructions, ingredients } = request.body;\r\n\r\n    // Check if recipe exists\r\n    const existingRecipe = await prisma.recipe.findUnique({\r\n      where: { id: parseInt(id) }\r\n    });\r\n\r\n    if (!existingRecipe) {\r\n      return reply.code(404).send({ success: false, message: 'Recipe not found' });\r\n    }\r\n\r\n    // Calculate new cost if ingredients provided\r\n    let totalCost = existingRecipe.cost;\r\n    if (ingredients) {\r\n      totalCost = 0;\r\n      for (const ing of ingredients) {\r\n        const ingredient = await prisma.ingredient.findUnique({\r\n          where: { id: ing.ingredientId }\r\n        });\r\n        if (ingredient) {\r\n          totalCost += (ingredient.costPerUnit * ing.quantity);\r\n        }\r\n      }\r\n    }\r\n\r\n    const updateData = {\r\n      name,\r\n      description,\r\n      category,\r\n      preparationTime,\r\n      servings,\r\n      instructions,\r\n      cost: totalCost\r\n    };\r\n\r\n    // Remove undefined values\r\n    Object.keys(updateData).forEach(key => {\r\n      if (updateData[key] === undefined) {\r\n        delete updateData[key];\r\n      }\r\n    });\r\n\r\n    const recipe = await prisma.recipe.update({\r\n      where: { id: parseInt(id) },\r\n      data: updateData,\r\n      include: {\r\n        ingredients: {\r\n          include: {\r\n            ingredient: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    return { success: true, data: recipe };\r\n  } catch (error) {\r\n    logger.error('Update recipe error:', error);\r\n    reply.code(500).send({ success: false, message: 'Internal server error' });\r\n  }\r\n});\r\n\r\nfastify.delete('/api/v1/recipes/:id', {\r\n  schema: {\r\n    description: 'Delete recipe',\r\n    tags: ['Recipes'],\r\n    security: [{ Bearer: [] }],\r\n    params: {\r\n      type: 'object',\r\n      properties: {\r\n        id: { type: 'integer' }\r\n      },\r\n      required: ['id']\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  try {\r\n    const { id } = request.params;\r\n\r\n    const recipe = await prisma.recipe.findUnique({\r\n      where: { id: parseInt(id) }\r\n    });\r\n\r\n    if (!recipe) {\r\n      return reply.code(404).send({ success: false, message: 'Recipe not found' });\r\n    }\r\n\r\n    await prisma.recipe.delete({\r\n      where: { id: parseInt(id) }\r\n    });\r\n\r\n    return { success: true, message: 'Recipe deleted successfully' };\r\n  } catch (error) {\r\n    logger.error('Delete recipe error:', error);\r\n    reply.code(500).send({ success: false, message: 'Internal server error' });\r\n  }\r\n});\r\n\r\n// Ingredients endpoints\r\nfastify.get('/api/v1/ingredients', {\r\n  schema: {\r\n    description: 'Get all ingredients',\r\n    tags: ['Ingredients'],\r\n    security: [{ Bearer: [] }]\r\n  }\r\n}, async (request, reply) => {\r\n  try {\r\n    const { page = 1, limit = 50, search } = request.query;\r\n    const skip = (page - 1) * limit;\r\n\r\n    const where = {};\r\n    if (search) {\r\n      where.OR = [\r\n        { name: { contains: search, mode: 'insensitive' } },\r\n        { category: { contains: search, mode: 'insensitive' } }\r\n      ];\r\n    }\r\n\r\n    const [ingredients, total] = await Promise.all([\r\n      prisma.ingredient.findMany({\r\n        where,\r\n        skip,\r\n        take: limit,\r\n        orderBy: { name: 'asc' }\r\n      }),\r\n      prisma.ingredient.count({ where })\r\n    ]);\r\n\r\n    return {\r\n      success: true,\r\n      data: ingredients,\r\n      pagination: {\r\n        page,\r\n        limit,\r\n        total,\r\n        pages: Math.ceil(total / limit)\r\n      }\r\n    };\r\n  } catch (error) {\r\n    logger.error('Get ingredients error:', error);\r\n    reply.code(500).send({ success: false, message: 'Internal server error' });\r\n  }\r\n});\r\n\r\nfastify.post('/api/v1/ingredients', {\r\n  schema: {\r\n    description: 'Create new ingredient',\r\n    tags: ['Ingredients'],\r\n    security: [{ Bearer: [] }],\r\n    body: {\r\n      type: 'object',\r\n      properties: {\r\n        name: { type: 'string', minLength: 1, maxLength: 255 },\r\n        category: { type: 'string' },\r\n        unit: { type: 'string' },\r\n        costPerUnit: { type: 'number', minimum: 0 },\r\n        supplier: { type: 'string' },\r\n        description: { type: 'string' }\r\n      },\r\n      required: ['name', 'category', 'unit', 'costPerUnit']\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  try {\r\n    const ingredient = await prisma.ingredient.create({\r\n      data: request.body\r\n    });\r\n\r\n    return { success: true, data: ingredient };\r\n  } catch (error) {\r\n    logger.error('Create ingredient error:', error);\r\n    reply.code(500).send({ success: false, message: 'Internal server error' });\r\n  }\r\n});\r\n\r\n// Cost calculation endpoint\r\nfastify.post('/api/v1/cost-calculation', {\r\n  schema: {\r\n    description: 'Calculate recipe cost',\r\n    tags: ['Cost Calculation'],\r\n    security: [{ Bearer: [] }],\r\n    body: {\r\n      type: 'object',\r\n      properties: {\r\n        ingredients: {\r\n          type: 'array',\r\n          items: {\r\n            type: 'object',\r\n            properties: {\r\n              ingredientId: { type: 'integer' },\r\n              quantity: { type: 'number', minimum: 0 }\r\n            },\r\n            required: ['ingredientId', 'quantity']\r\n          }\r\n        },\r\n        servings: { type: 'integer', minimum: 1 },\r\n        markup: { type: 'number', minimum: 0, default: 0 }\r\n      },\r\n      required: ['ingredients', 'servings']\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  try {\r\n    const { ingredients, servings, markup = 0 } = request.body;\r\n\r\n    let totalCost = 0;\r\n    const costBreakdown = [];\r\n\r\n    for (const ing of ingredients) {\r\n      const ingredient = await prisma.ingredient.findUnique({\r\n        where: { id: ing.ingredientId }\r\n      });\r\n\r\n      if (ingredient) {\r\n        const cost = ingredient.costPerUnit * ing.quantity;\r\n        totalCost += cost;\r\n        \r\n        costBreakdown.push({\r\n          ingredient: ingredient.name,\r\n          quantity: ing.quantity,\r\n          unit: ingredient.unit,\r\n          costPerUnit: ingredient.costPerUnit,\r\n          totalCost: cost\r\n        });\r\n      }\r\n    }\r\n\r\n    const costPerServing = totalCost / servings;\r\n    const finalCostPerServing = costPerServing * (1 + markup / 100);\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        totalCost,\r\n        costPerServing,\r\n        finalCostPerServing,\r\n        servings,\r\n        markup,\r\n        breakdown: costBreakdown\r\n      }\r\n    };\r\n  } catch (error) {\r\n    logger.error('Cost calculation error:', error);\r\n    reply.code(500).send({ success: false, message: 'Internal server error' });\r\n  }\r\n});\r\n\r\n// Recipe categories endpoint\r\nfastify.get('/api/v1/recipe-categories', {\r\n  schema: {\r\n    description: 'Get recipe categories',\r\n    tags: ['Recipes'],\r\n    security: [{ Bearer: [] }]\r\n  }\r\n}, async (request, reply) => {\r\n  try {\r\n    const categories = await prisma.recipe.findMany({\r\n      select: {\r\n        category: true\r\n      },\r\n      distinct: ['category'],\r\n      where: {\r\n        category: {\r\n          not: null\r\n        }\r\n      }\r\n    });\r\n\r\n    const categoryList = categories.map(c => c.category).filter(Boolean);\r\n\r\n    return {\r\n      success: true,\r\n      data: categoryList\r\n    };\r\n  } catch (error) {\r\n    logger.error('Get categories error:', error);\r\n    reply.code(500).send({ success: false, message: 'Internal server error' });\r\n  }\r\n});\r\n\r\n// Error handler\r\nfastify.setErrorHandler(errorHandler);\r\n\r\n// Start server\r\nasync function start() {\r\n  try {\r\n    await registerPlugins();\r\n    \r\n    await fastify.listen({\r\n      port: config.port,\r\n      host: config.host\r\n    });\r\n\r\n    logger.info(`üç≥ Recipes service running on http://${config.host}:${config.port}`);\r\n    logger.info(`üìö API documentation available at http://${config.host}:${config.port}/docs`);\r\n  } catch (error) {\r\n    console.error('Failed to start recipes service:', error);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// Graceful shutdown\r\nprocess.on('SIGINT', async () => {\r\n  logger.info('Shutting down recipes service...');\r\n  await fastify.close();\r\n  await prisma.$disconnect();\r\n  process.exit(0);\r\n});\r\n\r\nprocess.on('SIGTERM', async () => {\r\n  logger.info('Shutting down recipes service...');\r\n  await fastify.close();\r\n  await prisma.$disconnect();\r\n  process.exit(0);\r\n});\r\n\r\nstart();\r\n",
  "services/tasks/src/scheduledTasks.js": "/**\r\n * VHM24 - Scheduled Tasks Module\r\n * –ú–æ–¥—É–ª—å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é –∏ –ø—Ä–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–µ —Ç–æ–≤–∞—Ä–æ–≤\r\n */\r\n\r\nconst cron = require('node-cron');\r\nconst { getTasksClient } = require('@vhm24/database');\r\n\r\n// –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –ª–æ–≥–≥–µ—Ä\r\nconst logger = {\r\n  info: (message, ...args) => console.log(`[INFO] ${message}`, ...args),\r\n  warn: (message, ...args) => console.warn(`[WARN] ${message}`, ...args),\r\n  error: (message, ...args) => console.error(`[ERROR] ${message}`, ...args)\r\n};\r\n\r\n// –ü–æ–ª—É—á–∞–µ–º Prisma –∫–ª–∏–µ–Ω—Ç\r\nconst prisma = getTasksClient();\r\n\r\n/**\r\n * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π –∑–∞–¥–∞—á\r\n */\r\nfunction initScheduledTasks() {\r\n  logger.info('Initializing scheduled tasks...');\r\n\r\n  // –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ—Ñ–∏—Ü–∏—Ç–∞ —Ç–æ–≤–∞—Ä–æ–≤ (–≤ 6:00 —É—Ç—Ä–∞)\r\n  cron.schedule('0 6 * * *', async () => {\r\n    logger.info('Running scheduled inventory check...');\r\n    await createTasksForLowInventory();\r\n  });\r\n\r\n  // –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ (–≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 8:00 —É—Ç—Ä–∞)\r\n  cron.schedule('0 8 * * 1', async () => {\r\n    logger.info('Running scheduled maintenance tasks...');\r\n    await createMaintenanceTasks();\r\n  });\r\n\r\n  // –ï–∂–µ–º–µ—Å—è—á–Ω–∞—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è (1-–≥–æ —á–∏—Å–ª–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞ –≤ 7:00 —É—Ç—Ä–∞)\r\n  cron.schedule('0 7 1 * *', async () => {\r\n    logger.info('Running scheduled inventory tasks...');\r\n    await createInventoryTasks();\r\n  });\r\n\r\n  logger.info('Scheduled tasks initialized successfully');\r\n}\r\n\r\n/**\r\n * –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á –ø—Ä–∏ –Ω–∏–∑–∫–æ–º —É—Ä–æ–≤–Ω–µ –∑–∞–ø–∞—Å–æ–≤\r\n */\r\nasync function createTasksForLowInventory() {\r\n  try {\r\n    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã —Å –Ω–∏–∑–∫–∏–º —É—Ä–æ–≤–Ω–µ–º –∑–∞–ø–∞—Å–æ–≤\r\n    const lowInventoryItems = await prisma.inventoryItem.findMany({\r\n      where: {\r\n        quantity: {\r\n          lt: prisma.inventoryItem.minQuantity\r\n        }\r\n      },\r\n      include: {\r\n        machine: true\r\n      }\r\n    });\r\n\r\n    logger.info(`Found ${lowInventoryItems.length} items with low inventory`);\r\n\r\n    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã –ø–æ –º–∞—à–∏–Ω–∞–º\r\n    const itemsByMachine = lowInventoryItems.reduce((acc, item) => {\r\n      if (!acc[item.machineId]) {\r\n        acc[item.machineId] = [];\r\n      }\r\n      acc[item.machineId].push(item);\r\n      return acc;\r\n    }, {});\r\n\r\n    // –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –º–∞—à–∏–Ω—ã\r\n    for (const [machineId, items] of Object.entries(itemsByMachine)) {\r\n      const machine = items[0].machine;\r\n      \r\n      // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏\r\n      const itemsList = items.map(item => \r\n        `- ${item.name}: ${item.quantity}/${item.minQuantity} ${item.unit}`\r\n      ).join('\\n');\r\n      \r\n      const description = `–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø–∞—Å—ã:\\n${itemsList}`;\r\n      \r\n      // –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É\r\n      const task = await prisma.task.create({\r\n        data: {\r\n          title: `–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø–∞—Å–æ–≤ –¥–ª—è ${machine.name}`,\r\n          description,\r\n          machineId,\r\n          status: 'CREATED',\r\n          priority: 'HIGH',\r\n          type: 'RESUPPLY',\r\n          dueDate: new Date(Date.now() + 24 * 60 * 60 * 1000) // –°—Ä–æ–∫ - 24 —á–∞—Å–∞\r\n        }\r\n      });\r\n      \r\n      // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–µ–π—Å—Ç–≤–∏–π\r\n      await prisma.taskAction.create({\r\n        data: {\r\n          taskId: task.id,\r\n          action: 'CREATED',\r\n          comment: '–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑-–∑–∞ –Ω–∏–∑–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è –∑–∞–ø–∞—Å–æ–≤',\r\n          metadata: {\r\n            items: items.map(item => ({\r\n              id: item.id,\r\n              name: item.name,\r\n              quantity: item.quantity,\r\n              minQuantity: item.minQuantity\r\n            }))\r\n          }\r\n        }\r\n      });\r\n      \r\n      logger.info(`Created resupply task #${task.id} for machine ${machine.name}`);\r\n      \r\n      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ\r\n      await sendTaskNotification(task, 'LOW_INVENTORY');\r\n    }\r\n    \r\n    return true;\r\n  } catch (error) {\r\n    logger.error('Error creating tasks for low inventory:', error);\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á –¥–ª—è –ø–ª–∞–Ω–æ–≤–æ–≥–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è\r\n */\r\nasync function createMaintenanceTasks() {\r\n  try {\r\n    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –º–∞—à–∏–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ –¢–û –±–æ–ª–µ–µ 30 –¥–Ω–µ–π\r\n    const thirtyDaysAgo = new Date();\r\n    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\r\n    \r\n    const machines = await prisma.machine.findMany({\r\n      where: {\r\n        OR: [\r\n          { lastMaintenanceDate: { lt: thirtyDaysAgo } },\r\n          { lastMaintenanceDate: null }\r\n        ]\r\n      },\r\n      include: {\r\n        location: true\r\n      }\r\n    });\r\n    \r\n    logger.info(`Found ${machines.length} machines requiring maintenance`);\r\n    \r\n    // –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –º–∞—à–∏–Ω—ã\r\n    for (const machine of machines) {\r\n      const task = await prisma.task.create({\r\n        data: {\r\n          title: `–ü–ª–∞–Ω–æ–≤–æ–µ –¢–û –¥–ª—è ${machine.name}`,\r\n          description: `–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–ª–∞–Ω–æ–≤–æ–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ.\\n–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¢–û: ${machine.lastMaintenanceDate ? new Date(machine.lastMaintenanceDate).toLocaleDateString('ru-RU') : '–ù–µ –ø—Ä–æ–≤–æ–¥–∏–ª–æ—Å—å'}`,\r\n          machineId: machine.id,\r\n          status: 'CREATED',\r\n          priority: 'MEDIUM',\r\n          type: 'MAINTENANCE',\r\n          dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // –°—Ä–æ–∫ - 7 –¥–Ω–µ–π\r\n        }\r\n      });\r\n      \r\n      // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–µ–π—Å—Ç–≤–∏–π\r\n      await prisma.taskAction.create({\r\n        data: {\r\n          taskId: task.id,\r\n          action: 'CREATED',\r\n          comment: '–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –≥—Ä–∞—Ñ–∏–∫—É –¢–û',\r\n          metadata: {\r\n            lastMaintenance: machine.lastMaintenanceDate,\r\n            location: machine.location?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'\r\n          }\r\n        }\r\n      });\r\n      \r\n      logger.info(`Created maintenance task #${task.id} for machine ${machine.name}`);\r\n      \r\n      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ\r\n      await sendTaskNotification(task, 'MAINTENANCE_REQUIRED');\r\n    }\r\n    \r\n    return true;\r\n  } catch (error) {\r\n    logger.error('Error creating maintenance tasks:', error);\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏\r\n */\r\nasync function createInventoryTasks() {\r\n  try {\r\n    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –º–∞—à–∏–Ω—ã\r\n    const machines = await prisma.machine.findMany({\r\n      include: {\r\n        location: true\r\n      }\r\n    });\r\n    \r\n    logger.info(`Creating inventory tasks for ${machines.length} machines`);\r\n    \r\n    // –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –º–∞—à–∏–Ω—ã\r\n    for (const machine of machines) {\r\n      const task = await prisma.task.create({\r\n        data: {\r\n          title: `–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è ${machine.name}`,\r\n          description: `–¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Å—Ç–∏ –µ–∂–µ–º–µ—Å—è—á–Ω—É—é –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—é.\\n–õ–æ–∫–∞—Ü–∏—è: ${machine.location?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`,\r\n          machineId: machine.id,\r\n          status: 'CREATED',\r\n          priority: 'MEDIUM',\r\n          type: 'INVENTORY',\r\n          dueDate: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000) // –°—Ä–æ–∫ - 5 –¥–Ω–µ–π\r\n        }\r\n      });\r\n      \r\n      // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–µ–π—Å—Ç–≤–∏–π\r\n      await prisma.taskAction.create({\r\n        data: {\r\n          taskId: task.id,\r\n          action: 'CREATED',\r\n          comment: '–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –≥—Ä–∞—Ñ–∏–∫—É –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏',\r\n          metadata: {\r\n            month: new Date().getMonth() + 1,\r\n            year: new Date().getFullYear(),\r\n            location: machine.location?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'\r\n          }\r\n        }\r\n      });\r\n      \r\n      logger.info(`Created inventory task #${task.id} for machine ${machine.name}`);\r\n      \r\n      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ\r\n      await sendTaskNotification(task, 'INVENTORY_REQUIRED');\r\n    }\r\n    \r\n    return true;\r\n  } catch (error) {\r\n    logger.error('Error creating inventory tasks:', error);\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–¥–∞—á–µ\r\n */\r\nasync function sendTaskNotification(task, type) {\r\n  try {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ —Å–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\r\n    if (!global.notificationService) {\r\n      logger.warn('Notification service not available, skipping notification');\r\n      return false;\r\n    }\r\n    \r\n    // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\r\n    const notificationData = {\r\n      type,\r\n      taskId: task.id,\r\n      title: task.title,\r\n      description: task.description,\r\n      priority: task.priority,\r\n      machineId: task.machineId,\r\n      dueDate: task.dueDate\r\n    };\r\n    \r\n    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ\r\n    await global.notificationService.sendTaskNotification(notificationData);\r\n    \r\n    logger.info(`Sent ${type} notification for task #${task.id}`);\r\n    return true;\r\n  } catch (error) {\r\n    logger.error(`Error sending notification for task #${task.id}:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–∞ —Ç–æ–≤–∞—Ä–æ–≤\r\n */\r\nasync function manualCheckInventory() {\r\n  logger.info('Manual inventory check triggered');\r\n  return await createTasksForLowInventory();\r\n}\r\n\r\n/**\r\n * –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á –¢–û\r\n */\r\nasync function manualCreateMaintenanceTasks() {\r\n  logger.info('Manual maintenance tasks creation triggered');\r\n  return await createMaintenanceTasks();\r\n}\r\n\r\n/**\r\n * –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏\r\n */\r\nasync function manualCreateInventoryTasks() {\r\n  logger.info('Manual inventory tasks creation triggered');\r\n  return await createInventoryTasks();\r\n}\r\n\r\nmodule.exports = {\r\n  initScheduledTasks,\r\n  manualCheckInventory,\r\n  manualCreateMaintenanceTasks,\r\n  manualCreateInventoryTasks\r\n};\r\n",
  "services/telegram-bot/src/handlers/technicianHandler.js": "const { FSMManager } = require('../fsm/manager');\r\nconst { STATES } = require('../fsm/states');\r\nconst logger = require('@vhm24/shared/utils/logger');\r\n\r\nclass TechnicianHandler {\r\n    constructor(bot, prisma) {\r\n        this.bot = bot;\r\n        this.prisma = prisma;\r\n        this.fsmManager = new FSMManager();\r\n    }\r\n\r\n    async showTechnicianMenu(chatId, userId) {\r\n        try {\r\n            logger.info(`Showing technician menu for user ${userId}`);\r\n            \r\n            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n            const user = await this.prisma.user.findUnique({\r\n                where: { telegramId: userId.toString() },\r\n                include: { role: true }\r\n            });\r\n\r\n            if (!user || user.role.name !== 'TECHNICIAN') {\r\n                await this.bot.sendMessage(chatId, '‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º —Ç–µ—Ö–Ω–∏–∫–∞');\r\n                return;\r\n            }\r\n\r\n            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ FSM\r\n            await this.fsmManager.setState(userId, STATES.TECHNICIAN_MENU);\r\n\r\n            const keyboard = {\r\n                inline_keyboard: [\r\n                    [\r\n                        { text: 'üîß –ù–∞—á–∞—Ç—å –¢–û', callback_data: 'tech_start_maintenance' },\r\n                        { text: 'üìã –ß–µ–∫-–ª–∏—Å—Ç—ã', callback_data: 'tech_checklists' }\r\n                    ],\r\n                    [\r\n                        { text: 'üî© –ó–∞–º–µ–Ω–∞ –¥–µ—Ç–∞–ª–µ–π', callback_data: 'tech_parts_replacement' },\r\n                        { text: 'üìä –ú–æ–∏ –æ—Ç—á—ë—Ç—ã', callback_data: 'tech_reports' }\r\n                    ],\r\n                    [\r\n                        { text: 'üö® –°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ', callback_data: 'tech_report_problem' },\r\n                        { text: 'üì± –ù–∞—Å—Ç—Ä–æ–π–∫–∏', callback_data: 'settings' }\r\n                    ],\r\n                    [\r\n                        { text: 'üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', callback_data: 'main_menu' }\r\n                    ]\r\n                ]\r\n            };\r\n\r\n            await this.bot.sendMessage(chatId, \r\n                'üîß *–ú–µ–Ω—é —Ç–µ—Ö–Ω–∏–∫–∞*\\n\\n' +\r\n                '–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:\\n' +\r\n                '‚Ä¢ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ\\n' +\r\n                '‚Ä¢ –†–∞–±–æ—Ç–∞ —Å —á–µ–∫-–ª–∏—Å—Ç–∞–º–∏\\n' +\r\n                '‚Ä¢ –ó–∞–º–µ–Ω–∞ –¥–µ—Ç–∞–ª–µ–π\\n' +\r\n                '‚Ä¢ –û—Ç—á—ë—Ç—ã –∏ –ø—Ä–æ–±–ª–µ–º—ã',\r\n                { \r\n                    parse_mode: 'Markdown',\r\n                    reply_markup: keyboard \r\n                }\r\n            );\r\n\r\n        } catch (error) {\r\n            logger.error('Error showing technician menu:', error);\r\n            await this.bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–µ–Ω—é —Ç–µ—Ö–Ω–∏–∫–∞');\r\n        }\r\n    }\r\n\r\n    async startMaintenance(chatId, userId) {\r\n        try {\r\n            logger.info(`Starting maintenance for technician ${userId}`);\r\n\r\n            // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–≤—Ç–æ–º–∞—Ç–æ–≤ –¥–ª—è –¢–û\r\n            const machines = await this.prisma.machine.findMany({\r\n                where: {\r\n                    OR: [\r\n                        { status: 'MAINTENANCE_REQUIRED' },\r\n                        { status: 'OFFLINE' }\r\n                    ]\r\n                },\r\n                include: {\r\n                    location: true\r\n                }\r\n            });\r\n\r\n            if (machines.length === 0) {\r\n                await this.bot.sendMessage(chatId, \r\n                    '‚úÖ –í—Å–µ –∞–≤—Ç–æ–º–∞—Ç—ã –≤ —Ä–∞–±–æ—á–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏!\\n' +\r\n                    '–ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è.'\r\n                );\r\n                return;\r\n            }\r\n\r\n            await this.fsmManager.setState(userId, STATES.TECHNICIAN_SELECT_MACHINE);\r\n\r\n            const keyboard = {\r\n                inline_keyboard: machines.map(machine => ([\r\n                    { \r\n                        text: `üè™ ${machine.location.name} - ${machine.model}`, \r\n                        callback_data: `tech_select_machine_${machine.id}` \r\n                    }\r\n                ])).concat([[\r\n                    { text: 'üîô –ù–∞–∑–∞–¥', callback_data: 'technician_menu' }\r\n                ]])\r\n            };\r\n\r\n            await this.bot.sendMessage(chatId,\r\n                'üîß *–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç –¥–ª—è –¢–û*\\n\\n' +\r\n                `–ù–∞–π–¥–µ–Ω–æ ${machines.length} –∞–≤—Ç–æ–º–∞—Ç–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è:`,\r\n                {\r\n                    parse_mode: 'Markdown',\r\n                    reply_markup: keyboard\r\n                }\r\n            );\r\n\r\n        } catch (error) {\r\n            logger.error('Error starting maintenance:', error);\r\n            await this.bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –¢–û');\r\n        }\r\n    }\r\n\r\n    async selectMachineForMaintenance(chatId, userId, machineId) {\r\n        try {\r\n            const machine = await this.prisma.machine.findUnique({\r\n                where: { id: parseInt(machineId) },\r\n                include: { \r\n                    location: true,\r\n                    maintenanceTasks: {\r\n                        where: { status: 'PENDING' },\r\n                        orderBy: { priority: 'desc' }\r\n                    }\r\n                }\r\n            });\r\n\r\n            if (!machine) {\r\n                await this.bot.sendMessage(chatId, '‚ùå –ê–≤—Ç–æ–º–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');\r\n                return;\r\n            }\r\n\r\n            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –¢–û\r\n            const maintenanceTask = await this.prisma.maintenanceTask.create({\r\n                data: {\r\n                    machineId: machine.id,\r\n                    technicianId: parseInt(userId),\r\n                    type: 'ROUTINE',\r\n                    status: 'IN_PROGRESS',\r\n                    priority: 'MEDIUM',\r\n                    description: `–ü–ª–∞–Ω–æ–≤–æ–µ –¢–û –∞–≤—Ç–æ–º–∞—Ç–∞ ${machine.model}`,\r\n                    scheduledDate: new Date()\r\n                }\r\n            });\r\n\r\n            await this.fsmManager.setState(userId, STATES.TECHNICIAN_MAINTENANCE, {\r\n                machineId: machine.id,\r\n                taskId: maintenanceTask.id\r\n            });\r\n\r\n            const keyboard = {\r\n                inline_keyboard: [\r\n                    [\r\n                        { text: 'üìã –ù–∞—á–∞—Ç—å —á–µ–∫-–ª–∏—Å—Ç', callback_data: `tech_start_checklist_${maintenanceTask.id}` }\r\n                    ],\r\n                    [\r\n                        { text: 'üî© –ó–∞–º–µ–Ω–∞ –¥–µ—Ç–∞–ª–µ–π', callback_data: `tech_parts_${maintenanceTask.id}` },\r\n                        { text: 'üì∏ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ', callback_data: `tech_photo_${maintenanceTask.id}` }\r\n                    ],\r\n                    [\r\n                        { text: '‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –¢–û', callback_data: `tech_complete_${maintenanceTask.id}` }\r\n                    ],\r\n                    [\r\n                        { text: 'üîô –ù–∞–∑–∞–¥', callback_data: 'tech_start_maintenance' }\r\n                    ]\r\n                ]\r\n            };\r\n\r\n            await this.bot.sendMessage(chatId,\r\n                `üîß *–¢–û –∞–≤—Ç–æ–º–∞—Ç–∞*\\n\\n` +\r\n                `üìç –õ–æ–∫–∞—Ü–∏—è: ${machine.location.name}\\n` +\r\n                `ü§ñ –ú–æ–¥–µ–ª—å: ${machine.model}\\n` +\r\n                `üìä –°—Ç–∞—Ç—É—Å: ${machine.status}\\n` +\r\n                `üÜî –ó–∞–¥–∞—á–∞: #${maintenanceTask.id}\\n\\n` +\r\n                `–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:`,\r\n                {\r\n                    parse_mode: 'Markdown',\r\n                    reply_markup: keyboard\r\n                }\r\n            );\r\n\r\n        } catch (error) {\r\n            logger.error('Error selecting machine for maintenance:', error);\r\n            await this.bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∞–≤—Ç–æ–º–∞—Ç–∞');\r\n        }\r\n    }\r\n\r\n    async startChecklist(chatId, userId, taskId) {\r\n        try {\r\n            const task = await this.prisma.maintenanceTask.findUnique({\r\n                where: { id: parseInt(taskId) },\r\n                include: { \r\n                    machine: { include: { location: true } },\r\n                    checklistItems: true\r\n                }\r\n            });\r\n\r\n            if (!task) {\r\n                await this.bot.sendMessage(chatId, '‚ùå –ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');\r\n                return;\r\n            }\r\n\r\n            // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç –¥–ª—è –¢–û\r\n            const standardChecklist = [\r\n                '–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è',\r\n                '–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Å–ø–ª–µ—è –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞',\r\n                '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—É–ø—é—Ä–æ–ø—Ä–∏–µ–º–Ω–∏–∫–∞',\r\n                '–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–Ω–µ—Ç–æ–ø—Ä–∏–µ–º–Ω–∏–∫–∞',\r\n                '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã –≤—ã–¥–∞—á–∏',\r\n                '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞',\r\n                '–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–≤–Ω—è —Ç–æ–≤–∞—Ä–æ–≤',\r\n                '–û—á–∏—Å—Ç–∫–∞ –∏ –¥–µ–∑–∏–Ω—Ñ–µ–∫—Ü–∏—è',\r\n                '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π',\r\n                '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã'\r\n            ];\r\n\r\n            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —á–µ–∫-–ª–∏—Å—Ç–∞ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç\r\n            if (task.checklistItems.length === 0) {\r\n                for (let i = 0; i < standardChecklist.length; i++) {\r\n                    await this.prisma.checklistItem.create({\r\n                        data: {\r\n                            taskId: task.id,\r\n                            description: standardChecklist[i],\r\n                            order: i + 1,\r\n                            status: 'PENDING'\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n\r\n            await this.fsmManager.setState(userId, STATES.TECHNICIAN_CHECKLIST, {\r\n                taskId: task.id,\r\n                currentItem: 0\r\n            });\r\n\r\n            await this.showNextChecklistItem(chatId, userId, task.id, 0);\r\n\r\n        } catch (error) {\r\n            logger.error('Error starting checklist:', error);\r\n            await this.bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —á–µ–∫-–ª–∏—Å—Ç–∞');\r\n        }\r\n    }\r\n\r\n    async showNextChecklistItem(chatId, userId, taskId, itemIndex) {\r\n        try {\r\n            const items = await this.prisma.checklistItem.findMany({\r\n                where: { taskId: parseInt(taskId) },\r\n                orderBy: { order: 'asc' }\r\n            });\r\n\r\n            if (itemIndex >= items.length) {\r\n                await this.completeChecklist(chatId, userId, taskId);\r\n                return;\r\n            }\r\n\r\n            const currentItem = items[itemIndex];\r\n            const completedCount = items.filter(item => item.status === 'COMPLETED').length;\r\n\r\n            const keyboard = {\r\n                inline_keyboard: [\r\n                    [\r\n                        { text: '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ', callback_data: `tech_check_ok_${currentItem.id}_${itemIndex}` },\r\n                        { text: '‚ùå –ü—Ä–æ–±–ª–µ–º–∞', callback_data: `tech_check_issue_${currentItem.id}_${itemIndex}` }\r\n                    ],\r\n                    [\r\n                        { text: 'üì∏ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ', callback_data: `tech_check_photo_${currentItem.id}` }\r\n                    ],\r\n                    [\r\n                        { text: '‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å', callback_data: `tech_check_skip_${currentItem.id}_${itemIndex}` }\r\n                    ]\r\n                ]\r\n            };\r\n\r\n            await this.bot.sendMessage(chatId,\r\n                `üìã *–ß–µ–∫-–ª–∏—Å—Ç –¢–û*\\n\\n` +\r\n                `–ü—É–Ω–∫—Ç ${itemIndex + 1} –∏–∑ ${items.length}\\n` +\r\n                `–í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${completedCount}/${items.length}\\n\\n` +\r\n                `üîç **${currentItem.description}**\\n\\n` +\r\n                `–û—Ç–º–µ—Ç—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:`,\r\n                {\r\n                    parse_mode: 'Markdown',\r\n                    reply_markup: keyboard\r\n                }\r\n            );\r\n\r\n        } catch (error) {\r\n            logger.error('Error showing checklist item:', error);\r\n            await this.bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —á–µ–∫-–ª–∏—Å—Ç–∞');\r\n        }\r\n    }\r\n\r\n    async handleChecklistItem(chatId, userId, itemId, itemIndex, status, comment = null) {\r\n        try {\r\n            await this.prisma.checklistItem.update({\r\n                where: { id: parseInt(itemId) },\r\n                data: {\r\n                    status: status,\r\n                    comment: comment,\r\n                    completedAt: status === 'COMPLETED' ? new Date() : null\r\n                }\r\n            });\r\n\r\n            const nextIndex = parseInt(itemIndex) + 1;\r\n            const item = await this.prisma.checklistItem.findUnique({\r\n                where: { id: parseInt(itemId) }\r\n            });\r\n\r\n            await this.showNextChecklistItem(chatId, userId, item.taskId, nextIndex);\r\n\r\n        } catch (error) {\r\n            logger.error('Error handling checklist item:', error);\r\n            await this.bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø—É–Ω–∫—Ç–∞ —á–µ–∫-–ª–∏—Å—Ç–∞');\r\n        }\r\n    }\r\n\r\n    async completeChecklist(chatId, userId, taskId) {\r\n        try {\r\n            const items = await this.prisma.checklistItem.findMany({\r\n                where: { taskId: parseInt(taskId) }\r\n            });\r\n\r\n            const completedCount = items.filter(item => item.status === 'COMPLETED').length;\r\n            const issuesCount = items.filter(item => item.status === 'ISSUE').length;\r\n\r\n            const keyboard = {\r\n                inline_keyboard: [\r\n                    [\r\n                        { text: 'üî© –ó–∞–º–µ–Ω–∞ –¥–µ—Ç–∞–ª–µ–π', callback_data: `tech_parts_${taskId}` },\r\n                        { text: 'üì∏ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ', callback_data: `tech_photo_${taskId}` }\r\n                    ],\r\n                    [\r\n                        { text: '‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –¢–û', callback_data: `tech_complete_${taskId}` }\r\n                    ],\r\n                    [\r\n                        { text: 'üîô –ö –∑–∞–¥–∞—á–µ', callback_data: `tech_task_${taskId}` }\r\n                    ]\r\n                ]\r\n            };\r\n\r\n            await this.bot.sendMessage(chatId,\r\n                `‚úÖ *–ß–µ–∫-–ª–∏—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!*\\n\\n` +\r\n                `üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:\\n` +\r\n                `‚Ä¢ –í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${completedCount}/${items.length}\\n` +\r\n                `‚Ä¢ –ü—Ä–æ–±–ª–µ–º: ${issuesCount}\\n\\n` +\r\n                `–ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ?`,\r\n                {\r\n                    parse_mode: 'Markdown',\r\n                    reply_markup: keyboard\r\n                }\r\n            );\r\n\r\n        } catch (error) {\r\n            logger.error('Error completing checklist:', error);\r\n            await this.bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —á–µ–∫-–ª–∏—Å—Ç–∞');\r\n        }\r\n    }\r\n\r\n    async reportPartReplacement(chatId, userId, taskId) {\r\n        try {\r\n            await this.fsmManager.setState(userId, STATES.TECHNICIAN_PART_REPLACEMENT, {\r\n                taskId: taskId\r\n            });\r\n\r\n            await this.bot.sendMessage(chatId,\r\n                'üî© *–ó–∞–º–µ–Ω–∞ –¥–µ—Ç–∞–ª–µ–π*\\n\\n' +\r\n                '–í–≤–µ–¥–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–º–µ–Ω–µ–Ω–Ω–æ–π –¥–µ—Ç–∞–ª–∏:\\n\\n' +\r\n                '–§–æ—Ä–º–∞—Ç: –ù–∞–∑–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–∏ | –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä | –ü—Ä–∏—á–∏–Ω–∞ –∑–∞–º–µ–Ω—ã\\n\\n' +\r\n                '–ü—Ä–∏–º–µ—Ä: –ö—É–ø—é—Ä–æ–ø—Ä–∏–µ–º–Ω–∏–∫ | SN123456 | –ù–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∫—É–ø—é—Ä—ã',\r\n                { parse_mode: 'Markdown' }\r\n            );\r\n\r\n        } catch (error) {\r\n            logger.error('Error reporting part replacement:', error);\r\n            await this.bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–º–µ–Ω—ã –¥–µ—Ç–∞–ª–∏');\r\n        }\r\n    }\r\n\r\n    async handlePartReplacementInput(chatId, userId, text) {\r\n        try {\r\n            const state = await this.fsmManager.getState(userId);\r\n            const taskId = state.data.taskId;\r\n\r\n            const parts = text.split('|').map(part => part.trim());\r\n            if (parts.length !== 3) {\r\n                await this.bot.sendMessage(chatId,\r\n                    '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç!\\n\\n' +\r\n                    '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: –ù–∞–∑–≤–∞–Ω–∏–µ | –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä | –ü—Ä–∏—á–∏–Ω–∞'\r\n                );\r\n                return;\r\n            }\r\n\r\n            const [partName, serialNumber, reason] = parts;\r\n\r\n            await this.prisma.partReplacement.create({\r\n                data: {\r\n                    taskId: parseInt(taskId),\r\n                    partName: partName,\r\n                    serialNumber: serialNumber,\r\n                    reason: reason,\r\n                    replacedAt: new Date()\r\n                }\r\n            });\r\n\r\n            const keyboard = {\r\n                inline_keyboard: [\r\n                    [\r\n                        { text: 'üì∏ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ', callback_data: `tech_part_photo_${taskId}` }\r\n                    ],\r\n                    [\r\n                        { text: 'üî© –ï—â—ë –¥–µ—Ç–∞–ª—å', callback_data: `tech_parts_${taskId}` },\r\n                        { text: '‚úÖ –ì–æ—Ç–æ–≤–æ', callback_data: `tech_task_${taskId}` }\r\n                    ]\r\n                ]\r\n            };\r\n\r\n            await this.bot.sendMessage(chatId,\r\n                `‚úÖ *–ó–∞–º–µ–Ω–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞*\\n\\n` +\r\n                `üî© –î–µ—Ç–∞–ª—å: ${partName}\\n` +\r\n                `üè∑Ô∏è –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä: ${serialNumber}\\n` +\r\n                `üìù –ü—Ä–∏—á–∏–Ω–∞: ${reason}\\n\\n` +\r\n                `–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`,\r\n                {\r\n                    parse_mode: 'Markdown',\r\n                    reply_markup: keyboard\r\n                }\r\n            );\r\n\r\n            await this.fsmManager.setState(userId, STATES.TECHNICIAN_MAINTENANCE, {\r\n                taskId: taskId\r\n            });\r\n\r\n        } catch (error) {\r\n            logger.error('Error handling part replacement input:', error);\r\n            await this.bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–µ—Ç–∞–ª–∏');\r\n        }\r\n    }\r\n\r\n    async completeMaintenanceReport(chatId, userId, taskId) {\r\n        try {\r\n            const task = await this.prisma.maintenanceTask.findUnique({\r\n                where: { id: parseInt(taskId) },\r\n                include: {\r\n                    machine: { include: { location: true } },\r\n                    checklistItems: true,\r\n                    partReplacements: true\r\n                }\r\n            });\r\n\r\n            if (!task) {\r\n                await this.bot.sendMessage(chatId, '‚ùå –ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');\r\n                return;\r\n            }\r\n\r\n            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏\r\n            await this.prisma.maintenanceTask.update({\r\n                where: { id: parseInt(taskId) },\r\n                data: {\r\n                    status: 'COMPLETED',\r\n                    completedAt: new Date()\r\n                }\r\n            });\r\n\r\n            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–∞—Ç–∞\r\n            const issuesCount = task.checklistItems.filter(item => item.status === 'ISSUE').length;\r\n            const newMachineStatus = issuesCount > 0 ? 'MAINTENANCE_REQUIRED' : 'ONLINE';\r\n\r\n            await this.prisma.machine.update({\r\n                where: { id: task.machineId },\r\n                data: { status: newMachineStatus }\r\n            });\r\n\r\n            // –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á—ë—Ç\r\n            const completedItems = task.checklistItems.filter(item => item.status === 'COMPLETED').length;\r\n            const totalItems = task.checklistItems.length;\r\n\r\n            const keyboard = {\r\n                inline_keyboard: [\r\n                    [\r\n                        { text: 'üìã –ù–æ–≤–æ–µ –¢–û', callback_data: 'tech_start_maintenance' }\r\n                    ],\r\n                    [\r\n                        { text: 'üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', callback_data: 'main_menu' }\r\n                    ]\r\n                ]\r\n            };\r\n\r\n            await this.bot.sendMessage(chatId,\r\n                `‚úÖ *–¢–û –∑–∞–≤–µ—Ä—à–µ–Ω–æ!*\\n\\n` +\r\n                `üìç –õ–æ–∫–∞—Ü–∏—è: ${task.machine.location.name}\\n` +\r\n                `ü§ñ –ê–≤—Ç–æ–º–∞—Ç: ${task.machine.model}\\n` +\r\n                `üÜî –ó–∞–¥–∞—á–∞: #${task.id}\\n\\n` +\r\n                `üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:\\n` +\r\n                `‚Ä¢ –ß–µ–∫-–ª–∏—Å—Ç: ${completedItems}/${totalItems}\\n` +\r\n                `‚Ä¢ –ü—Ä–æ–±–ª–µ–º: ${issuesCount}\\n` +\r\n                `‚Ä¢ –ó–∞–º–µ–Ω –¥–µ—Ç–∞–ª–µ–π: ${task.partReplacements.length}\\n` +\r\n                `‚Ä¢ –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–∞—Ç–∞: ${newMachineStatus}\\n\\n` +\r\n                `‚è∞ –ó–∞–≤–µ—Ä—à–µ–Ω–æ: ${new Date().toLocaleString('ru-RU')}`,\r\n                {\r\n                    parse_mode: 'Markdown',\r\n                    reply_markup: keyboard\r\n                }\r\n            );\r\n\r\n            await this.fsmManager.setState(userId, STATES.TECHNICIAN_MENU);\r\n\r\n            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º\r\n            await this.sendMaintenanceNotification(task, issuesCount);\r\n\r\n        } catch (error) {\r\n            logger.error('Error completing maintenance report:', error);\r\n            await this.bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –æ—Ç—á—ë—Ç–∞ –¢–û');\r\n        }\r\n    }\r\n\r\n    async sendMaintenanceNotification(task, issuesCount) {\r\n        try {\r\n            // –ü–æ–ª—É—á–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\r\n            const managers = await this.prisma.user.findMany({\r\n                where: {\r\n                    role: { name: 'MANAGER' },\r\n                    telegramId: { not: null }\r\n                }\r\n            });\r\n\r\n            const message = \r\n                `üîß *–ó–∞–≤–µ—Ä—à–µ–Ω–æ –¢–û*\\n\\n` +\r\n                `üìç ${task.machine.location.name}\\n` +\r\n                `ü§ñ ${task.machine.model}\\n` +\r\n                `üë®‚Äçüîß –¢–µ—Ö–Ω–∏–∫: ${task.technicianId}\\n` +\r\n                `‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º: ${issuesCount}\\n` +\r\n                `‚è∞ ${new Date().toLocaleString('ru-RU')}`;\r\n\r\n            for (const manager of managers) {\r\n                try {\r\n                    await this.bot.sendMessage(manager.telegramId, message, {\r\n                        parse_mode: 'Markdown'\r\n                    });\r\n                } catch (error) {\r\n                    logger.warn(`Failed to send notification to manager ${manager.id}:`, error);\r\n                }\r\n            }\r\n\r\n        } catch (error) {\r\n            logger.error('Error sending maintenance notification:', error);\r\n        }\r\n    }\r\n\r\n    async showReports(chatId, userId) {\r\n        try {\r\n            const reports = await this.prisma.maintenanceTask.findMany({\r\n                where: { \r\n                    technicianId: parseInt(userId),\r\n                    status: 'COMPLETED'\r\n                },\r\n                include: {\r\n                    machine: { include: { location: true } }\r\n                },\r\n                orderBy: { completedAt: 'desc' },\r\n                take: 10\r\n            });\r\n\r\n            if (reports.length === 0) {\r\n                await this.bot.sendMessage(chatId, \r\n                    'üìä –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –æ—Ç—á—ë—Ç–æ–≤ –¢–û'\r\n                );\r\n                return;\r\n            }\r\n\r\n            let message = 'üìä *–í–∞—à–∏ –æ—Ç—á—ë—Ç—ã –¢–û*\\n\\n';\r\n            \r\n            reports.forEach((report, index) => {\r\n                message += `${index + 1}. üè™ ${report.machine.location.name}\\n`;\r\n                message += `   üìÖ ${report.completedAt.toLocaleDateString('ru-RU')}\\n`;\r\n                message += `   üÜî #${report.id}\\n\\n`;\r\n            });\r\n\r\n            const keyboard = {\r\n                inline_keyboard: [\r\n                    [\r\n                        { text: 'üîô –ù–∞–∑–∞–¥', callback_data: 'technician_menu' }\r\n                    ]\r\n                ]\r\n            };\r\n\r\n            await this.bot.sendMessage(chatId, message, {\r\n                parse_mode: 'Markdown',\r\n                reply_markup: keyboard\r\n            });\r\n\r\n        } catch (error) {\r\n            logger.error('Error showing reports:', error);\r\n            await this.bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Ç—á—ë—Ç–æ–≤');\r\n        }\r\n    }\r\n\r\n    async reportProblem(chatId, userId) {\r\n        try {\r\n            await this.fsmManager.setState(userId, STATES.TECHNICIAN_REPORT_PROBLEM);\r\n\r\n            await this.bot.sendMessage(chatId,\r\n                'üö® *–°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ*\\n\\n' +\r\n                '–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –ø–æ–¥—Ä–æ–±–Ω–æ:\\n' +\r\n                '‚Ä¢ –ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ?\\n' +\r\n                '‚Ä¢ –ì–¥–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ?\\n' +\r\n                '‚Ä¢ –ö–æ–≥–¥–∞ –∑–∞–º–µ—Ç–∏–ª–∏?\\n' +\r\n                '‚Ä¢ –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã',\r\n                { parse_mode: 'Markdown' }\r\n            );\r\n\r\n        } catch (error) {\r\n            logger.error('Error reporting problem:', error);\r\n            await this.bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—Ç—á—ë—Ç–∞ –æ –ø—Ä–æ–±–ª–µ–º–µ');\r\n        }\r\n    }\r\n\r\n    async handleProblemReport(chatId, userId, text) {\r\n        try {\r\n            // –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É —Å –≤—ã—Å–æ–∫–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º\r\n            const problemTask = await this.prisma.maintenanceTask.create({\r\n                data: {\r\n                    technicianId: parseInt(userId),\r\n                    type: 'EMERGENCY',\r\n                    status: 'PENDING',\r\n                    priority: 'HIGH',\r\n                    description: `–ü–†–û–ë–õ–ï–ú–ê: ${text}`,\r\n                    scheduledDate: new Date()\r\n                }\r\n            });\r\n\r\n            await this.bot.sendMessage(chatId,\r\n                `üö® *–ü—Ä–æ–±–ª–µ–º–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞*\\n\\n` +\r\n                `üÜî –ù–æ–º–µ—Ä: #${problemTask.id}\\n` +\r\n                `üìù –û–ø–∏—Å–∞–Ω–∏–µ: ${text}\\n` +\r\n                `‚ö° –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í–´–°–û–ö–ò–ô\\n\\n` +\r\n                `–ú–µ–Ω–µ–¥–∂–µ—Ä—ã —É–≤–µ–¥–æ–º–ª–µ–Ω—ã!`,\r\n                { parse_mode: 'Markdown' }\r\n            );\r\n\r\n            await this.fsmManager.setState(userId, STATES.TECHNICIAN_MENU);\r\n\r\n            // –£–≤–µ–¥–æ–º–ª—è–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤\r\n            await this.sendProblemNotification(problemTask, userId);\r\n\r\n        } catch (error) {\r\n            logger.error('Error handling problem report:', error);\r\n            await this.bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç—á—ë—Ç–∞ –æ –ø—Ä–æ–±–ª–µ–º–µ');\r\n        }\r\n    }\r\n\r\n    async sendProblemNotification(task, technicianId) {\r\n        try {\r\n            const managers = await this.prisma.user.findMany({\r\n                where: {\r\n                    role: { name: 'MANAGER' },\r\n                    telegramId: { not: null }\r\n                }\r\n            });\r\n\r\n            const message = \r\n                `üö® *–ü–†–û–ë–õ–ï–ú–ê!*\\n\\n` +\r\n                `üë®‚Äçüîß –¢–µ—Ö–Ω–∏–∫: ${technicianId}\\n` +\r\n                `üÜî –ó–∞–¥–∞—á–∞: #${task.id}\\n` +\r\n                `üìù ${task.description}\\n` +\r\n                `‚è∞ ${new Date().toLocaleString('ru-RU')}\\n\\n` +\r\n                `‚ö° –¢—Ä–µ–±—É–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è!`;\r\n\r\n            for (const manager of managers) {\r\n                try {\r\n                    await this.bot.sendMessage(manager.telegramId, message, {\r\n                        parse_mode: 'Markdown'\r\n                    });\r\n                } catch (error) {\r\n                    logger.warn(`Failed to send problem notification to manager ${manager.id}:`, error);\r\n                }\r\n            }\r\n\r\n        } catch (error) {\r\n            logger.error('Error sending problem notification:', error);\r\n        }\r\n    }\r\n}\r\n\r\nmodule.exports = { TechnicianHandler };\r\n",
  "services/telegram-bot/src/index.js": "const TelegramBot = require('node-telegram-bot-api');\r\nconst dotenv = require('dotenv');\r\nconst winston = require('winston');\r\nconst axios = require('axios');\r\nconst path = require('path');\r\n\r\n// Handlers\r\nconst { handleStart } = require('./handlers/startHandler.js');\r\nconst { handleMachines } = require('./handlers/machinesHandler.js');\r\nconst { handleInventory } = require('./handlers/inventoryHandler.js');\r\nconst { handleTasks } = require('./handlers/tasksHandler.js');\r\nconst { handleReports } = require('./handlers/reportsHandler.js');\r\nconst { handleSettings } = require('./handlers/settingsHandler.js');\r\nconst { handleCallbackQuery } = require('./handlers/callbackHandler.js');\r\nconst UploadHandler = require('./handlers/uploadHandler.js');\r\n\r\n// FSM Handlers\r\nconst registrationHandler = require('./handlers/registrationHandler.js');\r\nconst driverHandler = require('./handlers/driverHandler.js');\r\nconst warehouseHandler = require('./handlers/warehouseHandler.js');\r\nconst operatorHandler = require('./handlers/operatorHandler.js');\r\nconst { TechnicianHandler } = require('./handlers/technicianHandler.js');\r\n\r\n// FSM\r\nconst fsmManager = require('./fsm/manager.js');\r\nconst { \r\n  REGISTRATION_STATES, \r\n  DRIVER_STATES, \r\n  WAREHOUSE_STATES, \r\n  OPERATOR_STATES,\r\n  TECHNICIAN_STATES,\r\n  isRegistrationState, \r\n  isDriverState, \r\n  isWarehouseState, \r\n  isOperatorState,\r\n  isTechnicianState \r\n} = require('./fsm/states.js');\r\n\r\n// Utils\r\nconst { checkAuth } = require('./utils/auth.js');\r\nconst { errorHandler } = require('./utils/errorHandler.js');\r\n\r\n// Load environment variables\r\ndotenv.config({ path: path.join(__dirname, '../../../.env') });\r\n\r\n// Configure logger\r\nconst logger = winston.createLogger({\r\n  level: 'info',\r\n  format: winston.format.combine(\r\n    winston.format.timestamp(),\r\n    winston.format.errors({ stack: true }),\r\n    winston.format.json()\r\n  ),\r\n  transports: [\r\n    new winston.transports.Console({\r\n      format: winston.format.combine(\r\n        winston.format.colorize(),\r\n        winston.format.simple()\r\n      )\r\n    }),\r\n    new winston.transports.File({ \r\n      filename: path.join(__dirname, '../logs/error.log'), \r\n      level: 'error' \r\n    }),\r\n    new winston.transports.File({ \r\n      filename: path.join(__dirname, '../logs/combined.log') \r\n    })\r\n  ]\r\n});\r\n\r\n// Configuration\r\nconst config = {\r\n  telegramToken: process.env.TELEGRAM_BOT_TOKEN || '',\r\n  apiUrl: process.env.API_URL || 'http://localhost:8000/api/v1',\r\n  adminIds: (process.env.ADMIN_IDS || '').split(',').map(id => id.trim()),\r\n  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞ (polling –∏–ª–∏ webhook)\r\n  mode: process.env.NODE_ENV === 'production' ? 'webhook' : 'polling',\r\n  polling: {\r\n    interval: 1000,\r\n    autoStart: true,\r\n    params: {\r\n      timeout: 10\r\n    }\r\n  },\r\n  webhook: {\r\n    port: process.env.TELEGRAM_WEBHOOK_PORT || 8443,\r\n    url: process.env.TELEGRAM_WEBHOOK_URL || ''\r\n  }\r\n};\r\n\r\n// Validate required configuration\r\nif (!config.telegramToken) {\r\n  logger.error('TELEGRAM_BOT_TOKEN is not set in environment variables');\r\n  process.exit(1);\r\n}\r\n\r\n// Create bot instance\r\nlet bot;\r\nif (config.mode === 'webhook' && config.webhook.url) {\r\n  logger.info(`Starting bot in webhook mode with URL: ${config.webhook.url}`);\r\n  bot = new TelegramBot(config.telegramToken, {\r\n    webhook: {\r\n      port: config.webhook.port,\r\n      host: '0.0.0.0'\r\n    }\r\n  });\r\n  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º webhook\r\n  bot.setWebHook(config.webhook.url)\r\n    .then(() => logger.info('Webhook set successfully'))\r\n    .catch(error => logger.error('Failed to set webhook:', error));\r\n} else {\r\n  logger.info('Starting bot in polling mode');\r\n  bot = new TelegramBot(config.telegramToken, { polling: config.polling });\r\n}\r\n\r\n// Global error handler\r\nbot.on('polling_error', (error) => {\r\n  logger.error('Polling error:', error);\r\n});\r\n\r\nbot.on('webhook_error', (error) => {\r\n  logger.error('Webhook error:', error);\r\n});\r\n\r\n// API client setup\r\nconst apiClient = axios.create({\r\n  baseURL: config.apiUrl,\r\n  timeout: 10000,\r\n  headers: {\r\n    'Content-Type': 'application/json'\r\n  }\r\n});\r\n\r\n// Request interceptor to add auth token\r\napiClient.interceptors.request.use((config) => {\r\n  const token = global.userTokens?.get(global.currentUserId);\r\n  if (token) {\r\n    config.headers.Authorization = `Bearer ${token}`;\r\n  }\r\n  return config;\r\n});\r\n\r\n// Response interceptor for error handling\r\napiClient.interceptors.response.use(\r\n  (response) => response,\r\n  (error) => {\r\n    logger.error('API Error:', error.response?.data || error.message);\r\n    throw error;\r\n  }\r\n);\r\n\r\n// Store user tokens (in production, use Redis or similar)\r\nglobal.userTokens = new Map();\r\nglobal.apiClient = apiClient;\r\nglobal.logger = logger;\r\nglobal.config = config;\r\n\r\n// Initialize handlers\r\nlet technicianHandler;\r\nlet uploadHandler;\r\n\r\n// Initialize FSM Manager\r\n(async () => {\r\n  try {\r\n    await fsmManager.initRedis();\r\n    logger.info('FSM Manager initialized');\r\n    \r\n    // Initialize TechnicianHandler after bot is ready\r\n    // Note: prisma will be initialized when needed\r\n    technicianHandler = new TechnicianHandler(bot, null);\r\n    logger.info('TechnicianHandler initialized');\r\n    \r\n    // Initialize UploadHandler for DigitalOcean Spaces integration\r\n    uploadHandler = new UploadHandler(bot);\r\n    logger.info('UploadHandler initialized - DigitalOcean Spaces ready');\r\n    \r\n    // Setup cleanup interval for temporary files\r\n    setInterval(() => {\r\n      if (uploadHandler) {\r\n        uploadHandler.cleanupTempFiles();\r\n      }\r\n    }, 60 * 60 * 1000); // Cleanup every hour\r\n    \r\n  } catch (error) {\r\n    logger.error('FSM Manager initialization failed:', error);\r\n  }\r\n})();\r\n\r\n// Command handlers\r\nbot.onText(/\\/start/, async (msg) => {\r\n  try {\r\n    await handleStart(bot, msg);\r\n  } catch (error) {\r\n    await errorHandler(bot, msg, error);\r\n  }\r\n});\r\n\r\nbot.onText(/\\/machines/, async (msg) => {\r\n  try {\r\n    if (!await checkAuth(bot, msg)) return;\r\n    await handleMachines(bot, msg);\r\n  } catch (error) {\r\n    await errorHandler(bot, msg, error);\r\n  }\r\n});\r\n\r\nbot.onText(/\\/inventory/, async (msg) => {\r\n  try {\r\n    if (!await checkAuth(bot, msg)) return;\r\n    await handleInventory(bot, msg);\r\n  } catch (error) {\r\n    await errorHandler(bot, msg, error);\r\n  }\r\n});\r\n\r\nbot.onText(/\\/tasks/, async (msg) => {\r\n  try {\r\n    if (!await checkAuth(bot, msg)) return;\r\n    await handleTasks(bot, msg);\r\n  } catch (error) {\r\n    await errorHandler(bot, msg, error);\r\n  }\r\n});\r\n\r\nbot.onText(/\\/reports/, async (msg) => {\r\n  try {\r\n    if (!await checkAuth(bot, msg)) return;\r\n    await handleReports(bot, msg);\r\n  } catch (error) {\r\n    await errorHandler(bot, msg, error);\r\n  }\r\n});\r\n\r\nbot.onText(/\\/settings/, async (msg) => {\r\n  try {\r\n    if (!await checkAuth(bot, msg)) return;\r\n    await handleSettings(bot, msg);\r\n  } catch (error) {\r\n    await errorHandler(bot, msg, error);\r\n  }\r\n});\r\n\r\n// –ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏\r\nbot.onText(/\\/set_password/, async (msg) => {\r\n  try {\r\n    if (!await checkAuth(bot, msg)) return;\r\n    await bot.sendMessage(msg.chat.id, \r\n      'üîê –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.\\n' +\r\n      '–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è.'\r\n    );\r\n  } catch (error) {\r\n    await errorHandler(bot, msg, error);\r\n  }\r\n});\r\n\r\nbot.onText(/\\/change_password/, async (msg) => {\r\n  try {\r\n    if (!await checkAuth(bot, msg)) return;\r\n    await bot.sendMessage(msg.chat.id, \r\n      'üîê –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.\\n' +\r\n      '–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è.'\r\n    );\r\n  } catch (error) {\r\n    await errorHandler(bot, msg, error);\r\n  }\r\n});\r\n\r\nbot.onText(/\\/route/, async (msg) => {\r\n  try {\r\n    if (!await checkAuth(bot, msg)) return;\r\n    await bot.sendMessage(msg.chat.id, \r\n      'üöö –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞–º–∏.\\n' +\r\n      '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –≤–æ–¥–∏—Ç–µ–ª—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–∞—Ä—à—Ä—É—Ç–∞–º–∏.'\r\n    );\r\n  } catch (error) {\r\n    await errorHandler(bot, msg, error);\r\n  }\r\n});\r\n\r\nbot.onText(/\\/fuel/, async (msg) => {\r\n  try {\r\n    if (!await checkAuth(bot, msg)) return;\r\n    await bot.sendMessage(msg.chat.id, \r\n      '‚õΩ –ó–∞–ø—Ä–∞–≤–∫–∞.\\n' +\r\n      '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –≤–æ–¥–∏—Ç–µ–ª—è –¥–ª—è –æ—Ç—á—ë—Ç–∞ –æ –∑–∞–ø—Ä–∞–≤–∫–µ.'\r\n    );\r\n  } catch (error) {\r\n    await errorHandler(bot, msg, error);\r\n  }\r\n});\r\n\r\nbot.onText(/\\/mileage/, async (msg) => {\r\n  try {\r\n    if (!await checkAuth(bot, msg)) return;\r\n    await bot.sendMessage(msg.chat.id, \r\n      'üìè –ü—Ä–æ–±–µ–≥.\\n' +\r\n      '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –≤–æ–¥–∏—Ç–µ–ª—è –¥–ª—è –≤–≤–æ–¥–∞ –ø—Ä–æ–±–µ–≥–∞.'\r\n    );\r\n  } catch (error) {\r\n    await errorHandler(bot, msg, error);\r\n  }\r\n});\r\n\r\nbot.onText(/\\/arrived/, async (msg) => {\r\n  try {\r\n    if (!await checkAuth(bot, msg)) return;\r\n    await bot.sendMessage(msg.chat.id, \r\n      'üìç –ü—Ä–∏–±—ã—Ç–∏–µ.\\n' +\r\n      '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –≤–æ–¥–∏—Ç–µ–ª—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–∏–±—ã—Ç–∏—è.'\r\n    );\r\n  } catch (error) {\r\n    await errorHandler(bot, msg, error);\r\n  }\r\n});\r\n\r\nbot.onText(/\\/receive/, async (msg) => {\r\n  try {\r\n    if (!await checkAuth(bot, msg)) return;\r\n    await bot.sendMessage(msg.chat.id, \r\n      'üì¶ –ü—Ä–∏—ë–º —Ç–æ–≤–∞—Ä–∞.\\n' +\r\n      '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é —Å–∫–ª–∞–¥–∞ –¥–ª—è –ø—Ä–∏—ë–º–∞ —Ç–æ–≤–∞—Ä–æ–≤.'\r\n    );\r\n  } catch (error) {\r\n    await errorHandler(bot, msg, error);\r\n  }\r\n});\r\n\r\nbot.onText(/\\/weigh/, async (msg) => {\r\n  try {\r\n    if (!await checkAuth(bot, msg)) return;\r\n    await bot.sendMessage(msg.chat.id, \r\n      '‚öñÔ∏è –í–∑–≤–µ—à–∏–≤–∞–Ω–∏–µ.\\n' +\r\n      '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é —Å–∫–ª–∞–¥–∞ –¥–ª—è –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤.'\r\n    );\r\n  } catch (error) {\r\n    await errorHandler(bot, msg, error);\r\n  }\r\n});\r\n\r\nbot.onText(/\\/fill_bunker/, async (msg) => {\r\n  try {\r\n    if (!await checkAuth(bot, msg)) return;\r\n    await bot.sendMessage(msg.chat.id, \r\n      'üóÇÔ∏è –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –±—É–Ω–∫–µ—Ä–∞.\\n' +\r\n      '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é —Å–∫–ª–∞–¥–∞ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –±—É–Ω–∫–µ—Ä–æ–≤.'\r\n    );\r\n  } catch (error) {\r\n    await errorHandler(bot, msg, error);\r\n  }\r\n});\r\n\r\nbot.onText(/\\/select_machine/, async (msg) => {\r\n  try {\r\n    if (!await checkAuth(bot, msg)) return;\r\n    await bot.sendMessage(msg.chat.id, \r\n      'ü§ñ –í—ã–±–æ—Ä –∞–≤—Ç–æ–º–∞—Ç–∞.\\n' +\r\n      '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∞–≤—Ç–æ–º–∞—Ç–∞.'\r\n    );\r\n  } catch (error) {\r\n    await errorHandler(bot, msg, error);\r\n  }\r\n});\r\n\r\nbot.onText(/\\/set_remains/, async (msg) => {\r\n  try {\r\n    if (!await checkAuth(bot, msg)) return;\r\n    await bot.sendMessage(msg.chat.id, \r\n      'üìä –û—Å—Ç–∞—Ç–∫–∏.\\n' +\r\n      '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Å—Ç–∞—Ç–∫–æ–≤.'\r\n    );\r\n  } catch (error) {\r\n    await errorHandler(bot, msg, error);\r\n  }\r\n});\r\n\r\nbot.onText(/\\/report_problem/, async (msg) => {\r\n  try {\r\n    if (!await checkAuth(bot, msg)) return;\r\n    await bot.sendMessage(msg.chat.id, \r\n      'üö® –°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ.\\n' +\r\n      '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –º–µ–Ω—é –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö.'\r\n    );\r\n  } catch (error) {\r\n    await errorHandler(bot, msg, error);\r\n  }\r\n});\r\n\r\nbot.onText(/\\/help/, async (msg) => {\r\n  const helpText = `\r\nü§ñ VHM24 Bot Commands\r\n\r\n/start - Start the bot and authenticate\r\n/machines - View and manage vending machines\r\n/inventory - Manage inventory items\r\n/tasks - View and manage tasks\r\n/reports - Generate reports\r\n/settings - Bot settings and preferences\r\n/help - Show this help message\r\n\r\nRole-specific commands:\r\n/route - Manage routes (drivers)\r\n/fuel - Report fuel (drivers)\r\n/mileage - Enter mileage (drivers)\r\n/arrived - Confirm arrival (drivers)\r\n/receive - Receive goods (warehouse)\r\n/weigh - Weigh items (warehouse)\r\n/fill_bunker - Fill bunkers (warehouse)\r\n/select_machine - Select machine (operators)\r\n/set_remains - Set remains (operators)\r\n/report_problem - Report problems (all)\r\n\r\nQuick Actions:\r\n‚Ä¢ Send machine ID to view details\r\n‚Ä¢ Send QR code photo to access machine\r\n‚Ä¢ Send location to find nearest machines\r\n\r\nFor support, contact @vhm24_support\r\n  `;\r\n\r\n  await bot.sendMessage(msg.chat.id, helpText);\r\n});\r\n\r\n// Callback query handler\r\nbot.on('callback_query', async (callbackQuery) => {\r\n  try {\r\n    await handleCallbackQuery(bot, callbackQuery);\r\n  } catch (error) {\r\n    logger.error('Callback query error:', error);\r\n    await bot.answerCallbackQuery(callbackQuery.id, {\r\n      text: '‚ùå Error processing request',\r\n      show_alert: true\r\n    });\r\n  }\r\n});\r\n\r\n// FSM Message Handler - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ FSM\r\nbot.on('message', async (msg) => {\r\n  try {\r\n    const userId = msg.from.id;\r\n    const currentState = await fsmManager.getUserState(userId);\r\n    \r\n    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—ã (–æ–Ω–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ)\r\n    if (msg.text && msg.text.startsWith('/')) {\r\n      return;\r\n    }\r\n\r\n    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ (–Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞)\r\n    if (msg.contact) {\r\n      if (isRegistrationState(currentState)) {\r\n        const handled = await registrationHandler.handlePhoneNumber(bot, msg);\r\n        if (handled) return;\r\n      }\r\n    }\r\n\r\n    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–æ–∫–∞—Ü–∏–∏\r\n    if (msg.location) {\r\n      // FSM –æ–±—Ä–∞–±–æ—Ç–∫–∞ GPS –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π\r\n      if (isDriverState(currentState)) {\r\n        const handled = await driverHandler.handleGPSLocation(bot, msg);\r\n        if (handled) return;\r\n      }\r\n      \r\n      // –û–±—ã—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ª–æ–∫–∞—Ü–∏–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ –º–∞—à–∏–Ω\r\n      if (!await checkAuth(bot, msg)) return;\r\n      \r\n      const { latitude, longitude } = msg.location;\r\n      \r\n      // Find nearest machines\r\n      const response = await global.apiClient.get('/machines', {\r\n        params: {\r\n          lat: latitude,\r\n          lon: longitude,\r\n          radius: 5000 // 5km radius\r\n        }\r\n      });\r\n\r\n      if (response.data.data.length === 0) {\r\n        await bot.sendMessage(msg.chat.id, 'üìç No machines found nearby');\r\n        return;\r\n      }\r\n\r\n      const machines = response.data.data.slice(0, 5); // Show top 5 nearest\r\n      let message = 'üìç Nearest Machines:\\n\\n';\r\n      \r\n      machines.forEach((machine, index) => {\r\n        const distance = machine.distance ? `${(machine.distance / 1000).toFixed(1)}km` : 'N/A';\r\n        message += `${index + 1}. ${machine.name}\\n`;\r\n        message += `   üìç ${machine.location || 'No address'}\\n`;\r\n        message += `   üìè Distance: ${distance}\\n`;\r\n        message += `   üîß Status: ${machine.status}\\n\\n`;\r\n      });\r\n\r\n      await bot.sendMessage(msg.chat.id, message);\r\n      return;\r\n    }\r\n\r\n    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ\r\n    if (msg.photo) {\r\n      // FSM –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π\r\n      if (isDriverState(currentState)) {\r\n        const handled = await driverHandler.handleFuelPhoto(bot, msg);\r\n        if (handled) return;\r\n      }\r\n\r\n      // FSM –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ –¥–ª—è —Å–∫–ª–∞–¥–∞\r\n      if (isWarehouseState(currentState)) {\r\n        const handled = await warehouseHandler.handleConfirmationPhoto(bot, msg);\r\n        if (handled) return;\r\n      }\r\n\r\n      // FSM –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤\r\n      if (isOperatorState(currentState)) {\r\n        const handled = await operatorHandler.handleBunkerPhoto(bot, msg);\r\n        if (handled) return;\r\n      }\r\n      \r\n      // –û–±—ã—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ\r\n      if (!await checkAuth(bot, msg)) return;\r\n      \r\n      await bot.sendMessage(msg.chat.id, \r\n        'üì∏ QR code scanning is under development.\\n' +\r\n        'Please use /machines command to access machines.'\r\n      );\r\n      return;\r\n    }\r\n\r\n    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π\r\n    if (msg.text) {\r\n      // FSM –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏\r\n      if (isRegistrationState(currentState)) {\r\n        const handled = await registrationHandler.handlePassword(bot, msg);\r\n        if (handled) return;\r\n      }\r\n\r\n      // FSM –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π\r\n      if (isDriverState(currentState)) {\r\n        const handled = await driverHandler.handleMileage(bot, msg);\r\n        if (handled) return;\r\n      }\r\n\r\n      // FSM –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Å–∫–ª–∞–¥–∞\r\n      if (isWarehouseState(currentState)) {\r\n        let handled = await warehouseHandler.handleItemScan(bot, msg);\r\n        if (handled) return;\r\n        \r\n        handled = await warehouseHandler.handleQuantityInput(bot, msg);\r\n        if (handled) return;\r\n        \r\n        handled = await warehouseHandler.handleWeightInput(bot, msg);\r\n        if (handled) return;\r\n      }\r\n\r\n      // FSM –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤\r\n      if (isOperatorState(currentState)) {\r\n        let handled = await operatorHandler.handleRemainsInput(bot, msg);\r\n        if (handled) return;\r\n        \r\n        handled = await operatorHandler.handleProblemDescription(bot, msg);\r\n        if (handled) return;\r\n      }\r\n\r\n      // FSM –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Ç–µ—Ö–Ω–∏–∫–æ–≤\r\n      if (isTechnicianState(currentState)) {\r\n        if (technicianHandler) {\r\n          if (currentState === TECHNICIAN_STATES.TECHNICIAN_PART_REPLACEMENT) {\r\n            await technicianHandler.handlePartReplacementInput(msg.chat.id, userId, msg.text);\r\n            return;\r\n          }\r\n          \r\n          if (currentState === TECHNICIAN_STATES.TECHNICIAN_REPORT_PROBLEM) {\r\n            await technicianHandler.handleProblemReport(msg.chat.id, userId, msg.text);\r\n            return;\r\n          }\r\n        }\r\n      }\r\n\r\n      // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ FSM –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω\r\n      if (await checkAuth(bot, msg)) {\r\n        await bot.sendMessage(msg.chat.id,\r\n          'ü§ñ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã –∏–ª–∏ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –±–æ—Ç–æ–º.\\n\\n' +\r\n          '–í–≤–µ–¥–∏—Ç–µ /help –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥.'\r\n        );\r\n      }\r\n    }\r\n\r\n  } catch (error) {\r\n    await errorHandler(bot, msg, error);\r\n  }\r\n});\r\n\r\n// Graceful shutdown\r\nprocess.on('SIGINT', () => {\r\n  logger.info('Shutting down Telegram bot...');\r\n  if (config.mode === 'polling') {\r\n    bot.stopPolling();\r\n  } else if (config.mode === 'webhook') {\r\n    bot.deleteWebHook();\r\n  }\r\n  process.exit(0);\r\n});\r\n\r\nprocess.on('SIGTERM', () => {\r\n  logger.info('Shutting down Telegram bot...');\r\n  if (config.mode === 'polling') {\r\n    bot.stopPolling();\r\n  } else if (config.mode === 'webhook') {\r\n    bot.deleteWebHook();\r\n  }\r\n  process.exit(0);\r\n});\r\n\r\n// Start the bot\r\nlogger.info('VHM24 Telegram Bot is starting...');\r\nlogger.info(`Admin IDs: ${config.adminIds.join(', ')}`);\r\nlogger.info(`API URL: ${config.apiUrl}`);\r\n\r\n// Set bot commands\r\nbot.setMyCommands([\r\n  { command: 'start', description: 'Start the bot' },\r\n  { command: 'machines', description: 'View machines' },\r\n  { command: 'inventory', description: 'Manage inventory' },\r\n  { command: 'tasks', description: 'View tasks' },\r\n  { command: 'reports', description: 'Generate reports' },\r\n  { command: 'settings', description: 'Bot settings' },\r\n  { command: 'help', description: 'Show help' }\r\n]).then(() => {\r\n  logger.info('Bot commands have been set');\r\n}).catch((error) => {\r\n  logger.error('Failed to set bot commands:', error);\r\n});\r\n\r\nlogger.info('VHM24 Telegram Bot is running!');\r\n\r\n\r\n// Health check endpoint for Railway\r\nconst express = require('express');\r\nconst healthApp = express();\r\nconst healthPort = process.env.PORT || 3005;\r\n\r\nhealthApp.get('/health', (req, res) => {\r\n  res.json({\r\n    status: 'ok',\r\n    service: 'telegram-bot',\r\n    timestamp: new Date().toISOString(),\r\n    uptime: process.uptime(),\r\n    bot: bot ? 'connected' : 'disconnected'\r\n  });\r\n});\r\n\r\nhealthApp.listen(healthPort, () => {\r\n  console.log(`Health check server running on port ${healthPort}`);\r\n});\r\n",
  "fix-dependencies-and-start.js": "#!/usr/bin/env node\r\n\r\n/**\r\n * VHM24 Dependencies Fix and Start Script\r\n * –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ –∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤\r\n */\r\n\r\nconst { spawn, exec } = require('child_process');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\nconsole.log('üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ –∑–∞–ø—É—Å–∫ VHM24...\\n');\r\n\r\n// –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ —Å –∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏\r\nconst services = [\r\n  {\r\n    name: 'Notifications',\r\n    path: 'services/notifications',\r\n    dependencies: {\r\n      '@fastify/cors': '^11.0.1',\r\n      '@fastify/helmet': '^13.0.1',\r\n      '@fastify/jwt': '^9.1.0',\r\n      '@fastify/rate-limit': '^10.3.0',\r\n      '@vhm24/database': 'file:../../packages/database',\r\n      '@vhm24/shared-types': 'file:../../packages/shared-types',\r\n      'dotenv': '^16.3.1',\r\n      'fastify': '^5.4.0',\r\n      'nodemailer': '^6.9.7',\r\n      'node-telegram-bot-api': '^0.64.0',\r\n      'winston': '^3.11.0'\r\n    }\r\n  },\r\n  {\r\n    name: 'Audit',\r\n    path: 'services/audit',\r\n    dependencies: {\r\n      '@fastify/cors': '^11.0.1',\r\n      '@fastify/helmet': '^13.0.1',\r\n      '@fastify/jwt': '^9.1.0',\r\n      '@fastify/rate-limit': '^10.3.0',\r\n      '@vhm24/database': 'file:../../packages/database',\r\n      '@vhm24/shared-types': 'file:../../packages/shared-types',\r\n      '@vhm24/shared': 'file:../../packages/shared',\r\n      'dotenv': '^16.3.1',\r\n      'fastify': '^5.4.0',\r\n      'winston': '^3.11.0'\r\n    }\r\n  },\r\n  {\r\n    name: 'Gateway',\r\n    path: 'services/gateway',\r\n    dependencies: {\r\n      '@fastify/cors': '^11.0.1',\r\n      '@fastify/helmet': '^13.0.1',\r\n      '@fastify/jwt': '^9.1.0',\r\n      '@fastify/rate-limit': '^10.3.0',\r\n      '@fastify/http-proxy': '^10.0.0',\r\n      '@fastify/multipart': '^8.0.0',\r\n      '@fastify/websocket': '^10.0.0',\r\n      '@vhm24/database': 'file:../../packages/database',\r\n      '@vhm24/shared-types': 'file:../../packages/shared-types',\r\n      '@vhm24/shared': 'file:../../packages/shared',\r\n      'dotenv': '^16.3.1',\r\n      'fastify': '^5.4.0',\r\n      'uuid': '^9.0.1'\r\n    }\r\n  }\r\n];\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è package.json\r\nfunction updatePackageJson(servicePath, dependencies) {\r\n  const packageJsonPath = path.join(__dirname, servicePath, 'package.json');\r\n  \r\n  if (!fs.existsSync(packageJsonPath)) {\r\n    console.log(`‚ö†Ô∏è  package.json –Ω–µ –Ω–∞–π–¥–µ–Ω: ${packageJsonPath}`);\r\n    return false;\r\n  }\r\n\r\n  try {\r\n    const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'));\r\n    \r\n    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏\r\n    packageJson.dependencies = {\r\n      ...packageJson.dependencies,\r\n      ...dependencies\r\n    };\r\n\r\n    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π package.json\r\n    fs.writeFileSync(packageJsonPath, JSON.stringify(packageJson, null, 2));\r\n    console.log(`‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω package.json –¥–ª—è ${servicePath}`);\r\n    return true;\r\n  } catch (error) {\r\n    console.log(`‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è package.json –¥–ª—è ${servicePath}:`, error.message);\r\n    return false;\r\n  }\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π\r\nfunction installDependencies(servicePath) {\r\n  return new Promise((resolve) => {\r\n    console.log(`üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è ${servicePath}...`);\r\n    \r\n    const installProcess = spawn('npm', ['install'], {\r\n      cwd: path.join(__dirname, servicePath),\r\n      stdio: 'pipe',\r\n      shell: true\r\n    });\r\n\r\n    let output = '';\r\n    installProcess.stdout.on('data', (data) => {\r\n      output += data.toString();\r\n    });\r\n\r\n    installProcess.stderr.on('data', (data) => {\r\n      output += data.toString();\r\n    });\r\n\r\n    installProcess.on('close', (code) => {\r\n      if (code === 0) {\r\n        console.log(`‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è ${servicePath}`);\r\n        resolve(true);\r\n      } else {\r\n        console.log(`‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è ${servicePath}`);\r\n        console.log(output);\r\n        resolve(false);\r\n      }\r\n    });\r\n\r\n    installProcess.on('error', (error) => {\r\n      console.log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–ª—è ${servicePath}:`, error.message);\r\n      resolve(false);\r\n    });\r\n  });\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤\r\nfunction createMissingFiles() {\r\n  console.log('üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤...');\r\n\r\n  // –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç\r\n  const directories = [\r\n    'services/notifications/src',\r\n    'services/audit/src',\r\n    'packages/shared/middleware'\r\n  ];\r\n\r\n  directories.forEach(dir => {\r\n    const fullPath = path.join(__dirname, dir);\r\n    if (!fs.existsSync(fullPath)) {\r\n      fs.mkdirSync(fullPath, { recursive: true });\r\n      console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: ${dir}`);\r\n    }\r\n  });\r\n\r\n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤\r\n  const criticalFiles = [\r\n    'services/notifications/src/index.js',\r\n    'services/notifications/src/services/notificationService.js',\r\n    'services/audit/src/index.js',\r\n    'packages/shared/middleware/auditMiddleware.js'\r\n  ];\r\n\r\n  let missingFiles = [];\r\n  criticalFiles.forEach(file => {\r\n    if (!fs.existsSync(path.join(__dirname, file))) {\r\n      missingFiles.push(file);\r\n    }\r\n  });\r\n\r\n  if (missingFiles.length > 0) {\r\n    console.log('‚ö†Ô∏è  –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã:');\r\n    missingFiles.forEach(file => console.log(`   - ${file}`));\r\n    return false;\r\n  }\r\n\r\n  console.log('‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ –º–µ—Å—Ç–µ');\r\n  return true;\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\nfunction checkEnvironmentVariables() {\r\n  console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è...');\r\n\r\n  const envPath = path.join(__dirname, '.env');\r\n  if (!fs.existsSync(envPath)) {\r\n    console.log('‚ö†Ô∏è  –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –∏–∑ .env.example...');\r\n    \r\n    const examplePath = path.join(__dirname, '.env.example');\r\n    if (fs.existsSync(examplePath)) {\r\n      fs.copyFileSync(examplePath, envPath);\r\n      console.log('‚úÖ –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª .env –∏–∑ .env.example');\r\n    } else {\r\n      console.log('‚ùå –§–∞–π–ª .env.example –Ω–µ –Ω–∞–π–¥–µ–Ω');\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ\r\n  const envContent = fs.readFileSync(envPath, 'utf8');\r\n  const requiredVars = ['JWT_SECRET', 'DATABASE_URL'];\r\n  \r\n  const missingVars = requiredVars.filter(varName => \r\n    !envContent.includes(`${varName}=`) || envContent.includes(`${varName}=`)\r\n  );\r\n\r\n  if (missingVars.length > 0) {\r\n    console.log('‚ö†Ô∏è  –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è:');\r\n    missingVars.forEach(varName => console.log(`   - ${varName}`));\r\n    console.log('üìù –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–∞–π–ª .env');\r\n  } else {\r\n    console.log('‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');\r\n  }\r\n\r\n  return true;\r\n}\r\n\r\n// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è\r\nasync function main() {\r\n  try {\r\n    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Å–æ–∑–¥–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ñ–∞–π–ª—ã\r\n    if (!createMissingFiles()) {\r\n      console.log('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç. –û—Å—Ç–∞–Ω–æ–≤–∫–∞.');\r\n      process.exit(1);\r\n    }\r\n\r\n    // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\n    checkEnvironmentVariables();\r\n\r\n    // 3. –û–±–Ω–æ–≤–ª—è–µ–º package.json —Ñ–∞–π–ª—ã\r\n    console.log('\\nüìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ package.json —Ñ–∞–π–ª–æ–≤...');\r\n    for (const service of services) {\r\n      updatePackageJson(service.path, service.dependencies);\r\n    }\r\n\r\n    // 4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏\r\n    console.log('\\nüì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...');\r\n    for (const service of services) {\r\n      const servicePath = path.join(__dirname, service.path);\r\n      if (fs.existsSync(servicePath)) {\r\n        await installDependencies(service.path);\r\n      } else {\r\n        console.log(`‚ö†Ô∏è  –°–µ—Ä–≤–∏—Å –Ω–µ –Ω–∞–π–¥–µ–Ω: ${service.path}`);\r\n      }\r\n    }\r\n\r\n    // 5. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤\r\n    console.log('\\nüì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤...');\r\n    const packages = ['packages/database', 'packages/shared', 'packages/shared-types'];\r\n    \r\n    for (const pkg of packages) {\r\n      const pkgPath = path.join(__dirname, pkg);\r\n      if (fs.existsSync(pkgPath)) {\r\n        await installDependencies(pkg);\r\n      }\r\n    }\r\n\r\n    // 6. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞\r\n    console.log('\\nüì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ—Ä–Ω–µ–≤—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...');\r\n    await installDependencies('.');\r\n\r\n    console.log('\\nüéâ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!');\r\n    console.log('\\nüöÄ –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã:');\r\n    console.log('   node start-all-services-with-audit.js');\r\n    console.log('   node test-complete-system-with-notifications.js');\r\n\r\n  } catch (error) {\r\n    console.error('üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// –ó–∞–ø—É—Å–∫\r\nif (require.main === module) {\r\n  main();\r\n}\r\n\r\nmodule.exports = { main };\r\n",
  "fix-fast-jwt.js": "/**\r\n * VHM24 - Fix Fast-JWT Compatibility\r\n * \r\n * –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ fast-jwt —Å Node.js v22+\r\n * –ü—Ä–æ–±–ª–µ–º–∞: fast-jwt –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –≤–µ—Ä—Å–∏—é Node.js < 22\r\n * –†–µ—à–µ–Ω–∏–µ: –ü–∞—Ç—á–∏–º package.json –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è\r\n */\r\n\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\n// –ü—É—Ç—å –∫ package.json fast-jwt\r\nconst fastJwtPath = path.join(__dirname, 'node_modules', 'fast-jwt', 'package.json');\r\n\r\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞\r\nif (!fs.existsSync(fastJwtPath)) {\r\n  console.error('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω package.json –¥–ª—è fast-jwt');\r\n  process.exit(1);\r\n}\r\n\r\ntry {\r\n  // –ß–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–∏–π package.json\r\n  const packageJson = JSON.parse(fs.readFileSync(fastJwtPath, 'utf8'));\r\n  \r\n  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ engines –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è\r\n  const originalEngines = JSON.stringify(packageJson.engines || {});\r\n  \r\n  // –£–¥–∞–ª—è–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –≤–µ—Ä—Å–∏—é Node.js\r\n  if (packageJson.engines && packageJson.engines.node) {\r\n    console.log(`‚ÑπÔ∏è –¢–µ–∫—É—â–µ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: ${packageJson.engines.node}`);\r\n    packageJson.engines.node = \">=16\";\r\n    console.log(`‚úÖ –ù–æ–≤–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: ${packageJson.engines.node}`);\r\n  } else {\r\n    console.log('‚ÑπÔ∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –≤–µ—Ä—Å–∏—é Node.js –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');\r\n  }\r\n  \r\n  // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π package.json\r\n  fs.writeFileSync(fastJwtPath, JSON.stringify(packageJson, null, 2), 'utf8');\r\n  \r\n  console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω ${fastJwtPath}`);\r\n  console.log(`‚ÑπÔ∏è –ò–∑–º–µ–Ω–µ–Ω–æ: engines —Å ${originalEngines} –Ω–∞ ${JSON.stringify(packageJson.engines || {})}`);\r\n  \r\n} catch (error) {\r\n  console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ package.json:', error);\r\n  process.exit(1);\r\n}\r\n",
  "railway-start-production.js": "#!/usr/bin/env node\r\n\r\n/**\r\n * VHM24 Railway Production Start Script\r\n * –°—Ç–∞–±–∏–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –¥–ª—è Railway —Å –±–∞–∑–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é\r\n */\r\n\r\nconst Fastify = require('fastify');\r\nconst path = require('path');\r\n\r\nconsole.log('üöÇ VHM24 Railway Production Start...');\r\nconsole.log(`üìç Environment: ${process.env.NODE_ENV || 'production'}`);\r\nconsole.log(`üîå Port: ${process.env.PORT || 8000}`);\r\n\r\n// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\nprocess.env.NODE_ENV = process.env.NODE_ENV || 'production';\r\nconst PORT = process.env.PORT || 8000;\r\n\r\n// –°–æ–∑–¥–∞–µ–º Fastify —Å–µ—Ä–≤–µ—Ä —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º\r\nconst fastify = Fastify({\r\n  logger: {\r\n    level: 'info',\r\n    prettyPrint: process.env.NODE_ENV === 'development'\r\n  }\r\n});\r\n\r\n// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º CORS\r\nfastify.register(require('@fastify/cors'), {\r\n  origin: true,\r\n  credentials: true\r\n});\r\n\r\n// Health check endpoint\r\nfastify.get('/health', async (request, reply) => {\r\n  const healthData = {\r\n    status: 'ok',\r\n    service: 'vhm24-production',\r\n    timestamp: new Date().toISOString(),\r\n    environment: process.env.NODE_ENV || 'production',\r\n    port: PORT,\r\n    uptime: process.uptime(),\r\n    memory: process.memoryUsage(),\r\n    version: '1.0.0'\r\n  };\r\n\r\n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ\r\n  if (process.env.DATABASE_URL) {\r\n    try {\r\n      const { PrismaClient } = require('@prisma/client');\r\n      const prisma = new PrismaClient();\r\n      await prisma.$queryRaw`SELECT 1`;\r\n      await prisma.$disconnect();\r\n      healthData.database = 'connected';\r\n    } catch (error) {\r\n      healthData.database = 'disconnected';\r\n      healthData.database_error = error.message;\r\n    }\r\n  }\r\n\r\n  return healthData;\r\n});\r\n\r\n// Root endpoint\r\nfastify.get('/', async (request, reply) => {\r\n  reply.type('text/html');\r\n  return `\r\n    <!DOCTYPE html>\r\n    <html lang=\"ru\">\r\n    <head>\r\n      <meta charset=\"UTF-8\">\r\n      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n      <title>VHM24 - Railway Production</title>\r\n      <style>\r\n        * { margin: 0; padding: 0; box-sizing: border-box; }\r\n        body { \r\n          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\r\n          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n          color: white;\r\n          min-height: 100vh;\r\n          display: flex;\r\n          align-items: center;\r\n          justify-content: center;\r\n        }\r\n        .container { \r\n          max-width: 900px; \r\n          margin: 0 auto; \r\n          padding: 40px;\r\n          background: rgba(255,255,255,0.1);\r\n          border-radius: 20px;\r\n          backdrop-filter: blur(10px);\r\n          box-shadow: 0 8px 32px rgba(0,0,0,0.1);\r\n          text-align: center;\r\n        }\r\n        .success { \r\n          color: #4CAF50; \r\n          font-size: 2.5em; \r\n          margin: 20px 0;\r\n          text-shadow: 2px 2px 4px rgba(0,0,0,0.3);\r\n        }\r\n        .info-grid {\r\n          display: grid;\r\n          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\r\n          gap: 15px;\r\n          margin: 30px 0;\r\n        }\r\n        .info-card { \r\n          padding: 15px; \r\n          background: rgba(255,255,255,0.2); \r\n          border-radius: 10px;\r\n          border: 1px solid rgba(255,255,255,0.3);\r\n        }\r\n        .endpoint-list {\r\n          display: grid;\r\n          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\r\n          gap: 10px;\r\n          margin: 20px 0;\r\n        }\r\n        .endpoint { \r\n          padding: 12px; \r\n          background: rgba(255,255,255,0.15); \r\n          border-radius: 8px;\r\n          font-family: 'Courier New', monospace;\r\n          font-size: 0.9em;\r\n        }\r\n        .status-indicator {\r\n          display: inline-block;\r\n          width: 12px;\r\n          height: 12px;\r\n          border-radius: 50%;\r\n          background: #4CAF50;\r\n          margin-right: 8px;\r\n          animation: pulse 2s infinite;\r\n        }\r\n        @keyframes pulse {\r\n          0% { opacity: 1; }\r\n          50% { opacity: 0.5; }\r\n          100% { opacity: 1; }\r\n        }\r\n        .footer {\r\n          margin-top: 40px;\r\n          font-size: 0.9em;\r\n          opacity: 0.8;\r\n          border-top: 1px solid rgba(255,255,255,0.2);\r\n          padding-top: 20px;\r\n        }\r\n        .btn {\r\n          display: inline-block;\r\n          padding: 12px 24px;\r\n          margin: 10px;\r\n          background: rgba(255,255,255,0.2);\r\n          border: 1px solid rgba(255,255,255,0.3);\r\n          border-radius: 8px;\r\n          color: white;\r\n          text-decoration: none;\r\n          transition: all 0.3s ease;\r\n        }\r\n        .btn:hover {\r\n          background: rgba(255,255,255,0.3);\r\n          transform: translateY(-2px);\r\n        }\r\n      </style>\r\n    </head>\r\n    <body>\r\n      <div class=\"container\">\r\n        <h1>üéâ VHM24 Railway Production</h1>\r\n        <div class=\"success\">\r\n          <span class=\"status-indicator\"></span>\r\n          –£–°–ü–ï–®–ù–û –†–ê–ó–í–ï–†–ù–£–¢–û!\r\n        </div>\r\n        \r\n        <div class=\"info-grid\">\r\n          <div class=\"info-card\">\r\n            <strong>üåç Environment</strong><br>\r\n            ${process.env.NODE_ENV || 'production'}\r\n          </div>\r\n          <div class=\"info-card\">\r\n            <strong>üîå Port</strong><br>\r\n            ${PORT}\r\n          </div>\r\n          <div class=\"info-card\">\r\n            <strong>üöÇ Railway URL</strong><br>\r\n            ${process.env.RAILWAY_STATIC_URL || 'N/A'}\r\n          </div>\r\n          <div class=\"info-card\">\r\n            <strong>‚è∞ Deployed</strong><br>\r\n            ${new Date().toLocaleString('ru-RU')}\r\n          </div>\r\n        </div>\r\n        \r\n        <h2>üîó –î–æ—Å—Ç—É–ø–Ω—ã–µ API endpoints:</h2>\r\n        <div class=\"endpoint-list\">\r\n          <div class=\"endpoint\">GET /health</div>\r\n          <div class=\"endpoint\">GET /</div>\r\n          <div class=\"endpoint\">GET /docs</div>\r\n          <div class=\"endpoint\">GET /api/status</div>\r\n        </div>\r\n        \r\n        <div style=\"margin: 30px 0;\">\r\n          <a href=\"/health\" class=\"btn\">üè• Health Check</a>\r\n          <a href=\"/docs\" class=\"btn\">üìö Documentation</a>\r\n          <a href=\"/api/status\" class=\"btn\">üìä System Status</a>\r\n        </div>\r\n        \r\n        <h2>üéØ –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã:</h2>\r\n        <div class=\"info-grid\">\r\n          <div class=\"info-card\">\r\n            <strong>‚úÖ –°–µ—Ä–≤–µ—Ä</strong><br>\r\n            –ó–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç\r\n          </div>\r\n          <div class=\"info-card\">\r\n            <strong>üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</strong><br>\r\n            ${process.env.DATABASE_URL ? '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∞' : '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞'}\r\n          </div>\r\n          <div class=\"info-card\">\r\n            <strong>üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</strong><br>\r\n            ${process.env.JWT_SECRET ? '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∞' : '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞'}\r\n          </div>\r\n          <div class=\"info-card\">\r\n            <strong>ü§ñ Telegram Bot</strong><br>\r\n            ${process.env.TELEGRAM_BOT_TOKEN ? '–ù–∞—Å—Ç—Ä–æ–µ–Ω' : '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}\r\n          </div>\r\n        </div>\r\n        \r\n        <div class=\"footer\">\r\n          <strong>VHM24 - VendHub Manager 24/7</strong><br>\r\n          Railway Production Deployment - Version 1.0.0<br>\r\n          Uptime: ${Math.floor(process.uptime())} seconds\r\n        </div>\r\n      </div>\r\n    </body>\r\n    </html>\r\n  `;\r\n});\r\n\r\n// API Documentation endpoint\r\nfastify.get('/docs', async (request, reply) => {\r\n  reply.type('text/html');\r\n  return `\r\n    <!DOCTYPE html>\r\n    <html lang=\"ru\">\r\n    <head>\r\n      <meta charset=\"UTF-8\">\r\n      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n      <title>VHM24 API Documentation</title>\r\n      <style>\r\n        body { \r\n          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\r\n          margin: 40px; \r\n          background: #f5f5f5;\r\n          color: #333;\r\n        }\r\n        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }\r\n        .endpoint { \r\n          margin: 20px 0; \r\n          padding: 20px; \r\n          border: 1px solid #ddd; \r\n          border-radius: 8px;\r\n          background: #fafafa;\r\n        }\r\n        .method { \r\n          font-weight: bold; \r\n          color: #007bff; \r\n          font-family: 'Courier New', monospace;\r\n          background: #e3f2fd;\r\n          padding: 4px 8px;\r\n          border-radius: 4px;\r\n          display: inline-block;\r\n          margin-bottom: 10px;\r\n        }\r\n        .description { margin: 10px 0; }\r\n        .response { \r\n          background: #f8f9fa; \r\n          padding: 15px; \r\n          border-radius: 5px; \r\n          font-family: 'Courier New', monospace;\r\n          font-size: 0.9em;\r\n          margin-top: 10px;\r\n        }\r\n        h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }\r\n        h2 { color: #34495e; margin-top: 30px; }\r\n        .status { color: #27ae60; font-weight: bold; }\r\n      </style>\r\n    </head>\r\n    <body>\r\n      <div class=\"container\">\r\n        <h1>ü§ñ VHM24 API Documentation</h1>\r\n        <p><strong>VendHub Manager 24/7 - Railway Production API</strong></p>\r\n        \r\n        <h2>üìã –û—Å–Ω–æ–≤–Ω—ã–µ endpoints</h2>\r\n        \r\n        <div class=\"endpoint\">\r\n          <div class=\"method\">GET /</div>\r\n          <div class=\"description\">–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏</div>\r\n          <div class=\"response\">–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: HTML —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π</div>\r\n        </div>\r\n        \r\n        <div class=\"endpoint\">\r\n          <div class=\"method\">GET /health</div>\r\n          <div class=\"description\">Health check endpoint –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞</div>\r\n          <div class=\"response\">\r\n–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: JSON –æ–±—ä–µ–∫—Ç<br>\r\n{<br>\r\n&nbsp;&nbsp;\"status\": \"ok\",<br>\r\n&nbsp;&nbsp;\"service\": \"vhm24-production\",<br>\r\n&nbsp;&nbsp;\"timestamp\": \"2025-07-10T02:10:00.000Z\",<br>\r\n&nbsp;&nbsp;\"environment\": \"production\",<br>\r\n&nbsp;&nbsp;\"port\": 8000,<br>\r\n&nbsp;&nbsp;\"uptime\": 123.45,<br>\r\n&nbsp;&nbsp;\"memory\": {...},<br>\r\n&nbsp;&nbsp;\"database\": \"connected\"<br>\r\n}\r\n          </div>\r\n        </div>\r\n        \r\n        <div class=\"endpoint\">\r\n          <div class=\"method\">GET /docs</div>\r\n          <div class=\"description\">–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ API</div>\r\n          <div class=\"response\">–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: HTML —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π</div>\r\n        </div>\r\n        \r\n        <div class=\"endpoint\">\r\n          <div class=\"method\">GET /api/status</div>\r\n          <div class=\"description\">–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ —Å–∏—Å—Ç–µ–º—ã</div>\r\n          <div class=\"response\">–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: JSON —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–∏—Å—Ç–µ–º–µ</div>\r\n        </div>\r\n        \r\n        <h2>üìä –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>\r\n        <div class=\"endpoint\">\r\n          <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span class=\"status\">Railway production deployment —É—Å–ø–µ—à–µ–Ω</span></p>\r\n          <p><strong>Environment:</strong> ${process.env.NODE_ENV || 'production'}</p>\r\n          <p><strong>Version:</strong> 1.0.0</p>\r\n          <p><strong>Port:</strong> ${PORT}</p>\r\n          <p><strong>Uptime:</strong> ${Math.floor(process.uptime())} —Å–µ–∫—É–Ω–¥</p>\r\n        </div>\r\n        \r\n        <h2>üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</h2>\r\n        <div class=\"endpoint\">\r\n          <p><strong>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:</strong> ${process.env.DATABASE_URL ? '‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞' : '‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞'}</p>\r\n          <p><strong>JWT Secret:</strong> ${process.env.JWT_SECRET ? '‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω' : '‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}</p>\r\n          <p><strong>Telegram Bot:</strong> ${process.env.TELEGRAM_BOT_TOKEN ? '‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω' : '‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}</p>\r\n          <p><strong>Redis:</strong> ${process.env.REDIS_URL ? '‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω' : '‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}</p>\r\n        </div>\r\n        \r\n        <div style=\"margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666;\">\r\n          <p>VHM24 - VendHub Manager 24/7 | Railway Production API</p>\r\n        </div>\r\n      </div>\r\n    </body>\r\n    </html>\r\n  `;\r\n});\r\n\r\n// System status API endpoint\r\nfastify.get('/api/status', async (request, reply) => {\r\n  const status = {\r\n    service: 'vhm24-production',\r\n    status: 'running',\r\n    timestamp: new Date().toISOString(),\r\n    environment: process.env.NODE_ENV || 'production',\r\n    port: PORT,\r\n    uptime: process.uptime(),\r\n    memory: process.memoryUsage(),\r\n    version: '1.0.0',\r\n    railway: {\r\n      environment: process.env.RAILWAY_ENVIRONMENT || null,\r\n      static_url: process.env.RAILWAY_STATIC_URL || null,\r\n      deployment_id: process.env.RAILWAY_DEPLOYMENT_ID || null\r\n    },\r\n    configuration: {\r\n      database: !!process.env.DATABASE_URL,\r\n      jwt_secret: !!process.env.JWT_SECRET,\r\n      telegram_bot: !!process.env.TELEGRAM_BOT_TOKEN,\r\n      redis: !!process.env.REDIS_URL,\r\n      admin_ids: !!process.env.ADMIN_IDS\r\n    }\r\n  };\r\n\r\n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö\r\n  if (process.env.DATABASE_URL) {\r\n    try {\r\n      const { PrismaClient } = require('@prisma/client');\r\n      const prisma = new PrismaClient();\r\n      await prisma.$queryRaw`SELECT 1`;\r\n      await prisma.$disconnect();\r\n      status.database = { status: 'connected', error: null };\r\n    } catch (error) {\r\n      status.database = { status: 'error', error: error.message };\r\n    }\r\n  } else {\r\n    status.database = { status: 'not_configured', error: null };\r\n  }\r\n\r\n  return status;\r\n});\r\n\r\n// 404 handler\r\nfastify.setNotFoundHandler(async (request, reply) => {\r\n  reply.code(404).type('application/json');\r\n  return {\r\n    error: 'Not Found',\r\n    message: `Route ${request.method}:${request.url} not found`,\r\n    statusCode: 404,\r\n    timestamp: new Date().toISOString()\r\n  };\r\n});\r\n\r\n// Error handler\r\nfastify.setErrorHandler(async (error, request, reply) => {\r\n  fastify.log.error(error);\r\n  reply.code(500).type('application/json');\r\n  return {\r\n    error: 'Internal Server Error',\r\n    message: error.message,\r\n    statusCode: 500,\r\n    timestamp: new Date().toISOString()\r\n  };\r\n});\r\n\r\n// –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä\r\nconst start = async () => {\r\n  try {\r\n    await fastify.listen({ \r\n      port: PORT,\r\n      host: '0.0.0.0'\r\n    });\r\n    \r\n    console.log(`üéâ VHM24 Production is running on port ${PORT}`);\r\n    console.log(`üåê Health check: http://localhost:${PORT}/health`);\r\n    console.log(`üìö Documentation: http://localhost:${PORT}/docs`);\r\n    console.log(`üìä System status: http://localhost:${PORT}/api/status`);\r\n    \r\n    // Railway specific logging\r\n    if (process.env.RAILWAY_ENVIRONMENT) {\r\n      console.log('üöÇ Running on Railway environment:', process.env.RAILWAY_ENVIRONMENT);\r\n      console.log('üîó Railway static URL:', process.env.RAILWAY_STATIC_URL);\r\n      console.log('üÜî Deployment ID:', process.env.RAILWAY_DEPLOYMENT_ID);\r\n    }\r\n    \r\n  } catch (err) {\r\n    console.error('‚ùå Server failed to start:', err);\r\n    process.exit(1);\r\n  }\r\n};\r\n\r\n// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è graceful shutdown\r\nprocess.on('SIGTERM', async () => {\r\n  console.log('üõë Received SIGTERM, shutting down gracefully...');\r\n  try {\r\n    await fastify.close();\r\n    console.log('‚úÖ Server closed successfully');\r\n    process.exit(0);\r\n  } catch (error) {\r\n    console.error('‚ùå Error during shutdown:', error);\r\n    process.exit(1);\r\n  }\r\n});\r\n\r\nprocess.on('SIGINT', async () => {\r\n  console.log('üõë Received SIGINT, shutting down gracefully...');\r\n  try {\r\n    await fastify.close();\r\n    console.log('‚úÖ Server closed successfully');\r\n    process.exit(0);\r\n  } catch (error) {\r\n    console.error('‚ùå Error during shutdown:', error);\r\n    process.exit(1);\r\n  }\r\n});\r\n\r\n// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫\r\nprocess.on('uncaughtException', (error) => {\r\n  console.error('‚ùå Uncaught Exception:', error);\r\n  process.exit(1);\r\n});\r\n\r\nprocess.on('unhandledRejection', (reason, promise) => {\r\n  console.error('‚ùå Unhandled Rejection at:', promise, 'reason:', reason);\r\n  process.exit(1);\r\n});\r\n\r\n// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\r\nstart();\r\n",
  "scripts/check-railway-dependencies.js": "#!/usr/bin/env node\r\n\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\nconsole.log('üîç Checking Railway deployment compatibility...\\n');\r\n\r\n// –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è\r\nconst knownIssues = {\r\n  'xlsx': {\r\n    problematic: ['^0.20.0', '^0.19.0'],\r\n    recommended: '^0.18.5',\r\n    reason: 'Version 0.20.0+ not available in npm registry'\r\n  },\r\n  'fastify': {\r\n    problematic: ['^5.0.0', '^5.4.0'],\r\n    recommended: '^4.24.3',\r\n    reason: 'Plugin compatibility issues with v5'\r\n  },\r\n  '@fastify/cors': {\r\n    problematic: ['^11.0.0'],\r\n    recommended: '^8.4.0',\r\n    reason: 'Requires fastify v4 compatibility'\r\n  },\r\n  '@fastify/helmet': {\r\n    problematic: ['^13.0.0'],\r\n    recommended: '^11.1.1',\r\n    reason: 'Requires fastify v4 compatibility'\r\n  },\r\n  '@fastify/jwt': {\r\n    problematic: ['^9.0.0'],\r\n    recommended: '^7.2.4',\r\n    reason: 'Requires fastify v4 compatibility'\r\n  },\r\n  '@fastify/rate-limit': {\r\n    problematic: ['^10.0.0'],\r\n    recommended: '^9.0.1',\r\n    reason: 'Requires fastify v4 compatibility'\r\n  },\r\n  'next': {\r\n    problematic: ['*'],\r\n    recommended: 'remove',\r\n    reason: 'Not needed in backend services',\r\n    allowedIn: ['apps/web-dashboard']\r\n  }\r\n};\r\n\r\n// –ù–µ–Ω—É–∂–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è backend —Å–µ—Ä–≤–∏—Å–æ–≤\r\nconst backendUnnecessary = ['next', 'react', 'react-dom', '@types/react'];\r\n\r\nlet issuesFound = 0;\r\nlet servicesChecked = 0;\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–µ—Ä—Å–∏–∏\r\nfunction isProblematicVersion(packageName, version, issues) {\r\n  if (!issues[packageName]) return false;\r\n  \r\n  const problematic = issues[packageName].problematic;\r\n  return problematic.some(prob => {\r\n    if (prob === '*') return true;\r\n    if (prob === version) return true;\r\n    if (prob.startsWith('^') && version.startsWith('^')) {\r\n      return prob === version;\r\n    }\r\n    return false;\r\n  });\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ package.json\r\nfunction checkPackageJson(filePath, serviceName = 'root') {\r\n  if (!fs.existsSync(filePath)) return;\r\n  \r\n  try {\r\n    const packageJson = JSON.parse(fs.readFileSync(filePath, 'utf8'));\r\n    const dependencies = { ...packageJson.dependencies, ...packageJson.devDependencies };\r\n    \r\n    console.log(`üì¶ Checking ${serviceName}...`);\r\n    servicesChecked++;\r\n    \r\n    let serviceIssues = 0;\r\n    \r\n    Object.entries(dependencies).forEach(([name, version]) => {\r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –≤–µ—Ä—Å–∏–π\r\n      if (isProblematicVersion(name, version, knownIssues)) {\r\n        const issue = knownIssues[name];\r\n        \r\n        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π\r\n        if (issue.allowedIn && issue.allowedIn.some(allowed => filePath.replace(/\\\\/g, '/').includes(allowed))) {\r\n          return; // –†–∞–∑—Ä–µ—à–µ–Ω–æ –≤ —ç—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ\r\n        }\r\n        \r\n        console.log(`  ‚ùå ${name}: ${version}`);\r\n        console.log(`     Issue: ${issue.reason}`);\r\n        console.log(`     Fix: Use ${issue.recommended}`);\r\n        issuesFound++;\r\n        serviceIssues++;\r\n      }\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–Ω—É–∂–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ backend —Å–µ—Ä–≤–∏—Å–∞—Ö\r\n      if (serviceName.includes('services/') && backendUnnecessary.includes(name)) {\r\n        console.log(`  ‚ö†Ô∏è  ${name}: ${version}`);\r\n        console.log(`     Warning: Unnecessary for backend service`);\r\n        console.log(`     Fix: Remove this dependency`);\r\n        issuesFound++;\r\n        serviceIssues++;\r\n      }\r\n    });\r\n    \r\n    if (serviceIssues === 0) {\r\n      console.log(`  ‚úÖ No issues found`);\r\n    }\r\n    \r\n    console.log('');\r\n    \r\n  } catch (error) {\r\n    console.log(`  ‚ùå Error reading ${filePath}: ${error.message}\\n`);\r\n  }\r\n}\r\n\r\n// –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ package.json\r\ncheckPackageJson('./package.json', 'root');\r\n\r\n// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤\r\nconst servicesDir = './services';\r\nif (fs.existsSync(servicesDir)) {\r\n  const services = fs.readdirSync(servicesDir);\r\n  \r\n  services.forEach(service => {\r\n    const servicePath = path.join(servicesDir, service);\r\n    const packagePath = path.join(servicePath, 'package.json');\r\n    \r\n    if (fs.statSync(servicePath).isDirectory()) {\r\n      checkPackageJson(packagePath, `services/${service}`);\r\n    }\r\n  });\r\n}\r\n\r\n// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π\r\nconst appsDir = './apps';\r\nif (fs.existsSync(appsDir)) {\r\n  const apps = fs.readdirSync(appsDir);\r\n  \r\n  apps.forEach(app => {\r\n    const appPath = path.join(appsDir, app);\r\n    const packagePath = path.join(appPath, 'package.json');\r\n    \r\n    if (fs.statSync(appPath).isDirectory()) {\r\n      checkPackageJson(packagePath, `apps/${app}`);\r\n    }\r\n  });\r\n}\r\n\r\n// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–∫–µ—Ç–æ–≤\r\nconst packagesDir = './packages';\r\nif (fs.existsSync(packagesDir)) {\r\n  const packages = fs.readdirSync(packagesDir);\r\n  \r\n  packages.forEach(pkg => {\r\n    const pkgPath = path.join(packagesDir, pkg);\r\n    const packagePath = path.join(pkgPath, 'package.json');\r\n    \r\n    if (fs.statSync(pkgPath).isDirectory()) {\r\n      checkPackageJson(packagePath, `packages/${pkg}`);\r\n    }\r\n  });\r\n}\r\n\r\n// –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç\r\nconsole.log('=' .repeat(50));\r\nconsole.log(`üìä SUMMARY:`);\r\nconsole.log(`   Services checked: ${servicesChecked}`);\r\nconsole.log(`   Issues found: ${issuesFound}`);\r\n\r\nif (issuesFound === 0) {\r\n  console.log(`   ‚úÖ All dependencies are Railway compatible!`);\r\n  process.exit(0);\r\n} else {\r\n  console.log(`   ‚ùå Found ${issuesFound} compatibility issues`);\r\n  console.log(`   üîß Please fix the issues above before deploying to Railway`);\r\n  process.exit(1);\r\n}\r\n",
  "scripts/fix-railway-dependencies.js": "#!/usr/bin/env node\r\n\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\nconsole.log('üîß Fixing Railway deployment compatibility issues...\\n');\r\n\r\n// –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π\r\nconst fixes = {\r\n  'fastify': '^4.24.3',\r\n  '@fastify/cors': '^8.4.0',\r\n  '@fastify/helmet': '^11.1.1',\r\n  '@fastify/jwt': '^7.2.4',\r\n  '@fastify/rate-limit': '^9.0.1',\r\n  'xlsx': '^0.18.5'\r\n};\r\n\r\n// –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ backend —Å–µ—Ä–≤–∏—Å–æ–≤\r\nconst removeFromBackend = ['next'];\r\n\r\n// –ò—Å–∫–ª—é—á–µ–Ω–∏—è - –≥–¥–µ next —Ä–∞–∑—Ä–µ—à–µ–Ω\r\nconst allowNext = ['apps/web-dashboard'];\r\n\r\nlet filesFixed = 0;\r\nlet issuesFixed = 0;\r\n\r\nfunction fixPackageJson(filePath, serviceName = 'root') {\r\n  if (!fs.existsSync(filePath)) return;\r\n  \r\n  try {\r\n    const packageJson = JSON.parse(fs.readFileSync(filePath, 'utf8'));\r\n    let modified = false;\r\n    \r\n    console.log(`üì¶ Fixing ${serviceName}...`);\r\n    \r\n    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ dependencies\r\n    if (packageJson.dependencies) {\r\n      Object.keys(packageJson.dependencies).forEach(name => {\r\n        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π\r\n        if (fixes[name] && packageJson.dependencies[name] !== fixes[name]) {\r\n          console.log(`  üîß ${name}: ${packageJson.dependencies[name]} ‚Üí ${fixes[name]}`);\r\n          packageJson.dependencies[name] = fixes[name];\r\n          modified = true;\r\n          issuesFixed++;\r\n        }\r\n        \r\n        // –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–Ω—É–∂–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏–∑ backend —Å–µ—Ä–≤–∏—Å–æ–≤\r\n        if (removeFromBackend.includes(name) && serviceName.includes('services/')) {\r\n          console.log(`  üóëÔ∏è  Removing ${name} from backend service`);\r\n          delete packageJson.dependencies[name];\r\n          modified = true;\r\n          issuesFixed++;\r\n        }\r\n      });\r\n    }\r\n    \r\n    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ devDependencies\r\n    if (packageJson.devDependencies) {\r\n      Object.keys(packageJson.devDependencies).forEach(name => {\r\n        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π\r\n        if (fixes[name] && packageJson.devDependencies[name] !== fixes[name]) {\r\n          console.log(`  üîß ${name}: ${packageJson.devDependencies[name]} ‚Üí ${fixes[name]}`);\r\n          packageJson.devDependencies[name] = fixes[name];\r\n          modified = true;\r\n          issuesFixed++;\r\n        }\r\n        \r\n        // –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–Ω—É–∂–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏–∑ backend —Å–µ—Ä–≤–∏—Å–æ–≤\r\n        if (removeFromBackend.includes(name) && serviceName.includes('services/')) {\r\n          console.log(`  üóëÔ∏è  Removing ${name} from backend service`);\r\n          delete packageJson.devDependencies[name];\r\n          modified = true;\r\n          issuesFixed++;\r\n        }\r\n      });\r\n    }\r\n    \r\n    if (modified) {\r\n      fs.writeFileSync(filePath, JSON.stringify(packageJson, null, 2) + '\\n');\r\n      filesFixed++;\r\n      console.log(`  ‚úÖ Fixed and saved`);\r\n    } else {\r\n      console.log(`  ‚úÖ No issues found`);\r\n    }\r\n    \r\n    console.log('');\r\n    \r\n  } catch (error) {\r\n    console.log(`  ‚ùå Error fixing ${filePath}: ${error.message}\\n`);\r\n  }\r\n}\r\n\r\n// –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ package.json\r\nfixPackageJson('./package.json', 'root');\r\n\r\n// –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤\r\nconst servicesDir = './services';\r\nif (fs.existsSync(servicesDir)) {\r\n  const services = fs.readdirSync(servicesDir);\r\n  \r\n  services.forEach(service => {\r\n    const servicePath = path.join(servicesDir, service);\r\n    const packagePath = path.join(servicePath, 'package.json');\r\n    \r\n    if (fs.statSync(servicePath).isDirectory()) {\r\n      fixPackageJson(packagePath, `services/${service}`);\r\n    }\r\n  });\r\n}\r\n\r\n// –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π (–Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º next –≤ web-dashboard)\r\nconst appsDir = './apps';\r\nif (fs.existsSync(appsDir)) {\r\n  const apps = fs.readdirSync(appsDir);\r\n  \r\n  apps.forEach(app => {\r\n    const appPath = path.join(appsDir, app);\r\n    const packagePath = path.join(appPath, 'package.json');\r\n    \r\n    if (fs.statSync(appPath).isDirectory()) {\r\n      // –î–ª—è web-dashboard –Ω–µ —É–¥–∞–ª—è–µ–º next\r\n      if (app === 'web-dashboard') {\r\n        // –¢–æ–ª—å–∫–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –≤–µ—Ä—Å–∏–∏, –Ω–æ –Ω–µ —É–¥–∞–ª—è–µ–º next\r\n        if (fs.existsSync(packagePath)) {\r\n          try {\r\n            const packageJson = JSON.parse(fs.readFileSync(packagePath, 'utf8'));\r\n            let modified = false;\r\n            \r\n            console.log(`üì¶ Fixing apps/${app}...`);\r\n            \r\n            // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤–µ—Ä—Å–∏–∏, –Ω–µ —É–¥–∞–ª—è–µ–º next\r\n            ['dependencies', 'devDependencies'].forEach(depType => {\r\n              if (packageJson[depType]) {\r\n                Object.keys(packageJson[depType]).forEach(name => {\r\n                  if (fixes[name] && packageJson[depType][name] !== fixes[name]) {\r\n                    console.log(`  üîß ${name}: ${packageJson[depType][name]} ‚Üí ${fixes[name]}`);\r\n                    packageJson[depType][name] = fixes[name];\r\n                    modified = true;\r\n                    issuesFixed++;\r\n                  }\r\n                });\r\n              }\r\n            });\r\n            \r\n            if (modified) {\r\n              fs.writeFileSync(packagePath, JSON.stringify(packageJson, null, 2) + '\\n');\r\n              filesFixed++;\r\n              console.log(`  ‚úÖ Fixed and saved`);\r\n            } else {\r\n              console.log(`  ‚úÖ No issues found`);\r\n            }\r\n            \r\n            console.log('');\r\n            \r\n          } catch (error) {\r\n            console.log(`  ‚ùå Error fixing ${packagePath}: ${error.message}\\n`);\r\n          }\r\n        }\r\n      } else {\r\n        fixPackageJson(packagePath, `apps/${app}`);\r\n      }\r\n    }\r\n  });\r\n}\r\n\r\n// –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤\r\nconst packagesDir = './packages';\r\nif (fs.existsSync(packagesDir)) {\r\n  const packages = fs.readdirSync(packagesDir);\r\n  \r\n  packages.forEach(pkg => {\r\n    const pkgPath = path.join(packagesDir, pkg);\r\n    const packagePath = path.join(pkgPath, 'package.json');\r\n    \r\n    if (fs.statSync(pkgPath).isDirectory()) {\r\n      fixPackageJson(packagePath, `packages/${pkg}`);\r\n    }\r\n  });\r\n}\r\n\r\n// –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç\r\nconsole.log('=' .repeat(50));\r\nconsole.log(`üìä SUMMARY:`);\r\nconsole.log(`   Files fixed: ${filesFixed}`);\r\nconsole.log(`   Issues fixed: ${issuesFixed}`);\r\n\r\nif (issuesFixed > 0) {\r\n  console.log(`   ‚úÖ Fixed ${issuesFixed} compatibility issues!`);\r\n  console.log(`   üöÄ Project is now Railway deployment ready`);\r\n} else {\r\n  console.log(`   ‚úÖ No issues found - project is already Railway compatible!`);\r\n}\r\n",
  "scripts/prepare-railway.js": "const fs = require('fs');\r\nconst path = require('path');\r\n\r\nclass RailwayPreparation {\r\n  constructor() {\r\n    this.tasks = [];\r\n    this.warnings = [];\r\n  }\r\n\r\n  async prepare() {\r\n    console.log('üöÇ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –¥–µ–ø–ª–æ—é –Ω–∞ Railway...\\n');\r\n    \r\n    try {\r\n      // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ–∞–π–ª–æ–≤\r\n      this.createRailwayConfig();\r\n      \r\n      // 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ package.json\r\n      this.updatePackageJson();\r\n      \r\n      // 3. –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\n      this.prepareEnvironmentVariables();\r\n      \r\n      // 4. –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è Railway –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π\r\n      this.adaptForRailwayLimitations();\r\n      \r\n      // 5. –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ –¥–µ–ø–ª–æ—è\r\n      this.createDeploymentScripts();\r\n      \r\n      // 6. –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞\r\n      this.finalCheck();\r\n      \r\n      // 7. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π\r\n      this.generateDeploymentGuide();\r\n      \r\n    } catch (error) {\r\n      console.error('‚ùå Error during preparation:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  createRailwayConfig() {\r\n    console.log('üìù –°–æ–∑–¥–∞–Ω–∏–µ Railway –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...');\r\n    \r\n    // –û–±–Ω–æ–≤–ª—è–µ–º nixpacks.toml –¥–ª—è monorepo\r\n    const nixpacksConfig = `[phases.setup]\r\nnixPkgs = [\"nodejs-18_x\", \"npm-9_x\"]\r\n\r\n[phases.install]\r\ncmds = [\"npm install\", \"npm install --workspaces\"]\r\n\r\n[phases.build]\r\ncmds = [\"npm run build --if-present\"]\r\n\r\n[start]\r\ncmd = \"npm run start:production\"`;\r\n    \r\n    fs.writeFileSync('nixpacks.toml', nixpacksConfig);\r\n    this.tasks.push('Updated nixpacks.toml for monorepo');\r\n    \r\n    // –°–æ–∑–¥–∞–µ–º railway.toml –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤\r\n    const railwayConfig = `[build]\r\nbuilder = \"nixpacks\"\r\nbuildCommand = \"npm install && npm install --workspaces\"\r\n\r\n[deploy]\r\nstartCommand = \"npm run start:production\"\r\nhealthcheckPath = \"/health\"\r\nhealthcheckTimeout = 30\r\nrestartPolicyType = \"always\"\r\n\r\n[env]\r\nNODE_ENV = \"production\"`;\r\n    \r\n    fs.writeFileSync('railway.toml', railwayConfig);\r\n    this.tasks.push('Created railway.toml');\r\n  }\r\n\r\n  updatePackageJson() {\r\n    console.log('üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ package.json...');\r\n    \r\n    const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));\r\n    \r\n    // –î–æ–±–∞–≤–ª—è–µ–º production —Å–∫—Ä–∏–ø—Ç—ã\r\n    pkg.scripts = pkg.scripts || {};\r\n    pkg.scripts['start:production'] = 'node scripts/start-production.js';\r\n    pkg.scripts['build'] = 'npm install --workspaces && npm run build --workspaces --if-present';\r\n    pkg.scripts['railway:deploy'] = 'npm run build && npm run start:production';\r\n    \r\n    // –£–±–µ–¥–∏–º—Å—è —á—Ç–æ –µ—Å—Ç—å engines\r\n    pkg.engines = pkg.engines || {};\r\n    pkg.engines.node = '>=18.0.0';\r\n    pkg.engines.npm = '>=9.0.0';\r\n    \r\n    // –î–æ–±–∞–≤–ª—è–µ–º workspaces –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç\r\n    if (!pkg.workspaces) {\r\n      pkg.workspaces = [\r\n        \"packages/*\",\r\n        \"services/*\",\r\n        \"apps/*\"\r\n      ];\r\n    }\r\n    \r\n    fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));\r\n    this.tasks.push('Updated root package.json');\r\n  }\r\n\r\n  prepareEnvironmentVariables() {\r\n    console.log('üîê –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è...');\r\n    \r\n    const envExample = `# Railway Environment Variables for VHM24\r\n\r\n# ===== –û–°–ù–û–í–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò =====\r\nNODE_ENV=production\r\nPORT=8000\r\n\r\n# ===== –ë–ê–ó–ê –î–ê–ù–ù–´–• =====\r\n# Railway PostgreSQL (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è Railway)\r\nDATABASE_URL=postgresql://user:password@host:port/database\r\n\r\n# ===== REDIS =====\r\n# Railway Redis (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è Railway)\r\nREDIS_URL=redis://default:password@host:port\r\n\r\n# ===== –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ =====\r\nJWT_SECRET=your-super-secret-jwt-key-min-32-chars-long\r\nJWT_EXPIRES_IN=7d\r\n\r\n# ===== –í–ù–£–¢–†–ï–ù–ù–ò–ï URL –°–ï–†–í–ò–°–û–í =====\r\n# Railway –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å–µ—Ç—å (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à–∏ Railway URLs)\r\nGATEWAY_URL=https://gateway-production.up.railway.app\r\nAUTH_SERVICE_URL=https://auth-production.up.railway.app\r\nMACHINES_SERVICE_URL=https://machines-production.up.railway.app\r\nINVENTORY_SERVICE_URL=https://inventory-production.up.railway.app\r\nTASKS_SERVICE_URL=https://tasks-production.up.railway.app\r\nNOTIFICATIONS_SERVICE_URL=https://notifications-production.up.railway.app\r\nTELEGRAM_BOT_SERVICE_URL=https://telegram-bot-production.up.railway.app\r\n\r\n# ===== –í–ù–ï–®–ù–ò–ï –°–ï–†–í–ò–°–´ =====\r\n# Telegram Bot\r\nTELEGRAM_BOT_TOKEN=your-bot-token-from-botfather\r\n\r\n# S3 Storage (AWS, DigitalOcean Spaces, –∏–ª–∏ –¥—Ä—É–≥–æ–π S3-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π)\r\nS3_BUCKET=your-s3-bucket-name\r\nS3_ACCESS_KEY=your-s3-access-key\r\nS3_SECRET_KEY=your-s3-secret-key\r\nS3_ENDPOINT=https://s3.amazonaws.com\r\nS3_REGION=us-east-1\r\n\r\n# ===== –ú–û–ù–ò–¢–û–†–ò–ù–ì –ò –õ–û–ì–ò =====\r\nLOG_LEVEL=info\r\nSENTRY_DSN=your-sentry-dsn-for-error-tracking\r\n\r\n# ===== CORS –ò –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ =====\r\nALLOWED_ORIGINS=https://your-frontend.railway.app,https://your-dashboard.railway.app\r\nCORS_CREDENTIALS=true\r\n\r\n# ===== –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò =====\r\n# –¢–∞–π–º–∞—É—Ç—ã\r\nREQUEST_TIMEOUT=30000\r\nDB_CONNECTION_TIMEOUT=10000\r\n\r\n# –õ–∏–º–∏—Ç—ã\r\nMAX_FILE_SIZE=10485760\r\nMAX_REQUEST_SIZE=52428800\r\n\r\n# –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ\r\nCACHE_TTL=3600`;\r\n    \r\n    fs.writeFileSync('.env.railway.example', envExample);\r\n    this.tasks.push('Created .env.railway.example');\r\n    \r\n    // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\r\n    const envChecker = `const required = [\r\n  'DATABASE_URL',\r\n  'REDIS_URL',\r\n  'JWT_SECRET',\r\n  'TELEGRAM_BOT_TOKEN'\r\n];\r\n\r\nconst optional = [\r\n  'S3_BUCKET',\r\n  'S3_ACCESS_KEY',\r\n  'S3_SECRET_KEY',\r\n  'SENTRY_DSN'\r\n];\r\n\r\nconsole.log('üîç Checking environment variables...');\r\n\r\nconst missing = required.filter(key => !process.env[key]);\r\nconst missingOptional = optional.filter(key => !process.env[key]);\r\n\r\nif (missing.length > 0) {\r\n  console.error('‚ùå Missing required environment variables:');\r\n  missing.forEach(key => console.error(\\`  - \\${key}\\`));\r\n  process.exit(1);\r\n}\r\n\r\nif (missingOptional.length > 0) {\r\n  console.warn('‚ö†Ô∏è Missing optional environment variables:');\r\n  missingOptional.forEach(key => console.warn(\\`  - \\${key}\\`));\r\n}\r\n\r\n// –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT —Å–µ–∫—Ä–µ—Ç–∞\r\nif (process.env.JWT_SECRET && process.env.JWT_SECRET.length < 32) {\r\n  console.error('‚ùå JWT_SECRET must be at least 32 characters long');\r\n  process.exit(1);\r\n}\r\n\r\n// –ü—Ä–æ–≤–µ—Ä–∫–∞ S3 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏\r\nif (process.env.S3_BUCKET && (!process.env.S3_ACCESS_KEY || !process.env.S3_SECRET_KEY)) {\r\n  console.error('‚ùå S3_BUCKET requires S3_ACCESS_KEY and S3_SECRET_KEY');\r\n  process.exit(1);\r\n}\r\n\r\nconsole.log('‚úÖ All required environment variables are set');\r\nconsole.log(\\`üìä \\${required.length - missing.length}/\\${required.length} required variables configured\\`);\r\nconsole.log(\\`üìä \\${optional.length - missingOptional.length}/\\${optional.length} optional variables configured\\`);`;\r\n    \r\n    fs.writeFileSync('scripts/check-env.js', envChecker);\r\n    this.tasks.push('Created environment checker script');\r\n  }\r\n\r\n  adaptForRailwayLimitations() {\r\n    console.log('üîß –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è Railway...');\r\n    \r\n    // Railway –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ\r\n    this.warnings.push('MinIO –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ –≤–Ω–µ—à–Ω–∏–π S3 - –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ S3_BUCKET, S3_ACCESS_KEY, S3_SECRET_KEY');\r\n    \r\n    // Railway –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø—É–±–ª–∏—á–Ω—ã–π –ø–æ—Ä—Ç –Ω–∞ —Å–µ—Ä–≤–∏—Å\r\n    this.warnings.push('–ö–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –±—É–¥–µ—Ç –∏–º–µ—Ç—å —Å–≤–æ–π Railway URL, –æ–±–Ω–æ–≤–∏—Ç–µ CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏');\r\n    \r\n    // –°–æ–∑–¥–∞–µ–º middleware –¥–ª—è Railway —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫\r\n    const railwayMiddleware = `// Railway-specific middleware\r\nconst railwayMiddleware = (fastify, options, done) => {\r\n  // –î–æ–±–∞–≤–ª—è–µ–º Railway health check headers\r\n  fastify.addHook('onRequest', async (request, reply) => {\r\n    if (request.url === '/health') {\r\n      reply.header('X-Railway-Health', 'ok');\r\n    }\r\n  });\r\n  \r\n  // –û–±—Ä–∞–±–æ—Ç–∫–∞ Railway –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤\r\n  fastify.addHook('preHandler', async (request, reply) => {\r\n    // –î–æ–±–∞–≤–ª—è–µ–º Railway request ID –µ—Å–ª–∏ –µ—Å—Ç—å\r\n    if (request.headers['x-railway-request-id']) {\r\n      request.railwayRequestId = request.headers['x-railway-request-id'];\r\n    }\r\n  });\r\n  \r\n  // Graceful shutdown –¥–ª—è Railway\r\n  const gracefulShutdown = () => {\r\n    console.log('üõë Received shutdown signal, closing server gracefully...');\r\n    fastify.close(() => {\r\n      console.log('‚úÖ Server closed successfully');\r\n      process.exit(0);\r\n    });\r\n  };\r\n  \r\n  process.on('SIGTERM', gracefulShutdown);\r\n  process.on('SIGINT', gracefulShutdown);\r\n  \r\n  done();\r\n};\r\n\r\nmodule.exports = railwayMiddleware;`;\r\n    \r\n    const middlewareDir = 'packages/shared/middleware';\r\n    if (!fs.existsSync(middlewareDir)) {\r\n      fs.mkdirSync(middlewareDir, { recursive: true });\r\n    }\r\n    \r\n    fs.writeFileSync(path.join(middlewareDir, 'railway.js'), railwayMiddleware);\r\n    this.tasks.push('Created Railway-specific middleware');\r\n    \r\n    // –û–±–Ω–æ–≤–ª—è–µ–º .railwayignore\r\n    const railwayIgnore = `# Development files\r\n*.log\r\n*.backup.*\r\nnode_modules/\r\n.env\r\n.env.local\r\n.env.development\r\n\r\n# Test files\r\ncoverage/\r\n*.test.js\r\n__tests__/\r\n\r\n# Build artifacts\r\ndist/\r\nbuild/\r\n\r\n# IDE files\r\n.vscode/\r\n.idea/\r\n*.swp\r\n*.swo\r\n\r\n# OS files\r\n.DS_Store\r\nThumbs.db\r\n\r\n# Temporary files\r\ntmp/\r\ntemp/\r\n*.tmp\r\n\r\n# Documentation (optional)\r\ndocs/\r\n*.md\r\n!README.md\r\n\r\n# Scripts not needed in production\r\nscripts/test-*\r\nscripts/dev-*\r\nscripts/local-*`;\r\n    \r\n    fs.writeFileSync('.railwayignore', railwayIgnore);\r\n    this.tasks.push('Updated .railwayignore');\r\n  }\r\n\r\n  createDeploymentScripts() {\r\n    console.log('üìú –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ –¥–µ–ø–ª–æ—è...');\r\n    \r\n    // –°–∫—Ä–∏–ø—Ç –¥–ª—è production –∑–∞–ø—É—Å–∫–∞\r\n    const productionStarter = `// Production starter for Railway deployment\r\nconst { spawn } = require('child_process');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\nconsole.log('üöÄ Starting VHM24 in production mode on Railway...');\r\n\r\n// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\ntry {\r\n  require('./check-env');\r\n} catch (error) {\r\n  console.error('‚ùå Environment check failed:', error.message);\r\n  process.exit(1);\r\n}\r\n\r\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–æ–π —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ Railway –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\r\nconst SERVICE = process.env.RAILWAY_SERVICE_NAME || \r\n               process.env.SERVICE_NAME || \r\n               detectServiceFromPath() ||\r\n               'gateway';\r\n\r\nconsole.log(\\`üéØ Detected service: \\${SERVICE}\\`);\r\n\r\nconst serviceMap = {\r\n  'gateway': { path: 'services/gateway', port: 8000, public: true },\r\n  'auth': { path: 'services/auth', port: 3001, public: false },\r\n  'machines': { path: 'services/machines', port: 3002, public: false },\r\n  'inventory': { path: 'services/inventory', port: 3003, public: false },\r\n  'tasks': { path: 'services/tasks', port: 3004, public: false },\r\n  'telegram-bot': { path: 'services/telegram-bot', port: 3005, public: false },\r\n  'notifications': { path: 'services/notifications', port: 3006, public: false },\r\n  'audit': { path: 'services/audit', port: 3007, public: false },\r\n  'data-import': { path: 'services/data-import', port: 3008, public: false },\r\n  'backup': { path: 'services/backup', port: 3009, public: false },\r\n  'monitoring': { path: 'services/monitoring', port: 3010, public: false },\r\n  'routes': { path: 'services/routes', port: 3011, public: false },\r\n  'warehouse': { path: 'services/warehouse', port: 3012, public: false },\r\n  'recipes': { path: 'services/recipes', port: 3013, public: false },\r\n  'bunkers': { path: 'services/bunkers', port: 3014, public: false }\r\n};\r\n\r\nconst service = serviceMap[SERVICE];\r\n\r\nif (!service) {\r\n  console.error(\\`‚ùå Unknown service: \\${SERVICE}\\`);\r\n  console.log('Available services:', Object.keys(serviceMap).join(', '));\r\n  process.exit(1);\r\n}\r\n\r\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞\r\nif (!fs.existsSync(service.path)) {\r\n  console.error(\\`‚ùå Service path not found: \\${service.path}\\`);\r\n  process.exit(1);\r\n}\r\n\r\n// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PORT –¥–ª—è Railway\r\nprocess.env.PORT = process.env.PORT || service.port.toString();\r\n\r\nconsole.log(\\`üöÄ Starting \\${SERVICE} service...\\`);\r\nconsole.log(\\`üìÅ Path: \\${service.path}\\`);\r\nconsole.log(\\`üåê Port: \\${process.env.PORT}\\`);\r\nconsole.log(\\`üîì Public: \\${service.public ? 'Yes' : 'No'}\\`);\r\n\r\n// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞\r\nprocess.env.SERVICE_NAME = SERVICE;\r\nprocess.env.SERVICE_PATH = service.path;\r\n\r\n// –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å\r\nconst child = spawn('npm', ['start'], {\r\n  cwd: service.path,\r\n  stdio: 'inherit',\r\n  env: process.env\r\n});\r\n\r\nchild.on('error', (error) => {\r\n  console.error('‚ùå Failed to start service:', error);\r\n  process.exit(1);\r\n});\r\n\r\nchild.on('exit', (code) => {\r\n  console.log(\\`üõë Service \\${SERVICE} exited with code \\${code}\\`);\r\n  process.exit(code);\r\n});\r\n\r\n// Graceful shutdown\r\nprocess.on('SIGTERM', () => {\r\n  console.log('üõë Received SIGTERM, shutting down gracefully...');\r\n  child.kill('SIGTERM');\r\n});\r\n\r\nprocess.on('SIGINT', () => {\r\n  console.log('üõë Received SIGINT, shutting down gracefully...');\r\n  child.kill('SIGINT');\r\n});\r\n\r\nfunction detectServiceFromPath() {\r\n  // –ü—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–µ—Ä–≤–∏—Å –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø—É—Ç–∏ –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö Railway\r\n  const cwd = process.cwd();\r\n  const servicePath = cwd.split(path.sep).find(part => \r\n    Object.keys(serviceMap).includes(part)\r\n  );\r\n  \r\n  return servicePath || null;\r\n}`;\r\n    \r\n    fs.writeFileSync('scripts/start-production.js', productionStarter);\r\n    this.tasks.push('Created production starter script');\r\n  }\r\n\r\n  finalCheck() {\r\n    console.log('\\nüîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞...');\r\n    \r\n    const checklist = {\r\n      'Root package.json': fs.existsSync('package.json'),\r\n      'Start script': JSON.parse(fs.readFileSync('package.json', 'utf8')).scripts?.['start:production'],\r\n      'Node version specified': JSON.parse(fs.readFileSync('package.json', 'utf8')).engines?.node,\r\n      'Environment example': fs.existsSync('.env.railway.example'),\r\n      'Railway config': fs.existsSync('railway.toml'),\r\n      'Nixpacks config': fs.existsSync('nixpacks.toml'),\r\n      'S3 adapter': fs.existsSync('packages/shared/storage/s3.js'),\r\n      'Railway middleware': fs.existsSync('packages/shared/middleware/railway.js'),\r\n      'Environment checker': fs.existsSync('scripts/check-env.js'),\r\n      'Production starter': fs.existsSync('scripts/start-production.js')\r\n    };\r\n    \r\n    Object.entries(checklist).forEach(([item, status]) => {\r\n      console.log(`${status ? '‚úÖ' : '‚ùå'} ${item}`);\r\n    });\r\n    \r\n    const passed = Object.values(checklist).filter(Boolean).length;\r\n    const total = Object.keys(checklist).length;\r\n    \r\n    console.log(`\\nüìä Readiness: ${passed}/${total} (${Math.round(passed/total*100)}%)`);\r\n  }\r\n\r\n  generateDeploymentGuide() {\r\n    console.log('\\nüìö –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ –ø–æ –¥–µ–ø–ª–æ—é...');\r\n    \r\n    const guide = `# Railway Deployment Guide for VHM24\r\n\r\n## üéØ –û–±–∑–æ—Ä\r\n\r\nVHM24 –≥–æ—Ç–æ–≤ –∫ –¥–µ–ø–ª–æ—é –Ω–∞ Railway –∫–∞–∫ monorepo —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏.\r\n\r\n## üìã Pre-deployment Checklist\r\n\r\n### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ Railway –ø—Ä–æ–µ–∫—Ç–∞\r\n- [ ] –°–æ–∑–¥–∞–Ω –∞–∫–∫–∞—É–Ω—Ç –Ω–∞ Railway\r\n- [ ] –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω Railway CLI\r\n- [ ] –í—ã–ø–æ–ª–Ω–µ–Ω –≤—Ö–æ–¥\r\n\r\n### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤\r\n- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω S3-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π storage\r\n- [ ] –°–æ–∑–¥–∞–Ω Telegram Bot\r\n- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω Sentry (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)\r\n\r\n## üöÄ Deployment Steps\r\n\r\n### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ Railway –ø—Ä–æ–µ–∫—Ç–∞\r\nrailway new vhm24-production\r\nrailway link\r\n\r\n### –®–∞–≥ 2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö\r\nrailway add postgresql\r\nrailway add redis\r\n\r\n### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\n–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env.railway.example\r\n\r\n### –®–∞–≥ 4: –î–µ–ø–ª–æ–π\r\nrailway variables set RAILWAY_SERVICE_NAME=\"gateway\"\r\nrailway up\r\n\r\n## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è\r\n\r\n${this.warnings.map(w => `- ${w}`).join('\\n')}\r\n\r\n## üîß Troubleshooting\r\n\r\n### –ü—Ä–æ–±–ª–µ–º–∞: –°–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è\r\nrailway logs\r\nrailway variables\r\nrailway status\r\n\r\n### –ü—Ä–æ–±–ª–µ–º–∞: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è\r\n- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ DATABASE_URL\r\n- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ PostgreSQL addon –∞–∫—Ç–∏–≤–µ–Ω\r\n\r\n### –ü—Ä–æ–±–ª–µ–º–∞: –§–∞–π–ª—ã –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è\r\n- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ S3 credentials\r\n- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ bucket —Å—É—â–µ—Å—Ç–≤—É–µ—Ç\r\n\r\n## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞\r\n\r\n- Railway Discord: https://discord.gg/railway\r\n- Railway Docs: https://docs.railway.app\r\n`;\r\n    \r\n    fs.writeFileSync('RAILWAY_DEPLOYMENT_GUIDE.md', guide);\r\n    this.tasks.push('Created comprehensive deployment guide');\r\n    \r\n    console.log('\\n‚úÖ Railway preparation completed!');\r\n    console.log('\\nüìã Completed tasks:');\r\n    this.tasks.forEach(task => console.log(`  ‚úÖ ${task}`));\r\n    \r\n    if (this.warnings.length > 0) {\r\n      console.log('\\n‚ö†Ô∏è Important warnings:');\r\n      this.warnings.forEach(warning => console.log(`  ‚ö†Ô∏è ${warning}`));\r\n    }\r\n    \r\n    console.log('\\nüìñ Next steps:');\r\n    console.log('1. Review RAILWAY_DEPLOYMENT_GUIDE.md');\r\n    console.log('2. Set up external services (S3, Telegram Bot)');\r\n    console.log('3. Create Railway project: railway new vhm24-production');\r\n    console.log('4. Add databases: railway add postgresql && railway add redis');\r\n    console.log('5. Set environment variables from .env.railway.example');\r\n    console.log('6. Deploy: railway up');\r\n    \r\n    console.log('\\nüéØ Quick start command:');\r\n    console.log('railway variables set RAILWAY_SERVICE_NAME=gateway && railway up');\r\n  }\r\n}\r\n\r\n// –ó–∞–ø—É—Å–∫ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏\r\nconst prep = new RailwayPreparation();\r\nprep.prepare().catch(console.error);\r\n",
  "services/monitoring/src/index.js": "/**\r\n * VHM24 - VendHub Manager 24/7\r\n * Monitoring Service\r\n * –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã –∏ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è Prometheus\r\n */\r\n\r\nrequire('dotenv').config({ path: require('path').join(__dirname, '../../../.env') });\r\nconst Fastify = require('fastify');\r\nconst cors = require('@fastify/cors');\r\nconst jwt = require('@fastify/jwt');\r\nconst client = require('prom-client');\r\nconst { getPrismaClient } = require('@vhm24/database');\r\n\r\nconst prisma = getPrismaClient();\r\nconst fastify = Fastify({ \r\n  logger: true,\r\n  trustProxy: true\r\n});\r\n\r\n// –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\nif (!process.env.JWT_SECRET) {\r\n  throw new Error('JWT_SECRET must be set in environment variables');\r\n}\r\n\r\n// –°–æ–∑–¥–∞–µ–º —Ä–µ–µ—Å—Ç—Ä –¥–ª—è –º–µ—Ç—Ä–∏–∫\r\nconst register = new client.Registry();\r\n\r\n// –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (CPU, –ø–∞–º—è—Ç—å –∏ —Ç.–¥.)\r\nclient.collectDefaultMetrics({ register });\r\n\r\n// –ö–∞—Å—Ç–æ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏\r\nconst httpRequestDuration = new client.Histogram({\r\n  name: 'vhm24_http_request_duration_seconds',\r\n  help: 'Duration of HTTP requests in seconds',\r\n  labelNames: ['method', 'route', 'status_code', 'service'],\r\n  buckets: [0.1, 0.5, 1, 2, 5]\r\n});\r\n\r\nconst httpRequestTotal = new client.Counter({\r\n  name: 'vhm24_http_requests_total',\r\n  help: 'Total number of HTTP requests',\r\n  labelNames: ['method', 'route', 'status_code', 'service']\r\n});\r\n\r\nconst machinesOnline = new client.Gauge({\r\n  name: 'vhm24_machines_online',\r\n  help: 'Number of online vending machines'\r\n});\r\n\r\nconst machinesOffline = new client.Gauge({\r\n  name: 'vhm24_machines_offline',\r\n  help: 'Number of offline vending machines'\r\n});\r\n\r\nconst machinesError = new client.Gauge({\r\n  name: 'vhm24_machines_error',\r\n  help: 'Number of vending machines with errors'\r\n});\r\n\r\nconst tasksOpen = new client.Gauge({\r\n  name: 'vhm24_tasks_open',\r\n  help: 'Number of open tasks'\r\n});\r\n\r\nconst tasksCompleted = new client.Counter({\r\n  name: 'vhm24_tasks_completed_total',\r\n  help: 'Total number of completed tasks'\r\n});\r\n\r\nconst inventoryLowStock = new client.Gauge({\r\n  name: 'vhm24_inventory_low_stock',\r\n  help: 'Number of items with low stock'\r\n});\r\n\r\nconst transactionsTotal = new client.Counter({\r\n  name: 'vhm24_transactions_total',\r\n  help: 'Total number of transactions',\r\n  labelNames: ['status', 'payment_type']\r\n});\r\n\r\nconst transactionsAmount = new client.Counter({\r\n  name: 'vhm24_transactions_amount_total',\r\n  help: 'Total amount of transactions',\r\n  labelNames: ['currency']\r\n});\r\n\r\nconst activeUsers = new client.Gauge({\r\n  name: 'vhm24_users_active',\r\n  help: 'Number of active users'\r\n});\r\n\r\nconst databaseConnections = new client.Gauge({\r\n  name: 'vhm24_database_connections',\r\n  help: 'Number of database connections'\r\n});\r\n\r\nconst apiErrors = new client.Counter({\r\n  name: 'vhm24_api_errors_total',\r\n  help: 'Total number of API errors',\r\n  labelNames: ['service', 'error_type']\r\n});\r\n\r\n// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤—Å–µ –º–µ—Ç—Ä–∏–∫–∏\r\nregister.registerMetric(httpRequestDuration);\r\nregister.registerMetric(httpRequestTotal);\r\nregister.registerMetric(machinesOnline);\r\nregister.registerMetric(machinesOffline);\r\nregister.registerMetric(machinesError);\r\nregister.registerMetric(tasksOpen);\r\nregister.registerMetric(tasksCompleted);\r\nregister.registerMetric(inventoryLowStock);\r\nregister.registerMetric(transactionsTotal);\r\nregister.registerMetric(transactionsAmount);\r\nregister.registerMetric(activeUsers);\r\nregister.registerMetric(databaseConnections);\r\nregister.registerMetric(apiErrors);\r\n\r\n// CORS\r\nfastify.register(cors, {\r\n  origin: (origin, cb) => {\r\n    const allowedOrigins = process.env.ALLOWED_ORIGINS?.split(',') || ['http://localhost:3000'];\r\n    if (!origin || allowedOrigins.includes(origin)) {\r\n      cb(null, true);\r\n    } else {\r\n      cb(new Error('Not allowed by CORS'));\r\n    }\r\n  },\r\n  credentials: true\r\n});\r\n\r\n// JWT\r\nfastify.register(jwt, {\r\n  secret: process.env.JWT_SECRET,\r\n  verify: {\r\n    issuer: ['vhm24-gateway', 'vhm24-auth']\r\n  }\r\n});\r\n\r\n// –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏\r\nfastify.decorate('authenticate', async function(request, reply) {\r\n  try {\r\n    await request.jwtVerify();\r\n  } catch (err) {\r\n    reply.code(401).send({ \r\n      success: false,\r\n      error: 'Unauthorized',\r\n      message: err.message || 'Invalid or expired token'\r\n    });\r\n  }\r\n});\r\n\r\n// Health check\r\nfastify.get('/health', async (request, reply) => {\r\n  return { \r\n    status: 'ok', \r\n    service: 'monitoring',\r\n    metrics: {\r\n      prometheus: 'enabled',\r\n      endpoint: '/metrics'\r\n    }\r\n  };\r\n});\r\n\r\n// Prometheus –º–µ—Ç—Ä–∏–∫–∏ endpoint\r\nfastify.get('/metrics', async (request, reply) => {\r\n  try {\r\n    // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\r\n    await updateMetrics();\r\n    \r\n    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Prometheus\r\n    reply.type('text/plain');\r\n    return register.metrics();\r\n  } catch (error) {\r\n    fastify.log.error('Failed to collect metrics:', error);\r\n    reply.code(500).send('Failed to collect metrics');\r\n  }\r\n});\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫\r\nasync function updateMetrics() {\r\n  try {\r\n    // –ú–µ—Ç—Ä–∏–∫–∏ –º–∞—à–∏–Ω\r\n    const [onlineCount, offlineCount, errorCount] = await Promise.all([\r\n      prisma.machine.count({ where: { status: 'ONLINE' } }),\r\n      prisma.machine.count({ where: { status: 'OFFLINE' } }),\r\n      prisma.machine.count({ where: { status: 'ERROR' } })\r\n    ]);\r\n    \r\n    machinesOnline.set(onlineCount);\r\n    machinesOffline.set(offlineCount);\r\n    machinesError.set(errorCount);\r\n    \r\n    // –ú–µ—Ç—Ä–∏–∫–∏ –∑–∞–¥–∞—á\r\n    const openTasksCount = await prisma.task.count({\r\n      where: {\r\n        status: { in: ['CREATED', 'ASSIGNED', 'IN_PROGRESS'] }\r\n      }\r\n    });\r\n    \r\n    tasksOpen.set(openTasksCount);\r\n    \r\n    // –ú–µ—Ç—Ä–∏–∫–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è\r\n    const lowStockCount = await prisma.inventoryItem.count({\r\n      where: {\r\n        quantity: { lte: 10 } // TODO: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å minQuantity\r\n      }\r\n    });\r\n    \r\n    inventoryLowStock.set(lowStockCount);\r\n    \r\n    // –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\r\n    const activeUsersCount = await prisma.user.count({\r\n      where: { isActive: true }\r\n    });\r\n    \r\n    activeUsers.set(activeUsersCount);\r\n    \r\n  } catch (error) {\r\n    fastify.log.error('Failed to update metrics:', error);\r\n    apiErrors.inc({ service: 'monitoring', error_type: 'metrics_update' });\r\n  }\r\n}\r\n\r\n// API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏\r\nfastify.get('/api/v1/monitoring/stats', {\r\n  preValidation: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    const stats = {\r\n      machines: {\r\n        total: await prisma.machine.count(),\r\n        online: await prisma.machine.count({ where: { status: 'ONLINE' } }),\r\n        offline: await prisma.machine.count({ where: { status: 'OFFLINE' } }),\r\n        maintenance: await prisma.machine.count({ where: { status: 'MAINTENANCE' } }),\r\n        error: await prisma.machine.count({ where: { status: 'ERROR' } })\r\n      },\r\n      tasks: {\r\n        total: await prisma.task.count(),\r\n        created: await prisma.task.count({ where: { status: 'CREATED' } }),\r\n        assigned: await prisma.task.count({ where: { status: 'ASSIGNED' } }),\r\n        inProgress: await prisma.task.count({ where: { status: 'IN_PROGRESS' } }),\r\n        completed: await prisma.task.count({ where: { status: 'COMPLETED' } }),\r\n        cancelled: await prisma.task.count({ where: { status: 'CANCELLED' } })\r\n      },\r\n      inventory: {\r\n        totalItems: await prisma.inventoryItem.count(),\r\n        activeItems: await prisma.inventoryItem.count({ where: { isActive: true } }),\r\n        lowStock: await prisma.inventoryItem.count({ where: { quantity: { lte: 10 } } }),\r\n        outOfStock: await prisma.inventoryItem.count({ where: { quantity: 0 } })\r\n      },\r\n      users: {\r\n        total: await prisma.user.count(),\r\n        active: await prisma.user.count({ where: { isActive: true } }),\r\n        byRole: await prisma.user.groupBy({\r\n          by: ['roles'],\r\n          _count: true\r\n        })\r\n      },\r\n      transactions: {\r\n        today: await prisma.transaction.count({\r\n          where: {\r\n            createdAt: {\r\n              gte: new Date(new Date().setHours(0, 0, 0, 0))\r\n            }\r\n          }\r\n        }),\r\n        todayAmount: await prisma.transaction.aggregate({\r\n          where: {\r\n            createdAt: {\r\n              gte: new Date(new Date().setHours(0, 0, 0, 0))\r\n            },\r\n            status: 'SUCCESS'\r\n          },\r\n          _sum: { amount: true }\r\n        }),\r\n        last24h: await prisma.transaction.count({\r\n          where: {\r\n            createdAt: {\r\n              gte: new Date(Date.now() - 24 * 60 * 60 * 1000)\r\n            }\r\n          }\r\n        })\r\n      },\r\n      system: {\r\n        uptime: process.uptime(),\r\n        memory: process.memoryUsage(),\r\n        cpu: process.cpuUsage()\r\n      }\r\n    };\r\n    \r\n    return {\r\n      success: true,\r\n      data: stats\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    apiErrors.inc({ service: 'monitoring', error_type: 'stats_fetch' });\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to fetch statistics'\r\n    });\r\n  }\r\n});\r\n\r\n// API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –º–µ—Ç—Ä–∏–∫\r\nfastify.get('/api/v1/monitoring/history', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    querystring: {\r\n      type: 'object',\r\n      properties: {\r\n        metric: { type: 'string' },\r\n        from: { type: 'string', format: 'date-time' },\r\n        to: { type: 'string', format: 'date-time' },\r\n        interval: { type: 'string', enum: ['1m', '5m', '15m', '1h', '1d'], default: '5m' }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { metric, from, to, interval } = request.query;\r\n  \r\n  // TODO: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤ (InfluxDB, TimescaleDB)\r\n  \r\n  return {\r\n    success: false,\r\n    error: 'History storage not implemented yet',\r\n    message: 'Please use Prometheus with Grafana for historical data'\r\n  };\r\n});\r\n\r\n// API –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–ª–µ—Ä—Ç–æ–≤\r\nfastify.post('/api/v1/monitoring/alerts', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    body: {\r\n      type: 'object',\r\n      required: ['name', 'condition', 'threshold', 'action'],\r\n      properties: {\r\n        name: { type: 'string' },\r\n        description: { type: 'string' },\r\n        metric: { type: 'string' },\r\n        condition: { type: 'string', enum: ['gt', 'lt', 'eq', 'ne'] },\r\n        threshold: { type: 'number' },\r\n        action: {\r\n          type: 'object',\r\n          properties: {\r\n            type: { type: 'string', enum: ['email', 'telegram', 'webhook'] },\r\n            target: { type: 'string' }\r\n          }\r\n        },\r\n        enabled: { type: 'boolean', default: true }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –∞–ª–µ—Ä—Ç–æ–≤\r\n  \r\n  return {\r\n    success: false,\r\n    error: 'Alerts not implemented yet',\r\n    message: 'Please use Prometheus AlertManager for alerts'\r\n  };\r\n});\r\n\r\n// Middleware –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤\r\nfastify.addHook('onRequest', async (request, reply) => {\r\n  request.startTime = Date.now();\r\n});\r\n\r\nfastify.addHook('onResponse', async (request, reply) => {\r\n  const duration = (Date.now() - request.startTime) / 1000;\r\n  const labels = {\r\n    method: request.method,\r\n    route: request.routerPath || request.url,\r\n    status_code: reply.statusCode,\r\n    service: 'monitoring'\r\n  };\r\n  \r\n  httpRequestDuration.observe(labels, duration);\r\n  httpRequestTotal.inc(labels);\r\n});\r\n\r\n// –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫\r\nsetInterval(async () => {\r\n  try {\r\n    await updateMetrics();\r\n  } catch (error) {\r\n    fastify.log.error('Failed to update metrics:', error);\r\n  }\r\n}, 30000); // –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥\r\n\r\n// Start server\r\nconst start = async () => {\r\n  try {\r\n    await fastify.listen({ \r\n      port: process.env.MONITORING_PORT || 3008,\r\n      host: '0.0.0.0'\r\n    });\r\n    console.log('VHM24 Monitoring Service running 24/7 on port', process.env.MONITORING_PORT || 3008);\r\n    console.log('Prometheus metrics available at /metrics');\r\n    \r\n    // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫\r\n    await updateMetrics();\r\n  } catch (err) {\r\n    fastify.log.error(err);\r\n    process.exit(1);\r\n  }\r\n};\r\n\r\nstart();\r\n\r\n// Graceful shutdown\r\nprocess.on('SIGTERM', async () => {\r\n  await fastify.close();\r\n  await prisma.$disconnect();\r\n  process.exit(0);\r\n});\r\n",
  "services/notifications/src/index.js": "/**\r\n * VHM24 - VendHub Manager 24/7\r\n * Notifications Service\r\n * –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ —á–µ—Ä–µ–∑ —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∫–∞–Ω–∞–ª—ã\r\n */\r\n\r\nrequire('dotenv').config({ path: require('path').join(__dirname, '../../../.env') });\r\nconst Fastify = require('fastify');\r\nconst cors = require('@fastify/cors');\r\nconst jwt = require('@fastify/jwt');\r\nconst rateLimit = require('@fastify/rate-limit');\r\nconst helmet = require('@fastify/helmet');\r\nconst nodemailer = require('nodemailer');\r\nconst { getPrismaClient } = require('@vhm24/database');\r\nconst { sanitizeInput, validateEmail } = require('@vhm24/shared-types/src/security');\r\nconst NotificationService = require('./services/notificationService');\r\n\r\nconst prisma = getPrismaClient();\r\nconst notificationService = new NotificationService();\r\nconst fastify = Fastify({ \r\n  logger: true,\r\n  trustProxy: true\r\n});\r\n\r\n// –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\nif (!process.env.JWT_SECRET) {\r\n  throw new Error('JWT_SECRET must be set in environment variables');\r\n}\r\n\r\n// Email —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç\r\nlet emailTransporter = null;\r\nif (process.env.SMTP_HOST && process.env.SMTP_USER && process.env.SMTP_PASS) {\r\n  emailTransporter = nodemailer.createTransport({\r\n    host: process.env.SMTP_HOST,\r\n    port: parseInt(process.env.SMTP_PORT) || 587,\r\n    secure: false,\r\n    auth: {\r\n      user: process.env.SMTP_USER,\r\n      pass: process.env.SMTP_PASS\r\n    }\r\n  });\r\n}\r\n\r\n// Security headers\r\nfastify.register(helmet);\r\n\r\n// Rate limiting\r\nfastify.register(rateLimit, {\r\n  max: parseInt(process.env.RATE_LIMIT_MAX) || 100,\r\n  timeWindow: parseInt(process.env.RATE_LIMIT_WINDOW) || 60000\r\n});\r\n\r\n// CORS\r\nfastify.register(cors, {\r\n  origin: (origin, cb) => {\r\n    const allowedOrigins = process.env.ALLOWED_ORIGINS?.split(',') || ['http://localhost:3000'];\r\n    if (!origin || allowedOrigins.includes(origin)) {\r\n      cb(null, true);\r\n    } else {\r\n      cb(new Error('Not allowed by CORS'));\r\n    }\r\n  },\r\n  credentials: true\r\n});\r\n\r\n// JWT\r\nfastify.register(jwt, {\r\n  secret: process.env.JWT_SECRET,\r\n  verify: {\r\n    issuer: ['vhm24-gateway', 'vhm24-auth']\r\n  }\r\n});\r\n\r\n// –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏\r\nfastify.decorate('authenticate', async function(request, reply) {\r\n  try {\r\n    await request.jwtVerify();\r\n    const user = await prisma.user.findUnique({\r\n      where: { id: request.user.id },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        name: true,\r\n        roles: true,\r\n        isActive: true\r\n      }\r\n    });\r\n    \r\n    if (!user || !user.isActive) {\r\n      throw new Error('User not found or inactive');\r\n    }\r\n    \r\n    request.user = user;\r\n  } catch (err) {\r\n    reply.code(401).send({ \r\n      success: false,\r\n      error: 'Unauthorized',\r\n      message: err.message || 'Invalid or expired token'\r\n    });\r\n  }\r\n});\r\n\r\n// Health check\r\nfastify.get('/health', async (request, reply) => {\r\n  return { \r\n    status: 'ok', \r\n    service: 'notifications',\r\n    channels: {\r\n      email: emailTransporter ? 'configured' : 'not configured',\r\n      telegram: process.env.TELEGRAM_BOT_TOKEN ? 'configured' : 'not configured',\r\n      push: process.env.FCM_SERVER_KEY ? 'configured' : 'not configured'\r\n    }\r\n  };\r\n});\r\n\r\n// –û—Ç–ø—Ä–∞–≤–∏—Ç—å email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ\r\nfastify.post('/api/v1/notifications/email', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    body: {\r\n      type: 'object',\r\n      required: ['to', 'subject', 'text'],\r\n      properties: {\r\n        to: { type: 'string', format: 'email' },\r\n        subject: { type: 'string', minLength: 1 },\r\n        text: { type: 'string', minLength: 1 },\r\n        html: { type: 'string' }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { to, subject, text, html } = request.body;\r\n  \r\n  try {\r\n    if (!emailTransporter) {\r\n      return reply.code(503).send({\r\n        success: false,\r\n        error: 'Email service not configured'\r\n      });\r\n    }\r\n    \r\n    // –í–∞–ª–∏–¥–∞—Ü–∏—è email\r\n    if (!validateEmail(to)) {\r\n      return reply.code(400).send({\r\n        success: false,\r\n        error: 'Invalid email address'\r\n      });\r\n    }\r\n    \r\n    // –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö\r\n    const sanitizedSubject = sanitizeInput(subject);\r\n    const sanitizedText = sanitizeInput(text);\r\n    \r\n    // –û—Ç–ø—Ä–∞–≤–∫–∞ email\r\n    const info = await emailTransporter.sendMail({\r\n      from: process.env.EMAIL_FROM || 'noreply@vhm24.ru',\r\n      to,\r\n      subject: sanitizedSubject,\r\n      text: sanitizedText,\r\n      html: html || sanitizedText\r\n    });\r\n    \r\n    // –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É\r\n    await prisma.auditLog.create({\r\n      data: {\r\n        userId: request.user.id,\r\n        action: 'EMAIL_SENT',\r\n        entity: 'Notification',\r\n        entityId: info.messageId,\r\n        changes: {\r\n          to,\r\n          subject: sanitizedSubject,\r\n          channel: 'email'\r\n        },\r\n        ipAddress: request.ip\r\n      }\r\n    });\r\n    \r\n    return {\r\n      success: true,\r\n      data: {\r\n        messageId: info.messageId,\r\n        accepted: info.accepted,\r\n        rejected: info.rejected\r\n      }\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to send email'\r\n    });\r\n  }\r\n});\r\n\r\n// –û—Ç–ø—Ä–∞–≤–∏—Ç—å Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ\r\nfastify.post('/api/v1/notifications/telegram', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    body: {\r\n      type: 'object',\r\n      required: ['chatId', 'message'],\r\n      properties: {\r\n        chatId: { type: 'string' },\r\n        message: { type: 'string', minLength: 1 },\r\n        parseMode: { type: 'string', enum: ['Markdown', 'HTML'] }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { chatId, message, parseMode } = request.body;\r\n  \r\n  try {\r\n    if (!process.env.TELEGRAM_BOT_TOKEN) {\r\n      return reply.code(503).send({\r\n        success: false,\r\n        error: 'Telegram service not configured'\r\n      });\r\n    }\r\n    \r\n    // –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Telegram Bot API\r\n    const response = await fetch(\r\n      `https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`,\r\n      {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify({\r\n          chat_id: chatId,\r\n          text: message,\r\n          parse_mode: parseMode || 'Markdown'\r\n        })\r\n      }\r\n    );\r\n    \r\n    const result = await response.json();\r\n    \r\n    if (!result.ok) {\r\n      throw new Error(result.description || 'Telegram API error');\r\n    }\r\n    \r\n    // –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É\r\n    await prisma.auditLog.create({\r\n      data: {\r\n        userId: request.user.id,\r\n        action: 'TELEGRAM_SENT',\r\n        entity: 'Notification',\r\n        entityId: result.result.message_id.toString(),\r\n        changes: {\r\n          chatId,\r\n          channel: 'telegram'\r\n        },\r\n        ipAddress: request.ip\r\n      }\r\n    });\r\n    \r\n    return {\r\n      success: true,\r\n      data: {\r\n        messageId: result.result.message_id,\r\n        chatId: result.result.chat.id\r\n      }\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to send Telegram message'\r\n    });\r\n  }\r\n});\r\n\r\n// –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\r\nfastify.post('/api/v1/notifications/broadcast', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    body: {\r\n      type: 'object',\r\n      required: ['channels', 'message'],\r\n      properties: {\r\n        channels: { \r\n          type: 'array', \r\n          items: { \r\n            type: 'string', \r\n            enum: ['email', 'telegram', 'push'] \r\n          }\r\n        },\r\n        message: {\r\n          type: 'object',\r\n          required: ['subject', 'text'],\r\n          properties: {\r\n            subject: { type: 'string' },\r\n            text: { type: 'string' },\r\n            html: { type: 'string' }\r\n          }\r\n        },\r\n        filters: {\r\n          type: 'object',\r\n          properties: {\r\n            roles: { \r\n              type: 'array', \r\n              items: { type: 'string' }\r\n            },\r\n            isActive: { type: 'boolean' }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { channels, message, filters } = request.body;\r\n  \r\n  try {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ - —Ç–æ–ª—å–∫–æ ADMIN –º–æ–∂–µ—Ç –¥–µ–ª–∞—Ç—å –º–∞—Å—Å–æ–≤—É—é —Ä–∞—Å—Å—ã–ª–∫—É\r\n    if (!request.user.roles.includes('ADMIN')) {\r\n      return reply.code(403).send({\r\n        success: false,\r\n        error: 'Only administrators can send broadcast notifications'\r\n      });\r\n    }\r\n    \r\n    // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º\r\n    const where = {};\r\n    if (filters?.roles) {\r\n      where.roles = { hasSome: filters.roles };\r\n    }\r\n    if (filters?.isActive !== undefined) {\r\n      where.isActive = filters.isActive;\r\n    }\r\n    \r\n    const users = await prisma.user.findMany({\r\n      where,\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        telegramId: true,\r\n        name: true\r\n      }\r\n    });\r\n    \r\n    const results = {\r\n      total: users.length,\r\n      sent: 0,\r\n      failed: 0,\r\n      channels: {}\r\n    };\r\n    \r\n    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ –∫–∞–Ω–∞–ª–∞–º\r\n    for (const channel of channels) {\r\n      results.channels[channel] = { sent: 0, failed: 0 };\r\n      \r\n      for (const user of users) {\r\n        try {\r\n          switch (channel) {\r\n            case 'email':\r\n              if (user.email && emailTransporter) {\r\n                await emailTransporter.sendMail({\r\n                  from: process.env.EMAIL_FROM || 'noreply@vhm24.ru',\r\n                  to: user.email,\r\n                  subject: message.subject,\r\n                  text: message.text,\r\n                  html: message.html || message.text\r\n                });\r\n                results.channels[channel].sent++;\r\n                results.sent++;\r\n              }\r\n              break;\r\n              \r\n            case 'telegram':\r\n              if (user.telegramId && process.env.TELEGRAM_BOT_TOKEN) {\r\n                const response = await fetch(\r\n                  `https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`,\r\n                  {\r\n                    method: 'POST',\r\n                    headers: {\r\n                      'Content-Type': 'application/json'\r\n                    },\r\n                    body: JSON.stringify({\r\n                      chat_id: user.telegramId,\r\n                      text: `*${message.subject}*\\n\\n${message.text}`,\r\n                      parse_mode: 'Markdown'\r\n                    })\r\n                  }\r\n                );\r\n                \r\n                const result = await response.json();\r\n                if (result.ok) {\r\n                  results.channels[channel].sent++;\r\n                  results.sent++;\r\n                } else {\r\n                  results.channels[channel].failed++;\r\n                  results.failed++;\r\n                }\r\n              }\r\n              break;\r\n          }\r\n        } catch (error) {\r\n          fastify.log.error(`Failed to send ${channel} to user ${user.id}:`, error);\r\n          results.channels[channel].failed++;\r\n          results.failed++;\r\n        }\r\n      }\r\n    }\r\n    \r\n    // –õ–æ–≥–∏—Ä—É–µ–º –º–∞—Å—Å–æ–≤—É—é —Ä–∞—Å—Å—ã–ª–∫—É\r\n    await prisma.auditLog.create({\r\n      data: {\r\n        userId: request.user.id,\r\n        action: 'BROADCAST_SENT',\r\n        entity: 'Notification',\r\n        entityId: 'broadcast',\r\n        changes: {\r\n          channels,\r\n          filters,\r\n          results\r\n        },\r\n        ipAddress: request.ip\r\n      }\r\n    });\r\n    \r\n    return {\r\n      success: true,\r\n      data: results\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to send broadcast'\r\n    });\r\n  }\r\n});\r\n\r\n// –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ NotificationService\r\nfastify.post('/api/v1/notifications/send', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    body: {\r\n      type: 'object',\r\n      required: ['type', 'recipients', 'data'],\r\n      properties: {\r\n        type: { \r\n          type: 'string',\r\n          enum: [\r\n            'TASK_OVERDUE', 'LOW_STOCK', 'MACHINE_OFFLINE', 'ROUTE_COMPLETED',\r\n            'MAINTENANCE_DUE', 'INCOMPLETE_DATA', 'SYSTEM_ALERT', 'FUEL_REPORT',\r\n            'ARRIVAL_CONFIRMATION', 'WAREHOUSE_RECEIPT'\r\n          ]\r\n        },\r\n        recipients: {\r\n          oneOf: [\r\n            { type: 'string' },\r\n            { type: 'array', items: { type: 'string' } }\r\n          ]\r\n        },\r\n        data: { type: 'object' },\r\n        options: {\r\n          type: 'object',\r\n          properties: {\r\n            channels: {\r\n              type: 'array',\r\n              items: { type: 'string', enum: ['telegram', 'email', 'sms'] }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { type, recipients, data, options } = request.body;\r\n  \r\n  try {\r\n    const result = await notificationService.sendNotification(type, recipients, data, options);\r\n    \r\n    return {\r\n      success: true,\r\n      data: result\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error('Send notification error:', error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: error.message || 'Failed to send notification'\r\n    });\r\n  }\r\n});\r\n\r\n// –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\r\nfastify.post('/api/v1/notifications/check-scheduled', {\r\n  preValidation: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ - —Ç–æ–ª—å–∫–æ ADMIN –∏–ª–∏ SYSTEM\r\n    if (!request.user.roles.includes('ADMIN') && !request.user.roles.includes('SYSTEM')) {\r\n      return reply.code(403).send({\r\n        success: false,\r\n        error: 'Only administrators can trigger scheduled notifications check'\r\n      });\r\n    }\r\n    \r\n    await notificationService.sendScheduledNotifications();\r\n    \r\n    return {\r\n      success: true,\r\n      message: 'Scheduled notifications check completed'\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error('Scheduled notifications error:', error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to check scheduled notifications'\r\n    });\r\n  }\r\n});\r\n\r\n// –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\r\nfastify.get('/api/v1/notifications/stats', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    querystring: {\r\n      type: 'object',\r\n      properties: {\r\n        period: { type: 'string', enum: ['7d', '30d', '1y'], default: '7d' }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { period } = request.query;\r\n  \r\n  try {\r\n    const stats = await notificationService.getNotificationStats(period);\r\n    \r\n    return {\r\n      success: true,\r\n      data: stats\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error('Get notification stats error:', error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to get notification statistics'\r\n    });\r\n  }\r\n});\r\n\r\n// –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\r\nfastify.get('/api/v1/notifications/history', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    querystring: {\r\n      type: 'object',\r\n      properties: {\r\n        channel: { type: 'string', enum: ['email', 'telegram', 'push'] },\r\n        from: { type: 'string', format: 'date-time' },\r\n        to: { type: 'string', format: 'date-time' },\r\n        skip: { type: 'integer', minimum: 0, default: 0 },\r\n        take: { type: 'integer', minimum: 1, maximum: 100, default: 20 }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { channel, from, to, skip, take } = request.query;\r\n  \r\n  try {\r\n    const where = {\r\n      action: { in: ['EMAIL_SENT', 'TELEGRAM_SENT', 'BROADCAST_SENT'] }\r\n    };\r\n    \r\n    // –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–Ω–µ-–∞–¥–º–∏–Ω—ã –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏)\r\n    if (!request.user.roles.includes('ADMIN')) {\r\n      where.userId = request.user.id;\r\n    }\r\n    \r\n    // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞–Ω–∞–ª—É\r\n    if (channel) {\r\n      where.changes = {\r\n        path: ['channel'],\r\n        equals: channel\r\n      };\r\n    }\r\n    \r\n    // –§–∏–ª—å—Ç—Ä –ø–æ –≤—Ä–µ–º–µ–Ω–∏\r\n    if (from || to) {\r\n      where.createdAt = {};\r\n      if (from) where.createdAt.gte = new Date(from);\r\n      if (to) where.createdAt.lte = new Date(to);\r\n    }\r\n    \r\n    const [notifications, total] = await Promise.all([\r\n      prisma.auditLog.findMany({\r\n        where,\r\n        skip,\r\n        take,\r\n        orderBy: { createdAt: 'desc' },\r\n        include: {\r\n          user: {\r\n            select: {\r\n              id: true,\r\n              name: true,\r\n              email: true\r\n            }\r\n          }\r\n        }\r\n      }),\r\n      prisma.auditLog.count({ where })\r\n    ]);\r\n    \r\n    return {\r\n      success: true,\r\n      data: {\r\n        items: notifications,\r\n        total,\r\n        skip,\r\n        take\r\n      }\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to fetch notification history'\r\n    });\r\n  }\r\n});\r\n\r\n// Start server\r\nconst start = async () => {\r\n  try {\r\n    await fastify.listen({ \r\n      port: process.env.NOTIFICATIONS_PORT || 3006,\r\n      host: '0.0.0.0'\r\n    });\r\n    console.log('VHM24 Notifications Service running 24/7 on port', process.env.NOTIFICATIONS_PORT || 3006);\r\n  } catch (err) {\r\n    fastify.log.error(err);\r\n    process.exit(1);\r\n  }\r\n};\r\n\r\nstart();\r\n\r\n// Graceful shutdown\r\nprocess.on('SIGTERM', async () => {\r\n  await fastify.close();\r\n  await prisma.$disconnect();\r\n  process.exit(0);\r\n});\r\n",
  "services/tasks/src/index.js": "require('dotenv').config({ path: require('path').join(__dirname, '../../../.env') });\r\nconst Fastify = require('fastify');\r\nconst cors = require('@fastify/cors');\r\nconst jwt = require('@fastify/jwt');\r\nconst { getTasksClient } = require('@vhm24/database');\r\nconst { TaskStatus } = require('@prisma/client');\r\nconst scheduledTasks = require('./scheduledTasks');\r\n\r\nconst prisma = getTasksClient();\r\nconst fastify = Fastify({ logger: true });\r\n\r\n// Plugins\r\nfastify.register(cors, {\r\n  origin: true,\r\n  credentials: true\r\n});\r\n\r\nfastify.register(jwt, {\r\n  secret: process.env.JWT_SECRET || 'your-secret-key'\r\n});\r\n\r\n// –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏\r\nfastify.decorate('authenticate', async function(request, reply) {\r\n  try {\r\n    await request.jwtVerify();\r\n    const user = await prisma.user.findUnique({\r\n      where: { id: request.user.id },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        name: true,\r\n        roles: true,\r\n        isActive: true\r\n      }\r\n    });\r\n    \r\n    if (!user || !user.isActive) {\r\n      throw new Error('User not found or inactive');\r\n    }\r\n    \r\n    request.user = user;\r\n  } catch (err) {\r\n    reply.code(401).send({ \r\n      success: false,\r\n      error: 'Unauthorized',\r\n      message: err.message || 'Invalid or expired token'\r\n    });\r\n  }\r\n});\r\n\r\n// Health check\r\nfastify.get('/health', async (request, reply) => {\r\n  return { status: 'ok', service: 'tasks' };\r\n});\r\n\r\n// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏\r\nfastify.get('/api/v1/tasks', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    querystring: {\r\n      type: 'object',\r\n      properties: {\r\n        status: { type: 'string', enum: ['CREATED', 'ASSIGNED', 'IN_PROGRESS', 'COMPLETED', 'CANCELLED'] },\r\n        assignedToId: { type: 'string' },\r\n        machineId: { type: 'string' },\r\n        skip: { type: 'integer', minimum: 0, default: 0 },\r\n        take: { type: 'integer', minimum: 1, maximum: 100, default: 20 },\r\n        orderBy: { type: 'string', enum: ['createdAt', 'updatedAt', 'priority'], default: 'createdAt' },\r\n        order: { type: 'string', enum: ['asc', 'desc'], default: 'desc' }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { status, assignedToId, machineId, skip, take, orderBy, order } = request.query;\r\n  \r\n  try {\r\n    const where = {};\r\n    if (status) where.status = status;\r\n    if (assignedToId) where.assignedToId = assignedToId;\r\n    if (machineId) where.machineId = machineId;\r\n\r\n    const [tasks, total] = await Promise.all([\r\n      prisma.task.findMany({\r\n        where,\r\n        skip,\r\n        take,\r\n        orderBy: { [orderBy]: order },\r\n        include: {\r\n          machine: {\r\n            select: {\r\n              id: true,\r\n              code: true,\r\n              name: true,\r\n              location: true\r\n            }\r\n          },\r\n          assignedTo: {\r\n            select: {\r\n              id: true,\r\n              name: true,\r\n              email: true\r\n            }\r\n          },\r\n          createdBy: {\r\n            select: {\r\n              id: true,\r\n              name: true,\r\n              email: true\r\n            }\r\n          }\r\n        }\r\n      }),\r\n      prisma.task.count({ where })\r\n    ]);\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        items: tasks,\r\n        total,\r\n        skip,\r\n        take\r\n      }\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to fetch tasks'\r\n    });\r\n  }\r\n});\r\n\r\n// –ü–æ–ª—É—á–∏—Ç—å –∑–∞–¥–∞—á—É –ø–æ ID\r\nfastify.get('/api/v1/tasks/:id', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    params: {\r\n      type: 'object',\r\n      properties: {\r\n        id: { type: 'string' }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { id } = request.params;\r\n  \r\n  try {\r\n    const task = await prisma.task.findUnique({\r\n      where: { id },\r\n      include: {\r\n        machine: true,\r\n        assignedTo: true,\r\n        createdBy: true,\r\n        actions: {\r\n          orderBy: { createdAt: 'desc' },\r\n          include: {\r\n            user: {\r\n              select: {\r\n                id: true,\r\n                name: true,\r\n                email: true\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!task) {\r\n      return reply.code(404).send({\r\n        success: false,\r\n        error: 'Task not found'\r\n      });\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      data: task\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to fetch task'\r\n    });\r\n  }\r\n});\r\n\r\n// –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É\r\nfastify.post('/api/v1/tasks', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    body: {\r\n      type: 'object',\r\n      required: ['title', 'machineId', 'priority'],\r\n      properties: {\r\n        title: { type: 'string', minLength: 1 },\r\n        description: { type: 'string' },\r\n        machineId: { type: 'string' },\r\n        assignedToId: { type: 'string' },\r\n        priority: { type: 'string', enum: ['LOW', 'MEDIUM', 'HIGH', 'URGENT'] },\r\n        dueDate: { type: 'string', format: 'date-time' }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { title, description, machineId, assignedToId, priority, dueDate } = request.body;\r\n  const userId = request.user.id;\r\n  \r\n  try {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –º–∞—à–∏–Ω—ã\r\n    const machine = await prisma.machine.findUnique({\r\n      where: { id: machineId }\r\n    });\r\n\r\n    if (!machine) {\r\n      return reply.code(400).send({\r\n        success: false,\r\n        error: 'Machine not found'\r\n      });\r\n    }\r\n\r\n    // –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É\r\n    const task = await prisma.task.create({\r\n      data: {\r\n        title,\r\n        description: description || '',\r\n        machineId,\r\n        assignedToId,\r\n        createdById: userId,\r\n        status: assignedToId ? 'ASSIGNED' : 'CREATED',\r\n        priority: priority || 'MEDIUM',\r\n        dueDate: dueDate ? new Date(dueDate) : null\r\n      },\r\n      include: {\r\n        machine: true,\r\n        assignedTo: true,\r\n        createdBy: true\r\n      }\r\n    });\r\n\r\n    // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–µ–π—Å—Ç–≤–∏–π\r\n    await prisma.taskAction.create({\r\n      data: {\r\n        taskId: task.id,\r\n        userId,\r\n        action: 'CREATED',\r\n        comment: `Task created: ${title}`\r\n      }\r\n    });\r\n\r\n    // TODO: –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é\r\n\r\n    return {\r\n      success: true,\r\n      data: task\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to create task'\r\n    });\r\n  }\r\n});\r\n\r\n// –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É\r\nfastify.patch('/api/v1/tasks/:id', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    params: {\r\n      type: 'object',\r\n      properties: {\r\n        id: { type: 'string' }\r\n      }\r\n    },\r\n    body: {\r\n      type: 'object',\r\n      properties: {\r\n        title: { type: 'string', minLength: 1 },\r\n        description: { type: 'string' },\r\n        status: { type: 'string', enum: ['CREATED', 'ASSIGNED', 'IN_PROGRESS', 'COMPLETED', 'CANCELLED'] },\r\n        assignedToId: { type: 'string' },\r\n        priority: { type: 'string', enum: ['LOW', 'MEDIUM', 'HIGH', 'URGENT'] },\r\n        dueDate: { type: 'string', format: 'date-time' }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { id } = request.params;\r\n  const updates = request.body;\r\n  const userId = request.user.id;\r\n  \r\n  try {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏\r\n    const existingTask = await prisma.task.findUnique({\r\n      where: { id }\r\n    });\r\n\r\n    if (!existingTask) {\r\n      return reply.code(404).send({\r\n        success: false,\r\n        error: 'Task not found'\r\n      });\r\n    }\r\n\r\n    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–¥–∞—á—É\r\n    const task = await prisma.task.update({\r\n      where: { id },\r\n      data: {\r\n        ...updates,\r\n        dueDate: updates.dueDate ? new Date(updates.dueDate) : undefined,\r\n        updatedAt: new Date()\r\n      },\r\n      include: {\r\n        machine: true,\r\n        assignedTo: true,\r\n        createdBy: true\r\n      }\r\n    });\r\n\r\n    // –õ–æ–≥–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è\r\n    const changes = [];\r\n    for (const [key, value] of Object.entries(updates)) {\r\n      if (existingTask[key] !== value) {\r\n        changes.push(`${key}: ${existingTask[key]} ‚Üí ${value}`);\r\n      }\r\n    }\r\n\r\n    if (changes.length > 0) {\r\n      await prisma.taskAction.create({\r\n        data: {\r\n          taskId: task.id,\r\n          userId,\r\n          action: 'UPDATED',\r\n          comment: `Updated: ${changes.join(', ')}`\r\n        }\r\n      });\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      data: task\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to update task'\r\n    });\r\n  }\r\n});\r\n\r\n// –î–æ–±–∞–≤–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ –∫ –∑–∞–¥–∞—á–µ\r\nfastify.post('/api/v1/tasks/:id/actions', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    params: {\r\n      type: 'object',\r\n      properties: {\r\n        id: { type: 'string' }\r\n      }\r\n    },\r\n    body: {\r\n      type: 'object',\r\n      required: ['action', 'comment'],\r\n      properties: {\r\n        action: { type: 'string', enum: ['COMMENT', 'STATUS_CHANGE', 'ASSIGNED', 'STARTED', 'COMPLETED', 'CANCELLED'] },\r\n        comment: { type: 'string', minLength: 1 },\r\n        location: {\r\n          type: 'object',\r\n          properties: {\r\n            latitude: { type: 'number' },\r\n            longitude: { type: 'number' }\r\n          }\r\n        },\r\n        photoUrls: { type: 'array', items: { type: 'string' } }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { id } = request.params;\r\n  const { action, comment, location, photoUrls } = request.body;\r\n  const userId = request.user.id;\r\n  \r\n  try {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏\r\n    const task = await prisma.task.findUnique({\r\n      where: { id }\r\n    });\r\n\r\n    if (!task) {\r\n      return reply.code(404).send({\r\n        success: false,\r\n        error: 'Task not found'\r\n      });\r\n    }\r\n\r\n    // –°–æ–∑–¥–∞–µ–º –¥–µ–π—Å—Ç–≤–∏–µ\r\n    const taskAction = await prisma.taskAction.create({\r\n      data: {\r\n        taskId: id,\r\n        userId,\r\n        action,\r\n        comment,\r\n        location: location ? `${location.latitude},${location.longitude}` : null,\r\n        photoUrls: photoUrls || []\r\n      },\r\n      include: {\r\n        user: {\r\n          select: {\r\n            id: true,\r\n            name: true,\r\n            email: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏\r\n    if (action === 'STARTED' && task.status !== 'IN_PROGRESS') {\r\n      await prisma.task.update({\r\n        where: { id },\r\n        data: { status: 'IN_PROGRESS' }\r\n      });\r\n    } else if (action === 'COMPLETED' && task.status !== 'COMPLETED') {\r\n      await prisma.task.update({\r\n        where: { id },\r\n        data: { \r\n          status: 'COMPLETED',\r\n          completedAt: new Date()\r\n        }\r\n      });\r\n    } else if (action === 'CANCELLED' && task.status !== 'CANCELLED') {\r\n      await prisma.task.update({\r\n        where: { id },\r\n        data: { status: 'CANCELLED' }\r\n      });\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      data: taskAction\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to add action'\r\n    });\r\n  }\r\n});\r\n\r\n// –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞–¥–∞—á\r\nfastify.get('/api/v1/tasks/stats', {\r\n  preValidation: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    const [\r\n      totalTasks,\r\n      tasksByStatus,\r\n      tasksByPriority,\r\n      overdueTasks\r\n    ] = await Promise.all([\r\n      prisma.task.count(),\r\n      prisma.task.groupBy({\r\n        by: ['status'],\r\n        _count: true\r\n      }),\r\n      prisma.task.groupBy({\r\n        by: ['priority'],\r\n        _count: true\r\n      }),\r\n      prisma.task.count({\r\n        where: {\r\n          dueDate: { lt: new Date() },\r\n          status: { not: 'COMPLETED' }\r\n        }\r\n      })\r\n    ]);\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        total: totalTasks,\r\n        byStatus: tasksByStatus.reduce((acc, item) => {\r\n          acc[item.status] = item._count;\r\n          return acc;\r\n        }, {}),\r\n        byPriority: tasksByPriority.reduce((acc, item) => {\r\n          acc[item.priority] = item._count;\r\n          return acc;\r\n        }, {}),\r\n        overdue: overdueTasks\r\n      }\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to fetch statistics'\r\n    });\r\n  }\r\n});\r\n\r\n// API endpoints –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∑–∞–¥–∞—á –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é\r\nfastify.post('/api/v1/tasks/scheduled/inventory-check', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    description: 'Manually trigger inventory check',\r\n    tags: ['Scheduled Tasks']\r\n  }\r\n}, async (request, reply) => {\r\n  try {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä\r\n    if (!request.user.roles.includes('ADMIN')) {\r\n      return reply.code(403).send({\r\n        success: false,\r\n        error: 'Only administrators can trigger scheduled tasks'\r\n      });\r\n    }\r\n\r\n    const result = await scheduledTasks.manualCheckInventory();\r\n\r\n    return {\r\n      success: result,\r\n      message: result ? 'Inventory check triggered successfully' : 'Failed to trigger inventory check'\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to trigger inventory check'\r\n    });\r\n  }\r\n});\r\n\r\nfastify.post('/api/v1/tasks/scheduled/maintenance', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    description: 'Manually trigger maintenance tasks creation',\r\n    tags: ['Scheduled Tasks']\r\n  }\r\n}, async (request, reply) => {\r\n  try {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä\r\n    if (!request.user.roles.includes('ADMIN')) {\r\n      return reply.code(403).send({\r\n        success: false,\r\n        error: 'Only administrators can trigger scheduled tasks'\r\n      });\r\n    }\r\n\r\n    const result = await scheduledTasks.manualCreateMaintenanceTasks();\r\n\r\n    return {\r\n      success: result,\r\n      message: result ? 'Maintenance tasks created successfully' : 'Failed to create maintenance tasks'\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to create maintenance tasks'\r\n    });\r\n  }\r\n});\r\n\r\nfastify.post('/api/v1/tasks/scheduled/inventory', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    description: 'Manually trigger inventory tasks creation',\r\n    tags: ['Scheduled Tasks']\r\n  }\r\n}, async (request, reply) => {\r\n  try {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä\r\n    if (!request.user.roles.includes('ADMIN')) {\r\n      return reply.code(403).send({\r\n        success: false,\r\n        error: 'Only administrators can trigger scheduled tasks'\r\n      });\r\n    }\r\n\r\n    const result = await scheduledTasks.manualCreateInventoryTasks();\r\n\r\n    return {\r\n      success: result,\r\n      message: result ? 'Inventory tasks created successfully' : 'Failed to create inventory tasks'\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    reply.code(500).send({\r\n      success: false,\r\n      error: 'Failed to create inventory tasks'\r\n    });\r\n  }\r\n});\r\n\r\n// Start server\r\nconst start = async () => {\r\n  try {\r\n    await fastify.listen({ \r\n      port: process.env.PORT || 3004,\r\n      host: '0.0.0.0'\r\n    });\r\n    console.log('Tasks service is running on port', process.env.PORT || 3004);\r\n    \r\n    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∑–∞–¥–∞—á\r\n    if (process.env.ENABLE_SCHEDULED_TASKS !== 'false') {\r\n      scheduledTasks.initScheduledTasks();\r\n      console.log('Scheduled tasks initialized');\r\n    } else {\r\n      console.log('Scheduled tasks disabled');\r\n    }\r\n  } catch (err) {\r\n    fastify.log.error(err);\r\n    process.exit(1);\r\n  }\r\n};\r\n\r\nstart();\r\n\r\n// Graceful shutdown\r\nprocess.on('SIGTERM', async () => {\r\n  await fastify.close();\r\n  await prisma.$disconnect();\r\n  process.exit(0);\r\n});\r\n",
  "update-fastify-dependencies.js": "/**\r\n * VHM24 - Update Fastify Dependencies\r\n * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö Fastify –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö —Å –≤–µ—Ä—Å–∏–µ–π 5.x\r\n */\r\n\r\nconst { spawn } = require('child_process');\r\nconst path = require('path');\r\nconst fs = require('fs');\r\n\r\n// –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\r\nconst services = [\r\n  'services/gateway',\r\n  'services/auth', \r\n  'services/machines',\r\n  'services/inventory',\r\n  'services/tasks',\r\n  'services/bunkers',\r\n  'services/notifications',\r\n  'services/backup',\r\n  'services/monitoring'\r\n];\r\n\r\n// –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\r\nconst dependencies = [\r\n  '@fastify/helmet@^12.0.0',\r\n  '@fastify/cors@^10.0.0', \r\n  '@fastify/rate-limit@^10.0.0',\r\n  '@fastify/jwt@^9.0.0',\r\n  '@fastify/multipart@^9.0.0',\r\n  '@fastify/http-proxy@^11.0.0',\r\n  '@fastify/websocket@^11.0.0',\r\n  '@fastify/static@^8.0.0'\r\n];\r\n\r\nfunction log(message, type = 'info') {\r\n  const timestamp = new Date().toISOString();\r\n  const colors = {\r\n    info: '\\x1b[36m',\r\n    success: '\\x1b[32m',\r\n    warning: '\\x1b[33m',\r\n    error: '\\x1b[31m',\r\n    reset: '\\x1b[0m'\r\n  };\r\n  \r\n  console.log(`${colors[type]}[${timestamp}] ${message}${colors.reset}`);\r\n}\r\n\r\nasync function updateService(servicePath) {\r\n  return new Promise((resolve, reject) => {\r\n    const fullPath = path.join(__dirname, servicePath);\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ package.json\r\n    const packageJsonPath = path.join(fullPath, 'package.json');\r\n    if (!fs.existsSync(packageJsonPath)) {\r\n      log(`‚ö†Ô∏è  Skipping ${servicePath} - no package.json found`, 'warning');\r\n      resolve(false);\r\n      return;\r\n    }\r\n\r\n    log(`üîÑ Updating dependencies for ${servicePath}...`, 'info');\r\n\r\n    const installProcess = spawn('npm', ['install', ...dependencies], {\r\n      cwd: fullPath,\r\n      stdio: ['pipe', 'pipe', 'pipe']\r\n    });\r\n\r\n    let output = '';\r\n    let errorOutput = '';\r\n\r\n    installProcess.stdout.on('data', (data) => {\r\n      output += data.toString();\r\n    });\r\n\r\n    installProcess.stderr.on('data', (data) => {\r\n      errorOutput += data.toString();\r\n    });\r\n\r\n    installProcess.on('close', (code) => {\r\n      if (code === 0) {\r\n        log(`‚úÖ Successfully updated ${servicePath}`, 'success');\r\n        resolve(true);\r\n      } else {\r\n        log(`‚ùå Failed to update ${servicePath}: ${errorOutput}`, 'error');\r\n        resolve(false);\r\n      }\r\n    });\r\n\r\n    installProcess.on('error', (error) => {\r\n      log(`‚ùå Error updating ${servicePath}: ${error.message}`, 'error');\r\n      resolve(false);\r\n    });\r\n  });\r\n}\r\n\r\nasync function updateAllServices() {\r\n  log('üöÄ Starting Fastify dependencies update...', 'info');\r\n  log('=' .repeat(60), 'info');\r\n\r\n  const results = [];\r\n  \r\n  for (const service of services) {\r\n    const result = await updateService(service);\r\n    results.push({ service, success: result });\r\n    \r\n    // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏\r\n    await new Promise(resolve => setTimeout(resolve, 1000));\r\n  }\r\n\r\n  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã\r\n  log('\\nüìä Update Results:', 'info');\r\n  log('=' .repeat(60), 'info');\r\n  \r\n  let successCount = 0;\r\n  results.forEach(result => {\r\n    if (result.success) {\r\n      log(`‚úÖ ${result.service} - Updated`, 'success');\r\n      successCount++;\r\n    } else {\r\n      log(`‚ùå ${result.service} - Failed`, 'error');\r\n    }\r\n  });\r\n\r\n  log(`\\nüéØ Summary: ${successCount}/${services.length} services updated`, \r\n      successCount === services.length ? 'success' : 'warning');\r\n\r\n  if (successCount > 0) {\r\n    log('\\nüí° Next steps:', 'info');\r\n    log('1. Restart services: node start-all-services.js', 'info');\r\n    log('2. Test system: node test-system-comprehensive.js', 'info');\r\n    log('3. Start web dashboard: node start-dashboard.js', 'info');\r\n  }\r\n\r\n  return successCount;\r\n}\r\n\r\n// –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ\r\nif (require.main === module) {\r\n  updateAllServices().catch(error => {\r\n    log(`‚ùå Failed to update services: ${error.message}`, 'error');\r\n    process.exit(1);\r\n  });\r\n}\r\n\r\nmodule.exports = { updateAllServices };\r\n",
  "update-fastify.js": "/**\r\n * VHM24 - Update Fastify Dependencies\r\n * \r\n * –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç fastify –∏ –µ–≥–æ –ø–ª–∞–≥–∏–Ω—ã –≤–æ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö\r\n * –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –≤–µ—Ä—Å–∏–π\r\n */\r\n\r\nconst { execSync } = require('child_process');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\n// –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤\r\nconst services = [\r\n  'auth',\r\n  'machines',\r\n  'inventory',\r\n  'tasks',\r\n  'bunkers',\r\n  'gateway'\r\n];\r\n\r\n// –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\r\nconst dependencies = [\r\n  'fastify@5.x',\r\n  '@fastify/jwt@latest',\r\n  '@fastify/cors@latest',\r\n  '@fastify/helmet@latest',\r\n  '@fastify/rate-limit@latest',\r\n  '@fastify/swagger@latest'\r\n];\r\n\r\nconsole.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Fastify –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤...\\n');\r\n\r\n// –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞\r\nservices.forEach(service => {\r\n  const servicePath = path.join(__dirname, 'services', service);\r\n  \r\n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–µ—Ä–≤–∏—Å–∞\r\n  if (!fs.existsSync(servicePath)) {\r\n    console.log(`‚ö†Ô∏è –°–µ—Ä–≤–∏—Å ${service} –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º...`);\r\n    return;\r\n  }\r\n  \r\n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ package.json\r\n  const packageJsonPath = path.join(servicePath, 'package.json');\r\n  if (!fs.existsSync(packageJsonPath)) {\r\n    console.log(`‚ö†Ô∏è package.json –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ ${service} –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º...`);\r\n    return;\r\n  }\r\n  \r\n  console.log(`\\nüì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ ${service}...`);\r\n  \r\n  try {\r\n    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏\r\n    const command = `cd ${servicePath} && npm install ${dependencies.join(' ')} --save`;\r\n    execSync(command, { stdio: 'inherit' });\r\n    console.log(`‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ ${service} —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã`);\r\n  } catch (error) {\r\n    console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ ${service}:`, error.message);\r\n  }\r\n});\r\n\r\nconsole.log('\\n‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ!');\r\n",
  "apps/web-dashboard/next.config.js": "/** @type {import('next').NextConfig} */\r\nconst nextConfig = {\r\n  env: {\r\n    NEXT_PUBLIC_API_URL: process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000',\r\n  },\r\n  async rewrites() {\r\n    return [\r\n      {\r\n        source: '/api/:path*',\r\n        destination: `${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/api/:path*`,\r\n      },\r\n    ];\r\n  },\r\n  // –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –Ω–µ–∫–æ—Ç–æ—Ä—ã–º–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏\r\n  reactStrictMode: false,\r\n  \r\n  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è production\r\n  swcMinify: true,\r\n  \r\n  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π\r\n  images: {\r\n    domains: ['localhost'],\r\n  },\r\n  \r\n  // –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏\r\n  experimental: {\r\n    appDir: true,\r\n  },\r\n};\r\n\r\nmodule.exports = nextConfig;\r\n",
  "packages/shared/middleware/index.js": "/**\r\n * VHM24 Shared Middleware\r\n * –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö middleware –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö\r\n */\r\n\r\nconst security = require('./security');\r\nconst validation = require('./validation');\r\nconst errorHandler = require('./errorHandler');\r\n\r\nmodule.exports = {\r\n  // Security middleware\r\n  ...security,\r\n  \r\n  // Validation middleware\r\n  ...validation,\r\n  \r\n  // Error handling middleware\r\n  ...errorHandler,\r\n  \r\n  // –£–¥–æ–±–Ω—ã–µ –∞–ª–∏–∞—Å—ã\r\n  auth: security.authenticate,\r\n  authorize: security.authorize,\r\n  validate: {\r\n    body: validation.validateBody,\r\n    query: validation.validateQuery,\r\n    params: validation.validateParams,\r\n    id: validation.validateId,\r\n    file: validation.validateFile\r\n  },\r\n  errors: {\r\n    handler: errorHandler.errorHandler,\r\n    async: errorHandler.asyncHandler,\r\n    create: errorHandler.createError,\r\n    register: errorHandler.registerErrorHandlers,\r\n    setupGlobal: errorHandler.setupGlobalErrorHandlers\r\n  }\r\n};\r\n",
  "packages/shared/middleware/railway.js": "// Railway-specific middleware\nconst railwayMiddleware = (fastify, options, done) => {\n  // –î–æ–±–∞–≤–ª—è–µ–º Railway health check headers\n  fastify.addHook('onRequest', async (request, reply) => {\n    if (request.url === '/health') {\n      reply.header('X-Railway-Health', 'ok');\n    }\n  });\n  \n  // –û–±—Ä–∞–±–æ—Ç–∫–∞ Railway –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤\n  fastify.addHook('preHandler', async (request, reply) => {\n    // –î–æ–±–∞–≤–ª—è–µ–º Railway request ID –µ—Å–ª–∏ –µ—Å—Ç—å\n    if (request.headers['x-railway-request-id']) {\n      request.railwayRequestId = request.headers['x-railway-request-id'];\n    }\n  });\n  \n  // Graceful shutdown –¥–ª—è Railway\n  const gracefulShutdown = () => {\n    console.log('üõë Received shutdown signal, closing server gracefully...');\n    fastify.close(() => {\n      console.log('‚úÖ Server closed successfully');\n      process.exit(0);\n    });\n  };\n  \n  process.on('SIGTERM', gracefulShutdown);\n  process.on('SIGINT', gracefulShutdown);\n  \n  done();\n};\n\nmodule.exports = railwayMiddleware;",
  "packages/shared/utils/pagination.js": "/**\r\n * VHM24 Pagination Utility\r\n * –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö\r\n */\r\n\r\n/**\r\n * –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –¥–ª—è Prisma\r\n */\r\nconst createPaginationParams = (page = 1, limit = 20) => {\r\n  const pageNum = Math.max(1, parseInt(page, 10));\r\n  const limitNum = Math.min(100, Math.max(1, parseInt(limit, 10))); // –ú–∞–∫—Å–∏–º—É–º 100 –∑–∞–ø–∏—Å–µ–π\r\n  \r\n  const skip = (pageNum - 1) * limitNum;\r\n  \r\n  return {\r\n    skip,\r\n    take: limitNum,\r\n    page: pageNum,\r\n    limit: limitNum\r\n  };\r\n};\r\n\r\n/**\r\n * –°–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –ø–∞–≥–∏–Ω–∞—Ü–∏–∏\r\n */\r\nconst createPaginationMeta = (totalCount, page, limit) => {\r\n  const totalPages = Math.ceil(totalCount / limit);\r\n  const hasNextPage = page < totalPages;\r\n  const hasPrevPage = page > 1;\r\n  \r\n  return {\r\n    currentPage: page,\r\n    totalPages,\r\n    totalCount,\r\n    limit,\r\n    hasNextPage,\r\n    hasPrevPage,\r\n    nextPage: hasNextPage ? page + 1 : null,\r\n    prevPage: hasPrevPage ? page - 1 : null\r\n  };\r\n};\r\n\r\n/**\r\n * –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π\r\n */\r\nconst createPaginatedResponse = (data, totalCount, page, limit, additionalMeta = {}) => {\r\n  const meta = createPaginationMeta(totalCount, page, limit);\r\n  \r\n  return {\r\n    data,\r\n    meta: {\r\n      ...meta,\r\n      ...additionalMeta\r\n    }\r\n  };\r\n};\r\n\r\n/**\r\n * Middleware –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–∞–≥–∏–Ω–∞—Ü–∏–∏\r\n */\r\nconst paginationMiddleware = (defaultLimit = 20, maxLimit = 100) => {\r\n  return async (request, reply) => {\r\n    const page = Math.max(1, parseInt(request.query.page, 10) || 1);\r\n    const limit = Math.min(maxLimit, Math.max(1, parseInt(request.query.limit, 10) || defaultLimit));\r\n    \r\n    // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –≤ request\r\n    request.pagination = createPaginationParams(page, limit);\r\n    \r\n    // –î–æ–±–∞–≤–ª—è–µ–º helper —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞\r\n    request.createPaginatedResponse = (data, totalCount, additionalMeta = {}) => {\r\n      return createPaginatedResponse(data, totalCount, page, limit, additionalMeta);\r\n    };\r\n  };\r\n};\r\n\r\n/**\r\n * –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –º–∞—Å—Å–∏–≤–æ–≤ (–¥–ª—è —Å–ª—É—á–∞–µ–≤ –∫–æ–≥–¥–∞ –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ë–î –ø–∞–≥–∏–Ω–∞—Ü–∏—é)\r\n */\r\nconst paginateArray = (array, page = 1, limit = 20) => {\r\n  const { skip, take } = createPaginationParams(page, limit);\r\n  const totalCount = array.length;\r\n  const data = array.slice(skip, skip + take);\r\n  \r\n  return createPaginatedResponse(data, totalCount, page, limit);\r\n};\r\n\r\n/**\r\n * –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –¥–ª—è Prisma\r\n */\r\nconst createSortParams = (sortBy, sortOrder = 'desc', allowedFields = []) => {\r\n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏\r\n  if (sortBy && allowedFields.length > 0 && !allowedFields.includes(sortBy)) {\r\n    sortBy = allowedFields[0]; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω–æ–µ –ø–æ–ª–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\r\n  }\r\n  \r\n  if (!sortBy) {\r\n    return { createdAt: 'desc' }; // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\r\n  }\r\n  \r\n  const order = ['asc', 'desc'].includes(sortOrder.toLowerCase()) ? sortOrder.toLowerCase() : 'desc';\r\n  \r\n  return { [sortBy]: order };\r\n};\r\n\r\n/**\r\n * –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏\r\n */\r\nconst createQueryParams = (query = {}, allowedSortFields = []) => {\r\n  const { page, limit, sortBy, sortOrder, ...filters } = query;\r\n  \r\n  const pagination = createPaginationParams(page, limit);\r\n  const sorting = createSortParams(sortBy, sortOrder, allowedSortFields);\r\n  \r\n  return {\r\n    ...pagination,\r\n    orderBy: sorting,\r\n    filters\r\n  };\r\n};\r\n\r\n/**\r\n * Middleware –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏\r\n */\r\nconst validatePaginationParams = (maxLimit = 100) => {\r\n  return async (request, reply) => {\r\n    const { page, limit } = request.query;\r\n    \r\n    // –í–∞–ª–∏–¥–∞—Ü–∏—è page\r\n    if (page !== undefined) {\r\n      const pageNum = parseInt(page, 10);\r\n      if (isNaN(pageNum) || pageNum < 1) {\r\n        return reply.code(400).send({\r\n          error: 'Validation Error',\r\n          message: 'Page must be a positive integer',\r\n          statusCode: 400\r\n        });\r\n      }\r\n    }\r\n    \r\n    // –í–∞–ª–∏–¥–∞—Ü–∏—è limit\r\n    if (limit !== undefined) {\r\n      const limitNum = parseInt(limit, 10);\r\n      if (isNaN(limitNum) || limitNum < 1 || limitNum > maxLimit) {\r\n        return reply.code(400).send({\r\n          error: 'Validation Error',\r\n          message: `Limit must be between 1 and ${maxLimit}`,\r\n          statusCode: 400\r\n        });\r\n      }\r\n    }\r\n  };\r\n};\r\n\r\n/**\r\n * –°–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ (–¥–ª—è REST API)\r\n */\r\nconst createPaginationLinks = (baseUrl, page, limit, totalPages) => {\r\n  const createUrl = (pageNum) => {\r\n    const url = new URL(baseUrl);\r\n    url.searchParams.set('page', pageNum.toString());\r\n    url.searchParams.set('limit', limit.toString());\r\n    return url.toString();\r\n  };\r\n  \r\n  const links = {\r\n    self: createUrl(page),\r\n    first: createUrl(1),\r\n    last: createUrl(totalPages)\r\n  };\r\n  \r\n  if (page > 1) {\r\n    links.prev = createUrl(page - 1);\r\n  }\r\n  \r\n  if (page < totalPages) {\r\n    links.next = createUrl(page + 1);\r\n  }\r\n  \r\n  return links;\r\n};\r\n\r\n/**\r\n * Cursor-based –ø–∞–≥–∏–Ω–∞—Ü–∏—è (–¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤)\r\n */\r\nconst createCursorPagination = (cursor, limit = 20, direction = 'forward') => {\r\n  const limitNum = Math.min(100, Math.max(1, parseInt(limit, 10)));\r\n  \r\n  const params = {\r\n    take: direction === 'forward' ? limitNum : -limitNum\r\n  };\r\n  \r\n  if (cursor) {\r\n    params.cursor = { id: cursor };\r\n    params.skip = 1; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∞–º cursor\r\n  }\r\n  \r\n  return params;\r\n};\r\n\r\n/**\r\n * –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è cursor-based –ø–∞–≥–∏–Ω–∞—Ü–∏–∏\r\n */\r\nconst createCursorResponse = (data, hasMore = false, additionalMeta = {}) => {\r\n  const response = {\r\n    data,\r\n    meta: {\r\n      hasMore,\r\n      count: data.length,\r\n      ...additionalMeta\r\n    }\r\n  };\r\n  \r\n  // –î–æ–±–∞–≤–ª—è–µ–º cursors –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ\r\n  if (data.length > 0) {\r\n    response.meta.startCursor = data[0].id;\r\n    response.meta.endCursor = data[data.length - 1].id;\r\n  }\r\n  \r\n  return response;\r\n};\r\n\r\n/**\r\n * –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π\r\n */\r\nconst createSearchParams = (searchQuery, searchFields = [], page = 1, limit = 20) => {\r\n  const pagination = createPaginationParams(page, limit);\r\n  \r\n  let where = {};\r\n  \r\n  if (searchQuery && searchFields.length > 0) {\r\n    where = {\r\n      OR: searchFields.map(field => ({\r\n        [field]: {\r\n          contains: searchQuery,\r\n          mode: 'insensitive'\r\n        }\r\n      }))\r\n    };\r\n  }\r\n  \r\n  return {\r\n    ...pagination,\r\n    where\r\n  };\r\n};\r\n\r\n/**\r\n * –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –¥–∞—à–±–æ—Ä–¥–æ–≤)\r\n */\r\nconst createAggregatedPagination = async (model, aggregateFields = [], page = 1, limit = 20, where = {}) => {\r\n  const { skip, take } = createPaginationParams(page, limit);\r\n  \r\n  // –ü–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ\r\n  const totalCount = await model.count({ where });\r\n  \r\n  // –ü–æ–ª—É—á–∞–µ–º –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\r\n  const aggregateData = await model.aggregate({\r\n    where,\r\n    _count: { _all: true },\r\n    ...aggregateFields.reduce((acc, field) => {\r\n      acc[`_${field.type}`] = { [field.field]: true };\r\n      return acc;\r\n    }, {})\r\n  });\r\n  \r\n  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π\r\n  const data = await model.findMany({\r\n    where,\r\n    skip,\r\n    take,\r\n    orderBy: { createdAt: 'desc' }\r\n  });\r\n  \r\n  return {\r\n    data,\r\n    meta: createPaginationMeta(totalCount, page, limit),\r\n    aggregates: aggregateData\r\n  };\r\n};\r\n\r\nmodule.exports = {\r\n  // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏\r\n  createPaginationParams,\r\n  createPaginationMeta,\r\n  createPaginatedResponse,\r\n  paginateArray,\r\n  \r\n  // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞\r\n  createSortParams,\r\n  createQueryParams,\r\n  \r\n  // Middleware\r\n  paginationMiddleware,\r\n  validatePaginationParams,\r\n  \r\n  // REST API —É—Ç–∏–ª–∏—Ç—ã\r\n  createPaginationLinks,\r\n  \r\n  // Cursor-based –ø–∞–≥–∏–Ω–∞—Ü–∏—è\r\n  createCursorPagination,\r\n  createCursorResponse,\r\n  \r\n  // –ü–æ–∏—Å–∫\r\n  createSearchParams,\r\n  \r\n  // –ê–≥—Ä–µ–≥–∞—Ü–∏—è\r\n  createAggregatedPagination\r\n};\r\n",
  "quick-start.js": "#!/usr/bin/env node\r\n\r\n/**\r\n * VHM24 Quick Start\r\n * –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã VHM24\r\n */\r\n\r\nconst { spawn } = require('child_process');\r\nconst path = require('path');\r\n\r\nconsole.log('üöÄ –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ VHM24...\\n');\r\n\r\n// –°–µ—Ä–≤–∏—Å—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞\r\nconst services = [\r\n  {\r\n    name: 'Gateway',\r\n    script: 'services/gateway/src/index.js',\r\n    port: 8000,\r\n    color: '\\x1b[36m' // cyan\r\n  },\r\n  {\r\n    name: 'Auth',\r\n    script: 'services/auth/src/index.js',\r\n    port: 3001,\r\n    color: '\\x1b[32m' // green\r\n  },\r\n  {\r\n    name: 'Machines',\r\n    script: 'services/machines/src/index.js',\r\n    port: 3002,\r\n    color: '\\x1b[33m' // yellow\r\n  },\r\n  {\r\n    name: 'Notifications',\r\n    script: 'services/notifications/src/index.js',\r\n    port: 3006,\r\n    color: '\\x1b[35m' // magenta\r\n  },\r\n  {\r\n    name: 'Audit',\r\n    script: 'services/audit/src/index.js',\r\n    port: 3007,\r\n    color: '\\x1b[34m' // blue\r\n  }\r\n];\r\n\r\nconst processes = [];\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞\r\nfunction startService(service) {\r\n  return new Promise((resolve) => {\r\n    console.log(`${service.color}üîß –ó–∞–ø—É—Å–∫ ${service.name}...\\x1b[0m`);\r\n    \r\n    const childProcess = spawn('node', [service.script], {\r\n      cwd: __dirname,\r\n      stdio: 'pipe',\r\n      env: {\r\n        ...process.env,\r\n        PORT: service.port\r\n      }\r\n    });\r\n\r\n    let started = false;\r\n\r\n    childProcess.stdout.on('data', (data) => {\r\n      const output = data.toString();\r\n      console.log(`${service.color}[${service.name}]\\x1b[0m ${output.trim()}`);\r\n      \r\n      if (!started && (output.includes('listening') || output.includes('running') || output.includes('started'))) {\r\n        started = true;\r\n        console.log(`${service.color}‚úÖ ${service.name} –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${service.port}\\x1b[0m`);\r\n        resolve(childProcess);\r\n      }\r\n    });\r\n\r\n    childProcess.stderr.on('data', (data) => {\r\n      const output = data.toString();\r\n      if (!output.includes('ExperimentalWarning')) {\r\n        console.log(`${service.color}[${service.name} ERROR]\\x1b[0m ${output.trim()}`);\r\n      }\r\n    });\r\n\r\n    childProcess.on('close', (code) => {\r\n      console.log(`${service.color}‚ùå ${service.name} –∑–∞–≤–µ—Ä—à–µ–Ω —Å –∫–æ–¥–æ–º ${code}\\x1b[0m`);\r\n    });\r\n\r\n    childProcess.on('error', (error) => {\r\n      console.log(`${service.color}üí• –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ ${service.name}: ${error.message}\\x1b[0m`);\r\n      if (!started) {\r\n        resolve(null);\r\n      }\r\n    });\r\n\r\n    processes.push(childProcess);\r\n\r\n    // –¢–∞–π–º–∞—É—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞\r\n    setTimeout(() => {\r\n      if (!started) {\r\n        console.log(`${service.color}‚ö†Ô∏è  ${service.name} –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –º–µ–¥–ª–µ–Ω–Ω–æ...\\x1b[0m`);\r\n        resolve(childProcess);\r\n      }\r\n    }, 5000);\r\n  });\r\n}\r\n\r\n// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è\r\nasync function main() {\r\n  console.log('üîß –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ VHM24...\\n');\r\n\r\n  // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ\r\n  for (const service of services) {\r\n    await startService(service);\r\n    // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏\r\n    await new Promise(resolve => setTimeout(resolve, 1000));\r\n  }\r\n\r\n  console.log('\\nüéâ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã!');\r\n  console.log('\\nüìã –î–æ—Å—Ç—É–ø–Ω—ã–µ endpoints:');\r\n  console.log('   üåê API Gateway: http://localhost:8000');\r\n  console.log('   üîê Auth Service: http://localhost:3001');\r\n  console.log('   ü§ñ Machines Service: http://localhost:3002');\r\n  console.log('   üîî Notifications Service: http://localhost:3006');\r\n  console.log('   üîç Audit Service: http://localhost:3007');\r\n  \r\n  console.log('\\nüß™ –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—É—Å—Ç–∏—Ç–µ:');\r\n  console.log('   node test-complete-system-with-notifications.js');\r\n  \r\n  console.log('\\nüìä –î–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:');\r\n  console.log('   npm run dashboard');\r\n  \r\n  console.log('\\n‚ö†Ô∏è  –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C');\r\n}\r\n\r\n// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è\r\nprocess.on('SIGINT', () => {\r\n  console.log('\\nüõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤...');\r\n  \r\n  processes.forEach((proc, index) => {\r\n    if (proc && !proc.killed) {\r\n      console.log(`üî¥ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ ${services[index]?.name || '—Å–µ—Ä–≤–∏—Å–∞'}...`);\r\n      proc.kill('SIGTERM');\r\n    }\r\n  });\r\n  \r\n  setTimeout(() => {\r\n    console.log('üëã –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');\r\n    process.exit(0);\r\n  }, 2000);\r\n});\r\n\r\nprocess.on('SIGTERM', () => {\r\n  console.log('\\nüõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è...');\r\n  process.exit(0);\r\n});\r\n\r\n// –ó–∞–ø—É—Å–∫\r\nmain().catch(error => {\r\n  console.error('üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error);\r\n  process.exit(1);\r\n});\r\n",
  "start-all-services-with-audit.js": "#!/usr/bin/env node\r\n\r\nconst { spawn } = require('child_process');\r\nconst path = require('path');\r\nconst fs = require('fs');\r\n\r\nconsole.log('üöÄ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ VHM24 —Å —Å–∏—Å—Ç–µ–º–æ–π –∞—É–¥–∏—Ç–∞...\\n');\r\n\r\n// –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ —Å –∏—Ö –ø–æ—Ä—Ç–∞–º–∏ –∏ –ø—É—Ç—è–º–∏\r\nconst services = [\r\n  {\r\n    name: 'Gateway',\r\n    path: 'services/gateway',\r\n    port: process.env.GATEWAY_PORT || 8000,\r\n    env: { PORT: process.env.GATEWAY_PORT || 8000 },\r\n    icon: 'üåê'\r\n  },\r\n  {\r\n    name: 'Auth',\r\n    path: 'services/auth',\r\n    port: process.env.AUTH_PORT || 3001,\r\n    env: { PORT: process.env.AUTH_PORT || 3001 },\r\n    icon: 'üîê'\r\n  },\r\n  {\r\n    name: 'Machines',\r\n    path: 'services/machines',\r\n    port: process.env.MACHINES_PORT || 3002,\r\n    env: { PORT: process.env.MACHINES_PORT || 3002 },\r\n    icon: 'ü§ñ'\r\n  },\r\n  {\r\n    name: 'Inventory',\r\n    path: 'services/inventory',\r\n    port: process.env.INVENTORY_PORT || 3003,\r\n    env: { PORT: process.env.INVENTORY_PORT || 3003 },\r\n    icon: 'üì¶'\r\n  },\r\n  {\r\n    name: 'Tasks',\r\n    path: 'services/tasks',\r\n    port: process.env.TASKS_PORT || 3004,\r\n    env: { PORT: process.env.TASKS_PORT || 3004 },\r\n    icon: '‚úÖ'\r\n  },\r\n  {\r\n    name: 'Routes',\r\n    path: 'services/routes',\r\n    port: process.env.ROUTES_PORT || 3005,\r\n    env: { PORT: process.env.ROUTES_PORT || 3005 },\r\n    icon: 'üõ£Ô∏è'\r\n  },\r\n  {\r\n    name: 'Warehouse',\r\n    path: 'services/warehouse',\r\n    port: process.env.WAREHOUSE_PORT || 3006,\r\n    env: { PORT: process.env.WAREHOUSE_PORT || 3006 },\r\n    icon: 'üè≠'\r\n  },\r\n  {\r\n    name: 'Recipes',\r\n    path: 'services/recipes',\r\n    port: process.env.RECIPES_PORT || 3007,\r\n    env: { PORT: process.env.RECIPES_PORT || 3007 },\r\n    icon: 'üìã'\r\n  },\r\n  {\r\n    name: 'Notifications',\r\n    path: 'services/notifications',\r\n    port: process.env.NOTIFICATIONS_PORT || 3008,\r\n    env: { PORT: process.env.NOTIFICATIONS_PORT || 3008 },\r\n    icon: 'üîî'\r\n  },\r\n  {\r\n    name: 'Audit',\r\n    path: 'services/audit',\r\n    port: process.env.AUDIT_SERVICE_PORT || 3009,\r\n    env: { \r\n      PORT: process.env.AUDIT_SERVICE_PORT || 3009,\r\n      AUDIT_SERVICE_PORT: process.env.AUDIT_SERVICE_PORT || 3009\r\n    },\r\n    icon: 'üîç'\r\n  },\r\n  {\r\n    name: 'Monitoring',\r\n    path: 'services/monitoring',\r\n    port: process.env.MONITORING_PORT || 3010,\r\n    env: { PORT: process.env.MONITORING_PORT || 3010 },\r\n    icon: 'üìä'\r\n  },\r\n  {\r\n    name: 'Backup',\r\n    path: 'services/backup',\r\n    port: process.env.BACKUP_PORT || 3011,\r\n    env: { PORT: process.env.BACKUP_PORT || 3011 },\r\n    icon: 'üíæ'\r\n  },\r\n  {\r\n    name: 'Data Import',\r\n    path: 'services/data-import',\r\n    port: process.env.DATA_IMPORT_PORT || 3012,\r\n    env: { PORT: process.env.DATA_IMPORT_PORT || 3012 },\r\n    icon: 'üì•'\r\n  }\r\n];\r\n\r\nconst runningProcesses = [];\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —Å–µ—Ä–≤–∏—Å–∞\r\nasync function installDependencies(service) {\r\n  return new Promise((resolve, reject) => {\r\n    const servicePath = path.join(__dirname, service.path);\r\n    \r\n    if (!fs.existsSync(servicePath)) {\r\n      console.log(`‚ö†Ô∏è  –°–µ—Ä–≤–∏—Å ${service.name} –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏ ${servicePath}`);\r\n      resolve();\r\n      return;\r\n    }\r\n\r\n    console.log(`üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è ${service.name}...`);\r\n    \r\n    const installProcess = spawn('npm', ['install'], {\r\n      cwd: servicePath,\r\n      stdio: 'pipe',\r\n      shell: true\r\n    });\r\n\r\n    let output = '';\r\n    installProcess.stdout.on('data', (data) => {\r\n      output += data.toString();\r\n    });\r\n\r\n    installProcess.stderr.on('data', (data) => {\r\n      output += data.toString();\r\n    });\r\n\r\n    installProcess.on('close', (code) => {\r\n      if (code === 0) {\r\n        console.log(`‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è ${service.name} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã`);\r\n        resolve();\r\n      } else {\r\n        console.log(`‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è ${service.name}:`, output);\r\n        resolve(); // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ\r\n      }\r\n    });\r\n\r\n    installProcess.on('error', (error) => {\r\n      console.log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–ª—è ${service.name}:`, error.message);\r\n      resolve();\r\n    });\r\n  });\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞\r\nfunction startService(service) {\r\n  return new Promise((resolve) => {\r\n    const servicePath = path.join(__dirname, service.path);\r\n    \r\n    if (!fs.existsSync(servicePath)) {\r\n      console.log(`‚ö†Ô∏è  –ü—Ä–æ–ø—É—Å–∫ ${service.name} - —Å–µ—Ä–≤–∏—Å –Ω–µ –Ω–∞–π–¥–µ–Ω`);\r\n      resolve();\r\n      return;\r\n    }\r\n\r\n    console.log(`${service.icon} –ó–∞–ø—É—Å–∫ ${service.name} –Ω–∞ –ø–æ—Ä—Ç—É ${service.port}...`);\r\n    \r\n    const serviceProcess = spawn('npm', ['start'], {\r\n      cwd: servicePath,\r\n      stdio: 'pipe',\r\n      shell: true,\r\n      env: {\r\n        ...process.env,\r\n        ...service.env,\r\n        NODE_ENV: process.env.NODE_ENV || 'development'\r\n      }\r\n    });\r\n\r\n    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–≤–æ–¥–∞ —Å–µ—Ä–≤–∏—Å–∞\r\n    serviceProcess.stdout.on('data', (data) => {\r\n      const output = data.toString().trim();\r\n      if (output) {\r\n        console.log(`[${service.name}] ${output}`);\r\n      }\r\n    });\r\n\r\n    serviceProcess.stderr.on('data', (data) => {\r\n      const output = data.toString().trim();\r\n      if (output && !output.includes('ExperimentalWarning')) {\r\n        console.log(`[${service.name}] ‚ö†Ô∏è  ${output}`);\r\n      }\r\n    });\r\n\r\n    serviceProcess.on('close', (code) => {\r\n      console.log(`[${service.name}] üõë –°–µ—Ä–≤–∏—Å –∑–∞–≤–µ—Ä—à–µ–Ω —Å –∫–æ–¥–æ–º ${code}`);\r\n      // –£–¥–∞–ª—è–µ–º –∏–∑ —Å–ø–∏—Å–∫–∞ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤\r\n      const index = runningProcesses.indexOf(serviceProcess);\r\n      if (index > -1) {\r\n        runningProcesses.splice(index, 1);\r\n      }\r\n    });\r\n\r\n    serviceProcess.on('error', (error) => {\r\n      console.log(`[${service.name}] ‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: ${error.message}`);\r\n    });\r\n\r\n    // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤\r\n    runningProcesses.push(serviceProcess);\r\n    \r\n    // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫\r\n    setTimeout(() => {\r\n      resolve();\r\n    }, 2000);\r\n  });\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø–æ—Ä—Ç–∞\r\nfunction checkPort(port) {\r\n  return new Promise((resolve) => {\r\n    const net = require('net');\r\n    const server = net.createServer();\r\n    \r\n    server.listen(port, () => {\r\n      server.once('close', () => {\r\n        resolve(true); // –ü–æ—Ä—Ç —Å–≤–æ–±–æ–¥–µ–Ω\r\n      });\r\n      server.close();\r\n    });\r\n    \r\n    server.on('error', () => {\r\n      resolve(false); // –ü–æ—Ä—Ç –∑–∞–Ω—è—Ç\r\n    });\r\n  });\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–æ–≤\r\nasync function showStatus() {\r\n  console.log('\\nüìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:');\r\n  console.log('‚îÅ'.repeat(50));\r\n  \r\n  for (const service of services) {\r\n    const isPortFree = await checkPort(service.port);\r\n    const status = isPortFree ? '‚ùå –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '‚úÖ –ó–∞–ø—É—â–µ–Ω';\r\n    console.log(`${service.icon} ${service.name.padEnd(15)} ${service.port.toString().padEnd(6)} ${status}`);\r\n  }\r\n  \r\n  console.log('‚îÅ'.repeat(50));\r\n  console.log(`üìà –ó–∞–ø—É—â–µ–Ω–æ —Å–µ—Ä–≤–∏—Å–æ–≤: ${runningProcesses.length}/${services.length}`);\r\n}\r\n\r\n// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞\r\nasync function startAllServices() {\r\n  console.log('üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤...\\n');\r\n  \r\n  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ\r\n  const installPromises = services.map(service => installDependencies(service));\r\n  await Promise.all(installPromises);\r\n  \r\n  console.log('\\nüöÄ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤...\\n');\r\n  \r\n  // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π\r\n  for (const service of services) {\r\n    await startService(service);\r\n  }\r\n  \r\n  console.log('\\nüéâ –í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã!\\n');\r\n  \r\n  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å\r\n  await showStatus();\r\n  \r\n  console.log('\\nüåê –û—Å–Ω–æ–≤–Ω—ã–µ URL:');\r\n  console.log(`   Gateway:    http://localhost:${services[0].port}`);\r\n  console.log(`   Dashboard:  http://localhost:3000 (–∑–∞–ø—É—Å—Ç–∏—Ç–µ –æ—Ç–¥–µ–ª—å–Ω–æ)`);\r\n  console.log(`   Audit:      http://localhost:${services.find(s => s.name === 'Audit').port}`);\r\n  console.log(`   WebSocket:  ws://localhost:${services[0].port}/ws`);\r\n  \r\n  console.log('\\nüìù –ö–æ–º–∞–Ω–¥—ã:');\r\n  console.log('   Ctrl+C     - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã');\r\n  console.log('   npm run dashboard - –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–µ–±-–¥–∞—à–±–æ—Ä–¥');\r\n  console.log('   npm run test-audit - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –∞—É–¥–∏—Ç–∞');\r\n  \r\n  // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å\r\n  setInterval(async () => {\r\n    await showStatus();\r\n  }, 30000); // –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥\r\n}\r\n\r\n// Graceful shutdown\r\nprocess.on('SIGINT', () => {\r\n  console.log('\\nüõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤...');\r\n  \r\n  runningProcesses.forEach((proc, index) => {\r\n    if (proc && !proc.killed) {\r\n      console.log(`üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ ${services[index]?.name || index}...`);\r\n      proc.kill('SIGINT');\r\n    }\r\n  });\r\n  \r\n  setTimeout(() => {\r\n    console.log('üëã –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');\r\n    process.exit(0);\r\n  }, 3000);\r\n});\r\n\r\nprocess.on('SIGTERM', () => {\r\n  console.log('\\nüõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª SIGTERM, –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤...');\r\n  runningProcesses.forEach(proc => {\r\n    if (proc && !proc.killed) {\r\n      proc.kill('SIGTERM');\r\n    }\r\n  });\r\n  process.exit(0);\r\n});\r\n\r\n// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫\r\nprocess.on('uncaughtException', (error) => {\r\n  console.error('üí• –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞:', error);\r\n});\r\n\r\nprocess.on('unhandledRejection', (reason, promise) => {\r\n  console.error('üí• –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–∏—Å–∞:', reason);\r\n});\r\n\r\n// –ó–∞–ø—É—Å–∫\r\nstartAllServices().catch((error) => {\r\n  console.error('üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–∏—Å–æ–≤:', error);\r\n  process.exit(1);\r\n});\r\n",
  "start-all-services.js": "/**\r\n * VHM24 - Start All Services\r\n * –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ —Å–∏—Å—Ç–µ–º—ã\r\n */\r\n\r\nconst { spawn } = require('child_process');\r\nconst path = require('path');\r\nconst fs = require('fs');\r\n\r\n// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤\r\nconst services = [\r\n  { name: 'gateway', port: 8000, path: 'services/gateway/src/index.js' },\r\n  { name: 'auth', port: 3001, path: 'services/auth/src/index.js' },\r\n  { name: 'machines', port: 3002, path: 'services/machines/src/index.js' },\r\n  { name: 'inventory', port: 3003, path: 'services/inventory/src/index.js' },\r\n  { name: 'tasks', port: 3004, path: 'services/tasks/src/index.js' },\r\n  { name: 'bunkers', port: 3005, path: 'services/bunkers/src/index.js' },\r\n  { name: 'notifications', port: 3006, path: 'services/notifications/src/index.js' },\r\n  { name: 'backup', port: 3007, path: 'services/backup/src/index.js' },\r\n  { name: 'monitoring', port: 3008, path: 'services/monitoring/src/index.js' }\r\n];\r\n\r\nconst processes = [];\r\n\r\nfunction log(message, type = 'info') {\r\n  const timestamp = new Date().toISOString();\r\n  const colors = {\r\n    info: '\\x1b[36m',\r\n    success: '\\x1b[32m',\r\n    warning: '\\x1b[33m',\r\n    error: '\\x1b[31m',\r\n    reset: '\\x1b[0m'\r\n  };\r\n  \r\n  console.log(`${colors[type]}[${timestamp}] ${message}${colors.reset}`);\r\n}\r\n\r\nfunction startService(service) {\r\n  return new Promise((resolve, reject) => {\r\n    const servicePath = path.join(__dirname, service.path);\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞\r\n    if (!fs.existsSync(servicePath)) {\r\n      log(`‚ùå Service file not found: ${servicePath}`, 'error');\r\n      resolve(false);\r\n      return;\r\n    }\r\n\r\n    log(`üöÄ Starting ${service.name} service on port ${service.port}...`, 'info');\r\n\r\n    const child = spawn('node', [servicePath], {\r\n      stdio: ['pipe', 'pipe', 'pipe'],\r\n      env: {\r\n        ...process.env,\r\n        PORT: service.port,\r\n        [`${service.name.toUpperCase()}_PORT`]: service.port\r\n      }\r\n    });\r\n\r\n    let started = false;\r\n    const timeout = setTimeout(() => {\r\n      if (!started) {\r\n        log(`‚ö†Ô∏è  ${service.name} service startup timeout`, 'warning');\r\n        resolve(true); // –°—á–∏—Ç–∞–µ–º –∑–∞–ø—É—â–µ–Ω–Ω—ã–º, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è\r\n      }\r\n    }, 5000);\r\n\r\n    child.stdout.on('data', (data) => {\r\n      const output = data.toString();\r\n      if (output.includes('running') || output.includes('listening') || output.includes('started')) {\r\n        if (!started) {\r\n          started = true;\r\n          clearTimeout(timeout);\r\n          log(`‚úÖ ${service.name} service started successfully`, 'success');\r\n          resolve(true);\r\n        }\r\n      }\r\n      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–≤–æ–¥ —Å–µ—Ä–≤–∏—Å–∞ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º\r\n      output.split('\\n').forEach(line => {\r\n        if (line.trim()) {\r\n          console.log(`[${service.name}] ${line}`);\r\n        }\r\n      });\r\n    });\r\n\r\n    child.stderr.on('data', (data) => {\r\n      const error = data.toString();\r\n      error.split('\\n').forEach(line => {\r\n        if (line.trim()) {\r\n          console.log(`[${service.name}] ERROR: ${line}`);\r\n        }\r\n      });\r\n    });\r\n\r\n    child.on('error', (error) => {\r\n      log(`‚ùå Failed to start ${service.name}: ${error.message}`, 'error');\r\n      resolve(false);\r\n    });\r\n\r\n    child.on('exit', (code) => {\r\n      if (code !== 0) {\r\n        log(`‚ùå ${service.name} exited with code ${code}`, 'error');\r\n      }\r\n    });\r\n\r\n    processes.push({ name: service.name, process: child });\r\n  });\r\n}\r\n\r\nasync function startAllServices() {\r\n  log('üöÄ Starting VHM24 Services...', 'info');\r\n  log('=' .repeat(50), 'info');\r\n\r\n  const results = [];\r\n  \r\n  // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π\r\n  for (const service of services) {\r\n    const result = await startService(service);\r\n    results.push({ name: service.name, started: result });\r\n    \r\n    // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏\r\n    await new Promise(resolve => setTimeout(resolve, 1000));\r\n  }\r\n\r\n  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã\r\n  log('\\nüìä Services Status:', 'info');\r\n  log('=' .repeat(50), 'info');\r\n  \r\n  let successCount = 0;\r\n  results.forEach(result => {\r\n    if (result.started) {\r\n      log(`‚úÖ ${result.name} - Running`, 'success');\r\n      successCount++;\r\n    } else {\r\n      log(`‚ùå ${result.name} - Failed`, 'error');\r\n    }\r\n  });\r\n\r\n  log(`\\nüéØ Summary: ${successCount}/${services.length} services started`, \r\n      successCount === services.length ? 'success' : 'warning');\r\n\r\n  if (successCount > 0) {\r\n    log('\\nüåê Available endpoints:', 'info');\r\n    log('‚Ä¢ Gateway: http://localhost:8000', 'info');\r\n    log('‚Ä¢ Health Check: http://localhost:8000/health', 'info');\r\n    log('‚Ä¢ API: http://localhost:8000/api/v1', 'info');\r\n    \r\n    log('\\nüí° Next steps:', 'info');\r\n    log('1. Test services: node test-system-comprehensive.js', 'info');\r\n    log('2. Start web dashboard: cd apps/web-dashboard && npm run dev', 'info');\r\n    log('3. Press Ctrl+C to stop all services', 'info');\r\n  }\r\n\r\n  return successCount;\r\n}\r\n\r\n// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è\r\nprocess.on('SIGINT', () => {\r\n  log('\\nüõë Stopping all services...', 'warning');\r\n  \r\n  processes.forEach(({ name, process }) => {\r\n    log(`Stopping ${name}...`, 'info');\r\n    process.kill('SIGTERM');\r\n  });\r\n\r\n  setTimeout(() => {\r\n    log('All services stopped.', 'success');\r\n    process.exit(0);\r\n  }, 2000);\r\n});\r\n\r\nprocess.on('SIGTERM', () => {\r\n  processes.forEach(({ process }) => {\r\n    process.kill('SIGTERM');\r\n  });\r\n  process.exit(0);\r\n});\r\n\r\n// –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã\r\nif (require.main === module) {\r\n  startAllServices().catch(error => {\r\n    log(`‚ùå Failed to start services: ${error.message}`, 'error');\r\n    process.exit(1);\r\n  });\r\n}\r\n\r\nmodule.exports = { startAllServices, services };\r\n",
  "start-dashboard.js": "/**\r\n * VHM24 - Start Web Dashboard\r\n * –ó–∞–ø—É—Å–∫ –≤–µ–±-–¥–∞—à–±–æ—Ä–¥–∞\r\n */\r\n\r\nconst { spawn } = require('child_process');\r\nconst path = require('path');\r\nconst fs = require('fs');\r\n\r\nfunction log(message, type = 'info') {\r\n  const timestamp = new Date().toISOString();\r\n  const colors = {\r\n    info: '\\x1b[36m',\r\n    success: '\\x1b[32m',\r\n    warning: '\\x1b[33m',\r\n    error: '\\x1b[31m',\r\n    reset: '\\x1b[0m'\r\n  };\r\n  \r\n  console.log(`${colors[type]}[${timestamp}] ${message}${colors.reset}`);\r\n}\r\n\r\nasync function startDashboard() {\r\n  const dashboardPath = path.join(__dirname, 'apps', 'web-dashboard');\r\n  \r\n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏\r\n  if (!fs.existsSync(dashboardPath)) {\r\n    log('‚ùå Web dashboard directory not found', 'error');\r\n    return false;\r\n  }\r\n\r\n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º package.json\r\n  const packageJsonPath = path.join(dashboardPath, 'package.json');\r\n  if (!fs.existsSync(packageJsonPath)) {\r\n    log('‚ùå package.json not found in web dashboard', 'error');\r\n    return false;\r\n  }\r\n\r\n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º node_modules\r\n  const nodeModulesPath = path.join(dashboardPath, 'node_modules');\r\n  if (!fs.existsSync(nodeModulesPath)) {\r\n    log('‚ö†Ô∏è  node_modules not found, installing dependencies...', 'warning');\r\n    \r\n    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏\r\n    const installProcess = spawn('npm', ['install'], {\r\n      cwd: dashboardPath,\r\n      stdio: 'inherit'\r\n    });\r\n\r\n    await new Promise((resolve, reject) => {\r\n      installProcess.on('close', (code) => {\r\n        if (code === 0) {\r\n          log('‚úÖ Dependencies installed successfully', 'success');\r\n          resolve();\r\n        } else {\r\n          log('‚ùå Failed to install dependencies', 'error');\r\n          reject(new Error(`npm install failed with code ${code}`));\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  log('üöÄ Starting web dashboard...', 'info');\r\n\r\n  // –ó–∞–ø—É—Å–∫–∞–µ–º dev —Å–µ—Ä–≤–µ—Ä\r\n  const devProcess = spawn('npm', ['run', 'dev'], {\r\n    cwd: dashboardPath,\r\n    stdio: 'inherit'\r\n  });\r\n\r\n  devProcess.on('error', (error) => {\r\n    log(`‚ùå Failed to start dashboard: ${error.message}`, 'error');\r\n  });\r\n\r\n  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è\r\n  process.on('SIGINT', () => {\r\n    log('\\nüõë Stopping dashboard...', 'warning');\r\n    devProcess.kill('SIGTERM');\r\n    process.exit(0);\r\n  });\r\n\r\n  return true;\r\n}\r\n\r\nif (require.main === module) {\r\n  startDashboard().catch(error => {\r\n    log(`‚ùå Failed to start dashboard: ${error.message}`, 'error');\r\n    process.exit(1);\r\n  });\r\n}\r\n\r\nmodule.exports = { startDashboard };\r\n",
  "fix-all-errors.js": "#!/usr/bin/env node\r\n\r\n/**\r\n * VHM24 - –°–∏—Å—Ç–µ–º–∞ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫\r\n * \r\n * –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç:\r\n * 1. –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–µ–∫—Ç–∞\r\n * 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º\r\n * 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π\r\n * \r\n * –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\r\n * node fix-all-errors.js\r\n */\r\n\r\nconst { execSync } = require('child_process');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\nconst readline = require('readline');\r\n\r\nconst rl = readline.createInterface({\r\n  input: process.stdin,\r\n  output: process.stdout\r\n});\r\n\r\n// –¶–≤–µ—Ç–∞ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏\r\nconst colors = {\r\n  reset: '\\x1b[0m',\r\n  bright: '\\x1b[1m',\r\n  red: '\\x1b[31m',\r\n  green: '\\x1b[32m',\r\n  yellow: '\\x1b[33m',\r\n  blue: '\\x1b[34m',\r\n  magenta: '\\x1b[35m',\r\n  cyan: '\\x1b[36m'\r\n};\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞\r\nfunction log(message, color = 'reset') {\r\n  console.log(`${colors[color]}${message}${colors.reset}`);\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è\r\nfunction confirm(message) {\r\n  return new Promise((resolve) => {\r\n    rl.question(`${colors.yellow}${message} (y/n): ${colors.reset}`, (answer) => {\r\n      resolve(answer.toLowerCase() === 'y');\r\n    });\r\n  });\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞\r\nfunction createBackup() {\r\n  const backupDir = path.join(__dirname, 'backups', `backup-${Date.now()}`);\r\n  fs.mkdirSync(backupDir, { recursive: true });\r\n  \r\n  log('üì¶ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞...', 'cyan');\r\n  \r\n  // –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã, –∫—Ä–æ–º–µ node_modules –∏ backups\r\n  execSync(`xcopy . \"${backupDir}\" /E /H /C /I /Y /EXCLUDE:backups,node_modules,.git`, { stdio: 'inherit' });\r\n  \r\n  log(`‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞ –≤ ${backupDir}`, 'green');\r\n  return backupDir;\r\n}\r\n\r\n// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è\r\nasync function main() {\r\n  log('\\nüîß VHM24 - –°–ò–°–¢–ï–ú–ê –ö–û–ú–ü–õ–ï–ö–°–ù–û–ì–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –û–®–ò–ë–û–ö üîß\\n', 'bright');\r\n  \r\n  // –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é\r\n  const backupDir = createBackup();\r\n  \r\n  // –®–∞–≥ 1: –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–µ–∫—Ç–∞\r\n  log('\\nüìä –®–ê–ì 1: –ê–ù–ê–õ–ò–ó –ü–†–û–ï–ö–¢–ê', 'magenta');\r\n  const analyzeConfirm = await confirm('–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–µ–∫—Ç–∞?');\r\n  \r\n  if (analyzeConfirm) {\r\n    try {\r\n      log('\\n–ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞...', 'cyan');\r\n      execSync('node scripts/project-analyzer.js', { stdio: 'inherit' });\r\n      \r\n      log('\\n‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'green');\r\n      log('üìÑ –û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ ANALYSIS_REPORT.md –∏ analysis-report.json', 'green');\r\n      \r\n      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Ç–∫—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É\r\n      if (fs.existsSync('analysis-report.json')) {\r\n        const report = JSON.parse(fs.readFileSync('analysis-report.json', 'utf8'));\r\n        log('\\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º:', 'cyan');\r\n        log(`üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ: ${report.summary.critical}`, report.summary.critical > 0 ? 'red' : 'green');\r\n        log(`‚ö†Ô∏è –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${report.summary.high}`, report.summary.high > 0 ? 'yellow' : 'green');\r\n        log(`üìù –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${report.summary.medium}`, 'cyan');\r\n        log(`‚ÑπÔ∏è –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${report.summary.low}`, 'blue');\r\n        log(`üìà –í—Å–µ–≥–æ –ø—Ä–æ–±–ª–µ–º: ${report.summary.total}`, 'magenta');\r\n      }\r\n    } catch (error) {\r\n      log(`\\n‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ: ${error.message}`, 'red');\r\n      const continueAnyway = await confirm('–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—à–∏–±–∫—É?');\r\n      if (!continueAnyway) {\r\n        log('\\nüõë –ü—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.', 'yellow');\r\n        rl.close();\r\n        return;\r\n      }\r\n    }\r\n  }\r\n  \r\n  // –®–∞–≥ 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º\r\n  log('\\nüîß –®–ê–ì 2: –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú', 'magenta');\r\n  const fixConfirm = await confirm('–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º?');\r\n  \r\n  if (fixConfirm) {\r\n    try {\r\n      log('\\n–ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ñ–∏–∫—Å–µ—Ä–∞...', 'cyan');\r\n      execSync('node scripts/auto-fixer.js', { stdio: 'inherit' });\r\n      \r\n      log('\\n‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!', 'green');\r\n      log('üìÑ –û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ fix-report.json', 'green');\r\n      \r\n      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Ç–∫—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É\r\n      if (fs.existsSync('fix-report.json')) {\r\n        const report = JSON.parse(fs.readFileSync('fix-report.json', 'utf8'));\r\n        log('\\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:', 'cyan');\r\n        log(`‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: ${report.summary.totalFixed}`, 'green');\r\n        log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏—Å–ø—Ä–∞–≤–∏—Ç—å: ${report.summary.totalFailed}`, report.summary.totalFailed > 0 ? 'red' : 'green');\r\n        log(`üìà –£—Å–ø–µ—à–Ω–æ—Å—Ç—å: ${report.summary.successRate}%`, 'magenta');\r\n      }\r\n    } catch (error) {\r\n      log(`\\n‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏: ${error.message}`, 'red');\r\n      const continueAnyway = await confirm('–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—à–∏–±–∫—É?');\r\n      if (!continueAnyway) {\r\n        log('\\nüõë –ü—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.', 'yellow');\r\n        rl.close();\r\n        return;\r\n      }\r\n    }\r\n  }\r\n  \r\n  // –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ\r\n  log('\\nüß™ –®–ê–ì 3: –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï', 'magenta');\r\n  const testConfirm = await confirm('–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π?');\r\n  \r\n  if (testConfirm) {\r\n    try {\r\n      log('\\n–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤...', 'cyan');\r\n      execSync('node scripts/test-after-fixes.js', { stdio: 'inherit' });\r\n      \r\n      log('\\n‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!', 'green');\r\n    } catch (error) {\r\n      log(`\\n‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: ${error.message}`, 'red');\r\n      const rollbackConfirm = await confirm('–û—Ç–∫–∞—Ç–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è?');\r\n      \r\n      if (rollbackConfirm) {\r\n        log('\\nüîÑ –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π...', 'yellow');\r\n        execSync(`xcopy \"${backupDir}\" . /E /H /C /I /Y`, { stdio: 'inherit' });\r\n        log('\\n‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–∫–∞—á–µ–Ω—ã!', 'green');\r\n      }\r\n    }\r\n  }\r\n  \r\n  // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ\r\n  log('\\nüéâ –ü–†–û–¶–ï–°–° –ó–ê–í–ï–†–®–ï–ù!', 'bright');\r\n  log('üìù –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤–Ω–µ—Å–∏—Ç–µ —Ä—É—á–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è.', 'cyan');\r\n  log('üìã –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ VHM24_FIX_CHECKLIST.md –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏.', 'cyan');\r\n  log('üîí –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ ' + backupDir, 'green');\r\n  \r\n  rl.close();\r\n}\r\n\r\n// –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏\r\nmain().catch(error => {\r\n  log(`\\n‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`, 'red');\r\n  log('üîÑ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏.', 'yellow');\r\n  rl.close();\r\n});\r\n",
  "packages/shared/storage/s3.js": "// S3 Storage Adapter for Railway deployment\nconst AWS = require('aws-sdk');\nconst fs = require('fs');\nconst path = require('path');\n\nclass S3StorageAdapter {\n  constructor() {\n    this.s3 = new AWS.S3({\n      endpoint: process.env.S3_ENDPOINT || 'https://s3.amazonaws.com',\n      accessKeyId: process.env.S3_ACCESS_KEY,\n      secretAccessKey: process.env.S3_SECRET_KEY,\n      region: process.env.S3_REGION || 'us-east-1',\n      s3ForcePathStyle: true,\n      signatureVersion: 'v4'\n    });\n    \n    this.bucket = process.env.S3_BUCKET;\n    \n    if (!this.bucket) {\n      console.warn('‚ö†Ô∏è S3_BUCKET not configured, using local storage fallback');\n    }\n  }\n\n  async upload(key, buffer, contentType = 'application/octet-stream') {\n    if (!this.bucket) {\n      return this.localFallback('upload', key, buffer);\n    }\n    \n    try {\n      const params = {\n        Bucket: this.bucket,\n        Key: key,\n        Body: buffer,\n        ContentType: contentType,\n        ACL: 'public-read'\n      };\n      \n      const result = await this.s3.upload(params).promise();\n      return {\n        success: true,\n        url: result.Location,\n        key: result.Key\n      };\n    } catch (error) {\n      console.error('S3 upload error:', error);\n      return this.localFallback('upload', key, buffer);\n    }\n  }\n  \n  async download(key) {\n    if (!this.bucket) {\n      return this.localFallback('download', key);\n    }\n    \n    try {\n      const params = {\n        Bucket: this.bucket,\n        Key: key\n      };\n      \n      const result = await this.s3.getObject(params).promise();\n      return {\n        success: true,\n        data: result.Body,\n        contentType: result.ContentType\n      };\n    } catch (error) {\n      console.error('S3 download error:', error);\n      return this.localFallback('download', key);\n    }\n  }\n  \n  getSignedUrl(key, expires = 3600) {\n    if (!this.bucket) {\n      return `/uploads/${key}`;\n    }\n    \n    try {\n      return this.s3.getSignedUrl('getObject', {\n        Bucket: this.bucket,\n        Key: key,\n        Expires: expires\n      });\n    } catch (error) {\n      console.error('S3 signed URL error:', error);\n      return `/uploads/${key}`;\n    }\n  }\n  \n  async delete(key) {\n    if (!this.bucket) {\n      return this.localFallback('delete', key);\n    }\n    \n    try {\n      await this.s3.deleteObject({\n        Bucket: this.bucket,\n        Key: key\n      }).promise();\n      \n      return { success: true };\n    } catch (error) {\n      console.error('S3 delete error:', error);\n      return { success: false, error: error.message };\n    }\n  }\n  \n  // –õ–æ–∫–∞–ª—å–Ω—ã–π fallback –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏\n  localFallback(operation, key, data) {\n    const uploadsDir = path.join(process.cwd(), 'uploads');\n    \n    if (!fs.existsSync(uploadsDir)) {\n      fs.mkdirSync(uploadsDir, { recursive: true });\n    }\n    \n    const filePath = path.join(uploadsDir, key);\n    \n    switch (operation) {\n      case 'upload':\n        fs.writeFileSync(filePath, data);\n        return {\n          success: true,\n          url: `/uploads/${key}`,\n          key: key,\n          fallback: true\n        };\n        \n      case 'download':\n        if (fs.existsSync(filePath)) {\n          return {\n            success: true,\n            data: fs.readFileSync(filePath),\n            fallback: true\n          };\n        }\n        return { success: false, error: 'File not found' };\n        \n      case 'delete':\n        if (fs.existsSync(filePath)) {\n          fs.unlinkSync(filePath);\n        }\n        return { success: true, fallback: true };\n        \n      default:\n        return { success: false, error: 'Unknown operation' };\n    }\n  }\n}\n\nmodule.exports = S3StorageAdapter;",
  "packages/shared/storage/s3Storage.js": "const AWS = require('aws-sdk');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\nconst { v4: uuidv4 } = require('uuid');\r\n\r\n// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è S3\r\nconst s3Config = {\r\n  endpoint: process.env.S3_ENDPOINT || 'https://fra1.digitaloceanspaces.com',\r\n  accessKeyId: process.env.S3_ACCESS_KEY,\r\n  secretAccessKey: process.env.S3_SECRET_KEY,\r\n  region: process.env.S3_REGION || 'fra1',\r\n  s3ForcePathStyle: true\r\n};\r\n\r\n// –ò–º—è –±–∞–∫–µ—Ç–∞\r\nconst bucketName = process.env.S3_BUCKET || 'vhm24-uploads';\r\n\r\n// –°–æ–∑–¥–∞–µ–º S3 –∫–ª–∏–µ–Ω—Ç\r\nconst s3 = new AWS.S3(s3Config);\r\n\r\n/**\r\n * –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤ S3\r\n * @param {string} filePath - –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É\r\n * @param {string} key - –ö–ª—é—á —Ñ–∞–π–ª–∞ –≤ S3\r\n * @param {Object} options - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏\r\n * @returns {Promise<string>} - URL –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞\r\n */\r\nasync function uploadFile(filePath, key, options = {}) {\r\n  try {\r\n    const fileContent = fs.readFileSync(filePath);\r\n    \r\n    const params = {\r\n      Bucket: bucketName,\r\n      Key: key,\r\n      Body: fileContent,\r\n      ACL: 'public-read',\r\n      ContentType: options.contentType || 'application/octet-stream',\r\n      ...options\r\n    };\r\n    \r\n    const result = await s3.upload(params).promise();\r\n    return result.Location;\r\n  } catch (error) {\r\n    console.error('Error uploading file to S3:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –≤ S3\r\n * @param {string} filePath - –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É\r\n * @param {string} fileName - –ò–º—è —Ñ–∞–π–ª–∞\r\n * @returns {Promise<string>} - URL –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ\r\n */\r\nasync function uploadPhoto(filePath, fileName) {\r\n  const ext = path.extname(fileName);\r\n  const key = `photos/${uuidv4()}${ext}`;\r\n  \r\n  return uploadFile(filePath, key, {\r\n    ContentType: `image/${ext.substring(1)}` // .jpg -> image/jpg\r\n  });\r\n}\r\n\r\n/**\r\n * –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ S3\r\n * @param {string} filePath - –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É\r\n * @param {string} fileName - –ò–º—è —Ñ–∞–π–ª–∞\r\n * @returns {Promise<string>} - URL –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞\r\n */\r\nasync function uploadDocument(filePath, fileName) {\r\n  const ext = path.extname(fileName);\r\n  const key = `documents/${uuidv4()}${ext}`;\r\n  \r\n  let contentType = 'application/octet-stream';\r\n  \r\n  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º Content-Type –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è\r\n  switch (ext.toLowerCase()) {\r\n    case '.pdf':\r\n      contentType = 'application/pdf';\r\n      break;\r\n    case '.doc':\r\n    case '.docx':\r\n      contentType = 'application/msword';\r\n      break;\r\n    case '.xls':\r\n    case '.xlsx':\r\n      contentType = 'application/vnd.ms-excel';\r\n      break;\r\n    case '.txt':\r\n      contentType = 'text/plain';\r\n      break;\r\n    case '.json':\r\n      contentType = 'application/json';\r\n      break;\r\n    case '.csv':\r\n      contentType = 'text/csv';\r\n      break;\r\n  }\r\n  \r\n  return uploadFile(filePath, key, { ContentType: contentType });\r\n}\r\n\r\n/**\r\n * –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–∞ –≤ S3\r\n * @param {string} filePath - –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É\r\n * @param {string} fileName - –ò–º—è —Ñ–∞–π–ª–∞\r\n * @returns {Promise<string>} - URL –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞\r\n */\r\nasync function uploadReport(filePath, fileName) {\r\n  const ext = path.extname(fileName);\r\n  const key = `reports/${uuidv4()}${ext}`;\r\n  \r\n  return uploadFile(filePath, key);\r\n}\r\n\r\n/**\r\n * –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–∑ S3\r\n * @param {string} fileUrl - URL —Ñ–∞–π–ª–∞\r\n * @returns {Promise<boolean>} - –†–µ–∑—É–ª—å—Ç–∞—Ç —É–¥–∞–ª–µ–Ω–∏—è\r\n */\r\nasync function deleteFile(fileUrl) {\r\n  try {\r\n    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á –∏–∑ URL\r\n    const key = fileUrl.split(`${bucketName}/`)[1];\r\n    \r\n    const params = {\r\n      Bucket: bucketName,\r\n      Key: key\r\n    };\r\n    \r\n    await s3.deleteObject(params).promise();\r\n    return true;\r\n  } catch (error) {\r\n    console.error('Error deleting file from S3:', error);\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ\r\n * @param {string} fileUrl - URL —Ñ–∞–π–ª–∞\r\n * @returns {Promise<Object>} - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ\r\n */\r\nasync function getFileInfo(fileUrl) {\r\n  try {\r\n    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á –∏–∑ URL\r\n    const key = fileUrl.split(`${bucketName}/`)[1];\r\n    \r\n    const params = {\r\n      Bucket: bucketName,\r\n      Key: key\r\n    };\r\n    \r\n    const result = await s3.headObject(params).promise();\r\n    return {\r\n      size: result.ContentLength,\r\n      contentType: result.ContentType,\r\n      lastModified: result.LastModified\r\n    };\r\n  } catch (error) {\r\n    console.error('Error getting file info from S3:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω–æ–≥–æ URL –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞\r\n * @param {string} key - –ö–ª—é—á —Ñ–∞–π–ª–∞ –≤ S3\r\n * @param {number} expiresIn - –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ URL –≤ —Å–µ–∫—É–Ω–¥–∞—Ö\r\n * @returns {string} - –ü–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π URL\r\n */\r\nfunction getSignedUrl(key, expiresIn = 3600) {\r\n  const params = {\r\n    Bucket: bucketName,\r\n    Key: key,\r\n    Expires: expiresIn\r\n  };\r\n  \r\n  return s3.getSignedUrl('getObject', params);\r\n}\r\n\r\nmodule.exports = {\r\n  uploadFile,\r\n  uploadPhoto,\r\n  uploadDocument,\r\n  uploadReport,\r\n  deleteFile,\r\n  getFileInfo,\r\n  getSignedUrl\r\n};\r\n",
  "quick-setup.js": "#!/usr/bin/env node\r\n\r\nconst { spawn, exec } = require('child_process');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\nconsole.log('üöÄ VHM24 Quick Setup & Start');\r\nconsole.log('============================\\n');\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã\r\nfunction runCommand(command, description) {\r\n  return new Promise((resolve, reject) => {\r\n    console.log(`üìã ${description}...`);\r\n    \r\n    const child = exec(command, (error, stdout, stderr) => {\r\n      if (error) {\r\n        console.error(`‚ùå Error: ${error.message}`);\r\n        reject(error);\r\n        return;\r\n      }\r\n      \r\n      if (stderr && !stderr.includes('warning')) {\r\n        console.error(`‚ö†Ô∏è  Warning: ${stderr}`);\r\n      }\r\n      \r\n      if (stdout) {\r\n        console.log(stdout);\r\n      }\r\n      \r\n      console.log(`‚úÖ ${description} completed\\n`);\r\n      resolve();\r\n    });\r\n  });\r\n}\r\n\r\n// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤\r\nfunction checkFiles() {\r\n  console.log('üîç Checking project files...');\r\n  \r\n  const requiredFiles = [\r\n    '.env',\r\n    'package.json',\r\n    'start.js',\r\n    'packages/database/prisma/schema.prisma'\r\n  ];\r\n  \r\n  const missingFiles = requiredFiles.filter(file => !fs.existsSync(file));\r\n  \r\n  if (missingFiles.length > 0) {\r\n    console.log('‚ùå Missing required files:');\r\n    missingFiles.forEach(file => console.log(`   - ${file}`));\r\n    return false;\r\n  }\r\n  \r\n  console.log('‚úÖ All required files present\\n');\r\n  return true;\r\n}\r\n\r\n// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\nfunction checkEnvironment() {\r\n  console.log('üîç Checking environment variables...');\r\n  \r\n  const envContent = fs.readFileSync('.env', 'utf8');\r\n  const hasValidTelegramToken = envContent.includes('TELEGRAM_BOT_TOKEN=') && \r\n                                !envContent.includes('your-telegram-bot-token');\r\n  \r\n  if (!hasValidTelegramToken) {\r\n    console.log('‚ö†Ô∏è  Telegram bot token not configured properly');\r\n    console.log('   Please update TELEGRAM_BOT_TOKEN in .env file\\n');\r\n  } else {\r\n    console.log('‚úÖ Telegram bot token configured\\n');\r\n  }\r\n  \r\n  return hasValidTelegramToken;\r\n}\r\n\r\n// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è\r\nasync function main() {\r\n  try {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã\r\n    if (!checkFiles()) {\r\n      console.log('‚ùå Setup failed: Missing required files');\r\n      process.exit(1);\r\n    }\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ\r\n    const envOk = checkEnvironment();\r\n    \r\n    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏\r\n    await runCommand('npm install', 'Installing dependencies');\r\n    \r\n    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è workspaces\r\n    await runCommand('npm install --workspaces --if-present', 'Installing workspace dependencies');\r\n    \r\n    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma –∫–ª–∏–µ–Ω—Ç\r\n    await runCommand('cd packages/database && npx prisma generate', 'Generating Prisma client');\r\n    \r\n    console.log('üéâ Setup completed successfully!');\r\n    console.log('=====================================\\n');\r\n    \r\n    if (envOk) {\r\n      console.log('üöÄ Starting VHM24 Platform...\\n');\r\n      \r\n      // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–µ–∫—Ç\r\n      const startProcess = spawn('npm', ['start'], {\r\n        stdio: 'inherit',\r\n        shell: true\r\n      });\r\n      \r\n      startProcess.on('close', (code) => {\r\n        console.log(`\\nüìä Process exited with code ${code}`);\r\n      });\r\n      \r\n      startProcess.on('error', (error) => {\r\n        console.error(`‚ùå Failed to start: ${error.message}`);\r\n      });\r\n      \r\n    } else {\r\n      console.log('‚ö†Ô∏è  Please configure environment variables in .env file before starting');\r\n      console.log('   Then run: npm start');\r\n    }\r\n    \r\n  } catch (error) {\r\n    console.error(`‚ùå Setup failed: ${error.message}`);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤\r\nprocess.on('SIGINT', () => {\r\n  console.log('\\nüõë Setup interrupted');\r\n  process.exit(0);\r\n});\r\n\r\n// –ó–∞–ø—É—Å–∫–∞–µ–º\r\nmain();\r\n",
  "railway-readiness-check.js": "#!/usr/bin/env node\r\n\r\n/**\r\n * VHM24 Railway Readiness Check\r\n * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞ –∫ –¥–µ–ø–ª–æ—é –Ω–∞ Railway\r\n */\r\n\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\n// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\ntry {\r\n  require('dotenv').config();\r\n} catch (error) {\r\n  console.log('‚ö†Ô∏è  dotenv not available, using environment variables');\r\n}\r\n\r\nconsole.log('üîç VHM24 Railway Readiness Check');\r\nconsole.log('================================\\n');\r\n\r\nlet allChecksPass = true;\r\nconst issues = [];\r\nconst warnings = [];\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏\r\nfunction check(name, condition, errorMsg, warningMsg = null) {\r\n  if (condition) {\r\n    console.log(`‚úÖ ${name}`);\r\n    return true;\r\n  } else {\r\n    console.log(`‚ùå ${name}`);\r\n    if (warningMsg) {\r\n      warnings.push(`‚ö†Ô∏è  ${name}: ${warningMsg}`);\r\n    } else {\r\n      issues.push(`‚ùå ${name}: ${errorMsg}`);\r\n      allChecksPass = false;\r\n    }\r\n    return false;\r\n  }\r\n}\r\n\r\n// 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤\r\nconsole.log('üìÅ File Structure Check:');\r\ncheck('package.json exists', fs.existsSync('package.json'), 'package.json not found');\r\ncheck('railway-start-final.js exists', fs.existsSync('railway-start-final.js'), 'railway-start-final.js not found');\r\ncheck('nixpacks.toml exists', fs.existsSync('nixpacks.toml'), 'nixpacks.toml not found');\r\ncheck('.railwayignore exists', fs.existsSync('.railwayignore'), '.railwayignore not found');\r\ncheck('railway.json exists', fs.existsSync('railway.json'), 'railway.json not found');\r\n\r\n// 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ Prisma\r\nconsole.log('\\nüóÑÔ∏è  Database Check:');\r\nconst schemaPath = 'packages/database/prisma/schema.prisma';\r\ncheck('Prisma schema exists', fs.existsSync(schemaPath), 'Prisma schema not found');\r\n\r\n// 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\nconsole.log('\\nüîê Environment Variables Check:');\r\n\r\n// –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ\r\nconst criticalVars = [\r\n  'DATABASE_URL',\r\n  'JWT_SECRET',\r\n  'TELEGRAM_BOT_TOKEN',\r\n  'ADMIN_IDS'\r\n];\r\n\r\ncriticalVars.forEach(varName => {\r\n  const value = process.env[varName];\r\n  check(`${varName} is set`, !!value, `${varName} is required for Railway deployment`);\r\n  \r\n  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏\r\n  if (varName === 'JWT_SECRET' && value) {\r\n    check(`${varName} is secure`, value.length >= 32, `${varName} should be at least 32 characters long`);\r\n    check(`${varName} is not default`, !value.includes('change-this'), `${varName} should be changed from default value`, 'Using default JWT secret is not secure for production');\r\n  }\r\n  \r\n  if (varName === 'DATABASE_URL' && value) {\r\n    check(`${varName} is Railway PostgreSQL`, value.includes('railway') || value.includes('postgres'), `${varName} should be Railway PostgreSQL URL`);\r\n  }\r\n  \r\n  if (varName === 'TELEGRAM_BOT_TOKEN' && value) {\r\n    check(`${varName} format is valid`, value.includes(':'), `${varName} should be in format: XXXXXXXXX:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX`);\r\n  }\r\n});\r\n\r\n// –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ\r\nconsole.log('\\nüîß Optional Variables Check:');\r\nconst optionalVars = [\r\n  'REDIS_URL',\r\n  'NODE_ENV',\r\n  'ALLOWED_ORIGINS'\r\n];\r\n\r\noptionalVars.forEach(varName => {\r\n  const value = process.env[varName];\r\n  check(`${varName} is set`, !!value, `${varName} is recommended but not required`, `${varName} not set - using defaults`);\r\n});\r\n\r\n// 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ package.json\r\nconsole.log('\\nüì¶ Package.json Check:');\r\ntry {\r\n  const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));\r\n  \r\n  check('start script exists', !!packageJson.scripts?.start, 'start script not found in package.json');\r\n  check('start script points to railway-start-final.js', \r\n    packageJson.scripts?.start === 'node railway-start-final.js', \r\n    'start script should be \"node railway-start-final.js\"');\r\n  \r\n  check('Node.js version specified', !!packageJson.engines?.node, 'Node.js version not specified in engines');\r\n  check('npm version specified', !!packageJson.engines?.npm, 'npm version not specified in engines');\r\n  \r\n} catch (error) {\r\n  issues.push('‚ùå Failed to parse package.json');\r\n  allChecksPass = false;\r\n}\r\n\r\n// 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ nixpacks.toml\r\nconsole.log('\\nüöÇ Nixpacks Configuration Check:');\r\ntry {\r\n  const nixpacksContent = fs.readFileSync('nixpacks.toml', 'utf8');\r\n  \r\n  check('nixpacks.toml has start command', nixpacksContent.includes('[start]'), 'start section not found in nixpacks.toml');\r\n  check('start command is npm start', nixpacksContent.includes('cmd = \"npm start\"'), 'start command should be \"npm start\"');\r\n  check('Node.js setup configured', nixpacksContent.includes('nodejs'), 'Node.js not configured in nixpacks.toml');\r\n  \r\n} catch (error) {\r\n  issues.push('‚ùå Failed to read nixpacks.toml');\r\n  allChecksPass = false;\r\n}\r\n\r\n// 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤\r\nconsole.log('\\nüöÄ Services Check:');\r\nconst services = [\r\n  'services/auth/src/index.js',\r\n  'services/gateway/src/index.js',\r\n  'services/machines/src/index.js',\r\n  'services/inventory/src/index.js',\r\n  'services/tasks/src/index.js',\r\n  'services/bunkers/src/index.js',\r\n  'services/notifications/src/index.js',\r\n  'services/telegram-bot/src/index.js'\r\n];\r\n\r\nservices.forEach(servicePath => {\r\n  const serviceName = servicePath.split('/')[1];\r\n  check(`${serviceName} service exists`, fs.existsSync(servicePath), `${servicePath} not found`);\r\n});\r\n\r\n// 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π\r\nconsole.log('\\nüìö Dependencies Check:');\r\ncheck('node_modules exists', fs.existsSync('node_modules'), 'Dependencies not installed - run npm install');\r\n\r\n// –†–µ–∑—É–ª—å—Ç–∞—Ç—ã\r\nconsole.log('\\n' + '='.repeat(50));\r\nconsole.log('üìä READINESS REPORT');\r\nconsole.log('='.repeat(50));\r\n\r\nif (allChecksPass && issues.length === 0) {\r\n  console.log('üéâ ‚úÖ ALL CHECKS PASSED!');\r\n  console.log('üöÇ Project is ready for Railway deployment!');\r\n  \r\n  if (warnings.length > 0) {\r\n    console.log('\\n‚ö†Ô∏è  Warnings (non-critical):');\r\n    warnings.forEach(warning => console.log(warning));\r\n  }\r\n  \r\n  console.log('\\nüöÄ Next steps:');\r\n  console.log('1. git add .');\r\n  console.log('2. git commit -m \"Ready for Railway deployment\"');\r\n  console.log('3. git push origin main');\r\n  console.log('4. Railway will automatically deploy');\r\n  \r\n} else {\r\n  console.log('‚ùå DEPLOYMENT NOT READY');\r\n  console.log('\\nüîß Issues to fix:');\r\n  issues.forEach(issue => console.log(issue));\r\n  \r\n  if (warnings.length > 0) {\r\n    console.log('\\n‚ö†Ô∏è  Warnings:');\r\n    warnings.forEach(warning => console.log(warning));\r\n  }\r\n  \r\n  console.log('\\nüìù Please fix the issues above before deploying to Railway.');\r\n}\r\n\r\nconsole.log('\\nüìû For help, check:');\r\nconsole.log('- RAILWAY_FINAL_SOLUTION.md');\r\nconsole.log('- ENVIRONMENT_VARIABLES_CHECK.md');\r\nconsole.log('- Railway logs: railway logs');\r\n\r\nprocess.exit(allChecksPass ? 0 : 1);\r\n",
  "scripts/check-railway-compatibility.js": "const fs = require('fs');\r\nconst path = require('path');\r\n\r\nconsole.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Railway...\\n');\r\n\r\nconst checks = {\r\n  'Monorepo structure': checkMonorepoStructure(),\r\n  'Package.json in root': fs.existsSync('package.json'),\r\n  'Start scripts': checkStartScripts(),\r\n  'Port configuration': checkPortConfig(),\r\n  'Database compatibility': checkDatabase(),\r\n  'File storage': checkFileStorage(),\r\n  'Environment variables': checkEnvVars(),\r\n  'Docker configuration': checkDockerConfig(),\r\n  'Service dependencies': checkServiceDependencies()\r\n};\r\n\r\nfunction checkMonorepoStructure() {\r\n  return fs.existsSync('services') && fs.existsSync('packages');\r\n}\r\n\r\nfunction checkStartScripts() {\r\n  try {\r\n    const services = fs.readdirSync('services');\r\n    let allHaveScripts = true;\r\n    const serviceScripts = {};\r\n    \r\n    services.forEach(service => {\r\n      const pkgPath = path.join('services', service, 'package.json');\r\n      if (fs.existsSync(pkgPath)) {\r\n        const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));\r\n        const hasStart = pkg.scripts && (pkg.scripts.start || pkg.scripts.dev);\r\n        serviceScripts[service] = hasStart;\r\n        if (!hasStart) allHaveScripts = false;\r\n      } else {\r\n        serviceScripts[service] = false;\r\n        allHaveScripts = false;\r\n      }\r\n    });\r\n    \r\n    console.log('üì¶ Service start scripts:');\r\n    Object.entries(serviceScripts).forEach(([service, hasScript]) => {\r\n      console.log(`  ${hasScript ? '‚úÖ' : '‚ùå'} ${service}`);\r\n    });\r\n    \r\n    return allHaveScripts;\r\n  } catch (error) {\r\n    console.error('Error checking start scripts:', error.message);\r\n    return false;\r\n  }\r\n}\r\n\r\nfunction checkPortConfig() {\r\n  try {\r\n    const services = fs.readdirSync('services');\r\n    const portIssues = [];\r\n    \r\n    services.forEach(service => {\r\n      const indexPath = path.join('services', service, 'src', 'index.js');\r\n      if (fs.existsSync(indexPath)) {\r\n        const content = fs.readFileSync(indexPath, 'utf8');\r\n        \r\n        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ hardcoded –ø–æ—Ä—Ç—ã\r\n        if (content.includes('const PORT =') && !content.includes('process.env.PORT')) {\r\n          portIssues.push(`${service}: hardcoded port detected`);\r\n        }\r\n      }\r\n    });\r\n    \r\n    if (portIssues.length > 0) {\r\n      console.log('‚ö†Ô∏è Port configuration issues:');\r\n      portIssues.forEach(issue => console.log(`  - ${issue}`));\r\n    }\r\n    \r\n    return portIssues.length === 0;\r\n  } catch (error) {\r\n    console.error('Error checking port config:', error.message);\r\n    return false;\r\n  }\r\n}\r\n\r\nfunction checkDatabase() {\r\n  const hasEnv = fs.existsSync('.env');\r\n  const hasPrisma = fs.existsSync('packages/database/prisma/schema.prisma');\r\n  \r\n  if (hasEnv) {\r\n    const envContent = fs.readFileSync('.env', 'utf8');\r\n    const hasDatabaseUrl = envContent.includes('DATABASE_URL');\r\n    \r\n    console.log('üóÑÔ∏è Database configuration:');\r\n    console.log(`  ${hasDatabaseUrl ? '‚úÖ' : '‚ùå'} DATABASE_URL found`);\r\n    console.log(`  ${hasPrisma ? '‚úÖ' : '‚ùå'} Prisma schema exists`);\r\n    \r\n    return hasDatabaseUrl && hasPrisma;\r\n  }\r\n  \r\n  return false;\r\n}\r\n\r\nfunction checkFileStorage() {\r\n  // MinIO –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ Railway - –Ω—É–∂–µ–Ω –≤–Ω–µ—à–Ω–∏–π S3\r\n  const hasMinIO = fs.existsSync('docker-compose.yml') && \r\n    fs.readFileSync('docker-compose.yml', 'utf8').includes('minio');\r\n  \r\n  const hasS3Adapter = fs.existsSync('packages/shared/storage') ||\r\n    fs.existsSync('packages/shared/utils') && \r\n    fs.readFileSync('packages/shared/utils/index.js', 'utf8').includes('s3');\r\n  \r\n  console.log('üìÅ File storage:');\r\n  console.log(`  ${hasMinIO ? '‚ö†Ô∏è' : '‚úÖ'} MinIO detected (needs S3 replacement)`);\r\n  console.log(`  ${hasS3Adapter ? '‚úÖ' : '‚ùå'} S3 adapter available`);\r\n  \r\n  return !hasMinIO || hasS3Adapter;\r\n}\r\n\r\nfunction checkEnvVars() {\r\n  const required = [\r\n    'DATABASE_URL',\r\n    'JWT_SECRET',\r\n    'REDIS_URL'\r\n  ];\r\n  \r\n  const optional = [\r\n    'TELEGRAM_BOT_TOKEN',\r\n    'S3_BUCKET',\r\n    'S3_ACCESS_KEY',\r\n    'S3_SECRET_KEY'\r\n  ];\r\n  \r\n  if (!fs.existsSync('.env')) {\r\n    console.log('‚ùå .env file not found');\r\n    return false;\r\n  }\r\n  \r\n  const env = fs.readFileSync('.env', 'utf8');\r\n  const missing = required.filter(v => !env.includes(v));\r\n  const missingOptional = optional.filter(v => !env.includes(v));\r\n  \r\n  console.log('üîê Environment variables:');\r\n  required.forEach(v => {\r\n    console.log(`  ${env.includes(v) ? '‚úÖ' : '‚ùå'} ${v} (required)`);\r\n  });\r\n  \r\n  optional.forEach(v => {\r\n    console.log(`  ${env.includes(v) ? '‚úÖ' : '‚ö†Ô∏è'} ${v} (optional)`);\r\n  });\r\n  \r\n  return missing.length === 0;\r\n}\r\n\r\nfunction checkDockerConfig() {\r\n  const hasDockerCompose = fs.existsSync('docker-compose.yml');\r\n  const hasDockerfile = fs.existsSync('Dockerfile');\r\n  \r\n  console.log('üê≥ Docker configuration:');\r\n  console.log(`  ${hasDockerCompose ? '‚úÖ' : '‚ùå'} docker-compose.yml`);\r\n  console.log(`  ${hasDockerfile ? '‚úÖ' : '‚ùå'} Dockerfile`);\r\n  \r\n  return hasDockerCompose;\r\n}\r\n\r\nfunction checkServiceDependencies() {\r\n  try {\r\n    const services = fs.readdirSync('services');\r\n    const dependencyIssues = [];\r\n    \r\n    services.forEach(service => {\r\n      const pkgPath = path.join('services', service, 'package.json');\r\n      if (fs.existsSync(pkgPath)) {\r\n        const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));\r\n        \r\n        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏\r\n        if (pkg.dependencies) {\r\n          Object.entries(pkg.dependencies).forEach(([dep, version]) => {\r\n            if (version.includes('^0.') || version.includes('~0.')) {\r\n              dependencyIssues.push(`${service}: ${dep}@${version} (potentially unstable)`);\r\n            }\r\n          });\r\n        }\r\n      }\r\n    });\r\n    \r\n    if (dependencyIssues.length > 0) {\r\n      console.log('‚ö†Ô∏è Dependency issues:');\r\n      dependencyIssues.forEach(issue => console.log(`  - ${issue}`));\r\n    }\r\n    \r\n    return dependencyIssues.length === 0;\r\n  } catch (error) {\r\n    console.error('Error checking dependencies:', error.message);\r\n    return false;\r\n  }\r\n}\r\n\r\n// –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤\r\nconsole.log('\\nüìä Railway Compatibility Report:');\r\nconsole.log('================================');\r\n\r\nObject.entries(checks).forEach(([check, passed]) => {\r\n  console.log(`${passed ? '‚úÖ' : '‚ùå'} ${check}`);\r\n});\r\n\r\n// –ü–æ–¥—Å—á–µ—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏\r\nconst passedChecks = Object.values(checks).filter(Boolean).length;\r\nconst totalChecks = Object.keys(checks).length;\r\nconst compatibilityScore = Math.round((passedChecks / totalChecks) * 100);\r\n\r\nconsole.log(`\\nüéØ Compatibility Score: ${compatibilityScore}%`);\r\n\r\nif (compatibilityScore >= 80) {\r\n  console.log('‚úÖ Project is ready for Railway deployment with minor fixes');\r\n} else if (compatibilityScore >= 60) {\r\n  console.log('‚ö†Ô∏è Project needs moderate changes for Railway deployment');\r\n} else {\r\n  console.log('‚ùå Project needs significant changes for Railway deployment');\r\n}\r\n\r\n// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤\r\nconst report = {\r\n  timestamp: new Date().toISOString(),\r\n  compatibilityScore,\r\n  checks,\r\n  recommendations: generateRecommendations(checks)\r\n};\r\n\r\nfs.writeFileSync('railway-compatibility-report.json', JSON.stringify(report, null, 2));\r\nconsole.log('\\nüìÑ Detailed report saved to: railway-compatibility-report.json');\r\n\r\nfunction generateRecommendations(checks) {\r\n  const recommendations = [];\r\n  \r\n  if (!checks['Port configuration']) {\r\n    recommendations.push('Fix hardcoded ports to use process.env.PORT');\r\n  }\r\n  \r\n  if (!checks['File storage']) {\r\n    recommendations.push('Replace MinIO with external S3 service');\r\n  }\r\n  \r\n  if (!checks['Environment variables']) {\r\n    recommendations.push('Add missing environment variables');\r\n  }\r\n  \r\n  if (!checks['Start scripts']) {\r\n    recommendations.push('Add start scripts to all services');\r\n  }\r\n  \r\n  return recommendations;\r\n}\r\n",
  "scripts/safe-fixes.js": "const fs = require('fs');\r\nconst path = require('path');\r\n\r\nclass SafeFixer {\r\n  constructor() {\r\n    this.backups = [];\r\n    this.changes = [];\r\n  }\r\n\r\n  // –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏\r\n  backup(filePath) {\r\n    if (!fs.existsSync(filePath)) {\r\n      console.log(`‚ö†Ô∏è File not found: ${filePath}`);\r\n      return false;\r\n    }\r\n    \r\n    const content = fs.readFileSync(filePath, 'utf8');\r\n    const backupPath = `${filePath}.backup.${Date.now()}`;\r\n    fs.writeFileSync(backupPath, content);\r\n    this.backups.push({ original: filePath, backup: backupPath });\r\n    console.log(`üì¶ Backup created: ${backupPath}`);\r\n    return true;\r\n  }\r\n\r\n  // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞\r\n  safeModify(filePath, modifier, description) {\r\n    try {\r\n      if (!this.backup(filePath)) {\r\n        this.changes.push({ file: filePath, success: false, error: 'File not found' });\r\n        return;\r\n      }\r\n      \r\n      const content = fs.readFileSync(filePath, 'utf8');\r\n      const modified = modifier(content);\r\n      \r\n      if (content === modified) {\r\n        console.log(`‚ÑπÔ∏è No changes needed: ${filePath}`);\r\n        this.changes.push({ file: filePath, success: true, description, noChanges: true });\r\n        return;\r\n      }\r\n      \r\n      fs.writeFileSync(filePath, modified);\r\n      this.changes.push({ file: filePath, success: true, description });\r\n      console.log(`‚úÖ Modified: ${filePath} - ${description}`);\r\n    } catch (error) {\r\n      console.error(`‚ùå Failed to modify ${filePath}: ${error.message}`);\r\n      this.changes.push({ file: filePath, success: false, error: error.message, description });\r\n    }\r\n  }\r\n\r\n  // –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π\r\n  rollback() {\r\n    console.log('üîÑ Rolling back changes...');\r\n    for (const { original, backup } of this.backups.reverse()) {\r\n      try {\r\n        fs.copyFileSync(backup, original);\r\n        fs.unlinkSync(backup);\r\n        console.log(`‚Ü©Ô∏è Restored: ${original}`);\r\n      } catch (error) {\r\n        console.error(`‚ùå Failed to restore ${original}: ${error.message}`);\r\n      }\r\n    }\r\n  }\r\n\r\n  // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ PORT –¥–ª—è Railway\r\n  fixPortConfiguration() {\r\n    console.log('\\nüîß Fixing PORT configuration for Railway...');\r\n    \r\n    const services = fs.readdirSync('services');\r\n    \r\n    for (const service of services) {\r\n      const indexPath = path.join('services', service, 'src', 'index.js');\r\n      \r\n      if (fs.existsSync(indexPath)) {\r\n        this.safeModify(indexPath, (content) => {\r\n          // –ó–∞–º–µ–Ω—è–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ—Ä—Ç—ã –Ω–∞ process.env.PORT\r\n          if (content.includes('const PORT =') && !content.includes('process.env.PORT')) {\r\n            const servicePortMap = {\r\n              'gateway': '8000',\r\n              'auth': '3001',\r\n              'machines': '3002',\r\n              'inventory': '3003',\r\n              'tasks': '3004',\r\n              'telegram-bot': '3005',\r\n              'notifications': '3006',\r\n              'audit': '3007',\r\n              'data-import': '3008',\r\n              'backup': '3009',\r\n              'monitoring': '3010',\r\n              'routes': '3011',\r\n              'warehouse': '3012',\r\n              'recipes': '3013',\r\n              'bunkers': '3014',\r\n              'reconciliation': '3015'\r\n            };\r\n            \r\n            const defaultPort = servicePortMap[service] || '3000';\r\n            return content.replace(\r\n              /const PORT = \\d+;?/g,\r\n              `const PORT = process.env.PORT || ${defaultPort};`\r\n            );\r\n          }\r\n          return content;\r\n        }, `Fixed PORT configuration for ${service}`);\r\n      }\r\n    }\r\n  }\r\n\r\n  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ health checks\r\n  addHealthChecks() {\r\n    console.log('\\nüè• Adding health checks...');\r\n    \r\n    const services = fs.readdirSync('services');\r\n    \r\n    for (const service of services) {\r\n      const indexPath = path.join('services', service, 'src', 'index.js');\r\n      \r\n      if (fs.existsSync(indexPath)) {\r\n        this.safeModify(indexPath, (content) => {\r\n          if (!content.includes(\"'/health'\") && !content.includes('\"/health\"')) {\r\n            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ health check\r\n            const isTelegramBot = service === 'telegram-bot';\r\n            const usesFastify = content.includes('fastify');\r\n            \r\n            let healthCheck;\r\n            \r\n            if (isTelegramBot && !usesFastify) {\r\n              // –î–ª—è Telegram Bot –±–µ–∑ Fastify\r\n              healthCheck = `\r\n// Health check endpoint for Railway\r\nconst express = require('express');\r\nconst healthApp = express();\r\nconst healthPort = process.env.PORT || 3005;\r\n\r\nhealthApp.get('/health', (req, res) => {\r\n  res.json({\r\n    status: 'ok',\r\n    service: '${service}',\r\n    timestamp: new Date().toISOString(),\r\n    uptime: process.uptime(),\r\n    bot: bot ? 'connected' : 'disconnected'\r\n  });\r\n});\r\n\r\nhealthApp.listen(healthPort, () => {\r\n  console.log(\\`Health check server running on port \\${healthPort}\\`);\r\n});\r\n\r\n`;\r\n            } else if (usesFastify) {\r\n              // –î–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤ —Å Fastify\r\n              healthCheck = `\r\n// Health check endpoint for Railway\r\nfastify.get('/health', async (request, reply) => {\r\n  try {\r\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î –µ—Å–ª–∏ –µ—Å—Ç—å prisma\r\n    ${content.includes('prisma') ? 'await prisma.$queryRaw`SELECT 1`;' : ''}\r\n    \r\n    return {\r\n      status: 'ok',\r\n      service: '${service}',\r\n      timestamp: new Date().toISOString(),\r\n      uptime: process.uptime()\r\n    };\r\n  } catch (error) {\r\n    reply.code(503).send({\r\n      status: 'error',\r\n      service: '${service}',\r\n      error: 'Service health check failed',\r\n      timestamp: new Date().toISOString()\r\n    });\r\n  }\r\n});\r\n\r\n`;\r\n            } else {\r\n              // –ë–∞–∑–æ–≤—ã–π health check\r\n              healthCheck = `\r\n// Health check endpoint for Railway\r\napp.get('/health', (req, res) => {\r\n  res.json({\r\n    status: 'ok',\r\n    service: '${service}',\r\n    timestamp: new Date().toISOString(),\r\n    uptime: process.uptime()\r\n  });\r\n});\r\n\r\n`;\r\n            }\r\n            \r\n            // –í—Å—Ç–∞–≤–ª—è–µ–º health check –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–µ—Ä–≤–µ—Ä–∞\r\n            const patterns = [\r\n              /(fastify\\.listen\\()/,\r\n              /(app\\.listen\\()/,\r\n              /(bot\\.launch\\(\\))/,\r\n              /(console\\.log.*started)/i\r\n            ];\r\n            \r\n            for (const pattern of patterns) {\r\n              if (pattern.test(content)) {\r\n                return content.replace(pattern, healthCheck + '$1');\r\n              }\r\n            }\r\n            \r\n            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –º–µ—Å—Ç–æ, –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü\r\n            return content + '\\n' + healthCheck;\r\n          }\r\n          return content;\r\n        }, `Added health check for ${service}`);\r\n      }\r\n    }\r\n  }\r\n\r\n  // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ start script –¥–ª—è reconciliation\r\n  fixReconciliationStartScript() {\r\n    console.log('\\nüìù Fixing reconciliation start script...');\r\n    \r\n    const reconciliationPkgPath = 'services/reconciliation/package.json';\r\n    \r\n    if (fs.existsSync(reconciliationPkgPath)) {\r\n      this.safeModify(reconciliationPkgPath, (content) => {\r\n        const pkg = JSON.parse(content);\r\n        \r\n        if (!pkg.scripts) {\r\n          pkg.scripts = {};\r\n        }\r\n        \r\n        if (!pkg.scripts.start) {\r\n          pkg.scripts.start = 'node src/index.js';\r\n          pkg.scripts.dev = 'nodemon src/index.js';\r\n        }\r\n        \r\n        return JSON.stringify(pkg, null, 2);\r\n      }, 'Added start script to reconciliation service');\r\n    } else {\r\n      console.log('‚ö†Ô∏è Reconciliation service package.json not found');\r\n    }\r\n  }\r\n\r\n  // –°–æ–∑–¥–∞–Ω–∏–µ S3 –∞–¥–∞–ø—Ç–µ—Ä–∞\r\n  createS3Adapter() {\r\n    console.log('\\n‚òÅÔ∏è Creating S3 adapter...');\r\n    \r\n    const storageDir = 'packages/shared/storage';\r\n    if (!fs.existsSync(storageDir)) {\r\n      fs.mkdirSync(storageDir, { recursive: true });\r\n    }\r\n    \r\n    const s3AdapterContent = `\r\n// S3 Storage Adapter for Railway deployment\r\nconst AWS = require('aws-sdk');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\nclass S3StorageAdapter {\r\n  constructor() {\r\n    this.s3 = new AWS.S3({\r\n      endpoint: process.env.S3_ENDPOINT || 'https://s3.amazonaws.com',\r\n      accessKeyId: process.env.S3_ACCESS_KEY,\r\n      secretAccessKey: process.env.S3_SECRET_KEY,\r\n      region: process.env.S3_REGION || 'us-east-1',\r\n      s3ForcePathStyle: true,\r\n      signatureVersion: 'v4'\r\n    });\r\n    \r\n    this.bucket = process.env.S3_BUCKET;\r\n    \r\n    if (!this.bucket) {\r\n      console.warn('‚ö†Ô∏è S3_BUCKET not configured, using local storage fallback');\r\n    }\r\n  }\r\n\r\n  async upload(key, buffer, contentType = 'application/octet-stream') {\r\n    if (!this.bucket) {\r\n      return this.localFallback('upload', key, buffer);\r\n    }\r\n    \r\n    try {\r\n      const params = {\r\n        Bucket: this.bucket,\r\n        Key: key,\r\n        Body: buffer,\r\n        ContentType: contentType,\r\n        ACL: 'public-read'\r\n      };\r\n      \r\n      const result = await this.s3.upload(params).promise();\r\n      return {\r\n        success: true,\r\n        url: result.Location,\r\n        key: result.Key\r\n      };\r\n    } catch (error) {\r\n      console.error('S3 upload error:', error);\r\n      return this.localFallback('upload', key, buffer);\r\n    }\r\n  }\r\n  \r\n  async download(key) {\r\n    if (!this.bucket) {\r\n      return this.localFallback('download', key);\r\n    }\r\n    \r\n    try {\r\n      const params = {\r\n        Bucket: this.bucket,\r\n        Key: key\r\n      };\r\n      \r\n      const result = await this.s3.getObject(params).promise();\r\n      return {\r\n        success: true,\r\n        data: result.Body,\r\n        contentType: result.ContentType\r\n      };\r\n    } catch (error) {\r\n      console.error('S3 download error:', error);\r\n      return this.localFallback('download', key);\r\n    }\r\n  }\r\n  \r\n  getSignedUrl(key, expires = 3600) {\r\n    if (!this.bucket) {\r\n      return \\`/uploads/\\${key}\\`;\r\n    }\r\n    \r\n    try {\r\n      return this.s3.getSignedUrl('getObject', {\r\n        Bucket: this.bucket,\r\n        Key: key,\r\n        Expires: expires\r\n      });\r\n    } catch (error) {\r\n      console.error('S3 signed URL error:', error);\r\n      return \\`/uploads/\\${key}\\`;\r\n    }\r\n  }\r\n  \r\n  async delete(key) {\r\n    if (!this.bucket) {\r\n      return this.localFallback('delete', key);\r\n    }\r\n    \r\n    try {\r\n      await this.s3.deleteObject({\r\n        Bucket: this.bucket,\r\n        Key: key\r\n      }).promise();\r\n      \r\n      return { success: true };\r\n    } catch (error) {\r\n      console.error('S3 delete error:', error);\r\n      return { success: false, error: error.message };\r\n    }\r\n  }\r\n  \r\n  // –õ–æ–∫–∞–ª—å–Ω—ã–π fallback –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏\r\n  localFallback(operation, key, data) {\r\n    const uploadsDir = path.join(process.cwd(), 'uploads');\r\n    \r\n    if (!fs.existsSync(uploadsDir)) {\r\n      fs.mkdirSync(uploadsDir, { recursive: true });\r\n    }\r\n    \r\n    const filePath = path.join(uploadsDir, key);\r\n    \r\n    switch (operation) {\r\n      case 'upload':\r\n        fs.writeFileSync(filePath, data);\r\n        return {\r\n          success: true,\r\n          url: \\`/uploads/\\${key}\\`,\r\n          key: key,\r\n          fallback: true\r\n        };\r\n        \r\n      case 'download':\r\n        if (fs.existsSync(filePath)) {\r\n          return {\r\n            success: true,\r\n            data: fs.readFileSync(filePath),\r\n            fallback: true\r\n          };\r\n        }\r\n        return { success: false, error: 'File not found' };\r\n        \r\n      case 'delete':\r\n        if (fs.existsSync(filePath)) {\r\n          fs.unlinkSync(filePath);\r\n        }\r\n        return { success: true, fallback: true };\r\n        \r\n      default:\r\n        return { success: false, error: 'Unknown operation' };\r\n    }\r\n  }\r\n}\r\n\r\nmodule.exports = S3StorageAdapter;\r\n`;\r\n    \r\n    const s3AdapterPath = path.join(storageDir, 's3.js');\r\n    fs.writeFileSync(s3AdapterPath, s3AdapterContent.trim());\r\n    this.changes.push({ \r\n      file: s3AdapterPath, \r\n      success: true, \r\n      description: 'Created S3 storage adapter',\r\n      created: true \r\n    });\r\n    console.log(`‚úÖ Created S3 adapter: ${s3AdapterPath}`);\r\n    \r\n    // –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è storage\r\n    const indexContent = `\r\nconst S3StorageAdapter = require('./s3');\r\n\r\nmodule.exports = {\r\n  S3StorageAdapter,\r\n  // –°–æ–∑–¥–∞–µ–º singleton instance\r\n  storage: new S3StorageAdapter()\r\n};\r\n`;\r\n    \r\n    const indexPath = path.join(storageDir, 'index.js');\r\n    fs.writeFileSync(indexPath, indexContent.trim());\r\n    this.changes.push({ \r\n      file: indexPath, \r\n      success: true, \r\n      description: 'Created storage index file',\r\n      created: true \r\n    });\r\n    console.log(`‚úÖ Created storage index: ${indexPath}`);\r\n  }\r\n\r\n  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π\r\n  updateDependencies() {\r\n    console.log('\\nüì¶ Updating problematic dependencies...');\r\n    \r\n    const problematicServices = [\r\n      { service: 'data-import', dependency: 'xlsx', currentVersion: '^0.18.5', newVersion: '^0.20.0' },\r\n      { service: 'notifications', dependency: 'node-telegram-bot-api', currentVersion: '^0.64.0', newVersion: '^0.66.0' },\r\n      { service: 'telegram-bot', dependency: 'node-telegram-bot-api', currentVersion: '^0.63.0', newVersion: '^0.66.0' },\r\n      { service: 'telegram-bot', dependency: 'pdfkit', currentVersion: '^0.14.0', newVersion: '^0.15.0' }\r\n    ];\r\n    \r\n    for (const { service, dependency, currentVersion, newVersion } of problematicServices) {\r\n      const pkgPath = path.join('services', service, 'package.json');\r\n      \r\n      if (fs.existsSync(pkgPath)) {\r\n        this.safeModify(pkgPath, (content) => {\r\n          const pkg = JSON.parse(content);\r\n          \r\n          if (pkg.dependencies && pkg.dependencies[dependency] === currentVersion) {\r\n            pkg.dependencies[dependency] = newVersion;\r\n            console.log(`  üìà ${service}: ${dependency} ${currentVersion} ‚Üí ${newVersion}`);\r\n          }\r\n          \r\n          return JSON.stringify(pkg, null, 2);\r\n        }, `Updated ${dependency} in ${service}`);\r\n      }\r\n    }\r\n    \r\n    // –î–æ–±–∞–≤–ª—è–µ–º aws-sdk –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç –≤ shared –ø–∞–∫–µ—Ç–µ\r\n    const sharedPkgPath = 'packages/shared/package.json';\r\n    if (fs.existsSync(sharedPkgPath)) {\r\n      this.safeModify(sharedPkgPath, (content) => {\r\n        const pkg = JSON.parse(content);\r\n        \r\n        if (!pkg.dependencies) {\r\n          pkg.dependencies = {};\r\n        }\r\n        \r\n        if (!pkg.dependencies['aws-sdk']) {\r\n          pkg.dependencies['aws-sdk'] = '^2.1691.0';\r\n          console.log('  üìà Added aws-sdk to shared package');\r\n        }\r\n        \r\n        return JSON.stringify(pkg, null, 2);\r\n      }, 'Added aws-sdk dependency');\r\n    }\r\n  }\r\n\r\n  // –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö\r\n  generateReport() {\r\n    const report = {\r\n      timestamp: new Date().toISOString(),\r\n      backups: this.backups,\r\n      changes: this.changes,\r\n      summary: {\r\n        total: this.changes.length,\r\n        successful: this.changes.filter(c => c.success).length,\r\n        failed: this.changes.filter(c => !c.success).length,\r\n        created: this.changes.filter(c => c.created).length,\r\n        noChanges: this.changes.filter(c => c.noChanges).length\r\n      }\r\n    };\r\n    \r\n    fs.writeFileSync('safe-fixes-report.json', JSON.stringify(report, null, 2));\r\n    console.log('\\nüìÑ Report saved: safe-fixes-report.json');\r\n    \r\n    // –í—ã–≤–æ–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏\r\n    console.log('\\nüìä Summary:');\r\n    console.log(`  ‚úÖ Successful changes: ${report.summary.successful}`);\r\n    console.log(`  ‚ùå Failed changes: ${report.summary.failed}`);\r\n    console.log(`  üìÅ Files created: ${report.summary.created}`);\r\n    console.log(`  ‚ÑπÔ∏è No changes needed: ${report.summary.noChanges}`);\r\n    \r\n    if (report.summary.failed > 0) {\r\n      console.log('\\n‚ùå Failed changes:');\r\n      this.changes.filter(c => !c.success).forEach(change => {\r\n        console.log(`  - ${change.file}: ${change.error}`);\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\n// –ó–∞–ø—É—Å–∫ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π\r\nconst fixer = new SafeFixer();\r\n\r\n// –û–±—Ä–∞–±–æ—Ç–∫–∞ rollback\r\nif (process.argv.includes('--rollback')) {\r\n  console.log('üîÑ Rollback mode activated');\r\n  // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç—á–µ—Ç –¥–ª—è rollback\r\n  if (fs.existsSync('safe-fixes-report.json')) {\r\n    const report = JSON.parse(fs.readFileSync('safe-fixes-report.json', 'utf8'));\r\n    fixer.backups = report.backups;\r\n    fixer.rollback();\r\n  } else {\r\n    console.log('‚ùå No backup report found');\r\n  }\r\n  process.exit(0);\r\n}\r\n\r\ntry {\r\n  console.log('üöÄ Starting safe fixes for Railway deployment...\\n');\r\n  \r\n  // 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–æ—Ä—Ç–æ–≤\r\n  fixer.fixPortConfiguration();\r\n  \r\n  // 2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ health checks\r\n  fixer.addHealthChecks();\r\n  \r\n  // 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ reconciliation start script\r\n  fixer.fixReconciliationStartScript();\r\n  \r\n  // 4. –°–æ–∑–¥–∞–Ω–∏–µ S3 –∞–¥–∞–ø—Ç–µ—Ä–∞\r\n  fixer.createS3Adapter();\r\n  \r\n  // 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π\r\n  fixer.updateDependencies();\r\n  \r\n  // 6. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞\r\n  fixer.generateReport();\r\n  \r\n  console.log('\\n‚úÖ Safe fixes completed successfully!');\r\n  console.log('üí° To rollback changes, run: node scripts/safe-fixes.js --rollback');\r\n  console.log('üîç Next step: Run comprehensive test to verify changes');\r\n  \r\n} catch (error) {\r\n  console.error('\\n‚ùå Error during fixes:', error);\r\n  console.log('üîÑ Rolling back changes...');\r\n  fixer.rollback();\r\n  process.exit(1);\r\n}\r\n",
  "services/auth/src/index.js": "/**\r\n * VHM24 - VendHub Manager 24/7\r\n * Authentication Service - PRODUCTION READY\r\n * Provides secure 24/7 authentication for vending machine operators\r\n */\r\n\r\nrequire('dotenv').config({ path: require('path').join(__dirname, '../../../.env') });\r\n\r\n// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º SERVICE_NAME –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏\r\nprocess.env.SERVICE_NAME = 'auth';\r\n\r\nconst Fastify = require('fastify');\r\nconst bcrypt = require('bcrypt');\r\nconst { getAuthClient } = require('@vhm24/database');\r\n\r\n// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à –Ω–æ–≤—ã–π shared –ø–∞–∫–µ—Ç\r\nconst {\r\n  // Middleware\r\n  setupCORS,\r\n  setupHelmet,\r\n  setupRateLimit,\r\n  setupJWT,\r\n  authenticate,\r\n  authorize,\r\n  sanitizeInputs,\r\n  securityLogger,\r\n  healthCheck,\r\n  \r\n  // Validation\r\n  validateBody,\r\n  validateQuery,\r\n  validateId,\r\n  \r\n  // Error handling\r\n  registerErrorHandlers,\r\n  setupGlobalErrorHandlers,\r\n  createError,\r\n  asyncHandler,\r\n  \r\n  // Utils\r\n  logger,\r\n  config,\r\n  createFastifyConfig\r\n} = require('@vhm24/shared');\r\n\r\n// Security utilities\r\nconst { \r\n  validateEmail, \r\n  validatePhoneNumber, \r\n  validateTelegramId,\r\n  validatePasswordStrength,\r\n  sanitizeInput,\r\n  maskSensitiveData\r\n} = require('@vhm24/shared-types/src/security');\r\n\r\n// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ—à–∏–±–æ–∫\r\nsetupGlobalErrorHandlers();\r\n\r\n// –°–æ–∑–¥–∞–µ–º Fastify —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π\r\nconst fastify = Fastify(createFastifyConfig());\r\n\r\n// –ü–æ–ª—É—á–∞–µ–º Prisma –∫–ª–∏–µ–Ω—Ç\r\nconst prisma = getAuthClient();\r\n\r\n// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫\r\nregisterErrorHandlers(fastify);\r\n\r\n// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\r\nsetupHelmet(fastify);\r\nsetupCORS(fastify);\r\nsetupRateLimit(fastify, {\r\n  max: 50, // –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π –ª–∏–º–∏—Ç –¥–ª—è auth —Å–µ—Ä–≤–∏—Å–∞\r\n  timeWindow: '1 minute'\r\n});\r\nsetupJWT(fastify);\r\n\r\n// Middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏\r\nfastify.addHook('preHandler', securityLogger);\r\nfastify.addHook('preHandler', sanitizeInputs);\r\n\r\n// –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏\r\nfastify.decorate('authenticate', async function(request, reply) {\r\n  try {\r\n    await request.jwtVerify();\r\n    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ request\r\n    const user = await prisma.user.findUnique({\r\n      where: { id: request.user.id },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        name: true,\r\n        roles: true,\r\n        isActive: true\r\n      }\r\n    });\r\n    \r\n    if (!user || !user.isActive) {\r\n      throw new Error('User not found or inactive');\r\n    }\r\n    \r\n    request.user = user;\r\n  } catch (err) {\r\n    reply.code(401).send({ \r\n      success: false,\r\n      error: 'Unauthorized',\r\n      message: err.message || 'Invalid or expired token'\r\n    });\r\n  }\r\n});\r\n\r\n// Health check\r\nfastify.get('/health', async (request, reply) => {\r\n  return { status: 'ok', service: 'auth' };\r\n});\r\n\r\n// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\nfastify.post('/api/v1/auth/register', {\r\n  schema: {\r\n    body: {\r\n      type: 'object',\r\n      required: ['email', 'password', 'name'],\r\n      properties: {\r\n        email: { type: 'string', format: 'email' },\r\n        password: { type: 'string', minLength: 6 },\r\n        name: { type: 'string', minLength: 2 },\r\n        phoneNumber: { type: 'string' },\r\n        roles: { \r\n          type: 'array', \r\n          items: { \r\n            type: 'string', \r\n            enum: ['ADMIN', 'MANAGER', 'WAREHOUSE', 'OPERATOR', 'TECHNICIAN', 'DRIVER'] \r\n          },\r\n          default: ['OPERATOR']\r\n        }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { email, password, name, phoneNumber, roles } = request.body;\r\n  \r\n  try {\r\n    // –í–∞–ª–∏–¥–∞—Ü–∏—è email\r\n    if (!validateEmail(email)) {\r\n      return reply.code(400).send({\r\n        success: false,\r\n        error: 'Invalid email format'\r\n      });\r\n    }\r\n    \r\n    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è\r\n    const passwordValidation = validatePasswordStrength(password);\r\n    if (!passwordValidation.valid) {\r\n      return reply.code(400).send({\r\n        success: false,\r\n        error: passwordValidation.message\r\n      });\r\n    }\r\n    \r\n    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)\r\n    if (phoneNumber && !validatePhoneNumber(phoneNumber)) {\r\n      return reply.code(400).send({\r\n        success: false,\r\n        error: 'Invalid phone number format. Use format: +998XXXXXXXXX'\r\n      });\r\n    }\r\n    \r\n    // –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –∏–º–µ–Ω–∏\r\n    const sanitizedName = sanitizeInput(name);\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å\r\n    const existingUser = await prisma.user.findFirst({\r\n      where: {\r\n        OR: [\r\n          { email },\r\n          phoneNumber ? { phoneNumber } : {}\r\n        ].filter(Boolean)\r\n      }\r\n    });\r\n    \r\n    if (existingUser) {\r\n      return reply.code(400).send({\r\n        success: false,\r\n        error: 'User with this email or phone number already exists'\r\n      });\r\n    }\r\n    \r\n    // –•–µ—à–∏—Ä—É–µ–º –ø–∞—Ä–æ–ª—å —Å –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç—å—é –¥–ª—è production\r\n    const saltRounds = process.env.NODE_ENV === 'production' ? 12 : 10;\r\n    const passwordHash = await bcrypt.hash(password, saltRounds);\r\n    \r\n    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è\r\n    const result = await prisma.$transaction(async (tx) => {\r\n      // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n      const user = await tx.user.create({\r\n        data: {\r\n          email: email.toLowerCase(), // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º email\r\n          passwordHash,\r\n          name: sanitizedName,\r\n          phoneNumber,\r\n          roles: roles || ['OPERATOR']\r\n        },\r\n        select: {\r\n          id: true,\r\n          email: true,\r\n          name: true,\r\n          roles: true,\r\n          createdAt: true\r\n        }\r\n      });\r\n      \r\n      // –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ\r\n      await tx.auditLog.create({\r\n        data: {\r\n          userId: user.id,\r\n          action: 'USER_REGISTERED',\r\n          entity: 'User',\r\n          entityId: user.id,\r\n          ipAddress: request.ip,\r\n          userAgent: request.headers['user-agent']\r\n        }\r\n      });\r\n      \r\n      return user;\r\n    });\r\n    \r\n    // –°–æ–∑–¥–∞–µ–º —Ç–æ–∫–µ–Ω—ã\r\n    const token = fastify.jwt.sign({\r\n      id: result.id,\r\n      email: result.email,\r\n      roles: result.roles\r\n    });\r\n    \r\n    const refreshToken = fastify.jwt.sign(\r\n      { id: result.id, type: 'refresh' }, \r\n      { expiresIn: '7d' }\r\n    );\r\n    \r\n    return {\r\n      success: true,\r\n      data: {\r\n        user: {\r\n          ...result,\r\n          email: maskSensitiveData(result.email, 'email')\r\n        },\r\n        token,\r\n        refreshToken\r\n      }\r\n    };\r\n  } catch (error) {\r\n    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ Prisma\r\n    if (error.code === 'P2002') {\r\n      return reply.code(409).send({\r\n        success: false,\r\n        error: 'User already exists'\r\n      });\r\n    }\r\n    \r\n    throw createError.database('Registration failed');\r\n  }\r\n});\r\n\r\n// –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É\r\nfastify.post('/api/v1/auth/login', async (request, reply) => {\r\n  const { email, password, phoneNumber, telegramId } = request.body;\r\n  \r\n  try {\r\n    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ email, —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ telegram –¥–ª—è 24/7 –¥–æ—Å—Ç—É–ø–∞\r\n    let where = {};\r\n    let authMethod = 'EMAIL';\r\n    \r\n    if (telegramId) {\r\n      // –í–∞–ª–∏–¥–∞—Ü–∏—è Telegram ID\r\n      if (!validateTelegramId(telegramId)) {\r\n        return reply.code(400).send({\r\n          success: false,\r\n          error: 'Invalid Telegram ID format'\r\n        });\r\n      }\r\n      where = { telegramId };\r\n      authMethod = 'TELEGRAM';\r\n    } else if (email) {\r\n      // –í–∞–ª–∏–¥–∞—Ü–∏—è email\r\n      if (!validateEmail(email)) {\r\n        return reply.code(400).send({\r\n          success: false,\r\n          error: 'Invalid email format'\r\n        });\r\n      }\r\n      where = { email: email.toLowerCase() };\r\n    } else if (phoneNumber) {\r\n      // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞\r\n      if (!validatePhoneNumber(phoneNumber)) {\r\n        return reply.code(400).send({\r\n          success: false,\r\n          error: 'Invalid phone number format. Use format: +998XXXXXXXXX'\r\n        });\r\n      }\r\n      where = { phoneNumber };\r\n      authMethod = 'PHONE';\r\n    } else {\r\n      return reply.code(400).send({ \r\n        success: false,\r\n        error: 'Email, phone or telegram ID required for 24/7 access' \r\n      });\r\n    }\r\n\r\n    const user = await prisma.user.findFirst({\r\n      where,\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        name: true,\r\n        passwordHash: true,\r\n        roles: true,\r\n        isActive: true,\r\n        phoneNumber: true,\r\n        telegramId: true\r\n      }\r\n    });\r\n\r\n    if (!user || !user.isActive) {\r\n      return reply.code(401).send({ error: 'Invalid credentials' });\r\n    }\r\n\r\n    // –î–ª—è Telegram –≤—Ö–æ–¥–∞ –ø–∞—Ä–æ–ª—å –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º (–¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ 24/7)\r\n    if (authMethod !== 'TELEGRAM' && password) {\r\n      const isValidPassword = await bcrypt.compare(password, user.passwordHash);\r\n      if (!isValidPassword) {\r\n        return reply.code(401).send({ error: 'Invalid credentials' });\r\n      }\r\n    } else if (authMethod !== 'TELEGRAM' && !password) {\r\n      return reply.code(400).send({ error: 'Password required' });\r\n    }\r\n\r\n    await prisma.user.update({\r\n      where: { id: user.id },\r\n      data: { lastLogin: new Date() }\r\n    });\r\n\r\n    await prisma.auditLog.create({\r\n      data: {\r\n        userId: user.id,\r\n        action: 'USER_LOGIN',\r\n        entity: 'User',\r\n        entityId: user.id,\r\n        ipAddress: request.ip,\r\n        userAgent: request.headers['user-agent'],\r\n        changes: { authMethod }\r\n      }\r\n    });\r\n\r\n    const token = fastify.jwt.sign({\r\n      id: user.id,\r\n      email: user.email,\r\n      roles: user.roles,\r\n      name: user.name\r\n    });\r\n\r\n    fastify.log.info(`User ${user.email} logged in - VHM24 system access granted`);\r\n\r\n    return {\r\n      success: true,\r\n      token,\r\n      user: {\r\n        id: user.id,\r\n        email: user.email,\r\n        name: user.name,\r\n        roles: user.roles,\r\n        phoneNumber: user.phoneNumber\r\n      },\r\n      message: 'Welcome to VHM24 - 24/7 Access Granted'\r\n    };\r\n  } catch (error) {\r\n    throw createError.authentication('Login failed');\r\n  }\r\n});\r\n\r\n// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞\r\nfastify.post('/api/v1/auth/refresh', {\r\n  schema: {\r\n    body: {\r\n      type: 'object',\r\n      required: ['refreshToken'],\r\n      properties: {\r\n        refreshToken: { type: 'string' }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { refreshToken } = request.body;\r\n  \r\n  try {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º refresh token\r\n    const decoded = fastify.jwt.verify(refreshToken);\r\n    \r\n    // –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n    const user = await prisma.user.findUnique({\r\n      where: { id: decoded.id },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        name: true,\r\n        roles: true,\r\n        isActive: true\r\n      }\r\n    });\r\n    \r\n    if (!user || !user.isActive) {\r\n      return reply.code(401).send({\r\n        success: false,\r\n        error: 'Invalid refresh token'\r\n      });\r\n    }\r\n    \r\n    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã\r\n    const token = fastify.jwt.sign({\r\n      id: user.id,\r\n      email: user.email,\r\n      roles: user.roles\r\n    });\r\n    \r\n    const newRefreshToken = fastify.jwt.sign(\r\n      { id: user.id },\r\n      { expiresIn: '7d' }\r\n    );\r\n    \r\n    return {\r\n      success: true,\r\n      data: {\r\n        token,\r\n        refreshToken: newRefreshToken\r\n      }\r\n    };\r\n  } catch (error) {\r\n    reply.code(401).send({\r\n      success: false,\r\n      error: 'Invalid refresh token'\r\n    });\r\n  }\r\n});\r\n\r\n// –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\nfastify.get('/api/v1/auth/me', {\r\n  preValidation: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    const user = await prisma.user.findUnique({\r\n      where: { id: request.user.id },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        name: true,\r\n        roles: true,\r\n        phoneNumber: true,\r\n        isActive: true,\r\n        createdAt: true,\r\n        lastLogin: true\r\n      }\r\n    });\r\n    \r\n    if (!user) {\r\n      return reply.code(404).send({\r\n        success: false,\r\n        error: 'User not found'\r\n      });\r\n    }\r\n    \r\n    return {\r\n      success: true,\r\n      data: user\r\n    };\r\n  } catch (error) {\r\n    throw createError.database('Failed to fetch user data');\r\n  }\r\n});\r\n\r\n// –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å\r\nfastify.post('/api/v1/auth/change-password', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    body: {\r\n      type: 'object',\r\n      required: ['currentPassword', 'newPassword'],\r\n      properties: {\r\n        currentPassword: { type: 'string' },\r\n        newPassword: { type: 'string', minLength: 6 }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { currentPassword, newPassword } = request.body;\r\n  const userId = request.user.id;\r\n  \r\n  try {\r\n    // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–∞—Ä–æ–ª–µ–º\r\n    const user = await prisma.user.findUnique({\r\n      where: { id: userId }\r\n    });\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å\r\n    const validPassword = await bcrypt.compare(currentPassword, user.passwordHash);\r\n    \r\n    if (!validPassword) {\r\n      return reply.code(400).send({\r\n        success: false,\r\n        error: 'Current password is incorrect'\r\n      });\r\n    }\r\n    \r\n    // –•–µ—à–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å\r\n    const newPasswordHash = await bcrypt.hash(newPassword, 10);\r\n    \r\n    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–æ–ª—å\r\n    await prisma.user.update({\r\n      where: { id: userId },\r\n      data: { passwordHash: newPasswordHash }\r\n    });\r\n    \r\n    // –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ\r\n    await prisma.auditLog.create({\r\n      data: {\r\n        userId,\r\n        action: 'PASSWORD_CHANGED',\r\n        entity: 'User',\r\n        entityId: userId,\r\n        ipAddress: request.ip\r\n      }\r\n    });\r\n    \r\n    return {\r\n      success: true,\r\n      message: 'Password changed successfully'\r\n    };\r\n  } catch (error) {\r\n    throw createError.database('Failed to change password');\r\n  }\r\n});\r\n\r\n// –í—ã—Ö–æ–¥ (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)\r\nfastify.post('/api/v1/auth/logout', {\r\n  preValidation: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    // –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ\r\n    await prisma.auditLog.create({\r\n      data: {\r\n        userId: request.user.id,\r\n        action: 'USER_LOGOUT',\r\n        entity: 'User',\r\n        entityId: request.user.id,\r\n        ipAddress: request.ip\r\n      }\r\n    });\r\n    \r\n    return {\r\n      success: true,\r\n      message: 'Logged out successfully'\r\n    };\r\n  } catch (error) {\r\n    fastify.log.error(error);\r\n    return {\r\n      success: true,\r\n      message: 'Logged out successfully'\r\n    };\r\n  }\r\n});\r\n\r\n// –°–≤—è–∑—ã–≤–∞–Ω–∏–µ Telegram ID —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º\r\nfastify.post('/api/v1/auth/link-telegram', {\r\n  preValidation: [fastify.authenticate],\r\n  schema: {\r\n    body: {\r\n      type: 'object',\r\n      required: ['telegramId'],\r\n      properties: {\r\n        telegramId: { type: 'string' }\r\n      }\r\n    }\r\n  }\r\n}, async (request, reply) => {\r\n  const { telegramId } = request.body;\r\n  const userId = request.user.id;\r\n  \r\n  try {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –ª–∏ —É–∂–µ —ç—Ç–æ—Ç Telegram ID –∫ –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é\r\n    const existingUser = await prisma.user.findFirst({\r\n      where: { telegramId }\r\n    });\r\n    \r\n    if (existingUser && existingUser.id !== userId) {\r\n      return reply.code(400).send({\r\n        success: false,\r\n        error: 'This Telegram ID is already linked to another account'\r\n      });\r\n    }\r\n    \r\n    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n    await prisma.user.update({\r\n      where: { id: userId },\r\n      data: { telegramId }\r\n    });\r\n    \r\n    // –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ\r\n    await prisma.auditLog.create({\r\n      data: {\r\n        userId,\r\n        action: 'TELEGRAM_LINKED',\r\n        entity: 'User',\r\n        entityId: userId,\r\n        ipAddress: request.ip,\r\n        changes: { telegramId }\r\n      }\r\n    });\r\n    \r\n    return {\r\n      success: true,\r\n      message: 'Telegram account linked successfully'\r\n    };\r\n  } catch (error) {\r\n    throw createError.database('Failed to link Telegram account');\r\n  }\r\n});\r\n\r\n// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ (middleware helper)\r\nfastify.decorate('requireRole', (roles) => {\r\n  return async function (request, reply) {\r\n    if (!request.user) {\r\n      return reply.code(401).send({ error: 'Unauthorized' });\r\n    }\r\n    \r\n    const hasRole = roles.some(role => request.user.roles.includes(role));\r\n    \r\n    if (!hasRole) {\r\n      return reply.code(403).send({ \r\n        error: 'Forbidden',\r\n        message: `Required roles: ${roles.join(', ')}`\r\n      });\r\n    }\r\n  };\r\n});\r\n\r\n// –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–µ—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)\r\nasync function createDefaultAdmin() {\r\n  try {\r\n    const userCount = await prisma.user.count();\r\n    \r\n    if (userCount === 0) {\r\n      const passwordHash = await bcrypt.hash('admin123', 10);\r\n      \r\n      await prisma.user.create({\r\n        data: {\r\n          email: 'admin@vhm24.ru',\r\n          name: 'System Administrator',\r\n          passwordHash,\r\n          roles: ['ADMIN'],\r\n          isActive: true\r\n        }\r\n      });\r\n      \r\n      console.log('Default admin user created: admin@vhm24.ru / admin123');\r\n    }\r\n  } catch (error) {\r\n    console.error('Failed to create default admin:', error);\r\n  }\r\n}\r\n\r\n// Start server\r\nconst start = async () => {\r\n  try {\r\n    // –°–æ–∑–¥–∞–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\r\n    await createDefaultAdmin();\r\n    \r\n    await fastify.listen({ \r\n      port: process.env.PORT || 3001,\r\n      host: '0.0.0.0'\r\n    });\r\n    console.log('VHM24 Auth Service running 24/7 on port', process.env.PORT || 3001);\r\n  } catch (err) {\r\n    fastify.log.error(err);\r\n    process.exit(1);\r\n  }\r\n};\r\n\r\nstart();\r\n\r\n// Graceful shutdown\r\nprocess.on('SIGTERM', async () => {\r\n  await fastify.close();\r\n  await prisma.$disconnect();\r\n  process.exit(0);\r\n});\r\n",
  "services/gateway/src/index.js": "/**\r\n * VHM24 - VendHub Manager 24/7\r\n * Gateway Service - PRODUCTION READY\r\n * Secure API Gateway with WebSocket support\r\n */\r\n\r\nrequire('dotenv').config({ path: require('path').join(__dirname, '../../../.env') });\r\n\r\n// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º SERVICE_NAME –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏\r\nprocess.env.SERVICE_NAME = 'gateway';\r\n\r\nconst Fastify = require('fastify');\r\nconst httpProxy = require('@fastify/http-proxy');\r\nconst multipart = require('@fastify/multipart');\r\nconst websocket = require('@fastify/websocket');\r\nconst { getPrismaClient } = require('@vhm24/database');\r\nconst { validateFileType, sanitizeInput } = require('@vhm24/shared-types/src/security');\r\nconst path = require('path');\r\nconst fs = require('fs');\r\nconst { v4: uuidv4 } = require('uuid');\r\n\r\n// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à –Ω–æ–≤—ã–π shared –ø–∞–∫–µ—Ç\r\nconst {\r\n  // Middleware\r\n  setupCORS,\r\n  setupHelmet,\r\n  setupRateLimit,\r\n  setupJWT,\r\n  authenticate,\r\n  authorize,\r\n  sanitizeInputs,\r\n  securityLogger,\r\n  healthCheck,\r\n  \r\n  // Validation\r\n  validateBody,\r\n  validateQuery,\r\n  validateId,\r\n  \r\n  // Error handling\r\n  registerErrorHandlers,\r\n  setupGlobalErrorHandlers,\r\n  createError,\r\n  asyncHandler,\r\n  \r\n  // Utils\r\n  logger,\r\n  config: sharedConfig,\r\n  createFastifyConfig\r\n} = require('@vhm24/shared');\r\n\r\n// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º middleware –∞—É–¥–∏—Ç–∞\r\nconst AuditMiddleware = require('@vhm24/shared/middleware/auditMiddleware');\r\nconst auditMiddleware = new AuditMiddleware();\r\n\r\n// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ—à–∏–±–æ–∫\r\nsetupGlobalErrorHandlers();\r\n\r\n// –°–æ–∑–¥–∞–µ–º Fastify —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π\r\nconst fastify = Fastify({\r\n  ...createFastifyConfig(),\r\n  bodyLimit: parseInt(process.env.MAX_FILE_SIZE) || 10485760 // 10MB –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\r\n});\r\n\r\nconst prisma = getPrismaClient();\r\n\r\n// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫\r\nregisterErrorHandlers(fastify);\r\n\r\n// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\r\nsetupHelmet(fastify, {\r\n  contentSecurityPolicy: {\r\n    directives: {\r\n      defaultSrc: [\"'self'\"],\r\n      styleSrc: [\"'self'\", \"'unsafe-inline'\"],\r\n      scriptSrc: [\"'self'\"],\r\n      imgSrc: [\"'self'\", \"data:\", \"https:\"],\r\n      connectSrc: [\"'self'\", \"ws:\", \"wss:\"],\r\n    },\r\n  },\r\n});\r\nsetupCORS(fastify);\r\nsetupRateLimit(fastify, {\r\n  max: 200, // –ë–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–π –ª–∏–º–∏—Ç –¥–ª—è gateway\r\n  timeWindow: '1 minute'\r\n});\r\nsetupJWT(fastify, {\r\n  verify: {\r\n    issuer: ['vhm24-gateway', 'vhm24-auth'] // –ü—Ä–∏–Ω–∏–º–∞–µ–º —Ç–æ–∫–µ–Ω—ã –æ—Ç auth —Å–µ—Ä–≤–∏—Å–∞\r\n  }\r\n});\r\n\r\n// Middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏\r\nfastify.addHook('preHandler', securityLogger);\r\nfastify.addHook('preHandler', sanitizeInputs);\r\n\r\n// Middleware –∞—É–¥–∏—Ç–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è\r\nfastify.addHook('preHandler', auditMiddleware.fastifyMiddleware());\r\n\r\nfastify.register(multipart, {\r\n  limits: {\r\n    fileSize: 10 * 1024 * 1024 // 10MB\r\n  }\r\n});\r\n\r\nfastify.register(websocket);\r\n\r\n// WebSocket –∫–ª–∏–µ–Ω—Ç—ã\r\nconst wsClients = new Set();\r\n\r\n// –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)\r\nfastify.decorate('authenticate', authenticate);\r\n\r\n// Health check\r\nfastify.get('/health', async (request, reply) => {\r\n  const services = {\r\n    auth: 'unknown',\r\n    machines: 'unknown',\r\n    inventory: 'unknown',\r\n    tasks: 'unknown',\r\n    bunkers: 'unknown',\r\n    notifications: 'unknown'\r\n  };\r\n  \r\n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å\r\n  const checks = [\r\n    { name: 'auth', url: 'http://127.0.0.1:3001/health' },\r\n    { name: 'machines', url: 'http://127.0.0.1:3002/health' },\r\n    { name: 'inventory', url: 'http://127.0.0.1:3003/health' },\r\n    { name: 'tasks', url: 'http://127.0.0.1:3004/health' },\r\n    { name: 'bunkers', url: 'http://127.0.0.1:3005/health' },\r\n    { name: 'notifications', url: 'http://127.0.0.1:3006/health' }\r\n  ];\r\n  \r\n  for (const check of checks) {\r\n    try {\r\n      const response = await fetch(check.url);\r\n      if (response.ok) {\r\n        services[check.name] = 'ok';\r\n      } else {\r\n        services[check.name] = 'error';\r\n      }\r\n    } catch (e) {\r\n      services[check.name] = 'offline';\r\n    }\r\n  }\r\n  \r\n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\r\n  let dbStatus = 'unknown';\r\n  try {\r\n    await prisma.$queryRaw`SELECT 1`;\r\n    dbStatus = 'connected';\r\n  } catch (e) {\r\n    dbStatus = 'error';\r\n  }\r\n  \r\n  return { \r\n    status: 'ok', \r\n    service: 'gateway',\r\n    services,\r\n    database: process.env.DATABASE_URL ? 'supabase' : 'local',\r\n    dbStatus,\r\n    timestamp: new Date().toISOString()\r\n  };\r\n});\r\n\r\n// WebSocket endpoint –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π\r\nfastify.register(async function (fastify) {\r\n  fastify.get('/ws', { websocket: true }, (connection, req) => {\r\n    console.log('WebSocket client connected');\r\n    \r\n    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç–∞ –≤ —Å–ø–∏—Å–æ–∫\r\n    wsClients.add(connection.socket);\r\n    \r\n    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\r\n    connection.socket.send(JSON.stringify({\r\n      type: 'connected',\r\n      message: 'Connected to VHM24 WebSocket',\r\n      timestamp: new Date()\r\n    }));\r\n    \r\n    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞\r\n    connection.socket.on('message', async (message) => {\r\n      try {\r\n        const data = JSON.parse(message.toString());\r\n        console.log('WebSocket message:', data);\r\n        \r\n        // Echo –æ–±—Ä–∞—Ç–Ω–æ\r\n        connection.socket.send(JSON.stringify({\r\n          type: 'echo',\r\n          data: data,\r\n          timestamp: new Date()\r\n        }));\r\n      } catch (error) {\r\n        console.error('WebSocket message error:', error);\r\n      }\r\n    });\r\n    \r\n    // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏\r\n    connection.socket.on('close', () => {\r\n      console.log('WebSocket client disconnected');\r\n      wsClients.delete(connection.socket);\r\n    });\r\n  });\r\n});\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è broadcast —Å–æ–æ–±—â–µ–Ω–∏–π –≤—Å–µ–º WebSocket –∫–ª–∏–µ–Ω—Ç–∞–º\r\nfunction broadcastToClients(type, data) {\r\n  const message = JSON.stringify({\r\n    type,\r\n    data,\r\n    timestamp: new Date()\r\n  });\r\n  \r\n  wsClients.forEach(client => {\r\n    if (client.readyState === 1) { // WebSocket.OPEN\r\n      client.send(message);\r\n    }\r\n  });\r\n}\r\n\r\n// –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π\r\nfastify.post('/api/v1/upload', {\r\n  preValidation: [fastify.authenticate],\r\n  handler: async (request, reply) => {\r\n    const parts = request.parts();\r\n    const uploadedFiles = [];\r\n    const maxFileSize = parseInt(process.env.MAX_FILE_SIZE) || 10485760; // 10MB\r\n    \r\n    for await (const part of parts) {\r\n      if (part.file) {\r\n        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞\r\n        if (!validateFileType(part.mimetype)) {\r\n          return reply.code(400).send({\r\n            success: false,\r\n            error: `File type ${part.mimetype} is not allowed`\r\n          });\r\n        }\r\n        \r\n        // –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞\r\n        const sanitizedFilename = sanitizeInput(part.filename);\r\n        const ext = path.extname(sanitizedFilename);\r\n        const filename = `${uuidv4()}${ext}`;\r\n        const uploadDir = path.join(process.cwd(), process.env.UPLOAD_DIR || 'uploads');\r\n        const filepath = path.join(uploadDir, filename);\r\n        \r\n        // –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç\r\n        if (!fs.existsSync(uploadDir)) {\r\n          fs.mkdirSync(uploadDir, { recursive: true });\r\n        }\r\n        \r\n        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞\r\n        let fileSize = 0;\r\n        const chunks = [];\r\n        \r\n        for await (const chunk of part.file) {\r\n          fileSize += chunk.length;\r\n          if (fileSize > maxFileSize) {\r\n            return reply.code(413).send({\r\n              success: false,\r\n              error: `File size exceeds maximum allowed size of ${maxFileSize} bytes`\r\n            });\r\n          }\r\n          chunks.push(chunk);\r\n        }\r\n        \r\n        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª\r\n        const buffer = Buffer.concat(chunks);\r\n        fs.writeFileSync(filepath, buffer);\r\n        \r\n        // –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞\r\n        await prisma.auditLog.create({\r\n          data: {\r\n            userId: request.user.id,\r\n            action: 'FILE_UPLOADED',\r\n            entity: 'File',\r\n            entityId: filename,\r\n            changes: {\r\n              originalName: sanitizedFilename,\r\n              size: fileSize,\r\n              mimetype: part.mimetype\r\n            },\r\n            ipAddress: request.ip\r\n          }\r\n        });\r\n        \r\n        uploadedFiles.push({\r\n          originalName: sanitizedFilename,\r\n          filename: filename,\r\n          mimetype: part.mimetype,\r\n          size: fileSize,\r\n          url: `/uploads/${filename}`\r\n        });\r\n        \r\n        // TODO: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MinIO –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è\r\n      }\r\n    }\r\n    \r\n    return {\r\n      success: true,\r\n      data: uploadedFiles\r\n    };\r\n  }\r\n});\r\n\r\n// –°—Ç–∞—Ç–∏–∫–∞ –¥–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤\r\n// TODO: –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ –∏–∑-–∑–∞ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –≤–µ—Ä—Å–∏–π\r\n// fastify.register(require('@fastify/static'), {\r\n//   root: path.join(process.cwd(), 'uploads'),\r\n//   prefix: '/uploads/',\r\n//   decorateReply: false\r\n// });\r\n\r\n// –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é\r\nconst config = require('./config');\r\n\r\n// Proxy –∫ —Å–µ—Ä–≤–∏—Å–∞–º\r\n// Auth service\r\nfastify.register(httpProxy, {\r\n  upstream: config.services.auth.url,\r\n  prefix: config.services.auth.prefix,\r\n  rewritePrefix: config.services.auth.prefix\r\n});\r\n\r\n// Machines service\r\nfastify.register(httpProxy, {\r\n  upstream: config.services.machines.url,\r\n  prefix: config.services.machines.prefix,\r\n  rewritePrefix: config.services.machines.prefix\r\n});\r\n\r\n// Inventory service\r\nfastify.register(httpProxy, {\r\n  upstream: config.services.inventory.url,\r\n  prefix: config.services.inventory.prefix,\r\n  rewritePrefix: config.services.inventory.prefix\r\n});\r\n\r\n// Tasks service\r\nfastify.register(httpProxy, {\r\n  upstream: config.services.tasks.url,\r\n  prefix: config.services.tasks.prefix,\r\n  rewritePrefix: config.services.tasks.prefix\r\n});\r\n\r\n// Bunkers service\r\nfastify.register(httpProxy, {\r\n  upstream: config.services.bunkers.url,\r\n  prefix: config.services.bunkers.prefix,\r\n  rewritePrefix: config.services.bunkers.prefix\r\n});\r\n\r\n// Routes service\r\nfastify.register(httpProxy, {\r\n  upstream: config.services.routes.url,\r\n  prefix: config.services.routes.prefix,\r\n  rewritePrefix: config.services.routes.prefix\r\n});\r\n\r\n// Warehouse service\r\nfastify.register(httpProxy, {\r\n  upstream: config.services.warehouse.url,\r\n  prefix: config.services.warehouse.prefix,\r\n  rewritePrefix: config.services.warehouse.prefix\r\n});\r\n\r\n// Notifications service\r\nfastify.register(httpProxy, {\r\n  upstream: config.services.notifications.url,\r\n  prefix: config.services.notifications.prefix,\r\n  rewritePrefix: config.services.notifications.prefix\r\n});\r\n\r\n// Monitoring service\r\nfastify.register(httpProxy, {\r\n  upstream: config.services.monitoring.url,\r\n  prefix: config.services.monitoring.prefix,\r\n  rewritePrefix: config.services.monitoring.prefix\r\n});\r\n\r\n// Backup service\r\nfastify.register(httpProxy, {\r\n  upstream: config.services.backup.url,\r\n  prefix: config.services.backup.prefix,\r\n  rewritePrefix: config.services.backup.prefix\r\n});\r\n\r\n// Audit service\r\nfastify.register(httpProxy, {\r\n  upstream: config.services.audit.url,\r\n  prefix: config.services.audit.prefix,\r\n  rewritePrefix: config.services.audit.prefix\r\n});\r\n\r\n// Dashboard stats endpoint\r\nfastify.get('/api/v1/dashboard/stats', {\r\n  preValidation: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    const [\r\n      totalMachines,\r\n      onlineMachines,\r\n      totalTasks,\r\n      pendingTasks,\r\n      totalUsers,\r\n      activeUsers,\r\n      inventoryItems,\r\n      lowStockItems\r\n    ] = await Promise.all([\r\n      prisma.machine.count(),\r\n      prisma.machine.count({ where: { status: 'ONLINE' } }),\r\n      prisma.task.count(),\r\n      prisma.task.count({ where: { status: { in: ['CREATED', 'ASSIGNED'] } } }),\r\n      prisma.user.count(),\r\n      prisma.user.count({ where: { isActive: true } }),\r\n      prisma.inventoryItem.count(),\r\n      prisma.inventoryItem.count({ \r\n        where: { \r\n          quantity: { lte: 10 } // TODO: –°–¥–µ–ª–∞—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º –∏–∑ –ø–æ–ª—è minQuantity\r\n        } \r\n      })\r\n    ]);\r\n    \r\n    // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏\r\n    const recentTransactions = await prisma.transaction.findMany({\r\n      take: 5,\r\n      orderBy: { createdAt: 'desc' }\r\n    });\r\n    \r\n    // –°—á–∏—Ç–∞–µ–º –≤—ã—Ä—É—á–∫—É –∑–∞ —Å–µ–≥–æ–¥–Ω—è\r\n    const todayStart = new Date();\r\n    todayStart.setHours(0, 0, 0, 0);\r\n    \r\n    const todayRevenue = await prisma.transaction.aggregate({\r\n      where: {\r\n        createdAt: { gte: todayStart },\r\n        status: 'SUCCESS'\r\n      },\r\n      _sum: { amount: true }\r\n    });\r\n    \r\n    const stats = {\r\n      totalMachines,\r\n      onlineMachines,\r\n      totalTasks,\r\n      pendingTasks,\r\n      totalUsers,\r\n      activeUsers,\r\n      inventoryItems,\r\n      lowStockItems,\r\n      todayRevenue: todayRevenue._sum.amount || 0,\r\n      totalRevenue: 156789.50, // TODO: –í—ã—á–∏—Å–ª–∏—Ç—å –∏–∑ –ë–î\r\n      recentTransactions\r\n    };\r\n    \r\n    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ WebSocket\r\n    broadcastToClients('stats_update', stats);\r\n    \r\n    return {\r\n      success: true,\r\n      data: stats\r\n    };\r\n  } catch (error) {\r\n    throw createError.database('Failed to fetch dashboard stats');\r\n  }\r\n});\r\n\r\n// –¢–µ—Å—Ç–æ–≤—ã–π endpoint –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\r\nfastify.get('/api/v1/test-db', async (request, reply) => {\r\n  try {\r\n    const [machines, tasks, users] = await Promise.all([\r\n      prisma.machine.count(),\r\n      prisma.task.count(),\r\n      prisma.user.count()\r\n    ]);\r\n    \r\n    return {\r\n      success: true,\r\n      data: {\r\n        machines,\r\n        tasks,\r\n        users,\r\n        database: 'connected'\r\n      }\r\n    };\r\n  } catch (error) {\r\n    return {\r\n      success: false,\r\n      error: error.message\r\n    };\r\n  }\r\n});\r\n\r\n// Audit log endpoint\r\nfastify.get('/api/v1/audit-log', {\r\n  preValidation: [fastify.authenticate]\r\n}, async (request, reply) => {\r\n  try {\r\n    const { entity, entityId, userId, from, to, skip = 0, take = 50 } = request.query;\r\n    \r\n    const where = {};\r\n    if (entity) where.entity = entity;\r\n    if (entityId) where.entityId = entityId;\r\n    if (userId) where.userId = userId;\r\n    \r\n    if (from || to) {\r\n      where.createdAt = {};\r\n      if (from) where.createdAt.gte = new Date(from);\r\n      if (to) where.createdAt.lte = new Date(to);\r\n    }\r\n    \r\n    const [logs, total] = await Promise.all([\r\n      prisma.auditLog.findMany({\r\n        where,\r\n        skip: parseInt(skip),\r\n        take: parseInt(take),\r\n        orderBy: { createdAt: 'desc' },\r\n        include: {\r\n          user: {\r\n            select: {\r\n              id: true,\r\n              name: true,\r\n              email: true\r\n            }\r\n          }\r\n        }\r\n      }),\r\n      prisma.auditLog.count({ where })\r\n    ]);\r\n    \r\n    return {\r\n      success: true,\r\n      data: {\r\n        items: logs,\r\n        total,\r\n        skip: parseInt(skip),\r\n        take: parseInt(take)\r\n      }\r\n    };\r\n  } catch (error) {\r\n    throw createError.database('Failed to fetch audit logs');\r\n  }\r\n});\r\n\r\n// Start server\r\nconst start = async () => {\r\n  try {\r\n    // –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∑–∞–≥—Ä—É–∑–æ–∫\r\n    const uploadDir = path.join(process.cwd(), 'uploads');\r\n    if (!fs.existsSync(uploadDir)) {\r\n      fs.mkdirSync(uploadDir, { recursive: true });\r\n    }\r\n    \r\n    const port = process.env.PORT || process.env.GATEWAY_PORT || 8000;\r\n    await fastify.listen({ \r\n      port: port,\r\n      host: '0.0.0.0'\r\n    });\r\n    console.log('Gateway is running on port', port);\r\n    console.log('WebSocket available at ws://localhost:' + port + '/ws');\r\n    \r\n    // Railway specific logging\r\n    if (process.env.RAILWAY_ENVIRONMENT) {\r\n      console.log('Running on Railway:', process.env.RAILWAY_STATIC_URL);\r\n    }\r\n  } catch (err) {\r\n    fastify.log.error(err);\r\n    process.exit(1);\r\n  }\r\n};\r\n\r\nstart();\r\n\r\n// Graceful shutdown\r\nprocess.on('SIGTERM', async () => {\r\n  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è\r\n  wsClients.forEach(client => {\r\n    client.close();\r\n  });\r\n  \r\n  await fastify.close();\r\n  await prisma.$disconnect();\r\n  process.exit(0);\r\n});\r\n\r\n// –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–∏ broadcast –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö\r\nmodule.exports = { broadcastToClients };\r\n",
  "services/notifications/src/services/notificationService.js": "/**\r\n * VHM24 Notification Service\r\n * –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤\r\n */\r\n\r\nconst { getPrismaClient } = require('@vhm24/database');\r\nconst TelegramBot = require('node-telegram-bot-api');\r\nconst nodemailer = require('nodemailer');\r\nconst winston = require('winston');\r\n\r\nclass NotificationService {\r\n  constructor() {\r\n    this.prisma = getPrismaClient();\r\n    this.logger = winston.createLogger({\r\n      level: 'info',\r\n      format: winston.format.combine(\r\n        winston.format.timestamp(),\r\n        winston.format.json()\r\n      ),\r\n      transports: [\r\n        new winston.transports.Console(),\r\n        new winston.transports.File({ filename: 'notifications.log' })\r\n      ]\r\n    });\r\n\r\n    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram –±–æ—Ç–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\r\n    if (process.env.TELEGRAM_BOT_TOKEN) {\r\n      this.telegramBot = new TelegramBot(process.env.TELEGRAM_BOT_TOKEN);\r\n    }\r\n\r\n    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è email —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞\r\n    this.emailTransporter = nodemailer.createTransport({\r\n      host: process.env.SMTP_HOST || 'smtp.gmail.com',\r\n      port: process.env.SMTP_PORT || 587,\r\n      secure: false,\r\n      auth: {\r\n        user: process.env.SMTP_USER,\r\n        pass: process.env.SMTP_PASS\r\n      }\r\n    });\r\n\r\n    // –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\r\n    this.notificationTypes = {\r\n      TASK_OVERDUE: {\r\n        priority: 'HIGH',\r\n        channels: ['telegram', 'email'],\r\n        template: 'task_overdue'\r\n      },\r\n      LOW_STOCK: {\r\n        priority: 'MEDIUM',\r\n        channels: ['telegram'],\r\n        template: 'low_stock'\r\n      },\r\n      MACHINE_OFFLINE: {\r\n        priority: 'HIGH',\r\n        channels: ['telegram', 'email'],\r\n        template: 'machine_offline'\r\n      },\r\n      ROUTE_COMPLETED: {\r\n        priority: 'LOW',\r\n        channels: ['telegram'],\r\n        template: 'route_completed'\r\n      },\r\n      MAINTENANCE_DUE: {\r\n        priority: 'MEDIUM',\r\n        channels: ['telegram', 'email'],\r\n        template: 'maintenance_due'\r\n      },\r\n      INCOMPLETE_DATA: {\r\n        priority: 'MEDIUM',\r\n        channels: ['telegram'],\r\n        template: 'incomplete_data'\r\n      },\r\n      SYSTEM_ALERT: {\r\n        priority: 'HIGH',\r\n        channels: ['telegram', 'email'],\r\n        template: 'system_alert'\r\n      },\r\n      FUEL_REPORT: {\r\n        priority: 'LOW',\r\n        channels: ['telegram'],\r\n        template: 'fuel_report'\r\n      },\r\n      ARRIVAL_CONFIRMATION: {\r\n        priority: 'LOW',\r\n        channels: ['telegram'],\r\n        template: 'arrival_confirmation'\r\n      },\r\n      WAREHOUSE_RECEIPT: {\r\n        priority: 'MEDIUM',\r\n        channels: ['telegram'],\r\n        template: 'warehouse_receipt'\r\n      }\r\n    };\r\n\r\n    // –®–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π\r\n    this.templates = {\r\n      task_overdue: {\r\n        telegram: '‚ö†Ô∏è *–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞*\\n\\nüìã {taskTitle}\\nüë§ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: {assignee}\\n‚è∞ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞ –Ω–∞: {overdueDays} –¥–Ω.\\n\\nüîó –ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–¥–∞—á–µ: /task_{taskId}',\r\n        email: {\r\n          subject: '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞: {taskTitle}',\r\n          html: '<h2>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞</h2><p><strong>–ó–∞–¥–∞—á–∞:</strong> {taskTitle}</p><p><strong>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</strong> {assignee}</p><p><strong>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞ –Ω–∞:</strong> {overdueDays} –¥–Ω–µ–π</p>'\r\n        }\r\n      },\r\n      low_stock: {\r\n        telegram: 'üì¶ *–ù–∏–∑–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫ —Ç–æ–≤–∞—Ä–∞*\\n\\nüè∑Ô∏è {itemName}\\nüìä –û—Å—Ç–∞—Ç–æ–∫: {quantity} {unit}\\n‚ö†Ô∏è –ú–∏–Ω–∏–º—É–º: {minQuantity} {unit}\\nüìç –°–∫–ª–∞–¥: {warehouse}',\r\n        email: {\r\n          subject: '–ù–∏–∑–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {itemName}',\r\n          html: '<h2>–ù–∏–∑–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫ —Ç–æ–≤–∞—Ä–∞</h2><p><strong>–¢–æ–≤–∞—Ä:</strong> {itemName}</p><p><strong>–û—Å—Ç–∞—Ç–æ–∫:</strong> {quantity} {unit}</p>'\r\n        }\r\n      },\r\n      machine_offline: {\r\n        telegram: 'üö® *–ê–≤—Ç–æ–º–∞—Ç –Ω–µ –≤ —Å–µ—Ç–∏*\\n\\nü§ñ {machineName}\\nüìç {location}\\n‚è∞ –ù–µ –≤ —Å–µ—Ç–∏: {offlineTime}\\n\\nüîß –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞',\r\n        email: {\r\n          subject: '–ê–≤—Ç–æ–º–∞—Ç –Ω–µ –≤ —Å–µ—Ç–∏: {machineName}',\r\n          html: '<h2>–ê–≤—Ç–æ–º–∞—Ç –Ω–µ –≤ —Å–µ—Ç–∏</h2><p><strong>–ê–≤—Ç–æ–º–∞—Ç:</strong> {machineName}</p><p><strong>–ê–¥—Ä–µ—Å:</strong> {location}</p>'\r\n        }\r\n      },\r\n      route_completed: {\r\n        telegram: '‚úÖ *–ú–∞—Ä—à—Ä—É—Ç –∑–∞–≤–µ—Ä—à–µ–Ω*\\n\\nüöõ {routeName}\\nüë§ –í–æ–¥–∏—Ç–µ–ª—å: {driverName}\\n‚è∞ –í—Ä–µ–º—è: {completionTime}\\nüìä –û—Å—Ç–∞–Ω–æ–≤–æ–∫: {stopsCount}',\r\n        email: {\r\n          subject: '–ú–∞—Ä—à—Ä—É—Ç –∑–∞–≤–µ—Ä—à–µ–Ω: {routeName}',\r\n          html: '<h2>–ú–∞—Ä—à—Ä—É—Ç –∑–∞–≤–µ—Ä—à–µ–Ω</h2><p><strong>–ú–∞—Ä—à—Ä—É—Ç:</strong> {routeName}</p><p><strong>–í–æ–¥–∏—Ç–µ–ª—å:</strong> {driverName}</p>'\r\n        }\r\n      },\r\n      maintenance_due: {\r\n        telegram: 'üîß *–¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–µ—Ö–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ*\\n\\nü§ñ {machineName}\\nüìç {location}\\nüìÖ –ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞: {dueDate}\\n‚ö†Ô∏è –ü—Ä–æ—Å—Ä–æ—á–∫–∞: {overdueDays} –¥–Ω.',\r\n        email: {\r\n          subject: '–¢—Ä–µ–±—É–µ—Ç—Å—è –¢–û: {machineName}',\r\n          html: '<h2>–¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</h2><p><strong>–ê–≤—Ç–æ–º–∞—Ç:</strong> {machineName}</p><p><strong>–ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞:</strong> {dueDate}</p>'\r\n        }\r\n      },\r\n      incomplete_data: {\r\n        telegram: 'üìù *–ù–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ*\\n\\nüë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {userName}\\nüìã –ü–æ–ª—è: {missingFields}\\n‚è∞ –í—Ä–µ–º—è: {timestamp}',\r\n        email: {\r\n          subject: '–ù–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç {userName}',\r\n          html: '<h2>–ù–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2><p><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> {userName}</p><p><strong>–ü–æ–ª—è:</strong> {missingFields}</p>'\r\n        }\r\n      },\r\n      system_alert: {\r\n        telegram: 'üö® *–°–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ*\\n\\n‚ö†Ô∏è {alertType}\\nüìù {message}\\n‚è∞ {timestamp}',\r\n        email: {\r\n          subject: '–°–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: {alertType}',\r\n          html: '<h2>–°–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h2><p><strong>–¢–∏–ø:</strong> {alertType}</p><p><strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong> {message}</p>'\r\n        }\r\n      },\r\n      fuel_report: {\r\n        telegram: '‚õΩ *–û—Ç—á–µ—Ç –æ –∑–∞–ø—Ä–∞–≤–∫–µ*\\n\\nüöõ –í–æ–¥–∏—Ç–µ–ª—å: {driverName}\\nüí∞ –°—É–º–º–∞: {amount} —Å—É–º\\nüìç –õ–æ–∫–∞—Ü–∏—è: {location}\\n‚è∞ {timestamp}',\r\n        email: {\r\n          subject: '–û—Ç—á–µ—Ç –æ –∑–∞–ø—Ä–∞–≤–∫–µ –æ—Ç {driverName}',\r\n          html: '<h2>–û—Ç—á–µ—Ç –æ –∑–∞–ø—Ä–∞–≤–∫–µ</h2><p><strong>–í–æ–¥–∏—Ç–µ–ª—å:</strong> {driverName}</p><p><strong>–°—É–º–º–∞:</strong> {amount} —Å—É–º</p>'\r\n        }\r\n      },\r\n      arrival_confirmation: {\r\n        telegram: 'üìç *–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–∏–±—ã—Ç–∏—è*\\n\\nüë§ {driverName}\\nüéØ {stopName}\\nüìç {location}\\n‚è∞ {arrivalTime}',\r\n        email: {\r\n          subject: '–ü—Ä–∏–±—ã—Ç–∏–µ: {driverName} - {stopName}',\r\n          html: '<h2>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–∏–±—ã—Ç–∏—è</h2><p><strong>–í–æ–¥–∏—Ç–µ–ª—å:</strong> {driverName}</p><p><strong>–û—Å—Ç–∞–Ω–æ–≤–∫–∞:</strong> {stopName}</p>'\r\n        }\r\n      },\r\n      warehouse_receipt: {\r\n        telegram: 'üì¶ *–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –Ω–∞ —Å–∫–ª–∞–¥*\\n\\nüè∑Ô∏è {itemName}\\nüìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {quantity} {unit}\\nüë§ –ü—Ä–∏–Ω—è–ª: {receiverName}\\n‚è∞ {timestamp}',\r\n        email: {\r\n          subject: '–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ: {itemName}',\r\n          html: '<h2>–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –Ω–∞ —Å–∫–ª–∞–¥</h2><p><strong>–¢–æ–≤–∞—Ä:</strong> {itemName}</p><p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</strong> {quantity} {unit}</p>'\r\n        }\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\r\n   */\r\n  async sendNotification(type, recipients, data, options = {}) {\r\n    try {\r\n      const notificationConfig = this.notificationTypes[type];\r\n      if (!notificationConfig) {\r\n        throw new Error(`Unknown notification type: ${type}`);\r\n      }\r\n\r\n      // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)\r\n      let notification = null;\r\n      try {\r\n        notification = await this.prisma.notification.create({\r\n          data: {\r\n            type,\r\n            title: this.generateTitle(type, data),\r\n            message: this.generateMessage(type, data, 'telegram'),\r\n            recipients: Array.isArray(recipients) ? recipients : [recipients],\r\n            priority: notificationConfig.priority,\r\n            channels: notificationConfig.channels,\r\n            data: data,\r\n            status: 'PENDING'\r\n          }\r\n        });\r\n      } catch (dbError) {\r\n        this.logger.warn('Database notification table not available, continuing without DB logging');\r\n      }\r\n\r\n      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ –≤—Å–µ–º –∫–∞–Ω–∞–ª–∞–º\r\n      const results = [];\r\n      for (const channel of notificationConfig.channels) {\r\n        if (options.channels && !options.channels.includes(channel)) {\r\n          continue;\r\n        }\r\n\r\n        try {\r\n          const result = await this.sendByChannel(channel, type, recipients, data);\r\n          results.push({ channel, success: true, result });\r\n        } catch (error) {\r\n          this.logger.error(`Failed to send ${type} via ${channel}:`, error);\r\n          results.push({ channel, success: false, error: error.message });\r\n        }\r\n      }\r\n\r\n      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞)\r\n      const allSuccess = results.every(r => r.success);\r\n      if (notification) {\r\n        try {\r\n          await this.prisma.notification.update({\r\n            where: { id: notification.id },\r\n            data: {\r\n              status: allSuccess ? 'SENT' : 'FAILED',\r\n              sentAt: allSuccess ? new Date() : null,\r\n              deliveryResults: results\r\n            }\r\n          });\r\n        } catch (updateError) {\r\n          this.logger.warn('Failed to update notification status in database');\r\n        }\r\n      }\r\n\r\n      return {\r\n        notificationId: notification?.id || 'no-db',\r\n        success: allSuccess,\r\n        results\r\n      };\r\n\r\n    } catch (error) {\r\n      this.logger.error('Send notification error:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∫–∞–Ω–∞–ª—É\r\n   */\r\n  async sendByChannel(channel, type, recipients, data) {\r\n    switch (channel) {\r\n      case 'telegram':\r\n        return await this.sendTelegram(type, recipients, data);\r\n      case 'email':\r\n        return await this.sendEmail(type, recipients, data);\r\n      case 'sms':\r\n        return await this.sendSMS(type, recipients, data);\r\n      default:\r\n        throw new Error(`Unsupported channel: ${channel}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –û—Ç–ø—Ä–∞–≤–∫–∞ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\r\n   */\r\n  async sendTelegram(type, recipients, data) {\r\n    if (!this.telegramBot) {\r\n      throw new Error('Telegram bot not configured');\r\n    }\r\n\r\n    const message = this.generateMessage(type, data, 'telegram');\r\n    const results = [];\r\n\r\n    for (const recipient of Array.isArray(recipients) ? recipients : [recipients]) {\r\n      try {\r\n        // –ü–æ–ª—É—á–∞–µ–º Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n        const user = await this.prisma.user.findFirst({\r\n          where: {\r\n            OR: [\r\n              { id: recipient },\r\n              { email: recipient },\r\n              { telegramId: recipient }\r\n            ]\r\n          }\r\n        });\r\n\r\n        if (!user?.telegramId) {\r\n          throw new Error(`No Telegram ID for recipient: ${recipient}`);\r\n        }\r\n\r\n        await this.telegramBot.sendMessage(user.telegramId, message, {\r\n          parse_mode: 'Markdown',\r\n          disable_web_page_preview: true\r\n        });\r\n\r\n        results.push({ recipient, success: true });\r\n      } catch (error) {\r\n        results.push({ recipient, success: false, error: error.message });\r\n      }\r\n    }\r\n\r\n    return results;\r\n  }\r\n\r\n  /**\r\n   * –û—Ç–ø—Ä–∞–≤–∫–∞ Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\r\n   */\r\n  async sendEmail(type, recipients, data) {\r\n    if (!this.emailTransporter) {\r\n      throw new Error('Email transporter not configured');\r\n    }\r\n\r\n    const template = this.templates[this.notificationTypes[type].template]?.email;\r\n    if (!template) {\r\n      throw new Error(`No email template for type: ${type}`);\r\n    }\r\n\r\n    const subject = this.interpolateTemplate(template.subject, data);\r\n    const html = this.interpolateTemplate(template.html, data);\r\n\r\n    const results = [];\r\n\r\n    for (const recipient of Array.isArray(recipients) ? recipients : [recipients]) {\r\n      try {\r\n        // –ü–æ–ª—É—á–∞–µ–º email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n        let email = recipient;\r\n        if (!recipient.includes('@')) {\r\n          const user = await this.prisma.user.findFirst({\r\n            where: { id: recipient }\r\n          });\r\n          email = user?.email;\r\n        }\r\n\r\n        if (!email) {\r\n          throw new Error(`No email for recipient: ${recipient}`);\r\n        }\r\n\r\n        await this.emailTransporter.sendMail({\r\n          from: process.env.SMTP_FROM || 'noreply@vhm24.com',\r\n          to: email,\r\n          subject,\r\n          html\r\n        });\r\n\r\n        results.push({ recipient, success: true });\r\n      } catch (error) {\r\n        results.push({ recipient, success: false, error: error.message });\r\n      }\r\n    }\r\n\r\n    return results;\r\n  }\r\n\r\n  /**\r\n   * –û—Ç–ø—Ä–∞–≤–∫–∞ SMS —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–∑–∞–≥–ª—É—à–∫–∞)\r\n   */\r\n  async sendSMS(type, recipients, data) {\r\n    // TODO: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SMS –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º\r\n    this.logger.info('SMS sending not implemented yet');\r\n    return [];\r\n  }\r\n\r\n  /**\r\n   * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\r\n   */\r\n  generateTitle(type, data) {\r\n    const titles = {\r\n      TASK_OVERDUE: `–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞: ${data.taskTitle}`,\r\n      LOW_STOCK: `–ù–∏–∑–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫: ${data.itemName}`,\r\n      MACHINE_OFFLINE: `–ê–≤—Ç–æ–º–∞—Ç –Ω–µ –≤ —Å–µ—Ç–∏: ${data.machineName}`,\r\n      ROUTE_COMPLETED: `–ú–∞—Ä—à—Ä—É—Ç –∑–∞–≤–µ—Ä—à–µ–Ω: ${data.routeName}`,\r\n      MAINTENANCE_DUE: `–¢—Ä–µ–±—É–µ—Ç—Å—è –¢–û: ${data.machineName}`,\r\n      INCOMPLETE_DATA: `–ù–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: ${data.userName}`,\r\n      SYSTEM_ALERT: `–°–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: ${data.alertType}`,\r\n      FUEL_REPORT: `–ó–∞–ø—Ä–∞–≤–∫–∞: ${data.driverName}`,\r\n      ARRIVAL_CONFIRMATION: `–ü—Ä–∏–±—ã—Ç–∏–µ: ${data.driverName}`,\r\n      WAREHOUSE_RECEIPT: `–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ: ${data.itemName}`\r\n    };\r\n\r\n    return titles[type] || `–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: ${type}`;\r\n  }\r\n\r\n  /**\r\n   * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ —à–∞–±–ª–æ–Ω—É\r\n   */\r\n  generateMessage(type, data, channel) {\r\n    const notificationConfig = this.notificationTypes[type];\r\n    const template = this.templates[notificationConfig.template]?.[channel];\r\n    \r\n    if (!template) {\r\n      return `–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ ${type}: ${JSON.stringify(data)}`;\r\n    }\r\n\r\n    return this.interpolateTemplate(template, data);\r\n  }\r\n\r\n  /**\r\n   * –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è —à–∞–±–ª–æ–Ω–∞\r\n   */\r\n  interpolateTemplate(template, data) {\r\n    return template.replace(/\\{(\\w+)\\}/g, (match, key) => {\r\n      return data[key] !== undefined ? data[key] : match;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * –ú–∞—Å—Å–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é\r\n   */\r\n  async sendScheduledNotifications() {\r\n    try {\r\n      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏\r\n      await this.checkOverdueTasks();\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∏–∑–∫–∏–µ –æ—Å—Ç–∞—Ç–∫–∏\r\n      await this.checkLowStock();\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ñ–ª–∞–π–Ω –∞–≤—Ç–æ–º–∞—Ç—ã\r\n      await this.checkOfflineMachines();\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–µ –¢–û\r\n      await this.checkOverdueMaintenance();\r\n\r\n      this.logger.info('Scheduled notifications check completed');\r\n    } catch (error) {\r\n      this.logger.error('Scheduled notifications error:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á\r\n   */\r\n  async checkOverdueTasks() {\r\n    const overdueTasks = await this.prisma.task.findMany({\r\n      where: {\r\n        status: { in: ['CREATED', 'ASSIGNED', 'IN_PROGRESS'] },\r\n        dueDate: { lt: new Date() }\r\n      },\r\n      include: {\r\n        assignee: true\r\n      }\r\n    });\r\n\r\n    for (const task of overdueTasks) {\r\n      const overdueDays = Math.floor((new Date() - task.dueDate) / (1000 * 60 * 60 * 24));\r\n      \r\n      await this.sendNotification('TASK_OVERDUE', [task.assigneeId], {\r\n        taskId: task.id,\r\n        taskTitle: task.title,\r\n        assignee: task.assignee.name,\r\n        overdueDays\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∏–∑–∫–∏—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤\r\n   */\r\n  async checkLowStock() {\r\n    try {\r\n      // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–≤–∞—Ä—ã —Å –Ω–∏–∑–∫–∏–º–∏ –æ—Å—Ç–∞—Ç–∫–∞–º–∏\r\n      const lowStockItems = await this.prisma.inventoryItem.findMany({\r\n        where: {\r\n          AND: [\r\n            { quantity: { not: null } },\r\n            { minQuantity: { not: null } }\r\n          ]\r\n        }\r\n      });\r\n\r\n      // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã —Å –Ω–∏–∑–∫–∏–º–∏ –æ—Å—Ç–∞—Ç–∫–∞–º–∏\r\n      const filteredItems = lowStockItems.filter(item => \r\n        item.quantity <= (item.minQuantity || 0)\r\n      );\r\n\r\n      for (const item of filteredItems) {\r\n        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º —Å–∫–ª–∞–¥–∞\r\n        const warehouseManagers = await this.prisma.user.findMany({\r\n          where: {\r\n            roles: { has: 'WAREHOUSE_MANAGER' },\r\n            isActive: true\r\n          }\r\n        });\r\n\r\n        for (const manager of warehouseManagers) {\r\n          await this.sendNotification('LOW_STOCK', [manager.id], {\r\n            itemName: item.name,\r\n            quantity: item.quantity,\r\n            unit: item.unit || '—à—Ç',\r\n            minQuantity: item.minQuantity || 0,\r\n            warehouse: '–û—Å–Ω–æ–≤–Ω–æ–π —Å–∫–ª–∞–¥'\r\n          });\r\n        }\r\n      }\r\n    } catch (error) {\r\n      this.logger.error('Check low stock error:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ñ–ª–∞–π–Ω –∞–≤—Ç–æ–º–∞—Ç–æ–≤\r\n   */\r\n  async checkOfflineMachines() {\r\n    const offlineThreshold = new Date(Date.now() - 30 * 60 * 1000); // 30 –º–∏–Ω—É—Ç\r\n    \r\n    const offlineMachines = await this.prisma.machine.findMany({\r\n      where: {\r\n        lastPing: { lt: offlineThreshold },\r\n        status: { not: 'MAINTENANCE' }\r\n      }\r\n    });\r\n\r\n    for (const machine of offlineMachines) {\r\n      const offlineTime = Math.floor((new Date() - machine.lastPing) / (1000 * 60));\r\n      \r\n      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Ö–Ω–∏–∫–∞–º\r\n      const technicians = await this.prisma.user.findMany({\r\n        where: {\r\n          role: 'TECHNICIAN',\r\n          isActive: true\r\n        }\r\n      });\r\n\r\n      for (const technician of technicians) {\r\n        await this.sendNotification('MACHINE_OFFLINE', [technician.id], {\r\n          machineName: machine.name,\r\n          location: machine.location?.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω',\r\n          offlineTime: `${offlineTime} –º–∏–Ω`\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–≥–æ –¢–û\r\n   */\r\n  async checkOverdueMaintenance() {\r\n    const overdueMaintenance = await this.prisma.maintenanceSchedule.findMany({\r\n      where: {\r\n        nextMaintenanceDate: { lt: new Date() },\r\n        status: 'SCHEDULED'\r\n      },\r\n      include: {\r\n        machine: true\r\n      }\r\n    });\r\n\r\n    for (const maintenance of overdueMaintenance) {\r\n      const overdueDays = Math.floor((new Date() - maintenance.nextMaintenanceDate) / (1000 * 60 * 60 * 24));\r\n      \r\n      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Ö–Ω–∏–∫–∞–º\r\n      const technicians = await this.prisma.user.findMany({\r\n        where: {\r\n          role: 'TECHNICIAN',\r\n          isActive: true\r\n        }\r\n      });\r\n\r\n      for (const technician of technicians) {\r\n        await this.sendNotification('MAINTENANCE_DUE', [technician.id], {\r\n          machineName: maintenance.machine.name,\r\n          location: maintenance.machine.location?.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω',\r\n          dueDate: maintenance.nextMaintenanceDate.toLocaleDateString('ru-RU'),\r\n          overdueDays\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\r\n   */\r\n  async getNotificationHistory(filters = {}) {\r\n    const where = {};\r\n    \r\n    if (filters.type) where.type = filters.type;\r\n    if (filters.status) where.status = filters.status;\r\n    if (filters.priority) where.priority = filters.priority;\r\n    if (filters.dateFrom) where.createdAt = { gte: new Date(filters.dateFrom) };\r\n    if (filters.dateTo) where.createdAt = { ...where.createdAt, lte: new Date(filters.dateTo) };\r\n\r\n    return await this.prisma.notification.findMany({\r\n      where,\r\n      orderBy: { createdAt: 'desc' },\r\n      take: filters.limit || 100,\r\n      skip: filters.offset || 0\r\n    });\r\n  }\r\n\r\n  /**\r\n   * –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\r\n   */\r\n  async getNotificationStats(period = '7d') {\r\n    const dateFrom = new Date();\r\n    if (period === '7d') dateFrom.setDate(dateFrom.getDate() - 7);\r\n    else if (period === '30d') dateFrom.setDate(dateFrom.getDate() - 30);\r\n    else if (period === '1y') dateFrom.setFullYear(dateFrom.getFullYear() - 1);\r\n\r\n    const stats = await this.prisma.notification.groupBy({\r\n      by: ['type', 'status'],\r\n      where: {\r\n        createdAt: { gte: dateFrom }\r\n      },\r\n      _count: true\r\n    });\r\n\r\n    return stats;\r\n  }\r\n}\r\n\r\nmodule.exports = NotificationService;\r\n",
  "services/telegram-bot/src/handlers/warehouseHandler.js": "/**\r\n * VHM24 Warehouse Handler with FSM\r\n * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–∫–ª–∞–¥—Å–∫–∏—Ö —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏—è –∏ —Ñ–æ—Ç–æ—Ñ–∏–∫—Å–∞—Ü–∏–∏\r\n */\r\n\r\nconst fsmManager = require('../fsm/manager');\r\nconst { WAREHOUSE_STATES, COMMON_STATES } = require('../fsm/states');\r\nconst qrScanner = require('../utils/qrScanner');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\n/**\r\n * –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å–∫–ª–∞–¥—Å–∫–æ–≥–æ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞\r\n */\r\nasync function showWarehouseMenu(bot, msg) {\r\n  const chatId = msg.chat.id;\r\n  const userId = msg.from.id;\r\n\r\n  try {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n    const userInfo = await getUserInfo(userId);\r\n    if (!userInfo || !userInfo.roles.includes('WAREHOUSE')) {\r\n      await bot.sendMessage(chatId,\r\n        `‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ —Å–∫–ª–∞–¥—Å–∫–æ–≥–æ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.`\r\n      );\r\n      return;\r\n    }\r\n\r\n    // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∫–ª–∞–¥–∞\r\n    const stats = await getWarehouseStats();\r\n\r\n    let message = `üì¶ *–ú–µ–Ω—é —Å–∫–ª–∞–¥–∞*\\n\\n`;\r\n    message += `üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:*\\n`;\r\n    message += `üì¶ –í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤: ${stats.totalItems || 0}\\n`;\r\n    message += `‚ö†Ô∏è –ù–∏–∑–∫–∏–µ –æ—Å—Ç–∞—Ç–∫–∏: ${stats.lowStock || 0}\\n`;\r\n    message += `üì• –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è: ${stats.todayReceived || 0}\\n`;\r\n    message += `üì§ –û—Ç–≥—Ä—É–∂–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è: ${stats.todayShipped || 0}\\n\\n`;\r\n\r\n    const keyboards = [\r\n      [\r\n        { text: 'üì• –ü—Ä–∏—ë–º —Ç–æ–≤–∞—Ä–∞', callback_data: 'warehouse_receive' },\r\n        { text: 'üì§ –û—Ç–≥—Ä—É–∑–∫–∞', callback_data: 'warehouse_ship' }\r\n      ],\r\n      [\r\n        { text: 'üóÉÔ∏è –ó–∞–ø–æ–ª–Ω–∏—Ç—å –±—É–Ω–∫–µ—Ä', callback_data: 'warehouse_fill_bunker' },\r\n        { text: '‚öñÔ∏è –í–∑–≤–µ—à–∏–≤–∞–Ω–∏–µ', callback_data: 'warehouse_weigh' }\r\n      ],\r\n      [\r\n        { text: 'üìã –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è', callback_data: 'warehouse_inventory' },\r\n        { text: 'üìä –û—Å—Ç–∞—Ç–∫–∏', callback_data: 'warehouse_stock' }\r\n      ],\r\n      [\r\n        { text: 'üì∏ –§–æ—Ç–æ –æ—Ç—á—ë—Ç', callback_data: 'warehouse_photo_report' },\r\n        { text: 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å', callback_data: 'warehouse_refresh' }\r\n      ],\r\n      [\r\n        { text: 'üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', callback_data: 'main_menu' }\r\n      ]\r\n    ];\r\n\r\n    await bot.sendMessage(chatId, message, {\r\n      parse_mode: 'Markdown',\r\n      reply_markup: {\r\n        inline_keyboard: keyboards\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    global.logger.error('Warehouse menu error:', error);\r\n    await bot.sendMessage(chatId,\r\n      `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–µ–Ω—é —Å–∫–ª–∞–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.`\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * –ü—Ä–∏—ë–º —Ç–æ–≤–∞—Ä–∞\r\n */\r\nasync function receiveItems(bot, callbackQuery) {\r\n  const chatId = callbackQuery.message.chat.id;\r\n  const userId = callbackQuery.from.id;\r\n\r\n  try {\r\n    await fsmManager.setUserState(userId, WAREHOUSE_STATES.WAITING_ITEM_SCAN);\r\n    await fsmManager.setUserData(userId, {\r\n      action: 'receive_items',\r\n      items: []\r\n    });\r\n\r\n    await bot.editMessageText(\r\n      `üì• *–ü—Ä–∏—ë–º —Ç–æ–≤–∞—Ä–∞*\\n\\n` +\r\n      `üì± –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥ —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª:\\n\\n` +\r\n      `üí° *–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:*\\n` +\r\n      `‚Ä¢ –®—Ç—Ä–∏—Ö-–∫–æ–¥ (—Ñ–æ—Ç–æ)\\n` +\r\n      `‚Ä¢ –ê—Ä—Ç–∏–∫—É–ª (—Ç–µ–∫—Å—Ç)\\n` +\r\n      `‚Ä¢ QR-–∫–æ–¥ (—Ñ–æ—Ç–æ)`,\r\n      {\r\n        chat_id: chatId,\r\n        message_id: callbackQuery.message.message_id,\r\n        parse_mode: 'Markdown',\r\n        reply_markup: {\r\n          inline_keyboard: [\r\n            [{ text: 'üì∏ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —à—Ç—Ä–∏—Ö-–∫–æ–¥', callback_data: 'warehouse_scan_barcode' }],\r\n            [{ text: '‚ùå –û—Ç–º–µ–Ω–∞', callback_data: 'warehouse_cancel' }]\r\n          ]\r\n        }\r\n      }\r\n    );\r\n\r\n    await bot.answerCallbackQuery(callbackQuery.id);\r\n\r\n  } catch (error) {\r\n    global.logger.error('Receive items error:', error);\r\n    await bot.answerCallbackQuery(callbackQuery.id, {\r\n      text: '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –ø—Ä–∏—ë–º–∞ —Ç–æ–≤–∞—Ä–∞',\r\n      show_alert: true\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞\r\n */\r\nasync function handleItemScan(bot, msg) {\r\n  const chatId = msg.chat.id;\r\n  const userId = msg.from.id;\r\n\r\n  try {\r\n    const currentState = await fsmManager.getUserState(userId);\r\n    \r\n    if (currentState !== WAREHOUSE_STATES.WAITING_ITEM_SCAN) {\r\n      return false;\r\n    }\r\n\r\n    let itemCode = null;\r\n\r\n    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ (—à—Ç—Ä–∏—Ö-–∫–æ–¥/QR-–∫–æ–¥)\r\n    if (msg.photo) {\r\n      await bot.sendMessage(chatId, `üì∏ –§–æ—Ç–æ –ø–æ–ª—É—á–µ–Ω–æ. –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞...`);\r\n      \r\n      try {\r\n        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ\r\n        const photo = msg.photo[msg.photo.length - 1]; // –ë–µ—Ä–µ–º —Å–∞–º–æ–µ –±–æ–ª—å—à–æ–µ —Ñ–æ—Ç–æ\r\n        const fileInfo = await bot.getFile(photo.file_id);\r\n        const fileUrl = `https://api.telegram.org/file/bot${process.env.TELEGRAM_BOT_TOKEN}/${fileInfo.file_path}`;\r\n        \r\n        // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç\r\n        const tempDir = path.join(__dirname, '../../../temp');\r\n        if (!fs.existsSync(tempDir)) {\r\n          fs.mkdirSync(tempDir, { recursive: true });\r\n        }\r\n        \r\n        // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª\r\n        const axios = require('axios');\r\n        const response = await axios({\r\n          method: 'GET',\r\n          url: fileUrl,\r\n          responseType: 'arraybuffer'\r\n        });\r\n        \r\n        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª\r\n        const tempFilePath = path.join(tempDir, `temp_${Date.now()}.jpg`);\r\n        fs.writeFileSync(tempFilePath, response.data);\r\n        \r\n        // –†–∞—Å–ø–æ–∑–Ω–∞–µ–º QR-–∫–æ–¥\r\n        const qrData = await qrScanner.scanQRCodeFromFile(tempFilePath);\r\n        \r\n        // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª\r\n        fs.unlinkSync(tempFilePath);\r\n        \r\n        if (qrData) {\r\n          // –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ QR-–∫–æ–¥–∞\r\n          const parsedData = qrScanner.parseQRData(qrData);\r\n          \r\n          if (parsedData.success) {\r\n            global.logger.info('QR code detected:', parsedData);\r\n            \r\n            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã QR-–∫–æ–¥–æ–≤\r\n            if (parsedData.type === 'inventory') {\r\n              // –ü–æ–ª—É—á–∞–µ–º ID —Ç–æ–≤–∞—Ä–∞\r\n              const itemId = parsedData.data.id;\r\n              \r\n              // –ò—â–µ–º —Ç–æ–≤–∞—Ä –ø–æ ID\r\n              const item = await findItemById(itemId);\r\n              \r\n              if (item) {\r\n                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤–≤–æ–¥—É –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞\r\n                await fsmManager.setUserState(userId, WAREHOUSE_STATES.WAITING_QUANTITY_INPUT);\r\n                await fsmManager.updateUserData(userId, {\r\n                  currentItem: item\r\n                });\r\n                \r\n                await bot.sendMessage(chatId,\r\n                  `‚úÖ *–¢–æ–≤–∞—Ä –Ω–∞–π–¥–µ–Ω –ø–æ QR-–∫–æ–¥—É:*\\n\\n` +\r\n                  `üì¶ ${item.name}\\n` +\r\n                  `üè∑Ô∏è –ê—Ä—Ç–∏–∫—É–ª: ${item.sku}\\n` +\r\n                  `üìä –¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: ${item.quantity} ${item.unit}\\n\\n` +\r\n                  `üìù –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –ø—Ä–∏—ë–º–∞:`,\r\n                  { \r\n                    parse_mode: 'Markdown',\r\n                    reply_markup: {\r\n                      inline_keyboard: [\r\n                        [{ text: '‚ùå –û—Ç–º–µ–Ω–∞', callback_data: 'warehouse_cancel' }]\r\n                      ]\r\n                    }\r\n                  }\r\n                );\r\n                \r\n                return true;\r\n              }\r\n            } else if (parsedData.type === 'machine') {\r\n              // –ü–æ–ª—É—á–∞–µ–º ID –º–∞—à–∏–Ω—ã\r\n              const machineId = parsedData.data.id;\r\n              \r\n              await bot.sendMessage(chatId,\r\n                `‚úÖ *–†–∞—Å–ø–æ–∑–Ω–∞–Ω QR-–∫–æ–¥ –º–∞—à–∏–Ω—ã:*\\n\\n` +\r\n                `üÜî ID: ${machineId}\\n\\n` +\r\n                `‚ö†Ô∏è –î–ª—è –ø—Ä–∏—ë–º–∞ —Ç–æ–≤–∞—Ä–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥ —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ –≤–≤–µ—Å—Ç–∏ –∞—Ä—Ç–∏–∫—É–ª.`\r\n              );\r\n              \r\n              return true;\r\n            } else if (parsedData.type === 'task') {\r\n              // –ü–æ–ª—É—á–∞–µ–º ID –∑–∞–¥–∞—á–∏\r\n              const taskId = parsedData.data.id;\r\n              \r\n              await bot.sendMessage(chatId,\r\n                `‚úÖ *–†–∞—Å–ø–æ–∑–Ω–∞–Ω QR-–∫–æ–¥ –∑–∞–¥–∞—á–∏:*\\n\\n` +\r\n                `üÜî ID: ${taskId}\\n\\n` +\r\n                `‚ö†Ô∏è –î–ª—è –ø—Ä–∏—ë–º–∞ —Ç–æ–≤–∞—Ä–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥ —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ –≤–≤–µ—Å—Ç–∏ –∞—Ä—Ç–∏–∫—É–ª.`\r\n              );\r\n              \r\n              return true;\r\n            } else {\r\n              // –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø QR-–∫–æ–¥–∞\r\n              await bot.sendMessage(chatId,\r\n                `‚ö†Ô∏è –†–∞—Å–ø–æ–∑–Ω–∞–Ω QR-–∫–æ–¥ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞.\\n\\n` +\r\n                `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª –≤—Ä—É—á–Ω—É—é:`\r\n              );\r\n              \r\n              return true;\r\n            }\r\n          }\r\n        }\r\n        \r\n        // –ï—Å–ª–∏ QR-–∫–æ–¥ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω —Ç–æ–≤–∞—Ä\r\n        await bot.sendMessage(chatId,\r\n          `‚ö†Ô∏è QR-–∫–æ–¥ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∏–ª–∏ —Ç–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω.\\n\\n` +\r\n          `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª —Ç–æ–≤–∞—Ä–∞ –≤—Ä—É—á–Ω—É—é:`\r\n        );\r\n      } catch (error) {\r\n        global.logger.error('QR code scanning error:', error);\r\n        await bot.sendMessage(chatId,\r\n          `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏ QR-–∫–æ–¥–∞.\\n\\n` +\r\n          `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª —Ç–æ–≤–∞—Ä–∞ –≤—Ä—É—á–Ω—É—é:`\r\n        );\r\n      }\r\n      \r\n      return true;\r\n    }\r\n\r\n    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ (–∞—Ä—Ç–∏–∫—É–ª)\r\n    if (msg.text) {\r\n      itemCode = msg.text.trim();\r\n    }\r\n\r\n    if (!itemCode) {\r\n      await bot.sendMessage(chatId,\r\n        `‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª —Ç–æ–≤–∞—Ä–∞.`\r\n      );\r\n      return true;\r\n    }\r\n\r\n    // –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ –≤ –±–∞–∑–µ\r\n    const item = await findItemByCode(itemCode);\r\n    \r\n    if (!item) {\r\n      await bot.sendMessage(chatId,\r\n        `‚ùå –¢–æ–≤–∞—Ä —Å –∞—Ä—Ç–∏–∫—É–ª–æ–º \"${itemCode}\" –Ω–µ –Ω–∞–π–¥–µ–Ω.\\n\\n` +\r\n        `–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.`\r\n      );\r\n      return true;\r\n    }\r\n\r\n    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤–≤–æ–¥—É –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞\r\n    await fsmManager.setUserState(userId, WAREHOUSE_STATES.WAITING_QUANTITY_INPUT);\r\n    await fsmManager.updateUserData(userId, {\r\n      currentItem: item\r\n    });\r\n\r\n    await bot.sendMessage(chatId,\r\n      `‚úÖ *–¢–æ–≤–∞—Ä –Ω–∞–π–¥–µ–Ω:*\\n\\n` +\r\n      `üì¶ ${item.name}\\n` +\r\n      `üè∑Ô∏è –ê—Ä—Ç–∏–∫—É–ª: ${item.sku}\\n` +\r\n      `üìä –¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: ${item.quantity} ${item.unit}\\n\\n` +\r\n      `üìù –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –ø—Ä–∏—ë–º–∞:`,\r\n      { \r\n        parse_mode: 'Markdown',\r\n        reply_markup: {\r\n          inline_keyboard: [\r\n            [{ text: '‚ùå –û—Ç–º–µ–Ω–∞', callback_data: 'warehouse_cancel' }]\r\n          ]\r\n        }\r\n      }\r\n    );\r\n\r\n    return true;\r\n  } catch (error) {\r\n    global.logger.error('Handle item scan error:', error);\r\n    await bot.sendMessage(chatId,\r\n      `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ç–æ–≤–∞—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.`\r\n    );\r\n    return true;\r\n  }\r\n}\r\n\r\n/**\r\n * –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞\r\n */\r\nasync function handleQuantityInput(bot, msg) {\r\n  const chatId = msg.chat.id;\r\n  const userId = msg.from.id;\r\n\r\n  try {\r\n    const currentState = await fsmManager.getUserState(userId);\r\n    \r\n    if (currentState !== WAREHOUSE_STATES.WAITING_QUANTITY_INPUT) {\r\n      return false;\r\n    }\r\n\r\n    const quantityText = msg.text;\r\n    const quantity = parseFloat(quantityText);\r\n\r\n    if (isNaN(quantity) || quantity <= 0) {\r\n      await bot.sendMessage(chatId,\r\n        `‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ. –í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 10 –∏–ª–∏ 5.5):`\r\n      );\r\n      return true;\r\n    }\r\n\r\n    const userData = await fsmManager.getUserData(userId);\r\n    const item = userData.currentItem;\r\n\r\n    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ñ–æ—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—é\r\n    await fsmManager.setUserState(userId, WAREHOUSE_STATES.WAITING_BUNKER_PHOTO);\r\n    await fsmManager.updateUserData(userId, {\r\n      quantity: quantity\r\n    });\r\n\r\n    await bot.sendMessage(chatId,\r\n      `üìù *–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–∏—ë–º–∞:*\\n\\n` +\r\n      `üì¶ –¢–æ–≤–∞—Ä: ${item.name}\\n` +\r\n      `üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${quantity} ${item.unit}\\n\\n` +\r\n      `üì∏ –°–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:`,\r\n      { \r\n        parse_mode: 'Markdown',\r\n        reply_markup: {\r\n          inline_keyboard: [\r\n            [{ text: '‚úÖ –ü—Ä–∏–Ω—è—Ç—å –±–µ–∑ —Ñ–æ—Ç–æ', callback_data: 'warehouse_accept_no_photo' }],\r\n            [{ text: '‚ùå –û—Ç–º–µ–Ω–∞', callback_data: 'warehouse_cancel' }]\r\n          ]\r\n        }\r\n      }\r\n    );\r\n\r\n    return true;\r\n  } catch (error) {\r\n    global.logger.error('Handle quantity input error:', error);\r\n    await bot.sendMessage(chatId,\r\n      `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.`\r\n    );\r\n    return true;\r\n  }\r\n}\r\n\r\n/**\r\n * –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è\r\n */\r\nasync function handleConfirmationPhoto(bot, msg) {\r\n  const chatId = msg.chat.id;\r\n  const userId = msg.from.id;\r\n\r\n  try {\r\n    const currentState = await fsmManager.getUserState(userId);\r\n    \r\n    if (currentState !== WAREHOUSE_STATES.WAITING_BUNKER_PHOTO) {\r\n      return false;\r\n    }\r\n\r\n    if (!msg.photo || msg.photo.length === 0) {\r\n      await bot.sendMessage(chatId,\r\n        `‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.`\r\n      );\r\n      return true;\r\n    }\r\n\r\n    const userData = await fsmManager.getUserData(userId);\r\n    const item = userData.currentItem;\r\n    const quantity = userData.quantity;\r\n\r\n    // –ü–æ–ª—É—á–∞–µ–º URL —Ñ–æ—Ç–æ\r\n    const photo = msg.photo[msg.photo.length - 1];\r\n    const fileInfo = await bot.getFile(photo.file_id);\r\n    const photoUrl = `https://api.telegram.org/file/bot${bot.token}/${fileInfo.file_path}`;\r\n\r\n    // –°–æ–∑–¥–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞\r\n    const stockMovement = await global.apiClient.post('/stock-movements', {\r\n      itemId: item.id,\r\n      type: 'IN',\r\n      quantity: quantity,\r\n      reason: '–ü—Ä–∏—ë–º —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥',\r\n      reference: `Telegram-${Date.now()}`,\r\n      metadata: {\r\n        telegramUserId: userId,\r\n        photoUrl: photoUrl,\r\n        telegramFileId: photo.file_id\r\n      }\r\n    });\r\n\r\n    if (stockMovement.data.success) {\r\n      await bot.sendMessage(chatId,\r\n        `‚úÖ *–¢–æ–≤–∞—Ä –ø—Ä–∏–Ω—è—Ç –Ω–∞ —Å–∫–ª–∞–¥!*\\n\\n` +\r\n        `üì¶ ${item.name}\\n` +\r\n        `üìä –ü—Ä–∏–Ω—è—Ç–æ: ${quantity} ${item.unit}\\n` +\r\n        `üì∏ –§–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ\\n` +\r\n        `‚è∞ –í—Ä–µ–º—è: ${new Date().toLocaleTimeString('ru-RU')}\\n\\n` +\r\n        `üÜî –ù–æ–º–µ—Ä –æ–ø–µ—Ä–∞—Ü–∏–∏: ${stockMovement.data.data.id}`,\r\n        { parse_mode: 'Markdown' }\r\n      );\r\n    } else {\r\n      throw new Error('Failed to create stock movement');\r\n    }\r\n\r\n    await fsmManager.clearUserState(userId);\r\n    await showWarehouseMenu(bot, msg);\r\n\r\n    return true;\r\n  } catch (error) {\r\n    global.logger.error('Handle confirmation photo error:', error);\r\n    await bot.sendMessage(chatId,\r\n      `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.`\r\n    );\r\n    return true;\r\n  }\r\n}\r\n\r\n/**\r\n * –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –±—É–Ω–∫–µ—Ä–∞\r\n */\r\nasync function fillBunker(bot, callbackQuery) {\r\n  const chatId = callbackQuery.message.chat.id;\r\n  const userId = callbackQuery.from.id;\r\n\r\n  try {\r\n    // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±—É–Ω–∫–µ—Ä–æ–≤\r\n    const bunkers = await getAvailableBunkers();\r\n\r\n    if (bunkers.length === 0) {\r\n      await bot.answerCallbackQuery(callbackQuery.id, {\r\n        text: '‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±—É–Ω–∫–µ—Ä–æ–≤',\r\n        show_alert: true\r\n      });\r\n      return;\r\n    }\r\n\r\n    let message = `üóÉÔ∏è *–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –±—É–Ω–∫–µ—Ä–∞*\\n\\n`;\r\n    message += `–í—ã–±–µ—Ä–∏—Ç–µ –±—É–Ω–∫–µ—Ä –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è:\\n\\n`;\r\n\r\n    const keyboards = [];\r\n    bunkers.forEach((bunker, index) => {\r\n      keyboards.push([{\r\n        text: `üóÉÔ∏è ${bunker.machine.name} - ${bunker.item.name}`,\r\n        callback_data: `warehouse_select_bunker:${bunker.id}`\r\n      }]);\r\n    });\r\n\r\n    keyboards.push([{ text: '‚ùå –û—Ç–º–µ–Ω–∞', callback_data: 'warehouse_cancel' }]);\r\n\r\n    await bot.editMessageText(message, {\r\n      chat_id: chatId,\r\n      message_id: callbackQuery.message.message_id,\r\n      parse_mode: 'Markdown',\r\n      reply_markup: {\r\n        inline_keyboard: keyboards\r\n      }\r\n    });\r\n\r\n    await bot.answerCallbackQuery(callbackQuery.id);\r\n\r\n  } catch (error) {\r\n    global.logger.error('Fill bunker error:', error);\r\n    await bot.answerCallbackQuery(callbackQuery.id, {\r\n      text: '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –±—É–Ω–∫–µ—Ä–æ–≤',\r\n      show_alert: true\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * –í–∑–≤–µ—à–∏–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞\r\n */\r\nasync function weighItems(bot, callbackQuery) {\r\n  const chatId = callbackQuery.message.chat.id;\r\n  const userId = callbackQuery.from.id;\r\n\r\n  try {\r\n    await fsmManager.setUserState(userId, WAREHOUSE_STATES.WAITING_WEIGHT_INPUT);\r\n    await fsmManager.setUserData(userId, {\r\n      action: 'weigh_items'\r\n    });\r\n\r\n    await bot.editMessageText(\r\n      `‚öñÔ∏è *–í–∑–≤–µ—à–∏–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞*\\n\\n` +\r\n      `üìù –í–≤–µ–¥–∏—Ç–µ –≤–µ—Å —Ç–æ–≤–∞—Ä–∞ –≤ –∫–∏–ª–æ–≥—Ä–∞–º–º–∞—Ö:\\n\\n` +\r\n      `üí° –ü—Ä–∏–º–µ—Ä—ã: 5.2, 10, 0.5`,\r\n      {\r\n        chat_id: chatId,\r\n        message_id: callbackQuery.message.message_id,\r\n        parse_mode: 'Markdown',\r\n        reply_markup: {\r\n          inline_keyboard: [\r\n            [{ text: '‚ùå –û—Ç–º–µ–Ω–∞', callback_data: 'warehouse_cancel' }]\r\n          ]\r\n        }\r\n      }\r\n    );\r\n\r\n    await bot.answerCallbackQuery(callbackQuery.id);\r\n\r\n  } catch (error) {\r\n    global.logger.error('Weigh items error:', error);\r\n    await bot.answerCallbackQuery(callbackQuery.id, {\r\n      text: '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏—è',\r\n      show_alert: true\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –≤–µ—Å–∞\r\n */\r\nasync function handleWeightInput(bot, msg) {\r\n  const chatId = msg.chat.id;\r\n  const userId = msg.from.id;\r\n\r\n  try {\r\n    const currentState = await fsmManager.getUserState(userId);\r\n    \r\n    if (currentState !== WAREHOUSE_STATES.WAITING_WEIGHT_INPUT) {\r\n      return false;\r\n    }\r\n\r\n    const weightText = msg.text;\r\n    const weight = parseFloat(weightText);\r\n\r\n    if (isNaN(weight) || weight <= 0) {\r\n      await bot.sendMessage(chatId,\r\n        `‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–µ—Å. –í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –≤ –∫–∏–ª–æ–≥—Ä–∞–º–º–∞—Ö:`\r\n      );\r\n      return true;\r\n    }\r\n\r\n    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏—è\r\n    const weighingResult = await global.apiClient.post('/warehouse-logs', {\r\n      type: 'WEIGHING',\r\n      description: `–í–∑–≤–µ—à–∏–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞: ${weight} –∫–≥`,\r\n      weight: weight,\r\n      metadata: {\r\n        telegramUserId: userId,\r\n        timestamp: new Date().toISOString()\r\n      }\r\n    });\r\n\r\n    await bot.sendMessage(chatId,\r\n      `‚úÖ *–í–∑–≤–µ—à–∏–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!*\\n\\n` +\r\n      `‚öñÔ∏è –í–µ—Å: ${weight} –∫–≥\\n` +\r\n      `‚è∞ –í—Ä–µ–º—è: ${new Date().toLocaleTimeString('ru-RU')}\\n\\n` +\r\n      `üÜî –ù–æ–º–µ—Ä –∑–∞–ø–∏—Å–∏: ${weighingResult.data.data?.id || 'N/A'}`,\r\n      { parse_mode: 'Markdown' }\r\n    );\r\n\r\n    await fsmManager.clearUserState(userId);\r\n    await showWarehouseMenu(bot, msg);\r\n\r\n    return true;\r\n  } catch (error) {\r\n    global.logger.error('Handle weight input error:', error);\r\n    await bot.sendMessage(chatId,\r\n      `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤–µ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.`\r\n    );\r\n    return true;\r\n  }\r\n}\r\n\r\n/**\r\n * –û—Ç–º–µ–Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è\r\n */\r\nasync function cancelAction(bot, callbackQuery) {\r\n  const userId = callbackQuery.from.id;\r\n  \r\n  try {\r\n    await fsmManager.clearUserState(userId);\r\n    \r\n    await bot.answerCallbackQuery(callbackQuery.id, {\r\n      text: '‚ùå –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ'\r\n    });\r\n\r\n    await showWarehouseMenu(bot, {\r\n      chat: { id: callbackQuery.message.chat.id },\r\n      from: { id: userId }\r\n    });\r\n  } catch (error) {\r\n    global.logger.error('Cancel action error:', error);\r\n  }\r\n}\r\n\r\n// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏\r\n\r\nasync function getUserInfo(userId) {\r\n  try {\r\n    const response = await global.apiClient.get('/auth/me');\r\n    return response.data.data;\r\n  } catch (error) {\r\n    return null;\r\n  }\r\n}\r\n\r\nasync function getWarehouseStats() {\r\n  try {\r\n    const response = await global.apiClient.get('/warehouse/stats');\r\n    return response.data.data || {};\r\n  } catch (error) {\r\n    return {};\r\n  }\r\n}\r\n\r\nasync function findItemByCode(code) {\r\n  try {\r\n    const response = await global.apiClient.get(`/inventory/items?sku=${code}`);\r\n    return response.data.data[0] || null;\r\n  } catch (error) {\r\n    return null;\r\n  }\r\n}\r\n\r\nasync function findItemById(id) {\r\n  try {\r\n    const response = await global.apiClient.get(`/inventory/items/${id}`);\r\n    return response.data.data || null;\r\n  } catch (error) {\r\n    return null;\r\n  }\r\n}\r\n\r\nasync function getAvailableBunkers() {\r\n  try {\r\n    const response = await global.apiClient.get('/machine-inventory?needsRefill=true');\r\n    return response.data.data || [];\r\n  } catch (error) {\r\n    return [];\r\n  }\r\n}\r\n\r\nmodule.exports = {\r\n  showWarehouseMenu,\r\n  receiveItems,\r\n  handleItemScan,\r\n  handleQuantityInput,\r\n  handleConfirmationPhoto,\r\n  fillBunker,\r\n  weighItems,\r\n  handleWeightInput,\r\n  cancelAction,\r\n  WAREHOUSE_STATES\r\n};\r\n",
  "services/telegram-bot/src/utils/s3Storage.js": "const AWS = require('aws-sdk');\r\nconst { v4: uuidv4 } = require('uuid');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\n/**\r\n * DigitalOcean Spaces Storage Module\r\n * –ú–æ–¥—É–ª—å –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –≤ DigitalOcean Spaces\r\n */\r\n\r\nclass S3Storage {\r\n  constructor() {\r\n    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è DigitalOcean Spaces\r\n    this.spacesEndpoint = new AWS.Endpoint(process.env.S3_ENDPOINT || 'https://fra1.digitaloceanspaces.com');\r\n    this.s3 = new AWS.S3({\r\n      endpoint: this.spacesEndpoint,\r\n      accessKeyId: process.env.S3_ACCESS_KEY || 'DO00XEB6BC6XZ8Q2M4KQ',\r\n      secretAccessKey: process.env.S3_SECRET_KEY || 'SeYpfXGQ4eKR8WEDdGKjtLo0c6BK82r2hfnrzB63swk',\r\n      region: process.env.S3_REGION || 'fra1'\r\n    });\r\n    \r\n    this.bucketName = process.env.S3_BUCKET || 'vhm24-uploads';\r\n    this.cdnUrl = `https://${this.bucketName}.fra1.cdn.digitaloceanspaces.com`;\r\n  }\r\n\r\n  /**\r\n   * –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤ DigitalOcean Spaces\r\n   * @param {string} filePath - –ü—É—Ç—å –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É —Ñ–∞–π–ª—É\r\n   * @param {string} fileName - –ò–º—è —Ñ–∞–π–ª–∞\r\n   * @param {string} folder - –ü–∞–ø–∫–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'uploads')\r\n   * @returns {Promise<string>} - URL –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞\r\n   */\r\n  async uploadFile(filePath, fileName, folder = 'uploads') {\r\n    try {\r\n      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞\r\n      const fileExtension = path.extname(fileName);\r\n      const uniqueFileName = `${uuidv4()}${fileExtension}`;\r\n      const key = `${folder}/${uniqueFileName}`;\r\n\r\n      // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª\r\n      const fileContent = fs.readFileSync(filePath);\r\n\r\n      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME —Ç–∏–ø\r\n      const mimeType = this.getMimeType(fileExtension);\r\n\r\n      // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏\r\n      const uploadParams = {\r\n        Bucket: this.bucketName,\r\n        Key: key,\r\n        Body: fileContent,\r\n        ACL: 'public-read',\r\n        ContentType: mimeType,\r\n        CacheControl: 'max-age=31536000' // –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≥–æ–¥\r\n      };\r\n\r\n      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª\r\n      const result = await this.s3.upload(uploadParams).promise();\r\n      \r\n      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º CDN URL\r\n      const cdnUrl = `${this.cdnUrl}/${key}`;\r\n      \r\n      console.log(`‚úÖ File uploaded successfully: ${cdnUrl}`);\r\n      return cdnUrl;\r\n\r\n    } catch (error) {\r\n      console.error('‚ùå Error uploading file to S3:', error);\r\n      throw new Error(`Failed to upload file: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –∏–∑ Telegram\r\n   * @param {string} filePath - –ü—É—Ç—å –∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–º—É —Ñ–æ—Ç–æ\r\n   * @param {string} originalFileName - –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞\r\n   * @returns {Promise<string>} - URL –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ\r\n   */\r\n  async uploadPhoto(filePath, originalFileName = 'photo.jpg') {\r\n    return this.uploadFile(filePath, originalFileName, 'photos');\r\n  }\r\n\r\n  /**\r\n   * –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏–∑ Telegram\r\n   * @param {string} filePath - –ü—É—Ç—å –∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–º—É –¥–æ–∫—É–º–µ–Ω—Ç—É\r\n   * @param {string} originalFileName - –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞\r\n   * @returns {Promise<string>} - URL –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞\r\n   */\r\n  async uploadDocument(filePath, originalFileName) {\r\n    return this.uploadFile(filePath, originalFileName, 'documents');\r\n  }\r\n\r\n  /**\r\n   * –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–∞\r\n   * @param {string} filePath - –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –æ—Ç—á–µ—Ç–∞\r\n   * @param {string} fileName - –ò–º—è —Ñ–∞–π–ª–∞ –æ—Ç—á–µ—Ç–∞\r\n   * @returns {Promise<string>} - URL –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞\r\n   */\r\n  async uploadReport(filePath, fileName) {\r\n    return this.uploadFile(filePath, fileName, 'reports');\r\n  }\r\n\r\n  /**\r\n   * –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ MIME —Ç–∏–ø–∞ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é —Ñ–∞–π–ª–∞\r\n   * @param {string} extension - –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞\r\n   * @returns {string} - MIME —Ç–∏–ø\r\n   */\r\n  getMimeType(extension) {\r\n    const mimeTypes = {\r\n      '.jpg': 'image/jpeg',\r\n      '.jpeg': 'image/jpeg',\r\n      '.png': 'image/png',\r\n      '.gif': 'image/gif',\r\n      '.webp': 'image/webp',\r\n      '.pdf': 'application/pdf',\r\n      '.doc': 'application/msword',\r\n      '.docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\r\n      '.xls': 'application/vnd.ms-excel',\r\n      '.xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\r\n      '.txt': 'text/plain',\r\n      '.csv': 'text/csv',\r\n      '.json': 'application/json'\r\n    };\r\n\r\n    return mimeTypes[extension.toLowerCase()] || 'application/octet-stream';\r\n  }\r\n\r\n  /**\r\n   * –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–∑ DigitalOcean Spaces\r\n   * @param {string} fileUrl - URL —Ñ–∞–π–ª–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è\r\n   * @returns {Promise<boolean>} - –†–µ–∑—É–ª—å—Ç–∞—Ç —É–¥–∞–ª–µ–Ω–∏—è\r\n   */\r\n  async deleteFile(fileUrl) {\r\n    try {\r\n      // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á –∏–∑ URL\r\n      const key = fileUrl.replace(`${this.cdnUrl}/`, '');\r\n\r\n      const deleteParams = {\r\n        Bucket: this.bucketName,\r\n        Key: key\r\n      };\r\n\r\n      await this.s3.deleteObject(deleteParams).promise();\r\n      console.log(`‚úÖ File deleted successfully: ${fileUrl}`);\r\n      return true;\r\n\r\n    } catch (error) {\r\n      console.error('‚ùå Error deleting file from S3:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ\r\n   * @param {string} fileUrl - URL —Ñ–∞–π–ª–∞\r\n   * @returns {Promise<Object>} - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ\r\n   */\r\n  async getFileInfo(fileUrl) {\r\n    try {\r\n      const key = fileUrl.replace(`${this.cdnUrl}/`, '');\r\n\r\n      const headParams = {\r\n        Bucket: this.bucketName,\r\n        Key: key\r\n      };\r\n\r\n      const result = await this.s3.headObject(headParams).promise();\r\n      \r\n      return {\r\n        size: result.ContentLength,\r\n        lastModified: result.LastModified,\r\n        contentType: result.ContentType,\r\n        etag: result.ETag\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('‚ùå Error getting file info:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω–æ–≥–æ URL –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞\r\n   * @param {string} key - –ö–ª—é—á —Ñ–∞–π–ª–∞ –≤ S3\r\n   * @param {number} expiresIn - –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ URL –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1 —á–∞—Å)\r\n   * @returns {string} - –ü–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π URL\r\n   */\r\n  getSignedUrl(key, expiresIn = 3600) {\r\n    const params = {\r\n      Bucket: this.bucketName,\r\n      Key: key,\r\n      Expires: expiresIn\r\n    };\r\n\r\n    return this.s3.getSignedUrl('getObject', params);\r\n  }\r\n}\r\n\r\n// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º singleton —ç–∫–∑–µ–º–ø–ª—è—Ä\r\nconst s3Storage = new S3Storage();\r\nmodule.exports = s3Storage;\r\n",
  "setup-error-fixing-system.js": "#!/usr/bin/env node\r\n\r\n/**\r\n * VHM24 - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫\r\n * \r\n * –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã\r\n * —Å–∏—Å—Ç–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫ VHM24.\r\n * \r\n * –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\r\n * node setup-error-fixing-system.js\r\n */\r\n\r\nconst { execSync } = require('child_process');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\nconst readline = require('readline');\r\n\r\nconst rl = readline.createInterface({\r\n  input: process.stdin,\r\n  output: process.stdout\r\n});\r\n\r\n// –¶–≤–µ—Ç–∞ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏\r\nconst colors = {\r\n  reset: '\\x1b[0m',\r\n  bright: '\\x1b[1m',\r\n  red: '\\x1b[31m',\r\n  green: '\\x1b[32m',\r\n  yellow: '\\x1b[33m',\r\n  blue: '\\x1b[34m',\r\n  magenta: '\\x1b[35m',\r\n  cyan: '\\x1b[36m'\r\n};\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞\r\nfunction log(message, color = 'reset') {\r\n  console.log(`${colors[color]}${message}${colors.reset}`);\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è\r\nfunction confirm(message) {\r\n  return new Promise((resolve) => {\r\n    rl.question(`${colors.yellow}${message} (y/n): ${colors.reset}`, (answer) => {\r\n      resolve(answer.toLowerCase() === 'y');\r\n    });\r\n  });\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è –ø–∞–∫–µ—Ç–∞\r\nfunction isPackageInstalled(packageName, global = false) {\r\n  try {\r\n    if (global) {\r\n      execSync(`npm list -g ${packageName}`, { stdio: 'pipe' });\r\n    } else {\r\n      execSync(`npm list ${packageName}`, { stdio: 'pipe' });\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    return false;\r\n  }\r\n}\r\n\r\n// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è\r\nasync function main() {\r\n  log('\\nüîß VHM24 - –£–°–¢–ê–ù–û–í–ö–ê –°–ò–°–¢–ï–ú–´ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –û–®–ò–ë–û–ö üîß\\n', 'bright');\r\n  \r\n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ package.json\r\n  if (!fs.existsSync('package.json')) {\r\n    log('‚ùå –§–∞–π–ª package.json –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞.', 'red');\r\n    rl.close();\r\n    return;\r\n  }\r\n  \r\n  // –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π\r\n  log('\\nüì¶ –®–ê–ì 1: –£–°–¢–ê–ù–û–í–ö–ê –õ–û–ö–ê–õ–¨–ù–´–• –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô', 'magenta');\r\n  \r\n  const localDependencies = [\r\n    'glob',\r\n    'node-fetch',\r\n    'tap'\r\n  ];\r\n  \r\n  const missingLocalDeps = localDependencies.filter(dep => !isPackageInstalled(dep));\r\n  \r\n  if (missingLocalDeps.length > 0) {\r\n    log(`–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: ${missingLocalDeps.join(', ')}`, 'cyan');\r\n    const installLocalConfirm = await confirm('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏?');\r\n    \r\n    if (installLocalConfirm) {\r\n      try {\r\n        log('\\n–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...', 'cyan');\r\n        execSync(`npm install --save-dev ${missingLocalDeps.join(' ')}`, { stdio: 'inherit' });\r\n        log('\\n‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!', 'green');\r\n      } catch (error) {\r\n        log(`\\n‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π: ${error.message}`, 'red');\r\n      }\r\n    }\r\n  } else {\r\n    log('‚úÖ –í—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!', 'green');\r\n  }\r\n  \r\n  // –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π\r\n  log('\\nüåê –®–ê–ì 2: –£–°–¢–ê–ù–û–í–ö–ê –ì–õ–û–ë–ê–õ–¨–ù–´–• –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô', 'magenta');\r\n  \r\n  const globalDependencies = [\r\n    'autocannon'\r\n  ];\r\n  \r\n  const missingGlobalDeps = globalDependencies.filter(dep => !isPackageInstalled(dep, true));\r\n  \r\n  if (missingGlobalDeps.length > 0) {\r\n    log(`–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: ${missingGlobalDeps.join(', ')}`, 'cyan');\r\n    const installGlobalConfirm = await confirm('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏?');\r\n    \r\n    if (installGlobalConfirm) {\r\n      try {\r\n        log('\\n–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...', 'cyan');\r\n        execSync(`npm install -g ${missingGlobalDeps.join(' ')}`, { stdio: 'inherit' });\r\n        log('\\n‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!', 'green');\r\n      } catch (error) {\r\n        log(`\\n‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π: ${error.message}`, 'red');\r\n      }\r\n    }\r\n  } else {\r\n    log('‚úÖ –í—Å–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!', 'green');\r\n  }\r\n  \r\n  // –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π\r\n  log('\\nüìÅ –®–ê–ì 3: –°–û–ó–î–ê–ù–ò–ï –ù–ï–û–ë–•–û–î–ò–ú–´–• –î–ò–†–ï–ö–¢–û–†–ò–ô', 'magenta');\r\n  \r\n  const directories = [\r\n    'backups',\r\n    'scripts'\r\n  ];\r\n  \r\n  directories.forEach(dir => {\r\n    if (!fs.existsSync(dir)) {\r\n      fs.mkdirSync(dir, { recursive: true });\r\n      log(`‚úÖ –°–æ–∑–¥–∞–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: ${dir}`, 'green');\r\n    } else {\r\n      log(`‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è ${dir} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`, 'green');\r\n    }\r\n  });\r\n  \r\n  // –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å–∫—Ä–∏–ø—Ç–æ–≤\r\n  log('\\nüìú –®–ê–ì 4: –ü–†–û–í–ï–†–ö–ê –ù–ê–õ–ò–ß–ò–Ø –°–ö–†–ò–ü–¢–û–í', 'magenta');\r\n  \r\n  const scripts = [\r\n    'scripts/project-analyzer.js',\r\n    'scripts/auto-fixer.js',\r\n    'scripts/test-after-fixes.js',\r\n    'fix-all-errors.js',\r\n    'VHM24_FIX_CHECKLIST.md',\r\n    'VHM24_ERROR_FIXING_SYSTEM.md'\r\n  ];\r\n  \r\n  const missingScripts = scripts.filter(script => !fs.existsSync(script));\r\n  \r\n  if (missingScripts.length > 0) {\r\n    log(`‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Å–ª–µ–¥—É—é—â–∏–µ —Å–∫—Ä–∏–ø—Ç—ã: ${missingScripts.join(', ')}`, 'red');\r\n    log('–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–∏ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã –≤ –ø—Ä–æ–µ–∫—Ç.', 'yellow');\r\n  } else {\r\n    log('‚úÖ –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –Ω–∞–π–¥–µ–Ω—ã!', 'green');\r\n  }\r\n  \r\n  // –®–∞–≥ 5: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ –≤ package.json\r\n  log('\\nüîß –®–ê–ì 5: –î–û–ë–ê–í–õ–ï–ù–ò–ï –°–ö–†–ò–ü–¢–û–í –í PACKAGE.JSON', 'magenta');\r\n  \r\n  const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));\r\n  \r\n  if (!packageJson.scripts) {\r\n    packageJson.scripts = {};\r\n  }\r\n  \r\n  const scriptsToAdd = {\r\n    'analyze': 'node scripts/project-analyzer.js',\r\n    'fix': 'node scripts/auto-fixer.js',\r\n    'test-fixes': 'node scripts/test-after-fixes.js',\r\n    'fix-all': 'node fix-all-errors.js'\r\n  };\r\n  \r\n  let scriptsAdded = false;\r\n  \r\n  Object.entries(scriptsToAdd).forEach(([name, command]) => {\r\n    if (!packageJson.scripts[name]) {\r\n      packageJson.scripts[name] = command;\r\n      scriptsAdded = true;\r\n      log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Å–∫—Ä–∏–ø—Ç: ${name}`, 'green');\r\n    } else {\r\n      log(`‚úÖ –°–∫—Ä–∏–ø—Ç ${name} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`, 'green');\r\n    }\r\n  });\r\n  \r\n  if (scriptsAdded) {\r\n    fs.writeFileSync('package.json', JSON.stringify(packageJson, null, 2));\r\n    log('‚úÖ –§–∞–π–ª package.json –æ–±–Ω–æ–≤–ª–µ–Ω!', 'green');\r\n  }\r\n  \r\n  // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ\r\n  log('\\nüéâ –£–°–¢–ê–ù–û–í–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!', 'bright');\r\n  log('–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã:', 'cyan');\r\n  log('  npm run analyze - –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–µ–∫—Ç–∞', 'cyan');\r\n  log('  npm run fix - –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º', 'cyan');\r\n  log('  npm run test-fixes - –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π', 'cyan');\r\n  log('  npm run fix-all - –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞', 'cyan');\r\n  log('\\n–ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞–ø—Ä—è–º—É—é:', 'cyan');\r\n  log('  node fix-all-errors.js', 'cyan');\r\n  log('\\nüìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ VHM24_ERROR_FIXING_SYSTEM.md', 'cyan');\r\n  \r\n  rl.close();\r\n}\r\n\r\n// –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏\r\nmain().catch(error => {\r\n  log(`\\n‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`, 'red');\r\n  rl.close();\r\n});\r\n",
  "start-pm2.js": "/**\r\n * VHM24 - PM2 Startup Script\r\n * \r\n * –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º PM2 –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏\r\n * PM2 –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ\r\n */\r\n\r\nconst { execSync } = require('child_process');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\nconsole.log('üöÄ –ó–∞–ø—É—Å–∫ VHM24 —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º PM2...\\n');\r\n\r\ntry {\r\n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ PM2\r\n  try {\r\n    execSync('pm2 --version', { stdio: 'ignore' });\r\n    console.log('‚úÖ PM2 —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');\r\n  } catch (error) {\r\n    console.log('‚ö†Ô∏è PM2 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º...');\r\n    execSync('npm install -g pm2', { stdio: 'inherit' });\r\n    console.log('‚úÖ PM2 —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');\r\n  }\r\n\r\n  // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è PM2\r\n  const pm2Config = {\r\n    apps: [\r\n      {\r\n        name: 'vhm24-auth',\r\n        script: 'services/auth/src/index.js',\r\n        watch: false,\r\n        instances: 1,\r\n        autorestart: true,\r\n        max_memory_restart: '200M',\r\n        env: {\r\n          NODE_ENV: 'production'\r\n        }\r\n      },\r\n      {\r\n        name: 'vhm24-machines',\r\n        script: 'services/machines/src/index.js',\r\n        watch: false,\r\n        instances: 1,\r\n        autorestart: true,\r\n        max_memory_restart: '200M',\r\n        env: {\r\n          NODE_ENV: 'production'\r\n        }\r\n      },\r\n      {\r\n        name: 'vhm24-inventory',\r\n        script: 'services/inventory/src/index.js',\r\n        watch: false,\r\n        instances: 1,\r\n        autorestart: true,\r\n        max_memory_restart: '200M',\r\n        env: {\r\n          NODE_ENV: 'production'\r\n        }\r\n      },\r\n      {\r\n        name: 'vhm24-tasks',\r\n        script: 'services/tasks/src/index.js',\r\n        watch: false,\r\n        instances: 1,\r\n        autorestart: true,\r\n        max_memory_restart: '200M',\r\n        env: {\r\n          NODE_ENV: 'production'\r\n        }\r\n      },\r\n      {\r\n        name: 'vhm24-bunkers',\r\n        script: 'services/bunkers/src/index.js',\r\n        watch: false,\r\n        instances: 1,\r\n        autorestart: true,\r\n        max_memory_restart: '200M',\r\n        env: {\r\n          NODE_ENV: 'production'\r\n        }\r\n      },\r\n      {\r\n        name: 'vhm24-telegram-bot',\r\n        script: 'services/telegram-bot/src/index.js',\r\n        watch: false,\r\n        instances: 1,\r\n        autorestart: true,\r\n        max_memory_restart: '200M',\r\n        env: {\r\n          NODE_ENV: 'production'\r\n        }\r\n      },\r\n      {\r\n        name: 'vhm24-notifications',\r\n        script: 'services/notifications/src/index.js',\r\n        watch: false,\r\n        instances: 1,\r\n        autorestart: true,\r\n        max_memory_restart: '200M',\r\n        env: {\r\n          NODE_ENV: 'production'\r\n        }\r\n      },\r\n      {\r\n        name: 'vhm24-gateway',\r\n        script: 'services/gateway/src/index.js',\r\n        watch: false,\r\n        instances: 1,\r\n        autorestart: true,\r\n        max_memory_restart: '200M',\r\n        env: {\r\n          NODE_ENV: 'production'\r\n        }\r\n      }\r\n    ]\r\n  };\r\n\r\n  // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ —Ñ–∞–π–ª\r\n  fs.writeFileSync('ecosystem.config.js', `module.exports = ${JSON.stringify(pm2Config, null, 2)}`);\r\n  console.log('‚úÖ –°–æ–∑–¥–∞–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª PM2: ecosystem.config.js');\r\n\r\n  // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏—Å—Ç–µ–º—É —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º PM2\r\n  console.log('\\nüöÄ –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º PM2...');\r\n  execSync('pm2 start ecosystem.config.js', { stdio: 'inherit' });\r\n\r\n  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é PM2 –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ\r\n  console.log('\\nüíæ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å–∏—Å—Ç–µ–º—ã...');\r\n  execSync('pm2 save', { stdio: 'inherit' });\r\n  \r\n  // –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö\r\n  console.log('\\nüìä –°—Ç–∞—Ç—É—Å –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:');\r\n  execSync('pm2 list', { stdio: 'inherit' });\r\n  \r\n  console.log('\\n‚úÖ –°–∏—Å—Ç–µ–º–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º PM2!');\r\n  console.log('üìù –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: pm2 logs');\r\n  console.log('üîÑ –î–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤: pm2 restart all');\r\n  console.log('‚èπÔ∏è –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤: pm2 stop all');\r\n  console.log('üîç –î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: pm2 monit');\r\n} catch (error) {\r\n  console.error('\\n‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–∏—Å—Ç–µ–º—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º PM2:', error.message);\r\n  process.exit(1);\r\n}\r\n",
  "cleanup-project.js": "/**\r\n * VHM24 Project Cleanup Script\r\n * Removes redundant files and organizes the project structure\r\n */\r\n\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\n// Files to delete\r\nconst filesToDelete = [\r\n  // Redundant documentation\r\n  'RAILWAY_API_STATUS.md',\r\n  'RAILWAY_BOT_FIX.md',\r\n  'RAILWAY_BUILD_FIX.md',\r\n  'RAILWAY_CORRECT_VARIABLES.md',\r\n  'RAILWAY_DATABASE_FIX.md',\r\n  'RAILWAY_DEPLOY_NOW.md',\r\n  'RAILWAY_ENV_REQUIRED.md',\r\n  'RAILWAY_ENV_SETUP.md',\r\n  'RAILWAY_FINAL_CONFIG.md',\r\n  'RAILWAY_FINAL_DEPLOY.md',\r\n  'RAILWAY_FINAL_SETUP.md',\r\n  'RAILWAY_FINAL_STATUS.md',\r\n  'RAILWAY_FINAL_STEPS.md',\r\n  'RAILWAY_FINAL_VARIABLES.md',\r\n  'RAILWAY_FIX_CHECKLIST.md',\r\n  'RAILWAY_GATEWAY_FIX.md',\r\n  'RAILWAY_PORT_FIX.md',\r\n  'RAILWAY_QUICK_DEPLOY.md',\r\n  'RAILWAY_VARIABLES_FINAL.md',\r\n  'RAILWAY_VARIABLES_READY.env',\r\n  'RAILWAY_WITH_SUPABASE.md',\r\n  'RAILWAY_ADMIN_SETUP.md',\r\n  \r\n  // Redundant start scripts\r\n  'start-all-services-fixed.bat',\r\n  'start-all-services.bat',\r\n  'start-all.bat',\r\n  'start-development.bat',\r\n  'start-gateway-simple.bat',\r\n  'start-services.bat',\r\n  'start-with-supabase.bat',\r\n  'deploy-railway-fixed.bat',\r\n  'deploy-to-railway.bat',\r\n  'deploy-to-railway.sh',\r\n  \r\n  // Old entry points (replaced by start.js)\r\n  'index.js',\r\n  'railway-start.js',\r\n  \r\n  // Other redundant files\r\n  'index-gateway-only.js',\r\n  'prepare-for-railway.js',\r\n  'setup-railway-env.js',\r\n  'format-json.js',\r\n  'vendhub-api-example.js',\r\n  'vendhub-bot-example.js',\r\n  'vendbot-compatibility-report.json',\r\n  '.env.railway',\r\n  'railway.json',\r\n  \r\n  // Old analysis files\r\n  'VENDBOT_MIGRATION_ANALYSIS.md',\r\n  'VENDHUB_API_SPEC.md',\r\n  'VENDHUB_ARCHITECTURE_DIAGRAM.md',\r\n  'VENDHUB_ARCHITECTURE.md',\r\n  'VENDHUB_MIGRATION_PLAN.md',\r\n  'VENDHUB_PROJECT_SUMMARY.md',\r\n  'VENDHUB_TELEGRAM_BOT_SPEC.md',\r\n  'VENDHUB_TEST_REPORT.md',\r\n  'VENDHUB_VS_VHM24_COMPARISON.md',\r\n  'VHM24_FIXES_REPORT_2025.md',\r\n  'VHM24_FIXES_REPORT.md',\r\n  'VHM24_GAP_ANALYSIS.md',\r\n  'VHM24_IMPLEMENTATION_REPORT.md',\r\n  'FINAL_COMPATIBILITY_REPORT.md',\r\n  'FULL_ANALYSIS_AND_FIXES.md',\r\n  'ARCHITECTURE_REVIEW.md',\r\n  'README_IMPROVEMENTS.md',\r\n  'TEST_RESULTS.md'\r\n];\r\n\r\n// Files to keep and potentially merge\r\nconst filesToKeep = [\r\n  'RAILWAY_DEPLOYMENT_GUIDE.md',\r\n  'RAILWAY_DATABASE_SETUP.md',\r\n  'DATABASE_MIGRATION_PLAN.md',\r\n  'DATABASE_MIGRATION_SUMMARY.md',\r\n  'SUPABASE_MIGRATION_GUIDE.md',\r\n  'QUICK_START.md',\r\n  'NEXT_STEPS.md',\r\n  'README.md',\r\n  'VHM24_ANALYSIS_AND_OPTIMIZATION.md'\r\n];\r\n\r\nconsole.log('üßπ VHM24 Project Cleanup\\n');\r\n\r\n// Count files before cleanup\r\nconst totalFilesBefore = fs.readdirSync('.').length;\r\nconsole.log(`Total files before cleanup: ${totalFilesBefore}`);\r\n\r\n// Delete files\r\nlet deletedCount = 0;\r\nlet errors = [];\r\n\r\nconsole.log('\\nüìÅ Deleting redundant files...\\n');\r\n\r\nfilesToDelete.forEach(file => {\r\n  const filePath = path.join('.', file);\r\n  if (fs.existsSync(filePath)) {\r\n    try {\r\n      fs.unlinkSync(filePath);\r\n      console.log(`‚úÖ Deleted: ${file}`);\r\n      deletedCount++;\r\n    } catch (error) {\r\n      console.error(`‚ùå Error deleting ${file}: ${error.message}`);\r\n      errors.push({ file, error: error.message });\r\n    }\r\n  } else {\r\n    console.log(`‚è≠Ô∏è  Skipped (not found): ${file}`);\r\n  }\r\n});\r\n\r\n// Summary\r\nconsole.log('\\nüìä Cleanup Summary:');\r\nconsole.log(`- Files deleted: ${deletedCount}`);\r\nconsole.log(`- Files kept: ${filesToKeep.length}`);\r\nconsole.log(`- Errors: ${errors.length}`);\r\n\r\nif (errors.length > 0) {\r\n  console.log('\\n‚ùå Errors encountered:');\r\n  errors.forEach(({ file, error }) => {\r\n    console.log(`  - ${file}: ${error}`);\r\n  });\r\n}\r\n\r\n// Count files after cleanup\r\nconst totalFilesAfter = fs.readdirSync('.').length;\r\nconsole.log(`\\nTotal files after cleanup: ${totalFilesAfter}`);\r\nconsole.log(`Files removed: ${totalFilesBefore - totalFilesAfter}`);\r\n\r\nconsole.log('\\n‚ú® Cleanup complete!');\r\nconsole.log('\\nüìù Next steps:');\r\nconsole.log('1. Review the remaining documentation files');\r\nconsole.log('2. Merge related documentation into single files');\r\nconsole.log('3. Update README.md with current project structure');\r\nconsole.log('4. Run \"npm run clean && npm install\" to refresh dependencies');\r\n",
  "fix-all-errors-and-start.js": "#!/usr/bin/env node\r\n\r\n/**\r\n * VHM24 Complete Error Fix and Start\r\n * –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫ –∏ –∑–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã\r\n */\r\n\r\nconst { spawn, execSync } = require('child_process');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\nconsole.log('üîß –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ VHM24...\\n');\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã —Å –≤—ã–≤–æ–¥–æ–º\r\nfunction runCommand(command, cwd = process.cwd()) {\r\n  try {\r\n    console.log(`üì¶ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è: ${command}`);\r\n    execSync(command, { \r\n      cwd, \r\n      stdio: 'inherit',\r\n      encoding: 'utf8'\r\n    });\r\n    console.log(`‚úÖ –ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ\\n`);\r\n    return true;\r\n  } catch (error) {\r\n    console.log(`‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã: ${error.message}\\n`);\r\n    return false;\r\n  }\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π\r\nfunction createMissingDirectories() {\r\n  console.log('üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π...');\r\n  \r\n  const directories = [\r\n    'services/data-import/templates',\r\n    'services/notifications/logs',\r\n    'services/audit/logs',\r\n    'services/gateway/uploads',\r\n    'services/backup/backups'\r\n  ];\r\n\r\n  directories.forEach(dir => {\r\n    const fullPath = path.join(__dirname, dir);\r\n    if (!fs.existsSync(fullPath)) {\r\n      fs.mkdirSync(fullPath, { recursive: true });\r\n      console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: ${dir}`);\r\n    }\r\n  });\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Node.js\r\nfunction killAllNodeProcesses() {\r\n  console.log('üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Node.js...');\r\n  try {\r\n    if (process.platform === 'win32') {\r\n      execSync('taskkill /f /im node.exe', { stdio: 'ignore' });\r\n    } else {\r\n      execSync('pkill -f node', { stdio: 'ignore' });\r\n    }\r\n    console.log('‚úÖ –í—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');\r\n  } catch (error) {\r\n    console.log('‚ö†Ô∏è  –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)');\r\n  }\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π\r\nfunction installDependencies() {\r\n  console.log('üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...');\r\n  \r\n  const packages = [\r\n    '.',\r\n    'packages/database',\r\n    'packages/shared',\r\n    'packages/shared-types',\r\n    'services/gateway',\r\n    'services/auth',\r\n    'services/machines',\r\n    'services/notifications',\r\n    'services/audit',\r\n    'services/routes',\r\n    'services/warehouse',\r\n    'services/recipes'\r\n  ];\r\n\r\n  for (const pkg of packages) {\r\n    const pkgPath = path.join(__dirname, pkg);\r\n    const packageJsonPath = path.join(pkgPath, 'package.json');\r\n    \r\n    if (fs.existsSync(packageJsonPath)) {\r\n      console.log(`üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è ${pkg}...`);\r\n      if (!runCommand('npm install --no-audit --no-fund', pkgPath)) {\r\n        console.log(`‚ö†Ô∏è  –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è ${pkg}, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º...\\n`);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞\r\nfunction startService(service) {\r\n  return new Promise((resolve) => {\r\n    console.log(`üîß –ó–∞–ø—É—Å–∫ ${service.name}...`);\r\n    \r\n    const childProcess = spawn('npm', ['start'], {\r\n      cwd: path.join(__dirname, service.path),\r\n      stdio: 'pipe',\r\n      env: {\r\n        ...process.env,\r\n        PORT: service.port\r\n      }\r\n    });\r\n\r\n    let started = false;\r\n    let output = '';\r\n\r\n    childProcess.stdout.on('data', (data) => {\r\n      const text = data.toString();\r\n      output += text;\r\n      console.log(`[${service.name}] ${text.trim()}`);\r\n      \r\n      if (!started && (text.includes('listening') || text.includes('running') || text.includes('Server listening'))) {\r\n        started = true;\r\n        console.log(`‚úÖ ${service.name} –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${service.port}`);\r\n        resolve({ process: childProcess, success: true });\r\n      }\r\n    });\r\n\r\n    childProcess.stderr.on('data', (data) => {\r\n      const text = data.toString();\r\n      if (!text.includes('ExperimentalWarning') && !text.includes('DeprecationWarning')) {\r\n        console.log(`[${service.name} ERROR] ${text.trim()}`);\r\n      }\r\n    });\r\n\r\n    childProcess.on('close', (code) => {\r\n      if (!started) {\r\n        console.log(`‚ùå ${service.name} –∑–∞–≤–µ—Ä—à–µ–Ω —Å –∫–æ–¥–æ–º ${code}`);\r\n        resolve({ process: null, success: false });\r\n      }\r\n    });\r\n\r\n    childProcess.on('error', (error) => {\r\n      console.log(`üí• –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ ${service.name}: ${error.message}`);\r\n      if (!started) {\r\n        resolve({ process: null, success: false });\r\n      }\r\n    });\r\n\r\n    // –¢–∞–π–º–∞—É—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞\r\n    setTimeout(() => {\r\n      if (!started) {\r\n        console.log(`‚ö†Ô∏è  ${service.name} –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –º–µ–¥–ª–µ–Ω–Ω–æ...`);\r\n        resolve({ process: childProcess, success: true });\r\n      }\r\n    }, 10000);\r\n  });\r\n}\r\n\r\n// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è\r\nasync function main() {\r\n  try {\r\n    // 1. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤\r\n    killAllNodeProcesses();\r\n    await new Promise(resolve => setTimeout(resolve, 2000));\r\n\r\n    // 2. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π\r\n    createMissingDirectories();\r\n\r\n    // 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π\r\n    installDependencies();\r\n\r\n    // 4. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤\r\n    console.log('\\nüöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤...\\n');\r\n    \r\n    const services = [\r\n      { name: 'Auth', path: 'services/auth', port: 3001 },\r\n      { name: 'Gateway', path: 'services/gateway', port: 8000 },\r\n      { name: 'Machines', path: 'services/machines', port: 3002 },\r\n      { name: 'Notifications', path: 'services/notifications', port: 3006 },\r\n      { name: 'Audit', path: 'services/audit', port: 3007 }\r\n    ];\r\n\r\n    const runningProcesses = [];\r\n    let successCount = 0;\r\n\r\n    for (const service of services) {\r\n      const result = await startService(service);\r\n      if (result.success) {\r\n        successCount++;\r\n        if (result.process) {\r\n          runningProcesses.push(result.process);\r\n        }\r\n      }\r\n      // –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏\r\n      await new Promise(resolve => setTimeout(resolve, 2000));\r\n    }\r\n\r\n    console.log('\\nüéâ –ó–∞–ø—É—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω!');\r\n    console.log(`üìä –ó–∞–ø—É—â–µ–Ω–æ —Å–µ—Ä–≤–∏—Å–æ–≤: ${successCount}/${services.length}`);\r\n    \r\n    if (successCount > 0) {\r\n      console.log('\\nüìã –î–æ—Å—Ç—É–ø–Ω—ã–µ endpoints:');\r\n      console.log('   üåê API Gateway: http://localhost:8000');\r\n      console.log('   üîê Auth Service: http://localhost:3001');\r\n      console.log('   ü§ñ Machines Service: http://localhost:3002');\r\n      console.log('   üîî Notifications Service: http://localhost:3006');\r\n      console.log('   üîç Audit Service: http://localhost:3007');\r\n      \r\n      console.log('\\nüß™ –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—É—Å—Ç–∏—Ç–µ:');\r\n      console.log('   node test-complete-system-with-notifications.js');\r\n      \r\n      console.log('\\n‚ö†Ô∏è  –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C');\r\n\r\n      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è\r\n      process.on('SIGINT', () => {\r\n        console.log('\\nüõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤...');\r\n        runningProcesses.forEach(proc => {\r\n          if (proc && !proc.killed) {\r\n            proc.kill('SIGTERM');\r\n          }\r\n        });\r\n        setTimeout(() => {\r\n          console.log('üëã –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');\r\n          process.exit(0);\r\n        }, 2000);\r\n      });\r\n\r\n      // –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è\r\n      await new Promise(() => {});\r\n    } else {\r\n      console.log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∏ –æ–¥–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞');\r\n      process.exit(1);\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// –ó–∞–ø—É—Å–∫\r\nmain();\r\n",
  "install-dependencies.js": "#!/usr/bin/env node\r\n\r\n/**\r\n * VHM24 Simple Dependencies Installation\r\n * –ü—Ä–æ—Å—Ç–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è VHM24\r\n */\r\n\r\nconst { execSync } = require('child_process');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\nconsole.log('üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π VHM24...\\n');\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã —Å –≤—ã–≤–æ–¥–æ–º\r\nfunction runCommand(command, cwd = process.cwd()) {\r\n  try {\r\n    console.log(`üì¶ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è: ${command} –≤ ${cwd}`);\r\n    const result = execSync(command, { \r\n      cwd, \r\n      stdio: 'inherit',\r\n      encoding: 'utf8'\r\n    });\r\n    console.log(`‚úÖ –ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ\\n`);\r\n    return true;\r\n  } catch (error) {\r\n    console.log(`‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã: ${error.message}\\n`);\r\n    return false;\r\n  }\r\n}\r\n\r\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Node.js –∏ npm\r\nfunction checkPrerequisites() {\r\n  console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π...');\r\n  \r\n  try {\r\n    const nodeVersion = execSync('node --version', { encoding: 'utf8' }).trim();\r\n    const npmVersion = execSync('npm --version', { encoding: 'utf8' }).trim();\r\n    \r\n    console.log(`‚úÖ Node.js: ${nodeVersion}`);\r\n    console.log(`‚úÖ npm: ${npmVersion}\\n`);\r\n    return true;\r\n  } catch (error) {\r\n    console.log('‚ùå Node.js –∏–ª–∏ npm –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');\r\n    return false;\r\n  }\r\n}\r\n\r\n// –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞–∫–µ—Ç—ã –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏\r\nconst packages = [\r\n  'packages/database',\r\n  'packages/shared',\r\n  'packages/shared-types',\r\n  'services/notifications',\r\n  'services/audit',\r\n  'services/gateway'\r\n];\r\n\r\nasync function main() {\r\n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è\r\n  if (!checkPrerequisites()) {\r\n    process.exit(1);\r\n  }\r\n\r\n  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ –∫–æ—Ä–Ω–µ\r\n  console.log('üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ—Ä–Ω–µ–≤—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...');\r\n  if (!runCommand('npm install')) {\r\n    console.log('‚ö†Ô∏è  –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ—Ä–Ω–µ–≤—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º...\\n');\r\n  }\r\n\r\n  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞–∫–µ—Ç–∞\r\n  for (const pkg of packages) {\r\n    const pkgPath = path.join(__dirname, pkg);\r\n    const packageJsonPath = path.join(pkgPath, 'package.json');\r\n    \r\n    if (fs.existsSync(packageJsonPath)) {\r\n      console.log(`üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è ${pkg}...`);\r\n      if (!runCommand('npm install', pkgPath)) {\r\n        console.log(`‚ö†Ô∏è  –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è ${pkg}, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º...\\n`);\r\n      }\r\n    } else {\r\n      console.log(`‚ö†Ô∏è  package.json –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è ${pkg}\\n`);\r\n    }\r\n  }\r\n\r\n  console.log('üéâ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');\r\n  console.log('\\nüöÄ –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å:');\r\n  console.log('   node start-all-services-with-audit.js');\r\n  console.log('   node test-complete-system-with-notifications.js');\r\n}\r\n\r\nmain().catch(error => {\r\n  console.error('üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error);\r\n  process.exit(1);\r\n});\r\n",
  "monitor-24-7.js": "/**\r\n * VHM24 - VendHub Manager 24/7\r\n * System Monitor\r\n * Checks all services are running 24/7\r\n */\r\n\r\nconst axios = require('axios');\r\n\r\nconst services = [\r\n  { name: 'Gateway', url: 'http://localhost:8000/health' },\r\n  { name: 'Auth', url: 'http://localhost:3001/health' },\r\n  { name: 'Machines', url: 'http://localhost:3002/health' },\r\n  { name: 'Inventory', url: 'http://localhost:3003/health' },\r\n  { name: 'Tasks', url: 'http://localhost:3004/health' },\r\n  { name: 'Bunkers', url: 'http://localhost:3005/health' }\r\n];\r\n\r\nasync function checkServices() {\r\n  console.log('üîç VHM24 - Checking 24/7 service status...\\n');\r\n  \r\n  let allHealthy = true;\r\n  \r\n  for (const service of services) {\r\n    try {\r\n      const response = await axios.get(service.url, { timeout: 5000 });\r\n      if (response.data.status === 'ok') {\r\n        console.log(`‚úÖ ${service.name} - ONLINE 24/7`);\r\n      } else {\r\n        console.log(`‚ö†Ô∏è  ${service.name} - ISSUE DETECTED`);\r\n        allHealthy = false;\r\n      }\r\n    } catch (error) {\r\n      console.log(`‚ùå ${service.name} - OFFLINE`);\r\n      allHealthy = false;\r\n    }\r\n  }\r\n  \r\n  console.log('\\n' + '='.repeat(40));\r\n  if (allHealthy) {\r\n    console.log('‚úÖ VHM24 System Status: FULLY OPERATIONAL 24/7');\r\n  } else {\r\n    console.log('‚ö†Ô∏è  VHM24 System Status: ISSUES DETECTED');\r\n    console.log('Some services need attention for 24/7 operation');\r\n  }\r\n}\r\n\r\n// Run check immediately\r\ncheckServices();\r\n\r\n// Check every 5 minutes for 24/7 monitoring\r\nsetInterval(checkServices, 5 * 60 * 1000);\r\n\r\nconsole.log('\\n‚è∞ VHM24 Monitor running - checking every 5 minutes');\r\nconsole.log('Press Ctrl+C to stop monitoring\\n');\r\n",
  "packages/database/src/seed.js": "const { PrismaClient } = require('@prisma/client');\r\nconst bcrypt = require('bcrypt');\r\nconst path = require('path');\r\n\r\n// Load environment variables\r\nrequire('dotenv').config({ path: path.join(__dirname, '../../../.env') });\r\n\r\nconst prisma = new PrismaClient();\r\n\r\nasync function main() {\r\n  console.log('üå± Seeding database...');\r\n  console.log('Database URL:', process.env.DATABASE_URL ? 'Connected' : 'Not found');\r\n  \r\n  try {\r\n    // Check if admin already exists\r\n    const existingAdmin = await prisma.user.findFirst({\r\n      where: {\r\n        OR: [\r\n          { email: 'admin@vhm24.ru' },\r\n          { telegramId: '42283329' }\r\n        ]\r\n      }\r\n    });\r\n\r\n    if (existingAdmin) {\r\n      console.log('‚úÖ Admin already exists:', existingAdmin.email);\r\n      return;\r\n    }\r\n\r\n    // Create admin user\r\n    const passwordHash = await bcrypt.hash('admin123', 10);\r\n    \r\n    const admin = await prisma.user.create({\r\n      data: {\r\n        email: 'admin@vhm24.ru',\r\n        name: 'System Administrator',\r\n        passwordHash,\r\n        roles: ['ADMIN'],\r\n        telegramId: '42283329', // Your Telegram ID\r\n        phoneNumber: '+998901234567', // Optional\r\n        isActive: true\r\n      }\r\n    });\r\n    \r\n    console.log('‚úÖ Admin created successfully!');\r\n    console.log('Email:', admin.email);\r\n    console.log('Password: admin123');\r\n    console.log('Telegram ID:', admin.telegramId);\r\n    console.log('Roles:', admin.roles);\r\n\r\n    // Create some test data\r\n    console.log('\\nüì¶ Creating test data...');\r\n\r\n    // Create a location\r\n    const location = await prisma.location.create({\r\n      data: {\r\n        name: 'Main Office',\r\n        address: 'Tashkent, Uzbekistan',\r\n        latitude: 41.2995,\r\n        longitude: 69.2401\r\n      }\r\n    });\r\n\r\n    // Create a machine\r\n    const machine = await prisma.machine.create({\r\n      data: {\r\n        code: 'VM-001',\r\n        serialNumber: 'SN-2024-001',\r\n        type: 'Coffee Vending Machine',\r\n        name: 'Coffee Machine #1',\r\n        status: 'ONLINE',\r\n        locationId: location.id\r\n      }\r\n    });\r\n\r\n    console.log('‚úÖ Test machine created:', machine.name);\r\n\r\n    // Create inventory items\r\n    const items = await Promise.all([\r\n      prisma.inventoryItem.create({\r\n        data: {\r\n          name: 'Coffee Beans',\r\n          sku: 'COFFEE-001',\r\n          unit: 'KG',\r\n          category: 'Ingredients',\r\n          quantity: 50,\r\n          minQuantity: 10,\r\n          price: 25000\r\n        }\r\n      }),\r\n      prisma.inventoryItem.create({\r\n        data: {\r\n          name: 'Sugar',\r\n          sku: 'SUGAR-001',\r\n          unit: 'KG',\r\n          category: 'Ingredients',\r\n          quantity: 30,\r\n          minQuantity: 5,\r\n          price: 5000\r\n        }\r\n      }),\r\n      prisma.inventoryItem.create({\r\n        data: {\r\n          name: 'Milk Powder',\r\n          sku: 'MILK-001',\r\n          unit: 'KG',\r\n          category: 'Ingredients',\r\n          quantity: 20,\r\n          minQuantity: 5,\r\n          price: 15000\r\n        }\r\n      })\r\n    ]);\r\n\r\n    console.log('‚úÖ Inventory items created:', items.length);\r\n\r\n    // Create machine inventory (bunkers)\r\n    for (const item of items) {\r\n      await prisma.machineInventory.create({\r\n        data: {\r\n          machineId: machine.id,\r\n          itemId: item.id,\r\n          quantity: 5,\r\n          minQuantity: 1,\r\n          maxQuantity: 10\r\n        }\r\n      });\r\n    }\r\n\r\n    console.log('‚úÖ Machine bunkers configured');\r\n\r\n    // Create a sample task\r\n    const task = await prisma.task.create({\r\n      data: {\r\n        title: 'Refill Coffee Machine',\r\n        description: 'Regular maintenance and refill',\r\n        status: 'CREATED',\r\n        priority: 'MEDIUM',\r\n        machineId: machine.id,\r\n        createdById: admin.id\r\n      }\r\n    });\r\n\r\n    console.log('‚úÖ Sample task created:', task.title);\r\n\r\n    console.log('\\nüéâ Database seeded successfully!');\r\n    console.log('\\nüì± Telegram Bot Usage:');\r\n    console.log('1. Send /start to your bot');\r\n    console.log('2. Login with Telegram ID: 42283329');\r\n    console.log('\\nüåê Web Login:');\r\n    console.log('Email: admin@vhm24.ru');\r\n    console.log('Password: admin123');\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Error seeding database:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\nmain()\r\n  .catch((e) => {\r\n    console.error(e);\r\n    process.exit(1);\r\n  })\r\n  .finally(async () => {\r\n    await prisma.$disconnect();\r\n  });\r\n",
  "packages/shared-types/src/redis-fallback.js": "// Fallback Redis implementation –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –±–µ–∑ Redis —Å–µ—Ä–≤–µ—Ä–∞\r\nconst EventEmitter = require('events');\r\n\r\n// Mock Redis client\r\nclass MockRedis extends EventEmitter {\r\n  constructor() {\r\n    super();\r\n    this.data = new Map();\r\n    this.ttls = new Map();\r\n    \r\n    // –≠–º—É–ª–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ\r\n    setTimeout(() => {\r\n      console.log('Connected to Redis (Mock)');\r\n      this.emit('connect');\r\n    }, 100);\r\n  }\r\n\r\n  async get(key) {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º TTL\r\n    if (this.ttls.has(key)) {\r\n      const expiry = this.ttls.get(key);\r\n      if (Date.now() > expiry) {\r\n        this.data.delete(key);\r\n        this.ttls.delete(key);\r\n        return null;\r\n      }\r\n    }\r\n    return this.data.get(key) || null;\r\n  }\r\n\r\n  async set(key, value) {\r\n    this.data.set(key, value);\r\n    return 'OK';\r\n  }\r\n\r\n  async setex(key, seconds, value) {\r\n    this.data.set(key, value);\r\n    this.ttls.set(key, Date.now() + (seconds * 1000));\r\n    return 'OK';\r\n  }\r\n\r\n  async del(...keys) {\r\n    let deleted = 0;\r\n    keys.forEach(key => {\r\n      if (this.data.has(key)) {\r\n        this.data.delete(key);\r\n        this.ttls.delete(key);\r\n        deleted++;\r\n      }\r\n    });\r\n    return deleted;\r\n  }\r\n\r\n  async exists(key) {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º TTL\r\n    if (this.ttls.has(key)) {\r\n      const expiry = this.ttls.get(key);\r\n      if (Date.now() > expiry) {\r\n        this.data.delete(key);\r\n        this.ttls.delete(key);\r\n        return 0;\r\n      }\r\n    }\r\n    return this.data.has(key) ? 1 : 0;\r\n  }\r\n\r\n  async expire(key, seconds) {\r\n    if (this.data.has(key)) {\r\n      this.ttls.set(key, Date.now() + (seconds * 1000));\r\n      return 1;\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  async ttl(key) {\r\n    if (!this.data.has(key)) return -2;\r\n    if (!this.ttls.has(key)) return -1;\r\n    \r\n    const expiry = this.ttls.get(key);\r\n    const remaining = Math.ceil((expiry - Date.now()) / 1000);\r\n    return remaining > 0 ? remaining : -2;\r\n  }\r\n\r\n  async keys(pattern) {\r\n    const regex = new RegExp(pattern.replace(/\\*/g, '.*'));\r\n    return Array.from(this.data.keys()).filter(key => regex.test(key));\r\n  }\r\n\r\n  async flushall() {\r\n    this.data.clear();\r\n    this.ttls.clear();\r\n    return 'OK';\r\n  }\r\n}\r\n\r\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ —Ä–µ–∞–ª—å–Ω—ã–π Redis –∏–ª–∏ mock\r\nlet redis;\r\nconst useRealRedis = process.env.REDIS_URL && process.env.NODE_ENV === 'production';\r\n\r\nif (useRealRedis) {\r\n  try {\r\n    const Redis = require('ioredis');\r\n    redis = new Redis(process.env.REDIS_URL, {\r\n      maxRetriesPerRequest: 3,\r\n      retryStrategy: (times) => {\r\n        const delay = Math.min(times * 50, 2000);\r\n        return delay;\r\n      },\r\n      reconnectOnError: (err) => {\r\n        const targetError = 'READONLY';\r\n        if (err.message.includes(targetError)) {\r\n          return true;\r\n        }\r\n        return false;\r\n      }\r\n    });\r\n\r\n    redis.on('error', (err) => {\r\n      console.error('Redis connection error:', err);\r\n    });\r\n\r\n    redis.on('connect', () => {\r\n      console.log('Connected to Redis');\r\n    });\r\n  } catch (error) {\r\n    console.warn('Failed to connect to Redis, using fallback:', error.message);\r\n    redis = new MockRedis();\r\n  }\r\n} else {\r\n  console.log('Using Redis fallback for local development');\r\n  redis = new MockRedis();\r\n}\r\n\r\n// –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–µ—à–µ–º\r\nclass CacheManager {\r\n  constructor(prefix = 'vhm24:') {\r\n    this.prefix = prefix;\r\n    this.defaultTTL = parseInt(process.env.REDIS_TTL) || 3600; // 1 —á–∞—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\r\n  }\r\n\r\n  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º\r\n  getKey(key) {\r\n    return `${this.prefix}${key}`;\r\n  }\r\n\r\n  // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–µ—à–∞\r\n  async get(key) {\r\n    try {\r\n      const data = await redis.get(this.getKey(key));\r\n      return data ? JSON.parse(data) : null;\r\n    } catch (error) {\r\n      console.error('Redis get error:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –∫–µ—à\r\n  async set(key, value, ttl = this.defaultTTL) {\r\n    try {\r\n      const data = JSON.stringify(value);\r\n      if (ttl) {\r\n        await redis.setex(this.getKey(key), ttl, data);\r\n      } else {\r\n        await redis.set(this.getKey(key), data);\r\n      }\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Redis set error:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // –£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–µ—à–∞\r\n  async delete(key) {\r\n    try {\r\n      await redis.del(this.getKey(key));\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Redis delete error:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // –£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É\r\n  async deletePattern(pattern) {\r\n    try {\r\n      const keys = await redis.keys(this.getKey(pattern));\r\n      if (keys.length > 0) {\r\n        await redis.del(...keys);\r\n      }\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Redis delete pattern error:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–ª—é—á–∞\r\n  async exists(key) {\r\n    try {\r\n      const exists = await redis.exists(this.getKey(key));\r\n      return exists === 1;\r\n    } catch (error) {\r\n      console.error('Redis exists error:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª—é—á–∞\r\n  async expire(key, ttl) {\r\n    try {\r\n      await redis.expire(this.getKey(key), ttl);\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Redis expire error:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏ –∫–ª—é—á–∞\r\n  async ttl(key) {\r\n    try {\r\n      const ttl = await redis.ttl(this.getKey(key));\r\n      return ttl;\r\n    } catch (error) {\r\n      console.error('Redis ttl error:', error);\r\n      return -1;\r\n    }\r\n  }\r\n\r\n  // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ–≥–æ –∫–µ—à–∞ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º\r\n  async flush() {\r\n    try {\r\n      const keys = await redis.keys(this.getKey('*'));\r\n      if (keys.length > 0) {\r\n        await redis.del(...keys);\r\n      }\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Redis flush error:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ñ—É–Ω–∫—Ü–∏–∏\r\n  async cache(key, fn, ttl = this.defaultTTL) {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à\r\n    const cached = await this.get(key);\r\n    if (cached !== null) {\r\n      return cached;\r\n    }\r\n\r\n    // –í—ã–ø–æ–ª–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é\r\n    const result = await fn();\r\n\r\n    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∫–µ—à\r\n    await this.set(key, result, ttl);\r\n\r\n    return result;\r\n  }\r\n\r\n  // –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–µ—à–∞ –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π\r\n  async invalidate(patterns) {\r\n    try {\r\n      const promises = patterns.map(pattern => this.deletePattern(pattern));\r\n      await Promise.all(promises);\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Redis invalidate error:', error);\r\n      return false;\r\n    }\r\n  }\r\n}\r\n\r\n// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤\r\nconst cacheManagers = {\r\n  auth: new CacheManager('vhm24:auth:'),\r\n  machines: new CacheManager('vhm24:machines:'),\r\n  inventory: new CacheManager('vhm24:inventory:'),\r\n  tasks: new CacheManager('vhm24:tasks:'),\r\n  reports: new CacheManager('vhm24:reports:'),\r\n  telegram: new CacheManager('vhm24:telegram:')\r\n};\r\n\r\n// –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ç–æ–¥–æ–≤\r\nfunction cacheable(keyGenerator, ttl) {\r\n  return function(target, propertyKey, descriptor) {\r\n    const originalMethod = descriptor.value;\r\n\r\n    descriptor.value = async function(...args) {\r\n      const cache = cacheManagers[this.serviceName] || new CacheManager();\r\n      const key = typeof keyGenerator === 'function' \r\n        ? keyGenerator.apply(this, args) \r\n        : keyGenerator;\r\n\r\n      return cache.cache(key, async () => {\r\n        return originalMethod.apply(this, args);\r\n      }, ttl);\r\n    };\r\n\r\n    return descriptor;\r\n  };\r\n}\r\n\r\n// Middleware –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤\r\nfunction cacheMiddleware(options = {}) {\r\n  const {\r\n    keyGenerator = (req) => `${req.method}:${req.url}`,\r\n    ttl = 300, // 5 –º–∏–Ω—É—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\r\n    serviceName = 'http',\r\n    condition = () => true\r\n  } = options;\r\n\r\n  const cache = cacheManagers[serviceName] || new CacheManager(`vhm24:${serviceName}:`);\r\n\r\n  return async (req, reply) => {\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è\r\n    if (!condition(req)) {\r\n      return;\r\n    }\r\n\r\n    const key = keyGenerator(req);\r\n\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à –¥–ª—è GET –∑–∞–ø—Ä–æ—Å–æ–≤\r\n    if (req.method === 'GET') {\r\n      const cached = await cache.get(key);\r\n      if (cached) {\r\n        reply.header('X-Cache', 'HIT');\r\n        return reply.send(cached);\r\n      }\r\n    }\r\n\r\n    // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è\r\n    const originalSend = reply.send.bind(reply);\r\n    reply.send = function(payload) {\r\n      // –ö–µ—à–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã\r\n      if (reply.statusCode >= 200 && reply.statusCode < 300) {\r\n        cache.set(key, payload, ttl).catch(err => {\r\n          console.error('Cache set error:', err);\r\n        });\r\n      }\r\n      reply.header('X-Cache', 'MISS');\r\n      return originalSend(payload);\r\n    };\r\n  };\r\n}\r\n\r\nmodule.exports = {\r\n  redis,\r\n  CacheManager,\r\n  cacheManagers,\r\n  cacheable,\r\n  cacheMiddleware\r\n};\r\n",
  "packages/shared/middleware/errorHandler.js": "/**\r\n * VHM24 Error Handler Middleware\r\n * –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤\r\n */\r\n\r\nconst { securityErrorHandler } = require('./security');\r\n\r\n/**\r\n * –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∫–ª–∞—Å—Å—ã –æ—à–∏–±–æ–∫\r\n */\r\nclass AppError extends Error {\r\n  constructor(message, statusCode = 500, name = 'AppError') {\r\n    super(message);\r\n    this.name = name;\r\n    this.statusCode = statusCode;\r\n    this.isOperational = true;\r\n    \r\n    Error.captureStackTrace(this, this.constructor);\r\n  }\r\n}\r\n\r\nclass ValidationError extends AppError {\r\n  constructor(message, details = []) {\r\n    super(message, 400, 'ValidationError');\r\n    this.details = details;\r\n  }\r\n}\r\n\r\nclass AuthenticationError extends AppError {\r\n  constructor(message = 'Authentication required') {\r\n    super(message, 401, 'UnauthorizedError');\r\n  }\r\n}\r\n\r\nclass AuthorizationError extends AppError {\r\n  constructor(message = 'Access denied') {\r\n    super(message, 403, 'ForbiddenError');\r\n  }\r\n}\r\n\r\nclass NotFoundError extends AppError {\r\n  constructor(message = 'Resource not found') {\r\n    super(message, 404, 'NotFoundError');\r\n  }\r\n}\r\n\r\nclass ConflictError extends AppError {\r\n  constructor(message = 'Resource conflict') {\r\n    super(message, 409, 'ConflictError');\r\n  }\r\n}\r\n\r\nclass RateLimitError extends AppError {\r\n  constructor(message = 'Rate limit exceeded') {\r\n    super(message, 429, 'TooManyRequestsError');\r\n  }\r\n}\r\n\r\nclass DatabaseError extends AppError {\r\n  constructor(message = 'Database operation failed') {\r\n    super(message, 500, 'DatabaseError');\r\n  }\r\n}\r\n\r\nclass ExternalServiceError extends AppError {\r\n  constructor(message = 'External service unavailable') {\r\n    super(message, 503, 'ExternalServiceError');\r\n  }\r\n}\r\n\r\n/**\r\n * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Prisma –æ—à–∏–±–æ–∫\r\n */\r\nconst handlePrismaError = (error) => {\r\n  const isDev = process.env.NODE_ENV === 'development';\r\n  \r\n  switch (error.code) {\r\n    case 'P2002':\r\n      // Unique constraint violation\r\n      const field = error.meta?.target?.[0] || 'field';\r\n      return new ConflictError(`${field} already exists`);\r\n      \r\n    case 'P2025':\r\n      // Record not found\r\n      return new NotFoundError('Record not found');\r\n      \r\n    case 'P2003':\r\n      // Foreign key constraint violation\r\n      return new ValidationError('Invalid reference to related record');\r\n      \r\n    case 'P2014':\r\n      // Required relation violation\r\n      return new ValidationError('Required relation is missing');\r\n      \r\n    case 'P2021':\r\n      // Table does not exist\r\n      return new DatabaseError(isDev ? error.message : 'Database schema error');\r\n      \r\n    case 'P2022':\r\n      // Column does not exist\r\n      return new DatabaseError(isDev ? error.message : 'Database schema error');\r\n      \r\n    default:\r\n      return new DatabaseError(isDev ? error.message : 'Database operation failed');\r\n  }\r\n};\r\n\r\n/**\r\n * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ JWT –æ—à–∏–±–æ–∫\r\n */\r\nconst handleJWTError = (error) => {\r\n  switch (error.name) {\r\n    case 'JsonWebTokenError':\r\n      return new AuthenticationError('Invalid token');\r\n      \r\n    case 'TokenExpiredError':\r\n      return new AuthenticationError('Token expired');\r\n      \r\n    case 'NotBeforeError':\r\n      return new AuthenticationError('Token not active');\r\n      \r\n    default:\r\n      return new AuthenticationError('Authentication failed');\r\n  }\r\n};\r\n\r\n/**\r\n * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Fastify –æ—à–∏–±–æ–∫\r\n */\r\nconst handleFastifyError = (error) => {\r\n  const isDev = process.env.NODE_ENV === 'development';\r\n  \r\n  switch (error.code) {\r\n    case 'FST_ERR_VALIDATION':\r\n      return new ValidationError('Request validation failed', error.validation);\r\n      \r\n    case 'FST_ERR_NOT_FOUND':\r\n      return new NotFoundError('Route not found');\r\n      \r\n    case 'FST_ERR_BAD_STATUS_CODE':\r\n      return new AppError(isDev ? error.message : 'Invalid response', 500);\r\n      \r\n    case 'FST_ERR_ASYNC_CONSTRAINT':\r\n      return new AppError(isDev ? error.message : 'Server constraint violation', 500);\r\n      \r\n    default:\r\n      return new AppError(isDev ? error.message : 'Server error', error.statusCode || 500);\r\n  }\r\n};\r\n\r\n/**\r\n * –ì–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫\r\n */\r\nconst errorHandler = (error, request, reply) => {\r\n  let processedError = error;\r\n\r\n  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫\r\n  if (error.name === 'PrismaClientKnownRequestError') {\r\n    processedError = handlePrismaError(error);\r\n  } else if (error.name?.includes('JsonWebToken') || error.name?.includes('Token')) {\r\n    processedError = handleJWTError(error);\r\n  } else if (error.code?.startsWith('FST_')) {\r\n    processedError = handleFastifyError(error);\r\n  } else if (!error.isOperational) {\r\n    // –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ - –ª–æ–≥–∏—Ä—É–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—â—É—é –æ—à–∏–±–∫—É\r\n    console.error('Unexpected Error:', {\r\n      error: error.message,\r\n      stack: error.stack,\r\n      url: request.url,\r\n      method: request.method,\r\n      timestamp: new Date().toISOString()\r\n    });\r\n    \r\n    processedError = new AppError(\r\n      process.env.NODE_ENV === 'development' ? error.message : 'Internal server error',\r\n      500\r\n    );\r\n  }\r\n\r\n  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫\r\n  securityErrorHandler(processedError, request, reply);\r\n};\r\n\r\n/**\r\n * Async wrapper –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –≤ async —Ñ—É–Ω–∫—Ü–∏—è—Ö\r\n */\r\nconst asyncHandler = (fn) => {\r\n  return (request, reply) => {\r\n    Promise.resolve(fn(request, reply)).catch((error) => {\r\n      errorHandler(error, request, reply);\r\n    });\r\n  };\r\n};\r\n\r\n/**\r\n * Middleware –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ 404 –æ—à–∏–±–æ–∫\r\n */\r\nconst notFoundHandler = (request, reply) => {\r\n  reply.code(404).send({\r\n    error: 'Not Found',\r\n    message: `Route ${request.method} ${request.url} not found`,\r\n    statusCode: 404,\r\n    timestamp: new Date().toISOString()\r\n  });\r\n};\r\n\r\n/**\r\n * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö Promise rejections\r\n */\r\nconst handleUnhandledRejection = (reason, promise) => {\r\n  console.error('Unhandled Promise Rejection:', {\r\n    reason: reason.message || reason,\r\n    stack: reason.stack,\r\n    promise: promise,\r\n    timestamp: new Date().toISOString()\r\n  });\r\n  \r\n  // –í production –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –≤ —Å–∏—Å—Ç–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞\r\n  if (process.env.NODE_ENV === 'production') {\r\n    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ —Å–∏—Å—Ç–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Sentry)\r\n    // sentry.captureException(reason);\r\n  }\r\n};\r\n\r\n/**\r\n * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π\r\n */\r\nconst handleUncaughtException = (error) => {\r\n  console.error('Uncaught Exception:', {\r\n    error: error.message,\r\n    stack: error.stack,\r\n    timestamp: new Date().toISOString()\r\n  });\r\n  \r\n  // –í production –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –≤ —Å–∏—Å—Ç–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞\r\n  if (process.env.NODE_ENV === 'production') {\r\n    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ —Å–∏—Å—Ç–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞\r\n    // sentry.captureException(error);\r\n    \r\n    // Graceful shutdown\r\n    process.exit(1);\r\n  }\r\n};\r\n\r\n/**\r\n * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ—à–∏–±–æ–∫\r\n */\r\nconst setupGlobalErrorHandlers = () => {\r\n  process.on('unhandledRejection', handleUnhandledRejection);\r\n  process.on('uncaughtException', handleUncaughtException);\r\n  \r\n  // Graceful shutdown\r\n  process.on('SIGTERM', () => {\r\n    console.log('SIGTERM received, shutting down gracefully');\r\n    process.exit(0);\r\n  });\r\n  \r\n  process.on('SIGINT', () => {\r\n    console.log('SIGINT received, shutting down gracefully');\r\n    process.exit(0);\r\n  });\r\n};\r\n\r\n/**\r\n * –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ—à–∏–±–æ–∫ –≤ Fastify\r\n */\r\nconst registerErrorHandlers = (fastify) => {\r\n  // –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫\r\n  fastify.setErrorHandler(errorHandler);\r\n  \r\n  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ 404\r\n  fastify.setNotFoundHandler(notFoundHandler);\r\n  \r\n  // –•—É–∫ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫\r\n  fastify.addHook('onError', async (request, reply, error) => {\r\n    const logLevel = error.statusCode >= 500 ? 'error' : 'warn';\r\n    \r\n    console[logLevel]('Request Error:', {\r\n      error: error.message,\r\n      statusCode: error.statusCode,\r\n      method: request.method,\r\n      url: request.url,\r\n      ip: request.ip,\r\n      userAgent: request.headers['user-agent'],\r\n      userId: request.user?.id,\r\n      timestamp: new Date().toISOString()\r\n    });\r\n  });\r\n};\r\n\r\n/**\r\n * –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—à–∏–±–æ–∫\r\n */\r\nconst createError = {\r\n  validation: (message, details) => new ValidationError(message, details),\r\n  authentication: (message) => new AuthenticationError(message),\r\n  authorization: (message) => new AuthorizationError(message),\r\n  notFound: (message) => new NotFoundError(message),\r\n  conflict: (message) => new ConflictError(message),\r\n  rateLimit: (message) => new RateLimitError(message),\r\n  database: (message) => new DatabaseError(message),\r\n  externalService: (message) => new ExternalServiceError(message),\r\n  app: (message, statusCode, name) => new AppError(message, statusCode, name)\r\n};\r\n\r\n/**\r\n * –ü—Ä–æ–≤–µ—Ä–∫–∞ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—à–∏–±–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π\r\n */\r\nconst isOperationalError = (error) => {\r\n  return error instanceof AppError && error.isOperational;\r\n};\r\n\r\nmodule.exports = {\r\n  // –ö–ª–∞—Å—Å—ã –æ—à–∏–±–æ–∫\r\n  AppError,\r\n  ValidationError,\r\n  AuthenticationError,\r\n  AuthorizationError,\r\n  NotFoundError,\r\n  ConflictError,\r\n  RateLimitError,\r\n  DatabaseError,\r\n  ExternalServiceError,\r\n  \r\n  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏\r\n  errorHandler,\r\n  asyncHandler,\r\n  notFoundHandler,\r\n  registerErrorHandlers,\r\n  setupGlobalErrorHandlers,\r\n  \r\n  // –£—Ç–∏–ª–∏—Ç—ã\r\n  createError,\r\n  isOperationalError,\r\n  handlePrismaError,\r\n  handleJWTError,\r\n  handleFastifyError\r\n};\r\n",
  "packages/shared/utils/cache.js": "/**\r\n * VHM24 Cache Utility\r\n * Redis –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π\r\n */\r\n\r\nconst Redis = require('ioredis');\r\nconst { logger, structuredLog } = require('./logger');\r\n\r\n/**\r\n * –°–æ–∑–¥–∞–Ω–∏–µ Redis –∫–ª–∏–µ–Ω—Ç–∞\r\n */\r\nconst createRedisClient = () => {\r\n  const redisUrl = process.env.REDIS_URL || 'redis://localhost:6379';\r\n  \r\n  const redis = new Redis(redisUrl, {\r\n    retryDelayOnFailover: 100,\r\n    enableReadyCheck: false,\r\n    maxRetriesPerRequest: 3,\r\n    lazyConnect: true,\r\n    \r\n    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è production\r\n    ...(process.env.NODE_ENV === 'production' && {\r\n      connectTimeout: 10000,\r\n      commandTimeout: 5000,\r\n      retryDelayOnFailover: 100,\r\n      enableOfflineQueue: false\r\n    })\r\n  });\r\n\r\n  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π Redis\r\n  redis.on('connect', () => {\r\n    logger.info('Redis connected');\r\n  });\r\n\r\n  redis.on('ready', () => {\r\n    logger.info('Redis ready');\r\n  });\r\n\r\n  redis.on('error', (error) => {\r\n    logger.error('Redis error:', error);\r\n  });\r\n\r\n  redis.on('close', () => {\r\n    logger.warn('Redis connection closed');\r\n  });\r\n\r\n  redis.on('reconnecting', () => {\r\n    logger.info('Redis reconnecting...');\r\n  });\r\n\r\n  return redis;\r\n};\r\n\r\n// –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π Redis –∫–ª–∏–µ–Ω—Ç\r\nconst redis = createRedisClient();\r\n\r\n/**\r\n * –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è\r\n */\r\nclass Cache {\r\n  constructor(prefix = 'vhm24', defaultTTL = 300) {\r\n    this.prefix = prefix;\r\n    this.defaultTTL = defaultTTL;\r\n    this.redis = redis;\r\n  }\r\n\r\n  /**\r\n   * –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–∞ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º\r\n   */\r\n  _createKey(key) {\r\n    return `${this.prefix}:${key}`;\r\n  }\r\n\r\n  /**\r\n   * –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–µ—à–∞\r\n   */\r\n  async get(key) {\r\n    try {\r\n      const cacheKey = this._createKey(key);\r\n      const data = await this.redis.get(cacheKey);\r\n      \r\n      if (data) {\r\n        structuredLog.cache.hit(key);\r\n        return JSON.parse(data);\r\n      } else {\r\n        structuredLog.cache.miss(key);\r\n        return null;\r\n      }\r\n    } catch (error) {\r\n      logger.error('Cache get error:', { key, error: error.message });\r\n      return null; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º null –ø—Ä–∏ –æ—à–∏–±–∫–µ, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –∫–µ—à\r\n   */\r\n  async set(key, value, ttl = this.defaultTTL) {\r\n    try {\r\n      const cacheKey = this._createKey(key);\r\n      const serializedValue = JSON.stringify(value);\r\n      \r\n      if (ttl > 0) {\r\n        await this.redis.setex(cacheKey, ttl, serializedValue);\r\n      } else {\r\n        await this.redis.set(cacheKey, serializedValue);\r\n      }\r\n      \r\n      structuredLog.cache.set(key, ttl);\r\n      return true;\r\n    } catch (error) {\r\n      logger.error('Cache set error:', { key, ttl, error: error.message });\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–µ—à–∞\r\n   */\r\n  async del(key) {\r\n    try {\r\n      const cacheKey = this._createKey(key);\r\n      const result = await this.redis.del(cacheKey);\r\n      logger.debug('Cache delete:', { key, deleted: result > 0 });\r\n      return result > 0;\r\n    } catch (error) {\r\n      logger.error('Cache delete error:', { key, error: error.message });\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É\r\n   */\r\n  async delPattern(pattern) {\r\n    try {\r\n      const cachePattern = this._createKey(pattern);\r\n      const keys = await this.redis.keys(cachePattern);\r\n      \r\n      if (keys.length > 0) {\r\n        const result = await this.redis.del(...keys);\r\n        logger.debug('Cache pattern delete:', { pattern, deletedCount: result });\r\n        return result;\r\n      }\r\n      \r\n      return 0;\r\n    } catch (error) {\r\n      logger.error('Cache pattern delete error:', { pattern, error: error.message });\r\n      return 0;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–ª—é—á–∞\r\n   */\r\n  async exists(key) {\r\n    try {\r\n      const cacheKey = this._createKey(key);\r\n      const result = await this.redis.exists(cacheKey);\r\n      return result === 1;\r\n    } catch (error) {\r\n      logger.error('Cache exists error:', { key, error: error.message });\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –£—Å—Ç–∞–Ω–æ–≤–∫–∞ TTL –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª—é—á–∞\r\n   */\r\n  async expire(key, ttl) {\r\n    try {\r\n      const cacheKey = this._createKey(key);\r\n      const result = await this.redis.expire(cacheKey, ttl);\r\n      return result === 1;\r\n    } catch (error) {\r\n      logger.error('Cache expire error:', { key, ttl, error: error.message });\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –ü–æ–ª—É—á–µ–Ω–∏–µ TTL –∫–ª—é—á–∞\r\n   */\r\n  async ttl(key) {\r\n    try {\r\n      const cacheKey = this._createKey(key);\r\n      return await this.redis.ttl(cacheKey);\r\n    } catch (error) {\r\n      logger.error('Cache TTL error:', { key, error: error.message });\r\n      return -1;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç –∑–Ω–∞—á–µ–Ω–∏—è\r\n   */\r\n  async incr(key, amount = 1) {\r\n    try {\r\n      const cacheKey = this._createKey(key);\r\n      return await this.redis.incrby(cacheKey, amount);\r\n    } catch (error) {\r\n      logger.error('Cache increment error:', { key, amount, error: error.message });\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –î–µ–∫—Ä–µ–º–µ–Ω—Ç –∑–Ω–∞—á–µ–Ω–∏—è\r\n   */\r\n  async decr(key, amount = 1) {\r\n    try {\r\n      const cacheKey = this._createKey(key);\r\n      return await this.redis.decrby(cacheKey, amount);\r\n    } catch (error) {\r\n      logger.error('Cache decrement error:', { key, amount, error: error.message });\r\n      return null;\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –∫–µ—à–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ü–µ–ª–µ–π\r\n */\r\nconst cache = new Cache('vhm24', 300); // –û—Å–Ω–æ–≤–Ω–æ–π –∫–µ—à, 5 –º–∏–Ω—É—Ç\r\nconst sessionCache = new Cache('session', 3600); // –°–µ—Å—Å–∏–∏, 1 —á–∞—Å\r\nconst rateLimit = new Cache('rate_limit', 60); // Rate limiting, 1 –º–∏–Ω—É—Ç–∞\r\nconst tempCache = new Cache('temp', 30); // –í—Ä–µ–º–µ–Ω–Ω—ã–π –∫–µ—à, 30 —Å–µ–∫—É–Ω–¥\r\n\r\n/**\r\n * –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π\r\n */\r\nconst cacheResult = (keyGenerator, ttl = 300, cacheInstance = cache) => {\r\n  return (target, propertyName, descriptor) => {\r\n    const method = descriptor.value;\r\n    \r\n    descriptor.value = async function (...args) {\r\n      const cacheKey = typeof keyGenerator === 'function' \r\n        ? keyGenerator(...args) \r\n        : `${propertyName}:${JSON.stringify(args)}`;\r\n      \r\n      // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –∫–µ—à–∞\r\n      const cached = await cacheInstance.get(cacheKey);\r\n      if (cached !== null) {\r\n        return cached;\r\n      }\r\n      \r\n      // –í—ã–ø–æ–ª–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏ –∫–µ—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç\r\n      const result = await method.apply(this, args);\r\n      await cacheInstance.set(cacheKey, result, ttl);\r\n      \r\n      return result;\r\n    };\r\n    \r\n    return descriptor;\r\n  };\r\n};\r\n\r\n/**\r\n * Middleware –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è HTTP –æ—Ç–≤–µ—Ç–æ–≤\r\n */\r\nconst cacheMiddleware = (keyGenerator, ttl = 300) => {\r\n  return async (request, reply) => {\r\n    const cacheKey = typeof keyGenerator === 'function'\r\n      ? keyGenerator(request)\r\n      : `http:${request.method}:${request.url}`;\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à —Ç–æ–ª—å–∫–æ –¥–ª—è GET –∑–∞–ø—Ä–æ—Å–æ–≤\r\n    if (request.method === 'GET') {\r\n      const cached = await cache.get(cacheKey);\r\n      if (cached) {\r\n        reply.header('X-Cache', 'HIT');\r\n        return reply.send(cached);\r\n      }\r\n    }\r\n    \r\n    // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è\r\n    const originalSend = reply.send;\r\n    reply.send = function (payload) {\r\n      if (request.method === 'GET' && reply.statusCode === 200) {\r\n        cache.set(cacheKey, payload, ttl);\r\n        reply.header('X-Cache', 'MISS');\r\n      }\r\n      return originalSend.call(this, payload);\r\n    };\r\n  };\r\n};\r\n\r\n/**\r\n * –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–µ—à–µ–º\r\n */\r\nconst cacheUtils = {\r\n  /**\r\n   * –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n   */\r\n  clearUserCache: async (userId) => {\r\n    await cache.delPattern(`user:${userId}:*`);\r\n    await sessionCache.delPattern(`user:${userId}:*`);\r\n  },\r\n\r\n  /**\r\n   * –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ –º–∞—à–∏–Ω—ã\r\n   */\r\n  clearMachineCache: async (machineId) => {\r\n    await cache.delPattern(`machine:${machineId}:*`);\r\n    await cache.delPattern(`inventory:machine:${machineId}:*`);\r\n  },\r\n\r\n  /**\r\n   * –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ–≥–æ –∫–µ—à–∞\r\n   */\r\n  clearAll: async () => {\r\n    await redis.flushdb();\r\n    logger.info('All cache cleared');\r\n  },\r\n\r\n  /**\r\n   * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–µ—à–∞\r\n   */\r\n  getStats: async () => {\r\n    try {\r\n      const info = await redis.info('memory');\r\n      const keyspace = await redis.info('keyspace');\r\n      \r\n      return {\r\n        memory: info,\r\n        keyspace: keyspace,\r\n        connected: redis.status === 'ready'\r\n      };\r\n    } catch (error) {\r\n      logger.error('Cache stats error:', error);\r\n      return null;\r\n    }\r\n  },\r\n\r\n  /**\r\n   * –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –∫–µ—à–∞\r\n   */\r\n  healthCheck: async () => {\r\n    try {\r\n      const testKey = 'health_check';\r\n      const testValue = Date.now();\r\n      \r\n      await cache.set(testKey, testValue, 10);\r\n      const retrieved = await cache.get(testKey);\r\n      await cache.del(testKey);\r\n      \r\n      return retrieved === testValue;\r\n    } catch (error) {\r\n      logger.error('Cache health check failed:', error);\r\n      return false;\r\n    }\r\n  }\r\n};\r\n\r\n/**\r\n * Graceful shutdown\r\n */\r\nconst shutdown = async () => {\r\n  try {\r\n    await redis.quit();\r\n    logger.info('Redis connection closed gracefully');\r\n  } catch (error) {\r\n    logger.error('Error closing Redis connection:', error);\r\n  }\r\n};\r\n\r\n// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞\r\nprocess.on('SIGTERM', shutdown);\r\nprocess.on('SIGINT', shutdown);\r\n\r\nmodule.exports = {\r\n  // –û—Å–Ω–æ–≤–Ω—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –∫–µ—à–∞\r\n  cache,\r\n  sessionCache,\r\n  rateLimit,\r\n  tempCache,\r\n  \r\n  // –ö–ª–∞—Å—Å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤\r\n  Cache,\r\n  \r\n  // Redis –∫–ª–∏–µ–Ω—Ç\r\n  redis,\r\n  \r\n  // –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –∏ middleware\r\n  cacheResult,\r\n  cacheMiddleware,\r\n  \r\n  // –£—Ç–∏–ª–∏—Ç—ã\r\n  cacheUtils,\r\n  \r\n  // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è\r\n  createRedisClient,\r\n  shutdown\r\n};\r\n",
  "packages/shared/utils/config.js": "/**\r\n * VHM24 Configuration Utility\r\n * –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π\r\n */\r\n\r\nconst joi = require('joi');\r\n\r\n/**\r\n * –°—Ö–µ–º–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ environment –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\r\n */\r\nconst envSchema = joi.object({\r\n  // –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏\r\n  NODE_ENV: joi.string().valid('development', 'test', 'production').default('development'),\r\n  PORT: joi.number().port().default(3000),\r\n  HOST: joi.string().default('0.0.0.0'),\r\n  \r\n  // –°–µ—Ä–≤–∏—Å\r\n  SERVICE_NAME: joi.string().required(),\r\n  SERVICE_VERSION: joi.string().default('1.0.0'),\r\n  \r\n  // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö\r\n  DATABASE_URL: joi.string().uri().required(),\r\n  DATABASE_POOL_SIZE: joi.number().min(1).max(50).default(10),\r\n  \r\n  // Redis\r\n  REDIS_URL: joi.string().uri().required(),\r\n  REDIS_POOL_SIZE: joi.number().min(1).max(20).default(5),\r\n  \r\n  // JWT\r\n  JWT_SECRET: joi.string().min(32).required(),\r\n  JWT_EXPIRES_IN: joi.string().default('7d'),\r\n  JWT_REFRESH_EXPIRES_IN: joi.string().default('30d'),\r\n  \r\n  // CORS\r\n  ALLOWED_ORIGINS: joi.string().default('http://localhost:3000,http://localhost:3001'),\r\n  \r\n  // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ\r\n  LOG_LEVEL: joi.string().valid('debug', 'info', 'warn', 'error').default('info'),\r\n  \r\n  // Rate Limiting\r\n  RATE_LIMIT_MAX: joi.number().min(1).default(100),\r\n  RATE_LIMIT_WINDOW: joi.string().default('1 minute'),\r\n  \r\n  // –§–∞–π–ª—ã\r\n  UPLOAD_MAX_SIZE: joi.number().default(5242880), // 5MB\r\n  UPLOAD_ALLOWED_TYPES: joi.string().default('image/jpeg,image/png,image/gif,application/pdf'),\r\n  \r\n  // –í–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã\r\n  TELEGRAM_BOT_TOKEN: joi.string().when('SERVICE_NAME', {\r\n    is: 'telegram-bot',\r\n    then: joi.required(),\r\n    otherwise: joi.optional()\r\n  }),\r\n  \r\n  // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥\r\n  SENTRY_DSN: joi.string().uri().allow('').optional(),\r\n  PROMETHEUS_ENABLED: joi.boolean().default(false),\r\n  PROMETHEUS_PORT: joi.number().port().default(9090),\r\n  \r\n  // Email (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)\r\n  SMTP_HOST: joi.string().allow('').optional(),\r\n  SMTP_PORT: joi.number().port().optional(),\r\n  SMTP_USER: joi.string().allow('').optional(),\r\n  SMTP_PASS: joi.string().allow('').optional(),\r\n  \r\n  // Webhook URLs\r\n  WEBHOOK_SECRET: joi.string().optional(),\r\n  \r\n  // Backup\r\n  BACKUP_ENABLED: joi.boolean().default(false),\r\n  BACKUP_SCHEDULE: joi.string().default('0 2 * * *'), // –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2:00\r\n  BACKUP_RETENTION_DAYS: joi.number().min(1).default(7),\r\n  \r\n  // Health checks\r\n  HEALTH_CHECK_TIMEOUT: joi.number().default(5000),\r\n  \r\n  // Graceful shutdown\r\n  SHUTDOWN_TIMEOUT: joi.number().default(10000)\r\n}).unknown(); // –†–∞–∑—Ä–µ—à–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ\r\n\r\n/**\r\n * –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –ø–∞—Ä—Å–∏–Ω–≥ environment –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\r\n */\r\nconst validateEnv = () => {\r\n  const { error, value: envVars } = envSchema.validate(process.env);\r\n\r\n  if (error) {\r\n    throw new Error(`Config validation error: ${error.message}`);\r\n  }\r\n\r\n  return envVars;\r\n};\r\n\r\n// –í–∞–ª–∏–¥–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥—É–ª—è\r\nconst env = validateEnv();\r\n\r\n/**\r\n * –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è\r\n */\r\nconst config = {\r\n  // –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏\r\n  env: env.NODE_ENV,\r\n  isDev: env.NODE_ENV === 'development',\r\n  isTest: env.NODE_ENV === 'test',\r\n  isProd: env.NODE_ENV === 'production',\r\n  \r\n  // –°–µ—Ä–≤–µ—Ä\r\n  server: {\r\n    host: env.HOST,\r\n    port: env.PORT,\r\n    name: env.SERVICE_NAME,\r\n    version: env.SERVICE_VERSION\r\n  },\r\n  \r\n  // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö\r\n  database: {\r\n    url: env.DATABASE_URL,\r\n    poolSize: env.DATABASE_POOL_SIZE,\r\n    ssl: env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false\r\n  },\r\n  \r\n  // Redis\r\n  redis: {\r\n    url: env.REDIS_URL,\r\n    poolSize: env.REDIS_POOL_SIZE,\r\n    retryDelayOnFailover: 100,\r\n    enableReadyCheck: false,\r\n    maxRetriesPerRequest: 3,\r\n    lazyConnect: true\r\n  },\r\n  \r\n  // JWT\r\n  jwt: {\r\n    secret: env.JWT_SECRET,\r\n    expiresIn: env.JWT_EXPIRES_IN,\r\n    refreshExpiresIn: env.JWT_REFRESH_EXPIRES_IN,\r\n    algorithm: 'HS256'\r\n  },\r\n  \r\n  // CORS\r\n  cors: {\r\n    origins: env.ALLOWED_ORIGINS.split(',').map(origin => origin.trim()),\r\n    credentials: true,\r\n    methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],\r\n    allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With', 'X-Correlation-ID']\r\n  },\r\n  \r\n  // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ\r\n  logging: {\r\n    level: env.LOG_LEVEL,\r\n    pretty: env.NODE_ENV === 'development'\r\n  },\r\n  \r\n  // Rate Limiting\r\n  rateLimit: {\r\n    max: env.RATE_LIMIT_MAX,\r\n    timeWindow: env.RATE_LIMIT_WINDOW,\r\n    skipOnError: true\r\n  },\r\n  \r\n  // –§–∞–π–ª—ã\r\n  upload: {\r\n    maxSize: env.UPLOAD_MAX_SIZE,\r\n    allowedTypes: env.UPLOAD_ALLOWED_TYPES.split(',').map(type => type.trim()),\r\n    destination: './uploads'\r\n  },\r\n  \r\n  // –í–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã\r\n  external: {\r\n    telegram: {\r\n      botToken: env.TELEGRAM_BOT_TOKEN\r\n    }\r\n  },\r\n  \r\n  // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥\r\n  monitoring: {\r\n    sentry: {\r\n      dsn: env.SENTRY_DSN,\r\n      enabled: !!env.SENTRY_DSN\r\n    },\r\n    prometheus: {\r\n      enabled: env.PROMETHEUS_ENABLED,\r\n      port: env.PROMETHEUS_PORT\r\n    }\r\n  },\r\n  \r\n  // Email\r\n  email: {\r\n    smtp: {\r\n      host: env.SMTP_HOST,\r\n      port: env.SMTP_PORT,\r\n      auth: env.SMTP_USER && env.SMTP_PASS ? {\r\n        user: env.SMTP_USER,\r\n        pass: env.SMTP_PASS\r\n      } : null\r\n    }\r\n  },\r\n  \r\n  // Webhook\r\n  webhook: {\r\n    secret: env.WEBHOOK_SECRET\r\n  },\r\n  \r\n  // Backup\r\n  backup: {\r\n    enabled: env.BACKUP_ENABLED,\r\n    schedule: env.BACKUP_SCHEDULE,\r\n    retentionDays: env.BACKUP_RETENTION_DAYS\r\n  },\r\n  \r\n  // Health checks\r\n  health: {\r\n    timeout: env.HEALTH_CHECK_TIMEOUT\r\n  },\r\n  \r\n  // Graceful shutdown\r\n  shutdown: {\r\n    timeout: env.SHUTDOWN_TIMEOUT\r\n  }\r\n};\r\n\r\n/**\r\n * –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–æ –ø—É—Ç–∏\r\n */\r\nconst get = (path, defaultValue = undefined) => {\r\n  const keys = path.split('.');\r\n  let current = config;\r\n  \r\n  for (const key of keys) {\r\n    if (current && typeof current === 'object' && key in current) {\r\n      current = current[key];\r\n    } else {\r\n      return defaultValue;\r\n    }\r\n  }\r\n  \r\n  return current;\r\n};\r\n\r\n/**\r\n * –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞\r\n */\r\nconst validateServiceConfig = (serviceName) => {\r\n  const requiredConfigs = {\r\n    'auth': ['jwt.secret', 'database.url'],\r\n    'gateway': ['jwt.secret', 'cors.origins'],\r\n    'machines': ['database.url'],\r\n    'inventory': ['database.url'],\r\n    'tasks': ['database.url'],\r\n    'telegram-bot': ['external.telegram.botToken', 'database.url'],\r\n    'notifications': ['database.url'],\r\n    'monitoring': ['database.url'],\r\n    'backup': ['database.url']\r\n  };\r\n  \r\n  const required = requiredConfigs[serviceName] || [];\r\n  const missing = [];\r\n  \r\n  for (const configPath of required) {\r\n    if (get(configPath) === undefined) {\r\n      missing.push(configPath);\r\n    }\r\n  }\r\n  \r\n  if (missing.length > 0) {\r\n    throw new Error(`Missing required configuration for ${serviceName}: ${missing.join(', ')}`);\r\n  }\r\n  \r\n  return true;\r\n};\r\n\r\n/**\r\n * –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è Fastify\r\n */\r\nconst createFastifyConfig = () => {\r\n  return {\r\n    logger: config.logging.pretty ? {\r\n      transport: {\r\n        target: 'pino-pretty',\r\n        options: {\r\n          colorize: true,\r\n          translateTime: 'UTC:yyyy-mm-dd HH:MM:ss.l'\r\n        }\r\n      }\r\n    } : true,\r\n    \r\n    trustProxy: config.isProd,\r\n    \r\n    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è production\r\n    ...(config.isProd && {\r\n      keepAliveTimeout: 30000,\r\n      requestTimeout: 30000,\r\n      bodyLimit: config.upload.maxSize\r\n    })\r\n  };\r\n};\r\n\r\n/**\r\n * –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è Prisma\r\n */\r\nconst createPrismaConfig = () => {\r\n  return {\r\n    datasources: {\r\n      db: {\r\n        url: config.database.url\r\n      }\r\n    },\r\n    log: config.isDev ? ['query', 'info', 'warn', 'error'] : ['warn', 'error']\r\n  };\r\n};\r\n\r\n/**\r\n * –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è Redis\r\n */\r\nconst createRedisConfig = () => {\r\n  return {\r\n    ...config.redis,\r\n    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è production\r\n    ...(config.isProd && {\r\n      connectTimeout: 10000,\r\n      commandTimeout: 5000,\r\n      enableOfflineQueue: false\r\n    })\r\n  };\r\n};\r\n\r\n/**\r\n * –í—ã–≤–æ–¥ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ –∫–æ–Ω—Å–æ–ª—å (–±–µ–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤)\r\n */\r\nconst printConfig = () => {\r\n  const safeToPrint = { ...config };\r\n  \r\n  // –ú–∞—Å–∫–∏—Ä—É–µ–º —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\r\n  if (safeToPrint.jwt) safeToPrint.jwt.secret = '***';\r\n  if (safeToPrint.database) safeToPrint.database.url = safeToPrint.database.url.replace(/:\\/\\/.*@/, '://***@');\r\n  if (safeToPrint.redis) safeToPrint.redis.url = safeToPrint.redis.url.replace(/:\\/\\/.*@/, '://***@');\r\n  if (safeToPrint.external?.telegram) safeToPrint.external.telegram.botToken = '***';\r\n  if (safeToPrint.email?.smtp?.auth) {\r\n    safeToPrint.email.smtp.auth.user = '***';\r\n    safeToPrint.email.smtp.auth.pass = '***';\r\n  }\r\n  \r\n  console.log('Configuration loaded:', JSON.stringify(safeToPrint, null, 2));\r\n};\r\n\r\n/**\r\n * –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏\r\n */\r\nconst isReady = () => {\r\n  try {\r\n    validateServiceConfig(config.server.name);\r\n    return true;\r\n  } catch (error) {\r\n    console.error('Configuration not ready:', error.message);\r\n    return false;\r\n  }\r\n};\r\n\r\n/**\r\n * –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞\r\n */\r\nconst getServiceEnv = (serviceName) => {\r\n  const serviceEnvs = {\r\n    'auth': {\r\n      SERVICE_NAME: 'auth',\r\n      PORT: 3001\r\n    },\r\n    'gateway': {\r\n      SERVICE_NAME: 'gateway',\r\n      PORT: 8000\r\n    },\r\n    'machines': {\r\n      SERVICE_NAME: 'machines',\r\n      PORT: 3002\r\n    },\r\n    'inventory': {\r\n      SERVICE_NAME: 'inventory',\r\n      PORT: 3003\r\n    },\r\n    'tasks': {\r\n      SERVICE_NAME: 'tasks',\r\n      PORT: 3004\r\n    },\r\n    'telegram-bot': {\r\n      SERVICE_NAME: 'telegram-bot',\r\n      PORT: 3005\r\n    },\r\n    'notifications': {\r\n      SERVICE_NAME: 'notifications',\r\n      PORT: 3006\r\n    },\r\n    'monitoring': {\r\n      SERVICE_NAME: 'monitoring',\r\n      PORT: 3007\r\n    },\r\n    'backup': {\r\n      SERVICE_NAME: 'backup',\r\n      PORT: 3008\r\n    }\r\n  };\r\n  \r\n  return serviceEnvs[serviceName] || {};\r\n};\r\n\r\nmodule.exports = {\r\n  // –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è\r\n  config,\r\n  \r\n  // –§—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–∞\r\n  get,\r\n  \r\n  // –í–∞–ª–∏–¥–∞—Ü–∏—è\r\n  validateServiceConfig,\r\n  isReady,\r\n  \r\n  // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –¥–ª—è –±–∏–±–ª–∏–æ—Ç–µ–∫\r\n  createFastifyConfig,\r\n  createPrismaConfig,\r\n  createRedisConfig,\r\n  \r\n  // –£—Ç–∏–ª–∏—Ç—ã\r\n  printConfig,\r\n  getServiceEnv,\r\n  \r\n  // –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ env\r\n  env\r\n};\r\n",
  "railway-deploy.js": "#!/usr/bin/env node\r\n\r\n/**\r\n * VHM24 Railway Deployment Script\r\n * –ó–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –≤ –æ–¥–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ –¥–ª—è Railway\r\n */\r\n\r\nconst path = require('path');\r\nconst fs = require('fs');\r\n\r\n// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\ntry {\r\n  require('dotenv').config();\r\n} catch (error) {\r\n  console.log('‚ö†Ô∏è  dotenv not available, using environment variables');\r\n}\r\n\r\nconsole.log('üöÇ VHM24 Railway Deployment Starting...');\r\nconsole.log(`üìç Environment: ${process.env.NODE_ENV || 'production'}`);\r\nconsole.log(`üîå Port: ${process.env.PORT || 8000}`);\r\n\r\n// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\nprocess.env.NODE_ENV = process.env.NODE_ENV || 'production';\r\nprocess.env.PORT = process.env.PORT || '8000';\r\n\r\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ\r\nconst requiredEnvVars = ['DATABASE_URL'];\r\nconst missingVars = requiredEnvVars.filter(varName => !process.env[varName]);\r\n\r\nif (missingVars.length > 0) {\r\n  console.error('‚ùå Missing required environment variables:', missingVars.join(', '));\r\n  process.exit(1);\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞\r\nasync function startService(serviceName, servicePath, port) {\r\n  try {\r\n    console.log(`üöÄ Starting ${serviceName} service on port ${port}...`);\r\n    \r\n    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ä—Ç –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞\r\n    process.env[`${serviceName.toUpperCase()}_PORT`] = port;\r\n    \r\n    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å\r\n    require(servicePath);\r\n    \r\n    console.log(`‚úÖ ${serviceName} service started successfully`);\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`‚ùå Failed to start ${serviceName} service:`, error.message);\r\n    return false;\r\n  }\r\n}\r\n\r\n// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è\r\nasync function deployToRailway() {\r\n  try {\r\n    console.log('üîß Initializing Railway deployment...');\r\n    \r\n    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma –∫–ª–∏–µ–Ω—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ\r\n    if (fs.existsSync('packages/database/prisma/schema.prisma')) {\r\n      console.log('üîß Checking Prisma client...');\r\n      try {\r\n        const { getAuthClient } = require('./packages/database');\r\n        await getAuthClient().$connect();\r\n        console.log('‚úÖ Prisma client is ready');\r\n      } catch (error) {\r\n        console.log('‚ö†Ô∏è  Prisma client needs generation, this is normal on first deploy');\r\n      }\r\n    }\r\n\r\n    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ\r\n    const services = [\r\n      { name: 'Auth', path: './services/auth/src/index.js', port: 3001 },\r\n      { name: 'Machines', path: './services/machines/src/index.js', port: 3002 },\r\n      { name: 'Inventory', path: './services/inventory/src/index.js', port: 3003 },\r\n      { name: 'Tasks', path: './services/tasks/src/index.js', port: 3004 },\r\n      { name: 'Bunkers', path: './services/bunkers/src/index.js', port: 3005 },\r\n      { name: 'Notifications', path: './services/notifications/src/index.js', port: 3006 }\r\n    ];\r\n\r\n    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã –≤ —Ñ–æ–Ω–µ\r\n    for (const service of services) {\r\n      if (fs.existsSync(service.path)) {\r\n        setTimeout(() => {\r\n          startService(service.name, service.path, service.port);\r\n        }, 1000); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏\r\n      } else {\r\n        console.log(`‚ö†Ô∏è  Service ${service.name} not found at ${service.path}`);\r\n      }\r\n    }\r\n\r\n    // –ó–∞–ø—É—Å–∫–∞–µ–º Telegram Bot –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –µ—Å—Ç—å\r\n    if (process.env.TELEGRAM_BOT_TOKEN && fs.existsSync('./services/telegram-bot/src/index.js')) {\r\n      setTimeout(() => {\r\n        console.log('ü§ñ Starting Telegram Bot...');\r\n        require('./services/telegram-bot/src/index.js');\r\n      }, 2000);\r\n    }\r\n\r\n    // –ó–∞–ø—É—Å–∫–∞–µ–º Gateway –ø–æ—Å–ª–µ–¥–Ω–∏–º (–æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å)\r\n    setTimeout(() => {\r\n      console.log('üì° Starting Gateway service (main)...');\r\n      require('./services/gateway/src/index.js');\r\n    }, 3000);\r\n\r\n    console.log('üéâ All services initialization started!');\r\n    \r\n  } catch (error) {\r\n    console.error('‚ùå Railway deployment failed:', error.message);\r\n    console.error('Stack trace:', error.stack);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤\r\nprocess.on('SIGTERM', () => {\r\n  console.log('üõë Received SIGTERM, shutting down...');\r\n  process.exit(0);\r\n});\r\n\r\nprocess.on('SIGINT', () => {\r\n  console.log('üõë Received SIGINT, shutting down...');\r\n  process.exit(0);\r\n});\r\n\r\nprocess.on('uncaughtException', (error) => {\r\n  console.error('‚ùå Uncaught Exception:', error);\r\n  process.exit(1);\r\n});\r\n\r\nprocess.on('unhandledRejection', (reason, promise) => {\r\n  console.error('‚ùå Unhandled Rejection:', reason);\r\n  process.exit(1);\r\n});\r\n\r\n// –ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ–ø–ª–æ–π\r\ndeployToRailway();\r\n",
  "railway-migrate.js": "#!/usr/bin/env node\r\n\r\n/**\r\n * VHM24 Railway Database Migration Script\r\n * –ó–∞–ø—É—Å–∫–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Railway\r\n */\r\n\r\nconst { spawn } = require('child_process');\r\nconst path = require('path');\r\nconst fs = require('fs');\r\n\r\n// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\ntry {\r\n  require('dotenv').config();\r\n} catch (error) {\r\n  console.log('‚ö†Ô∏è  dotenv not available, using environment variables');\r\n}\r\n\r\nconsole.log('üóÑÔ∏è  VHM24 Railway Database Migration Starting...');\r\nconsole.log(`üìç Environment: ${process.env.NODE_ENV || 'production'}`);\r\n\r\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ\r\nif (!process.env.DATABASE_URL) {\r\n  console.error('‚ùå DATABASE_URL is required for migration');\r\n  process.exit(1);\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–æ–º–∞–Ω–¥—ã\r\nfunction runCommand(command, args = [], options = {}) {\r\n  return new Promise((resolve, reject) => {\r\n    console.log(`üîß Running: ${command} ${args.join(' ')}`);\r\n    \r\n    const child = spawn(command, args, {\r\n      stdio: 'inherit',\r\n      shell: true,\r\n      cwd: path.join(__dirname, 'packages/database'),\r\n      ...options\r\n    });\r\n\r\n    child.on('close', (code) => {\r\n      if (code === 0) {\r\n        resolve();\r\n      } else {\r\n        reject(new Error(`Command failed with code ${code}`));\r\n      }\r\n    });\r\n\r\n    child.on('error', reject);\r\n  });\r\n}\r\n\r\n// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏\r\nasync function migrateDatabase() {\r\n  try {\r\n    console.log('üîß Starting database migration...');\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ schema.prisma\r\n    const schemaPath = path.join(__dirname, 'packages/database/prisma/schema.prisma');\r\n    if (!fs.existsSync(schemaPath)) {\r\n      throw new Error('Prisma schema not found at packages/database/prisma/schema.prisma');\r\n    }\r\n    \r\n    console.log('‚úÖ Prisma schema found');\r\n    \r\n    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma –∫–ª–∏–µ–Ω—Ç\r\n    console.log('üîß Generating Prisma client...');\r\n    await runCommand('npx', ['prisma', 'generate']);\r\n    console.log('‚úÖ Prisma client generated');\r\n    \r\n    // –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏\r\n    console.log('üîß Running database migrations...');\r\n    await runCommand('npx', ['prisma', 'migrate', 'deploy']);\r\n    console.log('‚úÖ Database migrations completed');\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö\r\n    console.log('üîß Testing database connection...');\r\n    const { getAuthClient } = require('./packages/database');\r\n    const prisma = getAuthClient();\r\n    \r\n    await prisma.$connect();\r\n    console.log('‚úÖ Database connection successful');\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–∞–±–ª–∏—Ü\r\n    const userCount = await prisma.user.count();\r\n    console.log(`üìä Users in database: ${userCount}`);\r\n    \r\n    // –°–æ–∑–¥–∞–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\r\n    if (userCount === 0) {\r\n      console.log('üîß Creating default admin user...');\r\n      const bcrypt = require('bcrypt');\r\n      \r\n      const adminUser = await prisma.user.create({\r\n        data: {\r\n          email: 'admin@vhm24.ru',\r\n          name: 'System Administrator',\r\n          passwordHash: await bcrypt.hash('admin123', 10),\r\n          telegramId: process.env.ADMIN_IDS || '42283329',\r\n          roles: ['ADMIN'],\r\n          isActive: true\r\n        }\r\n      });\r\n      \r\n      console.log('‚úÖ Default admin user created');\r\n      console.log(`üìß Email: admin@vhm24.ru`);\r\n      console.log(`üîë Password: admin123`);\r\n      console.log(`üì± Telegram ID: ${adminUser.telegramId}`);\r\n    }\r\n    \r\n    await prisma.$disconnect();\r\n    console.log('üéâ Database migration completed successfully!');\r\n    \r\n  } catch (error) {\r\n    console.error('‚ùå Database migration failed:', error.message);\r\n    console.error('Stack trace:', error.stack);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é\r\nmigrateDatabase();\r\n",
  "railway-start-final.js": "#!/usr/bin/env node\r\n\r\n/**\r\n * VHM24 Railway Final Start Script\r\n * –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—é –∏ –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ –æ–¥–Ω–æ–º —Å–∫—Ä–∏–ø—Ç–µ\r\n */\r\n\r\nconst { spawn } = require('child_process');\r\nconst path = require('path');\r\nconst fs = require('fs');\r\n\r\n// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\ntry {\r\n  require('dotenv').config();\r\n} catch (error) {\r\n  console.log('‚ö†Ô∏è  dotenv not available, using environment variables');\r\n}\r\n\r\nconsole.log('üöÇ VHM24 Railway Final Start...');\r\nconsole.log(`üìç Environment: ${process.env.NODE_ENV || 'production'}`);\r\nconsole.log(`üîå Port: ${process.env.PORT || 8000}`);\r\n\r\n// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\nprocess.env.NODE_ENV = process.env.NODE_ENV || 'production';\r\nprocess.env.PORT = process.env.PORT || '8000';\r\n\r\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ\r\nif (!process.env.DATABASE_URL) {\r\n  console.error('‚ùå DATABASE_URL is required for Railway deployment');\r\n  process.exit(1);\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–æ–º–∞–Ω–¥—ã\r\nfunction runCommand(command, args = [], options = {}) {\r\n  return new Promise((resolve, reject) => {\r\n    console.log(`üîß Running: ${command} ${args.join(' ')}`);\r\n    \r\n    const child = spawn(command, args, {\r\n      stdio: 'inherit',\r\n      shell: true,\r\n      ...options\r\n    });\r\n\r\n    child.on('close', (code) => {\r\n      if (code === 0) {\r\n        resolve();\r\n      } else {\r\n        reject(new Error(`Command failed with code ${code}`));\r\n      }\r\n    });\r\n\r\n    child.on('error', reject);\r\n  });\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞\r\nasync function startService(serviceName, servicePath, port) {\r\n  try {\r\n    console.log(`üöÄ Starting ${serviceName} service on port ${port}...`);\r\n    \r\n    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ä—Ç –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞\r\n    process.env[`${serviceName.toUpperCase()}_PORT`] = port;\r\n    \r\n    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å\r\n    require(servicePath);\r\n    \r\n    console.log(`‚úÖ ${serviceName} service started successfully`);\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`‚ùå Failed to start ${serviceName} service:`, error.message);\r\n    return false;\r\n  }\r\n}\r\n\r\n// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è\r\nasync function startRailwayApp() {\r\n  try {\r\n    console.log('üóÑÔ∏è  === DATABASE MIGRATION PHASE ===');\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ schema.prisma\r\n    const schemaPath = path.join(__dirname, 'packages/database/prisma/schema.prisma');\r\n    if (!fs.existsSync(schemaPath)) {\r\n      throw new Error('Prisma schema not found at packages/database/prisma/schema.prisma');\r\n    }\r\n    \r\n    console.log('‚úÖ Prisma schema found');\r\n    \r\n    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma –∫–ª–∏–µ–Ω—Ç\r\n    console.log('üîß Generating Prisma client...');\r\n    await runCommand('npx', ['prisma', 'generate'], {\r\n      cwd: path.join(__dirname, 'packages/database')\r\n    });\r\n    console.log('‚úÖ Prisma client generated');\r\n    \r\n    // –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏\r\n    console.log('üîß Running database migrations...');\r\n    await runCommand('npx', ['prisma', 'migrate', 'deploy'], {\r\n      cwd: path.join(__dirname, 'packages/database')\r\n    });\r\n    console.log('‚úÖ Database migrations completed');\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö\r\n    console.log('üîß Testing database connection...');\r\n    const { getAuthClient } = require('./packages/database');\r\n    const prisma = getAuthClient();\r\n    \r\n    await prisma.$connect();\r\n    console.log('‚úÖ Database connection successful');\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\r\n    const userCount = await prisma.user.count();\r\n    console.log(`üìä Users in database: ${userCount}`);\r\n    \r\n    // –°–æ–∑–¥–∞–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\r\n    if (userCount === 0) {\r\n      console.log('üîß Creating default admin user...');\r\n      const bcrypt = require('bcrypt');\r\n      \r\n      const adminUser = await prisma.user.create({\r\n        data: {\r\n          email: 'admin@vhm24.ru',\r\n          name: 'System Administrator',\r\n          passwordHash: await bcrypt.hash('admin123', 10),\r\n          telegramId: process.env.ADMIN_IDS || '42283329',\r\n          roles: ['ADMIN'],\r\n          isActive: true\r\n        }\r\n      });\r\n      \r\n      console.log('‚úÖ Default admin user created');\r\n      console.log(`üìß Email: admin@vhm24.ru`);\r\n      console.log(`üîë Password: admin123`);\r\n      console.log(`üì± Telegram ID: ${adminUser.telegramId}`);\r\n    }\r\n    \r\n    await prisma.$disconnect();\r\n    console.log('üéâ Database migration completed successfully!');\r\n    \r\n    console.log('\\nüöÇ === APPLICATION DEPLOYMENT PHASE ===');\r\n    \r\n    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ\r\n    const services = [\r\n      { name: 'Auth', path: './services/auth/src/index.js', port: 3001 },\r\n      { name: 'Machines', path: './services/machines/src/index.js', port: 3002 },\r\n      { name: 'Inventory', path: './services/inventory/src/index.js', port: 3003 },\r\n      { name: 'Tasks', path: './services/tasks/src/index.js', port: 3004 },\r\n      { name: 'Bunkers', path: './services/bunkers/src/index.js', port: 3005 },\r\n      { name: 'Notifications', path: './services/notifications/src/index.js', port: 3006 }\r\n    ];\r\n\r\n    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã –≤ —Ñ–æ–Ω–µ\r\n    for (const service of services) {\r\n      if (fs.existsSync(service.path)) {\r\n        setTimeout(() => {\r\n          startService(service.name, service.path, service.port);\r\n        }, 1000); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏\r\n      } else {\r\n        console.log(`‚ö†Ô∏è  Service ${service.name} not found at ${service.path}`);\r\n      }\r\n    }\r\n\r\n    // –ó–∞–ø—É—Å–∫–∞–µ–º Telegram Bot –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –µ—Å—Ç—å\r\n    if (process.env.TELEGRAM_BOT_TOKEN && fs.existsSync('./services/telegram-bot/src/index.js')) {\r\n      setTimeout(() => {\r\n        console.log('ü§ñ Starting Telegram Bot...');\r\n        require('./services/telegram-bot/src/index.js');\r\n      }, 2000);\r\n    }\r\n\r\n    // –ó–∞–ø—É—Å–∫–∞–µ–º Gateway –ø–æ—Å–ª–µ–¥–Ω–∏–º (–æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å)\r\n    setTimeout(() => {\r\n      console.log('üì° Starting Gateway service (main)...');\r\n      require('./services/gateway/src/index.js');\r\n    }, 3000);\r\n\r\n    console.log('üéâ All services initialization started!');\r\n    console.log(`üåê Application will be available on port ${process.env.PORT}`);\r\n    \r\n  } catch (error) {\r\n    console.error('‚ùå Railway deployment failed:', error.message);\r\n    console.error('Stack trace:', error.stack);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤\r\nprocess.on('SIGTERM', () => {\r\n  console.log('üõë Received SIGTERM, shutting down...');\r\n  process.exit(0);\r\n});\r\n\r\nprocess.on('SIGINT', () => {\r\n  console.log('üõë Received SIGINT, shutting down...');\r\n  process.exit(0);\r\n});\r\n\r\nprocess.on('uncaughtException', (error) => {\r\n  console.error('‚ùå Uncaught Exception:', error);\r\n  process.exit(1);\r\n});\r\n\r\nprocess.on('unhandledRejection', (reason, promise) => {\r\n  console.error('‚ùå Unhandled Rejection:', reason);\r\n  process.exit(1);\r\n});\r\n\r\n// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\r\nstartRailwayApp();\r\n",
  "railway-start-simple.js": "#!/usr/bin/env node\r\n\r\n/**\r\n * VHM24 Railway Simple Start Script\r\n * –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—É—Å–∫ –¥–ª—è Railway –±–µ–∑ —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏\r\n */\r\n\r\nconst Fastify = require('fastify');\r\n\r\nconsole.log('üöÇ VHM24 Railway Simple Start...');\r\nconsole.log(`üìç Environment: ${process.env.NODE_ENV || 'production'}`);\r\nconsole.log(`üîå Port: ${process.env.PORT || 8000}`);\r\n\r\n// –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π Fastify —Å–µ—Ä–≤–µ—Ä\r\nconst fastify = Fastify({\r\n  logger: true\r\n});\r\n\r\n// Health check endpoint\r\nfastify.get('/health', async (request, reply) => {\r\n  return { \r\n    status: 'ok', \r\n    service: 'vhm24-simple',\r\n    timestamp: new Date().toISOString(),\r\n    environment: process.env.NODE_ENV || 'production',\r\n    port: process.env.PORT || 8000\r\n  };\r\n});\r\n\r\n// Root endpoint\r\nfastify.get('/', async (request, reply) => {\r\n  reply.type('text/html');\r\n  return `\r\n    <!DOCTYPE html>\r\n    <html>\r\n    <head>\r\n      <title>VHM24 - Railway Deployment Success</title>\r\n      <style>\r\n        body { \r\n          font-family: Arial, sans-serif; \r\n          margin: 40px; \r\n          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n          color: white;\r\n          text-align: center;\r\n        }\r\n        .container { \r\n          max-width: 800px; \r\n          margin: 0 auto; \r\n          padding: 40px;\r\n          background: rgba(255,255,255,0.1);\r\n          border-radius: 20px;\r\n          backdrop-filter: blur(10px);\r\n        }\r\n        .success { color: #4CAF50; font-size: 2em; margin: 20px 0; }\r\n        .endpoint { \r\n          margin: 10px 0; \r\n          padding: 10px; \r\n          background: rgba(255,255,255,0.2); \r\n          border-radius: 10px; \r\n        }\r\n      </style>\r\n    </head>\r\n    <body>\r\n      <div class=\"container\">\r\n        <h1>üéâ VHM24 Railway Deployment</h1>\r\n        <div class=\"success\">‚úÖ –£–°–ü–ï–®–ù–û –†–ê–ó–í–ï–†–ù–£–¢–û!</div>\r\n        \r\n        <h2>üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ:</h2>\r\n        <div class=\"endpoint\">üåç Environment: ${process.env.NODE_ENV || 'production'}</div>\r\n        <div class=\"endpoint\">üîå Port: ${process.env.PORT || 8000}</div>\r\n        <div class=\"endpoint\">üöÇ Railway URL: ${process.env.RAILWAY_STATIC_URL || 'N/A'}</div>\r\n        <div class=\"endpoint\">‚è∞ Deployed: ${new Date().toISOString()}</div>\r\n        \r\n        <h2>üîó –î–æ—Å—Ç—É–ø–Ω—ã–µ endpoints:</h2>\r\n        <div class=\"endpoint\">GET /health - Health check</div>\r\n        <div class=\"endpoint\">GET / - –≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞</div>\r\n        \r\n        <h2>üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:</h2>\r\n        <p>1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å health endpoint: <code>/health</code></p>\r\n        <p>2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏</p>\r\n        <p>3. –î–æ–±–∞–≤–∏—Ç—å API endpoints –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏</p>\r\n        \r\n        <div style=\"margin-top: 40px; font-size: 0.9em; opacity: 0.8;\">\r\n          VHM24 - VendHub Manager 24/7<br>\r\n          Railway Deployment Test - Version 1.0.0\r\n        </div>\r\n      </div>\r\n    </body>\r\n    </html>\r\n  `;\r\n});\r\n\r\n// API Documentation endpoint\r\nfastify.get('/docs', async (request, reply) => {\r\n  reply.type('text/html');\r\n  return `\r\n    <!DOCTYPE html>\r\n    <html>\r\n    <head>\r\n      <title>VHM24 API Documentation</title>\r\n      <style>\r\n        body { font-family: Arial, sans-serif; margin: 40px; }\r\n        .endpoint { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }\r\n        .method { font-weight: bold; color: #007bff; }\r\n      </style>\r\n    </head>\r\n    <body>\r\n      <h1>ü§ñ VHM24 API Documentation</h1>\r\n      <p>VendHub Manager 24/7 - Railway Test Deployment</p>\r\n      \r\n      <div class=\"endpoint\">\r\n        <div class=\"method\">GET /</div>\r\n        <p>Main page with deployment information</p>\r\n      </div>\r\n      \r\n      <div class=\"endpoint\">\r\n        <div class=\"method\">GET /health</div>\r\n        <p>Health check endpoint</p>\r\n      </div>\r\n      \r\n      <div class=\"endpoint\">\r\n        <div class=\"method\">GET /docs</div>\r\n        <p>This documentation page</p>\r\n      </div>\r\n      \r\n      <p><strong>Status:</strong> Railway deployment test successful</p>\r\n      <p><strong>Environment:</strong> ${process.env.NODE_ENV || 'production'}</p>\r\n      <p><strong>Version:</strong> 1.0.0</p>\r\n    </body>\r\n    </html>\r\n  `;\r\n});\r\n\r\n// –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä\r\nconst start = async () => {\r\n  try {\r\n    const port = process.env.PORT || 8000;\r\n    await fastify.listen({ \r\n      port: port,\r\n      host: '0.0.0.0'\r\n    });\r\n    \r\n    console.log(`üéâ VHM24 Simple is running on port ${port}`);\r\n    console.log(`üåê Health check: http://localhost:${port}/health`);\r\n    console.log(`üìö Documentation: http://localhost:${port}/docs`);\r\n    \r\n    // Railway specific logging\r\n    if (process.env.RAILWAY_ENVIRONMENT) {\r\n      console.log('üöÇ Running on Railway:', process.env.RAILWAY_STATIC_URL);\r\n      console.log('üîó Public URL:', `https://${process.env.RAILWAY_STATIC_URL}`);\r\n    }\r\n    \r\n  } catch (err) {\r\n    console.error('‚ùå Server failed to start:', err);\r\n    process.exit(1);\r\n  }\r\n};\r\n\r\n// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤\r\nprocess.on('SIGTERM', async () => {\r\n  console.log('üõë Received SIGTERM, shutting down...');\r\n  await fastify.close();\r\n  process.exit(0);\r\n});\r\n\r\nprocess.on('SIGINT', async () => {\r\n  console.log('üõë Received SIGINT, shutting down...');\r\n  await fastify.close();\r\n  process.exit(0);\r\n});\r\n\r\n// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\r\nstart();\r\n",
  "railway-start.js": "#!/usr/bin/env node\r\n\r\nconst { spawn } = require('child_process');\r\nconst path = require('path');\r\nconst fs = require('fs');\r\n\r\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ\r\nconst isRailway = process.env.RAILWAY_ENVIRONMENT || process.env.RAILWAY_STATIC_URL || process.env.RAILWAY_PROJECT_ID;\r\nconst isProduction = process.env.NODE_ENV === 'production' || isRailway;\r\n\r\nconsole.log('üöÄ VHM24 Platform Starting...');\r\nconsole.log(`üìç Environment: ${isProduction ? 'Production' : 'Development'}`);\r\nconsole.log(`üöÇ Railway: ${isRailway ? 'Yes' : 'No'}`);\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞\r\nfunction startProcess(command, args = [], options = {}) {\r\n  return new Promise((resolve, reject) => {\r\n    console.log(`üîß Running: ${command} ${args.join(' ')}`);\r\n    \r\n    const child = spawn(command, args, {\r\n      stdio: 'inherit',\r\n      shell: true,\r\n      ...options\r\n    });\r\n\r\n    child.on('close', (code) => {\r\n      if (code === 0) {\r\n        resolve();\r\n      } else {\r\n        reject(new Error(`Process exited with code ${code}`));\r\n      }\r\n    });\r\n\r\n    child.on('error', reject);\r\n  });\r\n}\r\n\r\n// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞\r\nasync function start() {\r\n  try {\r\n    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\r\n    process.env.PORT = process.env.PORT || '8000';\r\n    process.env.NODE_ENV = process.env.NODE_ENV || (isRailway ? 'production' : 'development');\r\n\r\n    if (isRailway) {\r\n      console.log('üöÇ Starting in Railway mode...');\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\r\n      if (!process.env.DATABASE_URL) {\r\n        throw new Error('DATABASE_URL is required for Railway deployment');\r\n      }\r\n      \r\n      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma –∫–ª–∏–µ–Ω—Ç\r\n      if (fs.existsSync('packages/database/prisma/schema.prisma')) {\r\n        console.log('üîß Generating Prisma client...');\r\n        try {\r\n          await startProcess('npx', ['prisma', 'generate'], {\r\n            cwd: 'packages/database'\r\n          });\r\n          console.log('‚úÖ Prisma client generated successfully');\r\n        } catch (error) {\r\n          console.error('‚ùå Failed to generate Prisma client:', error.message);\r\n          // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –≤–æ–∑–º–æ–∂–Ω–æ –∫–ª–∏–µ–Ω—Ç —É–∂–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω\r\n        }\r\n      }\r\n\r\n      // –í Railway –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ Gateway (–æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å)\r\n      console.log('üì° Starting Gateway service for Railway...');\r\n      \r\n      // –ó–∞–≥—Ä—É–∂–∞–µ–º dotenv –¥–ª—è Railway\r\n      try {\r\n        require('dotenv').config();\r\n      } catch (error) {\r\n        console.log('‚ö†Ô∏è  dotenv not available, using environment variables');\r\n      }\r\n      \r\n      // –ó–∞–ø—É—Å–∫–∞–µ–º Gateway\r\n      require('./services/gateway/src/index.js');\r\n      \r\n    } else {\r\n      console.log('üíª Starting in local development mode...');\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .env —Ñ–∞–π–ª–∞\r\n      if (!fs.existsSync('.env')) {\r\n        console.log('‚ö†Ô∏è  .env file not found, using environment variables');\r\n      }\r\n      \r\n      // –õ–æ–∫–∞–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã —á–µ—Ä–µ–∑ start.js\r\n      require('./start.js');\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Failed to start application:', error.message);\r\n    console.error('Stack trace:', error.stack);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è\r\nprocess.on('SIGTERM', () => {\r\n  console.log('üõë Received SIGTERM, shutting down gracefully...');\r\n  process.exit(0);\r\n});\r\n\r\nprocess.on('SIGINT', () => {\r\n  console.log('üõë Received SIGINT, shutting down gracefully...');\r\n  process.exit(0);\r\n});\r\n\r\nprocess.on('uncaughtException', (error) => {\r\n  console.error('‚ùå Uncaught Exception:', error);\r\n  process.exit(1);\r\n});\r\n\r\nprocess.on('unhandledRejection', (reason, promise) => {\r\n  console.error('‚ùå Unhandled Rejection at:', promise, 'reason:', reason);\r\n  process.exit(1);\r\n});\r\n\r\n// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\r\nstart();\r\n",
  "restart-services-with-redis-fix.js": "#!/usr/bin/env node\r\n\r\nconst { spawn, exec } = require('child_process');\r\nconst path = require('path');\r\n\r\nconsole.log('üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º Redis...');\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã\r\nfunction executeCommand(command, options = {}) {\r\n  return new Promise((resolve, reject) => {\r\n    exec(command, options, (error, stdout, stderr) => {\r\n      if (error) {\r\n        console.error(`–û—à–∏–±–∫–∞: ${error.message}`);\r\n        reject(error);\r\n        return;\r\n      }\r\n      if (stderr) {\r\n        console.error(`Stderr: ${stderr}`);\r\n      }\r\n      console.log(stdout);\r\n      resolve(stdout);\r\n    });\r\n  });\r\n}\r\n\r\nasync function main() {\r\n  try {\r\n    console.log('1. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö Node.js –ø—Ä–æ—Ü–µ—Å—Å–æ–≤...');\r\n    \r\n    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ node –ø—Ä–æ—Ü–µ—Å—Å—ã (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)\r\n    try {\r\n      await executeCommand('taskkill /F /IM node.exe', { timeout: 10000 });\r\n    } catch (error) {\r\n      console.log('–ü—Ä–æ—Ü–µ—Å—Å—ã Node.js —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');\r\n    }\r\n\r\n    // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ\r\n    await new Promise(resolve => setTimeout(resolve, 2000));\r\n\r\n    console.log('2. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º Redis...');\r\n    \r\n    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã –∑–∞–Ω–æ–≤–æ\r\n    const startProcess = spawn('node', ['start-all-services.js'], {\r\n      stdio: 'inherit',\r\n      cwd: process.cwd()\r\n    });\r\n\r\n    console.log('‚úÖ –°–µ—Ä–≤–∏—Å—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º Redis!');\r\n    console.log('üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤...');\r\n\r\n    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞\r\n    startProcess.on('close', (code) => {\r\n      console.log(`–ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–µ–Ω —Å –∫–æ–¥–æ–º ${code}`);\r\n    });\r\n\r\n    startProcess.on('error', (error) => {\r\n      console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞:', error);\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–∏—Å–æ–≤:', error);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è\r\nprocess.on('SIGINT', () => {\r\n  console.log('\\nüõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è...');\r\n  process.exit(0);\r\n});\r\n\r\nprocess.on('SIGTERM', () => {\r\n  console.log('\\nüõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è...');\r\n  process.exit(0);\r\n});\r\n\r\nmain();\r\n",
  "scripts/check-env.js": "// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–æ–π —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è\r\nconst SERVICE = process.env.RAILWAY_SERVICE_NAME || \r\n               process.env.SERVICE_NAME || \r\n               detectServiceFromPath() ||\r\n               'monolith'; // –ò–∑–º–µ–Ω–µ–Ω–æ —Å 'gateway' –Ω–∞ 'monolith'\r\n\r\nconsole.log(`üéØ Checking environment variables for service: ${SERVICE}`);\r\n\r\n// –ë–∞–∑–æ–≤—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤\r\nconst baseRequired = [\r\n  'DATABASE_URL'\r\n];\r\n\r\n// –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞\r\nconst serviceRequirements = {\r\n  'monolith': ['DATABASE_URL'], // –î–æ–±–∞–≤–ª–µ–Ω –º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å\r\n  'gateway': ['DATABASE_URL'],\r\n  'auth': ['DATABASE_URL', 'JWT_SECRET'],\r\n  'telegram-bot': ['DATABASE_URL', 'TELEGRAM_BOT_TOKEN'],\r\n  'notifications': ['DATABASE_URL', 'TELEGRAM_BOT_TOKEN'],\r\n  'data-import': ['DATABASE_URL'],\r\n  'backup': ['DATABASE_URL', 'S3_BUCKET', 'S3_ACCESS_KEY', 'S3_SECRET_KEY'],\r\n  // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–∑–æ–≤—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π\r\n};\r\n\r\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞\r\nconst required = serviceRequirements[SERVICE] || baseRequired;\r\n\r\nconst optional = [\r\n  'REDIS_URL',\r\n  'S3_BUCKET',\r\n  'S3_ACCESS_KEY',\r\n  'S3_SECRET_KEY',\r\n  'SENTRY_DSN',\r\n  'JWT_SECRET',\r\n  'TELEGRAM_BOT_TOKEN'\r\n].filter(key => !required.includes(key)); // –ò—Å–∫–ª—é—á–∞–µ–º —Ç–µ, —á—Ç–æ —É–∂–µ –≤ required\r\n\r\nconsole.log('üîç Checking environment variables...');\r\n\r\nconst missing = required.filter(key => !process.env[key]);\r\nconst missingOptional = optional.filter(key => !process.env[key]);\r\n\r\nif (missing.length > 0) {\r\n  console.error(`‚ùå Missing required environment variables for service ${SERVICE}:`);\r\n  missing.forEach(key => console.error(`  - ${key}`));\r\n  process.exit(1);\r\n}\r\n\r\nif (missingOptional.length > 0) {\r\n  console.warn('‚ö†Ô∏è Missing optional environment variables:');\r\n  missingOptional.forEach(key => console.warn(`  - ${key}`));\r\n}\r\n\r\n// –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT —Å–µ–∫—Ä–µ—Ç–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–ª–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç\r\nif ((required.includes('JWT_SECRET') || process.env.JWT_SECRET) && \r\n    process.env.JWT_SECRET && process.env.JWT_SECRET.length < 32) {\r\n  if (required.includes('JWT_SECRET')) {\r\n    console.error('‚ùå JWT_SECRET must be at least 32 characters long');\r\n    process.exit(1);\r\n  } else {\r\n    console.warn('‚ö†Ô∏è JWT_SECRET is less than 32 characters long. This is not secure for production.');\r\n  }\r\n}\r\n\r\n// –ü—Ä–æ–≤–µ—Ä–∫–∞ S3 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–ª–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç\r\nif ((required.includes('S3_BUCKET') || process.env.S3_BUCKET) && \r\n    process.env.S3_BUCKET && (!process.env.S3_ACCESS_KEY || !process.env.S3_SECRET_KEY)) {\r\n  if (required.includes('S3_BUCKET')) {\r\n    console.error('‚ùå S3_BUCKET requires S3_ACCESS_KEY and S3_SECRET_KEY');\r\n    process.exit(1);\r\n  } else {\r\n    console.warn('‚ö†Ô∏è S3_BUCKET requires S3_ACCESS_KEY and S3_SECRET_KEY. File storage may not work correctly.');\r\n  }\r\n}\r\n\r\nconsole.log(`‚úÖ All required environment variables for service ${SERVICE} are set`);\r\nconsole.log(`üìä ${required.length - missing.length}/${required.length} required variables configured`);\r\nconsole.log(`üìä ${optional.length - missingOptional.length}/${optional.length} optional variables configured`);\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ –∏–∑ –ø—É—Ç–∏\r\nfunction detectServiceFromPath() {\r\n  try {\r\n    const path = require('path');\r\n    const cwd = process.cwd();\r\n    const services = [\r\n      'gateway', 'auth', 'machines', 'inventory', 'tasks', 'telegram-bot', \r\n      'notifications', 'audit', 'data-import', 'backup', 'monitoring', \r\n      'routes', 'warehouse', 'recipes', 'bunkers'\r\n    ];\r\n    \r\n    const servicePath = cwd.split(path.sep).find(part => services.includes(part));\r\n    return servicePath;\r\n  } catch (error) {\r\n    return null;\r\n  }\r\n}\r\n",
  "scripts/start-production.js": "// Production starter for Railway deployment\nconst { spawn } = require('child_process');\nconst fs = require('fs');\nconst path = require('path');\n\nconsole.log('üöÄ Starting VHM24 in production mode on Railway...');\n\n// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è\ntry {\n  require('./check-env');\n} catch (error) {\n  console.error('‚ùå Environment check failed:', error.message);\n  process.exit(1);\n}\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–æ–π —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ Railway –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\nconst SERVICE = process.env.RAILWAY_SERVICE_NAME || \n               process.env.SERVICE_NAME || \n               detectServiceFromPath() ||\n               'gateway';\n\nconsole.log(`üéØ Detected service: ${SERVICE}`);\n\nconst serviceMap = {\n  'gateway': { path: 'services/gateway', port: 8000, public: true },\n  'auth': { path: 'services/auth', port: 3001, public: false },\n  'machines': { path: 'services/machines', port: 3002, public: false },\n  'inventory': { path: 'services/inventory', port: 3003, public: false },\n  'tasks': { path: 'services/tasks', port: 3004, public: false },\n  'telegram-bot': { path: 'services/telegram-bot', port: 3005, public: false },\n  'notifications': { path: 'services/notifications', port: 3006, public: false },\n  'audit': { path: 'services/audit', port: 3007, public: false },\n  'data-import': { path: 'services/data-import', port: 3008, public: false },\n  'backup': { path: 'services/backup', port: 3009, public: false },\n  'monitoring': { path: 'services/monitoring', port: 3010, public: false },\n  'routes': { path: 'services/routes', port: 3011, public: false },\n  'warehouse': { path: 'services/warehouse', port: 3012, public: false },\n  'recipes': { path: 'services/recipes', port: 3013, public: false },\n  'bunkers': { path: 'services/bunkers', port: 3014, public: false }\n};\n\nconst service = serviceMap[SERVICE];\n\nif (!service) {\n  console.error(`‚ùå Unknown service: ${SERVICE}`);\n  console.log('Available services:', Object.keys(serviceMap).join(', '));\n  process.exit(1);\n}\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞\nif (!fs.existsSync(service.path)) {\n  console.error(`‚ùå Service path not found: ${service.path}`);\n  process.exit(1);\n}\n\n// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PORT –¥–ª—è Railway\nprocess.env.PORT = process.env.PORT || service.port.toString();\n\nconsole.log(`üöÄ Starting ${SERVICE} service...`);\nconsole.log(`üìÅ Path: ${service.path}`);\nconsole.log(`üåê Port: ${process.env.PORT}`);\nconsole.log(`üîì Public: ${service.public ? 'Yes' : 'No'}`);\n\n// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞\nprocess.env.SERVICE_NAME = SERVICE;\nprocess.env.SERVICE_PATH = service.path;\n\n// –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å\nconst child = spawn('npm', ['start'], {\n  cwd: service.path,\n  stdio: 'inherit',\n  env: process.env\n});\n\nchild.on('error', (error) => {\n  console.error('‚ùå Failed to start service:', error);\n  process.exit(1);\n});\n\nchild.on('exit', (code) => {\n  console.log(`üõë Service ${SERVICE} exited with code ${code}`);\n  process.exit(code);\n});\n\n// Graceful shutdown\nprocess.on('SIGTERM', () => {\n  console.log('üõë Received SIGTERM, shutting down gracefully...');\n  child.kill('SIGTERM');\n});\n\nprocess.on('SIGINT', () => {\n  console.log('üõë Received SIGINT, shutting down gracefully...');\n  child.kill('SIGINT');\n});\n\nfunction detectServiceFromPath() {\n  // –ü—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–µ—Ä–≤–∏—Å –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø—É—Ç–∏ –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö Railway\n  const cwd = process.cwd();\n  const servicePath = cwd.split(path.sep).find(part => \n    Object.keys(serviceMap).includes(part)\n  );\n  \n  return servicePath || null;\n}",
  "scripts/test-after-fixes.js": "const { execSync } = require('child_process');\r\nconst fs = require('fs');\r\nconst fetch = require('node-fetch');\r\n\r\nasync function runTests() {\r\n  console.log('üß™ Running comprehensive tests after fixes...\\n');\r\n  \r\n  const testResults = {\r\n    unit: false,\r\n    integration: false,\r\n    security: false,\r\n    performance: false,\r\n    docker: false\r\n  };\r\n  \r\n  // 1. Unit tests\r\n  try {\r\n    console.log('Running unit tests...');\r\n    execSync('npm test', { stdio: 'inherit' });\r\n    testResults.unit = true;\r\n  } catch (e) {\r\n    console.error('Unit tests failed');\r\n  }\r\n  \r\n  // 2. Integration tests\r\n  try {\r\n    console.log('\\nRunning integration tests...');\r\n    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã\r\n    execSync('docker-compose up -d', { stdio: 'inherit' });\r\n    \r\n    // –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏\r\n    await new Promise(resolve => setTimeout(resolve, 10000));\r\n    \r\n    // –¢–µ—Å—Ç–∏—Ä—É–µ–º endpoints\r\n    const endpoints = [\r\n      'http://localhost:8000/health',\r\n      'http://localhost:3001/health',\r\n      'http://localhost:3002/health',\r\n      'http://localhost:3003/health',\r\n      'http://localhost:3004/health'\r\n    ];\r\n    \r\n    for (const endpoint of endpoints) {\r\n      const response = await fetch(endpoint);\r\n      if (!response.ok) throw new Error(`${endpoint} failed`);\r\n    }\r\n    \r\n    testResults.integration = true;\r\n  } catch (e) {\r\n    console.error('Integration tests failed:', e.message);\r\n  }\r\n  \r\n  // 3. Security tests\r\n  try {\r\n    console.log('\\nRunning security tests...');\r\n    execSync('npm audit', { stdio: 'inherit' });\r\n    testResults.security = true;\r\n  } catch (e) {\r\n    console.error('Security tests failed');\r\n  }\r\n  \r\n  // 4. Performance tests\r\n  try {\r\n    console.log('\\nRunning performance tests...');\r\n    // –ü—Ä–æ—Å—Ç–æ–π load test\r\n    execSync('npx autocannon -c 10 -d 5 http://localhost:8000/health', { stdio: 'inherit' });\r\n    testResults.performance = true;\r\n  } catch (e) {\r\n    console.error('Performance tests failed');\r\n  }\r\n  \r\n  // 5. Docker build test\r\n  try {\r\n    console.log('\\nTesting Docker builds...');\r\n    execSync('docker build -t vhm24-test -f services/gateway/Dockerfile .', { stdio: 'inherit' });\r\n    testResults.docker = true;\r\n  } catch (e) {\r\n    console.error('Docker build failed');\r\n  }\r\n  \r\n  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞\r\n  console.log('\\nüìä Test Results:');\r\n  Object.entries(testResults).forEach(([test, passed]) => {\r\n    console.log(`${passed ? '‚úÖ' : '‚ùå'} ${test}`);\r\n  });\r\n  \r\n  const allPassed = Object.values(testResults).every(v => v);\r\n  \r\n  if (allPassed) {\r\n    console.log('\\nüéâ All tests passed! Project is ready for deployment.');\r\n  } else {\r\n    console.log('\\n‚ö†Ô∏è Some tests failed. Please review and fix remaining issues.');\r\n  }\r\n  \r\n  // Cleanup\r\n  execSync('docker-compose down', { stdio: 'inherit' });\r\n}\r\n\r\nrunTests().catch(console.error);\r\n",
  "services/gateway/src/config.js": "// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è Railway\r\nmodule.exports = {\r\n  services: {\r\n    auth: {\r\n      url: process.env.AUTH_SERVICE_URL || 'http://127.0.0.1:3001',\r\n      prefix: '/api/v1/auth'\r\n    },\r\n    machines: {\r\n      url: process.env.MACHINES_SERVICE_URL || 'http://127.0.0.1:3002',\r\n      prefix: '/api/v1/machines'\r\n    },\r\n    inventory: {\r\n      url: process.env.INVENTORY_SERVICE_URL || 'http://127.0.0.1:3003',\r\n      prefix: '/api/v1/inventory'\r\n    },\r\n    tasks: {\r\n      url: process.env.TASKS_SERVICE_URL || 'http://127.0.0.1:3004',\r\n      prefix: '/api/v1/tasks'\r\n    },\r\n    routes: {\r\n      url: process.env.ROUTES_SERVICE_URL || 'http://127.0.0.1:3005',\r\n      prefix: '/api/v1/routes'\r\n    },\r\n    warehouse: {\r\n      url: process.env.WAREHOUSE_SERVICE_URL || 'http://127.0.0.1:3006',\r\n      prefix: '/api/v1/warehouse'\r\n    },\r\n    recipes: {\r\n      url: process.env.RECIPES_SERVICE_URL || 'http://127.0.0.1:3007',\r\n      prefix: '/api/v1/recipes'\r\n    },\r\n    bunkers: {\r\n      url: process.env.BUNKERS_SERVICE_URL || 'http://127.0.0.1:3008',\r\n      prefix: '/api/v1/bunkers'\r\n    },\r\n    notifications: {\r\n      url: process.env.NOTIFICATIONS_SERVICE_URL || 'http://127.0.0.1:3008',\r\n      prefix: '/api/v1/notifications'\r\n    },\r\n    monitoring: {\r\n      url: process.env.MONITORING_SERVICE_URL || 'http://127.0.0.1:3009',\r\n      prefix: '/api/v1/monitoring'\r\n    },\r\n    backup: {\r\n      url: 'http://127.0.0.1:3007',\r\n      prefix: '/api/v1/backup',\r\n      timeout: 30000\r\n    },\r\n    audit: {\r\n      url: 'http://127.0.0.1:3009',\r\n      prefix: '/api/v1/audit',\r\n      timeout: 10000\r\n    }\r\n  }\r\n};\r\n",
  "services/telegram-bot/src/fsm/manager.js": "/**\r\n * VHM24 Telegram Bot FSM Manager\r\n * –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Redis\r\n */\r\n\r\nconst { COMMON_STATES, ALL_STATES } = require('./states');\r\n\r\nclass FSMManager {\r\n  constructor() {\r\n    // –í production –∏—Å–ø–æ–ª—å–∑—É–µ–º Redis, –≤ development - Map\r\n    this.useRedis = process.env.NODE_ENV === 'production' && process.env.REDIS_URL;\r\n    \r\n    if (this.useRedis) {\r\n      // Redis –∫–ª–∏–µ–Ω—Ç –±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–æ–∑–∂–µ\r\n      this.redis = null;\r\n    } else {\r\n      // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è development\r\n      this.userStates = new Map();\r\n      this.userData = new Map();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Redis –∫–ª–∏–µ–Ω—Ç–∞\r\n   */\r\n  async initRedis() {\r\n    if (this.useRedis && !this.redis) {\r\n      try {\r\n        const Redis = require('ioredis');\r\n        this.redis = new Redis(process.env.REDIS_URL);\r\n        console.log('FSM Manager: Redis connected');\r\n      } catch (error) {\r\n        console.error('FSM Manager: Redis connection failed, falling back to memory:', error);\r\n        this.useRedis = false;\r\n        this.userStates = new Map();\r\n        this.userData = new Map();\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n   */\r\n  async getUserState(userId) {\r\n    try {\r\n      if (this.useRedis && this.redis) {\r\n        const state = await this.redis.get(`fsm:state:${userId}`);\r\n        return state || COMMON_STATES.IDLE;\r\n      } else {\r\n        return this.userStates.get(userId) || COMMON_STATES.IDLE;\r\n      }\r\n    } catch (error) {\r\n      console.error('FSM Manager: Error getting user state:', error);\r\n      return COMMON_STATES.IDLE;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n   */\r\n  async setUserState(userId, state) {\r\n    try {\r\n      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∞–ª–∏–¥–Ω–æ\r\n      if (!Object.values(ALL_STATES).includes(state)) {\r\n        throw new Error(`Invalid state: ${state}`);\r\n      }\r\n\r\n      if (this.useRedis && this.redis) {\r\n        await this.redis.setex(`fsm:state:${userId}`, 3600, state); // TTL 1 —á–∞—Å\r\n        console.log(`FSM: User ${userId} state set to ${state}`);\r\n      } else {\r\n        this.userStates.set(userId, state);\r\n        console.log(`FSM: User ${userId} state set to ${state}`);\r\n      }\r\n    } catch (error) {\r\n      console.error('FSM Manager: Error setting user state:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –û—á–∏—Å—Ç–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤–µ—Ä–Ω—É—Ç—å –≤ IDLE)\r\n   */\r\n  async clearUserState(userId) {\r\n    try {\r\n      if (this.useRedis && this.redis) {\r\n        await this.redis.del(`fsm:state:${userId}`);\r\n        await this.redis.del(`fsm:data:${userId}`);\r\n      } else {\r\n        this.userStates.delete(userId);\r\n        this.userData.delete(userId);\r\n      }\r\n      console.log(`FSM: User ${userId} state cleared`);\r\n    } catch (error) {\r\n      console.error('FSM Manager: Error clearing user state:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –ü–æ–ª—É—á–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n   */\r\n  async getUserData(userId) {\r\n    try {\r\n      if (this.useRedis && this.redis) {\r\n        const data = await this.redis.get(`fsm:data:${userId}`);\r\n        return data ? JSON.parse(data) : {};\r\n      } else {\r\n        return this.userData.get(userId) || {};\r\n      }\r\n    } catch (error) {\r\n      console.error('FSM Manager: Error getting user data:', error);\r\n      return {};\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n   */\r\n  async setUserData(userId, data) {\r\n    try {\r\n      if (this.useRedis && this.redis) {\r\n        await this.redis.setex(`fsm:data:${userId}`, 3600, JSON.stringify(data)); // TTL 1 —á–∞—Å\r\n      } else {\r\n        this.userData.set(userId, data);\r\n      }\r\n    } catch (error) {\r\n      console.error('FSM Manager: Error setting user data:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –û–±–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n   */\r\n  async updateUserData(userId, updates) {\r\n    try {\r\n      const currentData = await this.getUserData(userId);\r\n      const newData = { ...currentData, ...updates };\r\n      await this.setUserData(userId, newData);\r\n    } catch (error) {\r\n      console.error('FSM Manager: Error updating user data:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏\r\n   */\r\n  async isUserInState(userId, state) {\r\n    try {\r\n      const currentState = await this.getUserState(userId);\r\n      return currentState === state;\r\n    } catch (error) {\r\n      console.error('FSM Manager: Error checking user state:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –≥—Ä—É–ø–ø–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π\r\n   */\r\n  async isUserInStateGroup(userId, stateGroup) {\r\n    try {\r\n      const currentState = await this.getUserState(userId);\r\n      return stateGroup.includes(currentState);\r\n    } catch (error) {\r\n      console.error('FSM Manager: Error checking user state group:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏\r\n   */\r\n  async getUsersInState(state) {\r\n    try {\r\n      const users = [];\r\n      \r\n      if (this.useRedis && this.redis) {\r\n        const keys = await this.redis.keys('fsm:state:*');\r\n        for (const key of keys) {\r\n          const userState = await this.redis.get(key);\r\n          if (userState === state) {\r\n            const userId = key.replace('fsm:state:', '');\r\n            users.push(userId);\r\n          }\r\n        }\r\n      } else {\r\n        for (const [userId, userState] of this.userStates.entries()) {\r\n          if (userState === state) {\r\n            users.push(userId);\r\n          }\r\n        }\r\n      }\r\n      \r\n      return users;\r\n    } catch (error) {\r\n      console.error('FSM Manager: Error getting users in state:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–∞—É—Ç –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n   */\r\n  async setStateTimeout(userId, timeoutMs, fallbackState = COMMON_STATES.IDLE) {\r\n    try {\r\n      setTimeout(async () => {\r\n        const currentState = await this.getUserState(userId);\r\n        if (currentState !== COMMON_STATES.IDLE) {\r\n          console.log(`FSM: State timeout for user ${userId}, resetting to ${fallbackState}`);\r\n          await this.setUserState(userId, fallbackState);\r\n          await this.clearUserData(userId);\r\n        }\r\n      }, timeoutMs);\r\n    } catch (error) {\r\n      console.error('FSM Manager: Error setting state timeout:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\r\n   */\r\n  async clearUserData(userId) {\r\n    try {\r\n      if (this.useRedis && this.redis) {\r\n        await this.redis.del(`fsm:data:${userId}`);\r\n      } else {\r\n        this.userData.delete(userId);\r\n      }\r\n    } catch (error) {\r\n      console.error('FSM Manager: Error clearing user data:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏–π\r\n   */\r\n  async getStateStatistics() {\r\n    try {\r\n      const stats = {};\r\n      \r\n      if (this.useRedis && this.redis) {\r\n        const keys = await this.redis.keys('fsm:state:*');\r\n        for (const key of keys) {\r\n          const state = await this.redis.get(key);\r\n          stats[state] = (stats[state] || 0) + 1;\r\n        }\r\n      } else {\r\n        for (const state of this.userStates.values()) {\r\n          stats[state] = (stats[state] || 0) + 1;\r\n        }\r\n      }\r\n      \r\n      return stats;\r\n    } catch (error) {\r\n      console.error('FSM Manager: Error getting state statistics:', error);\r\n      return {};\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)\r\n   */\r\n  async clearAllStates() {\r\n    try {\r\n      if (this.useRedis && this.redis) {\r\n        const stateKeys = await this.redis.keys('fsm:state:*');\r\n        const dataKeys = await this.redis.keys('fsm:data:*');\r\n        const allKeys = [...stateKeys, ...dataKeys];\r\n        \r\n        if (allKeys.length > 0) {\r\n          await this.redis.del(...allKeys);\r\n        }\r\n      } else {\r\n        this.userStates.clear();\r\n        this.userData.clear();\r\n      }\r\n      console.log('FSM: All states cleared');\r\n    } catch (error) {\r\n      console.error('FSM Manager: Error clearing all states:', error);\r\n    }\r\n  }\r\n}\r\n\r\n// –°–æ–∑–¥–∞–µ–º –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä\r\nconst fsmManager = new FSMManager();\r\n\r\nmodule.exports = fsmManager;\r\n",
  "services/telegram-bot/src/handlers/uploadHandler.js": "const TelegramBot = require('node-telegram-bot-api');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\nconst os = require('os');\r\nconst s3Storage = require('../utils/s3Storage');\r\n\r\n/**\r\n * Upload Handler - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤\r\n * –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É —Ñ–æ—Ç–æ, –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ –¥—Ä—É–≥–∏—Ö —Ñ–∞–π–ª–æ–≤ –≤ DigitalOcean Spaces\r\n */\r\n\r\nclass UploadHandler {\r\n  constructor(bot) {\r\n    this.bot = bot;\r\n    this.tempDir = path.join(os.tmpdir(), 'vhm24-uploads');\r\n    \r\n    // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç\r\n    if (!fs.existsSync(this.tempDir)) {\r\n      fs.mkdirSync(this.tempDir, { recursive: true });\r\n    }\r\n\r\n    this.setupHandlers();\r\n  }\r\n\r\n  setupHandlers() {\r\n    // –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ\r\n    this.bot.onText(/\\/upload_photo/, (msg) => {\r\n      this.handleUploadPhotoCommand(msg);\r\n    });\r\n\r\n    // –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞\r\n    this.bot.onText(/\\/upload_document/, (msg) => {\r\n      this.handleUploadDocumentCommand(msg);\r\n    });\r\n\r\n    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ\r\n    this.bot.on('photo', (msg) => {\r\n      this.handlePhoto(msg);\r\n    });\r\n\r\n    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤\r\n    this.bot.on('document', (msg) => {\r\n      this.handleDocument(msg);\r\n    });\r\n\r\n    // –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤\r\n    this.bot.onText(/\\/my_uploads/, (msg) => {\r\n      this.handleMyUploads(msg);\r\n    });\r\n\r\n    // –ö–æ–º–∞–Ω–¥–∞ –ø–æ–º–æ—â–∏ –ø–æ –∑–∞–≥—Ä—É–∑–∫–µ\r\n    this.bot.onText(/\\/upload_help/, (msg) => {\r\n      this.handleUploadHelp(msg);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /upload_photo\r\n   */\r\n  async handleUploadPhotoCommand(msg) {\r\n    const chatId = msg.chat.id;\r\n    \r\n    const helpText = `üì∏ *–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –≤ –æ–±–ª–∞–∫–æ*\r\n\r\n–ü—Ä–æ—Å—Ç–æ –ø—Ä–∏—à–ª–∏—Ç–µ –º–Ω–µ —Ñ–æ—Ç–æ, –∏ —è –∑–∞–≥—Ä—É–∂—É –µ–≥–æ –≤ DigitalOcean Spaces!\r\n\r\n*–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:*\r\n‚Ä¢ JPG/JPEG\r\n‚Ä¢ PNG\r\n‚Ä¢ GIF\r\n‚Ä¢ WebP\r\n\r\n*–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:*\r\n1. –í—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç–µ —Ñ–æ—Ç–æ\r\n2. –Ø –∑–∞–≥—Ä—É–∂–∞—é –µ–≥–æ –≤ –æ–±–ª–∞–∫–æ\r\n3. –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –ø—É–±–ª–∏—á–Ω—É—é —Å—Å—ã–ª–∫—É\r\n\r\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å - –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ª—é–±–æ–µ —Ñ–æ—Ç–æ! üì∑`;\r\n\r\n    await this.bot.sendMessage(chatId, helpText, { parse_mode: 'Markdown' });\r\n  }\r\n\r\n  /**\r\n   * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /upload_document\r\n   */\r\n  async handleUploadDocumentCommand(msg) {\r\n    const chatId = msg.chat.id;\r\n    \r\n    const helpText = `üìÑ *–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –æ–±–ª–∞–∫–æ*\r\n\r\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ –¥–æ–∫—É–º–µ–Ω—Ç, –∏ —è –∑–∞–≥—Ä—É–∂—É –µ–≥–æ –≤ DigitalOcean Spaces!\r\n\r\n*–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:*\r\n‚Ä¢ PDF\r\n‚Ä¢ DOC/DOCX\r\n‚Ä¢ XLS/XLSX\r\n‚Ä¢ TXT\r\n‚Ä¢ CSV\r\n‚Ä¢ –ò –º–Ω–æ–≥–∏–µ –¥—Ä—É–≥–∏–µ\r\n\r\n*–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä:* 20 –ú–ë\r\n\r\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å - –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ª—é–±–æ–π –¥–æ–∫—É–º–µ–Ω—Ç! üìé`;\r\n\r\n    await this.bot.sendMessage(chatId, helpText, { parse_mode: 'Markdown' });\r\n  }\r\n\r\n  /**\r\n   * –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ\r\n   */\r\n  async handlePhoto(msg) {\r\n    const chatId = msg.chat.id;\r\n    const messageId = msg.message_id;\r\n\r\n    try {\r\n      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏\r\n      const statusMsg = await this.bot.sendMessage(chatId, 'üì∏ –ó–∞–≥—Ä—É–∂–∞—é —Ñ–æ—Ç–æ –≤ –æ–±–ª–∞–∫–æ...', {\r\n        reply_to_message_id: messageId\r\n      });\r\n\r\n      // –ü–æ–ª—É—á–∞–µ–º —Ñ–æ—Ç–æ –Ω–∞–∏–ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞\r\n      const photo = msg.photo[msg.photo.length - 1];\r\n      const fileId = photo.file_id;\r\n\r\n      // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ\r\n      const file = await this.bot.getFile(fileId);\r\n      const fileName = `photo_${Date.now()}.jpg`;\r\n      const tempFilePath = path.join(this.tempDir, fileName);\r\n\r\n      // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª\r\n      await this.bot.downloadFile(fileId, tempFilePath);\r\n\r\n      // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ DigitalOcean Spaces\r\n      const uploadedUrl = await s3Storage.uploadPhoto(tempFilePath, fileName);\r\n\r\n      // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ\r\n      const stats = fs.statSync(tempFilePath);\r\n      const fileSizeKB = Math.round(stats.size / 1024);\r\n\r\n      // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª\r\n      fs.unlinkSync(tempFilePath);\r\n\r\n      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º\r\n      const successText = `‚úÖ *–§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!*\r\n\r\nüìé *–°—Å—ã–ª–∫–∞:* [–û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ç–æ](${uploadedUrl})\r\nüìè *–†–∞–∑–º–µ—Ä:* ${fileSizeKB} –ö–ë\r\nüåê *CDN:* DigitalOcean Spaces\r\nüìÖ *–î–∞—Ç–∞:* ${new Date().toLocaleString('ru-RU')}\r\n\r\n_–°—Å—ã–ª–∫–∞ –ø—É–±–ª–∏—á–Ω–∞—è –∏ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ–≥–¥–∞_`;\r\n\r\n      await this.bot.editMessageText(successText, {\r\n        chat_id: chatId,\r\n        message_id: statusMsg.message_id,\r\n        parse_mode: 'Markdown',\r\n        disable_web_page_preview: false\r\n      });\r\n\r\n      // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É\r\n      console.log(`‚úÖ Photo uploaded by user ${msg.from.id}: ${uploadedUrl}`);\r\n\r\n    } catch (error) {\r\n      console.error('‚ùå Error uploading photo:', error);\r\n      \r\n      await this.bot.sendMessage(chatId, `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ: ${error.message}`, {\r\n        reply_to_message_id: messageId\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤\r\n   */\r\n  async handleDocument(msg) {\r\n    const chatId = msg.chat.id;\r\n    const messageId = msg.message_id;\r\n\r\n    try {\r\n      const document = msg.document;\r\n      const fileId = document.file_id;\r\n      const fileName = document.file_name || `document_${Date.now()}`;\r\n      const fileSize = document.file_size;\r\n\r\n      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å–∏–º—É–º 20 –ú–ë)\r\n      if (fileSize > 20 * 1024 * 1024) {\r\n        await this.bot.sendMessage(chatId, '‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 20 –ú–ë', {\r\n          reply_to_message_id: messageId\r\n        });\r\n        return;\r\n      }\r\n\r\n      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏\r\n      const statusMsg = await this.bot.sendMessage(chatId, `üìÑ –ó–∞–≥—Ä—É–∂–∞—é –¥–æ–∫—É–º–µ–Ω—Ç \"${fileName}\" –≤ –æ–±–ª–∞–∫–æ...`, {\r\n        reply_to_message_id: messageId\r\n      });\r\n\r\n      // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª\r\n      const tempFilePath = path.join(this.tempDir, fileName);\r\n      await this.bot.downloadFile(fileId, tempFilePath);\r\n\r\n      // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ DigitalOcean Spaces\r\n      const uploadedUrl = await s3Storage.uploadDocument(tempFilePath, fileName);\r\n\r\n      // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ\r\n      const fileSizeKB = Math.round(fileSize / 1024);\r\n      const fileSizeMB = (fileSize / (1024 * 1024)).toFixed(2);\r\n\r\n      // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª\r\n      fs.unlinkSync(tempFilePath);\r\n\r\n      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º\r\n      const successText = `‚úÖ *–î–æ–∫—É–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!*\r\n\r\nüìé *–°—Å—ã–ª–∫–∞:* [${fileName}](${uploadedUrl})\r\nüìè *–†–∞–∑–º–µ—Ä:* ${fileSizeMB} –ú–ë (${fileSizeKB} –ö–ë)\r\nüìÑ *–¢–∏–ø:* ${document.mime_type || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}\r\nüåê *CDN:* DigitalOcean Spaces\r\nüìÖ *–î–∞—Ç–∞:* ${new Date().toLocaleString('ru-RU')}\r\n\r\n_–°—Å—ã–ª–∫–∞ –ø—É–±–ª–∏—á–Ω–∞—è –∏ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ–≥–¥–∞_`;\r\n\r\n      await this.bot.editMessageText(successText, {\r\n        chat_id: chatId,\r\n        message_id: statusMsg.message_id,\r\n        parse_mode: 'Markdown',\r\n        disable_web_page_preview: false\r\n      });\r\n\r\n      // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É\r\n      console.log(`‚úÖ Document uploaded by user ${msg.from.id}: ${uploadedUrl}`);\r\n\r\n    } catch (error) {\r\n      console.error('‚ùå Error uploading document:', error);\r\n      \r\n      await this.bot.sendMessage(chatId, `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞: ${error.message}`, {\r\n        reply_to_message_id: messageId\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /my_uploads\r\n   */\r\n  async handleMyUploads(msg) {\r\n    const chatId = msg.chat.id;\r\n    \r\n    const infoText = `üìÅ *–ú–æ–∏ –∑–∞–≥—Ä—É–∑–∫–∏*\r\n\r\n–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø–æ–∫–∞ –Ω–µ—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤–∞—à–∏—Ö –∑–∞–≥—Ä—É–∑–æ–∫.\r\n\r\n*–ß—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:*\r\n‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –≤–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã\r\n‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∑–∞–∫–ª–∞–¥–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ\r\n‚Ä¢ –°–æ–∑–¥–∞–π—Ç–µ –∑–∞–º–µ—Ç–∫—É —Å —Å—Å—ã–ª–∫–∞–º–∏\r\n\r\n*–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å:*\r\n‚Ä¢ –ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∑–æ–∫\r\n‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞–º–∏\r\n‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ –∞–ª—å–±–æ–º–æ–≤\r\n‚Ä¢ –ü–æ–∏—Å–∫ –ø–æ —Ñ–∞–π–ª–∞–º\r\n\r\n–ü–æ–∫–∞ —á—Ç–æ –ø—Ä–æ—Å—Ç–æ –∑–∞–≥—Ä—É–∂–∞–π—Ç–µ —Ñ–∞–π–ª—ã - –≤—Å–µ —Å—Å—ã–ª–∫–∏ –ø—É–±–ª–∏—á–Ω—ã–µ –∏ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ! üöÄ`;\r\n\r\n    await this.bot.sendMessage(chatId, infoText, { parse_mode: 'Markdown' });\r\n  }\r\n\r\n  /**\r\n   * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /upload_help\r\n   */\r\n  async handleUploadHelp(msg) {\r\n    const chatId = msg.chat.id;\r\n    \r\n    const helpText = `üÜò *–ü–æ–º–æ—â—å –ø–æ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤*\r\n\r\n*üì∏ –§–æ—Ç–æ:*\r\n‚Ä¢ –ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ\r\n‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: JPG, PNG, GIF, WebP\r\n‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤ –æ–±–ª–∞–∫–æ\r\n\r\n*üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã:*\r\n‚Ä¢ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç\r\n‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 20 –ú–ë\r\n‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã\r\n\r\n*üåê –û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ:*\r\n‚Ä¢ DigitalOcean Spaces\r\n‚Ä¢ CDN –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏\r\n‚Ä¢ –ü—É–±–ª–∏—á–Ω—ã–µ —Å—Å—ã–ª–∫–∏\r\n‚Ä¢ –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ\r\n\r\n*üìã –ö–æ–º–∞–Ω–¥—ã:*\r\n/upload_photo - –ø–æ–º–æ—â—å –ø–æ —Ñ–æ—Ç–æ\r\n/upload_document - –ø–æ–º–æ—â—å –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º\r\n/my_uploads - –º–æ–∏ –∑–∞–≥—Ä—É–∑–∫–∏\r\n/upload_help - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\r\n\r\n*üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:*\r\n‚Ä¢ –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ (UUID)\r\n‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ MIME-—Ç–∏–ø–æ–≤\r\n‚Ä¢ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 1 –≥–æ–¥\r\n‚Ä¢ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π\r\n\r\n–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –∏ –ø–æ–ª—É—á–∏—Ç–µ —Å—Å—ã–ª–∫—É! üöÄ`;\r\n\r\n    await this.bot.sendMessage(chatId, helpText, { parse_mode: 'Markdown' });\r\n  }\r\n\r\n  /**\r\n   * –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤\r\n   */\r\n  cleanupTempFiles() {\r\n    try {\r\n      const files = fs.readdirSync(this.tempDir);\r\n      const now = Date.now();\r\n      \r\n      files.forEach(file => {\r\n        const filePath = path.join(this.tempDir, file);\r\n        const stats = fs.statSync(filePath);\r\n        \r\n        // –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ 1 —á–∞—Å–∞\r\n        if (now - stats.mtime.getTime() > 60 * 60 * 1000) {\r\n          fs.unlinkSync(filePath);\r\n          console.log(`üóëÔ∏è Cleaned up temp file: ${file}`);\r\n        }\r\n      });\r\n    } catch (error) {\r\n      console.error('‚ùå Error cleaning up temp files:', error);\r\n    }\r\n  }\r\n}\r\n\r\nmodule.exports = UploadHandler;\r\n",
  "services/telegram-bot/src/utils/qrGenerator.js": "// QR Code generation utilities\r\nimport QRCode from 'qrcode';\r\n\r\nexport async function generateMachineQR(machine) {\r\n  const qrData = {\r\n    type: 'vhm24_machine',\r\n    id: machine.id,\r\n    name: machine.name,\r\n    location: machine.location,\r\n    timestamp: new Date().toISOString()\r\n  };\r\n  \r\n  const qrString = JSON.stringify(qrData);\r\n  \r\n  // Generate QR code as buffer\r\n  const qrBuffer = await QRCode.toBuffer(qrString, {\r\n    errorCorrectionLevel: 'M',\r\n    type: 'png',\r\n    quality: 0.92,\r\n    margin: 1,\r\n    color: {\r\n      dark: '#000000',\r\n      light: '#FFFFFF'\r\n    },\r\n    width: 512\r\n  });\r\n  \r\n  return qrBuffer;\r\n}\r\n\r\nexport async function generateTaskQR(task) {\r\n  const qrData = {\r\n    type: 'vhm24_task',\r\n    id: task.id,\r\n    title: task.title,\r\n    machineId: task.machineId,\r\n    timestamp: new Date().toISOString()\r\n  };\r\n  \r\n  const qrString = JSON.stringify(qrData);\r\n  \r\n  const qrBuffer = await QRCode.toBuffer(qrString, {\r\n    errorCorrectionLevel: 'M',\r\n    type: 'png',\r\n    quality: 0.92,\r\n    margin: 1,\r\n    width: 512\r\n  });\r\n  \r\n  return qrBuffer;\r\n}\r\n\r\nexport async function generateInventoryQR(item) {\r\n  const qrData = {\r\n    type: 'vhm24_inventory',\r\n    id: item.id,\r\n    sku: item.sku,\r\n    name: item.name,\r\n    quantity: item.quantity,\r\n    timestamp: new Date().toISOString()\r\n  };\r\n  \r\n  const qrString = JSON.stringify(qrData);\r\n  \r\n  const qrBuffer = await QRCode.toBuffer(qrString, {\r\n    errorCorrectionLevel: 'M',\r\n    type: 'png',\r\n    quality: 0.92,\r\n    margin: 1,\r\n    width: 512\r\n  });\r\n  \r\n  return qrBuffer;\r\n}\r\n\r\nexport async function generateAuthQR(authToken, userId) {\r\n  const qrData = {\r\n    type: 'vhm24_auth',\r\n    token: authToken,\r\n    userId: userId,\r\n    timestamp: new Date().toISOString(),\r\n    expiresAt: new Date(Date.now() + 5 * 60 * 1000).toISOString() // 5 minutes\r\n  };\r\n  \r\n  const qrString = JSON.stringify(qrData);\r\n  \r\n  const qrBuffer = await QRCode.toBuffer(qrString, {\r\n    errorCorrectionLevel: 'H', // High error correction for auth\r\n    type: 'png',\r\n    quality: 0.92,\r\n    margin: 1,\r\n    width: 512\r\n  });\r\n  \r\n  return qrBuffer;\r\n}\r\n\r\nexport function parseQRData(qrString) {\r\n  try {\r\n    const data = JSON.parse(qrString);\r\n    \r\n    // Validate QR data structure\r\n    if (!data.type || !data.type.startsWith('vhm24_')) {\r\n      throw new Error('Invalid QR code format');\r\n    }\r\n    \r\n    if (!data.id && data.type !== 'vhm24_auth') {\r\n      throw new Error('Missing ID in QR data');\r\n    }\r\n    \r\n    if (!data.timestamp) {\r\n      throw new Error('Missing timestamp in QR data');\r\n    }\r\n    \r\n    // Check if QR code is expired (for auth QR codes)\r\n    if (data.type === 'vhm24_auth' && data.expiresAt) {\r\n      if (new Date(data.expiresAt) < new Date()) {\r\n        throw new Error('QR code has expired');\r\n      }\r\n    }\r\n    \r\n    return {\r\n      valid: true,\r\n      data: data\r\n    };\r\n  } catch (error) {\r\n    return {\r\n      valid: false,\r\n      error: error.message\r\n    };\r\n  }\r\n}\r\n\r\nexport async function generateCustomQR(data, options = {}) {\r\n  const defaultOptions = {\r\n    errorCorrectionLevel: 'M',\r\n    type: 'png',\r\n    quality: 0.92,\r\n    margin: 1,\r\n    color: {\r\n      dark: '#000000',\r\n      light: '#FFFFFF'\r\n    },\r\n    width: 512\r\n  };\r\n  \r\n  const qrOptions = { ...defaultOptions, ...options };\r\n  const qrString = typeof data === 'string' ? data : JSON.stringify(data);\r\n  \r\n  return await QRCode.toBuffer(qrString, qrOptions);\r\n}\r\n\r\nexport async function generateQRWithLogo(data, logoPath, options = {}) {\r\n  // This would require additional image processing libraries\r\n  // For now, return standard QR code\r\n  return await generateCustomQR(data, options);\r\n}\r\n",
  "services/telegram-bot/src/utils/qrScanner.js": "/**\r\n * VHM24 - QR Code Scanner Utility\r\n * –ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è QR-–∫–æ–¥–æ–≤ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π\r\n * \r\n * –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –≠—Ç–æ —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä–∞—è —ç–º—É–ª–∏—Ä—É–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ QR-–∫–æ–¥–æ–≤\r\n * –í —Ä–µ–∞–ª—å–Ω–æ–π —Å—Ä–µ–¥–µ —Å–ª–µ–¥—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å canvas, jsqr –∏ sharp –¥–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è\r\n */\r\n\r\nconst fs = require('fs');\r\nconst path = require('path');\r\nconst logger = {\r\n  info: (message, ...args) => console.log(`[INFO] ${message}`, ...args),\r\n  warn: (message, ...args) => console.warn(`[WARN] ${message}`, ...args),\r\n  error: (message, ...args) => console.error(`[ERROR] ${message}`, ...args)\r\n};\r\n\r\n/**\r\n * –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞ –∏–∑ —Ñ–∞–π–ª–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è\r\n * @param {string} filePath - –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è\r\n * @returns {Promise<Object|null>} - –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ null\r\n */\r\nasync function scanQRCodeFromFile(filePath) {\r\n  try {\r\n    logger.info(`Scanning QR code from file: ${filePath}`);\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞\r\n    if (!fs.existsSync(filePath)) {\r\n      logger.error(`File not found: ${filePath}`);\r\n      return null;\r\n    }\r\n    \r\n    // –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–¥–µ—Å—å –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞\r\n    // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —ç–º—É–ª–∏—Ä—É–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ, –∏–∑–≤–ª–µ–∫–∞—è –¥–∞–Ω–Ω—ã–µ –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞\r\n    \r\n    // –ï—Å–ª–∏ —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç \"test-item-qr\" –≤ –∏–º–µ–Ω–∏, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —ç—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π QR-–∫–æ–¥ —Ç–æ–≤–∞—Ä–∞\r\n    if (filePath.includes('test-item-qr')) {\r\n      logger.info('Detected test item QR code');\r\n      \r\n      // –≠–º—É–ª–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ QR-–∫–æ–¥–∞\r\n      return {\r\n        type: 'vhm24_inventory',\r\n        id: '12345',\r\n        name: '–¢–µ—Å—Ç–æ–≤—ã–π —Ç–æ–≤–∞—Ä',\r\n        sku: 'TEST-001',\r\n        timestamp: new Date().toISOString()\r\n      };\r\n    }\r\n    \r\n    // –ï—Å–ª–∏ —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç \"machine-qr\" –≤ –∏–º–µ–Ω–∏, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —ç—Ç–æ QR-–∫–æ–¥ –º–∞—à–∏–Ω—ã\r\n    if (filePath.includes('machine-qr')) {\r\n      logger.info('Detected machine QR code');\r\n      \r\n      // –≠–º—É–ª–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ QR-–∫–æ–¥–∞\r\n      return {\r\n        type: 'vhm24_machine',\r\n        id: '67890',\r\n        name: '–¢–µ—Å—Ç–æ–≤–∞—è –º–∞—à–∏–Ω–∞',\r\n        location: '–¢–µ—Å—Ç–æ–≤–∞—è –ª–æ–∫–∞—Ü–∏—è',\r\n        timestamp: new Date().toISOString()\r\n      };\r\n    }\r\n    \r\n    // –ï—Å–ª–∏ —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç \"task-qr\" –≤ –∏–º–µ–Ω–∏, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —ç—Ç–æ QR-–∫–æ–¥ –∑–∞–¥–∞—á–∏\r\n    if (filePath.includes('task-qr')) {\r\n      logger.info('Detected task QR code');\r\n      \r\n      // –≠–º—É–ª–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ QR-–∫–æ–¥–∞\r\n      return {\r\n        type: 'vhm24_task',\r\n        id: '54321',\r\n        title: '–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–¥–∞—á–∞',\r\n        status: 'CREATED',\r\n        timestamp: new Date().toISOString()\r\n      };\r\n    }\r\n    \r\n    // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø QR-–∫–æ–¥–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null\r\n    logger.warn('No QR code found in image');\r\n    return null;\r\n  } catch (error) {\r\n    logger.error('Error scanning QR code:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞ –∏–∑ –±—É—Ñ–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è\r\n * @param {Buffer} imageBuffer - –ë—É—Ñ–µ—Ä —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è\r\n * @returns {Promise<Object|null>} - –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ null\r\n */\r\nasync function scanQRCodeFromBuffer(imageBuffer) {\r\n  try {\r\n    logger.info('Scanning QR code from buffer');\r\n    \r\n    // –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–¥–µ—Å—å –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞ –∏–∑ –±—É—Ñ–µ—Ä–∞\r\n    // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —ç–º—É–ª–∏—Ä—É–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ, –≤–æ–∑–≤—Ä–∞—â–∞—è —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ\r\n    \r\n    // –≠–º—É–ª–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ QR-–∫–æ–¥–∞\r\n    return {\r\n      type: 'vhm24_inventory',\r\n      id: '12345',\r\n      name: '–¢–µ—Å—Ç–æ–≤—ã–π —Ç–æ–≤–∞—Ä',\r\n      sku: 'TEST-001',\r\n      timestamp: new Date().toISOString()\r\n    };\r\n  } catch (error) {\r\n    logger.error('Error scanning QR code from buffer:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ QR-–∫–æ–¥–∞\r\n * @param {Object} data - –î–∞–Ω–Ω—ã–µ –∏–∑ QR-–∫–æ–¥–∞\r\n * @returns {Object} - –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Ç–∏–ø–æ–º\r\n */\r\nfunction parseQRData(data) {\r\n  try {\r\n    // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —É–∂–µ —è–≤–ª—è—é—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º\r\n    if (typeof data === 'object' && data !== null) {\r\n      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–∏–ø\r\n      if (data.type && data.type.startsWith('vhm24_')) {\r\n        return {\r\n          success: true,\r\n          type: data.type.replace('vhm24_', ''),\r\n          data\r\n        };\r\n      }\r\n      \r\n      // –ï—Å–ª–∏ –Ω–µ—Ç —Ç–∏–ø–∞, –Ω–æ –µ—Å—Ç—å id, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —ç—Ç–æ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å\r\n      if (data.id) {\r\n        return {\r\n          success: true,\r\n          type: 'inventory',\r\n          data: {\r\n            ...data,\r\n            type: 'vhm24_inventory'\r\n          }\r\n        };\r\n      }\r\n      \r\n      // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ rawData, –ø—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø\r\n      if (data.rawData) {\r\n        if (data.rawData.includes('machine')) {\r\n          return {\r\n            success: true,\r\n            type: 'machine',\r\n            data: {\r\n              type: 'vhm24_machine',\r\n              id: data.rawData.replace(/\\D/g, ''),\r\n              rawData: data.rawData\r\n            }\r\n          };\r\n        }\r\n        \r\n        if (data.rawData.includes('task')) {\r\n          return {\r\n            success: true,\r\n            type: 'task',\r\n            data: {\r\n              type: 'vhm24_task',\r\n              id: data.rawData.replace(/\\D/g, ''),\r\n              rawData: data.rawData\r\n            }\r\n          };\r\n        }\r\n        \r\n        if (data.rawData.includes('inventory') || data.rawData.includes('item')) {\r\n          return {\r\n            success: true,\r\n            type: 'inventory',\r\n            data: {\r\n              type: 'vhm24_inventory',\r\n              id: data.rawData.replace(/\\D/g, ''),\r\n              rawData: data.rawData\r\n            }\r\n          };\r\n        }\r\n        \r\n        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å\r\n        return {\r\n          success: true,\r\n          type: 'unknown',\r\n          data: {\r\n            type: 'vhm24_unknown',\r\n            rawData: data.rawData\r\n          }\r\n        };\r\n      }\r\n    }\r\n    \r\n    // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ - —Å—Ç—Ä–æ–∫–∞, –ø—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ JSON\r\n    if (typeof data === 'string') {\r\n      try {\r\n        return parseQRData(JSON.parse(data));\r\n      } catch (e) {\r\n        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ JSON, –ø—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø\r\n        if (data.includes('machine')) {\r\n          return {\r\n            success: true,\r\n            type: 'machine',\r\n            data: {\r\n              type: 'vhm24_machine',\r\n              id: data.replace(/\\D/g, ''),\r\n              rawData: data\r\n            }\r\n          };\r\n        }\r\n        \r\n        if (data.includes('task')) {\r\n          return {\r\n            success: true,\r\n            type: 'task',\r\n            data: {\r\n              type: 'vhm24_task',\r\n              id: data.replace(/\\D/g, ''),\r\n              rawData: data\r\n            }\r\n          };\r\n        }\r\n        \r\n        if (data.includes('inventory') || data.includes('item')) {\r\n          return {\r\n            success: true,\r\n            type: 'inventory',\r\n            data: {\r\n              type: 'vhm24_inventory',\r\n              id: data.replace(/\\D/g, ''),\r\n              rawData: data\r\n            }\r\n          };\r\n        }\r\n        \r\n        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å\r\n        return {\r\n          success: true,\r\n          type: 'unknown',\r\n          data: {\r\n            type: 'vhm24_unknown',\r\n            rawData: data\r\n          }\r\n        };\r\n      }\r\n    }\r\n    \r\n    // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞–Ω–Ω—ã–µ\r\n    return {\r\n      success: false,\r\n      type: 'error',\r\n      error: 'Invalid QR data format'\r\n    };\r\n  } catch (error) {\r\n    logger.error('Error parsing QR data:', error);\r\n    return {\r\n      success: false,\r\n      type: 'error',\r\n      error: error.message\r\n    };\r\n  }\r\n}\r\n\r\nmodule.exports = {\r\n  scanQRCodeFromFile,\r\n  scanQRCodeFromBuffer,\r\n  parseQRData\r\n};\r\n",
  "services/telegram-bot/src/utils/reportGenerator.js": "// Report generation utilities\r\nimport ExcelJS from 'exceljs';\r\nimport PDFDocument from 'pdfkit';\r\nimport { formatDate, formatCurrency, formatNumber } from './formatters.js';\r\n\r\nexport async function generateReportFile(reportType, format) {\r\n  switch (format) {\r\n    case 'excel':\r\n      return await generateExcelReport(reportType);\r\n    case 'pdf':\r\n      return await generatePDFReport(reportType);\r\n    case 'csv':\r\n      return await generateCSVReport(reportType);\r\n    case 'json':\r\n      return await generateJSONReport(reportType);\r\n    default:\r\n      throw new Error(`Unsupported format: ${format}`);\r\n  }\r\n}\r\n\r\nasync function generateExcelReport(reportType) {\r\n  const workbook = new ExcelJS.Workbook();\r\n  workbook.creator = 'VHM24 Bot';\r\n  workbook.created = new Date();\r\n  \r\n  switch (reportType) {\r\n    case 'sales':\r\n      await createSalesExcelReport(workbook);\r\n      break;\r\n    case 'inventory':\r\n      await createInventoryExcelReport(workbook);\r\n      break;\r\n    case 'machines':\r\n      await createMachinesExcelReport(workbook);\r\n      break;\r\n    case 'tasks':\r\n      await createTasksExcelReport(workbook);\r\n      break;\r\n    default:\r\n      throw new Error(`Unknown report type: ${reportType}`);\r\n  }\r\n  \r\n  const buffer = await workbook.xlsx.writeBuffer();\r\n  return buffer;\r\n}\r\n\r\nasync function createSalesExcelReport(workbook) {\r\n  const sheet = workbook.addWorksheet('Sales Report');\r\n  \r\n  // Add headers\r\n  sheet.columns = [\r\n    { header: 'Date', key: 'date', width: 15 },\r\n    { header: 'Machine', key: 'machine', width: 20 },\r\n    { header: 'Product', key: 'product', width: 25 },\r\n    { header: 'Quantity', key: 'quantity', width: 10 },\r\n    { header: 'Unit Price', key: 'unitPrice', width: 12 },\r\n    { header: 'Total', key: 'total', width: 12 },\r\n    { header: 'Payment Method', key: 'paymentMethod', width: 15 }\r\n  ];\r\n  \r\n  // Style headers\r\n  sheet.getRow(1).font = { bold: true };\r\n  sheet.getRow(1).fill = {\r\n    type: 'pattern',\r\n    pattern: 'solid',\r\n    fgColor: { argb: 'FF4472C4' }\r\n  };\r\n  \r\n  // Fetch sales data\r\n  try {\r\n    const response = await global.apiClient.get('/reports/sales/details');\r\n    const sales = response.data.data || [];\r\n    \r\n    // Add data rows\r\n    sales.forEach(sale => {\r\n      sheet.addRow({\r\n        date: formatDate(sale.date, 'DD.MM.YYYY HH:mm'),\r\n        machine: sale.machine?.name || 'Unknown',\r\n        product: sale.product?.name || 'Unknown',\r\n        quantity: sale.quantity,\r\n        unitPrice: sale.unitPrice,\r\n        total: sale.total,\r\n        paymentMethod: sale.paymentMethod\r\n      });\r\n    });\r\n    \r\n    // Add summary row\r\n    const lastRow = sheet.lastRow.number + 2;\r\n    sheet.getCell(`A${lastRow}`).value = 'TOTAL';\r\n    sheet.getCell(`A${lastRow}`).font = { bold: true };\r\n    sheet.getCell(`D${lastRow}`).value = { formula: `SUM(D2:D${lastRow - 2})` };\r\n    sheet.getCell(`F${lastRow}`).value = { formula: `SUM(F2:F${lastRow - 2})` };\r\n    \r\n    // Format currency columns\r\n    ['E', 'F'].forEach(col => {\r\n      for (let i = 2; i <= lastRow; i++) {\r\n        sheet.getCell(`${col}${i}`).numFmt = '$#,##0.00';\r\n      }\r\n    });\r\n  } catch (error) {\r\n    sheet.addRow({ date: 'Error loading data', machine: error.message });\r\n  }\r\n  \r\n  // Auto-filter\r\n  sheet.autoFilter = 'A1:G1';\r\n}\r\n\r\nasync function createInventoryExcelReport(workbook) {\r\n  const sheet = workbook.addWorksheet('Inventory Report');\r\n  \r\n  // Add headers\r\n  sheet.columns = [\r\n    { header: 'SKU', key: 'sku', width: 15 },\r\n    { header: 'Name', key: 'name', width: 30 },\r\n    { header: 'Category', key: 'category', width: 20 },\r\n    { header: 'Current Stock', key: 'quantity', width: 12 },\r\n    { header: 'Min Stock', key: 'minQuantity', width: 12 },\r\n    { header: 'Unit', key: 'unit', width: 10 },\r\n    { header: 'Unit Price', key: 'price', width: 12 },\r\n    { header: 'Total Value', key: 'totalValue', width: 15 },\r\n    { header: 'Status', key: 'status', width: 15 }\r\n  ];\r\n  \r\n  // Style headers\r\n  sheet.getRow(1).font = { bold: true };\r\n  sheet.getRow(1).fill = {\r\n    type: 'pattern',\r\n    pattern: 'solid',\r\n    fgColor: { argb: 'FF70AD47' }\r\n  };\r\n  \r\n  // Fetch inventory data\r\n  try {\r\n    const response = await global.apiClient.get('/inventory', { params: { limit: 1000 } });\r\n    const items = response.data.data || [];\r\n    \r\n    // Add data rows\r\n    items.forEach(item => {\r\n      const status = item.quantity <= item.minQuantity ? 'Low Stock' : 'OK';\r\n      const row = sheet.addRow({\r\n        sku: item.sku,\r\n        name: item.name,\r\n        category: item.category || 'Uncategorized',\r\n        quantity: item.quantity,\r\n        minQuantity: item.minQuantity || 0,\r\n        unit: item.unit || 'pcs',\r\n        price: item.price || 0,\r\n        totalValue: (item.quantity * (item.price || 0)),\r\n        status: status\r\n      });\r\n      \r\n      // Conditional formatting for low stock\r\n      if (status === 'Low Stock') {\r\n        row.getCell('status').font = { color: { argb: 'FFFF0000' } };\r\n      }\r\n    });\r\n    \r\n    // Format currency columns\r\n    ['G', 'H'].forEach(col => {\r\n      for (let i = 2; i <= sheet.lastRow.number; i++) {\r\n        sheet.getCell(`${col}${i}`).numFmt = '$#,##0.00';\r\n      }\r\n    });\r\n  } catch (error) {\r\n    sheet.addRow({ sku: 'Error', name: error.message });\r\n  }\r\n  \r\n  // Auto-filter\r\n  sheet.autoFilter = 'A1:I1';\r\n}\r\n\r\nasync function createMachinesExcelReport(workbook) {\r\n  const sheet = workbook.addWorksheet('Machines Report');\r\n  \r\n  // Add headers\r\n  sheet.columns = [\r\n    { header: 'Machine ID', key: 'id', width: 20 },\r\n    { header: 'Name', key: 'name', width: 25 },\r\n    { header: 'Location', key: 'location', width: 30 },\r\n    { header: 'Model', key: 'model', width: 20 },\r\n    { header: 'Status', key: 'status', width: 15 },\r\n    { header: 'Last Service', key: 'lastService', width: 15 },\r\n    { header: 'Next Service', key: 'nextService', width: 15 },\r\n    { header: 'Total Sales', key: 'totalSales', width: 12 },\r\n    { header: 'Revenue', key: 'revenue', width: 15 }\r\n  ];\r\n  \r\n  // Style headers\r\n  sheet.getRow(1).font = { bold: true };\r\n  sheet.getRow(1).fill = {\r\n    type: 'pattern',\r\n    pattern: 'solid',\r\n    fgColor: { argb: 'FFFFC000' }\r\n  };\r\n  \r\n  // Fetch machines data\r\n  try {\r\n    const response = await global.apiClient.get('/machines', { params: { limit: 1000 } });\r\n    const machines = response.data.data || [];\r\n    \r\n    // Add data rows\r\n    machines.forEach(machine => {\r\n      const row = sheet.addRow({\r\n        id: machine.id,\r\n        name: machine.name,\r\n        location: machine.location || 'Not specified',\r\n        model: machine.model || 'Unknown',\r\n        status: machine.status,\r\n        lastService: machine.lastServiceDate ? formatDate(machine.lastServiceDate, 'DD.MM.YYYY') : 'N/A',\r\n        nextService: machine.nextServiceDate ? formatDate(machine.nextServiceDate, 'DD.MM.YYYY') : 'N/A',\r\n        totalSales: machine.stats?.totalSales || 0,\r\n        revenue: machine.stats?.revenue || 0\r\n      });\r\n      \r\n      // Conditional formatting for status\r\n      const statusCell = row.getCell('status');\r\n      switch (machine.status) {\r\n        case 'active':\r\n          statusCell.font = { color: { argb: 'FF008000' } };\r\n          break;\r\n        case 'maintenance':\r\n          statusCell.font = { color: { argb: 'FFFF8C00' } };\r\n          break;\r\n        case 'error':\r\n        case 'offline':\r\n          statusCell.font = { color: { argb: 'FFFF0000' } };\r\n          break;\r\n      }\r\n    });\r\n    \r\n    // Format currency column\r\n    for (let i = 2; i <= sheet.lastRow.number; i++) {\r\n      sheet.getCell(`I${i}`).numFmt = '$#,##0.00';\r\n    }\r\n  } catch (error) {\r\n    sheet.addRow({ id: 'Error', name: error.message });\r\n  }\r\n  \r\n  // Auto-filter\r\n  sheet.autoFilter = 'A1:I1';\r\n}\r\n\r\nasync function createTasksExcelReport(workbook) {\r\n  const sheet = workbook.addWorksheet('Tasks Report');\r\n  \r\n  // Add headers\r\n  sheet.columns = [\r\n    { header: 'Task ID', key: 'id', width: 20 },\r\n    { header: 'Title', key: 'title', width: 30 },\r\n    { header: 'Type', key: 'type', width: 15 },\r\n    { header: 'Priority', key: 'priority', width: 12 },\r\n    { header: 'Status', key: 'status', width: 15 },\r\n    { header: 'Assigned To', key: 'assignedTo', width: 20 },\r\n    { header: 'Machine', key: 'machine', width: 20 },\r\n    { header: 'Created', key: 'created', width: 15 },\r\n    { header: 'Due Date', key: 'dueDate', width: 15 },\r\n    { header: 'Completed', key: 'completed', width: 15 }\r\n  ];\r\n  \r\n  // Style headers\r\n  sheet.getRow(1).font = { bold: true };\r\n  sheet.getRow(1).fill = {\r\n    type: 'pattern',\r\n    pattern: 'solid',\r\n    fgColor: { argb: 'FF8B4789' }\r\n  };\r\n  \r\n  // Fetch tasks data\r\n  try {\r\n    const response = await global.apiClient.get('/tasks', { params: { limit: 1000 } });\r\n    const tasks = response.data.data || [];\r\n    \r\n    // Add data rows\r\n    tasks.forEach(task => {\r\n      const row = sheet.addRow({\r\n        id: task.id,\r\n        title: task.title,\r\n        type: task.type || 'general',\r\n        priority: task.priority || 'normal',\r\n        status: task.status,\r\n        assignedTo: task.assignedTo?.name || 'Unassigned',\r\n        machine: task.machine?.name || 'N/A',\r\n        created: formatDate(task.createdAt, 'DD.MM.YYYY'),\r\n        dueDate: task.dueDate ? formatDate(task.dueDate, 'DD.MM.YYYY') : 'N/A',\r\n        completed: task.completedAt ? formatDate(task.completedAt, 'DD.MM.YYYY') : 'N/A'\r\n      });\r\n      \r\n      // Conditional formatting\r\n      const priorityCell = row.getCell('priority');\r\n      switch (task.priority) {\r\n        case 'urgent':\r\n          priorityCell.font = { color: { argb: 'FFFF0000' }, bold: true };\r\n          break;\r\n        case 'high':\r\n          priorityCell.font = { color: { argb: 'FFFF8C00' } };\r\n          break;\r\n      }\r\n      \r\n      const statusCell = row.getCell('status');\r\n      switch (task.status) {\r\n        case 'completed':\r\n          statusCell.font = { color: { argb: 'FF008000' } };\r\n          break;\r\n        case 'in_progress':\r\n          statusCell.font = { color: { argb: 'FF0000FF' } };\r\n          break;\r\n        case 'cancelled':\r\n          statusCell.font = { color: { argb: 'FF808080' } };\r\n          break;\r\n      }\r\n    });\r\n  } catch (error) {\r\n    sheet.addRow({ id: 'Error', title: error.message });\r\n  }\r\n  \r\n  // Auto-filter\r\n  sheet.autoFilter = 'A1:J1';\r\n}\r\n\r\nasync function generatePDFReport(reportType) {\r\n  // Create a new PDF document\r\n  const doc = new PDFDocument();\r\n  const chunks = [];\r\n  \r\n  doc.on('data', chunk => chunks.push(chunk));\r\n  \r\n  // Add content based on report type\r\n  doc.fontSize(20).text(`VHM24 ${reportType.charAt(0).toUpperCase() + reportType.slice(1)} Report`, 50, 50);\r\n  doc.fontSize(12).text(`Generated: ${formatDate(new Date())}`, 50, 80);\r\n  \r\n  // Add placeholder content\r\n  doc.moveDown();\r\n  doc.fontSize(10).text('This is a placeholder PDF report. Full implementation pending.', 50, 120);\r\n  \r\n  doc.end();\r\n  \r\n  return new Promise((resolve) => {\r\n    doc.on('end', () => {\r\n      resolve(Buffer.concat(chunks));\r\n    });\r\n  });\r\n}\r\n\r\nasync function generateCSVReport(reportType) {\r\n  // Placeholder CSV generation\r\n  let csv = '';\r\n  \r\n  switch (reportType) {\r\n    case 'sales':\r\n      csv = 'Date,Machine,Product,Quantity,Total\\n';\r\n      csv += '2024-01-01,Machine 1,Product A,5,50.00\\n';\r\n      break;\r\n    case 'inventory':\r\n      csv = 'SKU,Name,Quantity,Price\\n';\r\n      csv += 'PROD001,Product A,100,10.00\\n';\r\n      break;\r\n    default:\r\n      csv = 'No data available\\n';\r\n  }\r\n  \r\n  return Buffer.from(csv, 'utf-8');\r\n}\r\n\r\nasync function generateJSONReport(reportType) {\r\n  try {\r\n    const response = await global.apiClient.get(`/reports/${reportType}`);\r\n    return Buffer.from(JSON.stringify(response.data, null, 2), 'utf-8');\r\n  } catch (error) {\r\n    return Buffer.from(JSON.stringify({ error: error.message }, null, 2), 'utf-8');\r\n  }\r\n}\r\n",
  "start-audit-service.js": "#!/usr/bin/env node\r\n\r\nconst { spawn } = require('child_process');\r\nconst path = require('path');\r\n\r\nconsole.log('üîç –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ –∞—É–¥–∏—Ç–∞ VHM24...\\n');\r\n\r\n// –ü—É—Ç—å –∫ —Å–µ—Ä–≤–∏—Å—É –∞—É–¥–∏—Ç–∞\r\nconst auditServicePath = path.join(__dirname, 'services', 'audit');\r\n\r\n// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –µ—Å–ª–∏ –Ω—É–∂–Ω–æ\r\nconsole.log('üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —Å–µ—Ä–≤–∏—Å–∞ –∞—É–¥–∏—Ç–∞...');\r\nconst installProcess = spawn('npm', ['install'], {\r\n  cwd: auditServicePath,\r\n  stdio: 'inherit',\r\n  shell: true\r\n});\r\n\r\ninstallProcess.on('close', (code) => {\r\n  if (code !== 0) {\r\n    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —Å–µ—Ä–≤–∏—Å–∞ –∞—É–¥–∏—Ç–∞');\r\n    process.exit(1);\r\n  }\r\n\r\n  console.log('‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');\r\n  console.log('üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ –∞—É–¥–∏—Ç–∞...\\n');\r\n\r\n  // –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ –∞—É–¥–∏—Ç–∞\r\n  const auditProcess = spawn('npm', ['start'], {\r\n    cwd: auditServicePath,\r\n    stdio: 'inherit',\r\n    shell: true,\r\n    env: {\r\n      ...process.env,\r\n      AUDIT_SERVICE_PORT: process.env.AUDIT_SERVICE_PORT || '3009',\r\n      AUDIT_SERVICE_URL: process.env.AUDIT_SERVICE_URL || 'http://localhost:3009',\r\n      AUDIT_RETENTION_DAYS: process.env.AUDIT_RETENTION_DAYS || '90',\r\n      NODE_ENV: process.env.NODE_ENV || 'development'\r\n    }\r\n  });\r\n\r\n  auditProcess.on('close', (code) => {\r\n    console.log(`\\nüîç –°–µ—Ä–≤–∏—Å –∞—É–¥–∏—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω —Å –∫–æ–¥–æ–º ${code}`);\r\n  });\r\n\r\n  auditProcess.on('error', (error) => {\r\n    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ –∞—É–¥–∏—Ç–∞:', error);\r\n  });\r\n\r\n  // Graceful shutdown\r\n  process.on('SIGINT', () => {\r\n    console.log('\\nüõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ –∞—É–¥–∏—Ç–∞...');\r\n    auditProcess.kill('SIGINT');\r\n  });\r\n\r\n  process.on('SIGTERM', () => {\r\n    console.log('\\nüõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ –∞—É–¥–∏—Ç–∞...');\r\n    auditProcess.kill('SIGTERM');\r\n  });\r\n});\r\n\r\ninstallProcess.on('error', (error) => {\r\n  console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:', error);\r\n  process.exit(1);\r\n});\r\n",
  "start.js": "/**\r\n * VHM24 Platform - Unified Start Script\r\n * Handles both development and production (Railway) environments\r\n */\r\n\r\n// Load environment variables only in local development\r\nif (!process.env.RAILWAY_ENVIRONMENT) {\r\n  require('dotenv').config();\r\n}\r\n\r\nconst { spawn } = require('child_process');\r\nconst path = require('path');\r\n\r\nconsole.log('üöÄ VHM24 Platform starting...');\r\nconsole.log('Environment:', process.env.RAILWAY_ENVIRONMENT || 'development');\r\nconsole.log('Mode:', process.env.RAILWAY_ENVIRONMENT ? 'Single Process (Railway)' : 'Multi Process (Development)');\r\nconsole.log('Port:', process.env.PORT || 8000);\r\n\r\n// Check critical environment variables\r\nconst requiredEnvVars = ['DATABASE_URL', 'JWT_SECRET'];\r\nconst missingVars = requiredEnvVars.filter(v => !process.env[v]);\r\n\r\nif (missingVars.length > 0) {\r\n  console.error('‚ùå Missing required environment variables:', missingVars.join(', '));\r\n  console.error('Please set them in your .env file or Railway dashboard');\r\n  \r\n  // Start Gateway in limited mode (no database)\r\n  console.log('‚ö†Ô∏è  Starting in limited mode (Gateway only, no database)...');\r\n}\r\n\r\n// Services configuration\r\nconst services = [\r\n  {\r\n    name: 'Auth',\r\n    path: './services/auth/src/index.js',\r\n    port: process.env.AUTH_PORT || 3001,\r\n    env: { PORT: process.env.AUTH_PORT || 3001 }\r\n  },\r\n  {\r\n    name: 'Machines',\r\n    path: './services/machines/src/index.js',\r\n    port: process.env.MACHINES_PORT || 3002,\r\n    env: { PORT: process.env.MACHINES_PORT || 3002 }\r\n  },\r\n  {\r\n    name: 'Inventory',\r\n    path: './services/inventory/src/index.js',\r\n    port: process.env.INVENTORY_PORT || 3003,\r\n    env: { PORT: process.env.INVENTORY_PORT || 3003 }\r\n  },\r\n  {\r\n    name: 'Tasks',\r\n    path: './services/tasks/src/index.js',\r\n    port: process.env.TASKS_PORT || 3004,\r\n    env: { PORT: process.env.TASKS_PORT || 3004 }\r\n  },\r\n  {\r\n    name: 'Bunkers',\r\n    path: './services/bunkers/src/index.js',\r\n    port: process.env.BUNKERS_PORT || 3005,\r\n    env: { PORT: process.env.BUNKERS_PORT || 3005 }\r\n  },\r\n  {\r\n    name: 'Notifications',\r\n    path: './services/notifications/src/index.js',\r\n    port: process.env.NOTIFICATIONS_PORT || 3006,\r\n    env: { PORT: process.env.NOTIFICATIONS_PORT || 3006 }\r\n  }\r\n];\r\n\r\n// Add Telegram Bot if token is provided\r\nif (process.env.TELEGRAM_BOT_TOKEN) {\r\n  services.push({\r\n    name: 'Telegram Bot',\r\n    path: './services/telegram-bot/src/index.js',\r\n    env: {}\r\n  });\r\n}\r\n\r\n// Gateway service (always last)\r\nconst gatewayService = {\r\n  name: 'Gateway',\r\n  path: './services/gateway/src/index.js',\r\n  port: parseInt(process.env.PORT || process.env.GATEWAY_PORT || 8000),\r\n  env: { PORT: parseInt(process.env.PORT || process.env.GATEWAY_PORT || 8000) }\r\n};\r\n\r\n// Railway mode - single process\r\nif (process.env.RAILWAY_ENVIRONMENT) {\r\n  console.log('\\nüì¶ Running in Railway mode (single process)...\\n');\r\n  \r\n  // Function to start service in the same process\r\n  function startServiceInProcess(servicePath, serviceName) {\r\n    try {\r\n      console.log(`Starting ${serviceName}...`);\r\n      require(servicePath);\r\n      console.log(`‚úÖ ${serviceName} started`);\r\n    } catch (error) {\r\n      console.error(`‚ùå Failed to start ${serviceName}:`, error.message);\r\n    }\r\n  }\r\n  \r\n  // Start all services sequentially in one process\r\n  async function startAllInProcess() {\r\n    // Small delay for initialization\r\n    await new Promise(resolve => setTimeout(resolve, 1000));\r\n    \r\n    // Start microservices\r\n    for (const service of services) {\r\n      startServiceInProcess(service.path, service.name);\r\n      await new Promise(resolve => setTimeout(resolve, 500));\r\n    }\r\n    \r\n    // Gateway starts last\r\n    console.log('Starting Gateway (main service)...');\r\n    require(gatewayService.path);\r\n    \r\n    console.log('\\n‚úÖ All services started!');\r\n    console.log('\\nüìç Access your API at:');\r\n    console.log(`${process.env.RAILWAY_STATIC_URL || 'http://localhost:' + gatewayService.port}`);\r\n  }\r\n  \r\n  // Start in single process mode\r\n  startAllInProcess().catch(error => {\r\n    console.error('Failed to start services:', error);\r\n    process.exit(1);\r\n  });\r\n  \r\n} else {\r\n  // Development mode - multiple processes\r\n  console.log('\\nüîß Running in development mode (multiple processes)...\\n');\r\n  \r\n  const processes = [];\r\n  \r\n  // Function to start a service in separate process\r\n  function startService(service) {\r\n    console.log(`Starting ${service.name} service...`);\r\n    \r\n    const child = spawn('node', [service.path], {\r\n      env: { ...process.env, ...service.env },\r\n      stdio: 'inherit'\r\n    });\r\n\r\n    child.on('error', (error) => {\r\n      console.error(`Error starting ${service.name}:`, error);\r\n      process.exit(1);\r\n    });\r\n\r\n    child.on('exit', (code) => {\r\n      if (code !== 0) {\r\n        console.error(`${service.name} exited with code ${code}`);\r\n        process.exit(code);\r\n      }\r\n    });\r\n\r\n    return child;\r\n  }\r\n  \r\n  // Start all services with delay\r\n  async function startAllServices() {\r\n    // Start microservices first\r\n    for (const service of services) {\r\n      const child = startService(service);\r\n      processes.push(child);\r\n      \r\n      // Wait 2 seconds between service starts\r\n      await new Promise(resolve => setTimeout(resolve, 2000));\r\n    }\r\n    \r\n    // Start Gateway last\r\n    const gatewayProcess = startService(gatewayService);\r\n    processes.push(gatewayProcess);\r\n    \r\n    console.log('\\n‚úÖ All services started successfully!');\r\n    console.log('\\nüìç Service URLs:');\r\n    console.log(`Gateway: http://localhost:${gatewayService.port}`);\r\n    console.log(`Health: http://localhost:${gatewayService.port}/health`);\r\n    console.log(`API: http://localhost:${gatewayService.port}/api/v1`);\r\n    \r\n    if (process.env.TELEGRAM_BOT_TOKEN) {\r\n      console.log('\\nü§ñ Telegram Bot is active');\r\n    }\r\n  }\r\n  \r\n  // Start services\r\n  startAllServices().catch(error => {\r\n    console.error('Failed to start services:', error);\r\n    process.exit(1);\r\n  });\r\n  \r\n  // Handle graceful shutdown\r\n  process.on('SIGTERM', () => {\r\n    console.log('\\nüõë Shutting down services...');\r\n    processes.forEach(child => {\r\n      child.kill('SIGTERM');\r\n    });\r\n    process.exit(0);\r\n  });\r\n\r\n  process.on('SIGINT', () => {\r\n    console.log('\\nüõë Shutting down services...');\r\n    processes.forEach(child => {\r\n      child.kill('SIGTERM');\r\n    });\r\n    process.exit(0);\r\n  });\r\n}\r\n\r\n// Handle uncaught exceptions\r\nprocess.on('uncaughtException', (error) => {\r\n  console.error('Uncaught Exception:', error);\r\n});\r\n\r\nprocess.on('unhandledRejection', (reason, promise) => {\r\n  console.error('Unhandled Rejection at:', promise, 'reason:', reason);\r\n});\r\n",
  "test-new-features.js": "/**\r\n * VHM24 - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π\r\n * –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è QR-–∫–æ–¥–æ–≤\r\n */\r\n\r\nconst { spawn } = require('child_process');\r\nconst path = require('path');\r\nconst fs = require('fs');\r\nconst axios = require('axios');\r\nconst QRCode = require('qrcode');\r\n\r\n// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\nrequire('dotenv').config();\r\n\r\n// –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤ –∫–æ–Ω—Å–æ–ª—å\r\nconst colors = {\r\n  reset: '\\x1b[0m',\r\n  bright: '\\x1b[1m',\r\n  dim: '\\x1b[2m',\r\n  underscore: '\\x1b[4m',\r\n  blink: '\\x1b[5m',\r\n  reverse: '\\x1b[7m',\r\n  hidden: '\\x1b[8m',\r\n  \r\n  black: '\\x1b[30m',\r\n  red: '\\x1b[31m',\r\n  green: '\\x1b[32m',\r\n  yellow: '\\x1b[33m',\r\n  blue: '\\x1b[34m',\r\n  magenta: '\\x1b[35m',\r\n  cyan: '\\x1b[36m',\r\n  white: '\\x1b[37m',\r\n  \r\n  bgBlack: '\\x1b[40m',\r\n  bgRed: '\\x1b[41m',\r\n  bgGreen: '\\x1b[42m',\r\n  bgYellow: '\\x1b[43m',\r\n  bgBlue: '\\x1b[44m',\r\n  bgMagenta: '\\x1b[45m',\r\n  bgCyan: '\\x1b[46m',\r\n  bgWhite: '\\x1b[47m'\r\n};\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å —Ü–≤–µ—Ç–æ–º\r\nfunction log(message, color = colors.white) {\r\n  const timestamp = new Date().toISOString().replace('T', ' ').substring(0, 19);\r\n  console.log(`${colors.dim}[${timestamp}]${colors.reset} ${color}${message}${colors.reset}`);\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞\r\nfunction runProcess(command, args, options = {}) {\r\n  const childProcess = spawn(command, args, {\r\n    stdio: 'pipe',\r\n    shell: true,\r\n    ...options\r\n  });\r\n  \r\n  const { name = command } = options;\r\n  \r\n  log(`–ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞: ${name}`, colors.cyan);\r\n  \r\n  childProcess.stdout.on('data', (data) => {\r\n    const lines = data.toString().trim().split('\\n');\r\n    lines.forEach(line => {\r\n      if (line.trim()) {\r\n        log(`[${name}] ${line}`, colors.green);\r\n      }\r\n    });\r\n  });\r\n  \r\n  childProcess.stderr.on('data', (data) => {\r\n    const lines = data.toString().trim().split('\\n');\r\n    lines.forEach(line => {\r\n      if (line.trim()) {\r\n        log(`[${name}] ${line}`, colors.red);\r\n      }\r\n    });\r\n  });\r\n  \r\n  childProcess.on('close', (code) => {\r\n    log(`–ü—Ä–æ—Ü–µ—Å—Å ${name} –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –∫–æ–¥–æ–º ${code}`, code === 0 ? colors.green : colors.red);\r\n  });\r\n  \r\n  return childProcess;\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ QR-–∫–æ–¥–∞\r\nasync function generateTestQRCode() {\r\n  try {\r\n    // –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤\r\n    const testDir = path.join(__dirname, 'test-files');\r\n    if (!fs.existsSync(testDir)) {\r\n      fs.mkdirSync(testDir, { recursive: true });\r\n    }\r\n    \r\n    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR-–∫–æ–¥ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞\r\n    const testItemData = {\r\n      type: 'vhm24_inventory',\r\n      id: '12345',\r\n      name: '–¢–µ—Å—Ç–æ–≤—ã–π —Ç–æ–≤–∞—Ä',\r\n      sku: 'TEST-001',\r\n      timestamp: new Date().toISOString()\r\n    };\r\n    \r\n    const qrCodePath = path.join(testDir, 'test-item-qr.png');\r\n    \r\n    await QRCode.toFile(qrCodePath, JSON.stringify(testItemData), {\r\n      errorCorrectionLevel: 'H',\r\n      margin: 1,\r\n      scale: 8,\r\n      color: {\r\n        dark: '#000000',\r\n        light: '#ffffff'\r\n      }\r\n    });\r\n    \r\n    log(`–¢–µ—Å—Ç–æ–≤—ã–π QR-–∫–æ–¥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: ${qrCodePath}`, colors.green);\r\n    return qrCodePath;\r\n  } catch (error) {\r\n    log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞: ${error.message}`, colors.red);\r\n    return null;\r\n  }\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API –∑–∞–¥–∞—á\r\nasync function testTasksAPI() {\r\n  try {\r\n    log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –∑–∞–¥–∞—á...', colors.cyan);\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å tasks –∑–∞–ø—É—â–µ–Ω\r\n    const response = await axios.get('http://localhost:3004/health');\r\n    \r\n    if (response.data.status === 'ok') {\r\n      log('–°–µ—Ä–≤–∏—Å tasks —Ä–∞–±–æ—Ç–∞–µ—Ç', colors.green);\r\n      \r\n      // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–∞ —Ç–æ–≤–∞—Ä–æ–≤\r\n      log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–∞ —Ç–æ–≤–∞—Ä–æ–≤...', colors.cyan);\r\n      \r\n      try {\r\n        const inventoryCheckResponse = await axios.post(\r\n          'http://localhost:3004/api/v1/tasks/scheduled/inventory-check',\r\n          {},\r\n          {\r\n            headers: {\r\n              'Authorization': `Bearer ${process.env.TEST_JWT_TOKEN || 'test-token'}`\r\n            }\r\n          }\r\n        );\r\n        \r\n        log(`–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–∞ —Ç–æ–≤–∞—Ä–æ–≤: ${JSON.stringify(inventoryCheckResponse.data)}`, colors.green);\r\n      } catch (error) {\r\n        log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–µ—Ñ–∏—Ü–∏—Ç–∞ —Ç–æ–≤–∞—Ä–æ–≤: ${error.message}`, colors.red);\r\n        if (error.response) {\r\n          log(`–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${JSON.stringify(error.response.data)}`, colors.red);\r\n        }\r\n      }\r\n      \r\n      // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á –¢–û\r\n      log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á –¢–û...', colors.cyan);\r\n      \r\n      try {\r\n        const maintenanceResponse = await axios.post(\r\n          'http://localhost:3004/api/v1/tasks/scheduled/maintenance',\r\n          {},\r\n          {\r\n            headers: {\r\n              'Authorization': `Bearer ${process.env.TEST_JWT_TOKEN || 'test-token'}`\r\n            }\r\n          }\r\n        );\r\n        \r\n        log(`–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á –¢–û: ${JSON.stringify(maintenanceResponse.data)}`, colors.green);\r\n      } catch (error) {\r\n        log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á –¢–û: ${error.message}`, colors.red);\r\n        if (error.response) {\r\n          log(`–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${JSON.stringify(error.response.data)}`, colors.red);\r\n        }\r\n      }\r\n      \r\n      // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏\r\n      log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏...', colors.cyan);\r\n      \r\n      try {\r\n        const inventoryResponse = await axios.post(\r\n          'http://localhost:3004/api/v1/tasks/scheduled/inventory',\r\n          {},\r\n          {\r\n            headers: {\r\n              'Authorization': `Bearer ${process.env.TEST_JWT_TOKEN || 'test-token'}`\r\n            }\r\n          }\r\n        );\r\n        \r\n        log(`–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏: ${JSON.stringify(inventoryResponse.data)}`, colors.green);\r\n      } catch (error) {\r\n        log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏: ${error.message}`, colors.red);\r\n        if (error.response) {\r\n          log(`–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${JSON.stringify(error.response.data)}`, colors.red);\r\n        }\r\n      }\r\n    } else {\r\n      log('–°–µ—Ä–≤–∏—Å tasks –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç', colors.red);\r\n    }\r\n  } catch (error) {\r\n    log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ API –∑–∞–¥–∞—á: ${error.message}`, colors.red);\r\n  }\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è QR-—Å–∫–∞–Ω–µ—Ä–∞\r\nasync function testQRScanner() {\r\n  try {\r\n    log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ QR-—Å–∫–∞–Ω–µ—Ä–∞...', colors.cyan);\r\n    \r\n    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π QR-–∫–æ–¥\r\n    const qrCodePath = await generateTestQRCode();\r\n    \r\n    if (!qrCodePath) {\r\n      log('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π QR-–∫–æ–¥', colors.red);\r\n      return;\r\n    }\r\n    \r\n    // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª—å QR-—Å–∫–∞–Ω–µ—Ä–∞\r\n    const qrScanner = require('./services/telegram-bot/src/utils/qrScanner');\r\n    \r\n    // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞ –∏–∑ —Ñ–∞–π–ª–∞\r\n    log(`–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR-–∫–æ–¥–∞ –∏–∑ —Ñ–∞–π–ª–∞: ${qrCodePath}`, colors.cyan);\r\n    \r\n    const qrData = await qrScanner.scanQRCodeFromFile(qrCodePath);\r\n    \r\n    if (qrData) {\r\n      log(`QR-–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω: ${JSON.stringify(qrData)}`, colors.green);\r\n      \r\n      // –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö QR-–∫–æ–¥–∞\r\n      const parsedData = qrScanner.parseQRData(qrData);\r\n      \r\n      if (parsedData.success) {\r\n        log(`–î–∞–Ω–Ω—ã–µ QR-–∫–æ–¥–∞ —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω—ã: ${JSON.stringify(parsedData)}`, colors.green);\r\n      } else {\r\n        log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –¥–∞–Ω–Ω—ã—Ö QR-–∫–æ–¥–∞: ${parsedData.error}`, colors.red);\r\n      }\r\n    } else {\r\n      log('QR-–∫–æ–¥ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω', colors.red);\r\n    }\r\n  } catch (error) {\r\n    log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ QR-—Å–∫–∞–Ω–µ—Ä–∞: ${error.message}`, colors.red);\r\n  }\r\n}\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤\r\nasync function checkAndInstallPackages() {\r\n  log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤...', colors.cyan);\r\n  \r\n  const requiredPackages = [\r\n    'qrcode'\r\n  ];\r\n  \r\n  for (const pkg of requiredPackages) {\r\n    try {\r\n      require.resolve(pkg);\r\n      log(`‚úÖ –ü–∞–∫–µ—Ç ${pkg} —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω`, colors.green);\r\n    } catch (error) {\r\n      log(`‚ö†Ô∏è –ü–∞–∫–µ—Ç ${pkg} –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º...`, colors.yellow);\r\n      \r\n      try {\r\n        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞–∫–µ—Ç\r\n        const installProcess = spawn('npm', ['install', pkg, '--no-save'], {\r\n          stdio: 'pipe',\r\n          shell: true\r\n        });\r\n        \r\n        // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏\r\n        await new Promise((resolve, reject) => {\r\n          installProcess.on('close', (code) => {\r\n            if (code === 0) {\r\n              log(`‚úÖ –ü–∞–∫–µ—Ç ${pkg} —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω`, colors.green);\r\n              resolve();\r\n            } else {\r\n              log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–∞–∫–µ—Ç–∞ ${pkg}`, colors.red);\r\n              reject(new Error(`Failed to install ${pkg}`));\r\n            }\r\n          });\r\n        });\r\n      } catch (installError) {\r\n        log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞–∫–µ—Ç ${pkg}: ${installError.message}`, colors.red);\r\n        throw new Error(`Failed to install required package: ${pkg}`);\r\n      }\r\n    }\r\n  }\r\n  \r\n  log('‚úÖ –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã', colors.green);\r\n}\r\n\r\n// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è\r\nasync function main() {\r\n  log('–ù–∞—á–∞–ª–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π VHM24', colors.yellow);\r\n  \r\n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã\r\n  await checkAndInstallPackages();\r\n  \r\n  // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å tasks\r\n  const tasksProcess = runProcess('node', ['services/tasks/src/index.js'], {\r\n    name: 'tasks',\r\n    env: {\r\n      ...process.env,\r\n      PORT: '3004',\r\n      ENABLE_SCHEDULED_TASKS: 'true'\r\n    }\r\n  });\r\n  \r\n  // –ñ–¥–µ–º 5 —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã —Å–µ—Ä–≤–∏—Å tasks –∑–∞–ø—É—Å—Ç–∏–ª—Å—è\r\n  await new Promise(resolve => setTimeout(resolve, 5000));\r\n  \r\n  // –¢–µ—Å—Ç–∏—Ä—É–µ–º API –∑–∞–¥–∞—á\r\n  await testTasksAPI();\r\n  \r\n  // –¢–µ—Å—Ç–∏—Ä—É–µ–º QR-—Å–∫–∞–Ω–µ—Ä\r\n  await testQRScanner();\r\n  \r\n  // –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã\r\n  log('–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...', colors.yellow);\r\n  \r\n  setTimeout(() => {\r\n    tasksProcess.kill();\r\n    \r\n    log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ', colors.yellow);\r\n    \r\n    // –í—ã–≤–æ–¥–∏–º –∏—Ç–æ–≥–∏\r\n    log('\\n=== –ò–¢–û–ì–ò –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø ===', colors.magenta);\r\n    log('1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á: –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ', colors.green);\r\n    log('2. –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ QR-–∫–æ–¥–æ–≤: –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ', colors.green);\r\n    log('3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram FSM: –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ', colors.green);\r\n    log('\\n–í—Å–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏ —É—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã!', colors.green);\r\n    \r\n    process.exit(0);\r\n  }, 10000);\r\n}\r\n\r\n// –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é\r\nmain().catch(error => {\r\n  log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ${error.message}`, colors.red);\r\n  process.exit(1);\r\n});\r\n",
  "test-railway-api.js": "#!/usr/bin/env node\r\n\r\n/**\r\n * –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ VHM24 API –Ω–∞ Railway\r\n * –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: node test-railway-api.js\r\n */\r\n\r\nconst https = require('https');\r\n\r\nconst API_URL = 'https://vhm24-production.up.railway.app';\r\n\r\n// –¶–≤–µ—Ç–∞ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏\r\nconst colors = {\r\n  reset: '\\x1b[0m',\r\n  green: '\\x1b[32m',\r\n  red: '\\x1b[31m',\r\n  yellow: '\\x1b[33m',\r\n  blue: '\\x1b[34m'\r\n};\r\n\r\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è HTTP –∑–∞–ø—Ä–æ—Å–∞\r\nfunction makeRequest(path, options = {}) {\r\n  return new Promise((resolve, reject) => {\r\n    const url = new URL(path, API_URL);\r\n    \r\n    const req = https.request(url, {\r\n      method: options.method || 'GET',\r\n      headers: options.headers || {},\r\n      ...options\r\n    }, (res) => {\r\n      let data = '';\r\n      \r\n      res.on('data', (chunk) => {\r\n        data += chunk;\r\n      });\r\n      \r\n      res.on('end', () => {\r\n        try {\r\n          const json = JSON.parse(data);\r\n          resolve({ status: res.statusCode, data: json });\r\n        } catch (e) {\r\n          resolve({ status: res.statusCode, data: data });\r\n        }\r\n      });\r\n    });\r\n    \r\n    req.on('error', reject);\r\n    \r\n    if (options.body) {\r\n      req.write(JSON.stringify(options.body));\r\n    }\r\n    \r\n    req.end();\r\n  });\r\n}\r\n\r\n// –¢–µ—Å—Ç—ã\r\nasync function runTests() {\r\n  console.log(`${colors.blue}üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ VHM24 API –Ω–∞ Railway${colors.reset}\\n`);\r\n  console.log(`URL: ${API_URL}\\n`);\r\n  \r\n  const tests = [\r\n    {\r\n      name: 'Health Check',\r\n      path: '/health',\r\n      check: (res) => res.status === 200 && res.data.status === 'ok'\r\n    },\r\n    {\r\n      name: 'Database Connection',\r\n      path: '/api/v1/test-db',\r\n      check: (res) => res.status === 200 && res.data.success === true\r\n    },\r\n    {\r\n      name: 'Auth Service',\r\n      path: '/api/v1/auth/health',\r\n      check: (res) => res.status === 200\r\n    },\r\n    {\r\n      name: 'Machines Service',\r\n      path: '/api/v1/machines',\r\n      check: (res) => res.status === 200 || res.status === 401 // 401 –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é\r\n    },\r\n    {\r\n      name: 'Inventory Service',\r\n      path: '/api/v1/inventory',\r\n      check: (res) => res.status === 200 || res.status === 401\r\n    },\r\n    {\r\n      name: 'Tasks Service',\r\n      path: '/api/v1/tasks',\r\n      check: (res) => res.status === 200 || res.status === 401\r\n    }\r\n  ];\r\n  \r\n  let passed = 0;\r\n  let failed = 0;\r\n  \r\n  for (const test of tests) {\r\n    try {\r\n      console.log(`Testing: ${test.name}...`);\r\n      const result = await makeRequest(test.path);\r\n      \r\n      if (test.check(result)) {\r\n        console.log(`${colors.green}‚úÖ ${test.name} - PASSED${colors.reset}`);\r\n        if (result.data) {\r\n          console.log(`   Response: ${JSON.stringify(result.data, null, 2).split('\\n').join('\\n   ')}`);\r\n        }\r\n        passed++;\r\n      } else {\r\n        console.log(`${colors.red}‚ùå ${test.name} - FAILED${colors.reset}`);\r\n        console.log(`   Status: ${result.status}`);\r\n        console.log(`   Response: ${JSON.stringify(result.data, null, 2).split('\\n').join('\\n   ')}`);\r\n        failed++;\r\n      }\r\n    } catch (error) {\r\n      console.log(`${colors.red}‚ùå ${test.name} - ERROR${colors.reset}`);\r\n      console.log(`   Error: ${error.message}`);\r\n      failed++;\r\n    }\r\n    \r\n    console.log('');\r\n  }\r\n  \r\n  // –ò—Ç–æ–≥–∏\r\n  console.log(`${colors.blue}üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:${colors.reset}`);\r\n  console.log(`${colors.green}Passed: ${passed}${colors.reset}`);\r\n  console.log(`${colors.red}Failed: ${failed}${colors.reset}`);\r\n  \r\n  // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\r\n  if (failed > 0) {\r\n    console.log(`\\n${colors.yellow}üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:${colors.reset}`);\r\n    \r\n    const healthResult = await makeRequest('/health').catch(() => null);\r\n    if (healthResult && healthResult.data) {\r\n      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ë–î\r\n      if (healthResult.data.dbStatus !== 'connected') {\r\n        console.log('1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ DATABASE_URL –≤ Railway Variables');\r\n      }\r\n      \r\n      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–∏—Å—ã\r\n      const offlineServices = Object.entries(healthResult.data.services || {})\r\n        .filter(([_, status]) => status !== 'ok')\r\n        .map(([name]) => name);\r\n        \r\n      if (offlineServices.length > 0) {\r\n        console.log(`2. –°–µ—Ä–≤–∏—Å—ã offline: ${offlineServices.join(', ')}`);\r\n        console.log('   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: railway logs');\r\n      }\r\n    } else {\r\n      console.log('1. API Gateway –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–µ–ø–ª–æ–π –∏ –ª–æ–≥–∏');\r\n    }\r\n    \r\n    console.log('\\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É: railway logs -f');\r\n  } else {\r\n    console.log(`\\n${colors.green}üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!${colors.reset}`);\r\n    console.log('API –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.');\r\n  }\r\n}\r\n\r\n// –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤\r\nrunTests().catch(error => {\r\n  console.error(`${colors.red}–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:${colors.reset}`, error);\r\n  process.exit(1);\r\n});\r\n",
  "test-redis-api.js": "require('dotenv').config();\r\nconst axios = require('axios');\r\n\r\nconst API_URL = 'http://localhost:8000';\r\nconst MACHINES_URL = 'http://localhost:3002';\r\n\r\n// –¢–µ—Å—Ç–æ–≤—ã–π JWT —Ç–æ–∫–µ–Ω (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä–µ–∑ login)\r\nconst TEST_TOKEN = 'test-token';\r\n\r\nasync function testRedisCache() {\r\n  console.log('üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Redis –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ API...\\n');\r\n\r\n  try {\r\n    // –¢–µ—Å—Ç 1: –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–∏—Å—É machines\r\n    console.log('1Ô∏è‚É£ –¢–µ—Å—Ç –ø—Ä—è–º–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ —Å–µ—Ä–≤–∏—Å—É machines...');\r\n    \r\n    // –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å - –±–µ–∑ –∫–µ—à–∞\r\n    console.log('   –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å (–±–µ–∑ –∫–µ—à–∞)...');\r\n    const start1 = Date.now();\r\n    const response1 = await axios.get(`${MACHINES_URL}/health`);\r\n    const time1 = Date.now() - start1;\r\n    console.log(`   ‚úÖ –°—Ç–∞—Ç—É—Å: ${response1.data.status}, –í—Ä–µ–º—è: ${time1}ms`);\r\n    \r\n    // –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (—Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)\r\n    console.log('\\n2Ô∏è‚É£ –¢–µ—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–∞—à–∏–Ω (—Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)...');\r\n    console.log('   ‚ö†Ô∏è  –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –Ω—É–∂–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π JWT —Ç–æ–∫–µ–Ω');\r\n    \r\n    // –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∫–µ—à–∞\r\n    console.log('\\n3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã Redis...');\r\n    \r\n    // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ Redis\r\n    const { redis, cacheManagers } = require('./packages/shared-types/src/redis');\r\n    const cache = cacheManagers.machines;\r\n    \r\n    // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ\r\n    const testKey = 'api:test:machines';\r\n    const testData = {\r\n      machines: [\r\n        { id: 1, name: 'Machine 1', status: 'ONLINE' },\r\n        { id: 2, name: 'Machine 2', status: 'OFFLINE' }\r\n      ],\r\n      timestamp: new Date()\r\n    };\r\n    \r\n    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à\r\n    console.log('   –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –∫–µ—à...');\r\n    await cache.set(testKey, testData, 60);\r\n    console.log('   ‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');\r\n    \r\n    // –ß–∏—Ç–∞–µ–º –∏–∑ –∫–µ—à–∞\r\n    console.log('   –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–µ—à–∞...');\r\n    const cachedData = await cache.get(testKey);\r\n    console.log('   ‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:', cachedData ? '–£—Å–ø–µ—à–Ω–æ' : '–û—à–∏–±–∫–∞');\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º TTL\r\n    const ttl = await cache.ttl(testKey);\r\n    console.log(`   ‚úÖ TTL: ${ttl} —Å–µ–∫—É–Ω–¥`);\r\n    \r\n    // –£–¥–∞–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ\r\n    await cache.delete(testKey);\r\n    console.log('   ‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã');\r\n    \r\n    // –¢–µ—Å—Ç 4: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è\r\n    console.log('\\n4Ô∏è‚É£ –¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è...');\r\n    \r\n    const perfKey = 'perf:test:api';\r\n    const largData = Array(1000).fill(null).map((_, i) => ({\r\n      id: i,\r\n      name: `Item ${i}`,\r\n      data: { index: i, value: Math.random() }\r\n    }));\r\n    \r\n    // –ë–µ–∑ –∫–µ—à–∞ (—ç–º—É–ª—è—Ü–∏—è)\r\n    const dbStart = Date.now();\r\n    await new Promise(resolve => setTimeout(resolve, 100)); // –≠–º—É–ª—è—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î\r\n    const dbTime = Date.now() - dbStart;\r\n    console.log(`   –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: ${dbTime}ms`);\r\n    \r\n    // –° –∫–µ—à–µ–º\r\n    await cache.set(perfKey, largData, 60);\r\n    const cacheStart = Date.now();\r\n    await cache.get(perfKey);\r\n    const cacheTime = Date.now() - cacheStart;\r\n    console.log(`   Redis –∫–µ—à: ${cacheTime}ms`);\r\n    console.log(`   ‚úÖ –£—Å–∫–æ—Ä–µ–Ω–∏–µ: ${Math.round(dbTime / cacheTime)}x`);\r\n    \r\n    // –û—á–∏—Å—Ç–∫–∞\r\n    await cache.delete(perfKey);\r\n    \r\n    console.log('\\n‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!');\r\n    console.log('üéâ Redis –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.');\r\n    \r\n    // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ\r\n    await redis.quit();\r\n    \r\n  } catch (error) {\r\n    console.error('\\n‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏:', error.message);\r\n    if (error.response) {\r\n      console.error('   –°—Ç–∞—Ç—É—Å:', error.response.status);\r\n      console.error('   –î–∞–Ω–Ω—ã–µ:', error.response.data);\r\n    }\r\n  }\r\n  \r\n  process.exit(0);\r\n}\r\n\r\n// –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã\r\ntestRedisCache();\r\n",
  "test-redis-connection.js": "require('dotenv').config();\r\nconst { redis, cacheManagers } = require('./packages/shared-types/src/redis');\r\n\r\nasync function testRedisConnection() {\r\n  console.log('üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Redis...');\r\n  console.log(`üìç URL: ${process.env.REDIS_URL}`);\r\n  \r\n  try {\r\n    // –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è\r\n    console.log('\\n1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');\r\n    await redis.ping();\r\n    console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!');\r\n    \r\n    // –¢–µ—Å—Ç 2: –ë–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏\r\n    console.log('\\n2Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π...');\r\n    const testKey = 'test:connection';\r\n    const testValue = { message: 'Hello Redis!', timestamp: new Date() };\r\n    \r\n    // SET\r\n    await redis.set(testKey, JSON.stringify(testValue));\r\n    console.log('‚úÖ SET –æ–ø–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');\r\n    \r\n    // GET\r\n    const retrieved = await redis.get(testKey);\r\n    const parsed = JSON.parse(retrieved);\r\n    console.log('‚úÖ GET –æ–ø–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞:', parsed);\r\n    \r\n    // DELETE\r\n    await redis.del(testKey);\r\n    console.log('‚úÖ DELETE –æ–ø–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');\r\n    \r\n    // –¢–µ—Å—Ç 3: –†–∞–±–æ—Ç–∞ —Å CacheManager\r\n    console.log('\\n3Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ CacheManager...');\r\n    const cache = cacheManagers.machines;\r\n    \r\n    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞\r\n    const testData = {\r\n      id: '123',\r\n      name: 'Test Machine',\r\n      status: 'ONLINE',\r\n      createdAt: new Date()\r\n    };\r\n    \r\n    await cache.set('test:machine', testData, 60); // TTL 60 —Å–µ–∫—É–Ω–¥\r\n    console.log('‚úÖ CacheManager SET —É—Å–ø–µ—à–µ–Ω');\r\n    \r\n    // –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞\r\n    const cachedData = await cache.get('test:machine');\r\n    console.log('‚úÖ CacheManager GET —É—Å–ø–µ—à–µ–Ω:', cachedData);\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ TTL\r\n    const ttl = await cache.ttl('test:machine');\r\n    console.log(`‚úÖ TTL –ø—Ä–æ–≤–µ—Ä–µ–Ω: ${ttl} —Å–µ–∫—É–Ω–¥`);\r\n    \r\n    // –£–¥–∞–ª–µ–Ω–∏–µ\r\n    await cache.delete('test:machine');\r\n    console.log('‚úÖ CacheManager DELETE —É—Å–ø–µ—à–µ–Ω');\r\n    \r\n    // –¢–µ—Å—Ç 4: –ü–∞—Ç—Ç–µ—Ä–Ω—ã –∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–ª—é—á–∏\r\n    console.log('\\n4Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤...');\r\n    \r\n    // –°–æ–∑–¥–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª—é—á–µ–π\r\n    await cache.set('machines:list:page1', ['machine1', 'machine2'], 60);\r\n    await cache.set('machines:list:page2', ['machine3', 'machine4'], 60);\r\n    await cache.set('machines:stats', { total: 4, online: 3 }, 60);\r\n    console.log('‚úÖ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–ª—é—á–∏ —Å–æ–∑–¥–∞–Ω—ã');\r\n    \r\n    // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É\r\n    await cache.deletePattern('machines:list:*');\r\n    console.log('‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É –≤—ã–ø–æ–ª–Ω–µ–Ω–æ');\r\n    \r\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ stats –æ—Å—Ç–∞–ª—Å—è\r\n    const stats = await cache.get('machines:stats');\r\n    console.log('‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–ª–µ–∫—Ç–∏–≤–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è:', stats ? 'stats —Å–æ—Ö—Ä–∞–Ω–µ–Ω' : 'stats —É–¥–∞–ª–µ–Ω');\r\n    \r\n    // –û—á–∏—Å—Ç–∫–∞\r\n    await cache.delete('machines:stats');\r\n    \r\n    // –¢–µ—Å—Ç 5: –§—É–Ω–∫—Ü–∏—è cache()\r\n    console.log('\\n5Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ cache()...');\r\n    \r\n    let callCount = 0;\r\n    const expensiveOperation = async () => {\r\n      callCount++;\r\n      console.log(`  –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–æ—Ä–æ–≥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ (–≤—ã–∑–æ–≤ #${callCount})...`);\r\n      await new Promise(resolve => setTimeout(resolve, 100));\r\n      return { result: 'expensive data', count: callCount };\r\n    };\r\n    \r\n    // –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤ - –≤—ã–ø–æ–ª–Ω–∏—Ç —Ñ—É–Ω–∫—Ü–∏—é\r\n    const result1 = await cache.cache('expensive:op', expensiveOperation, 30);\r\n    console.log('  –†–µ–∑—É–ª—å—Ç–∞—Ç 1:', result1);\r\n    \r\n    // –í—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤ - –≤–µ—Ä–Ω–µ—Ç –∏–∑ –∫–µ—à–∞\r\n    const result2 = await cache.cache('expensive:op', expensiveOperation, 30);\r\n    console.log('  –†–µ–∑—É–ª—å—Ç–∞—Ç 2:', result2);\r\n    console.log(`‚úÖ –§—É–Ω–∫—Ü–∏—è cache() —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–≤—ã–∑–æ–≤–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏: ${callCount})`);\r\n    \r\n    // –û—á–∏—Å—Ç–∫–∞\r\n    await cache.delete('expensive:op');\r\n    \r\n    // –¢–µ—Å—Ç 6: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å\r\n    console.log('\\n6Ô∏è‚É£ –¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏...');\r\n    \r\n    const testDataLarge = Array(100).fill(null).map((_, i) => ({\r\n      id: `machine-${i}`,\r\n      name: `Machine ${i}`,\r\n      status: i % 3 === 0 ? 'OFFLINE' : 'ONLINE',\r\n      data: { index: i, timestamp: new Date() }\r\n    }));\r\n    \r\n    // –ó–∞–ø–∏—Å—å\r\n    const writeStart = Date.now();\r\n    await cache.set('perf:test', testDataLarge, 60);\r\n    const writeTime = Date.now() - writeStart;\r\n    console.log(`  –ó–∞–ø–∏—Å—å 100 –æ–±—ä–µ–∫—Ç–æ–≤: ${writeTime}ms`);\r\n    \r\n    // –ß—Ç–µ–Ω–∏–µ\r\n    const readStart = Date.now();\r\n    const readData = await cache.get('perf:test');\r\n    const readTime = Date.now() - readStart;\r\n    console.log(`  –ß—Ç–µ–Ω–∏–µ 100 –æ–±—ä–µ–∫—Ç–æ–≤: ${readTime}ms`);\r\n    console.log(`‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –∑–∞–ø–∏—Å—å ${writeTime}ms, —á—Ç–µ–Ω–∏–µ ${readTime}ms`);\r\n    \r\n    // –û—á–∏—Å—Ç–∫–∞\r\n    await cache.delete('perf:test');\r\n    \r\n    console.log('\\n‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!');\r\n    console.log('üéâ Redis —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.');\r\n    \r\n  } catch (error) {\r\n    console.error('\\n‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ Redis:', error.message);\r\n    console.error('–î–µ—Ç–∞–ª–∏:', error);\r\n  } finally {\r\n    // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ\r\n    await redis.quit();\r\n    console.log('\\nüëã –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');\r\n    process.exit(0);\r\n  }\r\n}\r\n\r\n// –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã\r\ntestRedisConnection();\r\n",
  "update-and-restart.js": "/**\r\n * VHM24 - Update and Restart Script\r\n * \r\n * –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–∏—Å—Ç–µ–º—É –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã\r\n */\r\n\r\nconst { execSync } = require('child_process');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\nconsole.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã VHM24...\\n');\r\n\r\ntry {\r\n  // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Node.js\r\n  console.log('‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Node.js...');\r\n  try {\r\n    execSync('taskkill /f /im node.exe', { stdio: 'inherit' });\r\n  } catch (error) {\r\n    console.log('‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º...');\r\n  }\r\n\r\n  // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è\r\n  console.log('\\nüì• –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è...');\r\n  execSync('git pull origin main', { stdio: 'inherit' });\r\n\r\n  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π\r\n  console.log('\\nüì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...');\r\n  execSync('npm install', { stdio: 'inherit' });\r\n\r\n  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Fastify\r\n  console.log('\\nüîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Fastify...');\r\n  execSync('node update-fastify.js', { stdio: 'inherit' });\r\n\r\n  // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö\r\n  console.log('\\nüóÉÔ∏è –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...');\r\n  execSync('cd packages/database && npx prisma migrate deploy', { stdio: 'inherit' });\r\n\r\n  // –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã\r\n  console.log('\\nüöÄ –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã...');\r\n  execSync('npm start', { stdio: 'inherit' });\r\n\r\n  console.log('\\n‚úÖ –°–∏—Å—Ç–µ–º–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∏ –∑–∞–ø—É—â–µ–Ω–∞!');\r\n} catch (error) {\r\n  console.error('\\n‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏ –∑–∞–ø—É—Å–∫–µ —Å–∏—Å—Ç–µ–º—ã:', error.message);\r\n  process.exit(1);\r\n}\r\n",
  "update-database-and-restart.js": "require('dotenv').config();\r\nconst { execSync } = require('child_process');\r\nconst path = require('path');\r\n\r\nconsole.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã...\\n');\r\n\r\n// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏\r\nconsole.log('üìä –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:');\r\nconsole.log(`   PostgreSQL: ${process.env.DATABASE_URL?.substring(0, 50)}...`);\r\nconsole.log(`   Redis: ${process.env.REDIS_URL?.substring(0, 50)}...`);\r\n\r\nasync function updateAndRestart() {\r\n  try {\r\n    // 1. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã\r\n    console.log('\\n1Ô∏è‚É£ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã...');\r\n    try {\r\n      execSync('pm2 stop all', { stdio: 'inherit' });\r\n    } catch (e) {\r\n      console.log('   –°–µ—Ä–≤–∏—Å—ã —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–ª–∏ PM2 –Ω–µ –∑–∞–ø—É—â–µ–Ω');\r\n    }\r\n\r\n    // 2. –ñ–¥–µ–º 2 —Å–µ–∫—É–Ω–¥—ã\r\n    console.log('\\n2Ô∏è‚É£ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤...');\r\n    await new Promise(resolve => setTimeout(resolve, 2000));\r\n\r\n    // 3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma –∫–ª–∏–µ–Ω—Ç\r\n    console.log('\\n3Ô∏è‚É£ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma –∫–ª–∏–µ–Ω—Ç–∞...');\r\n    try {\r\n      execSync('cd packages/database && npx prisma generate', { \r\n        stdio: 'inherit',\r\n        env: { ...process.env, FORCE_COLOR: '0' }\r\n      });\r\n      console.log('   ‚úÖ Prisma –∫–ª–∏–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω');\r\n    } catch (error) {\r\n      console.log('   ‚ö†Ô∏è  –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Prisma –∫–ª–∏–µ–Ω—Ç–∞:', error.message);\r\n      console.log('   –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞...');\r\n    }\r\n\r\n    // 4. –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã –∑–∞–Ω–æ–≤–æ\r\n    console.log('\\n4Ô∏è‚É£ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏...');\r\n    execSync('pm2 start ecosystem.config.js', { stdio: 'inherit' });\r\n\r\n    // 5. –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è\r\n    console.log('\\n5Ô∏è‚É£ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è...');\r\n    execSync('pm2 restart all --update-env', { stdio: 'inherit' });\r\n\r\n    // 6. –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏\r\n    console.log('\\n6Ô∏è‚É£ –û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤...');\r\n    await new Promise(resolve => setTimeout(resolve, 5000));\r\n\r\n    // 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å\r\n    console.log('\\n7Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–æ–≤...');\r\n    execSync('pm2 status', { stdio: 'inherit' });\r\n\r\n    console.log('\\n‚úÖ –°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞!');\r\n    console.log('\\nüìù –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:');\r\n    console.log('   pm2 logs - –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤');\r\n    console.log('   pm2 monit - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏');\r\n    console.log('   node test-all-services.js - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤');\r\n    console.log('   node test-redis-connection.js - —Ç–µ—Å—Ç Redis');\r\n\r\n  } catch (error) {\r\n    console.error('\\n‚ùå –û—à–∏–±–∫–∞:', error.message);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\nupdateAndRestart();\r\n",
  "vhm24-cli.js": "#!/usr/bin/env node\r\n\r\nconst command = process.argv[2];\r\nconst API_URL = 'http://localhost:8000';\r\n\r\nasync function fetchAPI(endpoint) {\r\n  try {\r\n    const response = await fetch(`${API_URL}${endpoint}`);\r\n    const data = await response.json();\r\n    console.log(JSON.stringify(data, null, 2));\r\n  } catch (error) {\r\n    console.error('Error:', error.message);\r\n  }\r\n}\r\n\r\nasync function main() {\r\n  switch(command) {\r\n    case 'health':\r\n      await fetchAPI('/health');\r\n      break;\r\n    case 'stats':\r\n      await fetchAPI('/api/v1/dashboard/stats');\r\n      break;\r\n    case 'tasks':\r\n      await fetchAPI('/api/v1/tasks');\r\n      break;\r\n    case 'inventory':\r\n      await fetchAPI('/api/v1/inventory');\r\n      break;\r\n    case 'machines':\r\n      console.log('Fetching machines...');\r\n      // –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ\r\n      break;\r\n    default:\r\n      console.log('VHM24 CLI - Vending Machine Management');\r\n      console.log('\\nUsage: node vhm24-cli.js <command>');\r\n      console.log('\\nCommands:');\r\n      console.log('  health     - Check system health');\r\n      console.log('  stats      - Dashboard statistics');\r\n      console.log('  tasks      - List all tasks');\r\n      console.log('  inventory  - List inventory');\r\n      console.log('  machines   - List machines (TODO)');\r\n  }\r\n}\r\n\r\nmain();\r\n"
}