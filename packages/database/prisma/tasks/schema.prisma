generator client {
  provider = "prisma-client-js"
  output   = "../../node_modules/@prisma/client/tasks"
}

datasource db {
  provider = "postgresql"
  url      = env("TASKS_DATABASE_URL")
}

// ENUMS
enum TaskStatus {
  CREATED
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// MODELS
model Task {
  id           String       @id @default(cuid())
  title        String
  description  String       @default("")
  status       TaskStatus   @default(CREATED)
  priority     TaskPriority @default(MEDIUM)
  dueDate      DateTime?
  completedAt  DateTime?
  
  // External references
  machineId    String?      // Machine ID from machines service
  assignedToId String?      // User ID from auth service
  createdById  String       // User ID from auth service
  
  // Timestamps
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  
  // Relations
  actions      TaskAction[]
  
  @@index([status, assignedToId])
  @@index([machineId])
  @@index([createdById])
}

model TaskAction {
  id          String   @id @default(cuid())
  taskId      String
  task        Task     @relation(fields: [taskId], references: [id])
  userId      String   // User ID from auth service
  action      String
  comment     String
  location    String?  // "latitude,longitude"
  photoUrls   String[]
  metadata    Json?
  createdAt   DateTime @default(now())
  
  @@index([taskId])
  @@index([userId])
}

// Task templates for recurring tasks
model TaskTemplate {
  id           String       @id @default(cuid())
  name         String
  title        String
  description  String       @default("")
  priority     TaskPriority @default(MEDIUM)
  machineType  String?      // Type of machine this template applies to
  isActive     Boolean      @default(true)
  metadata     Json?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  
  @@index([machineType])
  @@index([isActive])
}

// Scheduled tasks
model ScheduledTask {
  id           String       @id @default(cuid())
  templateId   String?
  title        String
  description  String       @default("")
  priority     TaskPriority @default(MEDIUM)
  machineId    String?      // Machine ID from machines service
  assignToId   String?      // User ID from auth service
  scheduleType String       // DAILY, WEEKLY, MONTHLY, CUSTOM
  scheduleData Json         // Cron expression or custom schedule data
  nextRunAt    DateTime
  lastRunAt    DateTime?
  isActive     Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  
  @@index([nextRunAt])
  @@index([isActive])
  @@index([machineId])
}
