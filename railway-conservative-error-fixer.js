#!/usr/bin/env node



const { execSync } = require('child_process');
const fs = require('fs');

class RailwayConservativeErrorFixer {
    constructor() {
        this.projectId = process.env.API_KEY_234 || '740ca318-2ca1-49bb-8827-75feb0a5639c';
        this.publicUrl = 'https://web-production-73916.up.railway.app';
        
        
        
        
    }

    async run() {
        try {
            
            
            // 1. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            await this.diagnoseCurrentState();
            
            // 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ URL –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ö
            await this.fixUrlInConfigurations();
            
            // 3. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–µ–π—à–µ–≥–æ —Ä–∞–±–æ—á–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
            await this.createSimplestWorkingServer();
            
            // 4. –ú—è–≥–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ package.json
            await this.softUpdatePackageJson();
            
            // 5. –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π –¥–µ–ø–ª–æ–π
            await this.conservativeDeploy();
            
            // 6. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            await this.gradualTesting();
            
            
            
        } catch (error) {
            console.error('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏:', error.message);
            await this.createSafetyReport(error);
        }
    }

    async diagnoseCurrentState() {
        
        
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º Railway —Å—Ç–∞—Ç—É—Å
            const status = execSync('railway status', { encoding: 'utf8' });
            
            
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã
            const importantFiles = ['package.json', 'server.js', '.env', 'railway.toml'];
            
            
            for (const file of importantFiles) {
                if (fs.existsSync(file)) {
                    
                } else {
                    
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π URL
            
            try {
                const response = execSync(`curl -s -w "%{http_code}" "${this.publicUrl}"`, { encoding: 'utf8' });
                const statusCode = response.slice(-3);
                
                
                if (statusCode === '404') {
                    
                } else if (statusCode === '200') {
                    
                    return true;
                }
            } catch (error) {
                
            }
            
        } catch (error) {
            
        }
        
        return false;
    }

    async fixUrlInConfigurations() {
        
        
        // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º .env —Ñ–∞–π–ª
        if (fs.existsSync('.env')) {
            let envContent = fs.readFileSync('.env', 'utf8');
            
            // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ URL
            envContent = envContent.replace(
                /RAILWAY_PUBLIC_URL=https:\/\/web-production-73916\.up\.railway\.app[^=\n]*/g,
                'RAILWAY_PUBLIC_URL=https://web-production-73916.up.railway.app'
            );
            
            envContent = envContent.replace(
                /WEBHOOK_URL=https:\/\/web-production-73916\.up\.railway\.app[^=\n]*/g,
                'WEBHOOK_URL=https://web-production-73916.up.railway.app/api/bot'
            );
            
            fs.writeFileSync('.env', envContent);
            
        }
        
        // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º README.md
        if (fs.existsSync('README.md')) {
            let readmeContent = fs.readFileSync('README.md', 'utf8');
            
            // –ó–∞–º–µ–Ω—è–µ–º –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ URL –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ
            readmeContent = readmeContent.replace(
                /https:\/\/web-production-73916\.up\.railway\.app[^)\s\n]*/g,
                'https://web-production-73916.up.railway.app'
            );
            
            fs.writeFileSync('README.md', readmeContent);
            
        }
    }

    async createSimplestWorkingServer() {
        
        
        // –°–æ–∑–¥–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ–π —Å–µ—Ä–≤–µ—Ä
        const simpleServer = `const express = require('express');
const app = express();
const PORT = process.env.PORT || 8000;

// –ë–∞–∑–æ–≤—ã–µ middleware
app.use(express.json());

// –ü—Ä–æ—Å—Ç–µ–π—à–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
app.get('/', (req, res) => {
    res.json({
        message: 'VHM24 VendHub Management System - Working!',
        status: 'online',
        timestamp: new Date().toISOString(),
        version: '1.0.0'
    });
});

app.get('/api/health', (req, res) => {
    res.json({
        status: 'OK',
        timestamp: new Date().toISOString(),
        uptime: process.uptime()
    });
});

app.get('/api/info', (req, res) => {
    res.json({
        name: 'VHM24 API',
        version: '1.0.0',
        status: 'working',
        endpoints: ['/', '/api/health', '/api/info']
    });
});

// Telegram webhook endpoint
app.post('/api/bot', (req, res) => {
    
    res.json({ ok: true, message: 'Webhook received' });
});

// 404 handler
app.use('*', (req, res) => {
    res.status(404).json({
        error: 'Route not found',
        path: req.originalUrl,
        available: ['/', '/api/health', '/api/info', 'POST /api/bot']
    });
});

// Start server
app.listen(PORT, '0.0.0.0', () => {
    
    
});

module.exports = app;
`;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π server.js –∫–∞–∫ backup
        if (fs.existsSync('server.js')) {
            fs.copyFileSync('server.js', 'server.js.backup');
            
        }
        
        fs.writeFileSync('server.js', simpleServer);
        
    }

    async softUpdatePackageJson() {
        
        
        if (fs.existsSync('package.json')) {
            // –°–æ–∑–¥–∞–µ–º backup
            fs.copyFileSync('package.json', 'package.json.backup');
            
            
            const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ scripts, –Ω–µ —Ç—Ä–æ–≥–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            packageJson.scripts = {
                ...packageJson.scripts,
                "start": "node server.js",
                "dev": "node server.js",
                "test": "echo \"No tests specified\"",
                "deploy": "railway up"
            };
            
            // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –µ—Å—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            if (!packageJson.dependencies) {
                packageJson.dependencies = {};
            }
            
            if (!packageJson.dependencies.express) {
                packageJson.dependencies.express = "^4.18.2";
            }
            
            fs.writeFileSync('package.json', JSON.stringify(packageJson, null, 2));
            
        }
    }

    async conservativeDeploy() {
        
        
        try {
            
            
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª—ã –Ω–∞ –º–µ—Å—Ç–µ
            const requiredFiles = ['server.js', 'package.json'];
            for (const file of requiredFiles) {
                if (!fs.existsSync(file)) {
                    throw new Error(`–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª: ${file}`);
                }
            }
            
            // –î–µ–ø–ª–æ–∏–º
            execSync('railway up --detach', { stdio: 'inherit' });
            
            
            // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –º–µ–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏
            ...');
            await new Promise(resolve => setTimeout(resolve, 60000));
            
        } catch (error) {
            
            
            // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ backup
            if (fs.existsSync('server.js.backup')) {
                fs.copyFileSync('server.js.backup', 'server.js');
                
            }
        }
    }

    async gradualTesting() {
        
        
        const testEndpoints = [
            '/',
            '/api/health',
            '/api/info'
        ];
        
        let workingEndpoints = 0;
        
        for (const endpoint of testEndpoints) {
            const fullUrl = `${this.publicUrl}${endpoint}`;
            
            try {
                
                
                const response = execSync(`curl -s -w "%{http_code}" "${fullUrl}"`, { 
                    encoding: 'utf8',
                    timeout: 10000 
                });
                
                const statusCode = response.slice(-3);
                const body = response.slice(0, -3);
                
                if (statusCode === '200') {
                    
                    workingEndpoints++;
                    
                    if (body) {
                        try {
                            const jsonResponse = JSON.parse(body);
                            
                        } catch {
                            }...`);
                        }
                    }
                } else {
                    
                }
                
            } catch (error) {
                
            }
            
            // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏
            await new Promise(resolve => setTimeout(resolve, 2000));
        }
        
        
        
        if (workingEndpoints > 0) {
            
            return true;
        } else {
            
            return false;
        }
    }

    async createSafetyReport(error = null) {
        const report = `# üîß Railway Conservative Error Fixer Report

## üéØ –¶–µ–ª—å
–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ Railway –±–µ–∑ –≤—Ä–µ–¥–∞ —Å–∏—Å—Ç–µ–º–µ

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
1. **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è** - –ü—Ä–æ–≤–µ—Ä–µ–Ω —Å—Ç–∞—Ç—É—Å Railway –∏ —Ñ–∞–π–ª–æ–≤
2. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ URL** - –û—á–∏—â–µ–Ω—ã –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ URL –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ö
3. **–ü—Ä–æ—Å—Ç–µ–π—à–∏–π —Å–µ—Ä–≤–µ—Ä** - –°–æ–∑–¥–∞–Ω –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–±–æ—á–∏–π server.js
4. **–ú—è–≥–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** - –û–±–Ω–æ–≤–ª–µ–Ω package.json –±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
5. **–ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π –¥–µ–ø–ª–æ–π** - –í—ã–ø–æ–ª–Ω–µ–Ω –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–µ–ø–ª–æ–π
6. **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –æ—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

## üíæ –°–æ–∑–¥–∞–Ω–Ω—ã–µ backup —Ñ–∞–π–ª—ã
- \`server.js.backup\` - –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
- \`package.json.backup\` - –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è package.json

## üåê –¢–µ—Å—Ç–∏—Ä—É–µ–º—ã–µ URL
- https://web-production-73916.up.railway.app
- https://web-production-73916.up.railway.app/api/health
- https://web-production-73916.up.railway.app/api/info

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
- –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ URL –≤ .env –∏ README.md
- –£–ø—Ä–æ—â–µ–Ω server.js –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã scripts –≤ package.json

## üöÄ –°—Ç–∞—Ç—É—Å –¥–µ–ø–ª–æ—è
- **–î–µ–ø–ª–æ–π**: –í—ã–ø–æ–ª–Ω–µ–Ω
- **Backup**: –°–æ–∑–¥–∞–Ω
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞

${error ? `## ‚ö†Ô∏è –û—à–∏–±–∫–∏
- **–°–æ–æ–±—â–µ–Ω–∏–µ**: ${error.message}
- **–í—Ä–µ–º—è**: ${new Date().toISOString()}

## üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ñ–∞–π–ª—ã:
\`\`\`bash
cp server.js.backup server.js
cp package.json.backup package.json
railway up
\`\`\`
` : '## ‚úÖ –°—Ç–∞—Ç—É—Å: –£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ'}

## üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Railway Dashboard: https://railway.app/project/740ca318-2ca1-49bb-8827-75feb0a5639c
2. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ª–æ–≥–∏: \`railway logs\`
3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç

---
–í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è: ${new Date().toISOString()}
–¢–∏–ø: Conservative Error Fixer
–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è
`;

        fs.writeFileSync(process.env.API_KEY_235 || 'CONSERVATIVE_FIX_REPORT.md', report);
        
    }
}

// –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ–≥–æ —Ñ–∏–∫—Å–µ—Ä–∞
if (require.main === module) {
    const fixer = new RailwayConservativeErrorFixer();
    fixer.run().then(() => {
        fixer.createSafetyReport();
    });
}

module.exports = RailwayConservativeErrorFixer;
