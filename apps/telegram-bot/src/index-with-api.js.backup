require('dotenv').config();
const _TelegramBot = require('node-telegram-bot-api');
const _axios = require('axios');
const _winston = require('winston');

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞
const _logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  transports: [
    new winston.transports.Console(),
    new winston.transports.File({ filename: 'bot.log' })
  ]
});

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
const _config = {
  telegramToken: process.env.TELEGRAM_BOT_TOKEN,
  apiUrl: process.env.API_URL || 'http://localhost:8000/api/v1',
  adminIds: process.env.ADMIN_IDS ? process.env.ADMIN_IDS.split(',') : []
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
const _bot = new TelegramBot(config.telegramToken, { polling: true });

// –ü—Ä–æ—Å—Ç–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –≤ –ø–∞–º—è—Ç–∏
const _userStates = new Map();
const _userData = new Map();

// FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è
const _FSM_STATES = {
  START: 'start',
  REGISTRATION: 'registration',
  MAIN_MENU: 'main_menu',
  WAREHOUSE_MENU: 'warehouse_menu',
  WAREHOUSE_RECEIVE: 'warehouse_receive',
  MANAGER_MENU: 'manager_menu',
  TASKS_MENU: 'tasks_menu',
  TASK_CREATE: 'task_create'
};

// –†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const _USER_ROLES = {
  ADMIN: 'ADMIN',
  MANAGER: 'MANAGER',
  WAREHOUSE: 'WAREHOUSE',
  OPERATOR: 'OPERATOR',
  TECHNICIAN: 'TECHNICIAN',
  DRIVER: 'DRIVER'
};

// –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å FSM
class FSMManager {
  static getUserState(userId) {
    return userStates.get(userId) || FSM_STATES.START;
  }
  
  static setUserState(userId, state, data = {}) {
    userStates.set(userId, state);
    if (Object.keys(data).length > 0) {
      userData.set(userId, { ...userData.get(userId), ...data });
    }
  }
  
  static getUserData(userId) {
    return userData.get(userId) || {};
  }
  
  static clearUserData(userId) {
    userData.delete(userId);
  }
}

// API –∫–ª–∏–µ–Ω—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ endpoints
class APIClient {
  static async request(_method,_endpoint, data = null) {
    try {
      const _requestConfig = {
        method,
        url: `${config.apiUrl}${endpoint}`,
        headers: {
          'Content-Type': 'application/json',
          'x-telegram-bot-token': config.telegramToken
        }
      };
      
      if (data) {
        requestConfig.data = data;
      }
      
      const _response = await axios(requestConfig);
      return response.data;
    } catch (error) {
      logger.error('API request failed', { 
        method, 
        endpoint, 
        error: error.message,
        status: error.response?.status
      });
      throw error;
    }
  }
  
  static async testConnection() {
    try {
      const _response = await axios.get(`${config.apiUrl.replace('/api/v1', '')}/health`);
      return response.data.status === 'ok';
    } catch (error) {
      return false;
    }
  }
  
  // –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ Telegram ID
  static async getUserByTelegramId(telegramId) {
    try {
      return await this.request('GET', `/telegram/user/${telegramId}`);
    } catch (error) {
      if (error.response?.status === 404) {
        return null;
      }
      throw error;
    }
  }
  
  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  static async registerUser(userData) {
    return await this.request('POST', '/telegram/register', userData);
  }
  
  // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  static async authenticateUser(telegramId) {
    return await this.request('POST', '/telegram/auth', { telegramId });
  }
  
  // –ü–æ–ª—É—á–∏—Ç—å –∑–∞–¥–∞—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  static async getUserTasks(telegramId) {
    return await this.request('GET', `/telegram/tasks/${telegramId}`);
  }
  
  // –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
  static async createTask(taskData) {
    return await this.request('POST', '/telegram/tasks', taskData);
  }
  
  // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏
  static async updateTaskStatus(taskId, statusData) {
    return await this.request('PATCH', `/telegram/tasks/${taskId}/status`, statusData);
  }
  
  // –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–≤—Ç–æ–º–∞—Ç–æ–≤
  static async getMachines() {
    return await this.request('GET', '/telegram/machines');
  }
  
  // –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–≤–∞—Ä—ã
  static async getInventory() {
    return await this.request('GET', '/telegram/inventory');
  }
  
  // –°–æ–∑–¥–∞—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
  static async createStockMovement(movementData) {
    return await this.request('POST', '/telegram/stock-movement', movementData);
  }
  
  // –ü–æ–ª—É—á–∏—Ç—å –±—É–Ω–∫–µ—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∞
  static async getMachineBunkers(machineId) {
    return await this.request('GET', `/telegram/machines/${machineId}/bunkers`);
  }
  
  // –°–æ–∑–¥–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é —Å –±—É–Ω–∫–µ—Ä–æ–º
  static async createBunkerOperation(operationData) {
    return await this.request('POST', '/telegram/bunker-operation', operationData);
  }
}

// –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
const _keyboards = {
  mainMenu: (userRoles) => {
    const _keyboard = [];
    
    if (userRoles.includes(USER_ROLES.ADMIN)) {
      keyboard.push([{ text: 'üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ', callback_data: 'admin_menu' }]);
    }
    
    if (userRoles.includes(USER_ROLES.MANAGER)) {
      keyboard.push([{ text: 'üìä –ú–µ–Ω–µ–¥–∂–º–µ–Ω—Ç', callback_data: 'manager_menu' }]);
    }
    
    if (userRoles.includes(USER_ROLES.WAREHOUSE)) {
      keyboard.push([{ text: 'üì¶ –°–∫–ª–∞–¥', callback_data: 'warehouse_menu' }]);
    }
    
    if (userRoles.includes(USER_ROLES.OPERATOR)) {
      keyboard.push([{ text: 'üéÆ –û–ø–µ—Ä–∞—Ü–∏–∏', callback_data: 'operator_menu' }]);
    }
    
    keyboard.push([
      { text: 'üìã –ú–æ–∏ –∑–∞–¥–∞—á–∏', callback_data: 'my_tasks' },
      { text: '‚ùì –ü–æ–º–æ—â—å', callback_data: 'help' }
    ]);
    
    return {
      reply_markup: {
        inline_keyboard: keyboard
      }
    };
  },
  
  warehouseMenu: {
    reply_markup: {
      inline_keyboard: [
        [{ text: 'üì• –ü—Ä–∏—ë–º —Ç–æ–≤–∞—Ä–æ–≤', callback_data: 'warehouse_receive' }],
        [{ text: 'üóÇÔ∏è –ë—É–Ω–∫–µ—Ä—ã', callback_data: 'warehouse_bunkers' }],
        [{ text: 'üìã –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è', callback_data: 'warehouse_inventory' }],
        [{ text: 'üìä –û—Å—Ç–∞—Ç–∫–∏', callback_data: 'warehouse_stock' }],
        [{ text: 'üîô –ù–∞–∑–∞–¥', callback_data: 'main_menu' }]
      ]
    }
  },
  
  managerMenu: {
    reply_markup: {
      inline_keyboard: [
        [{ text: 'üìã –ó–∞–¥–∞—á–∏', callback_data: 'tasks_menu' }],
        [{ text: 'üóÉÔ∏è –ö–∞—Ä—Ç–æ—á–∫–∏', callback_data: 'manager_cards' }],
        [{ text: 'üìä –û—Ç—á—ë—Ç—ã', callback_data: 'manager_reports' }],
        [{ text: 'üí∞ –§–∏–Ω–∞–Ω—Å—ã', callback_data: 'manager_finance' }],
        [{ text: 'üîô –ù–∞–∑–∞–¥', callback_data: 'main_menu' }]
      ]
    }
  },
  
  tasksMenu: {
    reply_markup: {
      inline_keyboard: [
        [{ text: 'üìã –ú–æ–∏ –∑–∞–¥–∞—á–∏', callback_data: 'my_tasks' }],
        [{ text: '‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É', callback_data: 'create_task' }],
        [{ text: 'üìä –í—Å–µ –∑–∞–¥–∞—á–∏', callback_data: 'all_tasks' }],
        [{ text: 'üîô –ù–∞–∑–∞–¥', callback_data: 'main_menu' }]
      ]
    }
  },
  
  backToMain: {
    reply_markup: {
      inline_keyboard: [
        [{ text: 'üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', callback_data: 'main_menu' }]
      ]
    }
  }
};

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
bot.onText(/\/start/, async (msg) => {
  const _chatId = msg.chat.id;
  const _userId = msg.from.id;
  
  try {
    logger.info('User started bot', { userId, chatId });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API
    const _apiConnected = await APIClient.testConnection();
    
    if (!apiConnected) {
      await bot.sendMessage(chatId, 
        '‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.\n\n' +
        '–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.'
      );
      return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    const _user = await APIClient.getUserByTelegramId(userId.toString());
    
    if (user) {
      // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω, –∞–≤—Ç–æ—Ä–∏–∑—É–µ–º
      const _authResult = await APIClient.authenticateUser(userId.toString());
      userData.set(userId, { ...user, token: authResult.token });
      
      FSMManager.setUserState(userId, FSM_STATES.MAIN_MENU);
      
      await bot.sendMessage(chatId, 
        `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ VHM24, ${user.name}! üëã\n\n` +
        `üîó –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ —Ä–µ–∞–ª—å–Ω–æ–º—É API\n` +
        `–í–∞—à–∏ —Ä–æ–ª–∏: ${user.roles.join(', ')}\n\n` +
        '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –¥–ª—è —Ä–∞–±–æ—Ç—ã:',
        keyboards.mainMenu(user.roles)
      );
    } else {
      // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –Ω–∞—á–∏–Ω–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
      FSMManager.setUserState(userId, FSM_STATES.REGISTRATION);
      
      await bot.sendMessage(chatId,
        '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ VHM24! üéâ\n\n' +
        '–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è.\n' +
        '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:'
      );
    }
  } catch (error) {
    logger.error('Error in /start command', { error: error.message, userId });
    await bot.sendMessage(chatId, '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  }
});

bot.onText(/\/status/, async (msg) => {
  const _chatId = msg.chat.id;
  
  try {
    const _apiConnected = await APIClient.testConnection();
    
    const _statusText = `
üîç *–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã VHM24*

üåê Backend API: ${apiConnected ? '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω' : '‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}
ü§ñ Telegram Bot: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç
üîó –†–µ–∂–∏–º: –†–µ–∞–ª—å–Ω—ã–µ API endpoints
üìä –§—É–Ω–∫—Ü–∏–∏: –ü–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

‚è∞ –í—Ä–µ–º—è: ${new Date().toLocaleString('ru-RU')}
    `;
    
    await bot.sendMessage(chatId, statusText, { parse_mode: 'Markdown' });
  } catch (error) {
    await bot.sendMessage(chatId, '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Å–∏—Å—Ç–µ–º—ã.');
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback –∑–∞–ø—Ä–æ—Å–æ–≤
bot.on('callback_query', async (callbackQuery) => {
  const _msg = callbackQuery.message;
  const _chatId = msg.chat.id;
  const _userId = callbackQuery.from.id;
  const _data = callbackQuery.data;
  
  try {
    await bot.answerCallbackQuery(callbackQuery.id);
    
    const _user = userData.get(userId);
    if (!user) {
      await bot.sendMessage(chatId, '–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π /start');
      return;
    }
    
    switch (data) {
      case 'main_menu':
        FSMManager.setUserState(userId, FSM_STATES.MAIN_MENU);
        await bot.editMessageText(
          '–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:',
          {
            chat_id: chatId,
            message_id: msg.message_id,
            ...keyboards.mainMenu(user.roles)
          }
        );
        break;
        
      case 'warehouse_menu':
        if (!user.roles.includes(USER_ROLES.WAREHOUSE)) {
          await bot.sendMessage(chatId, '–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É —Ä–∞–∑–¥–µ–ª—É.');
          return;
        }
        FSMManager.setUserState(userId, FSM_STATES.WAREHOUSE_MENU);
        await bot.editMessageText(
          'üì¶ *–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–º*\n\n–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ü–∏—é:',
          {
            chat_id: chatId,
            message_id: msg.message_id,
            parse_mode: 'Markdown',
            ...keyboards.warehouseMenu
          }
        );
        break;
        
      case 'manager_menu':
        if (!user.roles.includes(USER_ROLES.MANAGER)) {
          await bot.sendMessage(chatId, '–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É —Ä–∞–∑–¥–µ–ª—É.');
          return;
        }
        FSMManager.setUserState(userId, FSM_STATES.MANAGER_MENU);
        await bot.editMessageText(
          'üìä *–ú–µ–Ω–µ–¥–∂–º–µ–Ω—Ç*\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:',
          {
            chat_id: chatId,
            message_id: msg.message_id,
            parse_mode: 'Markdown',
            ...keyboards.managerMenu
          }
        );
        break;
        
      case 'tasks_menu':
        FSMManager.setUserState(userId, FSM_STATES.TASKS_MENU);
        await bot.editMessageText(
          'üìã *–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏*\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:',
          {
            chat_id: chatId,
            message_id: msg.message_id,
            parse_mode: 'Markdown',
            ...keyboards.tasksMenu
          }
        );
        break;
        
      case 'my_tasks':
        await handleMyTasks(chatId, userId, msg.message_id);
        break;
        
      case 'warehouse_receive':
        await handleWarehouseReceive(chatId, userId, msg.message_id);
        break;
        
      case 'warehouse_stock':
        await handleWarehouseStock(chatId, userId, msg.message_id);
        break;
        
      case 'create_task':
        await handleCreateTask(chatId, userId, msg.message_id);
        break;
        
      default:
        await bot.sendMessage(chatId, '–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...');
    }
  } catch (error) {
    logger.error('Error in callback query', { error: error.message, userId, data });
    await bot.sendMessage(chatId, '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on('message', async (msg) => {
  if (msg.text && msg.text.startsWith('/')) {
    return; // –ö–æ–º–∞–Ω–¥—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
  }
  
  const _chatId = msg.chat.id;
  const _userId = msg.from.id;
  const _text = msg.text;
  
  try {
    const _currentState = FSMManager.getUserState(userId);
    
    switch (currentState) {
      case FSM_STATES.REGISTRATION:
        await handleRegistration(chatId, userId, text);
        break;
        
      case FSM_STATES.WAREHOUSE_RECEIVE:
        await handleWarehouseReceiveInput(chatId, userId, text);
        break;
        
      case FSM_STATES.TASK_CREATE:
        await handleTaskCreateInput(chatId, userId, text);
        break;
        
      default:
        // –í –¥—Ä—É–≥–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é
        const _user = userData.get(userId);
        if (user) {
          await bot.sendMessage(chatId, 
            '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏–ª–∏ –∫–æ–º–∞–Ω–¥—É /menu',
            keyboards.mainMenu(user.roles)
          );
        }
    }
  } catch (error) {
    logger.error('Error in message handler', { error: error.message, userId });
    await bot.sendMessage(chatId, '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
async function handleRegistration(chatId, userId, name) {
  try {
    const _userData = {
      telegramId: userId,
      telegramUsername: '',
      name: name.trim(),
      email: `user${userId}@vhm24.local`
      // roles –±—É–¥—É—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ backend –Ω–∞ –æ—Å–Ω–æ–≤–µ ADMIN_IDS
    };
    
    const _result = await APIClient.registerUser(userData);
    
    // –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const _user = await APIClient.getUserByTelegramId(userId.toString());
    
    FSMManager.setUserState(userId, FSM_STATES.MAIN_MENU);
    userData.set(userId, user);
    
    let registrationMessage;
    
    if (user.roles.includes('ADMIN')) {
      registrationMessage = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä! üëë\n\n` +
        `–ò–º—è: ${name}\n` +
        `–†–æ–ª–∏: ${user.roles.join(', ')}\n` +
        `–°—Ç–∞—Ç—É—Å: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–¥–æ–±—Ä–µ–Ω\n\n` +
        `–£ –≤–∞—Å –µ—Å—Ç—å –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º —Å–∏—Å—Ç–µ–º—ã.`;
    } else {
      registrationMessage = `–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! ‚è≥\n\n` +
        `–ò–º—è: ${name}\n` +
        `–†–æ–ª—å: ${user.roles.join(', ')}\n` +
        `–°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n\n` +
        `–í—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è.`;
    }
    
    await bot.sendMessage(chatId, registrationMessage, 
      user.roles.includes('ADMIN') ? keyboards.mainMenu(user.roles) : keyboards.backToMain
    );
    
    logger.info('User registered via API', { userId, name, roles: user.roles, isAdmin: user.roles.includes('ADMIN') });
  } catch (error) {
    logger.error('Registration failed', { error: error.message, userId });
    await bot.sendMessage(chatId, 
      '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.'
    );
  }
}

async function handleMyTasks(chatId, userId, messageId) {
  try {
    const _tasks = await APIClient.getUserTasks(userId.toString());
    
    if (tasks.length === 0) {
      await bot.editMessageText(
        'üìã *–ú–æ–∏ –∑–∞–¥–∞—á–∏*\n\n' +
        '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á.',
        {
          chat_id: chatId,
          message_id: messageId,
          parse_mode: 'Markdown',
          ...keyboards.backToMain
        }
      );
      return;
    }
    
    let _tasksText = 'üìã *–ú–æ–∏ –∑–∞–¥–∞—á–∏*\n\n';
    
    tasks.slice(0, 5).forEach((task, index) => {
      const _statusEmoji = {
        'CREATED': 'üÜï',
        'ASSIGNED': 'üìã',
        'IN_PROGRESS': '‚ö°',
        'COMPLETED': '‚úÖ',
        'CANCELLED': '‚ùå'
      };
      
      const _priorityEmoji = {
        'LOW': 'üü¢',
        'MEDIUM': 'üü°',
        'HIGH': 'üü†',
        'URGENT': 'üî¥'
      };
      
      tasksText += `${index + 1}. ${statusEmoji[task.status] || 'üìã'} ${task.title}\n`;
      tasksText += `   ${priorityEmoji[task.priority] || 'üü°'} ${task.priority}\n`;
      if (task.machine) {
        tasksText += `   üè™ ${task.machine.name}\n`;
      }
      tasksText += `   üìÖ ${new Date(task.createdAt).toLocaleDateString('ru-RU')}\n\n`;
    });
    
    if (tasks.length > 5) {
      tasksText += `... –∏ –µ—â–µ ${tasks.length - 5} –∑–∞–¥–∞—á`;
    }
    
    await bot.editMessageText(tasksText, {
      chat_id: chatId,
      message_id: messageId,
      parse_mode: 'Markdown',
      ...keyboards.backToMain
    });
    
  } catch (error) {
    logger.error('Error getting tasks', { error: error.message, userId });
    await bot.editMessageText(
      '‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–¥–∞—á',
      {
        chat_id: chatId,
        message_id: messageId,
        ...keyboards.backToMain
      }
    );
  }
}

async function handleWarehouseStock(chatId, userId, messageId) {
  try {
    const _inventory = await APIClient.getInventory();
    
    if (inventory.length === 0) {
      await bot.editMessageText(
        'üìä *–û—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ*\n\n' +
        '–°–∫–ª–∞–¥ –ø—É—Å—Ç.',
        {
          chat_id: chatId,
          message_id: messageId,
          parse_mode: 'Markdown',
          ...keyboards.backToMain
        }
      );
      return;
    }
    
    let _stockText = 'üìä *–û—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ*\n\n';
    
    inventory.slice(0, 10).forEach((item, index) => {
      const _statusEmoji = item.quantity <= (item.minQuantity || 0) ? 'üî¥' : 'üü¢';
      stockText += `${index + 1}. ${statusEmoji} ${item.name}\n`;
      stockText += `   üì¶ ${item.quantity} ${item.unit}\n`;
      if (item.minQuantity) {
        stockText += `   ‚ö†Ô∏è –ú–∏–Ω: ${item.minQuantity} ${item.unit}\n`;
      }
      stockText += '\n';
    });
    
    if (inventory.length > 10) {
      stockText += `... –∏ –µ—â–µ ${inventory.length - 10} —Ç–æ–≤–∞—Ä–æ–≤`;
    }
    
    await bot.editMessageText(stockText, {
      chat_id: chatId,
      message_id: messageId,
      parse_mode: 'Markdown',
      ...keyboards.backToMain
    });
    
  } catch (error) {
    logger.error('Error getting inventory', { error: error.message, userId });
    await bot.editMessageText(
      '‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤',
      {
        chat_id: chatId,
        message_id: messageId,
        ...keyboards.backToMain
      }
    );
  }
}

async function handleWarehouseReceive(chatId, userId, messageId) {
  FSMManager.setUserState(userId, FSM_STATES.WAREHOUSE_RECEIVE);
  
  await bot.editMessageText(
    'üì• *–ü—Ä–∏—ë–º —Ç–æ–≤–∞—Ä–æ–≤*\n\n' +
    '–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–≤–∞—Ä–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n' +
    '`–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –µ–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è`\n\n' +
    '–ù–∞–ø—Ä–∏–º–µ—Ä: `–ö–æ—Ñ–µ Jacobs, 10, –∫–≥`',
    {
      chat_id: chatId,
      message_id: messageId,
      parse_mode: 'Markdown',
      ...keyboards.backToMain
    }
  );
}

async function handleWarehouseReceiveInput(chatId, userId, text) {
  try {
    const _parts = text.split(',').map(p => p.trim());
    
    if (parts.length !== 3) {
      await bot.sendMessage(chatId, 
        '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: `–ù–∞–∑–≤–∞–Ω–∏–µ, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –µ–¥–∏–Ω–∏—Ü–∞`',
        { parse_mode: 'Markdown' }
      );
      return;
    }
    
    const [name, quantityStr, unit] = parts;
    const _quantity = parseFloat(quantityStr);
    
    if (isNaN(quantity)) {
      await bot.sendMessage(chatId, '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º.');
      return;
    }
    
    // –ó–¥–µ—Å—å –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π
    // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
    const _movementData = {
      itemId: 'demo-item-id', // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä
      telegramId: userId,
      type: 'IN',
      quantity: quantity,
      reason: `–ü—Ä–∏—ë–º —Ç–æ–≤–∞—Ä–∞ —á–µ—Ä–µ–∑ Telegram: ${name}`,
      eventTime: new Date().toISOString()
    };
    
    // –í —Ä–µ–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –≤—ã–∑–æ–≤ API
    // const _movement = await APIClient.createStockMovement(movementData);
    
    await bot.sendMessage(chatId,
      `‚úÖ –¢–æ–≤–∞—Ä –ø—Ä–∏–Ω—è—Ç –Ω–∞ —Å–∫–ª–∞–¥:\n\n` +
      `üì¶ ${name}\n` +
      `üìä ${quantity} ${unit}\n` +
      `‚è∞ ${new Date().toLocaleString('ru-RU')}\n\n` +
      `üîó –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º—É —á–µ—Ä–µ–∑ API`,
      keyboards.backToMain
    );
    
    FSMManager.setUserState(userId, FSM_STATES.WAREHOUSE_MENU);
    
    logger.info('Warehouse receive operation via API', { userId, name, quantity, unit });
  } catch (error) {
    logger.error('Error in warehouse receive', { error: error.message, userId });
    await bot.sendMessage(chatId, '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.');
  }
}

async function handleCreateTask(chatId, userId, messageId) {
  FSMManager.setUserState(userId, FSM_STATES.TASK_CREATE);
  
  await bot.editMessageText(
    '‚ûï *–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏*\n\n' +
    '–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n' +
    '`–ó–∞–≥–æ–ª–æ–≤–æ–∫ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç`\n\n' +
    '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: LOW, MEDIUM, HIGH, URGENT\n\n' +
    '–ù–∞–ø—Ä–∏–º–µ—Ä: `–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç | –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–Ω–æ–ø–∫–∞ | HIGH`',
    {
      chat_id: chatId,
      message_id: messageId,
      parse_mode: 'Markdown',
      ...keyboards.backToMain
    }
  );
}

async function handleTaskCreateInput(chatId, userId, text) {
  try {
    const _parts = text.split('|').map(p => p.trim());
    
    if (parts.length < 2) {
      await bot.sendMessage(chatId, 
        '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: `–ó–∞–≥–æ–ª–æ–≤–æ–∫ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç`',
        { parse_mode: 'Markdown' }
      );
      return;
    }
    
    const [title, description, priority = 'MEDIUM'] = parts;
    
    const _taskData = {
      title,
      description,
      priority: priority.toUpperCase(),
      createdByTelegramId: userId
    };
    
    const _task = await APIClient.createTask(taskData);
    
    await bot.sendMessage(chatId,
      `‚úÖ –ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞:\n\n` +
      `üìã ${task.title}\n` +
      `üìù ${task.description}\n` +
      `üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${task.priority}\n` +
      `üìÖ ${new Date(task.createdAt).toLocaleString('ru-RU')}\n\n` +
      `üîó –ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º—É —á–µ—Ä–µ–∑ API`,
      keyboards.backToMain
    );
    
    FSMManager.setUserState(userId, FSM_STATES.TASKS_MENU);
    
    logger.info('Task created via API', { userId, title, priority });
  } catch (error) {
    logger.error('Error creating task', { error: error.message, userId });
    await bot.sendMessage(chatId, '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏.');
  }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
bot.on('polling_error', (error) => {
  logger.error('Polling error', { error: error.message });
});

process.on('SIGINT', async () => {
  logger.info('Bot shutting down...');
  await bot.stopPolling();
  process.exit(0);
});

// –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
async function startBot() {
  try {
    logger.info('Starting VHM24 Telegram Bot (With Real API)...');
    logger.info(`Bot token: ${config.telegramToken ? 'Set' : 'Not set'}`);
    logger.info(`API URL: ${config.apiUrl}`);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API
    const _apiConnected = await APIClient.testConnection();
    logger.info(`API connection: ${apiConnected ? 'Connected' : 'Failed'}`);
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞
    await bot.setMyCommands([
      { command: 'start', description: '–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º' },
      { command: 'menu', description: '–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é' },
      { command: 'help', description: '–°–ø—Ä–∞–≤–∫–∞' },
      { command: 'status', description: '–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã' }
    ]);
    
    logger.info('VHM24 Telegram Bot started successfully! ü§ñ (With Real API)');
  } catch (error) {
    logger.error('Failed to start bot', { error: error.message });
    process.exit(1);
  }
}

startBot();
