# Инструкции по настройке VHM24 в Railway

## Введение

Этот документ содержит пошаговые инструкции по настройке и развертыванию проекта VHM24 (VendHub Management System) на платформе Railway. Следуя этим инструкциям, вы сможете настроить все необходимые компоненты системы и запустить их в продакшен-режиме.

## Предварительные требования

- Аккаунт на [Railway](https://railway.app/)
- Установленный [Node.js](https://nodejs.org/) (версия 18 или выше)
- Установленный [npm](https://www.npmjs.com/) (версия 8 или выше)
- Установленный [Git](https://git-scm.com/)
- Токен Telegram-бота (получить можно у [@BotFather](https://t.me/BotFather))
- Доступ к DigitalOcean Spaces (S3) или другому S3-совместимому хранилищу

## Шаг 1: Клонирование репозитория

```bash
git clone https://github.com/jamshiddins/VHM24.git
cd VHM24
```

## Шаг 2: Установка зависимостей

```bash
npm install
```

## Шаг 3: Настройка переменных окружения

Для настройки переменных окружения в Railway используйте скрипт `setup-railway-variables.js`:

```bash
npm run setup:railway-variables
```

Скрипт выполнит следующие действия:
1. Проверит наличие Railway CLI и при необходимости установит его
2. Выполнит вход в Railway
3. Создаст новый проект или выберет существующий
4. Создаст базу данных PostgreSQL
5. Создаст Redis
6. Настроит переменные окружения

Во время выполнения скрипта вам будет предложено ввести значения для следующих переменных:
- `JWT_SECRET` - секретный ключ для JWT (будет сгенерирован автоматически, если не указан)
- `TELEGRAM_BOT_TOKEN` - токен Telegram-бота
- `ADMIN_IDS` - список ID администраторов Telegram (через запятую)
- `S3_ACCESS_KEY` - ключ доступа к S3
- `S3_SECRET_KEY` - секретный ключ S3
- `S3_BUCKET` - имя бакета S3
- `S3_REGION` - регион S3
- `S3_ENDPOINT` - эндпоинт S3

## Шаг 4: Генерация Prisma клиента

```bash
npm run prisma:generate
```

## Шаг 5: Подготовка к деплою

```bash
# Очистка проекта от ненужных файлов и обновление Git
npm run prepare:deploy
```

Этот скрипт выполнит следующие действия:
1. Очистит проект от ненужных файлов
2. Обновит Git репозиторий
3. Выполнит деплой в Railway

Или вы можете выполнить эти действия по отдельности:

```bash
# Очистка проекта от ненужных файлов
npm run cleanup

# Обновление Git репозитория
npm run update:git

# Деплой в Railway
npm run deploy
```

## Шаг 6: Настройка вебхука для Telegram-бота

После успешного деплоя необходимо настроить вебхук для Telegram-бота:

```bash
npm run setup:webhook
```

## Шаг 7: Проверка работоспособности

Для проверки работоспособности системы выполните:

```bash
npm run check:health
```

Этот скрипт проверит:
1. Доступность API
2. Подключение к базе данных
3. Подключение к Redis
4. Работоспособность Telegram-бота

## Локальный запуск

Для локального запуска всех компонентов системы используйте:

```bash
# Запуск всех компонентов одновременно
npm run start:all

# Или запуск системы через скрипт start-vendhub-system.js
npm run start:system

# Или запуск отдельных компонентов
npm start           # API сервер
npm run start:bot   # Telegram-бот
npm run start:worker    # Worker для фоновых задач
npm run start:scheduler # Scheduler для планирования задач
```

## Структура проекта в Railway

После деплоя в Railway будут запущены следующие сервисы:

1. **web** - API сервер (Express.js)
2. **worker** - Обработчик фоновых задач
3. **scheduler** - Планировщик задач

Также будут созданы следующие плагины:

1. **PostgreSQL** - База данных
2. **Redis** - Кэширование и очереди задач

## Мониторинг и логирование

Railway предоставляет встроенные инструменты для мониторинга и логирования. Для просмотра логов выполните:

```bash
railway logs
```

Для просмотра метрик:

```bash
railway status
```

## Обновление проекта

Для обновления проекта в Railway выполните:

```bash
git pull
npm install
npm run deploy:railway
```

## Очистка проекта

Если вам нужно очистить проект от ненужных файлов перед деплоем, выполните:

```bash
npm run cleanup
```

## Устранение неполадок

### Проблемы с подключением к базе данных

1. Проверьте переменную окружения `DATABASE_URL`
2. Убедитесь, что база данных запущена
3. Проверьте логи базы данных

```bash
railway logs -s postgresql
```

### Проблемы с Telegram-ботом

1. Проверьте переменную окружения `TELEGRAM_BOT_TOKEN`
2. Убедитесь, что вебхук настроен правильно
3. Проверьте логи Telegram-бота

```bash
railway logs -s web
```

### Проблемы с Redis

1. Проверьте переменную окружения `REDIS_URL`
2. Убедитесь, что Redis запущен
3. Проверьте логи Redis

```bash
railway logs -s redis
```

## Заключение

Следуя этим инструкциям, вы сможете настроить и запустить проект VHM24 на платформе Railway. Если у вас возникнут вопросы или проблемы, обратитесь к документации Railway или создайте issue в репозитории проекта.
