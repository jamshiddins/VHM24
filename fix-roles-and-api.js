/**
 * –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–æ–ª–µ–π –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π API –º–µ–∂–¥—É –±–æ—Ç–æ–º –∏ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
 */

require('dotenv').config();
const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');
const axios = require('axios');

// –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤ –∫–æ–Ω—Å–æ–ª—å
const colors = {
  reset: '\x1b[0m',
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  magenta: '\x1b[35m',
  cyan: '\x1b[36m',
  white: '\x1b[37m'
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
function log(message, type = 'info') {
  const timestamp = new Date().toISOString();
  let color = colors.white;
  
  switch (type) {
    case 'success':
      color = colors.green;
      break;
    case 'error':
      color = colors.red;
      break;
    case 'warning':
      color = colors.yellow;
      break;
    case 'info':
      color = colors.blue;
      break;
    case 'title':
      color = colors.magenta;
      break;
  }
  
  console.log(`${color}[${timestamp}] ${message}${colors.reset}`);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞
function checkFileExists(filePath) {
  try {
    return fs.existsSync(filePath);
  } catch (error) {
    return false;
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
function ensureDirectoryExists(dirPath) {
  if (!fs.existsSync(dirPath)) {
    fs.mkdirSync(dirPath, { recursive: true });
    log(`–°–æ–∑–¥–∞–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: ${dirPath}`, 'success');
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞ apps/telegram-bot/src/utils/role-sync.js
function createRoleSyncFile() {
  log('–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ apps/telegram-bot/src/utils/role-sync.js...', 'info');
  
  const roleSyncPath = path.join(__dirname, 'apps', 'telegram-bot', 'src', 'utils', 'role-sync.js');
  
  // –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  ensureDirectoryExists(path.dirname(roleSyncPath));
  
  const roleSyncContent = `/**
 * –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ä–æ–ª–µ–π –º–µ–∂–¥—É Telegram-–±–æ—Ç–æ–º –∏ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
 */
const axios = require('axios');
const { PrismaClient } = require('@prisma/client');
const prisma = new PrismaClient();

// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Ä–æ–ª–µ–π
const ROLES = {
  ADMIN: 'ADMIN',
  MANAGER: 'MANAGER',
  WAREHOUSE: 'WAREHOUSE',
  OPERATOR: 'OPERATOR',
  TECHNICIAN: 'TECHNICIAN',
  DRIVER: 'DRIVER'
};

// –¢–µ–∫—Å—Ç–æ–≤—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ä–æ–ª–µ–π
const ROLE_TEXTS = {
  ADMIN: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
  MANAGER: '–ú–µ–Ω–µ–¥–∂–µ—Ä',
  WAREHOUSE: '–°–∫–ª–∞–¥—Å–∫–æ–π —Ä–∞–±–æ—Ç–Ω–∏–∫',
  OPERATOR: '–û–ø–µ—Ä–∞—Ç–æ—Ä',
  TECHNICIAN: '–¢–µ—Ö–Ω–∏–∫',
  DRIVER: '–í–æ–¥–∏—Ç–µ–ª—å'
};

// –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è —Ä–æ–ª–µ–π
const ROLE_PERMISSIONS = {
  ADMIN: ['*'], // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∏–º–µ–µ—Ç –≤—Å–µ –ø—Ä–∞–≤–∞
  MANAGER: ['create_task', 'view_reports', 'manage_machines', 'manage_finance', 'manage_directories'],
  WAREHOUSE: ['receive_items', 'dispatch_items', 'manage_bags', 'inventory_check'],
  OPERATOR: ['execute_task', 'replace_hoppers', 'replace_water', 'clean', 'cash_collection'],
  TECHNICIAN: ['repair', 'diagnostics', 'execute_task', 'view_reports'],
  DRIVER: ['execute_task', 'view_routes']
};

/**
 * –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @param {string} telegramId - Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @returns {Promise<object|null>} - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏–ª–∏ null, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
 */
async function checkUserRole(telegramId) {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±–∞–∑–µ
    const user = await prisma.user.findUnique({
      where: { telegramId: telegramId.toString() }
    });
    
    if (!user) {
      console.log(\`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å Telegram ID \${telegramId} –Ω–µ –Ω–∞–π–¥–µ–Ω\`);
      return null;
    }
    
    if (user.status !== 'ACTIVE') {
      console.log(\`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å Telegram ID \${telegramId} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω\`);
      return null;
    }
    
    return {
      id: user.id,
      telegramId: user.telegramId,
      firstName: user.firstName,
      lastName: user.lastName,
      role: user.role,
      permissions: ROLE_PERMISSIONS[user.role] || []
    };
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
    return null;
  }
}

/**
 * –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @param {string} role - –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @param {string} permission - –ü—Ä–æ–≤–µ—Ä—è–µ–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
 * @returns {boolean} - true, –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ, –∏–Ω–∞—á–µ false
 */
function hasPermission(role, permission) {
  if (!role || !permission) {
    return false;
  }
  
  // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∏–º–µ–µ—Ç –≤—Å–µ –ø—Ä–∞–≤–∞
  if (role === ROLES.ADMIN) {
    return true;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è —Ä–æ–ª–∏
  const permissions = ROLE_PERMISSIONS[role] || [];
  return permissions.includes(permission) || permissions.includes('*');
}

/**
 * –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å API
 * @param {object} user - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
 * @returns {Promise<boolean>} - true, –µ—Å–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, –∏–Ω–∞—á–µ false
 */
async function syncUserWithAPI(user) {
  try {
    if (!user || !user.id) {
      console.error('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
      return false;
    }
    
    const API_BASE_URL = process.env.API_BASE_URL || 'http://localhost:3000/api';
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const response = await axios.post(\`\${API_BASE_URL}/users/sync\`, {
      userId: user.id,
      telegramId: user.telegramId,
      firstName: user.firstName,
      lastName: user.lastName,
      role: user.role
    }, {
      timeout: 5000,
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    if (response.status === 200 && response.data.success) {
      console.log(\`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å \${user.id} —É—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å API\`);
      return true;
    } else {
      console.warn(\`–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è \${user.id} —Å API: \${JSON.stringify(response.data)}\`);
      return false;
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å API:', error.message);
    return false;
  }
}

/**
 * –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ä–æ–ª–∏
 * @param {string} role - –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @returns {string} - –¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–∏
 */
function getRoleText(role) {
  return ROLE_TEXTS[role] || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
}

module.exports = {
  ROLES,
  ROLE_TEXTS,
  ROLE_PERMISSIONS,
  checkUserRole,
  hasPermission,
  syncUserWithAPI,
  getRoleText
};
`;
  
  fs.writeFileSync(roleSyncPath, roleSyncContent);
  log('–§–∞–π–ª apps/telegram-bot/src/utils/role-sync.js —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω', 'success');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞ backend/src/routes/users.js
function fixUsersRouteFile() {
  log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ backend/src/routes/users.js...', 'info');
  
  const usersRoutePath = path.join(__dirname, 'backend', 'src', 'routes', 'users.js');
  
  if (checkFileExists(usersRoutePath)) {
    const usersRouteContent = fs.readFileSync(usersRoutePath, 'utf8');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    if (!usersRouteContent.includes('/sync')) {
      log('–í —Ñ–∞–π–ª–µ backend/src/routes/users.js –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –¥–æ–±–∞–≤–ª—è–µ–º...', 'warning');
      
      // –ù–∞—Ö–æ–¥–∏–º –º–µ—Å—Ç–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
      const newRoute = `
/**
 * @route POST /api/users/sync
 * @desc –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–µ–∂–¥—É Telegram-–±–æ—Ç–æ–º –∏ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
 */
router.post('/sync', async (req, res) => {
  try {
    const { userId, telegramId, firstName, lastName, role } = req.body;
    
    if (!userId || !telegramId) {
      return res.status(400).json({
        success: false,
        error: '–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã'
      });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    let user = await prisma.user.findUnique({
      where: { id: userId }
    });
    
    if (!user) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º Telegram ID
      user = await prisma.user.findUnique({
        where: { telegramId }
      });
      
      if (user) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user = await prisma.user.update({
          where: { telegramId },
          data: {
            firstName: firstName || user.firstName,
            lastName: lastName || user.lastName,
            role: role || user.role
          }
        });
        
        return res.json({
          success: true,
          message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω',
          user
        });
      }
      
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      user = await prisma.user.create({
        data: {
          id: userId,
          telegramId,
          firstName: firstName || '',
          lastName: lastName || '',
          role: role || 'USER',
          status: 'ACTIVE'
        }
      });
      
      return res.json({
        success: true,
        message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω',
        user
      });
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user = await prisma.user.update({
      where: { id: userId },
      data: {
        telegramId,
        firstName: firstName || user.firstName,
        lastName: lastName || user.lastName,
        role: role || user.role
      }
    });
    
    res.json({
      success: true,
      message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω',
      user
    });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
    res.status(500).json({
      success: false,
      error: '–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
      details: error.message
    });
  }
});`;
      
      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç –ø–µ—Ä–µ–¥ module.exports
      const updatedContent = usersRouteContent.replace(
        /module\.exports = router;/,
        `${newRoute}\n\nmodule.exports = router;`
      );
      
      fs.writeFileSync(usersRoutePath, updatedContent);
      log('–§–∞–π–ª backend/src/routes/users.js —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω', 'success');
    } else {
      log('–§–∞–π–ª backend/src/routes/users.js —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –º–∞—Ä—à—Ä—É—Ç –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'success');
    }
  } else {
    log('–§–∞–π–ª backend/src/routes/users.js –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º...', 'warning');
    
    // –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    ensureDirectoryExists(path.dirname(usersRoutePath));
    
    const usersRouteContent = `/**
 * –ú–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
 */
const express = require('express');
const router = express.Router();
const { PrismaClient } = require('@prisma/client');
const prisma = new PrismaClient();
const { authenticateToken, requireRole, ROLES } = require('../middleware/roleCheck');

/**
 * @route GET /api/users
 * @desc –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
 */
router.get('/', authenticateToken, requireRole([ROLES.ADMIN, ROLES.MANAGER]), async (req, res) => {
  try {
    const users = await prisma.user.findMany({
      orderBy: {
        createdAt: 'desc'
      }
    });
    
    res.json(users);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
    res.status(500).json({ error: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π' });
  }
});

/**
 * @route GET /api/users/:id
 * @desc –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
 */
router.get('/:id', authenticateToken, requireRole([ROLES.ADMIN, ROLES.MANAGER], true), async (req, res) => {
  try {
    const { id } = req.params;
    
    const user = await prisma.user.findUnique({
      where: { id }
    });
    
    if (!user) {
      return res.status(404).json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
    }
    
    res.json(user);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:', error);
    res.status(500).json({ error: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ' });
  }
});

/**
 * @route POST /api/users
 * @desc –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */
router.post('/', authenticateToken, requireRole([ROLES.ADMIN]), async (req, res) => {
  try {
    const { telegramId, firstName, lastName, role } = req.body;
    
    if (!telegramId) {
      return res.status(400).json({ error: 'Telegram ID –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω' });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º Telegram ID
    const existingUser = await prisma.user.findUnique({
      where: { telegramId }
    });
    
    if (existingUser) {
      return res.status(400).json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º Telegram ID —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç' });
    }
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const user = await prisma.user.create({
      data: {
        telegramId,
        firstName: firstName || '',
        lastName: lastName || '',
        role: role || 'USER',
        status: 'ACTIVE'
      }
    });
    
    res.status(201).json(user);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
    res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' });
  }
});

/**
 * @route PUT /api/users/:id
 * @desc –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
 */
router.put('/:id', authenticateToken, requireRole([ROLES.ADMIN]), async (req, res) => {
  try {
    const { id } = req.params;
    const { telegramId, firstName, lastName, role, status } = req.body;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    const user = await prisma.user.findUnique({
      where: { id }
    });
    
    if (!user) {
      return res.status(404).json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    const updatedUser = await prisma.user.update({
      where: { id },
      data: {
        telegramId: telegramId || user.telegramId,
        firstName: firstName || user.firstName,
        lastName: lastName || user.lastName,
        role: role || user.role,
        status: status || user.status
      }
    });
    
    res.json(updatedUser);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:', error);
    res.status(500).json({ error: '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ' });
  }
});

/**
 * @route DELETE /api/users/:id
 * @desc –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */
router.delete('/:id', authenticateToken, requireRole([ROLES.ADMIN]), async (req, res) => {
  try {
    const { id } = req.params;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    const user = await prisma.user.findUnique({
      where: { id }
    });
    
    if (!user) {
      return res.status(404).json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
    }
    
    // –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await prisma.user.delete({
      where: { id }
    });
    
    res.json({ message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω' });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
    res.status(500).json({ error: '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' });
  }
});

/**
 * @route POST /api/users/sync
 * @desc –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–µ–∂–¥—É Telegram-–±–æ—Ç–æ–º –∏ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
 */
router.post('/sync', async (req, res) => {
  try {
    const { userId, telegramId, firstName, lastName, role } = req.body;
    
    if (!userId || !telegramId) {
      return res.status(400).json({
        success: false,
        error: '–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã'
      });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    let user = await prisma.user.findUnique({
      where: { id: userId }
    });
    
    if (!user) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º Telegram ID
      user = await prisma.user.findUnique({
        where: { telegramId }
      });
      
      if (user) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user = await prisma.user.update({
          where: { telegramId },
          data: {
            firstName: firstName || user.firstName,
            lastName: lastName || user.lastName,
            role: role || user.role
          }
        });
        
        return res.json({
          success: true,
          message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω',
          user
        });
      }
      
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      user = await prisma.user.create({
        data: {
          id: userId,
          telegramId,
          firstName: firstName || '',
          lastName: lastName || '',
          role: role || 'USER',
          status: 'ACTIVE'
        }
      });
      
      return res.json({
        success: true,
        message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω',
        user
      });
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user = await prisma.user.update({
      where: { id: userId },
      data: {
        telegramId,
        firstName: firstName || user.firstName,
        lastName: lastName || user.lastName,
        role: role || user.role
      }
    });
    
    res.json({
      success: true,
      message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω',
      user
    });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
    res.status(500).json({
      success: false,
      error: '–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
      details: error.message
    });
  }
});

module.exports = router;
`;
    
    fs.writeFileSync(usersRoutePath, usersRouteContent);
    log('–§–∞–π–ª backend/src/routes/users.js —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω', 'success');
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞ apps/telegram-bot/src/scenes/main-menu.scene.js
function fixMainMenuSceneFile() {
  log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ apps/telegram-bot/src/scenes/main-menu.scene.js...', 'info');
  
  const mainMenuScenePath = path.join(__dirname, 'apps', 'telegram-bot', 'src', 'scenes', 'main-menu.scene.js');
  
  if (checkFileExists(mainMenuScenePath)) {
    const mainMenuSceneContent = fs.readFileSync(mainMenuScenePath, 'utf8');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏–º–ø–æ—Ä—Ç–∞ role-sync
    if (!mainMenuSceneContent.includes('role-sync')) {
      log('–í —Ñ–∞–π–ª–µ apps/telegram-bot/src/scenes/main-menu.scene.js –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–º–ø–æ—Ä—Ç role-sync, –∏—Å–ø—Ä–∞–≤–ª—è–µ–º...', 'warning');
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç role-sync
      const updatedContent = mainMenuSceneContent.replace(
        /const states = require\('\.\.\/states'\);/,
        `const states = require('../states');
const { checkUserRole, getRoleText, syncUserWithAPI } = require('../utils/role-sync');`
      );
      
      // –ó–∞–º–µ–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é handleAuthCheck
      const updatedContent2 = updatedContent.replace(
        /async function handleAuthCheck\(ctx\) {[\s\S]*?}/,
        `async function handleAuthCheck(ctx) {
  try {
    const telegramId = ctx.from.id.toString();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–æ–º–æ—â—å—é role-sync
    const user = await checkUserRole(telegramId);
    
    if (!user) {
      // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
      await ctx.reply('‚ö†Ô∏è –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ –∏–ª–∏ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.');
      ctx.session.state = 'unauthorized';
      return;
    }
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å API
    await syncUserWithAPI(user);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–µ—Å—Å–∏–∏
    ctx.session.user = user;
    
    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—é –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
    ctx.session.state = 'main_menu';
    await handleMainMenu(ctx);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
    await ctx.reply('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    await ctx.scene.leave();
  }
}`
      );
      
      // –ó–∞–º–µ–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é getRoleText
      const updatedContent3 = updatedContent2.replace(
        /function getRoleText\(role\) {[\s\S]*?}/,
        `// –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é getRoleText –∏–∑ role-sync
// function getRoleText(role) {
//   const roles = {
//     ADMIN: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
//     MANAGER: '–ú–µ–Ω–µ–¥–∂–µ—Ä',
//     WAREHOUSE: '–°–∫–ª–∞–¥—Å–∫–æ–π —Ä–∞–±–æ—Ç–Ω–∏–∫',
//     OPERATOR: '–û–ø–µ—Ä–∞—Ç–æ—Ä',
//     TECHNICIAN: '–¢–µ—Ö–Ω–∏–∫',
//     DRIVER: '–í–æ–¥–∏—Ç–µ–ª—å'
//   };
//   
//   return roles[role] || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
// }`
      );
      
      fs.writeFileSync(mainMenuScenePath, updatedContent3);
      log('–§–∞–π–ª apps/telegram-bot/src/scenes/main-menu.scene.js —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω', 'success');
    } else {
      log('–§–∞–π–ª apps/telegram-bot/src/scenes/main-menu.scene.js —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–º–ø–æ—Ä—Ç role-sync', 'success');
    }
  } else {
    log('–§–∞–π–ª apps/telegram-bot/src/scenes/main-menu.scene.js –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞ apps/telegram-bot/src/index.js
function fixTelegramBotIndexFile() {
  log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ apps/telegram-bot/src/index.js...', 'info');
  
  const telegramBotIndexPath = path.join(__dirname, 'apps', 'telegram-bot', 'src', 'index.js');
  
  if (checkFileExists(telegramBotIndexPath)) {
    const telegramBotIndexContent = fs.readFileSync(telegramBotIndexPath, 'utf8');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API
    if (!telegramBotIndexContent.includes('retryCount') || !telegramBotIndexContent.includes('retryDelay')) {
      log('–í —Ñ–∞–π–ª–µ apps/telegram-bot/src/index.js –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API, –∏—Å–ø—Ä–∞–≤–ª—è–µ–º...', 'warning');
      
      // –ó–∞–º–µ–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é checkApiHealth
      const updatedContent = telegramBotIndexContent.replace(
        /async function startBot\(\) {[\s\S]*?}/,
        `async function startBot() {
  try {
    console.log('üöÄ –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞...');
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±—Ö—É–∫–∞
    await setupWebhook();
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
    const maxRetries = 5;
    const retryDelay = 3000; // 3 —Å–µ–∫—É–Ω–¥—ã
    let retryCount = 0;
    let apiConnected = false;
    
    while (retryCount < maxRetries && !apiConnected) {
      try {
        const response = await axios.get(\`\${API_BASE_URL}/health\`, { timeout: 5000 });
        console.log(\`‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω: \${JSON.stringify(response.data)}\`);
        apiConnected = true;
      } catch (error) {
        retryCount++;
        if (retryCount < maxRetries) {
          console.warn(\`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API (\${retryCount}/\${maxRetries}): \${error.message}. –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ \${retryDelay/1000} —Å–µ–∫...\`);
          await new Promise(resolve => setTimeout(resolve, retryDelay));
        } else {
          console.error(\`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ API –ø–æ—Å–ª–µ \${maxRetries} –ø–æ–ø—ã—Ç–æ–∫: \${error.message}\`);
        }
      }
    }
    
    // –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    await bot.launch();
    
    console.log('‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω');
    
    // –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    console.log(\`üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞: API_BASE_URL=\${API_BASE_URL}, WEBHOOK_URL=\${WEBHOOK_URL}, ADMIN_IDS=\${ADMIN_IDS.join(', ') || '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã'}\`);
    
    // Graceful stop
    process.once('SIGINT', () => bot.stop('SIGINT'));
    process.once('SIGTERM', () => bot.stop('SIGTERM'));
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞:', error);
    process.exit(1);
  }
}`
      );
      
      fs.writeFileSync(telegramBotIndexPath, updatedContent);
      log('–§–∞–π–ª apps/telegram-bot/src/index.js —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω', 'success');
    } else {
      log('–§–∞–π–ª apps/telegram-bot/src/index.js —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –º–µ—Ö–∞–Ω–∏–∑–º –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API', 'success');
    }
  } else {
    log('–§–∞–π–ª apps/telegram-bot/src/index.js –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞ backend/src/routes/telegram.js
function fixTelegramRouteFile() {
  log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ backend/src/routes/telegram.js...', 'info');
  
  const telegramRoutePath = path.join(__dirname, 'backend', 'src', 'routes', 'telegram.js');
  
  if (checkFileExists(telegramRoutePath)) {
    const telegramRouteContent = fs.readFileSync(telegramRoutePath, 'utf8');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –≤–µ–±—Ö—É–∫–∞
    if (!telegramRouteContent.includes('maxRetries') || !telegramRouteContent.includes('retryDelay')) {
      log('–í —Ñ–∞–π–ª–µ backend/src/routes/telegram.js –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –≤–µ–±—Ö—É–∫–∞, –∏—Å–ø—Ä–∞–≤–ª—è–µ–º...', 'warning');
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–¥ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –≤–µ–±—Ö—É–∫–∞
      const updatedContent = telegramRouteContent.replace(
        /router\.post\('\/webhook', async \(req, res\) => {[\s\S]*?try {/,
        `router.post('/webhook', async (req, res) => {
  try {
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±—Ö—É–∫–∞ —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
    const maxRetries = 3;
    const retryDelay = 2000; // 2 —Å–µ–∫—É–Ω–¥—ã
    let retryCount = 0;
    let webhookSet = false;
    
    while (retryCount < maxRetries && !webhookSet) {
      try {
        // –ü–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–µ–±—Ö—É–∫
        await bot.telegram.setWebhook(\`\${WEBHOOK_URL}/api/telegram/webhook\`);
        console.log('‚úÖ –í–µ–±—Ö—É–∫ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
        webhookSet = true;
      } catch (error) {
        retryCount++;
        if (retryCount < maxRetries) {
          console.warn(\`‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–µ–±—Ö—É–∫–∞ (\${retryCount}/\${maxRetries}): \${error.message}. –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ \${retryDelay/1000} —Å–µ–∫...\`);
          await new Promise(resolve => setTimeout(resolve, retryDelay));
        } else {
          console.error(\`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–µ–±—Ö—É–∫ –ø–æ—Å–ª–µ \${maxRetries} –ø–æ–ø—ã—Ç–æ–∫: \${error.message}\`);
        }
      }
    }`
      );
      
      fs.writeFileSync(telegramRoutePath, updatedContent);
      log('–§–∞–π–ª backend/src/routes/telegram.js —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω', 'success');
    } else {
      log('–§–∞–π–ª backend/src/routes/telegram.js —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –≤–µ–±—Ö—É–∫–∞', 'success');
    }
  } else {
    log('–§–∞–π–ª backend/src/routes/telegram.js –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
  }
}
